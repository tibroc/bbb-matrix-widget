(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function t(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(n){if(n.ep)return;n.ep=!0;const s=t(n);fetch(n.href,s)}})();var hc={},Rh=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof hc<"u"?hc:typeof self<"u"?self:{};function Nr(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var fd={exports:{}};(function(r){(function(e,t){r.exports?r.exports=t():e.log=t()})(Rh,function(){var e=function(){},t="undefined",i=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),n=["trace","debug","info","warn","error"],s={},o=null;function a(v,S){var w=v[S];if(typeof w.bind=="function")return w.bind(v);try{return Function.prototype.bind.call(w,v)}catch{return function(){return Function.prototype.apply.apply(w,[v,arguments])}}}function c(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function l(v){return v==="debug"&&(v="log"),typeof console===t?!1:v==="trace"&&i?c:console[v]!==void 0?a(console,v):console.log!==void 0?a(console,"log"):e}function u(){for(var v=this.getLevel(),S=0;S<n.length;S++){var w=n[S];this[w]=S<v?e:this.methodFactory(w,v,this.name)}if(this.log=this.debug,typeof console===t&&v<this.levels.SILENT)return"No console available for logging"}function h(v){return function(){typeof console!==t&&(u.call(this),this[v].apply(this,arguments))}}function f(v,S,w){return l(v)||h.apply(this,arguments)}function g(v,S){var w=this,M,_,C,A="loglevel";typeof v=="string"?A+=":"+v:typeof v=="symbol"&&(A=void 0);function y(ue){var ge=(n[ue]||"silent").toUpperCase();if(!(typeof window===t||!A)){try{window.localStorage[A]=ge;return}catch{}try{window.document.cookie=encodeURIComponent(A)+"="+ge+";"}catch{}}}function $(){var ue;if(!(typeof window===t||!A)){try{ue=window.localStorage[A]}catch{}if(typeof ue===t)try{var ge=window.document.cookie,Se=encodeURIComponent(A),ze=ge.indexOf(Se+"=");ze!==-1&&(ue=/^([^;]+)/.exec(ge.slice(ze+Se.length+1))[1])}catch{}return w.levels[ue]===void 0&&(ue=void 0),ue}}function X(){if(!(typeof window===t||!A)){try{window.localStorage.removeItem(A)}catch{}try{window.document.cookie=encodeURIComponent(A)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function le(ue){var ge=ue;if(typeof ge=="string"&&w.levels[ge.toUpperCase()]!==void 0&&(ge=w.levels[ge.toUpperCase()]),typeof ge=="number"&&ge>=0&&ge<=w.levels.SILENT)return ge;throw new TypeError("log.setLevel() called with invalid level: "+ue)}w.name=v,w.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},w.methodFactory=S||f,w.getLevel=function(){return C??_??M},w.setLevel=function(ue,ge){return C=le(ue),ge!==!1&&y(C),u.call(w)},w.setDefaultLevel=function(ue){_=le(ue),$()||w.setLevel(ue,!1)},w.resetLevel=function(){C=null,X(),u.call(w)},w.enableAll=function(ue){w.setLevel(w.levels.TRACE,ue)},w.disableAll=function(ue){w.setLevel(w.levels.SILENT,ue)},w.rebuild=function(){if(o!==w&&(M=le(o.getLevel())),u.call(w),o===w)for(var ue in s)s[ue].rebuild()},M=le(o?o.getLevel():"WARN");var ne=$();ne!=null&&(C=le(ne)),u.call(w)}o=new g,o.getLogger=function(S){if(typeof S!="symbol"&&typeof S!="string"||S==="")throw new TypeError("You must supply a name when creating a logger.");var w=s[S];return w||(w=s[S]=new g(S,o.methodFactory)),w};var m=typeof window!==t?window.log:void 0;return o.noConflict=function(){return typeof window!==t&&window.log===o&&(window.log=m),o},o.getLoggers=function(){return s},o.default=o,o})})(fd);var Th=fd.exports;const _r=Nr(Th),gd="matrix";_r.methodFactory=function(r,e,t){return function(...i){return this.prefix&&i.unshift(this.prefix),r==="error"||r==="warn"||r==="trace"||r==="info"||r==="debug"?console[r](...i):console.log(...i)}};function pd(r){const e=r;e.getChild=e.withPrefix=function(t){const i=this.prefix||"";return Ch(i+t)}}function Ch(r){const e=_r.getLogger(`${gd}-${r}`);return e.prefix!==r&&(pd(e),e.prefix=r,e.setLevel(_r.levels.DEBUG,!1)),e}const d=_r.getLogger(gd);d.setLevel(_r.levels.DEBUG,!1);pd(d);class PE{constructor(e,t){this.parent=e,this.name=t+":"}trace(...e){this.parent.trace(this.name,...e)}debug(...e){this.parent.debug(this.name,...e)}info(...e){this.parent.info(this.name,...e)}warn(...e){this.parent.warn(this.name,...e)}error(...e){this.parent.error(this.name,...e)}}let $a=class{constructor(e,t){if(this.stable=e,this.unstable=t,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}get name(){return this.stable?this.stable:this.unstable}get altName(){return this.stable?this.unstable:null}get names(){const e=[this.name],t=this.altName;return t&&e.push(t),e}matches(e){return this.name===e||this.altName===e}findIn(e){let t;return this.name&&(t=e==null?void 0:e[this.name]),!t&&this.altName&&(t=e==null?void 0:e[this.altName]),t}includedIn(e){let t=!1;return this.name&&(t=e.includes(this.name)),!t&&this.altName&&(t=e.includes(this.altName)),t}};class Js extends $a{constructor(){super(...arguments),this.preferUnstable=!1}setPreferUnstable(e){this.preferUnstable=e}get name(){return this.stable&&!this.preferUnstable?this.stable:this.unstable}}let Ce=class extends $a{constructor(e,t){if(super(e,t),!this.unstable)throw new Error("Unstable value must be supplied")}get name(){return this.unstable}get altName(){return this.stable}};var R=(r=>(r.RoomCanonicalAlias="m.room.canonical_alias",r.RoomCreate="m.room.create",r.RoomJoinRules="m.room.join_rules",r.RoomMember="m.room.member",r.RoomThirdPartyInvite="m.room.third_party_invite",r.RoomPowerLevels="m.room.power_levels",r.RoomName="m.room.name",r.RoomTopic="m.room.topic",r.RoomAvatar="m.room.avatar",r.RoomPinnedEvents="m.room.pinned_events",r.RoomEncryption="m.room.encryption",r.RoomHistoryVisibility="m.room.history_visibility",r.RoomGuestAccess="m.room.guest_access",r.RoomServerAcl="m.room.server_acl",r.RoomTombstone="m.room.tombstone",r.RoomPredecessor="org.matrix.msc3946.room_predecessor",r.PolicyRuleUser="m.policy.rule.user",r.PolicyRuleRoom="m.policy.rule.room",r.PolicyRuleServer="m.policy.rule.server",r.SpaceChild="m.space.child",r.SpaceParent="m.space.parent",r.RoomRedaction="m.room.redaction",r.RoomMessage="m.room.message",r.RoomMessageEncrypted="m.room.encrypted",r.Sticker="m.sticker",r.CallInvite="m.call.invite",r.CallCandidates="m.call.candidates",r.CallAnswer="m.call.answer",r.CallHangup="m.call.hangup",r.CallReject="m.call.reject",r.CallSelectAnswer="m.call.select_answer",r.CallNegotiate="m.call.negotiate",r.CallSDPStreamMetadataChanged="m.call.sdp_stream_metadata_changed",r.CallSDPStreamMetadataChangedPrefix="org.matrix.call.sdp_stream_metadata_changed",r.CallReplaces="m.call.replaces",r.CallAssertedIdentity="m.call.asserted_identity",r.CallAssertedIdentityPrefix="org.matrix.call.asserted_identity",r.CallEncryptionKeysPrefix="io.element.call.encryption_keys",r.KeyVerificationRequest="m.key.verification.request",r.KeyVerificationStart="m.key.verification.start",r.KeyVerificationCancel="m.key.verification.cancel",r.KeyVerificationMac="m.key.verification.mac",r.KeyVerificationDone="m.key.verification.done",r.KeyVerificationKey="m.key.verification.key",r.KeyVerificationAccept="m.key.verification.accept",r.KeyVerificationReady="m.key.verification.ready",r.RoomMessageFeedback="m.room.message.feedback",r.Reaction="m.reaction",r.PollStart="org.matrix.msc3381.poll.start",r.Typing="m.typing",r.Receipt="m.receipt",r.Presence="m.presence",r.FullyRead="m.fully_read",r.Tag="m.tag",r.SpaceOrder="org.matrix.msc3230.space_order",r.PushRules="m.push_rules",r.Direct="m.direct",r.IgnoredUserList="m.ignored_user_list",r.RoomKey="m.room_key",r.RoomKeyRequest="m.room_key_request",r.ForwardedRoomKey="m.forwarded_room_key",r.Dummy="m.dummy",r.GroupCallPrefix="org.matrix.msc3401.call",r.GroupCallMemberPrefix="org.matrix.msc3401.call.member",r.CallNotify="org.matrix.msc4075.call.notify",r))(R||{}),Te=(r=>(r.Annotation="m.annotation",r.Replace="m.replace",r.Reference="m.reference",r.Thread="m.thread",r))(Te||{}),Jt=(r=>(r.Text="m.text",r.Emote="m.emote",r.Notice="m.notice",r.Image="m.image",r.File="m.file",r.Audio="m.audio",r.Location="m.location",r.Video="m.video",r.KeyVerificationRequest="m.key.verification.request",r))(Jt||{});const Fo="type";var _n=(r=>(r.Space="m.space",r.UnstableCall="org.matrix.msc3417.call",r.ElementVideo="io.element.video",r))(_n||{});const ut="org.matrix.msgid",fc=new Ce("m.room.purpose","org.matrix.msc3088.purpose"),gc=new Ce("m.enabled","org.matrix.msc3088.enabled"),pc=new Ce("m.data_tree","org.matrix.msc3089.data_tree"),kh=new Ce("m.leaf","org.matrix.msc3089.leaf"),Ri=new Ce("m.branch","org.matrix.msc3089.branch"),Oh=new Ce("m.room.marker","org.matrix.msc2716.marker"),mc=new Ce("with_rel_types","org.matrix.msc3912.with_relations"),Mh=new Ce("io.element.functional_members","io.element.functional_members"),En=new Ce("m.visibility","org.matrix.msc3531.visibility"),vc=new Ce("enabled","org.matrix.msc3881.enabled");new Ce("device_id","org.matrix.msc3881.device_id");const Ah=new Ce("m.local_notification_settings","org.matrix.msc3890.local_notification_settings"),$o=new Ce("thread_id","org.matrix.msc4023.thread_id"),Ph="l",Dh="rn",Uh={0:"O",1:"l","֭":"֖","֮":"֘","֨":"֙","֤":"֚","᪴":"ۛ","⃛":"ۛ","ؙ":"̓","ࣳ":"̓","̓":"̓","̕":"̓","ُ":"̓","ٝ":"̔","֜":"́","֝":"́","ؘ":"́","݇":"́","́":"́","॔":"́","َ":"́","̀":"̀","॓":"̀","̌":"̆","꙼":"̆","٘":"̆","ٚ":"̆","ͮ":"̆","ۨ":"̆̇","̐":"̆̇","ँ":"̆̇","ঁ":"̆̇","ઁ":"̆̇","ଁ":"̆̇","ఀ":"̆̇","ಁ":"̆̇","ഁ":"̆̇","𑒿":"̆̇","᳐":"̂","̑":"̂","ٛ":"̂","߮":"̂","꛰":"̂","֯":"̊","۟":"̊","៓":"̊","゚":"̊","ْ":"̊","ஂ":"̊","ံ":"̊","ំ":"̊","𑌀":"̊","ํ":"̊","ໍ":"̊","ͦ":"̊","ⷪ":"̊","࣫":"̈","߳":"̈","ً":"̋","ࣰ":"̋","͂":"̃","ٓ":"̃","ׄ":"̇","۬":"̇","݀":"̇","࣪":"̇","݁":"̇","͘":"̇","ֹ":"̇","ֺ":"̇","ׂ":"̇","ׁ":"̇","߭":"̇","ं":"̇","ਂ":"̇","ં":"̇","்":"̇","̷":"̸","᪷":"̨","̢":"̨","ͅ":"̨","᳒":"̄","̅":"̄","ٙ":"̄","߫":"̄","꛱":"̄","᳚":"̎","ٗ":"̒","͗":"͐","ࣿ":"͐","ࣸ":"͐","ऀ":"͒","᳭":"̖","᳜":"̩","ٖ":"̩","᳕":"̫","͇":"̳","ࣹ":"͔","ࣺ":"͕","゛":"ﾞ","゜":"ﾟ","̶":"̵","〬":"̉","ׅ":"̣","࣭":"̣","᳝":"̣","ִ":"̣","ٜ":"̣","़":"̣","়":"̣","਼":"̣","઼":"̣","଼":"̣","𑇊":"̣","𑓃":"̣","𐨺":"̣","࣮":"̤","᳞":"̤","༷":"̥","〭":"̥","̧":"̦","̡":"̦","̹":"̦","᳙":"̭","᳘":"̮","॒":"̱","̠":"̱","ࣱ":"ٌ","ࣨ":"ٌ","ࣥ":"ٌ",ﱞ:"ﹲّ","ࣲ":"ٍ",ﱟ:"ﹴّ",ﳲ:"ﹷّ",ﱠ:"ﹶّ",ﳳ:"ﹹّ",ﱡ:"ﹸّ","ؚ":"ِ","̗":"ِ",ﳴ:"ﹻّ",ﱢ:"ﹺّ",ﱣ:"ﹼٰ","ٟ":"ٕ","̍":"ٰ","݂":"ܼ","ਃ":"ঃ","ః":"ঃ","ಃ":"ঃ","ഃ":"ঃ","ඃ":"ঃ","း":"ঃ","𑓁":"ঃ","់":"่","່":"่","້":"้","໊":"๊","໋":"๋","꙯":"⃩","\u2028":" ","\u2029":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" ","ߺ":"_","﹍":"_","﹎":"_","﹏":"_","‐":"-","‑":"-","‒":"-","–":"-","﹘":"-","۔":"-","⁃":"-","˗":"-","−":"-","➖":"-","Ⲻ":"-","⨩":"-̓","⸚":"-̈","﬩":"-̇","∸":"-̇","⨪":"-̣","꓾":"-.","～":"〜","؍":",","٫":",","‚":",","¸":",","ꓹ":",","⸲":"،","٬":"،",";":";","⸵":"؛","ः":":","ઃ":":","：":":","։":":","܃":":","܄":":","᛬":":","︰":":","᠃":":","᠉":":","⁚":":","׃":":","˸":":","꞉":":","∶":":",ː:":","ꓽ":":","⩴":"::=","⧴":":→","！":"!",ǃ:"!","ⵑ":"!","‼":"!!","⁉":"!?",ʔ:"?","Ɂ":"?","ॽ":"?",Ꭾ:"?","ꛫ":"?","⁈":"?!","⁇":"??","⸮":"؟","𝅭":".","․":".","܁":".","܂":".","꘎":".","𐩐":".","٠":".","۰":".","ꓸ":".","ꓻ":".,","‥":"..","ꓺ":"..","…":"...","꛴":"꛳꛳","・":"·","･":"·","᛫":"·","·":"·","⸱":"·","𐄁":"·","•":"·","‧":"·","∙":"·","⋅":"·","ꞏ":"·",ᐧ:"·","⋯":"···","ⵈ":"···",ᑄ:"·<","⋗":"·>",ᐷ:"·>",ᑀ:"·>",ᔯ:"·4",ᑾ:"·b",ᒀ:"·ḃ",ᑺ:"·d",ᒘ:"·J",ᒶ:"·L",ᑶ:"·P",ᑗ:"·U",ᐺ:"·V",ᐼ:"·Ʌ",ᒮ:"·Γ",ᐎ:"·Δ",ᑙ:"·Ո",ᐌ:"·ᐁ",ᐐ:"·ᐄ",ᐒ:"·ᐅ",ᐔ:"·ᐆ",ᐗ:"·ᐊ",ᐙ:"·ᐋ",ᐾ:"·ᐲ",ᑂ:"·ᐴ",ᑆ:"·ᐹ",ᑛ:"·ᑏ",ᑔ:"·ᑐ",ᑝ:"·ᑐ",ᑟ:"·ᑑ",ᑡ:"·ᑕ",ᑣ:"·ᑖ",ᑴ:"·ᑫ",ᑸ:"·ᑮ",ᑼ:"·ᑰ",ᒒ:"·ᒉ",ᒔ:"·ᒋ",ᒖ:"·ᒌ",ᒚ:"·ᒎ",ᒜ:"·ᒐ",ᒞ:"·ᒑ",ᒬ:"·ᒣ",ᒰ:"·ᒦ",ᒲ:"·ᒧ",ᒴ:"·ᒨ",ᒸ:"·ᒫ",ᓉ:"·ᓀ","ᣆ":"·ᓂ","ᣈ":"·ᓃ","ᣊ":"·ᓄ","ᣌ":"·ᓅ",ᓋ:"·ᓇ",ᓍ:"·ᓈ",ᓜ:"·ᓓ",ᓞ:"·ᓕ",ᓠ:"·ᓖ",ᓢ:"·ᓗ",ᓤ:"·ᓘ",ᓦ:"·ᓚ",ᓨ:"·ᓛ",ᓶ:"·ᓭ",ᓸ:"·ᓯ",ᓺ:"·ᓰ",ᓼ:"·ᓱ",ᓾ:"·ᓲ",ᔀ:"·ᓴ",ᔂ:"·ᓵ",ᔗ:"·ᔐ",ᔙ:"·ᔑ",ᔛ:"·ᔒ",ᔝ:"·ᔓ",ᔟ:"·ᔔ",ᔡ:"·ᔕ",ᔣ:"·ᔖ",ᔱ:"·ᔨ",ᔳ:"·ᔩ",ᔵ:"·ᔪ",ᔷ:"·ᔫ",ᔹ:"·ᔭ",ᔻ:"·ᔮ","ᣎ":"·ᕃ","ᣏ":"·ᕆ","ᣐ":"·ᕇ","ᣑ":"·ᕈ","ᣒ":"·ᕉ","ᣓ":"·ᕋ",ᕎ:"·ᕌ",ᕛ:"·ᕚ",ᕨ:"·ᕧ","ᢳ":"·ᢱ","ᢶ":"·ᢴ","ᢹ":"·ᢸ","ᣂ":"·ᣀ","꠰":"।","॥":"।।","᰼":"᰻᰻","။":"၊၊","᪩":"᪨᪨","᪫":"᪪᪨","᭟":"᭞᭞","𐩗":"𐩖𐩖","𑑌":"𑑋𑑋","𑙂":"𑙁𑙁","𑱂":"𑱁𑱁","᱿":"᱾᱾","՝":"'","＇":"'","‘":"'","’":"'","‛":"'","′":"'","‵":"'","՚":"'","׳":"'","`":"'","`":"'","｀":"'","´":"'","΄":"'","´":"'","᾽":"'","᾿":"'","῾":"'","ʹ":"'","ʹ":"'","ˈ":"'","ˊ":"'","ˋ":"'","˴":"'",ʻ:"'",ʽ:"'",ʼ:"'",ʾ:"'","ꞌ":"'",י:"'","ߴ":"'","ߵ":"'",ᑊ:"'",ᛌ:"'","𖽑":"'","𖽒":"'","᳓":"''",'"':"''","＂":"''","“":"''","”":"''","‟":"''","″":"''","‶":"''","〃":"''","״":"''","˝":"''","ʺ":"''","˶":"''",ˮ:"''",ײ:"''","‴":"'''","‷":"'''","⁗":"''''",Ɓ:"'B",Ɗ:"'D",ŉ:"'n",Ƥ:"'P",Ƭ:"'T",Ƴ:"'Y","［":"(","❨":"(","❲":"(","〔":"(","﴾":"(","⸨":"((","㈠":"(ー)","⑵":"(2)","⒇":"(2O)","⑶":"(3)","⑷":"(4)","⑸":"(5)","⑹":"(6)","⑺":"(7)","⑻":"(8)","⑼":"(9)","⒜":"(a)","🄐":"(A)","⒝":"(b)","🄑":"(B)","⒞":"(c)","🄒":"(C)","⒟":"(d)","🄓":"(D)","⒠":"(e)","🄔":"(E)","⒡":"(f)","🄕":"(F)","⒢":"(g)","🄖":"(G)","⒣":"(h)","🄗":"(H)","⒤":"(i)","⒥":"(j)","🄙":"(J)","⒦":"(k)","🄚":"(K)","⑴":"(l)","🄘":"(l)","⒧":"(l)","🄛":"(L)","⑿":"(l2)","⒀":"(l3)","⒁":"(l4)","⒂":"(l5)","⒃":"(l6)","⒄":"(l7)","⒅":"(l8)","⒆":"(l9)","⑾":"(ll)","⑽":"(lO)","🄜":"(M)","⒩":"(n)","🄝":"(N)","⒪":"(o)","🄞":"(O)","⒫":"(p)","🄟":"(P)","⒬":"(q)","🄠":"(Q)","⒭":"(r)","🄡":"(R)","⒨":"(rn)","⒮":"(s)","🄢":"(S)","🄪":"(S)","⒯":"(t)","🄣":"(T)","⒰":"(u)","🄤":"(U)","⒱":"(v)","🄥":"(V)","⒲":"(w)","🄦":"(W)","⒳":"(x)","🄧":"(X)","⒴":"(y)","🄨":"(Y)","⒵":"(z)","🄩":"(Z)","㈀":"(ᄀ)","㈎":"(가)","㈁":"(ᄂ)","㈏":"(나)","㈂":"(ᄃ)","㈐":"(다)","㈃":"(ᄅ)","㈑":"(라)","㈄":"(ᄆ)","㈒":"(마)","㈅":"(ᄇ)","㈓":"(바)","㈆":"(ᄉ)","㈔":"(사)","㈇":"(ᄋ)","㈕":"(아)","㈝":"(오전)","㈞":"(오후)","㈈":"(ᄌ)","㈖":"(자)","㈜":"(주)","㈉":"(ᄎ)","㈗":"(차)","㈊":"(ᄏ)","㈘":"(카)","㈋":"(ᄐ)","㈙":"(타)","㈌":"(ᄑ)","㈚":"(파)","㈍":"(ᄒ)","㈛":"(하)","㈦":"(七)","㈢":"(三)","🉁":"(三)","㈨":"(九)","㈡":"(二)","🉂":"(二)","㈤":"(五)","㈹":"(代)","㈽":"(企)","㉁":"(休)","㈧":"(八)","㈥":"(六)","㈸":"(労)","🉇":"(勝)","㈩":"(十)","㈿":"(協)","㈴":"(名)","㈺":"(呼)","㈣":"(四)","㈯":"(土)","㈻":"(学)","🉃":"(安)","🉅":"(打)","🉈":"(敗)","㈰":"(日)","㈪":"(月)","㈲":"(有)","㈭":"(木)","🉀":"(本)","㈱":"(株)","㈬":"(水)","㈫":"(火)","🉄":"(点)","㈵":"(特)","🉆":"(盗)","㈼":"(監)","㈳":"(社)","㈷":"(祝)","㉀":"(祭)","㉂":"(自)","㉃":"(至)","㈶":"(財)","㈾":"(資)","㈮":"(金)","］":")","❩":")","❳":")","〕":")","﴿":")","⸩":"))","❴":"{","𝄔":"{","❵":"}","〚":"⟦","〛":"⟧","⟨":"❬","〈":"❬","〈":"❬","㇛":"❬",く:"❬","𡿨":"❬","⟩":"❭","〉":"❭","〉":"❭","＾":"︿","⸿":"¶","⁎":"*","٭":"*","∗":"*","𐌟":"*","᜵":"/","⁁":"/","∕":"/","⁄":"/","╱":"/","⟋":"/","⧸":"/","𝈺":"/","㇓":"/",〳:"/","Ⳇ":"/",ノ:"/",丿:"/","⼃":"/","⧶":"/̄","⫽":"//","⫻":"///","＼":"\\","﹨":"\\","∖":"\\","⟍":"\\","⧵":"\\","⧹":"\\","𝈏":"\\","𝈻":"\\","㇔":"\\",丶:"\\","⼂":"\\","⳹":"\\\\","⑊":"\\\\","⟈":"\\ᑕ","ꝸ":"&","૰":"॰","𑂻":"॰","𑇇":"॰","⚬":"॰","𑇛":"꣼","៙":"๏","៕":"๚","៚":"๛","༌":"་","༎":"།།","˄":"^","ˆ":"^","꙾":"ˇ","˘":"ˇ","‾":"ˉ","﹉":"ˉ","﹊":"ˉ","﹋":"ˉ","﹌":"ˉ","¯":"ˉ","￣":"ˉ","▔":"ˉ",ъ:"ˉb","ꙑ":"ˉbi","͵":"ˏ","˻":"˪","꜖":"˪","꜔":"˫","。":"˳","⸰":"°","˚":"°","∘":"°","○":"°","◦":"°","⍜":"°̲","⍤":"°̈","℃":"°C","℉":"°F","௵":"௳","༛":"༚༚","༟":"༚༝","࿎":"༝༚","༞":"༝༝","Ⓒ":"©","Ⓡ":"®","Ⓟ":"℗","𝈛":"⅄","⯬":"↞","⯭":"↟","⯮":"↠","⯯":"↡","↵":"↲","⥥":"⇃⇂","⥯":"⇃ᛚ","𝛛":"∂","𝜕":"∂","𝝏":"∂","𝞉":"∂","𝟃":"∂","𞣌":"∂","𞣍":"∂̵",ð:"∂̵","⌀":"∅","𝛁":"∇","𝛻":"∇","𝜵":"∇","𝝯":"∇","𝞩":"∇","𑢨":"∇","⍢":"∇̈","⍫":"∇̴","█":"∎","■":"∎","⨿":"∐","᛭":"+","➕":"+","𐊛":"+","⨣":"+̂","⨢":"+̊","⨤":"+̃","∔":"+̇","⨥":"+̣","⨦":"+̰","⨧":"+₂","➗":"÷","‹":"<","❮":"<","˂":"<","𝈶":"<",ᐸ:"<",ᚲ:"<","⋖":"<·","Ⲵ":"<·",ᑅ:"<·","≪":"<<","⋘":"<<<","᐀":"=","⹀":"=","゠":"=","꓿":"=","≚":"=̆","≙":"=̂","≗":"=̊","≐":"=̇","≑":"=̣̇","⩮":"=⃰","⩵":"==","⩶":"===","≞":"=ͫ","›":">","❯":">","˃":">","𝈷":">",ᐳ:">","𖼿":">",ᑁ:">·","⪥":"><","≫":">>","⨠":">>","⋙":">>>","⁓":"~","˜":"~","῀":"~","∼":"~","⍨":"~̈","⸞":"~̇","⩪":"~̇","⸟":"~̣","𞣈":"∠","⋀":"∧","∯":"∮∮","∰":"∮∮∮","⸫":"∴","⸪":"∵","⸬":"∷","𑇞":"≈","♎":"≏","🝞":"≏","≣":"≡","⨃":"⊍","⨄":"⊎","𝈸":"⊏","𝈹":"⊐","⨅":"⊓","⨆":"⊔","⨂":"⊗","⍟":"⊛","🝱":"⊠","🝕":"⊡","◁":"⊲","▷":"⊳","⍣":"⋆̈","︴":"⌇","◠":"⌒","⨽":"⌙","⌥":"⌤","⧇":"⌻","◎":"⌾","⦾":"⌾","⧅":"⍂","⦰":"⍉","⏃":"⍋","⏂":"⍎","⏁":"⍕","⏆":"⍭","☸":"⎈","︵":"⏜","︶":"⏝","︷":"⏞","︸":"⏟","︹":"⏠","︺":"⏡","▱":"⏥","⏼":"⏻","︱":"│","｜":"│","┃":"│","┏":"┌","┣":"├","▐":"▌","▗":"▖","▝":"▘","☐":"□","￭":"▪","▸":"▶","►":"▶","⳩":"☧","🜊":"☩","🌒":"☽","🌙":"☽","⏾":"☾","🌘":"☾","⧙":"⦚","🜺":"⧟","⨾":"⨟","𐆠":"⳨","♩":"𝅘𝅥","♪":"𝅘𝅥𝅮","⓪":"🄍","↺":"🄎","˙":"ॱ","ൎ":"ॱ","－":"ー","—":"ー","―":"ー","─":"ー","━":"ー","㇐":"ー","ꟷ":"ー",ᅳ:"ー",ㅡ:"ー",一:"ー","⼀":"ー",ᆖ:"ーー","ힹ":"ーᅡ","ힺ":"ーᅥ","ힻ":"ーᅥ丨","ힼ":"ーᅩ",ᆕ:"ーᅮ",ᅴ:"ー丨",ㅢ:"ー丨",ᆗ:"ー丨ᅮ","🄏":"$⃠","₤":"£","〒":"₸","〶":"₸","᭜":"᭐","꧆":"꧐","𑓑":"১","೧":"౧","ၥ":"၁","①":"➀","⑩":"➉","⏨":"₁₀","𝟐":"2","𝟚":"2","𝟤":"2","𝟮":"2","𝟸":"2","🯲":"2","Ꝛ":"2",Ƨ:"2",Ϩ:"2","Ꙅ":"2",ᒿ:"2","ꛯ":"2","ꧏ":"٢","۲":"٢","૨":"२","𑓒":"২","೨":"౨","②":"➁",ƻ:"2̵","🄃":"2,","⒉":"2.","㏵":"22日","㍮":"22点","㏶":"23日","㍯":"23点","㏷":"24日","㍰":"24点","㏸":"25日","㏹":"26日","㏺":"27日","㏻":"28日","㏼":"29日","㏴":"2l日","㍭":"2l点","⒛":"2O.","㏳":"2O日","㍬":"2O点","෩":"෨ා","෯":"෨ී","㏡":"2日","㋁":"2月","㍚":"2点","𝈆":"3","𝟑":"3","𝟛":"3","𝟥":"3","𝟯":"3","𝟹":"3","🯳":"3","Ɜ":"3",Ȝ:"3",Ʒ:"3","Ꝫ":"3","Ⳍ":"3",З:"3",Ӡ:"3","𖼻":"3","𑣊":"3","۳":"٣","𞣉":"٣","૩":"३","③":"➂",Ҙ:"3̦","🄄":"3,","⒊":"3.","㏾":"3l日","㏽":"3O日","㏢":"3日","㋂":"3月","㍛":"3点","𝟒":"4","𝟜":"4","𝟦":"4","𝟰":"4","𝟺":"4","🯴":"4",Ꮞ:"4","𑢯":"4","۴":"٤","૪":"४","④":"➃","🄅":"4,","⒋":"4.",ᔰ:"4·","㏣":"4日","㋃":"4月","㍜":"4点","𝟓":"5","𝟝":"5","𝟧":"5","𝟱":"5","𝟻":"5","🯵":"5",Ƽ:"5","𑢻":"5","⑤":"➄","🄆":"5,","⒌":"5.","㏤":"5日","㋄":"5月","㍝":"5点","𝟔":"6","𝟞":"6","𝟨":"6","𝟲":"6","𝟼":"6","🯶":"6","Ⳓ":"6",б:"6",Ꮾ:"6","𑣕":"6","۶":"٦","𑓖":"৬","⑥":"➅","🄇":"6,","⒍":"6.","㏥":"6日","㋅":"6月","㍞":"6点","𝈒":"7","𝟕":"7","𝟟":"7","𝟩":"7","𝟳":"7","𝟽":"7","🯷":"7","𐓒":"7","𑣆":"7","⑦":"➆","🄈":"7,","⒎":"7.","㏦":"7日","㋆":"7月","㍟":"7点","ଃ":"8","৪":"8","੪":"8","𞣋":"8","𝟖":"8","𝟠":"8","𝟪":"8","𝟴":"8","𝟾":"8","🯸":"8",ȣ:"8",Ȣ:"8","𐌚":"8","૮":"८","⑧":"➇","🄉":"8,","⒏":"8.","㏧":"8日","㋇":"8月","㍠":"8点","੧":"9","୨":"9","৭":"9","൭":"9","𝟗":"9","𝟡":"9","𝟫":"9","𝟵":"9","𝟿":"9","🯹":"9","Ꝯ":"9","Ⳋ":"9","𑣌":"9","𑢬":"9","𑣖":"9","१":"٩","𑣤":"٩","۹":"٩","೯":"౯","⑨":"➈","🄊":"9,","⒐":"9.","㏨":"9日","㋈":"9月","㍡":"9点","⍺":"a",ａ:"a","𝐚":"a","𝑎":"a","𝒂":"a","𝒶":"a","𝓪":"a","𝔞":"a","𝕒":"a","𝖆":"a","𝖺":"a","𝗮":"a","𝘢":"a","𝙖":"a","𝚊":"a",ɑ:"a",α:"a","𝛂":"a","𝛼":"a","𝜶":"a","𝝰":"a","𝞪":"a",а:"a","ⷶ":"ͣ",Ａ:"A","𝐀":"A","𝐴":"A","𝑨":"A","𝒜":"A","𝓐":"A","𝔄":"A","𝔸":"A","𝕬":"A","𝖠":"A","𝗔":"A","𝘈":"A","𝘼":"A","𝙰":"A",Α:"A","𝚨":"A","𝛢":"A","𝜜":"A","𝝖":"A","𝞐":"A",А:"A",Ꭺ:"A",ᗅ:"A","ꓮ":"A","𖽀":"A","𐊠":"A","⍶":"a̲",ǎ:"ă",Ǎ:"Ă",ȧ:"å",Ȧ:"Å",ẚ:"ả","℀":"a/c","℁":"a/s","ꜳ":"aa","Ꜳ":"AA",æ:"ae",ӕ:"ae",Æ:"AE",Ӕ:"AE","ꜵ":"ao","Ꜵ":"AO","🜇":"AR","ꜷ":"au","Ꜷ":"AU","ꜹ":"av","ꜻ":"av","Ꜹ":"AV","Ꜻ":"AV","ꜽ":"ay","Ꜽ":"AY","ꭺ":"ᴀ","∀":"Ɐ","𝈗":"Ɐ",ᗄ:"Ɐ","ꓯ":"Ɐ","𐐟":"Ɒ","𝐛":"b","𝑏":"b","𝒃":"b","𝒷":"b","𝓫":"b","𝔟":"b","𝕓":"b","𝖇":"b","𝖻":"b","𝗯":"b","𝘣":"b","𝙗":"b","𝚋":"b",Ƅ:"b",Ь:"b",Ꮟ:"b",ᑲ:"b",ᖯ:"b",Ｂ:"B",ℬ:"B","𝐁":"B","𝐵":"B","𝑩":"B","𝓑":"B","𝔅":"B","𝔹":"B","𝕭":"B","𝖡":"B","𝗕":"B","𝘉":"B","𝘽":"B","𝙱":"B","Ꞵ":"B",Β:"B","𝚩":"B","𝛣":"B","𝜝":"B","𝝗":"B","𝞑":"B",В:"B",Ᏼ:"B",ᗷ:"B","ꓐ":"B","𐊂":"B","𐊡":"B","𐌁":"B",ɓ:"b̔",ᑳ:"ḃ",ƃ:"b̄",Ƃ:"b̄",Б:"b̄",ƀ:"b̵",ҍ:"b̵",Ҍ:"b̵",ѣ:"b̵",Ѣ:"b̵",ᑿ:"b·",ᒁ:"ḃ·",ᒈ:"b'",Ы:"bl",в:"ʙ","ᏼ":"ʙ",ｃ:"c","ⅽ":"c","𝐜":"c","𝑐":"c","𝒄":"c","𝒸":"c","𝓬":"c","𝔠":"c","𝕔":"c","𝖈":"c","𝖼":"c","𝗰":"c","𝘤":"c","𝙘":"c","𝚌":"c","ᴄ":"c",ϲ:"c","ⲥ":"c",с:"c","ꮯ":"c","𐐽":"c","ⷭ":"ͨ","🝌":"C","𑣲":"C","𑣩":"C",Ｃ:"C","Ⅽ":"C",ℂ:"C",ℭ:"C","𝐂":"C","𝐶":"C","𝑪":"C","𝒞":"C","𝓒":"C","𝕮":"C","𝖢":"C","𝗖":"C","𝘊":"C","𝘾":"C","𝙲":"C","Ϲ":"C","Ⲥ":"C",С:"C",Ꮯ:"C","ꓚ":"C","𐊢":"C","𐌂":"C","𐐕":"C","𐔜":"C","¢":"c̸","ȼ":"c̸","₡":"C⃫","🅮":"C⃠",ç:"c̦",ҫ:"c̦",Ç:"C̦",Ҫ:"C̦",Ƈ:"C'","℅":"c/o","℆":"c/u","🅭":"㏄	⃝","⋴":"ꞓ",ɛ:"ꞓ",ε:"ꞓ","ϵ":"ꞓ","𝛆":"ꞓ","𝛜":"ꞓ","𝜀":"ꞓ","𝜖":"ꞓ","𝜺":"ꞓ","𝝐":"ꞓ","𝝴":"ꞓ","𝞊":"ꞓ","𝞮":"ꞓ","𝟄":"ꞓ","ⲉ":"ꞓ",є:"ꞓ","ԑ":"ꞓ","ꮛ":"ꞓ","𑣎":"ꞓ","𐐩":"ꞓ","€":"Ꞓ","Ⲉ":"Ꞓ",Є:"Ꞓ","⍷":"ꞓ̲","ͽ":"ꜿ","Ͽ":"Ꜿ","ⅾ":"d","ⅆ":"d","𝐝":"d","𝑑":"d","𝒅":"d","𝒹":"d","𝓭":"d","𝔡":"d","𝕕":"d","𝖉":"d","𝖽":"d","𝗱":"d","𝘥":"d","𝙙":"d","𝚍":"d","ԁ":"d",Ꮷ:"d",ᑯ:"d","ꓒ":"d","Ⅾ":"D","ⅅ":"D","𝐃":"D","𝐷":"D","𝑫":"D","𝒟":"D","𝓓":"D","𝔇":"D","𝔻":"D","𝕯":"D","𝖣":"D","𝗗":"D","𝘋":"D","𝘿":"D","𝙳":"D",Ꭰ:"D",ᗞ:"D",ᗪ:"D","ꓓ":"D",ɗ:"d̔",ɖ:"d̨",ƌ:"d̄",đ:"d̵",Đ:"D̵",Ð:"D̵",Ɖ:"D̵","₫":"ḏ̵","ꝺ":"Ꝺ",ᑻ:"d·",ᒇ:"d'",ʤ:"dȝ",ǳ:"dz",ʣ:"dz",ǲ:"Dz",Ǳ:"DZ",ǆ:"dž",ǅ:"Dž",Ǆ:"DŽ",ʥ:"dʑ","ꭰ":"ᴅ","⸹":"ẟ",δ:"ẟ","𝛅":"ẟ","𝛿":"ẟ","𝜹":"ẟ","𝝳":"ẟ","𝞭":"ẟ",ծ:"ẟ",ᕷ:"ẟ","℮":"e",ｅ:"e",ℯ:"e","ⅇ":"e","𝐞":"e","𝑒":"e","𝒆":"e","𝓮":"e","𝔢":"e","𝕖":"e","𝖊":"e","𝖾":"e","𝗲":"e","𝘦":"e","𝙚":"e","𝚎":"e","ꬲ":"e",е:"e",ҽ:"e","ⷷ":"ͤ","⋿":"E",Ｅ:"E",ℰ:"E","𝐄":"E","𝐸":"E","𝑬":"E","𝓔":"E","𝔈":"E","𝔼":"E","𝕰":"E","𝖤":"E","𝗘":"E","𝘌":"E","𝙀":"E","𝙴":"E",Ε:"E","𝚬":"E","𝛦":"E","𝜠":"E","𝝚":"E","𝞔":"E",Е:"E","ⴹ":"E",Ꭼ:"E","ꓰ":"E","𑢦":"E","𑢮":"E","𐊆":"E",ě:"ĕ",Ě:"Ĕ","ɇ":"e̸","Ɇ":"E̸",ҿ:"ę","ꭼ":"ᴇ",ə:"ǝ",ә:"ǝ","∃":"Ǝ","ⴺ":"Ǝ","ꓱ":"Ǝ",ɚ:"ǝ˞","ᴔ":"ǝo","ꭁ":"ǝo̸","ꭂ":"ǝo̵",Ә:"Ə","𝈡":"Ɛ",ℇ:"Ɛ","Ԑ":"Ɛ",Ꮛ:"Ɛ","𖼭":"Ɛ","𐐁":"Ɛ","ᶟ":"ᵋ","ᴈ":"ɜ",з:"ɜ",ҙ:"ɜ̦","𐑂":"ɞ","ꞝ":"ʚ","𐐪":"ʚ","𝐟":"f","𝑓":"f","𝒇":"f","𝒻":"f","𝓯":"f","𝔣":"f","𝕗":"f","𝖋":"f","𝖿":"f","𝗳":"f","𝘧":"f","𝙛":"f","𝚏":"f","ꬵ":"f","ꞙ":"f",ſ:"f","ẝ":"f",ք:"f","𝈓":"F",ℱ:"F","𝐅":"F","𝐹":"F","𝑭":"F","𝓕":"F","𝔉":"F","𝔽":"F","𝕱":"F","𝖥":"F","𝗙":"F","𝘍":"F","𝙁":"F","𝙵":"F","Ꞙ":"F",Ϝ:"F","𝟊":"F",ᖴ:"F","ꓝ":"F","𑣂":"F","𑢢":"F","𐊇":"F","𐊥":"F","𐔥":"F",ƒ:"f̦",Ƒ:"F̦","ᵮ":"f̴","℻":"FAX",ﬀ:"ff",ﬃ:"ffi",ﬄ:"ffl",ﬁ:"fi",ﬂ:"fl",ʩ:"fŋ",ᖵ:"Ⅎ","ꓞ":"Ⅎ","𝈰":"ꟻ",ᖷ:"ꟻ",ｇ:"g",ℊ:"g","𝐠":"g","𝑔":"g","𝒈":"g","𝓰":"g","𝔤":"g","𝕘":"g","𝖌":"g","𝗀":"g","𝗴":"g","𝘨":"g","𝙜":"g","𝚐":"g",ɡ:"g","ᶃ":"g",ƍ:"g",ց:"g","𝐆":"G","𝐺":"G","𝑮":"G","𝒢":"G","𝓖":"G","𝔊":"G","𝔾":"G","𝕲":"G","𝖦":"G","𝗚":"G","𝘎":"G","𝙂":"G","𝙶":"G","Ԍ":"G",Ꮐ:"G",Ᏻ:"G","ꓖ":"G","ᶢ":"ᵍ",ɠ:"g̔",ǧ:"ğ",Ǧ:"Ğ",ǵ:"ģ",ǥ:"g̵",Ǥ:"G̵",Ɠ:"G'","ԍ":"ɢ","ꮐ":"ɢ","ᏻ":"ɢ",ｈ:"h",ℎ:"h","𝐡":"h","𝒉":"h","𝒽":"h","𝓱":"h","𝔥":"h","𝕙":"h","𝖍":"h","𝗁":"h","𝗵":"h","𝘩":"h","𝙝":"h","𝚑":"h",һ:"h",հ:"h",Ꮒ:"h",Ｈ:"H",ℋ:"H",ℌ:"H",ℍ:"H","𝐇":"H","𝐻":"H","𝑯":"H","𝓗":"H","𝕳":"H","𝖧":"H","𝗛":"H","𝘏":"H","𝙃":"H","𝙷":"H",Η:"H","𝚮":"H","𝛨":"H","𝜢":"H","𝝜":"H","𝞖":"H","Ⲏ":"H",Н:"H",Ꮋ:"H",ᕼ:"H","ꓧ":"H","𐋏":"H","ᵸ":"ᴴ",ɦ:"h̔","ꚕ":"h̔",Ᏺ:"h̔","Ⱨ":"H̩",Ң:"H̩",ħ:"h̵",ℏ:"h̵",ћ:"h̵",Ħ:"H̵","Ӊ":"H̦",Ӈ:"H̦",н:"ʜ","ꮋ":"ʜ",ң:"ʜ̩","ӊ":"ʜ̦",ӈ:"ʜ̦","Ԋ":"Ƕ","ꮀ":"ⱶ","Ͱ":"Ⱶ",Ꭸ:"Ⱶ",Ꮀ:"Ⱶ","ꚱ":"Ⱶ","ꞕ":"ꜧ","˛":"i","⍳":"i",ｉ:"i","ⅰ":"i",ℹ:"i","ⅈ":"i","𝐢":"i","𝑖":"i","𝒊":"i","𝒾":"i","𝓲":"i","𝔦":"i","𝕚":"i","𝖎":"i","𝗂":"i","𝗶":"i","𝘪":"i","𝙞":"i","𝚒":"i",ı:"i","𝚤":"i",ɪ:"i",ɩ:"i",ι:"i",ι:"i",ͺ:"i","𝛊":"i","𝜄":"i","𝜾":"i","𝝸":"i","𝞲":"i",і:"i","ꙇ":"i","ӏ":"i","ꭵ":"i",Ꭵ:"i","𑣃":"i","ⓛ":"Ⓘ","⍸":"i̲",ǐ:"ĭ",Ǐ:"Ĭ",ɨ:"i̵","ᵻ":"i̵","ᵼ":"i̵","ⅱ":"ii","ⅲ":"iii",ĳ:"ij","ⅳ":"iv","ⅸ":"ix",ｊ:"j","ⅉ":"j","𝐣":"j","𝑗":"j","𝒋":"j","𝒿":"j","𝓳":"j","𝔧":"j","𝕛":"j","𝖏":"j","𝗃":"j","𝗷":"j","𝘫":"j","𝙟":"j","𝚓":"j",ϳ:"j",ј:"j",Ｊ:"J","𝐉":"J","𝐽":"J","𝑱":"J","𝒥":"J","𝓙":"J","𝔍":"J","𝕁":"J","𝕵":"J","𝖩":"J","𝗝":"J","𝘑":"J","𝙅":"J","𝙹":"J","Ʝ":"J","Ϳ":"J",Ј:"J",Ꭻ:"J",ᒍ:"J","ꓙ":"J","ɉ":"j̵","Ɉ":"J̵",ᒙ:"J·","𝚥":"ȷ",յ:"ȷ","ꭻ":"ᴊ","𝐤":"k","𝑘":"k","𝒌":"k","𝓀":"k","𝓴":"k","𝔨":"k","𝕜":"k","𝖐":"k","𝗄":"k","𝗸":"k","𝘬":"k","𝙠":"k","𝚔":"k",K:"K",Ｋ:"K","𝐊":"K","𝐾":"K","𝑲":"K","𝒦":"K","𝓚":"K","𝔎":"K","𝕂":"K","𝕶":"K","𝖪":"K","𝗞":"K","𝘒":"K","𝙆":"K","𝙺":"K",Κ:"K","𝚱":"K","𝛫":"K","𝜥":"K","𝝟":"K","𝞙":"K","Ⲕ":"K",К:"K",Ꮶ:"K",ᛕ:"K","ꓗ":"K","𐔘":"K",ƙ:"k̔","Ⱪ":"K̩",Қ:"K̩","₭":"K̵","Ꝁ":"K̵",Ҟ:"K̵",Ƙ:"K'","׀":"l","|":"l","∣":"l","⏽":"l","￨":"l","١":"l","۱":"l","𐌠":"l","𞣇":"l","𝟏":"l","𝟙":"l","𝟣":"l","𝟭":"l","𝟷":"l","🯱":"l",I:Ph,Ｉ:"l","Ⅰ":"l",ℐ:"l",ℑ:"l","𝐈":"l","𝐼":"l","𝑰":"l","𝓘":"l","𝕀":"l","𝕴":"l","𝖨":"l","𝗜":"l","𝘐":"l","𝙄":"l","𝙸":"l",Ɩ:"l",ｌ:"l","ⅼ":"l",ℓ:"l","𝐥":"l","𝑙":"l","𝒍":"l","𝓁":"l","𝓵":"l","𝔩":"l","𝕝":"l","𝖑":"l","𝗅":"l","𝗹":"l","𝘭":"l","𝙡":"l","𝚕":"l",ǀ:"l",Ι:"l","𝚰":"l","𝛪":"l","𝜤":"l","𝝞":"l","𝞘":"l","Ⲓ":"l",І:"l",Ӏ:"l",ו:"l",ן:"l",ا:"l","𞸀":"l","𞺀":"l",ﺎ:"l",ﺍ:"l","ߊ":"l","ⵏ":"l",ᛁ:"l","ꓲ":"l","𖼨":"l","𐊊":"l","𐌉":"l","𝈪":"L","Ⅼ":"L",ℒ:"L","𝐋":"L","𝐿":"L","𝑳":"L","𝓛":"L","𝔏":"L","𝕃":"L","𝕷":"L","𝖫":"L","𝗟":"L","𝘓":"L","𝙇":"L","𝙻":"L","Ⳑ":"L",Ꮮ:"L",ᒪ:"L","ꓡ":"L","𖼖":"L","𑢣":"L","𑢲":"L","𐐛":"L","𐔦":"L",ﴼ:"l̋",ﴽ:"l̋",ł:"l̸",Ł:"L̸",ɭ:"l̨",Ɨ:"l̵",ƚ:"l̵",ɫ:"l̴",إ:"lٕ",ﺈ:"lٕ",ﺇ:"lٕ",ٳ:"lٕ",ŀ:"l·",Ŀ:"l·",ᒷ:"l·","🄂":"l,","⒈":"l.",ױ:"l'","⒓":"l2.","㏫":"l2日","㋋":"l2月","㍤":"l2点","⒔":"l3.","㏬":"l3日","㍥":"l3点","⒕":"l4.","㏭":"l4日","㍦":"l4点","⒖":"l5.","㏮":"l5日","㍧":"l5点","⒗":"l6.","㏯":"l6日","㍨":"l6点","⒘":"l7.","㏰":"l7日","㍩":"l7点","⒙":"l8.","㏱":"l8日","㍪":"l8点","⒚":"l9.","㏲":"l9日","㍫":"l9点",ǉ:"lj",Ĳ:"lJ",ǈ:"Lj",Ǉ:"LJ","‖":"ll","∥":"ll","Ⅱ":"ll",ǁ:"ll",װ:"ll","𐆙":"l̵l̵","⒒":"ll.","Ⅲ":"lll","𐆘":"l̵l̵S̵","㏪":"ll日","㋊":"ll月","㍣":"ll点",Ю:"lO","⒑":"lO.","㏩":"lO日","㋉":"lO月","㍢":"lO点",ʪ:"ls","₶":"lt","Ⅳ":"lV","Ⅸ":"lX",ɮ:"lȝ",ʫ:"lz",أ:"lٴ",ﺄ:"lٴ",ﺃ:"lٴ",ٲ:"lٴ",ٵ:"lٴ",ﷳ:"lكبر",ﷲ:"lللّٰo","㏠":"l日","㋀":"l月","㍙":"l点","ⳑ":"ʟ","ꮮ":"ʟ","𐑃":"ʟ",Ｍ:"M","Ⅿ":"M",ℳ:"M","𝐌":"M","𝑀":"M","𝑴":"M","𝓜":"M","𝔐":"M","𝕄":"M","𝕸":"M","𝖬":"M","𝗠":"M","𝘔":"M","𝙈":"M","𝙼":"M",Μ:"M","𝚳":"M","𝛭":"M","𝜧":"M","𝝡":"M","𝞛":"M","Ϻ":"M","Ⲙ":"M",М:"M",Ꮇ:"M",ᗰ:"M",ᛖ:"M","ꓟ":"M","𐊰":"M","𐌑":"M","Ӎ":"M̦","🝫":"MB","ⷨ":"ᷟ","𝐧":"n","𝑛":"n","𝒏":"n","𝓃":"n","𝓷":"n","𝔫":"n","𝕟":"n","𝖓":"n","𝗇":"n","𝗻":"n","𝘯":"n","𝙣":"n","𝚗":"n",ո:"n",ռ:"n",Ｎ:"N",ℕ:"N","𝐍":"N","𝑁":"N","𝑵":"N","𝒩":"N","𝓝":"N","𝔑":"N","𝕹":"N","𝖭":"N","𝗡":"N","𝘕":"N","𝙉":"N","𝙽":"N",Ν:"N","𝚴":"N","𝛮":"N","𝜨":"N","𝝢":"N","𝞜":"N","Ⲛ":"N","ꓠ":"N","𐔓":"N","𐆎":"N̊",ɳ:"n̨",ƞ:"n̩",η:"n̩","𝛈":"n̩","𝜂":"n̩","𝜼":"n̩","𝝶":"n̩","𝞰":"n̩",Ɲ:"N̦","ᵰ":"n̴",ǌ:"nj",ǋ:"Nj",Ǌ:"NJ","№":"No","ͷ":"ᴎ",и:"ᴎ","𐑍":"ᴎ",ņ:"ɲ","ం":"o","ಂ":"o","ം":"o","ං":"o","०":"o","੦":"o","૦":"o","௦":"o","౦":"o","೦":"o","൦":"o","๐":"o","໐":"o","၀":"o","٥":"o","۵":"o",ｏ:"o",ℴ:"o","𝐨":"o","𝑜":"o","𝒐":"o","𝓸":"o","𝔬":"o","𝕠":"o","𝖔":"o","𝗈":"o","𝗼":"o","𝘰":"o","𝙤":"o","𝚘":"o","ᴏ":"o","ᴑ":"o","ꬽ":"o",ο:"o","𝛐":"o","𝜊":"o","𝝄":"o","𝝾":"o","𝞸":"o",σ:"o","𝛔":"o","𝜎":"o","𝝈":"o","𝞂":"o","𝞼":"o","ⲟ":"o",о:"o","ჿ":"o",օ:"o",ס:"o",ه:"o","𞸤":"o","𞹤":"o","𞺄":"o",ﻫ:"o",ﻬ:"o",ﻪ:"o",ﻩ:"o",ھ:"o",ﮬ:"o",ﮭ:"o",ﮫ:"o",ﮪ:"o",ہ:"o",ﮨ:"o",ﮩ:"o",ﮧ:"o",ﮦ:"o",ە:"o",ഠ:"o",ဝ:"o","𐓪":"o","𑣈":"o","𑣗":"o","𐐬":"o","߀":"O","০":"O","୦":"O","〇":"O","𑓐":"O","𑣠":"O","𝟎":"O","𝟘":"O","𝟢":"O","𝟬":"O","𝟶":"O","🯰":"O",Ｏ:"O","𝐎":"O","𝑂":"O","𝑶":"O","𝒪":"O","𝓞":"O","𝔒":"O","𝕆":"O","𝕺":"O","𝖮":"O","𝗢":"O","𝘖":"O","𝙊":"O","𝙾":"O",Ο:"O","𝚶":"O","𝛰":"O","𝜪":"O","𝝤":"O","𝞞":"O","Ⲟ":"O",О:"O",Օ:"O","ⵔ":"O",ዐ:"O",ଠ:"O","𐓂":"O","ꓳ":"O","𑢵":"O","𐊒":"O","𐊫":"O","𐐄":"O","𐔖":"O","⁰":"º","ᵒ":"º",ǒ:"ŏ",Ǒ:"Ŏ","ۿ":"ô",Ő:"Ö",ø:"o̸","ꬾ":"o̸",Ø:"O̸","ⵁ":"O̸",Ǿ:"Ó̸",ɵ:"o̵","ꝋ":"o̵",ө:"o̵",ѳ:"o̵","ꮎ":"o̵","ꮻ":"o̵","⊖":"O̵","⊝":"O̵","⍬":"O̵","𝈚":"O̵","🜔":"O̵",Ɵ:"O̵","Ꝋ":"O̵",θ:"O̵",ϑ:"O̵","𝛉":"O̵","𝛝":"O̵","𝜃":"O̵","𝜗":"O̵","𝜽":"O̵","𝝑":"O̵","𝝷":"O̵","𝞋":"O̵","𝞱":"O̵","𝟅":"O̵",Θ:"O̵","ϴ":"O̵","𝚯":"O̵","𝚹":"O̵","𝛩":"O̵","𝛳":"O̵","𝜣":"O̵","𝜭":"O̵","𝝝":"O̵","𝝧":"O̵","𝞗":"O̵","𝞡":"O̵",Ө:"O̵",Ѳ:"O̵","ⴱ":"O̵",Ꮎ:"O̵",Ꮻ:"O̵","ꭴ":"ơ",ﳙ:"oٰ","🄁":"O,","🄀":"O.",ơ:"o'",Ơ:"O'",Ꭴ:"O'","%":"º/₀","٪":"º/₀","⁒":"º/₀","‰":"º/₀₀","؉":"º/₀₀","‱":"º/₀₀₀","؊":"º/₀₀₀",œ:"oe",Œ:"OE",ɶ:"oᴇ","∞":"oo","ꝏ":"oo","ꚙ":"oo","Ꝏ":"OO","Ꚙ":"OO",ﳗ:"oج",ﱑ:"oج",ﳘ:"oم",ﱒ:"oم",ﶓ:"oمج",ﶔ:"oمم",ﱓ:"oى",ﱔ:"oى","ൟ":"oരo",တ:"oာ","㍘":"O点","ↄ":"ɔ","ᴐ":"ɔ","ͻ":"ɔ","𐑋":"ɔ","Ↄ":"Ɔ","Ͻ":"Ɔ","ꓛ":"Ɔ","𐐣":"Ɔ","ꬿ":"ɔ̸","ꭢ":"ɔe","𐐿":"ɷ","⍴":"p",ｐ:"p","𝐩":"p","𝑝":"p","𝒑":"p","𝓅":"p","𝓹":"p","𝔭":"p","𝕡":"p","𝖕":"p","𝗉":"p","𝗽":"p","𝘱":"p","𝙥":"p","𝚙":"p",ρ:"p",ϱ:"p","𝛒":"p","𝛠":"p","𝜌":"p","𝜚":"p","𝝆":"p","𝝔":"p","𝞀":"p","𝞎":"p","𝞺":"p","𝟈":"p","ⲣ":"p",р:"p",Ｐ:"P",ℙ:"P","𝐏":"P","𝑃":"P","𝑷":"P","𝒫":"P","𝓟":"P","𝔓":"P","𝕻":"P","𝖯":"P","𝗣":"P","𝘗":"P","𝙋":"P","𝙿":"P",Ρ:"P","𝚸":"P","𝛲":"P","𝜬":"P","𝝦":"P","𝞠":"P","Ⲣ":"P",Р:"P",Ꮲ:"P",ᑭ:"P","ꓑ":"P","𐊕":"P",ƥ:"p̔","ᵽ":"p̵",ᑷ:"p·",ᒆ:"P'","ᴩ":"ᴘ","ꮲ":"ᴘ",φ:"ɸ",ϕ:"ɸ","𝛗":"ɸ","𝛟":"ɸ","𝜑":"ɸ","𝜙":"ɸ","𝝋":"ɸ","𝝓":"ɸ","𝞅":"ɸ","𝞍":"ɸ","𝞿":"ɸ","𝟇":"ɸ","ⲫ":"ɸ",ф:"ɸ","𝐪":"q","𝑞":"q","𝒒":"q","𝓆":"q","𝓺":"q","𝔮":"q","𝕢":"q","𝖖":"q","𝗊":"q","𝗾":"q","𝘲":"q","𝙦":"q","𝚚":"q","ԛ":"q",գ:"q",զ:"q",ℚ:"Q","𝐐":"Q","𝑄":"Q","𝑸":"Q","𝒬":"Q","𝓠":"Q","𝔔":"Q","𝕼":"Q","𝖰":"Q","𝗤":"Q","𝘘":"Q","𝙌":"Q","𝚀":"Q","ⵕ":"Q",ʠ:"q̔","🜀":"QE","ᶐ":"ɋ","ᴋ":"ĸ",κ:"ĸ",ϰ:"ĸ","𝛋":"ĸ","𝛞":"ĸ","𝜅":"ĸ","𝜘":"ĸ","𝜿":"ĸ","𝝒":"ĸ","𝝹":"ĸ","𝞌":"ĸ","𝞳":"ĸ","𝟆":"ĸ","ⲕ":"ĸ",к:"ĸ","ꮶ":"ĸ",қ:"ĸ̩",ҟ:"ĸ̵","𝐫":"r","𝑟":"r","𝒓":"r","𝓇":"r","𝓻":"r","𝔯":"r","𝕣":"r","𝖗":"r","𝗋":"r","𝗿":"r","𝘳":"r","𝙧":"r","𝚛":"r","ꭇ":"r","ꭈ":"r","ᴦ":"r","ⲅ":"r",г:"r","ꮁ":"r","𝈖":"R",ℛ:"R",ℜ:"R",ℝ:"R","𝐑":"R","𝑅":"R","𝑹":"R","𝓡":"R","𝕽":"R","𝖱":"R","𝗥":"R","𝘙":"R","𝙍":"R","𝚁":"R",Ʀ:"R",Ꭱ:"R",Ꮢ:"R","𐒴":"R",ᖇ:"R","ꓣ":"R","𖼵":"R",ɽ:"r̨",ɼ:"r̩","ɍ":"r̵",ғ:"r̵","ᵲ":"r̴",ґ:"r'","𑣣":"rn",m:Dh,"ⅿ":"rn","𝐦":"rn","𝑚":"rn","𝒎":"rn","𝓂":"rn","𝓶":"rn","𝔪":"rn","𝕞":"rn","𝖒":"rn","𝗆":"rn","𝗺":"rn","𝘮":"rn","𝙢":"rn","𝚖":"rn","𑜀":"rn","₥":"rn̸",ɱ:"rn̦","ᵯ":"rn̴","₨":"Rs","ꭱ":"ʀ","ꮢ":"ʀ",я:"ᴙ","ᵳ":"ɾ̴","℩":"ɿ",ｓ:"s","𝐬":"s","𝑠":"s","𝒔":"s","𝓈":"s","𝓼":"s","𝔰":"s","𝕤":"s","𝖘":"s","𝗌":"s","𝘀":"s","𝘴":"s","𝙨":"s","𝚜":"s","ꜱ":"s",ƽ:"s",ѕ:"s","ꮪ":"s","𑣁":"s","𐑈":"s",Ｓ:"S","𝐒":"S","𝑆":"S","𝑺":"S","𝒮":"S","𝓢":"S","𝔖":"S","𝕊":"S","𝕾":"S","𝖲":"S","𝗦":"S","𝘚":"S","𝙎":"S","𝚂":"S",Ѕ:"S",Տ:"S",Ꮥ:"S",Ꮪ:"S","ꓢ":"S","𖼺":"S","𐊖":"S","𐐠":"S",ʂ:"s̨","ᵴ":"s̴","ꞵ":"ß",β:"ß",ϐ:"ß","𝛃":"ß","𝛽":"ß","𝜷":"ß","𝝱":"ß","𝞫":"ß",Ᏸ:"ß","🝜":"sss",ﬆ:"st","∫":"ʃ","ꭍ":"ʃ","∑":"Ʃ","⅀":"Ʃ",Σ:"Ʃ","𝚺":"Ʃ","𝛴":"Ʃ","𝜮":"Ʃ","𝝨":"Ʃ","𝞢":"Ʃ","ⵉ":"Ʃ","∬":"ʃʃ","∭":"ʃʃʃ","⨌":"ʃʃʃʃ","𝐭":"t","𝑡":"t","𝒕":"t","𝓉":"t","𝓽":"t","𝔱":"t","𝕥":"t","𝖙":"t","𝗍":"t","𝘁":"t","𝘵":"t","𝙩":"t","𝚝":"t","⊤":"T","⟙":"T","🝨":"T",Ｔ:"T","𝐓":"T","𝑇":"T","𝑻":"T","𝒯":"T","𝓣":"T","𝔗":"T","𝕋":"T","𝕿":"T","𝖳":"T","𝗧":"T","𝘛":"T","𝙏":"T","𝚃":"T",Τ:"T","𝚻":"T","𝛵":"T","𝜯":"T","𝝩":"T","𝞣":"T","Ⲧ":"T",Т:"T",Ꭲ:"T","ꓔ":"T","𖼊":"T","𑢼":"T","𐊗":"T","𐊱":"T","𐌕":"T",ƭ:"t̔","⍡":"T̈","Ⱦ":"T̸",Ț:"Ţ",Ʈ:"T̨",Ҭ:"T̩","₮":"T⃫",ŧ:"t̵",Ŧ:"T̵","ᵵ":"t̴",Ⴀ:"Ꞇ","Ꜩ":"T3",ʨ:"tɕ","℡":"TEL","ꝷ":"tf",ʦ:"ts",ʧ:"tʃ","ꜩ":"tȝ",τ:"ᴛ","𝛕":"ᴛ","𝜏":"ᴛ","𝝉":"ᴛ","𝞃":"ᴛ","𝞽":"ᴛ",т:"ᴛ","ꭲ":"ᴛ",ҭ:"ᴛ̩",ţ:"ƫ",ț:"ƫ",Ꮏ:"ƫ","𝐮":"u","𝑢":"u","𝒖":"u","𝓊":"u","𝓾":"u","𝔲":"u","𝕦":"u","𝖚":"u","𝗎":"u","𝘂":"u","𝘶":"u","𝙪":"u","𝚞":"u","ꞟ":"u","ᴜ":"u","ꭎ":"u","ꭒ":"u",ʋ:"u",υ:"u","𝛖":"u","𝜐":"u","𝝊":"u","𝞄":"u","𝞾":"u",ս:"u","𐓶":"u","𑣘":"u","∪":"U","⋃":"U","𝐔":"U","𝑈":"U","𝑼":"U","𝒰":"U","𝓤":"U","𝔘":"U","𝕌":"U","𝖀":"U","𝖴":"U","𝗨":"U","𝘜":"U","𝙐":"U","𝚄":"U",Ս:"U",ሀ:"U","𐓎":"U",ᑌ:"U","ꓴ":"U","𖽂":"U","𑢸":"U",ǔ:"ŭ",Ǔ:"Ŭ","ᵾ":"u̵","ꮜ":"u̵","Ʉ":"U̵",Ꮜ:"U̵",ᑘ:"U·",ᑧ:"U'","ᵫ":"ue","ꭣ":"uo",ṃ:"ꭑ",պ:"ɰ",ሣ:"ɰ","℧":"Ʊ",ᘮ:"Ʊ",ᘴ:"Ʊ","ᵿ":"ʊ̵","∨":"v","⋁":"v",ｖ:"v","ⅴ":"v","𝐯":"v","𝑣":"v","𝒗":"v","𝓋":"v","𝓿":"v","𝔳":"v","𝕧":"v","𝖛":"v","𝗏":"v","𝘃":"v","𝘷":"v","𝙫":"v","𝚟":"v","ᴠ":"v",ν:"v","𝛎":"v","𝜈":"v","𝝂":"v","𝝼":"v","𝞶":"v",ѵ:"v",ט:"v","𑜆":"v","ꮩ":"v","𑣀":"v","𝈍":"V","٧":"V","۷":"V","Ⅴ":"V","𝐕":"V","𝑉":"V","𝑽":"V","𝒱":"V","𝓥":"V","𝔙":"V","𝕍":"V","𝖁":"V","𝖵":"V","𝗩":"V","𝘝":"V","𝙑":"V","𝚅":"V",Ѵ:"V","ⴸ":"V",Ꮩ:"V",ᐯ:"V","ꛟ":"V","ꓦ":"V","𖼈":"V","𑢠":"V","𐔝":"V","𐆗":"V̵",ᐻ:"V·","🝬":"VB","ⅵ":"vi","ⅶ":"vii","ⅷ":"viii","Ⅵ":"Vl","Ⅶ":"Vll","Ⅷ":"Vlll","🜈":"Vᷤ","ᴧ":"ʌ","𐓘":"ʌ","٨":"Ʌ","۸":"Ʌ",Λ:"Ʌ","𝚲":"Ʌ","𝛬":"Ʌ","𝜦":"Ʌ","𝝠":"Ʌ","𝞚":"Ʌ",Л:"Ʌ","ⴷ":"Ʌ","𐒰":"Ʌ",ᐱ:"Ʌ","ꛎ":"Ʌ","ꓥ":"Ʌ","𖼽":"Ʌ","𐊍":"Ʌ","Ӆ":"Ʌ̦",ᐽ:"Ʌ·",ɯ:"w","𝐰":"w","𝑤":"w","𝒘":"w","𝓌":"w","𝔀":"w","𝔴":"w","𝕨":"w","𝖜":"w","𝗐":"w","𝘄":"w","𝘸":"w","𝙬":"w","𝚠":"w","ᴡ":"w",ѡ:"w","ԝ":"w",ա:"w","𑜊":"w","𑜎":"w","𑜏":"w","ꮃ":"w","𑣯":"W","𑣦":"W","𝐖":"W","𝑊":"W","𝑾":"W","𝒲":"W","𝓦":"W","𝔚":"W","𝕎":"W","𝖂":"W","𝖶":"W","𝗪":"W","𝘞":"W","𝙒":"W","𝚆":"W","Ԝ":"W",Ꮃ:"W",Ꮤ:"W","ꓪ":"W",ѽ:"w҆҇","𑓅":"ẇ","₩":"W̵","ꝡ":"w̦","ᴍ":"ʍ",м:"ʍ","ꮇ":"ʍ","ӎ":"ʍ̦","᙮":"x","×":"x","⤫":"x","⤬":"x","⨯":"x",ｘ:"x","ⅹ":"x","𝐱":"x","𝑥":"x","𝒙":"x","𝓍":"x","𝔁":"x","𝔵":"x","𝕩":"x","𝖝":"x","𝗑":"x","𝘅":"x","𝘹":"x","𝙭":"x","𝚡":"x",х:"x",ᕁ:"x",ᕽ:"x","ⷯ":"ͯ","᙭":"X","╳":"X","𐌢":"X","𑣬":"X",Ｘ:"X","Ⅹ":"X","𝐗":"X","𝑋":"X","𝑿":"X","𝒳":"X","𝓧":"X","𝔛":"X","𝕏":"X","𝖃":"X","𝖷":"X","𝗫":"X","𝘟":"X","𝙓":"X","𝚇":"X","Ꭓ":"X",Χ:"X","𝚾":"X","𝛸":"X","𝜲":"X","𝝬":"X","𝞦":"X","Ⲭ":"X",Х:"X","ⵝ":"X",ᚷ:"X","ꓫ":"X","𐊐":"X","𐊴":"X","𐌗":"X","𐔧":"X","⨰":"ẋ",Ҳ:"X̩","𐆖":"X̵","ⅺ":"xi","ⅻ":"xii","Ⅺ":"Xl","Ⅻ":"Xll",ɣ:"y","ᶌ":"y",ｙ:"y","𝐲":"y","𝑦":"y","𝒚":"y","𝓎":"y","𝔂":"y","𝔶":"y","𝕪":"y","𝖞":"y","𝗒":"y","𝘆":"y","𝘺":"y","𝙮":"y","𝚢":"y",ʏ:"y","ỿ":"y","ꭚ":"y",γ:"y","ℽ":"y","𝛄":"y","𝛾":"y","𝜸":"y","𝝲":"y","𝞬":"y",у:"y",ү:"y",ყ:"y","𑣜":"y",Ｙ:"Y","𝐘":"Y","𝑌":"Y","𝒀":"Y","𝒴":"Y","𝓨":"Y","𝔜":"Y","𝕐":"Y","𝖄":"Y","𝖸":"Y","𝗬":"Y","𝘠":"Y","𝙔":"Y","𝚈":"Y",Υ:"Y",ϒ:"Y","𝚼":"Y","𝛶":"Y","𝜰":"Y","𝝪":"Y","𝞤":"Y","Ⲩ":"Y",У:"Y",Ү:"Y",Ꭹ:"Y",Ꮍ:"Y","ꓬ":"Y","𖽃":"Y","𑢤":"Y","𐊲":"Y",ƴ:"y̔","ɏ":"y̵",ұ:"y̵","¥":"Y̵","Ɏ":"Y̵",Ұ:"Y̵",ʒ:"ȝ","ꝫ":"ȝ","ⳍ":"ȝ",ӡ:"ȝ",ჳ:"ȝ","𝐳":"z","𝑧":"z","𝒛":"z","𝓏":"z","𝔃":"z","𝔷":"z","𝕫":"z","𝖟":"z","𝗓":"z","𝘇":"z","𝘻":"z","𝙯":"z","𝚣":"z","ᴢ":"z","ꮓ":"z","𑣄":"z","𐋵":"Z","𑣥":"Z",Ｚ:"Z",ℤ:"Z",ℨ:"Z","𝐙":"Z","𝑍":"Z","𝒁":"Z","𝒵":"Z","𝓩":"Z","𝖅":"Z","𝖹":"Z","𝗭":"Z","𝘡":"Z","𝙕":"Z","𝚉":"Z",Ζ:"Z","𝚭":"Z","𝛧":"Z","𝜡":"Z","𝝛":"Z","𝞕":"Z",Ꮓ:"Z","ꓜ":"Z","𑢩":"Z",ʐ:"z̨",ƶ:"z̵",Ƶ:"Z̵",ȥ:"z̦",Ȥ:"Z̦","ᵶ":"z̴",ƿ:"þ","ϸ":"þ","Ϸ":"Þ","𐓄":"Þ","⁹":"ꝰ","ᴤ":"ƨ",ϩ:"ƨ","ꙅ":"ƨ",ь:"ƅ","ꮟ":"ƅ",ы:"ƅi","ꭾ":"ɂ",ˤ:"ˁ","ꛍ":"ʡ","⊙":"ʘ","☉":"ʘ","⨀":"ʘ","Ꙩ":"ʘ","ⵙ":"ʘ","𐓃":"ʘ","ℾ":"Γ","𝚪":"Γ","𝛤":"Γ","𝜞":"Γ","𝝘":"Γ","𝞒":"Γ","Ⲅ":"Γ",Г:"Γ",Ꮁ:"Γ",ᒥ:"Γ","𖼇":"Γ",Ғ:"Γ̵",ᒯ:"Γ·",Ґ:"Γ'","∆":"Δ","△":"Δ","🜂":"Δ","𝚫":"Δ","𝛥":"Δ","𝜟":"Δ","𝝙":"Δ","𝞓":"Δ","Ⲇ":"Δ","ⵠ":"Δ",ᐃ:"Δ","𖼚":"Δ","𐊅":"Δ","𐊣":"Δ","⍙":"Δ̲",ᐏ:"Δ·",ᐬ:"Δᐠ","𝟋":"ϝ","𝛇":"ζ","𝜁":"ζ","𝜻":"ζ","𝝵":"ζ","𝞯":"ζ","ⳤ":"ϗ","𝛌":"λ","𝜆":"λ","𝝀":"λ","𝝺":"λ","𝞴":"λ","Ⲗ":"λ","𐓛":"λ",µ:"μ","𝛍":"μ","𝜇":"μ","𝝁":"μ","𝝻":"μ","𝞵":"μ","𝛏":"ξ","𝜉":"ξ","𝝃":"ξ","𝝽":"ξ","𝞷":"ξ","𝚵":"Ξ","𝛯":"Ξ","𝜩":"Ξ","𝝣":"Ξ","𝞝":"Ξ",ϖ:"π","ℼ":"π","𝛑":"π","𝛡":"π","𝜋":"π","𝜛":"π","𝝅":"π","𝝕":"π","𝝿":"π","𝞏":"π","𝞹":"π","𝟉":"π","ᴨ":"π",п:"π","∏":"Π","ℿ":"Π","𝚷":"Π","𝛱":"Π","𝜫":"Π","𝝥":"Π","𝞟":"Π","Ⲡ":"Π",П:"Π","ꛛ":"Π","𐊭":"Ϙ","𐌒":"Ϙ",ϛ:"ς","𝛓":"ς","𝜍":"ς","𝝇":"ς","𝞁":"ς","𝞻":"ς","𝚽":"Φ","𝛷":"Φ","𝜱":"Φ","𝝫":"Φ","𝞥":"Φ","Ⲫ":"Φ",Ф:"Φ",Փ:"Φ",ቀ:"Φ","ᛰ":"Φ","𐊳":"Φ","ꭓ":"χ","ꭕ":"χ","𝛘":"χ","𝜒":"χ","𝝌":"χ","𝞆":"χ","𝟀":"χ","ⲭ":"χ","𝛙":"ψ","𝜓":"ψ","𝝍":"ψ","𝞇":"ψ","𝟁":"ψ",ѱ:"ψ","𐓹":"ψ","𝚿":"Ψ","𝛹":"Ψ","𝜳":"Ψ","𝝭":"Ψ","𝞧":"Ψ","Ⲯ":"Ψ",Ѱ:"Ψ","𐓑":"Ψ",ᛘ:"Ψ","𐊵":"Ψ","⍵":"ω","ꞷ":"ω","𝛚":"ω","𝜔":"ω","𝝎":"ω","𝞈":"ω","𝟂":"ω","ⲱ":"ω","ꙍ":"ω",Ω:"Ω","𝛀":"Ω","𝛺":"Ω","𝜴":"Ω","𝝮":"Ω","𝞨":"Ω",ᘯ:"Ω",ᘵ:"Ω","𐊶":"Ω","⍹":"ω̲",ώ:"ῴ","☰":"Ⲷ","Ⳝ":"Ϭ",җ:"ж̩",Җ:"Ж̩","𝈋":"И","Ͷ":"И","ꚡ":"И","𐐥":"И",Й:"Ѝ","Ҋ":"Ѝ̦",ѝ:"й","ҋ":"й̦","𐒼":"Ӄ","ᴫ":"л","ӆ":"л̦","ꭠ":"љ","𐓫":"ꙩ","ᷮ":"ⷬ","𐓍":"Ћ","𝈂":"Ӿ","𝈢":"Ѡ",Ꮗ:"Ѡ",ᗯ:"Ѡ",Ѽ:"Ѡ҆҇","ᣭ":"Ѡ·","Ꞷ":"Ꙍ",ӌ:"ҷ",Ӌ:"Ҷ",Ҿ:"Ҽ̨","ⲽ":"ш","Ⲽ":"Ш","Ꙑ":"Ъl","℈":"Э","🜁":"Ꙙ","𖼜":"Ꙙ","ꦒ":"ⰿ",և:"եւ",ኔ:"ձ",ﬔ:"մե",ﬕ:"մի",ﬗ:"մխ",ﬓ:"մն","∩":"Ո","⋂":"Ո","𝉅":"Ո",በ:"Ո",ᑎ:"Ո","ꓵ":"Ո",ᑚ:"Ո·",ᑨ:"Ո'",ﬖ:"վն","₽":"Ք","˓":"ՙ",ʿ:"ՙ",ℵ:"א",ﬡ:"א",אָ:"אַ",אּ:"אַ",ﭏ:"אל",ℶ:"ב",ℷ:"ג",ℸ:"ד",ﬢ:"ד",ﬣ:"ה",יּ:"יִ",ﬤ:"כ",ﬥ:"ל",ﬦ:"ם",ﬠ:"ע",ﬧ:"ר",שׂ:"שׁ",שּ:"שׁ",שּׂ:"שּׁ",ﬨ:"ת",ﺀ:"ء","۽":"ء͈",ﺂ:"آ",ﺁ:"آ",ﭑ:"ٱ",ﭐ:"ٱ","𞸁":"ب","𞸡":"ب","𞹡":"ب","𞺁":"ب","𞺡":"ب",ﺑ:"ب",ﺒ:"ب",ﺐ:"ب",ﺏ:"ب","ݑ":"بۛ","ࢶ":"بۢ","ࢡ":"بٔ",ﲠ:"بo",ﳢ:"بo",ﲜ:"بج",ﰅ:"بج",ﲝ:"بح",ﰆ:"بح",ﷂ:"بحى",ﲞ:"بخ",ﰇ:"بخ",ﳒ:"بخ",ﱋ:"بخ",ﶞ:"بخى",ﱪ:"بر",ﱫ:"بز",ﲟ:"بم",ﳡ:"بم",ﱬ:"بم",ﰈ:"بم",ﱭ:"بن",ﱮ:"بى",ﰉ:"بى",ﱯ:"بى",ﰊ:"بى",ﭔ:"ٻ",ﭕ:"ٻ",ﭓ:"ٻ",ﭒ:"ٻ",ې:"ٻ",ﯦ:"ٻ",ﯧ:"ٻ",ﯥ:"ٻ",ﯤ:"ٻ",ﭜ:"ڀ",ﭝ:"ڀ",ﭛ:"ڀ",ﭚ:"ڀ","ࢩ":"ݔ","ݧ":"ݔ","⍥":"ة",ö:"ة",ﺔ:"ة",ﺓ:"ة",ۃ:"ة","𞸕":"ت","𞸵":"ت","𞹵":"ت","𞺕":"ت","𞺵":"ت",ﺗ:"ت",ﺘ:"ت",ﺖ:"ت",ﺕ:"ت",ﲥ:"تo",ﳤ:"تo",ﲡ:"تج",ﰋ:"تج",ﵐ:"تجم",ﶠ:"تجى",ﶟ:"تجى",ﲢ:"تح",ﰌ:"تح",ﵒ:"تحج",ﵑ:"تحج",ﵓ:"تحم",ﲣ:"تخ",ﰍ:"تخ",ﵔ:"تخم",ﶢ:"تخى",ﶡ:"تخى",ﱰ:"تر",ﱱ:"تز",ﲤ:"تم",ﳣ:"تم",ﱲ:"تم",ﰎ:"تم",ﵕ:"تمج",ﵖ:"تمح",ﵗ:"تمخ",ﶤ:"تمى",ﶣ:"تمى",ﱳ:"تن",ﱴ:"تى",ﰏ:"تى",ﱵ:"تى",ﰐ:"تى",ﭠ:"ٺ",ﭡ:"ٺ",ﭟ:"ٺ",ﭞ:"ٺ",ﭤ:"ٿ",ﭥ:"ٿ",ﭣ:"ٿ",ﭢ:"ٿ","𞸂":"ج","𞸢":"ج","𞹂":"ج","𞹢":"ج","𞺂":"ج","𞺢":"ج",ﺟ:"ج",ﺠ:"ج",ﺞ:"ج",ﺝ:"ج",ﲧ:"جح",ﰕ:"جح",ﶦ:"جحى",ﶾ:"جحى",ﷻ:"جل جلlلo",ﲨ:"جم",ﰖ:"جم",ﵙ:"جمح",ﵘ:"جمح",ﶧ:"جمى",ﶥ:"جمى",ﴝ:"جى",ﴁ:"جى",ﴞ:"جى",ﴂ:"جى",ﭸ:"ڃ",ﭹ:"ڃ",ﭷ:"ڃ",ﭶ:"ڃ",ﭴ:"ڄ",ﭵ:"ڄ",ﭳ:"ڄ",ﭲ:"ڄ",ﭼ:"چ",ﭽ:"چ",ﭻ:"چ",ﭺ:"چ",ﮀ:"ڇ",ﮁ:"ڇ",ﭿ:"ڇ",ﭾ:"ڇ","𞸇":"ح","𞸧":"ح","𞹇":"ح","𞹧":"ح","𞺇":"ح","𞺧":"ح",ﺣ:"ح",ﺤ:"ح",ﺢ:"ح",ﺡ:"ح",څ:"حۛ",ځ:"حٔ","ݲ":"حٔ",ﲩ:"حج",ﰗ:"حج",ﶿ:"حجى",ﲪ:"حم",ﰘ:"حم",ﵛ:"حمى",ﵚ:"حمى",ﴛ:"حى",ﳿ:"حى",ﴜ:"حى",ﴀ:"حى","𞸗":"خ","𞸷":"خ","𞹗":"خ","𞹷":"خ","𞺗":"خ","𞺷":"خ",ﺧ:"خ",ﺨ:"خ",ﺦ:"خ",ﺥ:"خ",ﲫ:"خج",ﰙ:"خج",ﰚ:"خح",ﲬ:"خم",ﰛ:"خم",ﴟ:"خى",ﴃ:"خى",ﴠ:"خى",ﴄ:"خى","𐋡":"د","𞸃":"د","𞺃":"د","𞺣":"د",ﺪ:"د",ﺩ:"د",ڈ:"دؕ",ﮉ:"دؕ",ﮈ:"دؕ",ڎ:"دۛ",ﮇ:"دۛ",ﮆ:"دۛ","ۮ":"د̂","ࢮ":"د̤̣","𞸘":"ذ","𞺘":"ذ","𞺸":"ذ",ﺬ:"ذ",ﺫ:"ذ",ﱛ:"ذٰ",ڋ:"ڊؕ",ﮅ:"ڌ",ﮄ:"ڌ",ﮃ:"ڍ",ﮂ:"ڍ","𞸓":"ر","𞺓":"ر","𞺳":"ر",ﺮ:"ر",ﺭ:"ر",ڑ:"رؕ",ﮍ:"رؕ",ﮌ:"رؕ",ژ:"رۛ",ﮋ:"رۛ",ﮊ:"رۛ",ڒ:"ر̆","ࢹ":"ر̆̇","ۯ":"ر̂","ݬ":"رٔ",ﱜ:"رٰ",ﷶ:"رسول","﷼":"رىlل","𞸆":"ز","𞺆":"ز","𞺦":"ز",ﺰ:"ز",ﺯ:"ز","ࢲ":"ز̂","ݱ":"ڗؕ","𞸎":"س","𞸮":"س","𞹎":"س","𞹮":"س","𞺎":"س","𞺮":"س",ﺳ:"س",ﺴ:"س",ﺲ:"س",ﺱ:"س",ش:"سۛ","𞸔":"سۛ","𞸴":"سۛ","𞹔":"سۛ","𞹴":"سۛ","𞺔":"سۛ","𞺴":"سۛ",ﺷ:"سۛ",ﺸ:"سۛ",ﺶ:"سۛ",ﺵ:"سۛ","ݾ":"س̂",ﴱ:"سo",ﳨ:"سo",ﴲ:"سۛo",ﳪ:"سۛo",ﲭ:"سج",ﴴ:"سج",ﰜ:"سج",ﴭ:"سۛج",ﴷ:"سۛج",ﴥ:"سۛج",ﴉ:"سۛج",ﵝ:"سجح",ﵞ:"سجى",ﵩ:"سۛجى",ﲮ:"سح",ﴵ:"سح",ﰝ:"سح",ﴮ:"سۛح",ﴸ:"سۛح",ﴦ:"سۛح",ﴊ:"سۛح",ﵜ:"سحج",ﵨ:"سۛحم",ﵧ:"سۛحم",ﶪ:"سۛحى",ﲯ:"سخ",ﴶ:"سخ",ﰞ:"سخ",ﴯ:"سۛخ",ﴹ:"سۛخ",ﴧ:"سۛخ",ﴋ:"سۛخ",ﶨ:"سخى",ﷆ:"سخى",ﴪ:"سر",ﴎ:"سر",ﴩ:"سۛر",ﴍ:"سۛر",ﲰ:"سم",ﳧ:"سم",ﰟ:"سم",ﴰ:"سۛم",ﳩ:"سۛم",ﴨ:"سۛم",ﴌ:"سۛم",ﵡ:"سمج",ﵠ:"سمح",ﵟ:"سمح",ﵫ:"سۛمخ",ﵪ:"سۛمخ",ﵣ:"سمم",ﵢ:"سمم",ﵭ:"سۛمم",ﵬ:"سۛمم",ﴗ:"سى",ﳻ:"سى",ﴘ:"سى",ﳼ:"سى",ﴙ:"سۛى",ﳽ:"سۛى",ﴚ:"سۛى",ﳾ:"سۛى","𐋲":"ص","𞸑":"ص","𞸱":"ص","𞹑":"ص","𞹱":"ص","𞺑":"ص","𞺱":"ص",ﺻ:"ص",ﺼ:"ص",ﺺ:"ص",ﺹ:"ص",ڞ:"صۛ","ࢯ":"ص̤̣",ﲱ:"صح",ﰠ:"صح",ﵥ:"صحح",ﵤ:"صحح",ﶩ:"صحى",ﲲ:"صخ",ﴫ:"صر",ﴏ:"صر",ﷵ:"صلعم",ﷹ:"صلى",ﷰ:"صلى",ﷺ:"صلى lللo علىo وسلم",ﲳ:"صم",ﰡ:"صم",ﷅ:"صمم",ﵦ:"صمم",ﴡ:"صى",ﴅ:"صى",ﴢ:"صى",ﴆ:"صى","𞸙":"ض","𞸹":"ض","𞹙":"ض","𞹹":"ض","𞺙":"ض","𞺹":"ض",ﺿ:"ض",ﻀ:"ض",ﺾ:"ض",ﺽ:"ض",ﲴ:"ضج",ﰢ:"ضج",ﲵ:"ضح",ﰣ:"ضح",ﵮ:"ضحى",ﶫ:"ضحى",ﲶ:"ضخ",ﰤ:"ضخ",ﵰ:"ضخم",ﵯ:"ضخم",ﴬ:"ضر",ﴐ:"ضر",ﲷ:"ضم",ﰥ:"ضم",ﴣ:"ضى",ﴇ:"ضى",ﴤ:"ضى",ﴈ:"ضى","𐋨":"ط","𞸈":"ط","𞹨":"ط","𞺈":"ط","𞺨":"ط",ﻃ:"ط",ﻄ:"ط",ﻂ:"ط",ﻁ:"ط",ڟ:"طۛ",ﲸ:"طح",ﰦ:"طح",ﴳ:"طم",ﴺ:"طم",ﰧ:"طم",ﵲ:"طمح",ﵱ:"طمح",ﵳ:"طمم",ﵴ:"طمى",ﴑ:"طى",ﳵ:"طى",ﴒ:"طى",ﳶ:"طى","𞸚":"ظ","𞹺":"ظ","𞺚":"ظ","𞺺":"ظ",ﻇ:"ظ",ﻈ:"ظ",ﻆ:"ظ",ﻅ:"ظ",ﲹ:"ظم",ﴻ:"ظم",ﰨ:"ظم","؏":"ع","𞸏":"ع","𞸯":"ع","𞹏":"ع","𞹯":"ع","𞺏":"ع","𞺯":"ع",ﻋ:"ع",ﻌ:"ع",ﻊ:"ع",ﻉ:"ع",ﲺ:"عج",ﰩ:"عج",ﷄ:"عجم",ﵵ:"عجم",ﷷ:"علىo",ﲻ:"عم",ﰪ:"عم",ﵷ:"عمم",ﵶ:"عمم",ﵸ:"عمى",ﶶ:"عمى",ﴓ:"عى",ﳷ:"عى",ﴔ:"عى",ﳸ:"عى","𞸛":"غ","𞸻":"غ","𞹛":"غ","𞹻":"غ","𞺛":"غ","𞺻":"غ",ﻏ:"غ",ﻐ:"غ",ﻎ:"غ",ﻍ:"غ",ﲼ:"غج",ﰫ:"غج",ﲽ:"غم",ﰬ:"غم",ﵹ:"غمم",ﵻ:"غمى",ﵺ:"غمى",ﴕ:"غى",ﳹ:"غى",ﴖ:"غى",ﳺ:"غى","𞸐":"ف","𞸰":"ف","𞹰":"ف","𞺐":"ف","𞺰":"ف",ﻓ:"ف",ﻔ:"ف",ﻒ:"ف",ﻑ:"ف",ڧ:"ف",ﲾ:"فج",ﰭ:"فج",ﲿ:"فح",ﰮ:"فح",ﳀ:"فخ",ﰯ:"فخ",ﵽ:"فخم",ﵼ:"فخم",ﳁ:"فم",ﰰ:"فم",ﷁ:"فمى",ﱼ:"فى",ﰱ:"فى",ﱽ:"فى",ﰲ:"فى","𞸞":"ڡ","𞹾":"ڡ","ࢻ":"ڡ","ٯ":"ڡ","𞸟":"ڡ","𞹟":"ڡ","ࢼ":"ڡ",ڤ:"ڡۛ",ﭬ:"ڡۛ",ﭭ:"ڡۛ",ﭫ:"ڡۛ",ﭪ:"ڡۛ",ڨ:"ڡۛ","ࢤ":"ڢۛ",ﭰ:"ڦ",ﭱ:"ڦ",ﭯ:"ڦ",ﭮ:"ڦ","𞸒":"ق","𞸲":"ق","𞹒":"ق","𞹲":"ق","𞺒":"ق","𞺲":"ق",ﻗ:"ق",ﻘ:"ق",ﻖ:"ق",ﻕ:"ق",ﳂ:"قح",ﰳ:"قح",ﷱ:"قلى",ﳃ:"قم",ﰴ:"قم",ﶴ:"قمح",ﵾ:"قمح",ﵿ:"قمم",ﶲ:"قمى",ﱾ:"قى",ﰵ:"قى",ﱿ:"قى",ﰶ:"قى","𞸊":"ك","𞸪":"ك","𞹪":"ك",ﻛ:"ك",ﻜ:"ك",ﻚ:"ك",ﻙ:"ك",ک:"ك",ﮐ:"ك",ﮑ:"ك",ﮏ:"ك",ﮎ:"ك",ڪ:"ك",ڭ:"كۛ",ﯕ:"كۛ",ﯖ:"كۛ",ﯔ:"كۛ",ﯓ:"كۛ","ݣ":"كۛ",ﲀ:"كl",ﰷ:"كl",ﳄ:"كج",ﰸ:"كج",ﳅ:"كح",ﰹ:"كح",ﳆ:"كخ",ﰺ:"كخ",ﳇ:"كل",ﳫ:"كل",ﲁ:"كل",ﰻ:"كل",ﳈ:"كم",ﳬ:"كم",ﲂ:"كم",ﰼ:"كم",ﷃ:"كمم",ﶻ:"كمم",ﶷ:"كمى",ﲃ:"كى",ﰽ:"كى",ﲄ:"كى",ﰾ:"كى","ݢ":"ڬ",ﮔ:"گ",ﮕ:"گ",ﮓ:"گ",ﮒ:"گ","ࢰ":"گ",ڴ:"گۛ",ﮜ:"ڱ",ﮝ:"ڱ",ﮛ:"ڱ",ﮚ:"ڱ",ﮘ:"ڳ",ﮙ:"ڳ",ﮗ:"ڳ",ﮖ:"ڳ","𞸋":"ل","𞸫":"ل","𞹋":"ل","𞺋":"ل","𞺫":"ل",ﻟ:"ل",ﻠ:"ل",ﻞ:"ل",ﻝ:"ل",ڷ:"لۛ",ڵ:"ل̆",ﻼ:"لl",ﻻ:"لl",ﻺ:"لlٕ",ﻹ:"لlٕ",ﻸ:"لlٴ",ﻷ:"لlٴ",ﳍ:"لo",ﻶ:"لآ",ﻵ:"لآ",ﳉ:"لج",ﰿ:"لج",ﶃ:"لجج",ﶄ:"لجج",ﶺ:"لجم",ﶼ:"لجم",ﶬ:"لجى",ﳊ:"لح",ﱀ:"لح",ﶵ:"لحم",ﶀ:"لحم",ﶂ:"لحى",ﶁ:"لحى",ﳋ:"لخ",ﱁ:"لخ",ﶆ:"لخم",ﶅ:"لخم",ﳌ:"لم",ﳭ:"لم",ﲅ:"لم",ﱂ:"لم",ﶈ:"لمح",ﶇ:"لمح",ﶭ:"لمى",ﲆ:"لى",ﱃ:"لى",ﲇ:"لى",ﱄ:"لى","𞸌":"م","𞸬":"م","𞹬":"م","𞺌":"م","𞺬":"م",ﻣ:"م",ﻤ:"م",ﻢ:"م",ﻡ:"م","ࢧ":"مۛ","۾":"م͈",ﲈ:"مl",ﳎ:"مج",ﱅ:"مج",ﶌ:"مجح",ﶒ:"مجخ",ﶍ:"مجم",ﷀ:"مجى",ﳏ:"مح",ﱆ:"مح",ﶉ:"محج",ﶊ:"محم",ﷴ:"محمد",ﶋ:"محى",ﳐ:"مخ",ﱇ:"مخ",ﶎ:"مخج",ﶏ:"مخم",ﶹ:"مخى",ﳑ:"مم",ﲉ:"مم",ﱈ:"مم",ﶱ:"ممى",ﱉ:"مى",ﱊ:"مى","𞸍":"ن","𞸭":"ن","𞹍":"ن","𞹭":"ن","𞺍":"ن","𞺭":"ن",ﻧ:"ن",ﻨ:"ن",ﻦ:"ن",ﻥ:"ن","ݨ":"نؕ","ݩ":"ن̆",ﳖ:"نo",ﳯ:"نo",ﶸ:"نجح",ﶽ:"نجح",ﶘ:"نجم",ﶗ:"نجم",ﶙ:"نجى",ﷇ:"نجى",ﳓ:"نح",ﱌ:"نح",ﶕ:"نحم",ﶖ:"نحى",ﶳ:"نحى",ﳔ:"نخ",ﱍ:"نخ",ﲊ:"نر",ﲋ:"نز",ﳕ:"نم",ﳮ:"نم",ﲌ:"نم",ﱎ:"نم",ﶛ:"نمى",ﶚ:"نمى",ﲍ:"نن",ﲎ:"نى",ﱏ:"نى",ﲏ:"نى",ﱐ:"نى",ۂ:"ۀ",ﮥ:"ۀ",ﮤ:"ۀ","𐋤":"و","𞸅":"و","𞺅":"و","𞺥":"و",ﻮ:"و",ﻭ:"و","ࢱ":"و",ۋ:"وۛ",ﯟ:"وۛ",ﯞ:"وۛ",ۇ:"و̓",ﯘ:"و̓",ﯗ:"و̓",ۆ:"و̆",ﯚ:"و̆",ﯙ:"و̆",ۉ:"و̂",ﯣ:"و̂",ﯢ:"و̂",ۈ:"وٰ",ﯜ:"وٰ",ﯛ:"وٰ",ؤ:"وٴ",ﺆ:"وٴ",ﺅ:"وٴ",ٶ:"وٴ",ٷ:"و̓ٴ",ﯝ:"و̓ٴ",ﷸ:"وسلم",ﯡ:"ۅ",ﯠ:"ۅ","ٮ":"ى","𞸜":"ى","𞹼":"ى",ں:"ى","𞸝":"ى","𞹝":"ى",ﮟ:"ى",ﮞ:"ى","ࢽ":"ى",ﯨ:"ى",ﯩ:"ى",ﻰ:"ى",ﻯ:"ى",ي:"ى","𞸉":"ى","𞸩":"ى","𞹉":"ى","𞹩":"ى","𞺉":"ى","𞺩":"ى",ﻳ:"ى",ﻴ:"ى",ﻲ:"ى",ﻱ:"ى",ی:"ى",ﯾ:"ى",ﯿ:"ى",ﯽ:"ى",ﯼ:"ى",ے:"ى",ﮯ:"ى",ﮮ:"ى",ٹ:"ىؕ",ﭨ:"ىؕ",ﭩ:"ىؕ",ﭧ:"ىؕ",ﭦ:"ىؕ",ڻ:"ىؕ",ﮢ:"ىؕ",ﮣ:"ىؕ",ﮡ:"ىؕ",ﮠ:"ىؕ",پ:"ىۛ",ﭘ:"ىۛ",ﭙ:"ىۛ",ﭗ:"ىۛ",ﭖ:"ىۛ",ث:"ىۛ","𞸖":"ىۛ","𞸶":"ىۛ","𞹶":"ىۛ","𞺖":"ىۛ","𞺶":"ىۛ",ﺛ:"ىۛ",ﺜ:"ىۛ",ﺚ:"ىۛ",ﺙ:"ىۛ",ڽ:"ىۛ",ۑ:"ىۛ","ؿ":"ىۛ","ࢷ":"ىۛۢ","ݖ":"ى̆",ێ:"ى̆","ࢺ":"ى̆̇","ؽ":"ى̂","ࢨ":"ىٔ",ﲐ:"ىٰ",ﱝ:"ىٰ",ﳞ:"ىo",ﳱ:"ىo",ﳦ:"ىۛo",ئ:"ىٴ",ﺋ:"ىٴ",ﺌ:"ىٴ",ﺊ:"ىٴ",ﺉ:"ىٴ",ٸ:"ىٴ",ﯫ:"ىٴl",ﯪ:"ىٴl",ﲛ:"ىٴo",ﳠ:"ىٴo",ﯭ:"ىٴo",ﯬ:"ىٴo",ﯸ:"ىٴٻ",ﯷ:"ىٴٻ",ﯶ:"ىٴٻ",ﲗ:"ىٴج",ﰀ:"ىٴج",ﲘ:"ىٴح",ﰁ:"ىٴح",ﲙ:"ىٴخ",ﱤ:"ىٴر",ﱥ:"ىٴز",ﲚ:"ىٴم",ﳟ:"ىٴم",ﱦ:"ىٴم",ﰂ:"ىٴم",ﱧ:"ىٴن",ﯯ:"ىٴو",ﯮ:"ىٴو",ﯱ:"ىٴو̓",ﯰ:"ىٴو̓",ﯳ:"ىٴو̆",ﯲ:"ىٴو̆",ﯵ:"ىٴوٰ",ﯴ:"ىٴوٰ",ﯻ:"ىٴى",ﯺ:"ىٴى",ﱨ:"ىٴى",ﯹ:"ىٴى",ﰃ:"ىٴى",ﱩ:"ىٴى",ﰄ:"ىٴى",ﳚ:"ىج",ﱕ:"ىج",ﰑ:"ىۛج",ﶯ:"ىجى",ﳛ:"ىح",ﱖ:"ىح",ﶮ:"ىحى",ﳜ:"ىخ",ﱗ:"ىخ",ﲑ:"ىر",ﱶ:"ىۛر",ﲒ:"ىز",ﱷ:"ىۛز",ﳝ:"ىم",ﳰ:"ىم",ﲓ:"ىم",ﱘ:"ىم",ﲦ:"ىۛم",ﳥ:"ىۛم",ﱸ:"ىۛم",ﰒ:"ىۛم",ﶝ:"ىمم",ﶜ:"ىمم",ﶰ:"ىمى",ﲔ:"ىن",ﱹ:"ىۛن",ﲕ:"ىى",ﱙ:"ىى",ﲖ:"ىى",ﱚ:"ىى",ﱺ:"ىۛى",ﰓ:"ىۛى",ﱻ:"ىۛى",ﰔ:"ىۛى",ﮱ:"ۓ",ﮰ:"ۓ","𐊸":"ⵀ","⁞":"ⵂ","⸽":"ⵂ","⦙":"ⵂ","︙":"ⵗ","⁝":"ⵗ","⋮":"ⵗ",Մ:"ሆ",Ռ:"ቡ",Ի:"ኮ",Պ:"ጣ",आ:"अा",ऒ:"अाॆ",ओ:"अाे",औ:"अाै","ऄ":"अॆ",ऑ:"अॉ",ऍ:"एॅ",ऎ:"एॆ",ऐ:"एे",ई:"र्इ",ઽ:"ऽ","𑇜":"ꣻ","𑇋":"ऺ","ુ":"ु","ૂ":"ू","ੋ":"ॆ","੍":"्","્":"्",আ:"অা",ৠ:"ঋৃ",ৡ:"ঋৃ","𑒒":"ঘ","𑒔":"চ","𑒖":"জ","𑒘":"ঞ","𑒙":"ট","𑒛":"ড","𑒪":"ণ","𑒞":"ত","𑒟":"থ","𑒠":"দ","𑒡":"ধ","𑒢":"ন","𑒣":"প","𑒩":"ব","𑒧":"ম","𑒨":"য","𑒫":"র","𑒝":"ল","𑒭":"ষ","𑒮":"স","𑓄":"ঽ","𑒰":"া","𑒱":"ি","𑒹":"ে","𑒼":"ো","𑒾":"ৌ","𑓂":"্","𑒽":"ৗ",ਉ:"ੳੁ",ਊ:"ੳੂ",ਆ:"ਅਾ",ਐ:"ਅੈ",ਔ:"ਅੌ",ਇ:"ੲਿ",ਈ:"ੲੀ",ਏ:"ੲੇ",આ:"અા",ઑ:"અાૅ",ઓ:"અાે",ઔ:"અાૈ",ઍ:"અૅ",એ:"અે",ઐ:"અૈ",ଆ:"ଅା","௮":"அ",ர:"ஈ","ா":"ஈ","௫":"ஈு","௨":"உ",ഉ:"உ",ஊ:"உள",ഊ:"உൗ","௭":"எ","௷":"எவ",ஜ:"ஐ",ജ:"ஐ","௧":"க","௪":"ச","௬":"சு","௲":"சூ","ഺ":"டி",ണ:"ண","௺":"நீ","௴":"மீ","௰":"ய",ഴ:"ழ","ௗ":"ள","ை":"ன",ശ:"ஶ","௸":"ஷ","ി":"ி","ീ":"ி","ொ":"ெஈ","ௌ":"ெள","ோ":"ேஈ",ಅ:"అ",ಆ:"ఆ",ಇ:"ఇ",ౠ:"ఋా",ౡ:"ఌా",ಒ:"ఒ",ఔ:"ఒౌ",ಔ:"ఒౌ",ఓ:"ఒౕ",ಓ:"ఒౕ",ಜ:"జ",ಞ:"ఞ",ఢ:"డ̣",ಣ:"ణ",థ:"ధּ",భ:"బ̣",ಯ:"య",ఠ:"రּ",ಱ:"ఱ",ಲ:"ల",ష:"వ̣",హ:"వా",మ:"వు","ూ":"ుా","ౄ":"ృా",ೡ:"ಌಾ",ഈ:"ഇൗ",ഐ:"എെ",ഓ:"ഒാ",ഔ:"ഒൗ",ൡ:"ഞ","൫":"ദ്ര","൹":"നു",ഌ:"നു",ങ:"നു","൯":"ന്","ൻ":"ന്","൬":"ന്ന","൚":"ന്മ",റ:"ര","൪":"ര്","ർ":"ര്","൮":"വ്ര","൶":"ഹ്മ","ൂ":"ു","ൃ":"ു","ൈ":"െെ","෪":"ජ","෫":"ද","𑐓":"𑐴𑑂𑐒","𑐙":"𑐴𑑂𑐘","𑐤":"𑐴𑑂𑐣","𑐪":"𑐴𑑂𑐩","𑐭":"𑐴𑑂𑐬","𑐯":"𑐴𑑂𑐮","𑗘":"𑖂","𑗙":"𑖂","𑗚":"𑖃","𑗛":"𑖄","𑗜":"𑖲","𑗝":"𑖳",ฃ:"ข",ด:"ค",ต:"ค",ม:"ฆ",ຈ:"จ",ซ:"ช",ฏ:"ฎ",ท:"ฑ",ບ:"บ",ປ:"ป",ຝ:"ฝ",ພ:"พ",ຟ:"ฟ",ฦ:"ภ",ຍ:"ย","។":"ฯ",ๅ:"า",ำ:"̊า","ិ":"ิ","ី":"ี","ឹ":"ึ","ឺ":"ื","ຸ":"ุ","ູ":"ู",แ:"เเ",ໜ:"ຫນ",ໝ:"ຫມ",ຳ:"̊າ","༂":"འུྂཿ","༃":"འུྂ༔",ཪ:"ར",ༀ:"ཨོཾ","ཷ":"ྲཱྀ","ཹ":"ླཱྀ","𑲲":"𑲪","ႁ":"ဂှ",က:"ဂာ","ၰ":"ဃှ","ၦ":"ပှ",ဟ:"ပာ","ၯ":"ပာှ","ၾ":"ၽှ",ဩ:"သြ",ဪ:"သြော်","႞":"ႃ̊",ឣ:"អ","᧐":"ᦞ","᧑":"ᦱ","᪀":"ᩅ","᪐":"ᩅ","꩓":"ꨁ","꩖":"ꨣ","᭒":"ᬍ","᭓":"ᬑ","᭘":"ᬨ","ꦣ":"ꦝ",ᢖ:"ᡜ",ᡕ:"ᠵ",ῶ:"Ꮿ",ᐍ:"ᐁ·",ᐫ:"ᐁᐠ",ᐑ:"ᐄ·",ᐓ:"ᐅ·",ᐭ:"ᐅᐠ",ᐕ:"ᐆ·",ᐘ:"ᐊ·",ᐮ:"ᐊᐠ",ᐚ:"ᐋ·","ᣝ":"ᐞᣟ",ᓑ:"ᐡ",ᕀ:"ᐩ",ᐿ:"ᐲ·",ᑃ:"ᐴ·","⍩":"ᐵ",ᑇ:"ᐹ·",ᑜ:"ᑏ·","⸧":"ᑐ","⊃":"ᑐ",ᑞ:"ᑐ·",ᑩ:"ᑐ'","⟉":"ᑐ/","⫗":"ᑐᑕ",ᑠ:"ᑑ·","⸦":"ᑕ","⊂":"ᑕ",ᑢ:"ᑕ·",ᑪ:"ᑕ'",ᑤ:"ᑖ·",ᑵ:"ᑫ·",ᒅ:"ᑫ'",ᑹ:"ᑮ·",ᑽ:"ᑰ·",ᘃ:"ᒉ",ᒓ:"ᒉ·",ᒕ:"ᒋ·",ᒗ:"ᒌ·",ᒛ:"ᒎ·",ᘂ:"ᒐ",ᒝ:"ᒐ·",ᒟ:"ᒑ·",ᒭ:"ᒣ·",ᒱ:"ᒦ·",ᒳ:"ᒧ·",ᒵ:"ᒨ·",ᒹ:"ᒫ·",ᓊ:"ᓀ·","ᣇ":"ᓂ·","ᣉ":"ᓃ·","ᣋ":"ᓄ·","ᣍ":"ᓅ·",ᓌ:"ᓇ·",ᓎ:"ᓈ·",ᘄ:"ᓓ",ᓝ:"ᓓ·",ᓟ:"ᓕ·",ᓡ:"ᓖ·",ᓣ:"ᓗ·",ᓥ:"ᓘ·",ᘇ:"ᓚ",ᓧ:"ᓚ·",ᓩ:"ᓛ·",ᓷ:"ᓭ·",ᓹ:"ᓯ·",ᓻ:"ᓰ·",ᓽ:"ᓱ·",ᓿ:"ᓲ·",ᔁ:"ᓴ·",ᔃ:"ᓵ·",ᔌ:"ᔋ<",ᔎ:"ᔋb",ᔍ:"ᔋᑕ",ᔏ:"ᔋᒐ",ᔘ:"ᔐ·",ᔚ:"ᔑ·",ᔜ:"ᔒ·",ᔞ:"ᔓ·",ᔠ:"ᔔ·",ᔢ:"ᔕ·",ᔤ:"ᔖ·",ᔲ:"ᔨ·",ᔴ:"ᔩ·",ᔶ:"ᔪ·",ᔸ:"ᔫ·",ᔺ:"ᔭ·",ᔼ:"ᔮ·",ᘢ:"ᕃ","ᣠ":"ᕃ·",ᘣ:"ᕆ",ᘤ:"ᕊ",ᕏ:"ᕌ·",ᖃ:"ᕐb",ᖄ:"ᕐḃ",ᖁ:"ᕐd",ᕿ:"ᕐP",ᙯ:"ᕐᑫ",ᕾ:"ᕐᑬ",ᖀ:"ᕐᑮ",ᖂ:"ᕐᑰ",ᖅ:"ᕐᒃ",ᕜ:"ᕚ·","ᣣ":"ᕞ·","ᣤ":"ᕦ·",ᕩ:"ᕧ·","ᣥ":"ᕫ·","ᣨ":"ᖆ·",ᖑ:"ᖕJ",ᙰ:"ᖕᒉ",ᖎ:"ᖕᒊ",ᖏ:"ᖕᒋ",ᖐ:"ᖕᒌ",ᖒ:"ᖕᒎ",ᖓ:"ᖕᒐ",ᖔ:"ᖕᒑ",ᙳ:"ᖖJ",ᙱ:"ᖖᒋ",ᙲ:"ᖖᒌ",ᙴ:"ᖖᒎ",ᙵ:"ᖖᒐ",ᙶ:"ᖖᒑ","ᣪ":"ᖗ·","ᙷ":"ᖧ·","ᙸ":"ᖨ·","ᙹ":"ᖩ·","ᙺ":"ᖪ·","ᙻ":"ᖫ·","ᙼ":"ᖬ·","ᙽ":"ᖭ·","⪫":"ᗒ","⪪":"ᗕ","ꓷ":"ᗡ","ᣰ":"ᗴ·","ᣲ":"ᘛ·","ᶻ":"ᙆ","ꓭ":"ᙠ","ᶺ":"ᣔ","ᴾ":"ᣖ","ᣜ":"ᣟᐞ",ˡ:"ᣳ",ʳ:"ᣴ",ˢ:"ᣵ","ᣛ":"ᣵ","ꚰ":"ᚹ",ᛡ:"ᚼ","⍿":"ᚽ",ᛂ:"ᚽ","𝈿":"ᛋ","↑":"ᛏ","↿":"ᛐ","⥮":"ᛐ⇂","⥣":"ᛐᛚ","ⵣ":"ᛯ","↾":"ᛚ","⨡":"ᛚ","⋄":"ᛜ","◇":"ᛜ","◊":"ᛜ","♢":"ᛜ","🝔":"ᛜ","𑢷":"ᛜ","𐊔":"ᛜ","⍚":"ᛜ̲","⋈":"ᛞ","⨝":"ᛞ","𐓐":"ᛦ","↕":"ᛨ","𐳼":"𐲂","𐳺":"𐲥",ㄱ:"ᄀ",ᆨ:"ᄀ",ᄁ:"ᄀᄀ",ㄲ:"ᄀᄀ",ᆩ:"ᄀᄀ","ᇺ":"ᄀᄂ","ᅚ":"ᄀᄃ",ᇃ:"ᄀᄅ","ᇻ":"ᄀᄇ",ᆪ:"ᄀᄉ",ㄳ:"ᄀᄉ",ᇄ:"ᄀᄉᄀ","ᇼ":"ᄀᄎ","ᇽ":"ᄀᄏ","ᇾ":"ᄀᄒ",ㄴ:"ᄂ",ᆫ:"ᄂ",ᄓ:"ᄂᄀ",ᇅ:"ᄂᄀ",ᄔ:"ᄂᄂ",ㅥ:"ᄂᄂ","ᇿ":"ᄂᄂ",ᄕ:"ᄂᄃ",ㅦ:"ᄂᄃ",ᇆ:"ᄂᄃ","ퟋ":"ᄂᄅ",ᄖ:"ᄂᄇ","ᅛ":"ᄂᄉ",ᇇ:"ᄂᄉ",ㅧ:"ᄂᄉ","ᅜ":"ᄂᄌ",ᆬ:"ᄂᄌ",ㄵ:"ᄂᄌ","ퟌ":"ᄂᄎ",ᇉ:"ᄂᄐ","ᅝ":"ᄂᄒ",ᆭ:"ᄂᄒ",ㄶ:"ᄂᄒ",ᇈ:"ᄂᅀ",ㅨ:"ᄂᅀ",ㄷ:"ᄃ",ᆮ:"ᄃ",ᄗ:"ᄃᄀ",ᇊ:"ᄃᄀ",ᄄ:"ᄃᄃ",ㄸ:"ᄃᄃ","ퟍ":"ᄃᄃ","ퟎ":"ᄃᄃᄇ","ᅞ":"ᄃᄅ",ᇋ:"ᄃᄅ","ꥠ":"ᄃᄆ","ꥡ":"ᄃᄇ","ퟏ":"ᄃᄇ","ꥢ":"ᄃᄉ","ퟐ":"ᄃᄉ","ퟑ":"ᄃᄉᄀ","ꥣ":"ᄃᄌ","ퟒ":"ᄃᄌ","ퟓ":"ᄃᄎ","ퟔ":"ᄃᄐ",ㄹ:"ᄅ",ᆯ:"ᄅ","ꥤ":"ᄅᄀ",ᆰ:"ᄅᄀ",ㄺ:"ᄅᄀ","ꥥ":"ᄅᄀᄀ","ퟕ":"ᄅᄀᄀ",ᇌ:"ᄅᄀᄉ",ㅩ:"ᄅᄀᄉ","ퟖ":"ᄅᄀᄒ",ᄘ:"ᄅᄂ",ᇍ:"ᄅᄂ","ꥦ":"ᄅᄃ",ᇎ:"ᄅᄃ",ㅪ:"ᄅᄃ","ꥧ":"ᄅᄃᄃ",ᇏ:"ᄅᄃᄒ",ᄙ:"ᄅᄅ",ᇐ:"ᄅᄅ","ퟗ":"ᄅᄅᄏ","ꥨ":"ᄅᄆ",ᆱ:"ᄅᄆ",ㄻ:"ᄅᄆ",ᇑ:"ᄅᄆᄀ",ᇒ:"ᄅᄆᄉ","ퟘ":"ᄅᄆᄒ","ꥩ":"ᄅᄇ",ᆲ:"ᄅᄇ",ㄼ:"ᄅᄇ","ퟙ":"ᄅᄇᄃ","ꥪ":"ᄅᄇᄇ",ᇓ:"ᄅᄇᄉ",ㅫ:"ᄅᄇᄉ","ꥫ":"ᄅᄇᄋ",ᇕ:"ᄅᄇᄋ","ퟚ":"ᄅᄇᄑ",ᇔ:"ᄅᄇᄒ","ꥬ":"ᄅᄉ",ᆳ:"ᄅᄉ",ㄽ:"ᄅᄉ",ᇖ:"ᄅᄉᄉ",ᄛ:"ᄅᄋ","ퟝ":"ᄅᄋ","ꥭ":"ᄅᄌ","ꥮ":"ᄅᄏ",ᇘ:"ᄅᄏ",ᆴ:"ᄅᄐ",ㄾ:"ᄅᄐ",ᆵ:"ᄅᄑ",ㄿ:"ᄅᄑ",ᄚ:"ᄅᄒ",ㅀ:"ᄅᄒ",ᄻ:"ᄅᄒ",ᆶ:"ᄅᄒ","ퟲ":"ᄅᄒ",ᇗ:"ᄅᅀ",ㅬ:"ᄅᅀ","ퟛ":"ᄅᅌ",ᇙ:"ᄅᅙ",ㅭ:"ᄅᅙ","ퟜ":"ᄅᅙᄒ",ㅁ:"ᄆ",ᆷ:"ᄆ","ꥯ":"ᄆᄀ",ᇚ:"ᄆᄀ","ퟞ":"ᄆᄂ","ퟟ":"ᄆᄂᄂ","ꥰ":"ᄆᄃ",ᇛ:"ᄆᄅ","ퟠ":"ᄆᄆ",ᄜ:"ᄆᄇ",ㅮ:"ᄆᄇ",ᇜ:"ᄆᄇ","ퟡ":"ᄆᄇᄉ","ꥱ":"ᄆᄉ",ᇝ:"ᄆᄉ",ㅯ:"ᄆᄉ",ᇞ:"ᄆᄉᄉ",ᄝ:"ᄆᄋ",ㅱ:"ᄆᄋ",ᇢ:"ᄆᄋ","ퟢ":"ᄆᄌ",ᇠ:"ᄆᄎ",ᇡ:"ᄆᄒ",ᇟ:"ᄆᅀ",ㅰ:"ᄆᅀ",ㅂ:"ᄇ",ᆸ:"ᄇ",ᄞ:"ᄇᄀ",ㅲ:"ᄇᄀ",ᄟ:"ᄇᄂ",ᄠ:"ᄇᄃ",ㅳ:"ᄇᄃ","ퟣ":"ᄇᄃ",ᇣ:"ᄇᄅ","ퟤ":"ᄇᄅᄑ","ퟥ":"ᄇᄆ",ᄈ:"ᄇᄇ",ㅃ:"ᄇᄇ","ퟦ":"ᄇᄇ",ᄬ:"ᄇᄇᄋ",ㅹ:"ᄇᄇᄋ",ᄡ:"ᄇᄉ",ㅄ:"ᄇᄉ",ᆹ:"ᄇᄉ",ᄢ:"ᄇᄉᄀ",ㅴ:"ᄇᄉᄀ",ᄣ:"ᄇᄉᄃ",ㅵ:"ᄇᄉᄃ","ퟧ":"ᄇᄉᄃ",ᄤ:"ᄇᄉᄇ",ᄥ:"ᄇᄉᄉ",ᄦ:"ᄇᄉᄌ","ꥲ":"ᄇᄉᄐ",ᄫ:"ᄇᄋ",ㅸ:"ᄇᄋ",ᇦ:"ᄇᄋ",ᄧ:"ᄇᄌ",ㅶ:"ᄇᄌ","ퟨ":"ᄇᄌ",ᄨ:"ᄇᄎ","ퟩ":"ᄇᄎ","ꥳ":"ᄇᄏ",ᄩ:"ᄇᄐ",ㅷ:"ᄇᄐ",ᄪ:"ᄇᄑ",ᇤ:"ᄇᄑ","ꥴ":"ᄇᄒ",ᇥ:"ᄇᄒ",ㅅ:"ᄉ",ᆺ:"ᄉ",ᄭ:"ᄉᄀ",ㅺ:"ᄉᄀ",ᇧ:"ᄉᄀ",ᄮ:"ᄉᄂ",ㅻ:"ᄉᄂ",ᄯ:"ᄉᄃ",ㅼ:"ᄉᄃ",ᇨ:"ᄉᄃ",ᄰ:"ᄉᄅ",ᇩ:"ᄉᄅ",ᄱ:"ᄉᄆ","ퟪ":"ᄉᄆ",ᄲ:"ᄉᄇ",ㅽ:"ᄉᄇ",ᇪ:"ᄉᄇ",ᄳ:"ᄉᄇᄀ","ퟫ":"ᄉᄇᄋ",ᄊ:"ᄉᄉ",ㅆ:"ᄉᄉ",ᆻ:"ᄉᄉ","ퟬ":"ᄉᄉᄀ","ퟭ":"ᄉᄉᄃ","ꥵ":"ᄉᄉᄇ",ᄴ:"ᄉᄉᄉ",ᄵ:"ᄉᄋ",ᄶ:"ᄉᄌ",ㅾ:"ᄉᄌ","ퟯ":"ᄉᄌ",ᄷ:"ᄉᄎ","ퟰ":"ᄉᄎ",ᄸ:"ᄉᄏ",ᄹ:"ᄉᄐ","ퟱ":"ᄉᄐ",ᄺ:"ᄉᄑ","ퟮ":"ᄉᅀ",ㅇ:"ᄋ",ᆼ:"ᄋ",ᅁ:"ᄋᄀ",ᇬ:"ᄋᄀ",ᇭ:"ᄋᄀᄀ",ᅂ:"ᄋᄃ","ꥶ":"ᄋᄅ",ᅃ:"ᄋᄆ",ᅄ:"ᄋᄇ",ᅅ:"ᄋᄉ",ᇱ:"ᄋᄉ",ㆂ:"ᄋᄉ",ᅇ:"ᄋᄋ",ㆀ:"ᄋᄋ",ᇮ:"ᄋᄋ",ᅈ:"ᄋᄌ",ᅉ:"ᄋᄎ",ᇯ:"ᄋᄏ",ᅊ:"ᄋᄐ",ᅋ:"ᄋᄑ","ꥷ":"ᄋᄒ",ᅆ:"ᄋᅀ",ᇲ:"ᄋᅀ",ㆃ:"ᄋᅀ",ㅈ:"ᄌ",ᆽ:"ᄌ","ퟷ":"ᄌᄇ","ퟸ":"ᄌᄇᄇ",ᅍ:"ᄌᄋ",ᄍ:"ᄌᄌ",ㅉ:"ᄌᄌ","ퟹ":"ᄌᄌ","ꥸ":"ᄌᄌᄒ",ㅊ:"ᄎ",ᆾ:"ᄎ",ᅒ:"ᄎᄏ",ᅓ:"ᄎᄒ",ㅋ:"ᄏ",ᆿ:"ᄏ",ㅌ:"ᄐ",ᇀ:"ᄐ","ꥹ":"ᄐᄐ",ㅍ:"ᄑ",ᇁ:"ᄑ",ᅖ:"ᄑᄇ",ᇳ:"ᄑᄇ","ퟺ":"ᄑᄉ",ᅗ:"ᄑᄋ",ㆄ:"ᄑᄋ",ᇴ:"ᄑᄋ","ퟻ":"ᄑᄐ","ꥺ":"ᄑᄒ",ㅎ:"ᄒ",ᇂ:"ᄒ",ᇵ:"ᄒᄂ",ᇶ:"ᄒᄅ",ᇷ:"ᄒᄆ",ᇸ:"ᄒᄇ","ꥻ":"ᄒᄉ",ᅘ:"ᄒᄒ",ㆅ:"ᄒᄒ",ᄽ:"ᄼᄼ",ᄿ:"ᄾᄾ",ㅿ:"ᅀ",ᇫ:"ᅀ","ퟳ":"ᅀᄇ","ퟴ":"ᅀᄇᄋ",ㆁ:"ᅌ",ᇰ:"ᅌ","ퟵ":"ᅌᄆ","ퟶ":"ᅌᄒ",ᅏ:"ᅎᅎ",ᅑ:"ᅐᅐ",ㆆ:"ᅙ",ᇹ:"ᅙ","ꥼ":"ᅙᅙ",ㅤ:"ᅠ",ㅏ:"ᅡ","ᆣ":"ᅡー",ᅶ:"ᅡᅩ",ᅷ:"ᅡᅮ",ᅢ:"ᅡ丨",ㅐ:"ᅡ丨",ㅑ:"ᅣ",ᅸ:"ᅣᅩ",ᅹ:"ᅣᅭ","ᆤ":"ᅣᅮ",ᅤ:"ᅣ丨",ㅒ:"ᅣ丨",ㅓ:"ᅥ",ᅼ:"ᅥー",ᅺ:"ᅥᅩ",ᅻ:"ᅥᅮ",ᅦ:"ᅥ丨",ㅔ:"ᅥ丨",ㅕ:"ᅧ","ᆥ":"ᅧᅣ",ᅽ:"ᅧᅩ",ᅾ:"ᅧᅮ",ᅨ:"ᅧ丨",ㅖ:"ᅧ丨",ㅗ:"ᅩ",ᅪ:"ᅩᅡ",ㅘ:"ᅩᅡ",ᅫ:"ᅩᅡ丨",ㅙ:"ᅩᅡ丨","ᆦ":"ᅩᅣ","ᆧ":"ᅩᅣ丨",ᅿ:"ᅩᅥ",ᆀ:"ᅩᅥ丨","ힰ":"ᅩᅧ",ᆁ:"ᅩᅧ丨",ᆂ:"ᅩᅩ","ힱ":"ᅩᅩ丨",ᆃ:"ᅩᅮ",ᅬ:"ᅩ丨",ㅚ:"ᅩ丨",ㅛ:"ᅭ","ힲ":"ᅭᅡ","ힳ":"ᅭᅡ丨",ᆄ:"ᅭᅣ",ㆇ:"ᅭᅣ",ᆆ:"ᅭᅣ",ᆅ:"ᅭᅣ丨",ㆈ:"ᅭᅣ丨","ힴ":"ᅭᅥ",ᆇ:"ᅭᅩ",ᆈ:"ᅭ丨",ㆉ:"ᅭ丨",ㅜ:"ᅮ",ᆉ:"ᅮᅡ",ᆊ:"ᅮᅡ丨",ᅯ:"ᅮᅥ",ㅝ:"ᅮᅥ",ᆋ:"ᅮᅥー",ᅰ:"ᅮᅥ丨",ㅞ:"ᅮᅥ丨","ힵ":"ᅮᅧ",ᆌ:"ᅮᅧ丨",ᆍ:"ᅮᅮ",ᅱ:"ᅮ丨",ㅟ:"ᅮ丨","ힶ":"ᅮ丨丨",ㅠ:"ᅲ",ᆎ:"ᅲᅡ","ힷ":"ᅲᅡ丨",ᆏ:"ᅲᅥ",ᆐ:"ᅲᅥ丨",ᆑ:"ᅲᅧ",ㆊ:"ᅲᅧ",ᆒ:"ᅲᅧ丨",ㆋ:"ᅲᅧ丨","ힸ":"ᅲᅩ",ᆓ:"ᅲᅮ",ᆔ:"ᅲ丨",ㆌ:"ᅲ丨",ㆍ:"ᆞ","ퟅ":"ᆞᅡ",ᆟ:"ᆞᅥ","ퟆ":"ᆞᅥ丨",ᆠ:"ᆞᅮ",ᆢ:"ᆞᆞ",ᆡ:"ᆞ丨",ㆎ:"ᆞ丨",ヘ:"へ","⍁":"〼","⧄":"〼","꒞":"ꁊ","꒬":"ꁐ","꒜":"ꃀ","꒨":"ꄲ","꒿":"ꉙ","꒾":"ꊱ","꒔":"ꋍ","꓀":"ꎫ","꓂":"ꎵ","꒺":"ꎿ","꒰":"ꏂ","꒧":"ꑘ","⊥":"ꓕ","⟂":"ꓕ","𝈜":"ꓕ","Ʇ":"ꓕ","Ꞟ":"ꓤ","⅁":"ꓨ","⅂":"ꓶ","𝈕":"ꓶ","𝈫":"ꓶ","𖼦":"ꓶ","𐐑":"ꓶ","⅃":"𖼀","𑫦":"𑫥𑫯","𑫨":"𑫥𑫥","𑫩":"𑫥𑫥𑫯","𑫪":"𑫥𑫥𑫰","𑫧":"𑫥𑫰","𑫴":"𑫳𑫯","𑫶":"𑫳𑫳","𑫷":"𑫳𑫳𑫯","𑫸":"𑫳𑫳𑫰","𑫵":"𑫳𑫰","𑫬":"𑫫𑫯","𑫭":"𑫫𑫫","𑫮":"𑫫𑫫𑫯","⊕":"𐊨","⨁":"𐊨","🜨":"𐊨","Ꚛ":"𐊨","▽":"𐊼","𝈔":"𐊼","🜄":"𐊼","⧖":"𐋀","ꞛ":"𐐺","Ꞛ":"𐐒","𐒠":"𐒆","𐏑":"𐎂","𐏓":"𐎓","𒀸":"𐎚","☥":"𐦞","𓋹":"𐦞","〹":"卄",不:"不","丽":"丽","並":"並","⎜":"丨","⎟":"丨","⎢":"丨","⎥":"丨","⎪":"丨","⎮":"丨","㇑":"丨",ᅵ:"丨",ㅣ:"丨","⼁":"丨",ᆜ:"丨ー",ᆘ:"丨ᅡ",ᆙ:"丨ᅣ","ힽ":"丨ᅣᅩ","ힾ":"丨ᅣ丨","ힿ":"丨ᅧ","ퟀ":"丨ᅧ丨",ᆚ:"丨ᅩ","ퟁ":"丨ᅩ丨","ퟂ":"丨ᅭ",ᆛ:"丨ᅮ","ퟃ":"丨ᅲ",ᆝ:"丨ᆞ","ퟄ":"丨丨",串:"串","丸":"丸",丹:"丹","乁":"乁","㇠":"乙","⼄":"乙","㇟":"乚","⺃":"乚","㇖":"乛","⺂":"乛","⻲":"亀",亂:"亂","㇚":"亅","⼅":"亅",了:"了",ニ:"二","⼆":"二","𠄢":"𠄢","⼇":"亠",亮:"亮","⼈":"人",イ:"亻","⺅":"亻",什:"什","仌":"仌",令:"令","你":"你",倂:"併","倂":"併","侀":"侀",來:"來",例:"例","侮":"侮","侮":"侮","侻":"侻",便:"便",值:"値",倫:"倫","偺":"偺","備":"備","像":"像",僚:"僚","僧":"僧","僧":"僧","㒞":"㒞","⼉":"儿",兀:"兀","⺎":"兀","充":"充","免":"免","免":"免","兔":"兔","兤":"兤","⼊":"入","內":"內","全":"全",兩:"兩",ハ:"八","⼋":"八",六:"六","具":"具","𠔜":"𠔜","𠔥":"𠔥","冀":"冀","㒹":"㒹","⼌":"冂","再":"再","𠕋":"𠕋","冒":"冒","冕":"冕","㒻":"㒻","最":"最","⼍":"冖","冗":"冗","冤":"冤","⼎":"冫","冬":"冬","况":"况","况":"况",冷:"冷",凉:"凉",凌:"凌",凜:"凜",凞:"凞","⼏":"几","𠘺":"𠘺","凵":"凵","⼐":"凵","⼑":"刀","⺉":"刂","刃":"刃",切:"切","切":"切",列:"列",利:"利","㓟":"㓟",刺:"刺","刻":"刻","剆":"剆","割":"割","剷":"剷",劉:"劉","𠠄":"𠠄",カ:"力",力:"力","⼒":"力",劣:"劣","㔕":"㔕","劳":"劳","勇":"勇","勇":"勇","勉":"勉","勉":"勉",勒:"勒",勞:"勞","勤":"勤","勤":"勤",勵:"勵","⼓":"勹","勺":"勺","勺":"勺","包":"包","匆":"匆","𠣞":"𠣞","⼔":"匕",北:"北","北":"北","⼕":"匚","⼖":"匸",匿:"匿","⼗":"十","〸":"十","〺":"卅","卉":"卉","࿖":"卍","࿕":"卐","卑":"卑","卑":"卑","博":"博",ト:"卜","⼘":"卜","⼙":"卩","⺋":"㔾","即":"即",卵:"卵","卽":"卽","卿":"卿","卿":"卿","卿":"卿","⼚":"厂","𠨬":"𠨬","⼛":"厶",參:"參","⼜":"又","及":"及","叟":"叟","𠭣":"𠭣",ロ:"口","⼝":"口",囗:"口","⼞":"口",句:"句","叫":"叫","叱":"叱","吆":"吆",吏:"吏",吝:"吝","吸":"吸",呂:"呂","呈":"呈","周":"周","咞":"咞","咢":"咢",咽:"咽",䎛:"㖈","哶":"哶","唐":"唐","啓":"啓",啟:"啓","啕":"啕","啣":"啣","善":"善","善":"善",喇:"喇","喙":"喙","喙":"喙","喝":"喝","喝":"喝","喫":"喫","喳":"喳",嗀:"嗀","嗂":"嗂","嗢":"嗢","嘆":"嘆","嘆":"嘆","噑":"噑","噴":"噴","器":"器",囹:"囹","圖":"圖","圗":"圗","⼟":"土",士:"土","⼠":"土","型":"型","城":"城",㦳:"㘽","埴":"埴","堍":"堍","報":"報","堲":"堲","塀":"塀",塚:"塚","塚":"塚",塞:"塞",填:"塡",壿:"墫","墬":"墬","墳":"墳",壘:"壘",壟:"壟","𡓤":"𡓤","壮":"壮","売":"売","壷":"壷","⼡":"夂","夆":"夆","⼢":"夊",タ:"夕","⼣":"夕","多":"多","夢":"夢","⼤":"大","奄":"奄",奈:"奈",契:"契","奔":"奔","奢":"奢",女:"女","⼥":"女","𡚨":"𡚨","𡛪":"𡛪","姘":"姘","姬":"姬","娛":"娛","娧":"娧","婢":"婢","婦":"婦",嬀:"媯","㛮":"㛮","㛼":"㛼","媵":"媵","嬈":"嬈","嬨":"嬨","嬾":"嬾","嬾":"嬾","⼦":"子","⼧":"宀",宅:"宅","𡧈":"𡧈","寃":"寃","寘":"寘",寧:"寧",寧:"寧","寧":"寧",寮:"寮","寳":"寳","𡬘":"𡬘","⼨":"寸","寿":"寿","将":"将","⼩":"小","尢":"尢","⺐":"尢","⼪":"尢","⺏":"尣","㞁":"㞁","⼫":"尸",尿:"尿","屠":"屠",屢:"屢","層":"層",履:"履","屮":"屮","屮":"屮","⼬":"屮","𡴋":"𡴋","⼭":"山","峀":"峀","岍":"岍","𡷤":"𡷤","𡷦":"𡷦",崙:"崙","嵃":"嵃",嵐:"嵐","嵫":"嵫","嵮":"嵮","嵼":"嵼","嶲":"嶲",嶺:"嶺","⼮":"巛","巢":"巢",エ:"工","⼯":"工","⼰":"己","⺒":"巳","㠯":"㠯","巽":"巽","⼱":"巾",帲:"帡","帨":"帨","帽":"帽","幩":"幩","㡢":"㡢","𢆃":"𢆃","⼲":"干",年:"年","𢆟":"𢆟","⺓":"幺","⼳":"幺","⼴":"广",度:"度","㡼":"㡼","庰":"庰","庳":"庳","庶":"庶",廊:"廊","廊":"廊",廉:"廉","廒":"廒",廓:"廓","廙":"廙",廬:"廬","⼵":"廴","廾":"廾","⼶":"廾","𢌱":"𢌱","𢌱":"𢌱",弄:"弄","⼷":"弋","⼸":"弓","弢":"弢","弢":"弢","⼹":"彐","⺔":"彑","当":"当","㣇":"㣇","⼺":"彡","形":"形","彩":"彩","彫":"彫","⼻":"彳",律:"律","㣣":"㣣","徚":"徚",復:"復","徭":"徭","⼼":"心","⺖":"忄","⺗":"㣺","忍":"忍","志":"志",念:"念","忹":"忹",怒:"怒",怜:"怜","恵":"恵","㤜":"㤜","㤺":"㤺","悁":"悁","悔":"悔","悔":"悔","惇":"惇","惘":"惘",惡:"惡","𢛔":"𢛔","愈":"愈","慨":"慨",慄:"慄","慈":"慈","慌":"慌","慌":"慌","慎":"慎","慎":"慎","慠":"慠","慺":"慺","憎":"憎","憎":"憎","憎":"憎",憐:"憐","憤":"憤","憯":"憯","憲":"憲","𢡄":"𢡄","𢡊":"𢡊","懞":"懞","懲":"懲","懲":"懲","懲":"懲",懶:"懶","懶":"懶",戀:"戀","⼽":"戈","成":"成","戛":"戛",戮:"戮","戴":"戴","⼾":"戶",戸:"戶","⼿":"手","⺘":"扌","扝":"扝","抱":"抱",拉:"拉",拏:"拏",拓:"拓","拔":"拔","拼":"拼",拾:"拾","𢬌":"𢬌","挽":"挽","捐":"捐","捨":"捨",捻:"捻","掃":"掃",掠:"掠","掩":"掩","揄":"揄","揤":"揤","摒":"摒","𢯱":"𢯱","搜":"搜","搢":"搢","揅":"揅","摩":"摩","摷":"摷","摾":"摾","㨮":"㨮",搉:"㩁",撚:"撚","撝":"撝",擄:"擄","㩬":"㩬","⽀":"支","⽁":"攴","⺙":"攵","敏":"敏","敏":"敏","敖":"敖","敬":"敬",數:"數","𣀊":"𣀊","⽂":"文","⻫":"斉","⽃":"斗",料:"料","⽄":"斤","⽅":"方",旅:"旅","⽆":"无","⺛":"旡","既":"既","旣":"旣","⽇":"日",易:"易",曶:"㫚","㫤":"㫤","晉":"晉",晩:"晚",晴:"晴","晴":"晴","暑":"暑","暑":"暑",暈:"暈","㬈":"㬈","暜":"暜",暴:"暴",曆:"曆","㬙":"㬙","𣊸":"𣊸","⽈":"曰",更:"更","書":"書","⽉":"月","𣍟":"𣍟",肦:"朌",胐:"朏",胊:"朐",脁:"朓",胶:"㬵",朗:"朗","朗":"朗","朗":"朗",脧:"朘","望":"望","望":"望",幐:"㬺",䐠:"㬻","𣎓":"𣎓",膧:"朣","𣎜":"𣎜","⽊":"木",李:"李","杓":"杓","杖":"杖","杞":"杞","𣏃":"𣏃",柿:"杮",杻:"杻","枅":"枅",林:"林","㭉":"㭉","𣏕":"𣏕",柳:"柳","柺":"柺",栗:"栗","栟":"栟","桒":"桒","𣑭":"𣑭",梁:"梁","梅":"梅","梅":"梅","梎":"梎",梨:"梨","椔":"椔","楂":"楂","㮝":"㮝","㮝":"㮝",槩:"㮣",樧:"榝","榣":"榣","槪":"槪",樂:"樂",樂:"樂",樂:"樂",樓:"樓","𣚣":"𣚣","檨":"檨",櫓:"櫓","櫛":"櫛",欄:"欄","㰘":"㰘","⽋":"欠","次":"次","𣢧":"𣢧","歔":"歔","㱎":"㱎","⽌":"止","⻭":"歯","歲":"歲",歷:"歷","歹":"歹","⽍":"歹","⺞":"歺","殟":"殟",殮:"殮","⽎":"殳",殺:"殺","殺":"殺","殺":"殺","殻":"殻","𣪍":"𣪍","⽏":"毋","⺟":"母","𣫺":"𣫺","⽐":"比","⽑":"毛","⽒":"氏","⺠":"民","⽓":"气","⽔":"水","⺡":"氵","⺢":"氺","汎":"汎","汧":"汧",沈:"沈","沿":"沿",泌:"泌","泍":"泍",泥:"泥","𣲼":"𣲼",洛:"洛",洞:"洞","洴":"洴","派":"派",流:"流","流":"流","流":"流","洖":"洖","浩":"浩",浪:"浪","海":"海","海":"海","浸":"浸","涅":"涅","𣴞":"𣴞",淋:"淋",淚:"淚",淪:"淪","淹":"淹","渚":"渚","港":"港","湮":"湮",潙:"溈","滋":"滋","滋":"滋",溜:"溜",溺:"溺","滇":"滇",滑:"滑","滛":"滛","㴳":"㴳",漏:"漏","漢":"漢","漢":"漢",漣:"漣","𣻑":"𣻑","潮":"潮","𣽞":"𣽞","𣾎":"𣾎","濆":"濆",濫:"濫",濾:"濾","瀛":"瀛","瀞":"瀞","瀞":"瀞","瀹":"瀹","灊":"灊","㶖":"㶖","⽕":"火","⺣":"灬","灰":"灰","灷":"灷","災":"災",炙:"炙","炭":"炭",烈:"烈",烙:"烙","煮":"煮","煮":"煮","𤉣":"𤉣","煅":"煅",煉:"煉","𤋮":"𤋮","熜":"熜",燎:"燎",燐:"燐","𤎫":"𤎫",爐:"爐",爛:"爛","爨":"爨","⽖":"爪","爫":"爫","⺤":"爫","爵":"爵","爵":"爵","⽗":"父","⽘":"爻","⺦":"丬","⽙":"爿","⽚":"片","牐":"牐","⽛":"牙","𤘈":"𤘈","⽜":"牛",牢:"牢","犀":"犀","犕":"犕","⽝":"犬","⺨":"犭","犯":"犯",狀:"狀","𤜵":"𤜵",狼:"狼",猪:"猪","猪":"猪","𤠔":"𤠔",獵:"獵","獺":"獺","⽞":"玄",率:"率",率:"率","⽟":"玉","王":"王","㺬":"㺬","玥":"玥",玲:"玲","㺸":"㺸","㺸":"㺸",珞:"珞",琉:"琉",理:"理","琢":"琢","瑇":"瑇","瑜":"瑜",瑩:"瑩","瑱":"瑱","瑱":"瑱","璅":"璅",璉:"璉",璘:"璘","瓊":"瓊","⽠":"瓜","⽡":"瓦","㼛":"㼛","甆":"甆","⽢":"甘","⽣":"生","甤":"甤","⽤":"用","⽥":"田","画":"画","甾":"甾","𤰶":"𤰶",留:"留",略:"略",異:"異","異":"異","𤲒":"𤲒","⽦":"疋","⽧":"疒",痢:"痢","瘐":"瘐","瘟":"瘟","瘝":"瘝",療:"療",癩:"癩","⽨":"癶","⽩":"白","𤾡":"𤾡","𤾸":"𤾸","⽪":"皮","⽫":"皿","𥁄":"𥁄","㿼":"㿼",益:"益","益":"益","盛":"盛",盧:"盧","䀈":"䀈","⽬":"目","直":"直","直":"直","𥃲":"𥃲","𥃳":"𥃳",省:"省","䀘":"䀘","𥄙":"𥄙","眞":"眞","真":"真","真":"真","𥄳":"𥄳","着":"着","睊":"睊","睊":"睊","鿃":"䀹","䀹":"䀹","䀹":"䀹",晣:"䀿","䁆":"䁆","瞋":"瞋","𥉉":"𥉉","瞧":"瞧","⽭":"矛","⽮":"矢","⽯":"石","䂖":"䂖","𥐝":"𥐝",硏:"研","硎":"硎",硫:"硫",碌:"碌","碌":"碌","碑":"碑",磊:"磊","磌":"磌","磌":"磌",磻:"磻","䃣":"䃣",礪:"礪","⽰":"示","⺭":"礻",礼:"礼","社":"社","祈":"祈","祉":"祉","𥘦":"𥘦","祐":"祐","祖":"祖","祖":"祖","祝":"祝",神:"神",祥:"祥","視":"視","視":"視",祿:"祿","𥚚":"𥚚","禍":"禍","禎":"禎",福:"福","福":"福","𥛅":"𥛅",禮:"禮","⽱":"禸","⽲":"禾",秊:"秊","䄯":"䄯","秫":"秫",稜:"稜","穊":"穊","穀":"穀","穀":"穀","穏":"穏","⽳":"穴","突":"突","𥥼":"𥥼","窱":"窱",立:"立","⽴":"立","⻯":"竜","𥪧":"𥪧","𥪧":"𥪧","竮":"竮","⽵":"竹",笠:"笠","節":"節","節":"節","䈂":"䈂","𥮫":"𥮫","篆":"篆","䈧":"䈧","築":"築","𥲀":"𥲀","𥳐":"𥳐",簾:"簾",籠:"籠","⽶":"米","类":"类",粒:"粒",精:"精","糒":"糒",糖:"糖","糨":"糨","䊠":"䊠","糣":"糣",糧:"糧","⽷":"糸","⺯":"糹","𥾆":"𥾆","紀":"紀",紐:"紐",索:"索",累:"累",絶:"絕","絣":"絣","絛":"絛",綠:"綠",綾:"綾","緇":"緇",練:"練","練":"練","練":"練","縂":"縂","䌁":"䌁","縉":"縉",縷:"縷","繁":"繁","繅":"繅","𦇚":"𦇚","䌴":"䌴","⽸":"缶","𦈨":"𦈨","缾":"缾","𦉇":"𦉇","⽹":"网","⺫":"罒","⺲":"罒","⺱":"罓","䍙":"䍙","署":"署","𦋙":"𦋙",罹:"罹","罺":"罺",羅:"羅","𦌾":"𦌾","⽺":"羊","羕":"羕",羚:"羚",羽:"羽","⽻":"羽","翺":"翺",老:"老","⽼":"老","⺹":"耂","者":"者","者":"者","者":"者","⽽":"而","𦓚":"𦓚","⽾":"耒","𦔣":"𦔣","⽿":"耳",聆:"聆","聠":"聠","𦖨":"𦖨",聯:"聯","聰":"聰",聾:"聾","⾀":"聿","⺺":"肀","⾁":"肉",肋:"肋","肭":"肭","育":"育","䏕":"䏕","䏙":"䏙",腁:"胼","脃":"脃","脾":"脾","䐋":"䐋","朡":"朡","𦞧":"𦞧","𦞵":"𦞵",朦:"䑃",臘:"臘","⾂":"臣",臨:"臨","⾃":"自","臭":"臭","⾄":"至","⾅":"臼","舁":"舁","舁":"舁","舄":"舄","⾆":"舌","舘":"舘","⾇":"舛","⾈":"舟","䑫":"䑫","⾉":"艮",良:"良","⾊":"色","⾋":"艸","艹":"艹","艹":"艹","⺾":"艹","⺿":"艹","⻀":"艹","芋":"芋","芑":"芑","芝":"芝","花":"花","芳":"芳","芽":"芽",若:"若","若":"若","苦":"苦","𦬼":"𦬼",茶:"茶","荒":"荒","荣":"荣","茝":"茝","茣":"茣","莽":"莽","荓":"荓",菉:"菉","菊":"菊","菌":"菌","菜":"菜","菧":"菧","華":"華",菱:"菱","著":"著","著":"著","𦰶":"𦰶","莭":"莭",落:"落",葉:"葉",蔿:"蒍","𦳕":"𦳕","𦵫":"𦵫",蓮:"蓮","蓱":"蓱","蓳":"蓳",蓼:"蓼","蔖":"蔖","䔫":"䔫","蕤":"蕤","𦼬":"𦼬",藍:"藍","䕝":"䕝","𦾱":"𦾱","䕡":"䕡",藺:"藺",蘆:"蘆","䕫":"䕫",蘒:"蘒",蘭:"蘭","𧃒":"𧃒",虁:"蘷",蘿:"蘿","⾌":"虍","⻁":"虎","虐":"虐",虜:"虜","虜":"虜","虧":"虧","虩":"虩","⾍":"虫","蚩":"蚩","蚈":"蚈","蛢":"蛢","蜎":"蜎","蜨":"蜨","蝫":"蝫","蟡":"蟡","蝹":"蝹","蝹":"蝹","螆":"螆","䗗":"䗗","𧏊":"𧏊",螺:"螺","蠁":"蠁","䗹":"䗹",蠟:"蠟","⾎":"血",行:"行","⾏":"行","衠":"衠","衣":"衣","⾐":"衣","⻂":"衤",裂:"裂","𧙧":"𧙧",裏:"裏","裗":"裗","裞":"裞",裡:"裡",裸:"裸","裺":"裺","䘵":"䘵","褐":"褐","襁":"襁",襤:"襤","⾑":"襾","⻄":"西","⻃":"覀","覆":"覆",見:"見","⾒":"見","𧢮":"𧢮","⻅":"见","⾓":"角","⾔":"言","𧥦":"𧥦",詽:"訮",訞:"䚶","䚾":"䚾","䛇":"䛇","誠":"誠",說:"說",說:"說","調":"調","請":"請",諒:"諒",論:"論","諭":"諭","諭":"諭",諸:"諸","諸":"諸",諾:"諾","諾":"諾","謁":"謁","謁":"謁","謹":"謹","謹":"謹",識:"識",讀:"讀",讏:"讆","變":"變","變":"變","⻈":"讠","⾕":"谷","⾖":"豆",豈:"豈","豕":"豕","⾗":"豕",豣:"豜","⾘":"豸","𧲨":"𧲨","⾙":"貝","貫":"貫","賁":"賁",賂:"賂",賈:"賈","賓":"賓","贈":"贈","贈":"贈","贛":"贛","⻉":"贝","⾚":"赤","⾛":"走","起":"起",趆:"赿","𧻓":"𧻓","𧼯":"𧼯","⾜":"足","跋":"跋","趼":"趼",跺:"跥",路:"路","跰":"跰",躛:"躗","⾝":"身",車:"車","⾞":"車","軔":"軔",輧:"軿",輦:"輦",輪:"輪","輸":"輸","輸":"輸",輻:"輻",轢:"轢","⻋":"车","⾟":"辛","辞":"辞",辰:"辰","⾠":"辰","⾡":"辵","辶":"辶","⻌":"辶","⻍":"辶","巡":"巡",連:"連",逸:"逸","逸":"逸","遲":"遲",遼:"遼","𨗒":"𨗒","𨗭":"𨗭",邏:"邏","⾢":"邑","邔":"邔",郎:"郎",郞:"郎","郞":"郎","郱":"郱",都:"都","𨜮":"𨜮","鄑":"鄑","鄛":"鄛","⾣":"酉",酪:"酪","醙":"醙",醴:"醴","⾤":"釆",里:"里","⾥":"里",量:"量",金:"金","⾦":"金",鈴:"鈴","鈸":"鈸","鉶":"鉶","鋗":"鋗","鋘":"鋘","鉼":"鉼",錄:"錄",鍊:"鍊",鎮:"鎭","鏹":"鏹","鐕":"鐕","𨯺":"𨯺","⻐":"钅","⻑":"長","⾧":"長","⻒":"镸","⻓":"长","⾨":"門","開":"開","䦕":"䦕",閭:"閭","閷":"閷","𨵷":"𨵷","⻔":"门","⾩":"阜","⻏":"阝","⻖":"阝",阮:"阮",陋:"陋",降:"降",陵:"陵",陸:"陸","陼":"陼",隆:"隆",隣:"隣","䧦":"䧦","⾪":"隶","隷":"隷",隸:"隷",隸:"隷","⾫":"隹","雃":"雃",離:"離","難":"難","難":"難","⾬":"雨",零:"零",雷:"雷","霣":"霣","𩅅":"𩅅",露:"露",靈:"靈","⾭":"靑","⻘":"青",靖:"靖","靖":"靖","𩇟":"𩇟","⾮":"非","⾯":"面","𩈚":"𩈚","⾰":"革","䩮":"䩮","䩶":"䩶","⾱":"韋","韛":"韛","韠":"韠","⻙":"韦","⾲":"韭","𩐊":"𩐊","⾳":"音","響":"響","響":"響","⾴":"頁","䪲":"䪲","頋":"頋","頋":"頋","頋":"頋",領:"領","頩":"頩","𩒖":"𩒖","頻":"頻","頻":"頻",類:"類","⻚":"页","⾵":"風","𩖶":"𩖶","⻛":"风","⾶":"飛","⻜":"飞","⻝":"食","⾷":"食","⻟":"飠","飢":"飢",飯:"飯",飼:"飼","䬳":"䬳",館:"館","餩":"餩","⻠":"饣","⾸":"首","⾹":"香","馧":"馧","⾺":"馬","駂":"駂",駱:"駱","駾":"駾",驪:"驪","⻢":"马","⾻":"骨","䯎":"䯎","⾼":"高","⾽":"髟","𩬰":"𩬰","鬒":"鬒","鬒":"鬒","⾾":"鬥","⾿":"鬯","⿀":"鬲","⿁":"鬼","⻤":"鬼","⿂":"魚",魯:"魯","鱀":"鱀",鱗:"鱗","⻥":"鱼","⿃":"鳥","鳽":"鳽","䳎":"䳎","鵧":"鵧","䳭":"䳭","𪃎":"𪃎",鶴:"鶴","𪄅":"𪄅","䳸":"䳸",鷺:"鷺","𪈎":"𪈎",鸞:"鸞",鹃:"鹂","⿄":"鹵",鹿:"鹿","⿅":"鹿","𪊑":"𪊑",麗:"麗",麟:"麟","⿆":"麥","⻨":"麦","麻":"麻","⿇":"麻","𪎒":"𪎒","⿈":"黃","⻩":"黄","⿉":"黍",黎:"黎","䵖":"䵖","⿊":"黑",黒:"黑","墨":"墨","黹":"黹","⿋":"黹","⿌":"黽","鼅":"鼅","黾":"黾","⿍":"鼎","鼏":"鼏","⿎":"鼓","鼖":"鼖","⿏":"鼠","鼻":"鼻","⿐":"鼻","齃":"齃","⿑":"齊","⻬":"齐","⿒":"齒","𪘀":"𪘀","⻮":"齿",龍:"龍","⿓":"龍","龎":"龎","⻰":"龙",龜:"龜",龜:"龜","龜":"龜","⿔":"龜","⻳":"龟","⿕":"龠"};var md=Uh;function Lh(r){return r.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")}var Nh=RegExp(Object.keys(md).map(Lh).join("|"),"g");function Kh(r){return md[r]}function Fh(r){return r.replace(Nh,Kh)}var $h=Fh;const Bh=Nr($h);var zs={exports:{}},vd={};function Tt(r,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(r)),this._timeouts=r,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}var xh=Tt;Tt.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};Tt.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};Tt.prototype.retry=function(r){if(this._timeout&&clearTimeout(this._timeout),!r)return!1;var e=new Date().getTime();if(r&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(r),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(r);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),t=this._cachedTimeouts.slice(-1);else return!1;var i=this;return this._timer=setTimeout(function(){i._attempts++,i._operationTimeoutCb&&(i._timeout=setTimeout(function(){i._operationTimeoutCb(i._attempts)},i._operationTimeout),i._options.unref&&i._timeout.unref()),i._fn(i._attempts)},t),this._options.unref&&this._timer.unref(),!0};Tt.prototype.attempt=function(r,e){this._fn=r,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};Tt.prototype.try=function(r){console.log("Using RetryOperation.try() is deprecated"),this.attempt(r)};Tt.prototype.start=function(r){console.log("Using RetryOperation.start() is deprecated"),this.attempt(r)};Tt.prototype.start=Tt.prototype.try;Tt.prototype.errors=function(){return this._errors};Tt.prototype.attempts=function(){return this._attempts};Tt.prototype.mainError=function(){if(this._errors.length===0)return null;for(var r={},e=null,t=0,i=0;i<this._errors.length;i++){var n=this._errors[i],s=n.message,o=(r[s]||0)+1;r[s]=o,o>=t&&(e=n,t=o)}return e};(function(r){var e=xh;r.operation=function(t){var i=r.timeouts(t);return new e(i,{forever:t&&(t.forever||t.retries===1/0),unref:t&&t.unref,maxRetryTime:t&&t.maxRetryTime})},r.timeouts=function(t){if(t instanceof Array)return[].concat(t);var i={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var n in t)i[n]=t[n];if(i.minTimeout>i.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var s=[],o=0;o<i.retries;o++)s.push(this.createTimeout(o,i));return t&&t.forever&&!s.length&&s.push(this.createTimeout(o,i)),s.sort(function(a,c){return a-c}),s},r.createTimeout=function(t,i){var n=i.randomize?Math.random()+1:1,s=Math.round(n*Math.max(i.minTimeout,1)*Math.pow(i.factor,t));return s=Math.min(s,i.maxTimeout),s},r.wrap=function(t,i,n){if(i instanceof Array&&(n=i,i=null),!n){n=[];for(var s in t)typeof t[s]=="function"&&n.push(s)}for(var o=0;o<n.length;o++){var a=n[o],c=t[a];t[a]=(function(u){var h=r.operation(i),f=Array.prototype.slice.call(arguments,1),g=f.pop();f.push(function(m){h.retry(m)||(m&&(arguments[0]=h.mainError()),g.apply(this,arguments))}),h.attempt(function(){u.apply(t,f)})}).bind(t,c),t[a].options=i}}})(vd);var qh=vd;const Vh=qh,jh=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class yd extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const Gh=(r,e,t)=>{const i=t.retries-(e-1);return r.attemptNumber=e,r.retriesLeft=i,r},Wh=r=>jh.includes(r),Sd=(r,e)=>new Promise((t,i)=>{e={onFailedAttempt:()=>{},retries:10,...e};const n=Vh.operation(e);n.attempt(async s=>{try{t(await r(s))}catch(o){if(!(o instanceof Error)){i(new TypeError(`Non-error was thrown: "${o}". You should only throw errors.`));return}if(o instanceof yd)n.stop(),i(o.originalError);else if(o instanceof TypeError&&!Wh(o.message))n.stop(),i(o);else{Gh(o,s,e);try{await e.onFailedAttempt(o)}catch(a){i(a);return}n.retry(o)||i(n.mainError())}}})});zs.exports=Sd;zs.exports.default=Sd;zs.exports.AbortError=yd;var Hh=zs.exports;const Ed=Nr(Hh),Jh=new Ce("m.asset","org.matrix.msc3488.asset"),Ba=new Ce("m.ts","org.matrix.msc3488.ts"),zh=new Ce("m.location","org.matrix.msc3488.location");var nt=(r=>(r.Read="m.read",r.FullyRead="m.fully_read",r.ReadPrivate="m.read.private",r))(nt||{});const Ys="main",uo=new Map;function ho(r){return r instanceof String&&(r=r.toString()),uo.has(r)||uo.set(r,r),uo.get(r)}function Is(r,e){const t=e??new URLSearchParams;for(const[i,n]of Object.entries(r))n!=null&&(Array.isArray(n)?n.forEach(s=>{t.append(i,String(s))}):t.append(i,String(n)));return t}function yc(r,e,t){const i={...t,[e]:t[r]};return delete i[r],i}function W(r,e){for(const t in e){if(!e.hasOwnProperty(t))continue;const i=e[t];i!=null&&(r=r.replace(t,encodeURIComponent(i)))}return r}function Rs(r,e,t){let i;if(t){for(i=r.length-1;i>=0;i--)if(e(r[i],i,r))return r.splice(i,1),!0}else for(i=0;i<r.length;i++)if(e(r[i],i,r))return r.splice(i,1),!0;return!1}function bd(r,e){for(const t of e)if(!r.hasOwnProperty(t))throw new Error("Missing required key: "+t)}function wd(r){return JSON.parse(JSON.stringify(r))}function Xi(r,e){if(r===e)return!0;if(typeof r!=typeof e)return!1;if(typeof r=="number"&&isNaN(r)&&isNaN(e))return!0;if(r===null||e===null)return r===e;if(!(r instanceof Object)||r.constructor!==e.constructor||r.prototype!==e.prototype)return!1;if(r instanceof RegExp||r instanceof Date)return r.toString()===e.toString();if(Array.isArray(r)){if(r.length!==e.length)return!1;for(let t=0;t<r.length;t++)if(!Xi(r[t],e[t]))return!1}else{for(const t in e)if(e.hasOwnProperty(t)!==r.hasOwnProperty(t))return!1;for(const t in r)if(e.hasOwnProperty(t)!==r.hasOwnProperty(t)||!Xi(r[t],e[t]))return!1}return!0}function Bo(r){if(typeof r!="object"||r==null||Array.isArray(r))return r;const e=[];for(const[t,i]of Object.entries(r))e.push([t,Bo(i)]);return e.sort((t,i)=>us(t[0],i[0])),e}function Sc(r){return typeof r=="number"&&isFinite(r)}function zi(r){return typeof r=="string"?Bh(r.normalize("NFD").replace(Qh,"")):""}function xo(r){return typeof r=="string"?r.replace(/[\u202d-\u202e]/g,""):""}function Yh(r){return zi(r.toLowerCase()).replace(/[\\'!"#$%&()*+,\-./:;<=>?@[\]^_`{|}~\u2000-\u206f\u2e00-\u2e7f]/g,"").toLowerCase()}const Qh=/[\u2000-\u200F\u202A-\u202F\u0300-\u036F\uFEFF\u061C\u2800\u2062-\u2063\s]/g;function _d(r){return r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Id(r){return _d(r).replace(/\\\*/g,".*").replace(/\?/g,".")}function fo(r){return r!=null&&r.endsWith("/")?r.slice(0,-1):r}function Ir(r,e){return new Promise(t=>{setTimeout(t,r,e)})}async function LE(r,e,t){const i=Date.now();try{return await t()}finally{const n=Date.now();r.debug(`[Perf]: ${e} took ${n-i}ms`)}}function Xh(){return new Promise(setImmediate)}function Rd(r){return r==null}function Nn(){let r,e;const t=new Promise((i,n)=>{r=i,e=n});return{resolve:r,reject:e,promise:t}}async function bn(r,e){for(const t of r)await e(await t)}function Zh(r){return Promise.resolve(r())}async function ef(r,e){const t=[];for(let i=0;i<r.length;i+=e)t.push(...await Promise.all(r.slice(i,i+e).map(n=>n())));return t}function tf(r){return Ed(e=>r(e),{forever:!0,factor:2,minTimeout:3e3,maxTimeout:15e3})}const Mi=(()=>{let r="";for(let e=32;e<=126;e++)r+=String.fromCharCode(e);return r})();function Ec(r,e,t=Mi){return r.padEnd(e,t[0])}function Rr(r,e=Mi){const t=BigInt(e.length);if(r<=t)return e[Number(r)-1]??"";let i=r/t,n=Number(r%t)-1;return n<0&&(i-=BigInt(Math.abs(n)),n=Number(t)-1),Rr(i,e)+e[n]}function Ts(r,e=Mi){const t=BigInt(e.length);let i=BigInt(0);for(let n=r.length-1,s=BigInt(0);n>=0;n--,s++){const o=r.charCodeAt(n)-e.charCodeAt(0);i+=BigInt(1+o)*t**s}return i}function nf(r,e,t=Mi){const i=Math.max(r.length,e.length),n=Ts(Ec(r,i,t),t),s=Ts(Ec(e,i,t),t),o=(n+s)/BigInt(2);return o===n||o==s?Rr(o,t)+t[0]:Rr(o,t)}function Qn(r,e=Mi){return Rr(Ts(r,e)+BigInt(1),e)}function bc(r,e=Mi){return Rr(Ts(r,e)-BigInt(1),e)}function us(r,e){return r<e?-1:r>e?1:0}const rf=new Intl.Collator;function sf(r,e){return rf.compare(r,e)}function Td(r,e,t=!1){for(const[i,n]of Object.entries(e)){if(r[i]instanceof Object&&n){Td(r[i],n);continue}if(n!=null||!t){Gt(r,i,n);continue}}return r}function wc(r){return Ba.findIn(r.getContent())??-1}function of(r,e){return wc(e)-wc(r)}function Cd(r){return[nt.Read,nt.ReadPrivate].includes(r)}function _c(r,e,t=(i,n)=>i===n){if(r.size!==e.size)return!1;for(const[i,n]of r){const s=e.get(i);if(s===void 0||!t(n,s))return!1}return!0}function kd(r){return r instanceof Map?In(r):Array.isArray(r)?r.map(e=>kd(e)):r}function In(r){const e=new Map;for(const[t,i]of r)e.set(t,kd(i));return Object.fromEntries(e.entries())}function wn(r){return r==="__proto__"||r==="prototype"||r==="constructor"}function Gt(r,e,t){if(wn(e))throw new Error("Trying to modify prototype or constructor");r[e]=t}function Dt(r){return!(wn(r.room_id)||wn(r.sender)||wn(r.user_id)||wn(r.event_id))}class $e extends Map{constructor(e){super(),this.createDefault=e}getOrCreate(e){return this.has(e)||this.set(e,this.createDefault()),this.get(e)}}const qo="migrationState";var Zi=(r=>(r[r.NOT_STARTED=0]="NOT_STARTED",r[r.INITIAL_DATA_MIGRATED=1]="INITIAL_DATA_MIGRATED",r[r.OLM_SESSIONS_MIGRATED=2]="OLM_SESSIONS_MIGRATED",r[r.MEGOLM_SESSIONS_MIGRATED=3]="MEGOLM_SESSIONS_MIGRATED",r[r.ROOM_SETTINGS_MIGRATED=4]="ROOM_SETTINGS_MIGRATED",r[r.INITIAL_OWN_KEY_QUERY_DONE=5]="INITIAL_OWN_KEY_QUERY_DONE",r))(Zi||{});const Pn=50;function Ni(r,e){return encodeURIComponent(r)+"/"+encodeURIComponent(e)}function go(r){const e=r.split("/"),t=decodeURIComponent(e[0]),i=decodeURIComponent(e[1]);return{senderKey:t,sessionId:i}}class xa{constructor(){this.migrationState=Zi.NOT_STARTED,this.outgoingRoomKeyRequests=[],this.account=null,this.crossSigningKeys=null,this.privateKeys={},this.sessions={},this.sessionProblems={},this.notifiedErrorDevices={},this.inboundGroupSessions={},this.inboundGroupSessionsWithheld={},this.deviceData=null,this.rooms={},this.sessionsNeedingBackup={},this.sharedHistoryInboundGroupSessions={},this.parkedSharedHistory=new Map}async containsData(){return this.account!==null}async startup(){return this}deleteAllData(){return Promise.resolve()}async getMigrationState(){return this.migrationState}async setMigrationState(e){this.migrationState=e}getOrAddOutgoingRoomKeyRequest(e){const t=e.requestBody;return Zh(()=>{const i=this._getOutgoingRoomKeyRequest(t);return i?(d.log(`already have key request outstanding for ${t.room_id} / ${t.session_id}: not sending another`),i):(d.log(`enqueueing key request for ${t.room_id} / `+t.session_id),this.outgoingRoomKeyRequests.push(e),e)})}getOutgoingRoomKeyRequest(e){return Promise.resolve(this._getOutgoingRoomKeyRequest(e))}_getOutgoingRoomKeyRequest(e){for(const t of this.outgoingRoomKeyRequests)if(Xi(t.requestBody,e))return t;return null}getOutgoingRoomKeyRequestByState(e){for(const t of this.outgoingRoomKeyRequests)for(const i of e)if(t.state===i)return Promise.resolve(t);return Promise.resolve(null)}getAllOutgoingRoomKeyRequestsByState(e){return Promise.resolve(this.outgoingRoomKeyRequests.filter(t=>t.state==e))}getOutgoingRoomKeyRequestsByTarget(e,t,i){const n=[];for(const s of this.outgoingRoomKeyRequests)for(const o of i)s.state===o&&s.recipients.some(a=>a.userId===e&&a.deviceId===t)&&n.push(s);return Promise.resolve(n)}updateOutgoingRoomKeyRequest(e,t,i){for(const n of this.outgoingRoomKeyRequests)if(n.requestId===e)return n.state!==t?(d.warn(`Cannot update room key request from ${t} as it was already updated to ${n.state}`),Promise.resolve(null)):(Object.assign(n,i),Promise.resolve(n));return Promise.resolve(null)}deleteOutgoingRoomKeyRequest(e,t){for(let i=0;i<this.outgoingRoomKeyRequests.length;i++){const n=this.outgoingRoomKeyRequests[i];if(n.requestId===e)return n.state!=t?(d.warn(`Cannot delete room key request in state ${n.state} (expected ${t})`),Promise.resolve(null)):(this.outgoingRoomKeyRequests.splice(i,1),Promise.resolve(n))}return Promise.resolve(null)}getAccount(e,t){t(this.account)}storeAccount(e,t){this.account=t}getCrossSigningKeys(e,t){t(this.crossSigningKeys)}getSecretStorePrivateKey(e,t,i){const n=this.privateKeys[i];t(n||null)}storeCrossSigningKeys(e,t){this.crossSigningKeys=t}storeSecretStorePrivateKey(e,t,i){this.privateKeys[t]=i}countEndToEndSessions(e,t){let i=0;for(const n of Object.values(this.sessions))i+=Object.keys(n).length;t(i)}getEndToEndSession(e,t,i,n){const s=this.sessions[e]||{};n(s[t]||null)}getEndToEndSessions(e,t,i){i(this.sessions[e]||{})}getAllEndToEndSessions(e,t){Object.entries(this.sessions).forEach(([i,n])=>{Object.entries(n).forEach(([s,o])=>{t({...o,deviceKey:i,sessionId:s})})})}storeEndToEndSession(e,t,i,n){let s=this.sessions[e];s===void 0&&(s={},this.sessions[e]=s),Gt(s,t,i)}async storeEndToEndSessionProblem(e,t,i){const n=this.sessionProblems[e]=this.sessionProblems[e]||[];n.push({type:t,fixed:i,time:Date.now()}),n.sort((s,o)=>s.time-o.time)}async getEndToEndSessionProblem(e,t){const i=this.sessionProblems[e]||[];if(!i.length)return null;const n=i[i.length-1];for(const s of i)if(s.time>t)return Object.assign({},s,{fixed:n.fixed});return n.fixed?null:n}async filterOutNotifiedErrorDevices(e){const t=this.notifiedErrorDevices,i=[];for(const n of e){const{userId:s,deviceInfo:o}=n;s in t?o.deviceId in t[s]||(i.push(n),Gt(t[s],o.deviceId,!0)):(i.push(n),Gt(t,s,{[o.deviceId]:!0}))}return i}async getEndToEndSessionsBatch(){const e=[];for(const t of Object.values(this.sessions))for(const i of Object.values(t))if(e.push(i),e.length>=Pn)return e;return e.length===0?null:e}async deleteEndToEndSessionsBatch(e){for(const{deviceKey:t,sessionId:i}of e){const n=this.sessions[t]||{};delete n[i],Object.keys(n).length===0&&delete this.sessions[t]}}getEndToEndInboundGroupSession(e,t,i,n){const s=Ni(e,t);n(this.inboundGroupSessions[s]||null,this.inboundGroupSessionsWithheld[s]||null)}getAllEndToEndInboundGroupSessions(e,t){for(const i of Object.keys(this.inboundGroupSessions))t({...go(i),sessionData:this.inboundGroupSessions[i]});t(null)}addEndToEndInboundGroupSession(e,t,i,n){const s=Ni(e,t);this.inboundGroupSessions[s]===void 0&&(this.inboundGroupSessions[s]=i)}storeEndToEndInboundGroupSession(e,t,i,n){const s=Ni(e,t);this.inboundGroupSessions[s]=i}storeEndToEndInboundGroupSessionWithheld(e,t,i,n){const s=Ni(e,t);this.inboundGroupSessionsWithheld[s]=i}async countEndToEndInboundGroupSessions(){return Object.keys(this.inboundGroupSessions).length}async getEndToEndInboundGroupSessionsBatch(){const e=[];for(const[t,i]of Object.entries(this.inboundGroupSessions))if(e.push({...go(t),sessionData:i,needsBackup:t in this.sessionsNeedingBackup}),e.length>=Pn)return e;return e.length===0?null:e}async deleteEndToEndInboundGroupSessionsBatch(e){for(const{senderKey:t,sessionId:i}of e){const n=Ni(t,i);delete this.inboundGroupSessions[n]}}getEndToEndDeviceData(e,t){t(this.deviceData)}storeEndToEndDeviceData(e,t){this.deviceData=e}storeEndToEndRoom(e,t,i){this.rooms[e]=t}getEndToEndRooms(e,t){t(this.rooms)}getSessionsNeedingBackup(e){const t=[];for(const i in this.sessionsNeedingBackup)if(this.inboundGroupSessions[i]&&(t.push({...go(i),sessionData:this.inboundGroupSessions[i]}),e&&i.length>=e))break;return Promise.resolve(t)}countSessionsNeedingBackup(){return Promise.resolve(Object.keys(this.sessionsNeedingBackup).length)}unmarkSessionsNeedingBackup(e){for(const t of e){const i=Ni(t.senderKey,t.sessionId);delete this.sessionsNeedingBackup[i]}return Promise.resolve()}markSessionsNeedingBackup(e){for(const t of e){const i=Ni(t.senderKey,t.sessionId);this.sessionsNeedingBackup[i]=!0}return Promise.resolve()}addSharedHistoryInboundGroupSession(e,t,i){const n=this.sharedHistoryInboundGroupSessions[e]||[];n.push([t,i]),this.sharedHistoryInboundGroupSessions[e]=n}getSharedHistoryInboundGroupSessions(e){return Promise.resolve(this.sharedHistoryInboundGroupSessions[e]||[])}addParkedSharedHistory(e,t){const i=this.parkedSharedHistory.get(e)??[];i.push(t),this.parkedSharedHistory.set(e,i)}takeParkedSharedHistory(e){const t=this.parkedSharedHistory.get(e)??[];return this.parkedSharedHistory.delete(e),Promise.resolve(t)}doTxn(e,t,i){return Promise.resolve(i(null))}}function qa(r,e,t,i,n,s=!1,o){if(typeof e!="string"||!e)return"";if(e.indexOf("mxc://")!==0)return s?e:"";let a=e.slice(6),c="/_matrix/media/v3/download/";const l={};t&&(l.width=Math.round(t).toString()),i&&(l.height=Math.round(i).toString()),n&&(l.method=n),Object.keys(l).length>0&&(c="/_matrix/media/v3/thumbnail/"),typeof o=="boolean"&&(l.allow_redirect=JSON.stringify(o));const u=a.indexOf("#");let h="";u>=0&&(h=a.slice(u),a=a.slice(0,u));const f=Object.keys(l).length===0?"":"?"+Is(l);return r+c+a+f+h}var Va={exports:{}},Rn=typeof Reflect=="object"?Reflect:null,Ic=Rn&&typeof Rn.apply=="function"?Rn.apply:function(e,t,i){return Function.prototype.apply.call(e,t,i)},hs;Rn&&typeof Rn.ownKeys=="function"?hs=Rn.ownKeys:Object.getOwnPropertySymbols?hs=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:hs=function(e){return Object.getOwnPropertyNames(e)};function af(r){console&&console.warn&&console.warn(r)}var Od=Number.isNaN||function(e){return e!==e};function we(){we.init.call(this)}Va.exports=we;Va.exports.once=uf;we.EventEmitter=we;we.prototype._events=void 0;we.prototype._eventsCount=0;we.prototype._maxListeners=void 0;var Rc=10;function Qs(r){if(typeof r!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof r)}Object.defineProperty(we,"defaultMaxListeners",{enumerable:!0,get:function(){return Rc},set:function(r){if(typeof r!="number"||r<0||Od(r))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+r+".");Rc=r}});we.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};we.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||Od(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function Md(r){return r._maxListeners===void 0?we.defaultMaxListeners:r._maxListeners}we.prototype.getMaxListeners=function(){return Md(this)};we.prototype.emit=function(e){for(var t=[],i=1;i<arguments.length;i++)t.push(arguments[i]);var n=e==="error",s=this._events;if(s!==void 0)n=n&&s.error===void 0;else if(!n)return!1;if(n){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var c=s[e];if(c===void 0)return!1;if(typeof c=="function")Ic(c,this,t);else for(var l=c.length,u=Ld(c,l),i=0;i<l;++i)Ic(u[i],this,t);return!0};function Ad(r,e,t,i){var n,s,o;if(Qs(t),s=r._events,s===void 0?(s=r._events=Object.create(null),r._eventsCount=0):(s.newListener!==void 0&&(r.emit("newListener",e,t.listener?t.listener:t),s=r._events),o=s[e]),o===void 0)o=s[e]=t,++r._eventsCount;else if(typeof o=="function"?o=s[e]=i?[t,o]:[o,t]:i?o.unshift(t):o.push(t),n=Md(r),n>0&&o.length>n&&!o.warned){o.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=r,a.type=e,a.count=o.length,af(a)}return r}we.prototype.addListener=function(e,t){return Ad(this,e,t,!1)};we.prototype.on=we.prototype.addListener;we.prototype.prependListener=function(e,t){return Ad(this,e,t,!0)};function cf(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Pd(r,e,t){var i={fired:!1,wrapFn:void 0,target:r,type:e,listener:t},n=cf.bind(i);return n.listener=t,i.wrapFn=n,n}we.prototype.once=function(e,t){return Qs(t),this.on(e,Pd(this,e,t)),this};we.prototype.prependOnceListener=function(e,t){return Qs(t),this.prependListener(e,Pd(this,e,t)),this};we.prototype.removeListener=function(e,t){var i,n,s,o,a;if(Qs(t),n=this._events,n===void 0)return this;if(i=n[e],i===void 0)return this;if(i===t||i.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete n[e],n.removeListener&&this.emit("removeListener",e,i.listener||t));else if(typeof i!="function"){for(s=-1,o=i.length-1;o>=0;o--)if(i[o]===t||i[o].listener===t){a=i[o].listener,s=o;break}if(s<0)return this;s===0?i.shift():lf(i,s),i.length===1&&(n[e]=i[0]),n.removeListener!==void 0&&this.emit("removeListener",e,a||t)}return this};we.prototype.off=we.prototype.removeListener;we.prototype.removeAllListeners=function(e){var t,i,n;if(i=this._events,i===void 0)return this;if(i.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):i[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete i[e]),this;if(arguments.length===0){var s=Object.keys(i),o;for(n=0;n<s.length;++n)o=s[n],o!=="removeListener"&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=i[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(n=t.length-1;n>=0;n--)this.removeListener(e,t[n]);return this};function Dd(r,e,t){var i=r._events;if(i===void 0)return[];var n=i[e];return n===void 0?[]:typeof n=="function"?t?[n.listener||n]:[n]:t?df(n):Ld(n,n.length)}we.prototype.listeners=function(e){return Dd(this,e,!0)};we.prototype.rawListeners=function(e){return Dd(this,e,!1)};we.listenerCount=function(r,e){return typeof r.listenerCount=="function"?r.listenerCount(e):Ud.call(r,e)};we.prototype.listenerCount=Ud;function Ud(r){var e=this._events;if(e!==void 0){var t=e[r];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}we.prototype.eventNames=function(){return this._eventsCount>0?hs(this._events):[]};function Ld(r,e){for(var t=new Array(e),i=0;i<e;++i)t[i]=r[i];return t}function lf(r,e){for(;e+1<r.length;e++)r[e]=r[e+1];r.pop()}function df(r){for(var e=new Array(r.length),t=0;t<e.length;++t)e[t]=r[t].listener||r[t];return e}function uf(r,e){return new Promise(function(t,i){function n(o){r.removeListener(e,s),i(o)}function s(){typeof r.removeListener=="function"&&r.removeListener("error",n),t([].slice.call(arguments))}Nd(r,e,s,{once:!0}),e!=="error"&&hf(r,n,{once:!0})})}function hf(r,e,t){typeof r.on=="function"&&Nd(r,"error",e,t)}function Nd(r,e,t,i){if(typeof r.on=="function")i.once?r.once(e,t):r.on(e,t);else if(typeof r.addEventListener=="function")r.addEventListener(e,function n(s){i.once&&r.removeEventListener(e,n),t(s)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof r)}var Kr=Va.exports;const ff=Nr(Kr);var Kd=(r=>(r.NewListener="newListener",r.RemoveListener="removeListener",r.Error="error",r))(Kd||{});class ke extends Kr.EventEmitter{addListener(e,t){return super.addListener(e,t)}emit(e,...t){return super.emit(e,...t)}async emitPromised(e,...t){const i=this.listeners(e);return Promise.allSettled(i.map(n=>n(...t))).then(()=>i.length>0)}listenerCount(e){return super.listenerCount(e)}listeners(e){return super.listeners(e)}off(e,t){return super.off(e,t)}on(e,t){return super.on(e,t)}once(e,t){return super.once(e,t)}prependListener(e,t){return super.prependListener(e,t)}prependOnceListener(e,t){return super.prependOnceListener(e,t)}removeAllListeners(e){return e===void 0?super.removeAllListeners():super.removeAllListeners(e)}removeListener(e,t){return super.removeListener(e,t)}rawListeners(e){return super.rawListeners(e)}}var ae=(r=>(r.Ban="ban",r.Invite="invite",r.Join="join",r.Knock="knock",r.Leave="leave",r))(ae||{}),Nt=(r=>(r.Membership="RoomMember.membership",r.Name="RoomMember.name",r.PowerLevel="RoomMember.powerLevel",r.Typing="RoomMember.typing",r))(Nt||{});class Vo extends ke{constructor(e,t){super(),this.roomId=e,this.userId=t,this._isOutOfBand=!1,this.modified=-1,this.requestedProfileInfo=!1,this.typing=!1,this.powerLevel=0,this.powerLevelNorm=0,this.disambiguate=!1,this.events={},this.name=t,this.rawDisplayName=t,this.updateModifiedTime()}markOutOfBand(){this._isOutOfBand=!0}isOutOfBand(){return this._isOutOfBand}setMembershipEvent(e,t){const i=e.getDirectionalContent().displayname??"";if(e.getType()!==R.RoomMember)return;this._isOutOfBand=!1,this.events.member=e;const n=this.membership;this.membership=e.getDirectionalContent().membership,this.membership===void 0&&d.trace(`membership event with membership undefined (forwardLooking: ${e.forwardLooking})!`,e.getContent(),"prevcontent is ",e.getPrevContent()),this.disambiguate=mf(this.userId,i,t);const s=this.name;this.name=vf(this.userId,i,this.disambiguate),this.rawDisplayName=xo(e.getDirectionalContent().displayname??""),(!this.rawDisplayName||!zi(this.rawDisplayName))&&(this.rawDisplayName=this.userId),n!==this.membership&&(this.updateModifiedTime(),this.emit("RoomMember.membership",e,this,n)),s!==this.name&&(this.updateModifiedTime(),this.emit("RoomMember.name",e,this,s))}setPowerLevelEvent(e){if(e.getType()!==R.RoomPowerLevels||e.getStateKey()!=="")return;const t=e.getDirectionalContent();let i=t.users_default||0;const n=t.users||{};Object.values(n).forEach(a=>{i=Math.max(i,a)});const s=this.powerLevel,o=this.powerLevelNorm;n[this.userId]!==void 0&&Number.isInteger(n[this.userId])?this.powerLevel=n[this.userId]:t.users_default!==void 0?this.powerLevel=t.users_default:this.powerLevel=0,this.powerLevelNorm=0,i>0&&(this.powerLevelNorm=this.powerLevel*100/i),(s!==this.powerLevel||o!==this.powerLevelNorm)&&(this.updateModifiedTime(),this.emit("RoomMember.powerLevel",e,this))}setTypingEvent(e){if(e.getType()!=="m.typing")return;const t=this.typing;this.typing=!1;const i=e.getContent().user_ids;Array.isArray(i)&&(i.indexOf(this.userId)!==-1&&(this.typing=!0),t!==this.typing&&(this.updateModifiedTime(),this.emit("RoomMember.typing",e,this)))}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}isKicked(){return this.membership===ae.Leave&&this.events.member!==void 0&&this.events.member.getSender()!==this.events.member.getStateKey()}getDMInviter(){if(this.events.member){const e=this.events.member;let t=e.getContent(),i=e.getSender();if(t.membership===ae.Join&&(t=e.getPrevContent(),i=e.getUnsigned().prev_sender),t.membership===ae.Invite&&t.is_direct)return i}}getAvatarUrl(e,t,i,n,s=!0,o){const a=this.getMxcAvatarUrl();if(!a&&!s)return null;const c=qa(e,a,t,i,n,o);return c||null}getMxcAvatarUrl(){if(this.events.member)return this.events.member.getDirectionalContent().avatar_url;if(this.user)return this.user.avatarUrl}}const gf=/@.+:.+/,pf=/[\u200E\u200F\u202A-\u202F]/;function mf(r,e,t){return!e||e===r||!zi(e)||!t?!1:!!(gf.test(e)||pf.test(e)||t.getUserIdsWithDisplayName(e).some(n=>n!==r))}function vf(r,e,t){return!e||e===r?r:t?xo(e)+" ("+r+")":zi(e)?xo(e):r}var ot={},Xs={},Fr={};Object.defineProperty(Fr,"__esModule",{value:!0});Fr.NamespacedMap=void 0;function yf(r,e){var t=typeof Symbol<"u"&&r[Symbol.iterator]||r["@@iterator"];if(!t){if(Array.isArray(r)||(t=Sf(r))||e&&r&&typeof r.length=="number"){t&&(r=t);var i=0,n=function(){};return{s:n,n:function(){return i>=r.length?{done:!0}:{done:!1,value:r[i++]}},e:function(l){throw l},f:n}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var s=!0,o=!1,a;return{s:function(){t=t.call(r)},n:function(){var l=t.next();return s=l.done,l},e:function(l){o=!0,a=l},f:function(){try{!s&&t.return!=null&&t.return()}finally{if(o)throw a}}}}function Sf(r,e){if(r){if(typeof r=="string")return Tc(r,e);var t=Object.prototype.toString.call(r).slice(8,-1);if(t==="Object"&&r.constructor&&(t=r.constructor.name),t==="Map"||t==="Set")return Array.from(r);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return Tc(r,e)}}function Tc(r,e){(e==null||e>r.length)&&(e=r.length);for(var t=0,i=new Array(e);t<e;t++)i[t]=r[t];return i}function Ef(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function Cc(r,e){for(var t=0;t<e.length;t++){var i=e[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(r,i.key,i)}}function bf(r,e,t){return e&&Cc(r.prototype,e),t&&Cc(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}function wf(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}var _f=function(){function r(e){if(Ef(this,r),wf(this,"internalMap",new Map),e){var t=yf(e),i;try{for(t.s();!(i=t.n()).done;){var n=i.value;this.set(n[0],n[1])}}catch(s){t.e(s)}finally{t.f()}}}return bf(r,[{key:"get",value:function(t){return t.name&&this.internalMap.has(t.name)?this.internalMap.get(t.name):t.altName&&this.internalMap.has(t.altName)?this.internalMap.get(t.altName):null}},{key:"set",value:function(t,i){t.name&&this.internalMap.set(t.name,i),t.altName&&this.internalMap.set(t.altName,i)}},{key:"has",value:function(t){return!!this.get(t)}},{key:"delete",value:function(t){t.name&&this.internalMap.delete(t.name),t.altName&&this.internalMap.delete(t.altName)}},{key:"hasNamespaced",value:function(t){return this.internalMap.has(t)}},{key:"getNamespaced",value:function(t){return this.internalMap.get(t)}}]),r}();Fr.NamespacedMap=_f;var ui={};function jo(r){"@babel/helpers - typeof";return jo=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},jo(r)}Object.defineProperty(ui,"__esModule",{value:!0});ui.InvalidEventError=void 0;function kc(r,e){for(var t=0;t<e.length;t++){var i=e[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(r,i.key,i)}}function If(r,e,t){return e&&kc(r.prototype,e),t&&kc(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}function Rf(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function Tf(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),e&&Tr(r,e)}function Cf(r){var e=Fd();return function(){var i=Cr(r),n;if(e){var s=Cr(this).constructor;n=Reflect.construct(i,arguments,s)}else n=i.apply(this,arguments);return kf(this,n)}}function kf(r,e){if(e&&(jo(e)==="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return Of(r)}function Of(r){if(r===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return r}function Go(r){var e=typeof Map=="function"?new Map:void 0;return Go=function(i){if(i===null||!Mf(i))return i;if(typeof i!="function")throw new TypeError("Super expression must either be null or a function");if(typeof e<"u"){if(e.has(i))return e.get(i);e.set(i,n)}function n(){return fs(i,arguments,Cr(this).constructor)}return n.prototype=Object.create(i.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),Tr(n,i)},Go(r)}function fs(r,e,t){return Fd()?fs=Reflect.construct:fs=function(n,s,o){var a=[null];a.push.apply(a,s);var c=Function.bind.apply(n,a),l=new c;return o&&Tr(l,o.prototype),l},fs.apply(null,arguments)}function Fd(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function Mf(r){return Function.toString.call(r).indexOf("[native code]")!==-1}function Tr(r,e){return Tr=Object.setPrototypeOf||function(i,n){return i.__proto__=n,i},Tr(r,e)}function Cr(r){return Cr=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},Cr(r)}var Af=function(r){Tf(t,r);var e=Cf(t);function t(i){return Rf(this,t),e.call(this,i)}return If(t)}(Go(Error));ui.InvalidEventError=Af;var Kn={},zt={},Di={};Object.defineProperty(Di,"__esModule",{value:!0});Di.ExtensibleEvent=void 0;function Pf(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function Oc(r,e){for(var t=0;t<e.length;t++){var i=e[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(r,i.key,i)}}function Df(r,e,t){return e&&Oc(r.prototype,e),t&&Oc(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}var Uf=function(){function r(e){Pf(this,r),this.wireFormat=e}return Df(r,[{key:"wireContent",get:function(){return this.wireFormat.content}}]),r}();Di.ExtensibleEvent=Uf;var $r={};Object.defineProperty($r,"__esModule",{value:!0});$r.isOptionalAString=Lf;$r.isProvided=$d;function Lf(r){return $d(r)&&typeof r=="string"}function $d(r){return r!=null}var De={},Ft={};function Wo(r){"@babel/helpers - typeof";return Wo=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Wo(r)}Object.defineProperty(Ft,"__esModule",{value:!0});Ft.UnstableValue=Ft.NamespacedValue=void 0;function Nf(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),e&&Ho(r,e)}function Ho(r,e){return Ho=Object.setPrototypeOf||function(i,n){return i.__proto__=n,i},Ho(r,e)}function Kf(r){var e=Bf();return function(){var i=Cs(r),n;if(e){var s=Cs(this).constructor;n=Reflect.construct(i,arguments,s)}else n=i.apply(this,arguments);return Ff(this,n)}}function Ff(r,e){if(e&&(Wo(e)==="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return $f(r)}function $f(r){if(r===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return r}function Bf(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function Cs(r){return Cs=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},Cs(r)}function Bd(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function Mc(r,e){for(var t=0;t<e.length;t++){var i=e[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(r,i.key,i)}}function xd(r,e,t){return e&&Mc(r.prototype,e),t&&Mc(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}var qd=function(){function r(e,t){if(Bd(this,r),this.stable=e,this.unstable=t,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}return xd(r,[{key:"name",get:function(){return this.stable?this.stable:this.unstable}},{key:"altName",get:function(){return this.stable?this.unstable:null}},{key:"matches",value:function(t){return!!this.name&&this.name===t||!!this.altName&&this.altName===t}},{key:"findIn",value:function(t){var i;return this.name&&(i=t==null?void 0:t[this.name]),!i&&this.altName&&(i=t==null?void 0:t[this.altName]),i}},{key:"includedIn",value:function(t){var i=!1;return this.name&&(i=t.includes(this.name)),!i&&this.altName&&(i=t.includes(this.altName)),i}}]),r}();Ft.NamespacedValue=qd;var xf=function(r){Nf(t,r);var e=Kf(t);function t(i,n){var s;if(Bd(this,t),s=e.call(this,i,n),!s.unstable)throw new Error("Unstable value must be supplied");return s}return xd(t,[{key:"name",get:function(){return this.unstable}},{key:"altName",get:function(){return this.stable}}]),t}(qd);Ft.UnstableValue=xf;Object.defineProperty(De,"__esModule",{value:!0});De.M_TEXT=De.M_NOTICE=De.M_MESSAGE=De.M_HTML=De.M_EMOTE=void 0;var Br=Ft,qf=new Br.UnstableValue("m.message","org.matrix.msc1767.message");De.M_MESSAGE=qf;var Vf=new Br.UnstableValue("m.text","org.matrix.msc1767.text");De.M_TEXT=Vf;var jf=new Br.UnstableValue("m.html","org.matrix.msc1767.html");De.M_HTML=jf;var Gf=new Br.UnstableValue("m.emote","org.matrix.msc1767.emote");De.M_EMOTE=Gf;var Wf=new Br.UnstableValue("m.notice","org.matrix.msc1767.notice");De.M_NOTICE=Wf;var hi={};Object.defineProperty(hi,"__esModule",{value:!0});hi.isEventTypeSame=Hf;function Hf(r,e){if(typeof r=="string")return typeof e=="string"?e===r:e.matches(r);if(typeof e=="string")return r.matches(e);var t=e,i=r;return t.matches(i.name)||t.matches(i.altName)}function Jo(r){"@babel/helpers - typeof";return Jo=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Jo(r)}Object.defineProperty(zt,"__esModule",{value:!0});zt.MessageEvent=void 0;var Jf=Di,Xn=$r,po=ui,gt=De,zf=hi;function Ac(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(r);e&&(i=i.filter(function(n){return Object.getOwnPropertyDescriptor(r,n).enumerable})),t.push.apply(t,i)}return t}function Pc(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Ac(Object(t),!0).forEach(function(i){Si(r,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Ac(Object(t)).forEach(function(i){Object.defineProperty(r,i,Object.getOwnPropertyDescriptor(t,i))})}return r}function Yf(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function Dc(r,e){for(var t=0;t<e.length;t++){var i=e[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(r,i.key,i)}}function Qf(r,e,t){return e&&Dc(r.prototype,e),t&&Dc(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}function Xf(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),e&&zo(r,e)}function zo(r,e){return zo=Object.setPrototypeOf||function(i,n){return i.__proto__=n,i},zo(r,e)}function Zf(r){var e=tg();return function(){var i=ks(r),n;if(e){var s=ks(this).constructor;n=Reflect.construct(i,arguments,s)}else n=i.apply(this,arguments);return eg(this,n)}}function eg(r,e){if(e&&(Jo(e)==="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return gs(r)}function gs(r){if(r===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return r}function tg(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function ks(r){return ks=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},ks(r)}function Si(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}var ig=function(r){Xf(t,r);var e=Zf(t);function t(i){var n;Yf(this,t),n=e.call(this,i),Si(gs(n),"text",void 0),Si(gs(n),"html",void 0),Si(gs(n),"renderings",void 0);var s=gt.M_MESSAGE.findIn(n.wireContent),o=gt.M_TEXT.findIn(n.wireContent),a=gt.M_HTML.findIn(n.wireContent);if((0,Xn.isProvided)(s)){if(!Array.isArray(s))throw new po.InvalidEventError("m.message contents must be an array");var c=s.find(function(u){return!(0,Xn.isProvided)(u.mimetype)||u.mimetype==="text/plain"}),l=s.find(function(u){return u.mimetype==="text/html"});if(!c)throw new po.InvalidEventError("m.message is missing a plain text representation");n.text=c.body,n.html=l==null?void 0:l.body,n.renderings=s}else if((0,Xn.isOptionalAString)(o))n.text=o,n.html=a,n.renderings=[{body:o,mimetype:"text/plain"}],n.html&&n.renderings.push({body:n.html,mimetype:"text/html"});else throw new po.InvalidEventError("Missing textual representation for event");return n}return Qf(t,[{key:"isEmote",get:function(){return gt.M_EMOTE.matches(this.wireFormat.type)||(0,Xn.isProvided)(gt.M_EMOTE.findIn(this.wireFormat.content))}},{key:"isNotice",get:function(){return gt.M_NOTICE.matches(this.wireFormat.type)||(0,Xn.isProvided)(gt.M_NOTICE.findIn(this.wireFormat.content))}},{key:"isEquivalentTo",value:function(n){return(0,zf.isEventTypeSame)(n,gt.M_MESSAGE)}},{key:"serializeMMessageOnly",value:function(){var n=Si({},gt.M_MESSAGE.name,this.renderings);if(this.renderings.length===1){var s=this.renderings[0].mimetype;(s===void 0||s==="text/plain")&&(n=Si({},gt.M_TEXT.name,this.renderings[0].body))}return n}},{key:"serialize",value:function(){var n;return{type:"m.room.message",content:Pc(Pc({},this.serializeMMessageOnly()),{},{body:this.text,msgtype:"m.text",format:this.html?"org.matrix.custom.html":void 0,formatted_body:(n=this.html)!==null&&n!==void 0?n:void 0})}}}],[{key:"from",value:function(n,s){var o;return new t({type:gt.M_MESSAGE.name,content:(o={},Si(o,gt.M_TEXT.name,n),Si(o,gt.M_HTML.name,s),o)})}}]),t}(Jf.ExtensibleEvent);zt.MessageEvent=ig;var Fn={};function Yo(r){"@babel/helpers - typeof";return Yo=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Yo(r)}Object.defineProperty(Fn,"__esModule",{value:!0});Fn.NoticeEvent=void 0;var ng=zt,Jr=De,rg=hi;function Uc(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}function sg(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function Lc(r,e){for(var t=0;t<e.length;t++){var i=e[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(r,i.key,i)}}function og(r,e,t){return e&&Lc(r.prototype,e),t&&Lc(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}function vr(){return typeof Reflect<"u"&&Reflect.get?vr=Reflect.get:vr=function(e,t,i){var n=ag(e,t);if(n){var s=Object.getOwnPropertyDescriptor(n,t);return s.get?s.get.call(arguments.length<3?e:i):s.value}},vr.apply(this,arguments)}function ag(r,e){for(;!Object.prototype.hasOwnProperty.call(r,e)&&(r=en(r),r!==null););return r}function cg(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),e&&Qo(r,e)}function Qo(r,e){return Qo=Object.setPrototypeOf||function(i,n){return i.__proto__=n,i},Qo(r,e)}function lg(r){var e=hg();return function(){var i=en(r),n;if(e){var s=en(this).constructor;n=Reflect.construct(i,arguments,s)}else n=i.apply(this,arguments);return dg(this,n)}}function dg(r,e){if(e&&(Yo(e)==="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return ug(r)}function ug(r){if(r===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return r}function hg(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function en(r){return en=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},en(r)}var fg=function(r){cg(t,r);var e=lg(t);function t(i){return sg(this,t),e.call(this,i)}return og(t,[{key:"isNotice",get:function(){return!0}},{key:"isEquivalentTo",value:function(n){return(0,rg.isEventTypeSame)(n,Jr.M_NOTICE)||vr(en(t.prototype),"isEquivalentTo",this).call(this,n)}},{key:"serialize",value:function(){var n=vr(en(t.prototype),"serialize",this).call(this);return n.content.msgtype="m.notice",n}}],[{key:"from",value:function(n,s){var o;return new t({type:Jr.M_NOTICE.name,content:(o={},Uc(o,Jr.M_TEXT.name,n),Uc(o,Jr.M_HTML.name,s),o)})}}]),t}(ng.MessageEvent);Fn.NoticeEvent=fg;var $n={};function Xo(r){"@babel/helpers - typeof";return Xo=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Xo(r)}Object.defineProperty($n,"__esModule",{value:!0});$n.EmoteEvent=void 0;var gg=zt,zr=De,pg=hi;function Nc(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}function mg(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function Kc(r,e){for(var t=0;t<e.length;t++){var i=e[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(r,i.key,i)}}function vg(r,e,t){return e&&Kc(r.prototype,e),t&&Kc(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}function yr(){return typeof Reflect<"u"&&Reflect.get?yr=Reflect.get:yr=function(e,t,i){var n=yg(e,t);if(n){var s=Object.getOwnPropertyDescriptor(n,t);return s.get?s.get.call(arguments.length<3?e:i):s.value}},yr.apply(this,arguments)}function yg(r,e){for(;!Object.prototype.hasOwnProperty.call(r,e)&&(r=tn(r),r!==null););return r}function Sg(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),e&&Zo(r,e)}function Zo(r,e){return Zo=Object.setPrototypeOf||function(i,n){return i.__proto__=n,i},Zo(r,e)}function Eg(r){var e=_g();return function(){var i=tn(r),n;if(e){var s=tn(this).constructor;n=Reflect.construct(i,arguments,s)}else n=i.apply(this,arguments);return bg(this,n)}}function bg(r,e){if(e&&(Xo(e)==="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return wg(r)}function wg(r){if(r===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return r}function _g(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function tn(r){return tn=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},tn(r)}var Ig=function(r){Sg(t,r);var e=Eg(t);function t(i){return mg(this,t),e.call(this,i)}return vg(t,[{key:"isEmote",get:function(){return!0}},{key:"isEquivalentTo",value:function(n){return(0,pg.isEventTypeSame)(n,zr.M_EMOTE)||yr(tn(t.prototype),"isEquivalentTo",this).call(this,n)}},{key:"serialize",value:function(){var n=yr(tn(t.prototype),"serialize",this).call(this);return n.content.msgtype="m.emote",n}}],[{key:"from",value:function(n,s){var o;return new t({type:zr.M_EMOTE.name,content:(o={},Nc(o,zr.M_TEXT.name,n),Nc(o,zr.M_HTML.name,s),o)})}}]),t}(gg.MessageEvent);$n.EmoteEvent=Ig;Object.defineProperty(Kn,"__esModule",{value:!0});Kn.LEGACY_M_ROOM_MESSAGE=void 0;Kn.parseMRoomMessage=Og;var Fc=zt,Rg=Fn,Tg=$n,Cg=Ft,vi=De;function $c(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(r);e&&(i=i.filter(function(n){return Object.getOwnPropertyDescriptor(r,n).enumerable})),t.push.apply(t,i)}return t}function wt(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?$c(Object(t),!0).forEach(function(i){Bi(r,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):$c(Object(t)).forEach(function(i){Object.defineProperty(r,i,Object.getOwnPropertyDescriptor(t,i))})}return r}function Bi(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}var kg=new Cg.NamespacedValue("m.room.message");Kn.LEGACY_M_ROOM_MESSAGE=kg;function Og(r){var e,t,i;if(vi.M_MESSAGE.findIn(r.content)||vi.M_TEXT.findIn(r.content))return new Fc.MessageEvent(r);var n=(e=r.content)===null||e===void 0?void 0:e.msgtype,s=(t=r.content)===null||t===void 0?void 0:t.body,o=((i=r.content)===null||i===void 0?void 0:i.format)==="org.matrix.custom.html"?r.content.formatted_body:null;if(n==="m.text"){var a;return new Fc.MessageEvent(wt(wt({},r),{},{content:wt(wt({},r.content),{},(a={},Bi(a,vi.M_TEXT.name,s),Bi(a,vi.M_HTML.name,o),a))}))}else if(n==="m.notice"){var c;return new Rg.NoticeEvent(wt(wt({},r),{},{content:wt(wt({},r.content),{},(c={},Bi(c,vi.M_TEXT.name,s),Bi(c,vi.M_HTML.name,o),c))}))}else if(n==="m.emote"){var l;return new Tg.EmoteEvent(wt(wt({},r),{},{content:wt(wt({},r.content),{},(l={},Bi(l,vi.M_TEXT.name,s),Bi(l,vi.M_HTML.name,o),l))}))}else return null}var Zs={};Object.defineProperty(Zs,"__esModule",{value:!0});Zs.parseMMessage=Dg;var Mg=zt,Bc=De,Ag=$n,Pg=Fn;function Dg(r){return Bc.M_EMOTE.matches(r.type)?new Ag.EmoteEvent(r):Bc.M_NOTICE.matches(r.type)?new Pg.NoticeEvent(r):new Mg.MessageEvent(r)}var Je={};Object.defineProperty(Je,"__esModule",{value:!0});Je.M_POLL_START=Je.M_POLL_RESPONSE=Je.M_POLL_KIND_UNDISCLOSED=Je.M_POLL_KIND_DISCLOSED=Je.M_POLL_END=void 0;var xr=Ft,Ug=new xr.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed");Je.M_POLL_KIND_DISCLOSED=Ug;var Lg=new xr.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed");Je.M_POLL_KIND_UNDISCLOSED=Lg;var Ng=new xr.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start");Je.M_POLL_START=Ng;var Kg=new xr.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response");Je.M_POLL_RESPONSE=Kg;var Fg=new xr.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end");Je.M_POLL_END=Fg;var eo={},nn={};function ea(r){"@babel/helpers - typeof";return ea=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ea(r)}Object.defineProperty(nn,"__esModule",{value:!0});nn.PollStartEvent=nn.PollAnswerSubevent=void 0;var Qt=Je,Vd=zt,fr=De,ps=ui,$g=Ft,Bg=hi,xg=Di;function qg(r){return Wg(r)||Gg(r)||jg(r)||Vg()}function Vg(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function jg(r,e){if(r){if(typeof r=="string")return ta(r,e);var t=Object.prototype.toString.call(r).slice(8,-1);if(t==="Object"&&r.constructor&&(t=r.constructor.name),t==="Map"||t==="Set")return Array.from(r);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return ta(r,e)}}function Gg(r){if(typeof Symbol<"u"&&r[Symbol.iterator]!=null||r["@@iterator"]!=null)return Array.from(r)}function Wg(r){if(Array.isArray(r))return ta(r)}function ta(r,e){(e==null||e>r.length)&&(e=r.length);for(var t=0,i=new Array(e);t<e;t++)i[t]=r[t];return i}function xc(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(r);e&&(i=i.filter(function(n){return Object.getOwnPropertyDescriptor(r,n).enumerable})),t.push.apply(t,i)}return t}function Hg(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?xc(Object(t),!0).forEach(function(i){ct(r,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):xc(Object(t)).forEach(function(i){Object.defineProperty(r,i,Object.getOwnPropertyDescriptor(t,i))})}return r}function jd(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function qc(r,e){for(var t=0;t<e.length;t++){var i=e[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(r,i.key,i)}}function Gd(r,e,t){return e&&qc(r.prototype,e),t&&qc(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}function Wd(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),e&&ia(r,e)}function ia(r,e){return ia=Object.setPrototypeOf||function(i,n){return i.__proto__=n,i},ia(r,e)}function Hd(r){var e=zg();return function(){var i=Os(r),n;if(e){var s=Os(this).constructor;n=Reflect.construct(i,arguments,s)}else n=i.apply(this,arguments);return Jg(this,n)}}function Jg(r,e){if(e&&(ea(e)==="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return ji(r)}function ji(r){if(r===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return r}function zg(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function Os(r){return Os=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},Os(r)}function ct(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}var Jd=function(r){Wd(t,r);var e=Hd(t);function t(i){var n;jd(this,t),n=e.call(this,i),ct(ji(n),"id",void 0);var s=i.content.id;if(!s||typeof s!="string")throw new ps.InvalidEventError("Answer ID must be a non-empty string");return n.id=s,n}return Gd(t,[{key:"serialize",value:function(){return{type:"org.matrix.sdk.poll.answer",content:Hg({id:this.id},this.serializeMMessageOnly())}}}],[{key:"from",value:function(n,s){return new t({type:"org.matrix.sdk.poll.answer",content:ct({id:n},fr.M_TEXT.name,s)})}}]),t}(Vd.MessageEvent);nn.PollAnswerSubevent=Jd;var Yg=function(r){Wd(t,r);var e=Hd(t);function t(i){var n;jd(this,t),n=e.call(this,i),ct(ji(n),"question",void 0),ct(ji(n),"kind",void 0),ct(ji(n),"rawKind",void 0),ct(ji(n),"maxSelections",void 0),ct(ji(n),"answers",void 0);var s=Qt.M_POLL_START.findIn(n.wireContent);if(!s.question)throw new ps.InvalidEventError("A question is required");if(n.question=new Vd.MessageEvent({type:"org.matrix.sdk.poll.question",content:s.question}),n.rawKind=s.kind,Qt.M_POLL_KIND_DISCLOSED.matches(n.rawKind)?n.kind=Qt.M_POLL_KIND_DISCLOSED:n.kind=Qt.M_POLL_KIND_UNDISCLOSED,n.maxSelections=Number.isFinite(s.max_selections)&&s.max_selections>0?s.max_selections:1,!Array.isArray(s.answers))throw new ps.InvalidEventError("Poll answers must be an array");var o=s.answers.slice(0,20).map(function(a){return new Jd({type:"org.matrix.sdk.poll.answer",content:a})});if(o.length<=0)throw new ps.InvalidEventError("No answers available");return n.answers=o,n}return Gd(t,[{key:"isEquivalentTo",value:function(n){return(0,Bg.isEventTypeSame)(n,Qt.M_POLL_START)}},{key:"serialize",value:function(){var n;return{type:Qt.M_POLL_START.name,content:(n={},ct(n,Qt.M_POLL_START.name,{question:this.question.serialize().content,kind:this.rawKind,max_selections:this.maxSelections,answers:this.answers.map(function(s){return s.serialize().content})}),ct(n,fr.M_TEXT.name,"".concat(this.question.text,`
`).concat(this.answers.map(function(s,o){return"".concat(o+1,". ").concat(s.text)}).join(`
`))),n)}}}],[{key:"from",value:function(n,s,o){var a,c=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1;return new t({type:Qt.M_POLL_START.name,content:(a={},ct(a,fr.M_TEXT.name,n),ct(a,Qt.M_POLL_START.name,{question:ct({},fr.M_TEXT.name,n),kind:o instanceof $g.NamespacedValue?o.name:o,max_selections:c,answers:s.map(function(l){return ct({id:Qg()},fr.M_TEXT.name,l)})}),a)})}}]),t}(xg.ExtensibleEvent);nn.PollStartEvent=Yg;var Vc="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";function Qg(){return qg(Array(16)).map(function(){return Vc.charAt(Math.floor(Math.random()*Vc.length))}).join("")}var qr={},Bn={};Object.defineProperty(Bn,"__esModule",{value:!0});Bn.REFERENCE_RELATION=void 0;var Xg=Ft,Zg=new Xg.NamespacedValue("m.reference");Bn.REFERENCE_RELATION=Zg;function na(r){"@babel/helpers - typeof";return na=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},na(r)}Object.defineProperty(qr,"__esModule",{value:!0});qr.PollResponseEvent=void 0;var ep=Di,un=Je,tp=ui,mo=Bn,ip=hi;function np(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function jc(r,e){for(var t=0;t<e.length;t++){var i=e[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(r,i.key,i)}}function rp(r,e,t){return e&&jc(r.prototype,e),t&&jc(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}function sp(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),e&&ra(r,e)}function ra(r,e){return ra=Object.setPrototypeOf||function(i,n){return i.__proto__=n,i},ra(r,e)}function op(r){var e=cp();return function(){var i=Ms(r),n;if(e){var s=Ms(this).constructor;n=Reflect.construct(i,arguments,s)}else n=i.apply(this,arguments);return ap(this,n)}}function ap(r,e){if(e&&(na(e)==="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return ms(r)}function ms(r){if(r===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return r}function cp(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function Ms(r){return Ms=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},Ms(r)}function Zn(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}var lp=function(r){sp(t,r);var e=op(t);function t(i){var n;np(this,t),n=e.call(this,i),Zn(ms(n),"internalAnswerIds",void 0),Zn(ms(n),"internalSpoiled",void 0),Zn(ms(n),"pollEventId",void 0);var s=n.wireContent["m.relates_to"];if(!mo.REFERENCE_RELATION.matches(s==null?void 0:s.rel_type)||typeof(s==null?void 0:s.event_id)!="string")throw new tp.InvalidEventError("Relationship must be a reference to an event");return n.pollEventId=s.event_id,n.validateAgainst(null),n}return rp(t,[{key:"answerIds",get:function(){return this.internalAnswerIds}},{key:"spoiled",get:function(){return this.internalSpoiled}},{key:"validateAgainst",value:function(n){var s=un.M_POLL_RESPONSE.findIn(this.wireContent);if(!Array.isArray(s==null?void 0:s.answers)){this.internalSpoiled=!0,this.internalAnswerIds=[];return}var o=s.answers;if(o.some(function(a){return typeof a!="string"})||o.length===0){this.internalSpoiled=!0,this.internalAnswerIds=[];return}if(n){if(o.some(function(a){return!n.answers.some(function(c){return c.id===a})})){this.internalSpoiled=!0,this.internalAnswerIds=[];return}o=o.slice(0,n.maxSelections)}this.internalAnswerIds=o,this.internalSpoiled=!1}},{key:"isEquivalentTo",value:function(n){return(0,ip.isEventTypeSame)(n,un.M_POLL_RESPONSE)}},{key:"serialize",value:function(){return{type:un.M_POLL_RESPONSE.name,content:Zn({"m.relates_to":{rel_type:mo.REFERENCE_RELATION.name,event_id:this.pollEventId}},un.M_POLL_RESPONSE.name,{answers:this.spoiled?void 0:this.answerIds})}}}],[{key:"from",value:function(n,s){return new t({type:un.M_POLL_RESPONSE.name,content:Zn({"m.relates_to":{rel_type:mo.REFERENCE_RELATION.name,event_id:s}},un.M_POLL_RESPONSE.name,{answers:n})})}}]),t}(ep.ExtensibleEvent);qr.PollResponseEvent=lp;var Vr={};function sa(r){"@babel/helpers - typeof";return sa=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},sa(r)}Object.defineProperty(Vr,"__esModule",{value:!0});Vr.PollEndEvent=void 0;var er=Je,dp=ui,vo=Bn,up=zt,hp=De,fp=hi,gp=Di;function Gc(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(r);e&&(i=i.filter(function(n){return Object.getOwnPropertyDescriptor(r,n).enumerable})),t.push.apply(t,i)}return t}function pp(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Gc(Object(t),!0).forEach(function(i){mn(r,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Gc(Object(t)).forEach(function(i){Object.defineProperty(r,i,Object.getOwnPropertyDescriptor(t,i))})}return r}function mp(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function Wc(r,e){for(var t=0;t<e.length;t++){var i=e[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(r,i.key,i)}}function vp(r,e,t){return e&&Wc(r.prototype,e),t&&Wc(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}function yp(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),e&&oa(r,e)}function oa(r,e){return oa=Object.setPrototypeOf||function(i,n){return i.__proto__=n,i},oa(r,e)}function Sp(r){var e=bp();return function(){var i=As(r),n;if(e){var s=As(this).constructor;n=Reflect.construct(i,arguments,s)}else n=i.apply(this,arguments);return Ep(this,n)}}function Ep(r,e){if(e&&(sa(e)==="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return aa(r)}function aa(r){if(r===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return r}function bp(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function As(r){return As=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},As(r)}function mn(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}var wp=function(r){yp(t,r);var e=Sp(t);function t(i){var n;mp(this,t),n=e.call(this,i),mn(aa(n),"pollEventId",void 0),mn(aa(n),"closingMessage",void 0);var s=n.wireContent["m.relates_to"];if(!vo.REFERENCE_RELATION.matches(s==null?void 0:s.rel_type)||typeof(s==null?void 0:s.event_id)!="string")throw new dp.InvalidEventError("Relationship must be a reference to an event");return n.pollEventId=s.event_id,n.closingMessage=new up.MessageEvent(n.wireFormat),n}return vp(t,[{key:"isEquivalentTo",value:function(n){return(0,fp.isEventTypeSame)(n,er.M_POLL_END)}},{key:"serialize",value:function(){return{type:er.M_POLL_END.name,content:pp(mn({"m.relates_to":{rel_type:vo.REFERENCE_RELATION.name,event_id:this.pollEventId}},er.M_POLL_END.name,{}),this.closingMessage.serialize().content)}}}],[{key:"from",value:function(n,s){var o;return new t({type:er.M_POLL_END.name,content:(o={"m.relates_to":{rel_type:vo.REFERENCE_RELATION.name,event_id:n}},mn(o,er.M_POLL_END.name,{}),mn(o,hp.M_TEXT.name,s),o)})}}]),t}(gp.ExtensibleEvent);Vr.PollEndEvent=wp;Object.defineProperty(eo,"__esModule",{value:!0});eo.parseMPoll=Tp;var yo=Je,_p=nn,Ip=qr,Rp=Vr;function Tp(r){return yo.M_POLL_START.matches(r.type)?new _p.PollStartEvent(r):yo.M_POLL_RESPONSE.matches(r.type)?new Ip.PollResponseEvent(r):yo.M_POLL_END.matches(r.type)?new Rp.PollEndEvent(r):null}Object.defineProperty(Xs,"__esModule",{value:!0});Xs.ExtensibleEvents=void 0;var Cp=Fr,kp=ui,Hc=Kn,So=Zs,Yr=De,Eo=Je,bo=eo;function Op(r,e){var t=typeof Symbol<"u"&&r[Symbol.iterator]||r["@@iterator"];if(!t){if(Array.isArray(r)||(t=Mp(r))||e&&r&&typeof r.length=="number"){t&&(r=t);var i=0,n=function(){};return{s:n,n:function(){return i>=r.length?{done:!0}:{done:!1,value:r[i++]}},e:function(l){throw l},f:n}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var s=!0,o=!1,a;return{s:function(){t=t.call(r)},n:function(){var l=t.next();return s=l.done,l},e:function(l){o=!0,a=l},f:function(){try{!s&&t.return!=null&&t.return()}finally{if(o)throw a}}}}function Mp(r,e){if(r){if(typeof r=="string")return Jc(r,e);var t=Object.prototype.toString.call(r).slice(8,-1);if(t==="Object"&&r.constructor&&(t=r.constructor.name),t==="Map"||t==="Set")return Array.from(r);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return Jc(r,e)}}function Jc(r,e){(e==null||e>r.length)&&(e=r.length);for(var t=0,i=new Array(e);t<e;t++)i[t]=r[t];return i}function Ap(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function zc(r,e){for(var t=0;t<e.length;t++){var i=e[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(r,i.key,i)}}function Pp(r,e,t){return e&&zc(r.prototype,e),t&&zc(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}function ca(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}var la=function(){function r(){Ap(this,r),ca(this,"interpreters",new Cp.NamespacedMap([[Hc.LEGACY_M_ROOM_MESSAGE,Hc.parseMRoomMessage],[Yr.M_MESSAGE,So.parseMMessage],[Yr.M_EMOTE,So.parseMMessage],[Yr.M_NOTICE,So.parseMMessage],[Eo.M_POLL_START,bo.parseMPoll],[Eo.M_POLL_RESPONSE,bo.parseMPoll],[Eo.M_POLL_END,bo.parseMPoll]])),ca(this,"_unknownInterpretOrder",[Yr.M_MESSAGE])}return Pp(r,[{key:"unknownInterpretOrder",get:function(){var t;return(t=this._unknownInterpretOrder)!==null&&t!==void 0?t:[]},set:function(t){this._unknownInterpretOrder=t}},{key:"registerInterpreter",value:function(t,i){this.interpreters.set(t,i)}},{key:"parse",value:function(t){try{if(this.interpreters.hasNamespaced(t.type))return this.interpreters.getNamespaced(t.type)(t);var i=Op(this.unknownInterpretOrder),n;try{for(i.s();!(n=i.n()).done;){var s=n.value;if(this.interpreters.has(s)){var o=this.interpreters.get(s)(t);if(o)return o}}}catch(a){i.e(a)}finally{i.f()}return null}catch(a){if(a instanceof kp.InvalidEventError)return null;throw a}}}],[{key:"defaultInstance",get:function(){return r._defaultInstance}},{key:"unknownInterpretOrder",get:function(){return r.defaultInstance.unknownInterpretOrder},set:function(t){r.defaultInstance.unknownInterpretOrder=t}},{key:"registerInterpreter",value:function(t,i){r.defaultInstance.registerInterpreter(t,i)}},{key:"parse",value:function(t){return r.defaultInstance.parse(t)}}]),r}();Xs.ExtensibleEvents=la;ca(la,"_defaultInstance",new la);var zd={};Object.defineProperty(zd,"__esModule",{value:!0});var xn={};Object.defineProperty(xn,"__esModule",{value:!0});xn.LegacyMsgType=void 0;xn.isEventLike=Dp;var wo=De,Tn;xn.LegacyMsgType=Tn;(function(r){r.Text="m.text",r.Notice="m.notice",r.Emote="m.emote"})(Tn||(xn.LegacyMsgType=Tn={}));function Dp(r,e){var t=r.content;return e===Tn.Text?wo.M_MESSAGE.matches(r.type)||r.type==="m.room.message"&&(t==null?void 0:t.msgtype)==="m.text":e===Tn.Emote?wo.M_EMOTE.matches(r.type)||r.type==="m.room.message"&&(t==null?void 0:t.msgtype)==="m.emote":e===Tn.Notice?wo.M_NOTICE.matches(r.type)||r.type==="m.room.message"&&(t==null?void 0:t.msgtype)==="m.notice":!1}(function(r){Object.defineProperty(r,"__esModule",{value:!0});var e=Xs;Object.keys(e).forEach(function(y){y==="default"||y==="__esModule"||y in r&&r[y]===e[y]||Object.defineProperty(r,y,{enumerable:!0,get:function(){return e[y]}})});var t=zd;Object.keys(t).forEach(function(y){y==="default"||y==="__esModule"||y in r&&r[y]===t[y]||Object.defineProperty(r,y,{enumerable:!0,get:function(){return t[y]}})});var i=ui;Object.keys(i).forEach(function(y){y==="default"||y==="__esModule"||y in r&&r[y]===i[y]||Object.defineProperty(r,y,{enumerable:!0,get:function(){return i[y]}})});var n=Ft;Object.keys(n).forEach(function(y){y==="default"||y==="__esModule"||y in r&&r[y]===n[y]||Object.defineProperty(r,y,{enumerable:!0,get:function(){return n[y]}})});var s=Fr;Object.keys(s).forEach(function(y){y==="default"||y==="__esModule"||y in r&&r[y]===s[y]||Object.defineProperty(r,y,{enumerable:!0,get:function(){return s[y]}})});var o=$r;Object.keys(o).forEach(function(y){y==="default"||y==="__esModule"||y in r&&r[y]===o[y]||Object.defineProperty(r,y,{enumerable:!0,get:function(){return o[y]}})});var a=xn;Object.keys(a).forEach(function(y){y==="default"||y==="__esModule"||y in r&&r[y]===a[y]||Object.defineProperty(r,y,{enumerable:!0,get:function(){return a[y]}})});var c=hi;Object.keys(c).forEach(function(y){y==="default"||y==="__esModule"||y in r&&r[y]===c[y]||Object.defineProperty(r,y,{enumerable:!0,get:function(){return c[y]}})});var l=Kn;Object.keys(l).forEach(function(y){y==="default"||y==="__esModule"||y in r&&r[y]===l[y]||Object.defineProperty(r,y,{enumerable:!0,get:function(){return l[y]}})});var u=Zs;Object.keys(u).forEach(function(y){y==="default"||y==="__esModule"||y in r&&r[y]===u[y]||Object.defineProperty(r,y,{enumerable:!0,get:function(){return u[y]}})});var h=eo;Object.keys(h).forEach(function(y){y==="default"||y==="__esModule"||y in r&&r[y]===h[y]||Object.defineProperty(r,y,{enumerable:!0,get:function(){return h[y]}})});var f=Bn;Object.keys(f).forEach(function(y){y==="default"||y==="__esModule"||y in r&&r[y]===f[y]||Object.defineProperty(r,y,{enumerable:!0,get:function(){return f[y]}})});var g=Di;Object.keys(g).forEach(function(y){y==="default"||y==="__esModule"||y in r&&r[y]===g[y]||Object.defineProperty(r,y,{enumerable:!0,get:function(){return g[y]}})});var m=De;Object.keys(m).forEach(function(y){y==="default"||y==="__esModule"||y in r&&r[y]===m[y]||Object.defineProperty(r,y,{enumerable:!0,get:function(){return m[y]}})});var v=zt;Object.keys(v).forEach(function(y){y==="default"||y==="__esModule"||y in r&&r[y]===v[y]||Object.defineProperty(r,y,{enumerable:!0,get:function(){return v[y]}})});var S=$n;Object.keys(S).forEach(function(y){y==="default"||y==="__esModule"||y in r&&r[y]===S[y]||Object.defineProperty(r,y,{enumerable:!0,get:function(){return S[y]}})});var w=Fn;Object.keys(w).forEach(function(y){y==="default"||y==="__esModule"||y in r&&r[y]===w[y]||Object.defineProperty(r,y,{enumerable:!0,get:function(){return w[y]}})});var M=Je;Object.keys(M).forEach(function(y){y==="default"||y==="__esModule"||y in r&&r[y]===M[y]||Object.defineProperty(r,y,{enumerable:!0,get:function(){return M[y]}})});var _=nn;Object.keys(_).forEach(function(y){y==="default"||y==="__esModule"||y in r&&r[y]===_[y]||Object.defineProperty(r,y,{enumerable:!0,get:function(){return _[y]}})});var C=qr;Object.keys(C).forEach(function(y){y==="default"||y==="__esModule"||y in r&&r[y]===C[y]||Object.defineProperty(r,y,{enumerable:!0,get:function(){return C[y]}})});var A=Vr;Object.keys(A).forEach(function(y){y==="default"||y==="__esModule"||y in r&&r[y]===A[y]||Object.defineProperty(r,y,{enumerable:!0,get:function(){return A[y]}})})})(ot);const Up="modulepreload",Lp=function(r,e){return new URL(r,e).href},Yc={},Np=function(e,t,i){let n=Promise.resolve();if(t&&t.length>0){const s=document.getElementsByTagName("link"),o=document.querySelector("meta[property=csp-nonce]"),a=(o==null?void 0:o.nonce)||(o==null?void 0:o.getAttribute("nonce"));n=Promise.all(t.map(c=>{if(c=Lp(c,i),c in Yc)return;Yc[c]=!0;const l=c.endsWith(".css"),u=l?'[rel="stylesheet"]':"";if(!!i)for(let g=s.length-1;g>=0;g--){const m=s[g];if(m.href===c&&(!l||m.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${c}"]${u}`))return;const f=document.createElement("link");if(f.rel=l?"stylesheet":Up,l||(f.as="script",f.crossOrigin=""),f.href=c,a&&f.setAttribute("nonce",a),document.head.appendChild(f),l)return new Promise((g,m)=>{f.addEventListener("load",g),f.addEventListener("error",()=>m(new Error(`Unable to preload CSS for ${c}`)))})}))}return n.then(()=>e()).catch(s=>{const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=s,window.dispatchEvent(o),!o.defaultPrevented)throw s})};var da=(r=>(r.DisplayName="User.displayName",r.AvatarUrl="User.avatarUrl",r.Presence="User.presence",r.CurrentlyActive="User.currentlyActive",r.LastPresenceTs="User.lastPresenceTs",r))(da||{});class ki extends ke{constructor(e){super(),this.userId=e,this.modified=-1,this.presence="offline",this.lastActiveAgo=0,this.lastPresenceTs=0,this.currentlyActive=!1,this.events={},this.displayName=e,this.rawDisplayName=e,this.updateModifiedTime()}static createUser(e,t){const i=new ki(e);return t.reEmitter.reEmit(i,["User.avatarUrl","User.displayName","User.presence","User.currentlyActive","User.lastPresenceTs"]),i}setPresenceEvent(e){if(e.getType()!=="m.presence")return;const t=this.events.presence===null;this.events.presence=e;const i=[];(e.getContent().presence!==this.presence||t)&&i.push("User.presence"),e.getContent().avatar_url&&e.getContent().avatar_url!==this.avatarUrl&&i.push("User.avatarUrl"),e.getContent().displayname&&e.getContent().displayname!==this.displayName&&i.push("User.displayName"),e.getContent().currently_active!==void 0&&e.getContent().currently_active!==this.currentlyActive&&i.push("User.currentlyActive"),this.presence=e.getContent().presence,i.push("User.lastPresenceTs"),e.getContent().status_msg&&(this.presenceStatusMsg=e.getContent().status_msg),e.getContent().displayname&&(this.displayName=e.getContent().displayname),e.getContent().avatar_url&&(this.avatarUrl=e.getContent().avatar_url),this.lastActiveAgo=e.getContent().last_active_ago,this.lastPresenceTs=Date.now(),this.currentlyActive=e.getContent().currently_active,this.updateModifiedTime();for(const n of i)this.emit(n,e,this)}setDisplayName(e){const t=this.displayName;this.displayName=e,e!==t&&this.updateModifiedTime()}setRawDisplayName(e){this.rawDisplayName=e}setAvatarUrl(e){const t=this.avatarUrl;this.avatarUrl=e,e!==t&&this.updateModifiedTime()}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getLastActiveTs(){return this.lastPresenceTs-this.lastActiveAgo}}var he=(r=>(r.Backward="b",r.Forward="f",r))(he||{});const Ye=class Ye{constructor(e){var t;this.eventTimelineSet=e,this.events=[],this.baseIndex=0,this.startToken=null,this.endToken=null,this.prevTimeline=null,this.nextTimeline=null,this.paginationRequests={b:null,f:null},this.roomId=((t=e.room)==null?void 0:t.roomId)??null,this.roomId&&(this.startState=new qs(this.roomId),this.endState=new qs(this.roomId)),this.paginationRequests={b:null,f:null},this.name=this.roomId+":"+new Date().toISOString()}static setEventMetadata(e,t,i){var n,s,o,a;(s=(n=e.sender)==null?void 0:n.events)!=null&&s.member||(e.sender=t.getSentinelMember(e.getSender())),!((a=(o=e.target)==null?void 0:o.events)!=null&&a.member)&&e.getType()===R.RoomMember&&(e.target=t.getSentinelMember(e.getStateKey())),e.isState()&&i&&(e.forwardLooking=!1)}initialiseState(e,{timelineWasEmpty:t}={}){var i,n;if(this.events.length>0)throw new Error("Cannot initialise state after events are added");(i=this.startState)==null||i.setStateEvents(e,{timelineWasEmpty:t}),(n=this.endState)==null||n.setStateEvents(e,{timelineWasEmpty:t})}forkLive(e){const t=this.getState(e),i=new Ye(this.eventTimelineSet);return i.startState=t==null?void 0:t.clone(),i.endState=t,this.endState=t==null?void 0:t.clone(),i}fork(e){const t=this.getState(e),i=new Ye(this.eventTimelineSet);return i.startState=t==null?void 0:t.clone(),i.endState=t==null?void 0:t.clone(),i}getRoomId(){return this.roomId}getFilter(){return this.eventTimelineSet.getFilter()}getTimelineSet(){return this.eventTimelineSet}getBaseIndex(){return this.baseIndex}getEvents(){return this.events}getState(e){if(e==Ye.BACKWARDS)return this.startState;if(e==Ye.FORWARDS)return this.endState;throw new Error("Invalid direction '"+e+"'")}getPaginationToken(e){return this.roomId?this.getState(e).paginationToken:e==="b"?this.startToken:this.endToken}setPaginationToken(e,t){this.roomId?this.getState(t).paginationToken=e:t==="b"?this.startToken=e:this.endToken=e}getNeighbouringTimeline(e){if(e==Ye.BACKWARDS)return this.prevTimeline;if(e==Ye.FORWARDS)return this.nextTimeline;throw new Error("Invalid direction '"+e+"'")}setNeighbouringTimeline(e,t){if(this.getNeighbouringTimeline(t))throw new Error("timeline already has a neighbouring timeline - cannot reset neighbour (direction: "+t+")");if(t==Ye.BACKWARDS)this.prevTimeline=e;else if(t==Ye.FORWARDS)this.nextTimeline=e;else throw new Error("Invalid direction '"+t+"'");this.setPaginationToken(null,t)}addEvent(e,t,i){let n=!!t,s;typeof t=="object"?{toStartOfTimeline:n,roomState:i,timelineWasEmpty:s}=t:t!==void 0&&d.warn("Overload deprecated: `EventTimeline.addEvent(event, toStartOfTimeline, roomState?)` is deprecated in favor of the overload with `EventTimeline.addEvent(event, IAddEventOptions)`"),i||(i=n?this.startState:this.endState);const o=this.getTimelineSet();o.room&&(Ye.setEventMetadata(e,i,n),e.isState()&&o.room.getUnfilteredTimelineSet()===o&&(i==null||i.setStateEvents([e],{timelineWasEmpty:s}),(!e.sender||e.getType()===R.RoomMember&&!n)&&Ye.setEventMetadata(e,i,n)));let a;n?a=0:a=this.events.length,this.events.splice(a,0,e),n&&this.baseIndex++}insertEvent(e,t,i){const n=this.getTimelineSet();n.room&&(Ye.setEventMetadata(e,i,!1),e.isState()&&n.room.getUnfilteredTimelineSet()===n&&(i.setStateEvents([e],{}),(!e.sender||e.getType()===R.RoomMember)&&Ye.setEventMetadata(e,i,!1))),this.events.splice(t,0,e)}removeEvent(e){for(let t=this.events.length-1;t>=0;t--){const i=this.events[t];if(i.getId()==e)return this.events.splice(t,1),t<this.baseIndex&&this.baseIndex--,i}return null}toString(){return this.name}};Ye.BACKWARDS="b",Ye.FORWARDS="f";let ee=Ye;const Kp=(r,e,t=[])=>[e,...t].includes(r);class Yd extends ke{constructor(e,t,i,n){super(),this.relationType=e,this.eventType=t,this.altEventTypes=n,this.relationEventIds=new Set,this.relations=new Set,this.annotationsByKey={},this.annotationsBySender={},this.sortedAnnotationsByKey=[],this.targetEvent=null,this.creationEmitted=!1,this.onEventStatus=(s,o)=>{if(!s.isSending()){s.removeListener(be.Status,this.onEventStatus);return}o===se.CANCELLED&&(s.removeListener(be.Status,this.onEventStatus),this.removeEvent(s))},this.onBeforeRedaction=async s=>{if(this.relations.has(s)){if(this.relations.delete(s),this.relationType===Te.Annotation)this.removeAnnotationFromAggregation(s);else if(this.relationType===Te.Replace&&this.targetEvent&&!this.targetEvent.isState()){const o=await this.getLastReplacement();this.targetEvent.makeReplaced(o)}s.removeListener(be.BeforeRedaction,this.onBeforeRedaction),this.emit("Relations.redaction",s)}},this.client=i instanceof Ga?i.client:i}async addEvent(e){if(this.relationEventIds.has(e.getId()))return;const t=e.getRelation();if(!t){d.error("Event must have relation info");return}const i=t.rel_type,n=e.getType();if(this.relationType!==i||!Kp(n,this.eventType,this.altEventTypes)){d.error("Event relation info doesn't match this container");return}if(e.isSending()&&e.on(be.Status,this.onEventStatus),this.relations.add(e),this.relationEventIds.add(e.getId()),this.relationType===Te.Annotation)this.addAnnotationToAggregation(e);else if(this.relationType===Te.Replace&&this.targetEvent&&!this.targetEvent.isState()){const s=await this.getLastReplacement();this.targetEvent.makeReplaced(s)}e.on(be.BeforeRedaction,this.onBeforeRedaction),this.emit("Relations.add",e),this.maybeEmitCreated()}async removeEvent(e){if(this.relations.has(e)){if(this.relations.delete(e),this.relationType===Te.Annotation)this.removeAnnotationFromAggregation(e);else if(this.relationType===Te.Replace&&this.targetEvent&&!this.targetEvent.isState()){const t=await this.getLastReplacement();this.targetEvent.makeReplaced(t)}this.emit("Relations.remove",e)}}getRelations(){return[...this.relations]}addAnnotationToAggregation(e){const{key:t}=e.getRelation()??{};if(!t)return;let i=this.annotationsByKey[t];i||(i=this.annotationsByKey[t]=new Set,this.sortedAnnotationsByKey.push([t,i])),i.add(e),this.sortedAnnotationsByKey.sort((o,a)=>{const c=o[1];return a[1].size-c.size});const n=e.getSender();let s=this.annotationsBySender[n];s||(s=this.annotationsBySender[n]=new Set),s.add(e)}removeAnnotationFromAggregation(e){const{key:t}=e.getRelation()??{};if(!t)return;const i=this.annotationsByKey[t];i&&(i.delete(e),this.sortedAnnotationsByKey.sort((o,a)=>{const c=o[1];return a[1].size-c.size}));const n=e.getSender(),s=this.annotationsBySender[n];s&&s.delete(e)}getSortedAnnotationsByKey(){return this.relationType!==Te.Annotation?null:this.sortedAnnotationsByKey}getAnnotationsBySender(){return this.relationType!==Te.Annotation?null:this.annotationsBySender}async getLastReplacement(){if(this.relationType!==Te.Replace||!this.targetEvent)return null;const e=this.targetEvent.getServerAggregatedRelation(Te.Replace),t=e==null?void 0:e.origin_server_ts,i=this.getRelations().reduce((n,s)=>s.getSender()!==this.targetEvent.getSender()||t&&t>s.getTs()||n&&n.getTs()>s.getTs()?n:s,null);return i!=null&&i.shouldAttemptDecryption()&&this.client.isCryptoEnabled()?await i.attemptDecryption(this.client.crypto):i!=null&&i.isBeingDecrypted()&&await i.getDecryptionPromise(),i}async setTargetEvent(e){if(!this.targetEvent){if(this.targetEvent=e,this.relationType===Te.Replace&&!this.targetEvent.isState()){const t=await this.getLastReplacement();t&&this.targetEvent.makeReplaced(t)}this.maybeEmitCreated()}}maybeEmitCreated(){this.creationEmitted||!this.targetEvent||!this.relations.size||(this.creationEmitted=!0,this.targetEvent.emit(be.RelationsCreated,this.relationType,this.eventType))}}class Qd{constructor(e,t){this.client=e,this.room=t,this.relations=new Map}getChildEventsForEvent(e,t,i){var n,s;return(s=(n=this.relations.get(e))==null?void 0:n.get(t))==null?void 0:s.get(i)}getAllChildEventsForEvent(e){const t=this.relations.get(e)??new Map,i=[];for(const n of t.values())for(const s of n.values())i.push(...s.getRelations());return i}aggregateParentEvent(e){const t=this.relations.get(e.getId());if(t)for(const i of t.values())for(const n of i.values())n.setTargetEvent(e)}aggregateChildEvent(e,t){if(e.isRedacted()||e.status===se.CANCELLED)return;const i=e.getRelation();if(!i)return;const n=()=>{if(e.isDecryptionFailure()){e.once(be.Decrypted,n);return}this.aggregateChildEvent(e,t)};if(e.isBeingDecrypted()||e.shouldAttemptDecryption()){e.once(be.Decrypted,n);return}const{event_id:s,rel_type:o}=i,a=e.getType();let c=this.relations.get(s);c||(c=new Map,this.relations.set(s,c));let l=c.get(o);l||(l=new Map,c.set(o,l));let u=l.get(a);if(!u){u=new Yd(o,a,this.client),l.set(a,u);const h=this.room??(t==null?void 0:t.room),f=(t==null?void 0:t.findEventById(s))??(h==null?void 0:h.findEventById(s))??(h==null?void 0:h.getPendingEvent(s));f&&u.setTargetEvent(f)}u.addEvent(e)}}let vn;vn=d.log.bind(d);var vs=(r=>(r.Ignore="ignore",r.Replace="replace",r))(vs||{});class gr extends ke{constructor(e,t={},i,n,s=null){var o;super(),this.room=e,this.thread=n,this.threadListType=s,this._eventIdToTimeline=new Map,this.timelineSupport=!!t.timelineSupport,this.liveTimeline=new ee(this),this.displayPendingEvents=t.pendingEvents!==!1,this.timelines=[this.liveTimeline],this._eventIdToTimeline=new Map,this.filter=t.filter,this.relations=((o=this.room)==null?void 0:o.relations)??new Qd((e==null?void 0:e.client)??i)}getTimelines(){return this.timelines}getFilter(){return this.filter}setFilter(e){this.filter=e}getPendingEvents(){return!this.room||!this.displayPendingEvents?[]:this.room.getPendingEvents()}getLiveTimeline(){return this.liveTimeline}setLiveTimeline(e){this.liveTimeline=e}eventIdToTimeline(e){return this._eventIdToTimeline.get(e)}replaceEventId(e,t){const i=this._eventIdToTimeline.get(e);i&&(this._eventIdToTimeline.delete(e),this._eventIdToTimeline.set(t,i))}resetLiveTimeline(e,t){const i=!this.timelineSupport||!t,n=this.liveTimeline,s=i?n.forkLive(ee.FORWARDS):n.fork(ee.FORWARDS);i?(this.timelines=[s],this._eventIdToTimeline=new Map):this.timelines.push(s),t&&n.setPaginationToken(t,ee.FORWARDS),s.setPaginationToken(e??null,ee.BACKWARDS),this.liveTimeline=s,this.emit(de.TimelineReset,this.room,this,i)}getTimelineForEvent(e){if(e==null)return null;const t=this._eventIdToTimeline.get(e);return t===void 0?null:t}findEventById(e){const t=this.getTimelineForEvent(e);if(t)return t.getEvents().find(function(i){return i.getId()==e})}addTimeline(){if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");const e=new ee(this);return this.timelines.push(e),e}addEventsToTimeline(e,t,i,n){if(!i)throw new Error("'timeline' not specified for EventTimelineSet.addEventsToTimeline");if(!t&&i==this.liveTimeline)throw new Error("EventTimelineSet.addEventsToTimeline cannot be used for adding events to the live timeline - use Room.addLiveEvents instead");if(this.filter&&(e=this.filter.filterRoomTimeline(e),!e.length))return;const s=t?ee.BACKWARDS:ee.FORWARDS,o=t?ee.FORWARDS:ee.BACKWARDS;let a=!1,c=!1;for(const l of e){const u=l.getId(),h=this._eventIdToTimeline.get(u);if(!h){this.addEventToTimeline(l,i,{toStartOfTimeline:t}),c=!0,a=!0;continue}if(c=!1,h==i){vn("Event "+u+" already in timeline "+i);continue}const f=i.getNeighbouringTimeline(s);if(f){h==f?vn("Event "+u+" in neighbouring timeline - switching to "+h):vn("Event "+u+" already in a different timeline "+h),i=h;continue}d.info("Already have timeline for "+u+" - joining timeline "+i+" to "+h);const g=h===this.liveTimeline,m=i===this.liveTimeline,v=s===ee.BACKWARDS&&g,S=s===ee.FORWARDS&&m;if(v||S){v&&d.warn("Refusing to set a preceding existingTimeLine on our timeline as the existingTimeLine is live ("+h+")"),S&&d.warn("Refusing to set our preceding timeline on a existingTimeLine as our timeline is live ("+i+")");continue}i.setNeighbouringTimeline(h,s),h.setNeighbouringTimeline(i,o),i=h,a=!0}if(c||!a){if(s===ee.FORWARDS&&i===this.liveTimeline){d.warn({lastEventWasNew:c,didUpdate:a}),d.warn(`Refusing to set forwards pagination token of live timeline ${i} to ${n}`);return}i.setPaginationToken(n??null,s)}}addLiveEvent(e,t,i=!1,n){let s=t||"ignore",o;if(typeof t=="object"?{duplicateStrategy:s="ignore",fromCache:i=!1,roomState:n,timelineWasEmpty:o}=t:t!==void 0&&d.warn("Overload deprecated: `EventTimelineSet.addLiveEvent(event, duplicateStrategy?, fromCache?, roomState?)` is deprecated in favor of the overload with `EventTimelineSet.addLiveEvent(event, IAddLiveEventOptions)`"),this.filter&&!this.filter.filterRoomTimeline([e]).length)return;const a=this._eventIdToTimeline.get(e.getId());if(a){if(s==="replace"){vn("EventTimelineSet.addLiveEvent: replacing duplicate event "+e.getId());const c=a.getEvents();for(let l=0;l<c.length;l++)if(c[l].getId()===e.getId()){n||(n=a.getState(ee.FORWARDS)),ee.setEventMetadata(e,n,!1),c[l]=e;break}}else vn("EventTimelineSet.addLiveEvent: ignoring duplicate event "+e.getId());return}this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1,fromCache:i,roomState:n,timelineWasEmpty:o})}addEventToTimeline(e,t,i,n=!1,s){var u,h;let o=!!i,a;if(typeof i=="object"?{toStartOfTimeline:o,fromCache:n=!1,roomState:s,timelineWasEmpty:a}=i:i!==void 0&&d.warn("Overload deprecated: `EventTimelineSet.addEventToTimeline(event, timeline, toStartOfTimeline, fromCache?, roomState?)` is deprecated in favor of the overload with `EventTimelineSet.addEventToTimeline(event, timeline, IAddEventToTimelineOptions)`"),t.getTimelineSet()!==this)throw new Error(`EventTimelineSet.addEventToTimeline: Timeline=${t.toString()} does not belong " +
                "in timelineSet(threadId=${(u=this.thread)==null?void 0:u.id})`);const c=e.getId();if(this.relations.aggregateParentEvent(e),this.relations.aggregateChildEvent(e,this),this.room&&!this.canContain(e)){let f=`event=${c}`;e.threadRootId&&(f+=`(belongs to thread=${e.threadRootId})`),d.warn(`EventTimelineSet.addEventToTimeline: Ignoring ${f} that does not belong in timeline=${t.toString()} timelineSet(threadId=${(h=this.thread)==null?void 0:h.id})`);return}t.addEvent(e,{toStartOfTimeline:o,roomState:s,timelineWasEmpty:a}),this._eventIdToTimeline.set(c,t);const l={timeline:t,liveEvent:!o&&t==this.liveTimeline&&!n};this.emit(de.Timeline,e,this.room,!!o,!1,l)}insertEventIntoTimeline(e,t,i){var h,f;if(t.getTimelineSet()!==this)throw new Error(`EventTimelineSet.insertEventIntoTimeline: Timeline=${t.toString()} does not belong " +
                "in timelineSet(threadId=${(h=this.thread)==null?void 0:h.id})`);const n=e.getId();if(this.relations.aggregateParentEvent(e),this.relations.aggregateChildEvent(e,this),this.room&&!this.canContain(e)){let g=`event=${n}`;e.threadRootId&&(g+=`(belongs to thread=${e.threadRootId})`),d.warn(`EventTimelineSet.insertEventIntoTimeline: Ignoring ${g} that does not belong in timeline=${t.toString()} timelineSet(threadId=${(f=this.thread)==null?void 0:f.id})`);return}const s=e.relationEventId;if(!s){this.addEventToTimeline(e,t,{toStartOfTimeline:!1,fromCache:!1,timelineWasEmpty:!1,roomState:i});return}const o=this.findEventById(s),a=t.getEvents();let l=o!==void 0?a.indexOf(o):0;for(;l<a.length&&!(a[l].getTs()>e.getTs());l++);t.insertEvent(e,l,i),this._eventIdToTimeline.set(n,t);const u={timeline:t,liveEvent:!1};this.emit(de.Timeline,e,this.room,!1,!1,u)}handleRemoteEcho(e,t,i){const n=this._eventIdToTimeline.get(t);n?(this._eventIdToTimeline.delete(t),this._eventIdToTimeline.set(i,n)):(!this.filter||this.filter.filterRoomTimeline([e]).length)&&this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1})}removeEvent(e){const t=this._eventIdToTimeline.get(e);if(!t)return null;const i=t.removeEvent(e);if(i){this._eventIdToTimeline.delete(e);const n={timeline:t};this.emit(de.Timeline,i,this.room,void 0,!0,n)}return i}compareEventOrdering(e,t){if(e==t)return 0;const i=this._eventIdToTimeline.get(e),n=this._eventIdToTimeline.get(t);if(i===void 0||n===void 0)return null;if(i===n){let o,a;const c=i.getEvents();for(let u=0;u<c.length&&(o===void 0||a===void 0);u++){const h=c[u].getId();h==e&&(o=u),h==t&&(a=u)}const l=o-a;return l<0?-1:l>0?1:0}let s=i;for(;s;){if(s===n)return-1;s=s.getNeighbouringTimeline(ee.FORWARDS)}for(s=i;s;){if(s===n)return 1;s=s.getNeighbouringTimeline(ee.BACKWARDS)}return null}canContain(e){var s;if(!this.room)throw new Error("Cannot call `EventTimelineSet::canContain without a `room` set. Set the room when creating the EventTimelineSet to call this method.");const{threadId:t,shouldLiveInRoom:i,shouldLiveInThread:n}=this.room.eventShouldLiveIn(e);return this.thread?this.thread.id===t:(!i&&!n&&d.warn(`EventTimelineSet:canContain event encountered which cannot be added to any timeline roomId=${(s=this.room)==null?void 0:s.roomId} eventId=${e.getId()} threadId=${e.threadRootId}`),i)}}var se=(r=>(r.NOT_SENT="not_sent",r.ENCRYPTING="encrypting",r.SENDING="sending",r.QUEUED="queued",r.SENT="sent",r.CANCELLED="cancelled",r))(se||{});class Fp{constructor(e,t){this.roomId=e}}class Xd{constructor(e){this.target=e,this.reEmitters=new WeakMap}reEmit(e,t){let i=this.reEmitters.get(e);i||(i=new Map,this.reEmitters.set(e,i));for(const n of t){if(i.has(n))continue;const s=(...o)=>{n==="error"&&this.target.listenerCount("error")===0||this.target.emit(n,...o,e)};e.on(n,s),i.set(n,s)}}stopReEmitting(e,t){const i=this.reEmitters.get(e);if(i){for(const n of t)e.off(n,i.get(n)),i.delete(n);i.size===0&&this.reEmitters.delete(e)}}}class qn extends Xd{constructor(e){super(e)}reEmit(e,t){super.reEmit(e,t)}stopReEmitting(e,t){super.stopReEmitting(e,t)}}const ua=new Js("unread_thread_notifications","org.matrix.msc3773.unread_thread_notifications");function $p(r,e){if(e.endsWith("*")){const t=e.slice(0,-1);return r.slice(0,t.length)===t}else return r===e}class Qc{constructor(e,t){this.filterJson=e,this.userId=t}check(e){var s,o;const t=((s=e.getUnsigned())==null?void 0:s["m.relations"])||{},i=Object.keys(t),n=[];return this.userId&&((o=t==null?void 0:t[_e.name])!=null&&o.current_user_participated)&&n.push(this.userId),this.checkFields(e.getRoomId(),e.getSender(),e.getType(),e.getContent()?e.getContent().url!==void 0:!1,i,n)}toJSON(){return{types:this.filterJson.types||null,not_types:this.filterJson.not_types||[],rooms:this.filterJson.rooms||null,not_rooms:this.filterJson.not_rooms||[],senders:this.filterJson.senders||null,not_senders:this.filterJson.not_senders||[],contains_url:this.filterJson.contains_url||null,[br.name]:this.filterJson[br.name]||[],[wr.name]:this.filterJson[wr.name]||[]}}checkFields(e,t,i,n,s,o){const a={rooms:function(h){return e===h},senders:function(h){return t===h},types:function(h){return $p(i,h)}};for(const h in a){const f=a[h],g="not_"+h,m=this.filterJson[g];if(m!=null&&m.some(f))return!1;const v=this.filterJson[h];if(v&&!v.some(f))return!1}const c=this.filterJson.contains_url;if(c!==void 0&&c!==n)return!1;const l=this.filterJson[wr.name];if(l!==void 0&&!this.arrayMatchesFilter(l,s))return!1;const u=this.filterJson[br.name];return!(u!==void 0&&!this.arrayMatchesFilter(u,o))}arrayMatchesFilter(e,t){return t.length>0&&e.every(i=>t.includes(i))}filter(e){return e.filter(this.check,this)}limit(){return this.filterJson.limit!==void 0?this.filterJson.limit:10}}function _o(r,e,t){const i=e.split(".");let n=r;for(let s=0;s<i.length-1;s++)n[i[s]]||(n[i[s]]={}),n=n[i[s]];n[i[i.length-1]]=t}const js=class js{constructor(e,t){this.userId=e,this.filterId=t,this.definition={}}static fromJson(e,t,i){const n=new js(e,t);return n.setDefinition(i),n}getFilterId(){return this.filterId}getDefinition(){return this.definition}setDefinition(e){this.definition=e;const t=e.room,i={};t&&(t.rooms&&(i.rooms=t.rooms),t.rooms&&(i.not_rooms=t.not_rooms)),this.roomFilter=new Qc(i,this.userId),this.roomTimelineFilter=new Qc((t==null?void 0:t.timeline)||{},this.userId)}getRoomTimelineFilterComponent(){return this.roomTimelineFilter}filterRoomTimeline(e){return this.roomFilter&&(e=this.roomFilter.filter(e)),this.roomTimelineFilter&&(e=this.roomTimelineFilter.filter(e)),e}setTimelineLimit(e){_o(this.definition,"room.timeline.limit",e)}setUnreadThreadNotifications(e){var t,i,n;this.definition={...this.definition,room:{...(t=this.definition)==null?void 0:t.room,timeline:{...(n=(i=this.definition)==null?void 0:i.room)==null?void 0:n.timeline,[ua.name]:e}}}}setLazyLoadMembers(e){_o(this.definition,"room.state.lazy_load_members",e)}setIncludeLeaveRooms(e){_o(this.definition,"room.include_leave",e)}};js.LAZY_LOADING_MESSAGES_FILTER={lazy_load_members:!0};let It=js;function Bp(r){return r!=null}new ot.UnstableValue("m.message","org.matrix.msc1767.message");new ot.UnstableValue("m.text","org.matrix.msc1767.text");new ot.UnstableValue("m.html","org.matrix.msc1767.html");new ot.NamespacedValue("m.reference");const xp=new Ce("m.topic","org.matrix.msc3765.topic");function qp(r,e){return{msgtype:Jt.Text,format:"org.matrix.custom.html",body:r,formatted_body:e}}function Vp(r,e){return{msgtype:Jt.Notice,format:"org.matrix.custom.html",body:r,formatted_body:e}}function jp(r,e){return{msgtype:Jt.Emote,format:"org.matrix.custom.html",body:r,formatted_body:e}}function Gp(r){return{msgtype:Jt.Text,body:r}}function Wp(r){return{msgtype:Jt.Notice,body:r}}function Hp(r){return{msgtype:Jt.Emote,body:r}}const Jp=(r,e)=>{const t=[{body:r,mimetype:"text/plain"}];return Bp(e)&&t.push({body:e,mimetype:"text/html"}),{topic:r,[xp.name]:t}},zp=r=>{const{description:e,timeout:t,live:i}=r,n=Ba.findIn(r)??void 0,s=Jh.findIn(r);return{description:e,timeout:t,live:i,assetType:s==null?void 0:s.type,timestamp:n}},Xc=r=>{const e=zh.findIn(r),t=Ba.findIn(r)??void 0;return{description:e==null?void 0:e.description,uri:e==null?void 0:e.uri,timestamp:t}};var Ke=(r=>(r.New="Beacon.new",r.Update="Beacon.update",r.LivenessChange="Beacon.LivenessChange",r.Destroy="Beacon.Destroy",r.LocationUpdate="Beacon.LocationUpdate",r))(Ke||{});const Zc=(r,e,t)=>t>=r&&r+e>=t,ha=r=>`${r.getRoomId()}_${r.getStateKey()}`;class Yp extends ke{constructor(e){super(),this.rootEvent=e,this.clearLatestLocation=()=>{this._latestLocationEvent=void 0,this.emit("Beacon.LocationUpdate",this.latestLocationState)},this.roomId=this.rootEvent.getRoomId(),this.setBeaconInfo(this.rootEvent)}get isLive(){return!!this._isLive}get identifier(){return ha(this.rootEvent)}get beaconInfoId(){return this.rootEvent.getId()}get beaconInfoOwner(){return this.rootEvent.getStateKey()}get beaconInfoEventType(){return this.rootEvent.getType()}get beaconInfo(){return this._beaconInfo}get latestLocationState(){return this._latestLocationEvent&&Xc(this._latestLocationEvent.getContent())}get latestLocationEvent(){return this._latestLocationEvent}update(e){if(ha(e)!==this.identifier)throw new Error("Invalid updating event");e.getTs()<this.rootEvent.getTs()||(this.rootEvent=e,this.setBeaconInfo(this.rootEvent),this.emit("Beacon.update",e,this),this.clearLatestLocation())}destroy(){this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this._isLive=!1,this.emit("Beacon.Destroy",this.identifier)}monitorLiveness(){if(this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this.checkLiveness(),!!this.beaconInfo)if(this.isLive){const e=this.beaconInfo.timestamp+this.beaconInfo.timeout-Date.now();e>1&&(this.livenessWatchTimeout=setTimeout(()=>{this.monitorLiveness()},e))}else this.beaconInfo.timestamp>Date.now()&&(this.livenessWatchTimeout=setTimeout(()=>{this.monitorLiveness()},this.beaconInfo.timestamp-Date.now()))}addLocations(e){var n;if(!this.isLive)return;const i=(n=e.filter(s=>{const o=s.getContent(),a=Xc(o);if(!a.uri||!a.timestamp)return!1;const{timestamp:c}=a;return this._beaconInfo.timestamp&&Zc(this._beaconInfo.timestamp,this._beaconInfo.timeout,c)&&(!this.latestLocationState||c>this.latestLocationState.timestamp)}).sort(of))==null?void 0:n[0];i&&(this._latestLocationEvent=i,this.emit("Beacon.LocationUpdate",this.latestLocationState))}setBeaconInfo(e){this._beaconInfo=zp(e.getContent()),this.checkLiveness()}checkLiveness(){const e=this.isLive;if(!this.beaconInfo)return;const t=this.beaconInfo.timestamp>Date.now()?this.beaconInfo.timestamp-36e4:this.beaconInfo.timestamp;this._isLive=!!this._beaconInfo.live&&!!t&&Zc(t,this._beaconInfo.timeout,Date.now()),e!==this.isLive&&this.emit("Beacon.LivenessChange",this.isLive,this)}}function Zd(r,e,t,i=!1){return new it({content:{[e.getId()]:{[t]:{[r]:{ts:e.getTs(),...!i&&{thread_id:Dr(e)}}}}},type:R.Receipt,room_id:e.getRoomId()})}const hn=0,fn=1;class eu extends ke{constructor(){super(...arguments),this.receipts=new $e(()=>new Map),this.receiptCacheByEventId=new Map}getReadReceiptForUserId(e,t=!1,i=nt.Read){var o;const[n,s]=((o=this.receipts.get(i))==null?void 0:o.get(e))??[null,null];return t?n:s??n}compareReceipts(e,t){return this.getUnfilteredTimelineSet().compareEventOrdering(e.eventId,t.eventId)??e.data.ts-t.data.ts}getEventReadUpTo(e,t=!1){const i=this.getLatestReceipt(e,t);return i&&this.receiptPointsAtConsistentEvent(i)?i.eventId:null}receiptPointsAtConsistentEvent(e){var i;const t=this.findEventById(e.eventId);if(!t)return!1;if(!((i=e.data)!=null&&i.thread_id))return!0;if(e.data.thread_id===Ys){if(xs(t))return!0}else if(t.threadRootId===e.data.thread_id)return!0;return d.warn(`Ignoring receipt because its thread_id (${e.data.thread_id}) disagrees with the thread root (${t.threadRootId}) of the referenced event (event ID = ${e.eventId})`),!1}getLatestReceipt(e,t){const i=this.getReadReceiptForUserId(e,t,nt.Read),n=this.getReadReceiptForUserId(e,t,nt.ReadPrivate);let s;return i!=null&&i.eventId&&(n!=null&&n.eventId)&&(s=this.compareReceipts(i,n)),s?(s<0?n:i)??null:n??i??null}addReceiptToStructure(e,t,i,n,s){const o=this.receipts.getOrCreate(t);let a=o.get(i);a||(a=[null,null],o.set(i,a));let c=a[hn];s&&(c=a[fn]??a[hn]);const l={eventId:e,data:n};if(c&&this.compareReceipts(c,l)>=0)return;const u=s?a[hn]:l,h=s?l:a[fn];let f=null;u&&h&&(f=this.getUnfilteredTimelineSet().compareEventOrdering(u.eventId,h.eventId));const g=f===null||f<0,m=a[fn]??a[hn];s&&g?a[fn]=l:s||(a[hn]=l,g||(a[fn]=null));const v=a[fn]??a[hn];if(m!==v){if(m&&this.receiptCacheByEventId.get(m.eventId)){const S=m.eventId;this.receiptCacheByEventId.set(S,this.receiptCacheByEventId.get(S).filter(w=>w.type!==t||w.userId!==i)),this.receiptCacheByEventId.get(S).length<1&&this.receiptCacheByEventId.delete(S)}this.receiptCacheByEventId.get(e)||this.receiptCacheByEventId.set(e,[]),this.receiptCacheByEventId.get(e).push({userId:i,type:t,data:n})}}getReceiptsForEvent(e){return this.receiptCacheByEventId.get(e.getId())||[]}fixupNotifications(e){const t=this.getReadReceiptForUserId(e,!1),i=this.timeline[this.timeline.length-1];i&&(t==null?void 0:t.eventId)===i.getId()&&e===i.getSender()&&(this.setUnread(Be.Total,0),this.setUnread(Be.Highlight,0))}addLocalEchoReceipt(e,t,i,n=!1){this.addReceipt(Zd(e,t,i,n),!0)}getUsersReadUpTo(e){return this.getReceiptsForEvent(e).filter(function(t){return Cd(t.type)}).map(function(t){return t.userId})}}new ot.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed");new ot.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed");new ot.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start");const Ps=new ot.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response"),fa=new ot.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end");var tu=(r=>(r.New="Poll.new",r.End="Poll.end",r.Update="Poll.update",r.Responses="Poll.Responses",r.Destroy="Poll.Destroy",r.UndecryptableRelations="Poll.UndecryptableRelations",r))(tu||{});const el=(r,e)=>({responseEvents:r.filter(i=>{if(!i.isDecryptionFailure())return Ps.matches(i.getType())&&i.getTs()<=e})});class Qp extends ke{constructor(e,t,i){if(super(),this.rootEvent=e,this.matrixClient=t,this.room=i,this._isFetchingResponses=!1,this.responses=null,this.undecryptableRelationEventIds=new Set,this.countUndecryptableEvents=n=>{const s=n.filter(a=>a.isDecryptionFailure()).map(a=>a.getId()),o=this.undecryptableRelationsCount;this.undecryptableRelationEventIds=new Set([...this.undecryptableRelationEventIds,...s]),this.undecryptableRelationsCount!==o&&this.emit("Poll.UndecryptableRelations",this.undecryptableRelationsCount)},!this.rootEvent.getRoomId()||!this.rootEvent.getId())throw new Error("Invalid poll start event.");this.roomId=this.rootEvent.getRoomId(),this.pollEvent=this.rootEvent.unstableExtensibleEvent}get pollId(){return this.rootEvent.getId()}get endEventId(){var e;return(e=this.endEvent)==null?void 0:e.getId()}get isEnded(){return!!this.endEvent}get isFetchingResponses(){return this._isFetchingResponses}get undecryptableRelationsCount(){return this.undecryptableRelationEventIds.size}async getResponses(){return this.responses?this.responses:(this.isFetchingResponses||await this.fetchResponses(),this.responses)}onNewRelation(e){var n;if(fa.matches(e.getType())&&this.validateEndEvent(e)&&(this.endEvent=e,this.refilterResponsesOnEnd(),this.emit("Poll.end")),!this.responses)return;const t=((n=this.endEvent)==null?void 0:n.getTs())||Number.MAX_SAFE_INTEGER,{responseEvents:i}=el([e],t);this.countUndecryptableEvents([e]),i.length&&(i.forEach(s=>{this.responses.addEvent(s)}),this.emit("Poll.Responses",this.responses))}async fetchResponses(){var o;this._isFetchingResponses=!0;const e=await this.matrixClient.relations(this.roomId,this.rootEvent.getId(),"m.reference",void 0,{from:this.relationsNextBatch||void 0});await Promise.all(e.events.map(a=>this.matrixClient.decryptEventIfNeeded(a)));const t=this.responses||new Yd("m.reference",Ps.name,this.matrixClient,[Ps.altName]),i=e.events.find(a=>fa.matches(a.getType()));this.validateEndEvent(i)&&(this.endEvent=i,this.refilterResponsesOnEnd(),this.emit("Poll.end"));const n=((o=this.endEvent)==null?void 0:o.getTs())||Number.MAX_SAFE_INTEGER,{responseEvents:s}=el(e.events,n);s.forEach(a=>{t.addEvent(a)}),this.relationsNextBatch=e.nextBatch??void 0,this.responses=t,this.countUndecryptableEvents(e.events),this.relationsNextBatch?this.fetchResponses():this._isFetchingResponses=!1,this.emit("Poll.Responses",this.responses)}refilterResponsesOnEnd(){var t;if(!this.responses)return;const e=((t=this.endEvent)==null?void 0:t.getTs())||Number.MAX_SAFE_INTEGER;this.responses.getRelations().forEach(i=>{var n;i.getTs()>e&&((n=this.responses)==null||n.removeEvent(i))}),this.emit("Poll.Responses",this.responses)}validateEndEvent(e){if(!e||this.endEvent&&this.endEvent.getTs()<e.getTs())return!1;const t=this.room.currentState,i=e.getSender();return!!i&&(i===this.rootEvent.getSender()||t.maySendRedactionForEvent(this.rootEvent,i))}}const Xp=r=>{const e=r.getType();return ot.M_POLL_START.matches(e)||Ps.matches(e)||fa.matches(e)};class Zp{constructor(e){this.onTimelineEvent=t=>{const i=t.getId();if(!i)return;const n=this.danglingReceipts.remove(i);n==null||n.forEach(s=>{s.receipt.thread_id?this.threadedReceipts.set(s.receipt.thread_id,s.eventId,s.receiptType,s.userId,s.receipt.ts,s.synthetic):this.unthreadedReceipts.set(i,s.receiptType,s.userId,s.receipt.ts,s.synthetic)})},this.room=e,this.threadedReceipts=new nm(e),this.unthreadedReceipts=new iu(e),this.danglingReceipts=new rm,e.on(de.Timeline,this.onTimelineEvent)}add(e,t){for(const[i,n]of Object.entries(e))for(const[s,o]of Object.entries(n))for(const[a,c]of Object.entries(o))this.room.findEventById(i)?c.thread_id?this.threadedReceipts.set(c.thread_id,i,s,a,c.ts,t):this.unthreadedReceipts.set(i,s,a,c.ts,t):this.danglingReceipts.add(new tm(i,s,a,c,t))}hasUserReadEvent(e,t){const i=this.unthreadedReceipts.get(e);if(i&&ga(i.eventId,t,this.room))return!0;const n=this.room.findEventById(t);if(!n)return d.warn(`hasUserReadEvent event ID ${t} not found in room ${this.room.roomId}: this shouldn't happen!`),!1;const s=Dr(n),o=this.threadedReceipts.get(s,e);return!!(o&&ga(o.eventId,t,this.room)||this.userSentLatestEventInThread(s,e))}userSentLatestEventInThread(e,t){var n;const i=e===Ys?this.room.getLiveTimeline().getEvents():(n=this.room.getThread(e))==null?void 0:n.timeline;return!!(i&&i.length>0&&i[i.length-1].getSender()===t)}}class em{constructor(e,t,i){this.eventId=e,this.receiptType=t,this.ts=i}}class tm{constructor(e,t,i,n,s){this.eventId=e,this.receiptType=t,this.userId=i,this.receipt=n,this.synthetic=s}}class im{constructor(e){this.room=e,this.real=void 0,this.synthetic=void 0}set(e,t){e?this.synthetic=t:this.real=t,this.synthetic&&this.real&&ga(this.real.eventId,this.synthetic.eventId,this.room)&&(this.synthetic=void 0)}get(){return this.synthetic??this.real}getByType(e){return e?this.synthetic:this.real}}class iu{constructor(e){this.room=e,this.data=new Map}set(e,t,i,n,s){const o=ja(this.data,i,()=>new im(this.room)),a=o.getByType(s);a&&sm(a.eventId,e,this.room)||o.set(s,new em(e,t,n))}get(e){var t;return(t=this.data.get(e))==null?void 0:t.get()}}class nm{constructor(e){this.room=e,this.data=new Map}set(e,t,i,n,s,o){ja(this.data,e,()=>new iu(this.room)).set(t,i,n,s,o)}get(e,t){var i;return(i=this.data.get(e))==null?void 0:i.get(t)}}class rm{constructor(){this.data=new Map}add(e){ja(this.data,e.eventId,()=>[]).push(e)}remove(e){const t=this.data.get(e);return this.data.delete(e),t}}function ja(r,e,t){const i=r.get(e);if(i)return i;{const n=t();return r.set(e,n),n}}function ga(r,e,t){const i=t.compareEventOrdering(r,e);return i!==null&&i>=0}function sm(r,e,t){const i=t.compareEventOrdering(r,e);return i!==null&&i>0}function om(r,e,t){const i=r.findEventById(e),n=r.findEventById(t);if(!i||!n)return null;const s=xs(i),o=xs(n);return s&&o?am(r,e,t,i,n):cm(e,t,i,n)}function am(r,e,t,i,n){const s=r.getUnfilteredTimelineSet(),o=s.compareEventOrdering(e,t);return o!==null?o:s.getTimelineForEvent(e)===s.getLiveTimeline()?1:s.getTimelineForEvent(t)===s.getLiveTimeline()?-1:nu(i,n)}function cm(r,e,t,i){const n=Dr(t),s=Dr(i),o=t.getThread();return o&&n===s?o.timelineSet.compareEventOrdering(r,e):nu(t,i)}function nu(r,e){const t=r.getTs(),i=e.getTs();return t<i?-1:t>i?1:0}const tl="10",il=["1","2","3","4","5","6","7","8","9","10"],lm=30;var Be=(r=>(r.Highlight="highlight",r.Total="total",r))(Be||{}),de=(r=>(r.MyMembership="Room.myMembership",r.Tags="Room.tags",r.AccountData="Room.accountData",r.Receipt="Room.receipt",r.Name="Room.name",r.Redaction="Room.redaction",r.RedactionCancelled="Room.redactionCancelled",r.LocalEchoUpdated="Room.localEchoUpdated",r.Timeline="Room.timeline",r.TimelineReset="Room.timelineReset",r.TimelineRefresh="Room.TimelineRefresh",r.OldStateUpdated="Room.OldStateUpdated",r.CurrentStateUpdated="Room.CurrentStateUpdated",r.HistoryImportedWithinTimeline="Room.historyImportedWithinTimeline",r.UnreadNotifications="Room.UnreadNotifications",r.Summary="Room.Summary",r))(de||{});class Ga extends eu{constructor(e,t,i,n={}){super(),this.roomId=e,this.client=t,this.myUserId=i,this.opts=n,this.txnToEvent=new Map,this.notificationCounts={},this.threadNotifications=new Map,this.cachedThreadReadReceipts=new Map,this.oldestThreadedReceiptTs=1/0,this.unthreadedReceipts=new Map,this.polls=new Map,this.threadsTimelineSets=[],this.filteredTimelineSets={},this.timelineNeedsRefresh=!1,this.summaryHeroes=null,this.getTypeWarning=!1,this.getVersionWarning=!1,this.tags={},this.accountData=new Map,this.summary=null,this.relations=new Qd(this.client,this),this.threads=new Map,this.visibilityEvents=new Map,this.roomReceipts=new Zp(this),this.threadTimelineSetsPromise=null,this.threadsReady=!1,this.updateThreadRootEvents=(s,o,a)=>{var c,l;s.length&&(this.updateThreadRootEvent((c=this.threadsTimelineSets)==null?void 0:c[0],s,o,a),s.hasCurrentUserParticipated&&this.updateThreadRootEvent((l=this.threadsTimelineSets)==null?void 0:l[1],s,o,a))},this.updateThreadRootEvent=(s,o,a,c)=>{s&&o.rootEvent&&(c&&s.removeEvent(o.id),et.hasServerSideSupport?s.addLiveEvent(o.rootEvent,{duplicateStrategy:vs.Replace,fromCache:!1,roomState:this.currentState}):s.addEventToTimeline(o.rootEvent,s.getLiveTimeline(),{toStartOfTimeline:a}))},this.applyRedaction=s=>{if(s.isRedaction()){const o=s.event.redacts,a=o?this.findEventById(o):void 0;if(a){const c=a.threadRootId;if(a.makeRedacted(s,this),a.isState()){const l=this.currentState.getStateEvents(a.getType(),a.getStateKey());(l==null?void 0:l.getId())===a.getId()&&this.currentState.setStateEvents([a])}this.emit("Room.redaction",s,this,c),this.visibilityEvents.delete(o),a.isVisibilityEvent()&&this.redactVisibilityChangeEvent(s)}}},this.setMaxListeners(100),this.reEmitter=new qn(this),n.pendingEventOrdering=n.pendingEventOrdering||Ln.Chronological,this.name=e,this.normalizedName=e,this.on("Room.receipt",this.onReceipt),this.timelineSets=[new gr(this,n)],this.reEmitter.reEmit(this.getUnfilteredTimelineSet(),["Room.timeline","Room.timelineReset"]),this.fixUpLegacyTimelineFields(),this.opts.pendingEventOrdering===Ln.Detached&&(this.pendingEventList=[],this.client.store.getPendingEvents(this.roomId).then(s=>{const o=this.client.getEventMapper({toDevice:!1,decrypt:!1});s.forEach(async a=>{const c=o(a);await t.decryptEventIfNeeded(c),c.setStatus(se.NOT_SENT),this.addPendingEvent(c,c.getTxnId())})})),this.opts.lazyLoadMembers?this.membersPromise=void 0:this.membersPromise=Promise.resolve(!1)}async createThreadsTimelineSets(){var e;if(this.threadTimelineSetsPromise)return this.threadTimelineSetsPromise;if((e=this.client)!=null&&e.supportsThreads())try{this.threadTimelineSetsPromise=Promise.all([this.createThreadTimelineSet(),this.createThreadTimelineSet(qt.My)]);const t=await this.threadTimelineSetsPromise;return this.threadsTimelineSets[0]=t[0],this.threadsTimelineSets[1]=t[1],t}catch{return this.threadTimelineSetsPromise=null,null}return null}async decryptCriticalEvents(){if(!this.client.isCryptoEnabled())return;const e=this.getEventReadUpTo(this.client.getUserId(),!0),t=this.getLiveTimeline().getEvents(),i=t.findIndex(s=>s.event.event_id===e),n=t.slice(i).reverse().map(s=>this.client.decryptEventIfNeeded(s));await Promise.allSettled(n)}async decryptAllEvents(){if(!this.client.isCryptoEnabled())return;const e=this.getUnfilteredTimelineSet().getLiveTimeline().getEvents().slice(0).reverse().map(t=>this.client.decryptEventIfNeeded(t));await Promise.allSettled(e)}getCreator(){const e=this.currentState.getStateEvents(R.RoomCreate,"");return(e==null?void 0:e.getSender())??null}getVersion(){const e=this.currentState.getStateEvents(R.RoomCreate,"");return e?e.getContent().room_version??"1":(this.getVersionWarning||(d.warn("[getVersion] Room "+this.roomId+" does not have an m.room.create event"),this.getVersionWarning=!0),"1")}shouldUpgradeToVersion(){return il.includes(this.getVersion())?null:tl}async getRecommendedVersion(){let t=(await this.client.getCapabilities())["m.room_versions"];if(!t){t={default:tl,available:{}};for(const n of il)t.available[n]=Ju.Stable}let i=this.checkVersionAgainstCapability(t);if(i.urgent&&i.needsUpgrade)if(d.warn("Refreshing room version capability because the server looks to be supporting a newer room version we don't know about."),t=(await this.client.getCapabilities(!0))["m.room_versions"],t)i=this.checkVersionAgainstCapability(t);else return d.warn("No room version capability - assuming upgrade required."),i;return i}checkVersionAgainstCapability(e){const t=this.getVersion();d.log(`[${this.roomId}] Current version: ${t}`),d.log(`[${this.roomId}] Version capability: `,e);const i={version:t,needsUpgrade:!1,urgent:!1};return t===e.default||Object.keys(e.available).filter(s=>e.available[s]==="stable").includes(t)||(i.version=e.default,i.needsUpgrade=!0,i.urgent=!!this.getVersion().match(/^[0-9]+[0-9.]*$/g),i.urgent?d.warn(`URGENT upgrade required on ${this.roomId}`):d.warn(`Non-urgent upgrade required on ${this.roomId}`)),i}userMayUpgradeRoom(e){return this.currentState.maySendStateEvent(R.RoomTombstone,e)}getPendingEvents(){if(!this.pendingEventList)throw new Error("Cannot call getPendingEvents with pendingEventOrdering == "+this.opts.pendingEventOrdering);return this.pendingEventList}removePendingEvent(e){if(!this.pendingEventList)throw new Error("Cannot call removePendingEvent with pendingEventOrdering == "+this.opts.pendingEventOrdering);const t=Rs(this.pendingEventList,function(i){return i.getId()==e},!1);return this.savePendingEvents(),t}hasPendingEvent(e){var t;return((t=this.pendingEventList)==null?void 0:t.some(i=>i.getId()===e))??!1}getPendingEvent(e){var t;return((t=this.pendingEventList)==null?void 0:t.find(i=>i.getId()===e))??null}getLiveTimeline(){return this.getUnfilteredTimelineSet().getLiveTimeline()}get timeline(){return this.getLiveTimeline().getEvents()}getLastActiveTimestamp(){const t=this.getLiveTimeline().getEvents();return t.length?t[t.length-1].getTs():Number.MIN_SAFE_INTEGER}getLastLiveEvent(){const e=this.getLiveTimeline().getEvents(),t=e[e.length-1],i=this.getLastThread();if(!i)return t;const n=i.events[i.events.length-1];return((t==null?void 0:t.getTs())??0)>((n==null?void 0:n.getTs())??0)?t:n}getLastThread(){return this.getThreads().reduce((e,t)=>{if(!e)return t;const i=t.events[t.events.length-1],n=e.events[e.events.length-1];return((i==null?void 0:i.getTs())??0)>=((n==null?void 0:n.getTs())??0)?t:e},void 0)}getMyMembership(){return this.selfMembership??ae.Leave}getDMInviter(){var t;const e=this.getMember(this.myUserId);if(e)return e.getDMInviter();if(this.selfMembership===ae.Invite&&this.getInvitedAndJoinedMemberCount()===2)return(t=this.summaryHeroes)==null?void 0:t[0]}guessDMUserId(){const e=this.getMember(this.myUserId);if(e){const n=e.getDMInviter();if(n)return n}if(Array.isArray(this.summaryHeroes)&&this.summaryHeroes.length)return this.summaryHeroes[0];const i=this.currentState.getMembers().find(n=>n.userId!==this.myUserId);return i?i.userId:this.myUserId}getFunctionalMembers(){const e=this.currentState.getStateEvents(Mh.name,"");return Array.isArray(e==null?void 0:e.getContent().service_members)?e.getContent().service_members:[]}getAvatarFallbackMember(){var a;const e=this.getFunctionalMembers();let t=0;if(this.getMembers().forEach(c=>{c.membership!=="join"&&c.membership!=="invite"||e.includes(c.userId)||t++}),t>2)return;const i=(a=this.summaryHeroes)==null?void 0:a.filter(c=>!e.includes(c)),n=Array.isArray(i)&&i.length;if(n){const c=i.map(l=>this.getMember(l)).find(l=>!!l);if(c)return c}const s=this.getMembers(),o=s==null?void 0:s.filter(c=>!e.includes(c.userId));if(o.length<=2){const c=o.find(l=>l.userId!==this.myUserId);if(c)return c}if(n){const c=i.map(l=>this.client.getUser(l)).find(l=>!!l);if(c){const l=new Vo(this.roomId,c.userId);return l.user=c,l}}}updateMyMembership(e){const t=this.selfMembership;this.selfMembership=e,t!==e&&(e===ae.Leave&&this.cleanupAfterLeaving(),this.emit("Room.myMembership",this,e,t))}async loadMembersFromServer(){const e=this.client.store.getSyncToken();return(await this.client.members(this.roomId,void 0,ae.Leave,e??void 0)).chunk}async loadMembers(){let e=!1,t=await this.client.store.getOutOfBandMembers(this.roomId);return(t===null||this.hasEncryptionStateEvent())&&(e=!0,t=await this.loadMembersFromServer(),d.log(`LL: got ${t.length} members from server for room ${this.roomId}`)),{memberEvents:t.filter(Dt).map(this.client.getEventMapper()),fromServer:e}}membersLoaded(){return this.opts.lazyLoadMembers?this.currentState.outOfBandMembersReady():!0}loadMembersIfNeeded(){if(this.membersPromise)return this.membersPromise;this.currentState.markOutOfBandMembersStarted();const e=this.loadMembers().then(t=>(this.currentState.setOutOfBandMembers(t.memberEvents),t.fromServer)).catch(t=>{throw this.membersPromise=void 0,this.currentState.markOutOfBandMembersFailed(),t});return e.then(t=>{if(t){const i=this.currentState.getMembers().filter(s=>s.isOutOfBand()).map(s=>{var o;return(o=s.events.member)==null?void 0:o.event});return d.log(`LL: telling store to write ${i.length} members for room ${this.roomId}`),this.client.store.setOutOfBandMembers(this.roomId,i).catch(s=>{d.log("LL: storing OOB room members failed, oh well",s)})}}).catch(t=>{d.error(t)}),this.membersPromise=e,this.membersPromise}async clearLoadedMembersIfNeeded(){this.opts.lazyLoadMembers&&this.membersPromise&&(await this.loadMembersIfNeeded(),await this.client.store.clearOutOfBandMembers(this.roomId),this.currentState.clearOutOfBandMembers(),this.membersPromise=void 0)}cleanupAfterLeaving(){this.clearLoadedMembersIfNeeded().catch(e=>{d.error(`error after clearing loaded members from room ${this.roomId} after leaving`),d.log(e)})}async refreshLiveTimeline(){const e=this.getLiveTimeline(),t=e.getPaginationToken(ee.FORWARDS),i=e.getPaginationToken(ee.BACKWARDS),n=e.getEvents(),s=n[n.length-1];d.log(`[refreshLiveTimeline for ${this.roomId}] at mostRecentEventInTimeline=${s&&s.getId()} liveTimelineBefore=${e.toString()} forwardPaginationToken=${t} backwardPaginationToken=${i}`);const o=this.getUnfilteredTimelineSet();let a;s?(this.resetLiveTimeline(null,null),this.emit("Room.TimelineRefresh",this,o),a=await this.client.getEventTimeline(o,s.getId())):a=await this.client.getLatestTimeline(o);const c=o.getLiveTimeline();!c||c.getPaginationToken(he.Forward)===null&&c.getPaginationToken(he.Backward)===null&&c.getEvents().length===0?(d.log(`[refreshLiveTimeline for ${this.roomId}] using our new live timeline`),a.setPaginationToken(t,ee.FORWARDS),o.setLiveTimeline(a),this.fixUpLegacyTimelineFields()):d.log(`[refreshLiveTimeline for ${this.roomId}] \`/sync\` or some other request beat us to creating a new live timeline after we reset it. We'll use that instead since any events in the scrollback from this timeline will include the history.`),this.setTimelineNeedsRefresh(!1),this.emit("Room.TimelineRefresh",this,o)}resetLiveTimeline(e,t){for(const i of this.timelineSets)i.resetLiveTimeline(e??void 0,t??void 0);for(const i of this.threads.values())i.resetLiveTimeline(e,t);this.fixUpLegacyTimelineFields()}fixUpLegacyTimelineFields(){const e=this.oldState,t=this.currentState;this.oldState=this.getLiveTimeline().getState(ee.BACKWARDS),this.currentState=this.getLiveTimeline().getState(ee.FORWARDS),e!==this.oldState&&this.emit("Room.OldStateUpdated",this,e,this.oldState),t!==this.currentState&&(this.emit("Room.CurrentStateUpdated",this,t,this.currentState),this.reEmitter.stopReEmitting(t,[fe.Events,fe.Members,fe.NewMember,fe.Update,fe.Marker,Ke.New,Ke.Update,Ke.Destroy,Ke.LivenessChange]),this.reEmitter.reEmit(this.currentState,[fe.Events,fe.Members,fe.NewMember,fe.Update,fe.Marker,Ke.New,Ke.Update,Ke.Destroy,Ke.LivenessChange]))}onReceipt(e){this.hasEncryptionStateEvent()&&this.clearNotificationsOnReceipt(e)}clearNotificationsOnReceipt(e){var s,o;let t=[],i=!1;const n=e.getContent();for(const a of Object.values(n))for(const[c,l]of Object.entries(a))if(Cd(c)&&l)for(const[u,h]of Object.entries(l)){if(!h||typeof h!="object")continue;const f=h;u===this.client.getUserId()&&(f.thread_id===void 0?i=!0:typeof f.thread_id=="string"&&t.push(f.thread_id))}i&&(t=this.getThreads().filter(a=>this.getThreadUnreadNotificationCount(a.id,"total")>0||this.getThreadUnreadNotificationCount(a.id,"highlight")>0).map(a=>a.id),t.push("main"));for(const a of t){const l=a==="main"?this.getLiveTimeline():(s=this.getThread(a))==null?void 0:s.liveTimeline;if(!l){d.warn(`Couldn't find timeline for thread ID ${a} in room ${this.roomId}`);continue}const u=l.getEvents();let h=0;for(let f=u.length-1;f>=0;f--){if(f===u.length-20)return;const g=u[f];if(this.hasUserReadEvent(this.client.getUserId(),g.getId()))break;const m=this.client.getPushActionsForEvent(g);h+=(o=m==null?void 0:m.tweaks)!=null&&o.highlight?1:0}a==="main"?this.setUnreadNotificationCount("highlight",h):this.setThreadUnreadNotificationCount(a,"highlight",h)}}async hasUnverifiedDevices(){if(!this.hasEncryptionStateEvent())return!1;const e=await this.getEncryptionTargetMembers();for(const t of e)if(this.client.getStoredDevicesForUser(t.userId).some(n=>n.isUnverified()))return!0;return!1}getTimelineSets(){return this.timelineSets}getUnfilteredTimelineSet(){return this.timelineSets[0]}getTimelineForEvent(e){const t=this.findEventById(e),i=this.findThreadForEvent(t);return i?i.timelineSet.getTimelineForEvent(e):this.getUnfilteredTimelineSet().getTimelineForEvent(e)}addTimeline(){return this.getUnfilteredTimelineSet().addTimeline()}setTimelineNeedsRefresh(e){this.timelineNeedsRefresh=e}getTimelineNeedsRefresh(){return this.timelineNeedsRefresh}findEventById(e){let t=this.getUnfilteredTimelineSet().findEventById(e);if(!t){const i=this.getThreads();for(let n=0;n<i.length;n++)if(t=i[n].findEventById(e),t)return t}return t}getUnreadNotificationCount(e="total"){let t=this.getRoomUnreadNotificationCount(e);for(const i of this.threadNotifications.values())t+=i[e]??0;return t}getUnreadCountForEventContext(e="total",t){return(!!t.threadRootId&&!t.isThreadRoot?this.getThreadUnreadNotificationCount(t.threadRootId,e):this.getRoomUnreadNotificationCount(e))??0}getRoomUnreadNotificationCount(e="total"){return this.notificationCounts[e]??0}getThreadUnreadNotificationCount(e,t="total"){var i;return((i=this.threadNotifications.get(e))==null?void 0:i[t])??0}hasThreadUnreadNotification(){for(const e of this.threadNotifications.values())if((e.highlight??0)>0||(e.total??0)>0)return!0;return!1}setThreadUnreadNotificationCount(e,t,i){var s,o;const n={highlight:(s=this.threadNotifications.get(e))==null?void 0:s.highlight,total:(o=this.threadNotifications.get(e))==null?void 0:o.total,[t]:i};this.threadNotifications.set(e,n),this.emit("Room.UnreadNotifications",n,e)}get threadsAggregateNotificationType(){let e=null;for(const t of this.threadNotifications.values()){if((t.highlight??0)>0)return"highlight";(t.total??0)>0&&!e&&(e="total")}return e}resetThreadUnreadNotificationCountFromSync(e=[]){const t=this.hasEncryptionStateEvent();for(const[i,n]of this.threadNotifications)e.includes(i)||(n.total=0,t||(n.highlight=0));this.emit("Room.UnreadNotifications")}setUnreadNotificationCount(e,t){this.notificationCounts[e]=t,this.emit("Room.UnreadNotifications",this.notificationCounts)}setUnread(e,t){return this.setUnreadNotificationCount(e,t)}setSummary(e){const t=e["m.heroes"],i=e["m.joined_member_count"],n=e["m.invited_member_count"];Number.isInteger(i)&&this.currentState.setJoinedMemberCount(i),Number.isInteger(n)&&this.currentState.setInvitedMemberCount(n),Array.isArray(t)&&(this.summaryHeroes=t.filter(s=>s!==this.myUserId)),this.emit("Room.Summary",e)}setBlacklistUnverifiedDevices(e){this.blacklistUnverifiedDevices=e}getBlacklistUnverifiedDevices(){return this.blacklistUnverifiedDevices===void 0?null:this.blacklistUnverifiedDevices}getAvatarUrl(e,t,i,n,s=!0){const o=this.currentState.getStateEvents(R.RoomAvatar,"");if(!o&&!s)return null;const a=o?o.getContent().url:null;return a?qa(e,a,t,i,n):null}getMxcAvatarUrl(){var e,t;return((t=(e=this.currentState.getStateEvents(R.RoomAvatar,""))==null?void 0:e.getContent())==null?void 0:t.url)||null}getCanonicalAlias(){const e=this.currentState.getStateEvents(R.RoomCanonicalAlias,"");return e&&e.getContent().alias||null}getAltAliases(){const e=this.currentState.getStateEvents(R.RoomCanonicalAlias,"");return e?e.getContent().alt_aliases||[]:[]}addEventsToTimeline(e,t,i,n){i.getTimelineSet().addEventsToTimeline(e,t,i,n)}getThread(e){return this.threads.get(e)??null}getThreads(){return Array.from(this.threads.values())}getMember(e){return this.currentState.getMember(e)}getMembers(){return this.currentState.getMembers()}getJoinedMembers(){return this.getMembersWithMembership(ae.Join)}getJoinedMemberCount(){return this.currentState.getJoinedMemberCount()}getInvitedMemberCount(){return this.currentState.getInvitedMemberCount()}getInvitedAndJoinedMemberCount(){return this.getInvitedMemberCount()+this.getJoinedMemberCount()}getMembersWithMembership(e){return this.currentState.getMembers().filter(function(t){return t.membership===e})}async getEncryptionTargetMembers(){await this.loadMembersIfNeeded();let e=this.getMembersWithMembership(ae.Join);return this.shouldEncryptForInvitedMembers()&&(e=e.concat(this.getMembersWithMembership(ae.Invite))),e}shouldEncryptForInvitedMembers(){var t;const e=this.currentState.getStateEvents(R.RoomHistoryVisibility,"");return((t=e==null?void 0:e.getContent())==null?void 0:t.history_visibility)!=="joined"}getDefaultRoomName(e){return this.calculateRoomName(e,!0)}hasMembershipState(e,t){const i=this.getMember(e);return i?i.membership===t:!1}getOrCreateFilteredTimelineSet(e,{prepopulateTimeline:t=!0,useSyncEvents:i=!0,pendingEvents:n=!0}={}){if(this.filteredTimelineSets[e.filterId])return this.filteredTimelineSets[e.filterId];const s=Object.assign({filter:e,pendingEvents:n},this.opts),o=new gr(this,s);this.reEmitter.reEmit(o,["Room.timeline","Room.timelineReset"]),i&&(this.filteredTimelineSets[e.filterId]=o,this.timelineSets.push(o));const a=this.getLiveTimeline();if(t){a.getEvents().forEach(function(l){o.addLiveEvent(l)});let c=a;for(;c.getNeighbouringTimeline(ee.BACKWARDS);)c=c.getNeighbouringTimeline(ee.BACKWARDS);o.getLiveTimeline().setPaginationToken(c.getPaginationToken(ee.BACKWARDS),ee.BACKWARDS)}else if(i){const c=a.getPaginationToken(he.Forward);o.getLiveTimeline().setPaginationToken(c,he.Backward)}return o}async getThreadListFilter(e=qt.All){const t=this.client.getUserId(),i=new It(t),n={room:{timeline:{[wr.name]:[_e.name]}}};e===qt.My&&(n.room.timeline[br.name]=[t]),i.setDefinition(n);const s=await this.client.getOrCreateFilter(`THREAD_PANEL_${this.roomId}_${e}`,i);return i.filterId=s,i}async createThreadTimelineSet(e){let t;if(et.hasServerSideListSupport)t=new gr(this,{...this.opts,pendingEvents:!1},void 0,void 0,e??qt.All),this.reEmitter.reEmit(t,["Room.timeline","Room.timelineReset"]);else if(et.hasServerSideSupport){const i=await this.getThreadListFilter(e);t=this.getOrCreateFilteredTimelineSet(i,{prepopulateTimeline:!1,useSyncEvents:!1,pendingEvents:!1})}else t=new gr(this,{pendingEvents:!1}),Array.from(this.threads).forEach(([,i])=>{if(i.length===0)return;const n=i.timeline.some(s=>s.getSender()===this.client.getUserId());(e!==qt.My||n)&&t.getLiveTimeline().addEvent(i.rootEvent,{toStartOfTimeline:!1})});return t}processThreadRoots(e,t){if(this.client.supportsThreads())for(const i of e)ee.setEventMetadata(i,this.currentState,t),this.getThread(i.getId())||this.createThread(i.getId(),i,[],t)}async fetchRoomThreads(){var e,t;if(!(this.threadsReady||!this.client.supportsThreads())){if(et.hasServerSideListSupport)await Promise.all([this.fetchRoomThreadList(qt.All),this.fetchRoomThreadList(qt.My)]);else{const i=await this.getThreadListFilter(),{chunk:n}=await this.client.createMessagesRequest(this.roomId,"",Number.MAX_SAFE_INTEGER,he.Backward,i);if(!n.length)return;const s=n.map(this.client.getEventMapper()).sort((c,l)=>{const u=c.getServerAggregatedRelation(_e.name),h=l.getServerAggregatedRelation(_e.name);return u.latest_event.origin_server_ts-h.latest_event.origin_server_ts});let o;const a=this.getLiveTimeline().getState(ee.FORWARDS);for(const c of s){const l={duplicateStrategy:vs.Ignore,fromCache:!1,roomState:a};(e=this.threadsTimelineSets[0])==null||e.addLiveEvent(c,l);const u=c.getServerAggregatedRelation(_e.name);u!=null&&u.current_user_participated&&((t=this.threadsTimelineSets[1])==null||t.addLiveEvent(c,l),o=c)}this.processThreadRoots(s,!0),this.client.decryptEventIfNeeded(s[s.length-1]),o&&this.client.decryptEventIfNeeded(o)}this.on(jt.NewReply,this.onThreadReply),this.on(jt.Update,this.onThreadUpdate),this.on(jt.Delete,this.onThreadDelete),this.threadsReady=!0}}async processPollEvents(e){for(const t of e)try{if(!t.isEncrypted()&&!Xp(t))continue;await this.client.decryptEventIfNeeded(t),this.processPollEvent(t)}catch(i){d.warn("Error processing poll event",t.getId(),i)}}async processPollEvent(e){if(e.isDecryptionFailure()){e.once(be.Decrypted,i=>{this.processPollEvent(i)});return}if(ot.M_POLL_START.matches(e.getType())){try{const i=new Qp(e,this.client,this);this.polls.set(e.getId(),i),this.emit(tu.New,i),e.once(be.BeforeRedaction,n=>{this.polls.delete(n.getId())})}catch{}return}const t=e.relationEventId;if(t&&this.polls.has(t)){const i=this.polls.get(t);i==null||i.onNewRelation(e)}}async fetchRoomThreadList(e){if(!this.client.supportsThreads()||this.threadsTimelineSets.length===0)return;const t=e===qt.My?this.threadsTimelineSets[1]:this.threadsTimelineSets[0],{chunk:i,end:n}=await this.client.createThreadListMessagesRequest(this.roomId,null,void 0,he.Backward,t.threadListType,t.getFilter());if(t.getLiveTimeline().setPaginationToken(n??null,he.Backward),!i.length)return;const s=i.map(this.client.getEventMapper());this.processThreadRoots(s,!0);const o=this.getLiveTimeline().getState(ee.FORWARDS);for(const a of s)t.addLiveEvent(a,{duplicateStrategy:vs.Replace,fromCache:!1,roomState:o})}onThreadUpdate(e){this.updateThreadRootEvents(e,!1,!1)}onThreadReply(e){this.updateThreadRootEvents(e,!1,!0)}onThreadDelete(e){var n;this.threads.delete(e.id);const t=this.getTimelineForEvent(e.id),i=(n=t==null?void 0:t.getEvents())==null?void 0:n.find(s=>s.getId()===e.id);i?e.clearEventMetadata(i):d.debug("onThreadDelete: Could not find root event in room timeline");for(const s of this.threadsTimelineSets)s.removeEvent(e.id)}removeFilteredTimelineSet(e){const t=this.filteredTimelineSets[e.filterId];delete this.filteredTimelineSets[e.filterId];const i=this.timelineSets.indexOf(t);i>-1&&this.timelineSets.splice(i,1)}eventShouldLiveIn(e,t,i){var c;if(!((c=this.client)!=null&&c.supportsThreads()))return{shouldLiveInRoom:!0,shouldLiveInThread:!1};if(e.isThreadRoot||i!=null&&i.has(e.getId()))return{shouldLiveInRoom:!0,shouldLiveInThread:!0,threadId:e.getId()};const n=e.isRelation(_e.name),s=e.getAssociatedId(),o=e.threadRootId;if(s&&!n&&(o===s||i!=null&&i.has(s)))return{shouldLiveInRoom:!0,shouldLiveInThread:!1};let a;return s&&(a=this.findEventById(s)??(t==null?void 0:t.find(l=>l.getId()===s))),a&&!n?this.eventShouldLiveIn(a,t,i):o!=null?{shouldLiveInRoom:!1,shouldLiveInThread:!0,threadId:o}:!s||e.replyEventId?{shouldLiveInRoom:!0,shouldLiveInThread:!1}:{shouldLiveInRoom:!1,shouldLiveInThread:!1}}findThreadForEvent(e){if(!e)return null;const{threadId:t}=this.eventShouldLiveIn(e);return t?this.getThread(t):null}addThreadedEvents(e,t,i=!1){const n=this.getThread(e);if(n)n.addEvents(t,i);else{const s=this.findEventById(e)??t.find(o=>o.getId()===e);this.createThread(e,s,t,i)}}processThreadedEvents(e,t){var n;e.forEach(this.applyRedaction);const i={};for(const s of e){const{threadId:o,shouldLiveInThread:a}=this.eventShouldLiveIn(s);a&&!i[o]&&(i[o]=[]),(n=i[o])==null||n.push(s)}Object.entries(i).map(([s,o])=>this.addThreadedEvents(s,o,t))}createThread(e,t,i=[],n){var a,c;if(this.threads.has(e))return this.threads.get(e);if(t){const l=this.relations.getAllChildEventsForEvent(t.getId());l!=null&&l.length&&(i=i.concat(l.filter(u=>!u.isRelation(Te.Replace))))}const s=new et(e,t,{room:this,client:this.client,pendingEventOrdering:this.opts.pendingEventOrdering,receipts:this.cachedThreadReadReceipts.get(e)??[]});this.reEmitter.reEmit(s,[jt.Delete,jt.Update,jt.NewReply,"Room.timeline","Room.timelineReset"]),this.cachedThreadReadReceipts.delete(e),this.threads.set(s.id,s),s.addEvents(i,!1);const o=((a=this.lastThread)==null?void 0:a.rootEvent)&&(t==null?void 0:t.localTimestamp)&&((c=this.lastThread.rootEvent)==null?void 0:c.localTimestamp)<(t==null?void 0:t.localTimestamp);return(!this.lastThread||o)&&(this.lastThread=s),this.threadsReady&&s.initialEventsFetched&&this.updateThreadRootEvents(s,n,!1),this.emit(jt.New,s,n),s}processLiveEvent(e){if(this.applyRedaction(e),e.isVisibilityEvent()&&this.applyNewVisibilityEvent(e),this.applyPendingVisibilityEvents(e),!e.getUnsigned().transaction_id&&e.getSender()===this.myUserId){for(const[i,n]of this.txnToEvent)if(n.getId()===e.getId()){d.debug("processLiveEvent: found sent event without txn ID: ",i,e.getId());const s=e.getUnsigned();s.transaction_id=i,e.setUnsigned(s);break}}}addLiveEvent(e,t){const{duplicateStrategy:i,timelineWasEmpty:n,fromCache:s}=t;for(const o of this.timelineSets)o.addLiveEvent(e,{duplicateStrategy:i,fromCache:s,timelineWasEmpty:n});e.sender&&e.getType()!==R.RoomRedaction&&this.addReceipt(Zd(e.sender.userId,e,nt.Read),!0)}addPendingEvent(e,t){if(e.status!==se.SENDING&&e.status!==se.NOT_SENT)throw new Error("addPendingEvent called on an event with status "+e.status);if(this.txnToEvent.get(t))throw new Error("addPendingEvent called on an event with known txnId "+t);if(ee.setEventMetadata(e,this.getLiveTimeline().getState(ee.FORWARDS),!1),this.txnToEvent.set(t,e),this.pendingEventList){if(this.pendingEventList.some(i=>i.status===se.NOT_SENT)&&(d.warn("Setting event as NOT_SENT due to messages in the same state"),e.setStatus(se.NOT_SENT)),this.pendingEventList.push(e),this.savePendingEvents(),e.isRelation()&&this.aggregateNonLiveRelation(e),e.isRedaction()){const i=e.event.redacts;let n=this.pendingEventList.find(s=>s.getId()===i);!n&&i&&(n=this.findEventById(i)),n&&(n.markLocallyRedacted(e),this.emit("Room.redaction",e,this,n.threadRootId))}}else for(const i of this.timelineSets)i.getFilter()?i.getFilter().filterRoomTimeline([e]).length&&i.addEventToTimeline(e,i.getLiveTimeline(),{toStartOfTimeline:!1}):i.addEventToTimeline(e,i.getLiveTimeline(),{toStartOfTimeline:!1});this.emit("Room.localEchoUpdated",e,this)}savePendingEvents(){if(this.pendingEventList){const e=this.pendingEventList.map(t=>({...t.event,txn_id:t.getTxnId()})).filter(t=>{const i=t.type===R.RoomMessageEncrypted,n=this.hasEncryptionStateEvent();return i||!n});this.client.store.setPendingEvents(this.roomId,e)}}aggregateNonLiveRelation(e){this.relations.aggregateChildEvent(e)}getEventForTxnId(e){return this.txnToEvent.get(e)}handleRemoteEcho(e,t){const i=t.getId(),n=e.getId(),s=t.status;d.debug(`Got remote echo for event ${i} -> ${n} old status ${s}`),this.txnToEvent.delete(e.getUnsigned().transaction_id),this.pendingEventList&&this.removePendingEvent(i),t.handleRemoteEcho(e.event);const{shouldLiveInRoom:o,threadId:a}=this.eventShouldLiveIn(e),c=a?this.getThread(a):null;if(c==null||c.setEventMetadata(t),c==null||c.timelineSet.handleRemoteEcho(t,i,n),o)for(const l of this.timelineSets)l.handleRemoteEcho(t,i,n);this.emit("Room.localEchoUpdated",t,this,i,s)}updatePendingEvent(e,t,i){if(d.log(`setting pendingEvent status to ${t} in ${e.getRoomId()} event ID ${e.getId()} -> ${i}`),t==se.SENT&&!i)throw new Error("updatePendingEvent called with status=SENT, but no new event id");if(t==se.SENT&&this.getTimelineForEvent(i)){const c=this.findEventById(i);if(!(c==null?void 0:c.getUnsigned().transaction_id)&&c){const u=c.getUnsigned();u.transaction_id=e.getTxnId(),c.setUnsigned(u),this.removeEvent(c.getId()),this.handleRemoteEcho(c,e)}return}const n=e.status,s=e.getId();if(!n)throw new Error("updatePendingEventStatus called on an event which is not a local echo.");const o=dm[n];if(!(o!=null&&o.includes(t)))throw new Error(`Invalid EventStatus transition ${n}->${t}`);if(e.setStatus(t),t==se.SENT){e.replaceLocalEventId(i);const{shouldLiveInRoom:a,threadId:c}=this.eventShouldLiveIn(e),l=c?this.getThread(c):void 0;if(l==null||l.setEventMetadata(e),l==null||l.timelineSet.replaceEventId(s,i),a)for(const u of this.timelineSets)u.replaceEventId(s,i)}else if(t==se.CANCELLED){if(this.pendingEventList){const a=this.getPendingEvent(s);this.removePendingEvent(s),a!=null&&a.isRedaction()&&this.revertRedactionLocalEcho(a)}this.removeEvent(s)}this.savePendingEvents(),this.emit("Room.localEchoUpdated",e,this,s,n)}revertRedactionLocalEcho(e){const t=e.event.redacts;if(!t)return;const i=this.getUnfilteredTimelineSet().findEventById(t);i&&(i.unmarkLocallyRedacted(),this.emit("Room.redactionCancelled",e,this),i.isRelation()&&this.aggregateNonLiveRelation(i))}async addLiveEvents(e,t,i=!1){var u;let n=t,s=!1;if(typeof t=="object"?{duplicateStrategy:n,fromCache:i=!1,timelineWasEmpty:s}=t:t!==void 0&&d.warn("Overload deprecated: `Room.addLiveEvents(events, duplicateStrategy?, fromCache?)` is deprecated in favor of the overload with `Room.addLiveEvents(events, IAddLiveEventOptions)`"),n&&["replace","ignore"].indexOf(n)===-1)throw new Error("duplicateStrategy MUST be either 'replace' or 'ignore'");for(let h=0;h<this.timelineSets.length;h++){const f=this.timelineSets[h].getLiveTimeline();if(f.getPaginationToken(ee.FORWARDS))throw new Error("live timeline "+h+" is no longer live - it has a pagination token ("+f.getPaginationToken(ee.FORWARDS)+")");if(f.getNeighbouringTimeline(ee.FORWARDS))throw new Error(`live timeline ${h} is no longer live - it has a neighbouring timeline`)}const o=this.findThreadRoots(e),a={},c={duplicateStrategy:n,fromCache:i,timelineWasEmpty:s},l=[...e];for(const h of e){if(this.processLiveEvent(h),h.getUnsigned().transaction_id){const v=this.txnToEvent.get(h.getUnsigned().transaction_id);if(v){this.handleRemoteEcho(h,v);continue}}let{shouldLiveInRoom:f,shouldLiveInThread:g,threadId:m}=this.eventShouldLiveIn(h,l,o);if(!g&&!f&&h.isRelation())try{const v=new it(await this.client.fetchRoomEvent(this.roomId,h.relationEventId));if(l.push(v),v.threadRootId){o.add(v.threadRootId);const S=h.getUnsigned();S[$o.name]=v.threadRootId,h.setUnsigned(S)}({shouldLiveInRoom:f,shouldLiveInThread:g,threadId:m}=this.eventShouldLiveIn(h,l,o))}catch(v){d.error("Failed to load parent event of unhandled relation",v)}g&&!a[m??""]&&(a[m??""]=[]),(u=a[m??""])==null||u.push(h),f?this.addLiveEvent(h,c):!g&&h.isRelation()&&this.relations.aggregateChildEvent(h)}Object.entries(a).forEach(([h,f])=>{this.addThreadedEvents(h,f,!1)})}partitionThreadedEvents(e){if(this.client.supportsThreads()){const s=this.findThreadRoots(e);return e.reduce((o,a)=>{const{shouldLiveInRoom:c,shouldLiveInThread:l,threadId:u}=this.eventShouldLiveIn(a,e,s);return c&&o[0].push(a),l&&(a.setThreadId(u??""),o[1].push(a)),!l&&!c&&o[2].push(a),o},[[],[],[]])}else return[e,[],[]]}findThreadRoots(e){const t=new Set;for(const i of e){const n=i.threadRootId;n!=null&&t.add(n)}return t}addReceipt(e,t=!1){const i=e.getContent();this.roomReceipts.add(i,t),Object.keys(i).forEach(n=>{Object.keys(i[n]).forEach(s=>{Object.keys(i[n][s]).forEach(o=>{var h;const a=i[n][s][o],c=!a.thread_id||a.thread_id===Ys,l=c?this:this.threads.get(a.thread_id??"");if(l){if(l.addReceiptToStructure(n,s,o,a,t),!t&&this.client.isInitialSyncComplete()&&o===this.client.getUserId()){const f=l.timeline[l.timeline.length-1];f&&n===f.getId()&&o===f.getSender()&&(l.setUnread("total",0),l.setUnread("highlight",0))}}else this.cachedThreadReadReceipts.set(a.thread_id,[...this.cachedThreadReadReceipts.get(a.thread_id)??[],{eventId:n,receiptType:s,userId:o,receipt:a,synthetic:t}]);const u=this.client.getUserId();o===u&&!c&&a.ts<this.oldestThreadedReceiptTs&&(this.oldestThreadedReceiptTs=a.ts),!a.thread_id&&a.ts>(((h=this.unthreadedReceipts.get(o))==null?void 0:h.ts)??0)&&this.unthreadedReceipts.set(o,a)})})}),this.emit("Room.receipt",e,this)}addEphemeralEvents(e){for(const t of e)t.getType()===R.Typing?this.currentState.setTypingEvent(t):t.getType()===R.Receipt&&this.addReceipt(t)}removeEvents(e){for(const t of e)this.removeEvent(t)}removeEvent(e){let t=!1;for(const i of this.timelineSets){const n=i.removeEvent(e);n&&(n.isRedaction()&&this.revertRedactionLocalEcho(n),t=!0)}return t}recalculate(){const e=this.currentState.getStateEvents(R.RoomMember,this.myUserId);if(e){const i=e.getContent().membership;this.updateMyMembership(i),i===ae.Invite&&(e.getUnsigned().invite_room_state||[]).forEach(s=>{this.currentState.getStateEvents(s.type,s.state_key)||this.currentState.setStateEvents([new it({type:s.type,state_key:s.state_key,content:s.content,event_id:"$fake"+Date.now(),room_id:this.roomId,user_id:this.myUserId})])})}const t=this.name;this.name=this.calculateRoomName(this.myUserId),this.normalizedName=Yh(this.name),this.summary=new Fp(this.roomId,{title:this.name}),t!==this.name&&this.emit("Room.name",this)}addTags(e){this.tags=e.getContent().tags||{},this.emit("Room.tags",e,this)}addAccountData(e){for(const t of e){t.getType()==="m.tag"&&this.addTags(t);const i=t.getType(),n=this.accountData.get(i);this.accountData.set(i,t),this.emit("Room.accountData",t,this,n)}}getAccountData(e){return this.accountData.get(e)}maySendMessage(){return this.getMyMembership()===ae.Join&&(this.hasEncryptionStateEvent()?this.currentState.maySendEvent(R.RoomMessageEncrypted,this.myUserId):this.currentState.maySendEvent(R.RoomMessage,this.myUserId))}canInvite(e){let t=this.getMyMembership()===ae.Join;const i=this.currentState.getStateEvents(R.RoomPowerLevels,""),n=i&&i.getContent(),s=this.getMember(e);return n&&s&&n.invite>s.powerLevel&&(t=!1),t}getJoinRule(){return this.currentState.getJoinRule()}getHistoryVisibility(){return this.currentState.getHistoryVisibility()}getGuestAccess(){return this.currentState.getGuestAccess()}getType(){const e=this.currentState.getStateEvents(R.RoomCreate,"");if(!e){this.getTypeWarning||(d.warn("[getType] Room "+this.roomId+" does not have an m.room.create event"),this.getTypeWarning=!0);return}return e.getContent()[Fo]}isSpaceRoom(){return this.getType()===_n.Space}isCallRoom(){return this.getType()===_n.UnstableCall}isElementVideoRoom(){return this.getType()===_n.ElementVideo}findPredecessor(e=!1){const t=this.getLiveTimeline().getState(ee.FORWARDS);return t?t.findPredecessor(e):null}roomNameGenerator(e){if(this.client.roomNameGenerator){const t=this.client.roomNameGenerator(this.roomId,e);if(t!==null)return t}switch(e.type){case 2:return e.name;case 1:switch(e.subtype){case"Inviting":return`Inviting ${nl(e.names,e.count)}`;default:return nl(e.names,e.count)}case 0:return e.oldName?`Empty room (was ${e.oldName})`:"Empty room"}}calculateRoomName(e,t=!1){if(!t){const f=this.currentState.getStateEvents(R.RoomName,"");if(f!=null&&f.getContent().name)return this.roomNameGenerator({type:2,name:f.getContent().name})}const i=this.getCanonicalAlias();if(i)return this.roomNameGenerator({type:2,name:i});const n=this.currentState.getJoinedMemberCount(),s=this.currentState.getInvitedMemberCount();let o=n+s-1;const a=this.getFunctionalMembers();let c=[];if(this.summaryHeroes)this.summaryHeroes.forEach(f=>{if(a.includes(f)){o--;return}const g=this.getMember(f);c.push(g?g.name:f)});else{let f=this.currentState.getMembers().filter(g=>g.userId!==e&&(g.membership===ae.Invite||g.membership===ae.Join));f=f.filter(({userId:g})=>a.includes(g)?(o--,!1):!0),f.sort((g,m)=>sf(g.userId,m.userId)),f=f.slice(0,5),c=f.map(g=>g.name)}if(o)return this.roomNameGenerator({type:1,names:c,count:o});if(this.getMyMembership()==ae.Join){const f=this.currentState.getStateEvents(R.RoomThirdPartyInvite);if(f!=null&&f.length){const g=f.map(m=>m.getContent().display_name);return this.roomNameGenerator({type:1,subtype:"Inviting",names:g,count:g.length+1})}}let u=c;u.length||(u=this.currentState.getMembers().filter(f=>f.userId!==e&&f.membership!==ae.Invite&&f.membership!==ae.Join).map(f=>f.name));let h;return u.length&&(h=this.roomNameGenerator({type:1,names:u,count:u.length+1})),this.roomNameGenerator({type:0,oldName:h})}applyNewVisibilityEvent(e){const t=e.asVisibilityChange();if(!t)return;const i=e.getSender();if(!i||!(En.name&&this.currentState.maySendStateEvent(En.name,i)||En.altName&&this.currentState.maySendStateEvent(En.altName,i)))return;const s=this.visibilityEvents.get(t.eventId);if(s){let a=s.length-1;const c=Math.max(0,s.length-lm);for(;a>=c&&!(s[a].getTs()<e.getTs());--a);a===-1?s.unshift(e):s.splice(a+1,0,e)}else this.visibilityEvents.set(t.eventId,[e]);const o=this.findEventById(t.eventId);o&&o.applyVisibilityEvent(t)}redactVisibilityChangeEvent(e){if(!e.isVisibilityEvent)throw new Error("expected a visibility change event");const t=e.getRelation(),i=t==null?void 0:t.event_id,n=this.visibilityEvents.get(i);if(!n)return;const s=n.findIndex(o=>o.getId()===e.getId());if(s!==-1&&(n.splice(s,1),s===n.length)){const o=this.findEventById(i);if(!o)return;if(s===0)this.visibilityEvents.delete(i),o.applyVisibilityEvent();else{const c=n[n.length-1].asVisibilityChange();if(!c)throw new Error("at this stage, visibility changes should be well-formed");o.applyVisibilityEvent(c)}}}applyPendingVisibilityEvents(e){const t=this.visibilityEvents.get(e.getId());if(!t||t.length==0)return;const i=t[t.length-1],n=i.asVisibilityChange();n&&(n.visible,!(i.getTs()<e.getTs())&&e.applyVisibilityEvent(n))}getOldestThreadedReceiptTs(){return this.oldestThreadedReceiptTs}hasUserReadEvent(e,t){return this.roomReceipts.hasUserReadEvent(e,t)}getLastUnthreadedReceiptFor(e){return this.unthreadedReceipts.get(e)}fixupNotifications(e){super.fixupNotifications(e);const t=this.getThreads().filter(i=>this.getThreadUnreadNotificationCount(i.id,"total")>0);for(const i of t)i.fixupNotifications(e)}compareEventOrdering(e,t){return om(this,e,t)}hasEncryptionStateEvent(){var e;return!!((e=this.getLiveTimeline().getState(ee.FORWARDS))!=null&&e.getStateEvents(R.RoomEncryption,""))}}const dm={[se.ENCRYPTING]:[se.SENDING,se.NOT_SENT,se.CANCELLED],[se.SENDING]:[se.ENCRYPTING,se.QUEUED,se.NOT_SENT,se.SENT],[se.QUEUED]:[se.SENDING,se.NOT_SENT,se.CANCELLED],[se.SENT]:[],[se.NOT_SENT]:[se.SENDING,se.QUEUED,se.CANCELLED],[se.CANCELLED]:[]};function nl(r,e){const t=e-1;return r.length?r.length===1&&t<=1?r[0]:r.length===2&&t<=2?`${r[0]} and ${r[1]}`:t>1?`${r[0]} and ${t} others`:`${r[0]} and 1 other`:"Empty room"}var D=(r=>(r.Get="GET",r.Put="PUT",r.Post="POST",r.Delete="DELETE",r))(D||{});class pa extends Error{constructor(e,t){super(e),this.httpStatus=t}}class Et extends pa{constructor(e={},t,i,n){let s=e.error||"Unknown message";t&&(s=`[${t}] ${s}`),i&&(s=`${s} (${i})`),super(`MatrixError: ${s}`,t),this.httpStatus=t,this.url=i,this.event=n,this.errcode=e.errcode,this.name=e.errcode||"Unknown error code",this.data=e}}class to extends Error{constructor(e,t){super(e+(t?`: ${t.message}`:""))}get name(){return"ConnectionError"}}var ma=(r=>(r.SessionLoggedOut="Session.logged_out",r.NoConsent="no_consent",r))(ma||{});/*!
 * content-type
 * Copyright(c) 2015 Douglas Christopher Wilson
 * MIT Licensed
 */var rl=/; *([!#$%&'*+.^_`|~0-9A-Za-z-]+) *= *("(?:[\u000b\u0020\u0021\u0023-\u005b\u005d-\u007e\u0080-\u00ff]|\\[\u000b\u0020-\u00ff])*"|[!#$%&'*+.^_`|~0-9A-Za-z-]+) */g,um=/\\([\u000b\u0020-\u00ff])/g,hm=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+\/[!#$%&'*+.^_`|~0-9A-Za-z-]+$/,fm=gm;function gm(r){if(!r)throw new TypeError("argument string is required");var e=typeof r=="object"?pm(r):r;if(typeof e!="string")throw new TypeError("argument string is required to be a string");var t=e.indexOf(";"),i=t!==-1?e.slice(0,t).trim():e.trim();if(!hm.test(i))throw new TypeError("invalid media type");var n=new mm(i.toLowerCase());if(t!==-1){var s,o,a;for(rl.lastIndex=t;o=rl.exec(e);){if(o.index!==t)throw new TypeError("invalid parameter format");t+=o[0].length,s=o[1].toLowerCase(),a=o[2],a.charCodeAt(0)===34&&(a=a.slice(1,-1),a.indexOf("\\")!==-1&&(a=a.replace(um,"$1"))),n.parameters[s]=a}if(t!==e.length)throw new TypeError("invalid parameter format")}return n}function pm(r){var e;if(typeof r.getHeader=="function"?e=r.getHeader("content-type"):typeof r.headers=="object"&&(e=r.headers&&r.headers["content-type"]),typeof e!="string")throw new TypeError("content-type header is missing from object");return e}function mm(r){this.parameters=Object.create(null),this.type=r}function ru(r){const e=new AbortController;return setTimeout(()=>{e.abort()},r),e.signal}function vm(r){const e=new AbortController;function t(){for(const n of r)n.removeEventListener("abort",i)}function i(){e.abort(),t()}for(const n of r){if(n.aborted){i();break}n.addEventListener("abort",i)}return{signal:e.signal,cleanup:t}}function su(r,e){let t;try{t=ym(r)}catch(i){return i}return(t==null?void 0:t.type)==="application/json"&&e?new Et(JSON.parse(e),r.status,ou(r)?r.responseURL:r.url):(t==null?void 0:t.type)==="text/plain"?new pa(`Server returned ${r.status} error: ${e}`,r.status):new pa(`Server returned ${r.status} error`,r.status)}function ou(r){return"getResponseHeader"in r}function ym(r){let e;if(ou(r)?e=r.getResponseHeader("Content-Type"):e=r.headers.get("Content-Type"),!e)return null;try{return fm(e)}catch(t){throw new Error(`Error parsing Content-Type '${e}': ${t}`)}}async function Sm(r,e){let t=0,i=null;for(;t<r;)try{if(t>0){const n=1e3*Math.pow(2,t);d.log(`network operation failed ${t} times, retrying in ${n}ms...`),await Ir(n)}return await e()}catch(n){if(n instanceof to)t+=1,i=n;else throw n}throw i}function Em(r,e,t){if(e>4||r instanceof to&&!t||r.httpStatus&&(r.httpStatus===400||r.httpStatus===403||r.httpStatus===401)||r.name==="AbortError"||r.name==="M_TOO_LARGE")return-1;if(r.name==="M_LIMIT_EXCEEDED"){const i=r.data.retry_after_ms;if(i>0)return i}return 1e3*Math.pow(2,e)}var bm={};class wm{constructor(e,t){this.eventEmitter=e,this.opts=t,this.abortController=new AbortController,bd(t,["baseUrl","prefix"]),t.onlyData=!!t.onlyData,t.useAuthorizationHeader=t.useAuthorizationHeader??!0}abort(){this.abortController.abort(),this.abortController=new AbortController}fetch(e,t){return this.opts.fetchFn?this.opts.fetchFn(e,t):bm.fetch(e,t)}setIdBaseUrl(e){this.opts.idBaseUrl=e}idServerRequest(e,t,i,n,s){if(!this.opts.idBaseUrl)throw new Error("No identity server base URL set");let o,a;e===D.Get?o=i:a=i;const c=this.getUrl(t,o,n,this.opts.idBaseUrl),l={json:!0,headers:{}};return s&&(l.headers.Authorization=`Bearer ${s}`),this.requestOtherUrl(e,c,a,l)}async authedRequest(e,t,i,n,s={}){i||(i={});const o={...s};this.opts.accessToken&&(this.opts.useAuthorizationHeader?(o.headers||(o.headers={}),o.headers.Authorization||(o.headers.Authorization="Bearer "+this.opts.accessToken),i.access_token&&delete i.access_token):i.access_token||(i.access_token=this.opts.accessToken));try{return await this.request(e,t,i,n,o)}catch(a){const c=a;if(c.errcode==="M_UNKNOWN_TOKEN"&&!o.doNotAttemptTokenRefresh&&await this.tryRefreshToken())return this.authedRequest(e,t,i,n,{...s,doNotAttemptTokenRefresh:!0});throw c.errcode=="M_UNKNOWN_TOKEN"&&!(o!=null&&o.inhibitLogoutEmit)?this.eventEmitter.emit(ma.SessionLoggedOut,c):c.errcode=="M_CONSENT_NOT_GIVEN"&&this.eventEmitter.emit(ma.NoConsent,c.message,c.data.consent_uri),c}}async tryRefreshToken(){var e;if(!this.opts.refreshToken||!this.opts.tokenRefreshFunction)return!1;try{const{accessToken:t,refreshToken:i}=await this.opts.tokenRefreshFunction(this.opts.refreshToken);return this.opts.accessToken=t,this.opts.refreshToken=i,!0}catch(t){return(e=this.opts.logger)==null||e.warn("Failed to refresh token",t),!1}}request(e,t,i,n,s){const o=this.getUrl(t,i,s==null?void 0:s.prefix,s==null?void 0:s.baseUrl);return this.requestOtherUrl(e,o,n,s)}async requestOtherUrl(e,t,i,n={}){var w,M,_,C;const s=this.sanitizeUrlForLogs(t);(w=this.opts.logger)==null||w.debug(`FetchHttpApi: --> ${e} ${s}`);const o=Object.assign({},n.headers||{}),a=n.json??!0,c=a&&((M=i==null?void 0:i.constructor)==null?void 0:M.name)===Object.name;a&&(c&&!o["Content-Type"]&&(o["Content-Type"]="application/json"),o.Accept||(o.Accept="application/json"));const l=n.localTimeoutMs??this.opts.localTimeoutMs,u=n.keepAlive??!1,h=[this.abortController.signal];l!==void 0&&h.push(ru(l)),n.abortSignal&&h.push(n.abortSignal);let f;c?f=JSON.stringify(i):f=i;const{signal:g,cleanup:m}=vm(h);let v;const S=Date.now();try{v=await this.fetch(t,{signal:g,method:e,body:f,headers:o,mode:"cors",redirect:"follow",referrer:"",referrerPolicy:"no-referrer",cache:"no-cache",credentials:"omit",keepalive:u,priority:n.priority}),(_=this.opts.logger)==null||_.debug(`FetchHttpApi: <-- ${e} ${s} [${Date.now()-S}ms ${v.status}]`)}catch(A){throw(C=this.opts.logger)==null||C.debug(`FetchHttpApi: <-- ${e} ${s} [${Date.now()-S}ms ${A}]`),A.name==="AbortError"?A:new to("fetch failed",A)}finally{m()}if(!v.ok)throw su(v,await v.text());return this.opts.onlyData?a?v.json():v.text():v}sanitizeUrlForLogs(e){try{let t;typeof e=="string"?t=new URL(e):t=e;const i=new URLSearchParams;for(const o of t.searchParams.keys())i.append(o,"xxx");const n=i.toString(),s=n?`?${n}`:"";return t.origin+t.pathname+s}catch{return"??"}}getUrl(e,t,i,n){const s=n??this.opts.baseUrl,o=s.endsWith("/")?s.slice(0,-1):s,a=new URL(o+(i??this.opts.prefix)+e);return t&&Is(t,a.searchParams),a}}var Pe=(r=>(r.V1="/_matrix/client/v1",r.V3="/_matrix/client/v3",r.Unstable="/_matrix/client/unstable",r))(Pe||{}),ei=(r=>(r.V2="/_matrix/identity/v2",r))(ei||{}),Cn=(r=>(r.V1="/_matrix/media/v1",r.V3="/_matrix/media/v3",r))(Cn||{}),va={};const _m=1e3;let Im=0,Io;const ai=[],Rm=function(...r){};function sl(r,e,...t){e=e||0,e<0&&(e=0);const i=Date.now()+e,n=Im++,s={runAt:i,func:r,params:t,key:n},o=Cm(ai,function(a){return a.runAt-i});return ai.splice(o,0,s),Wa(),n}function ol(r){if(ai.length===0)return;let e;for(e=0;e<ai.length;e++)if(ai[e].key==r){ai.splice(e,1);break}e===0&&Wa()}function Wa(){Io&&va.clearTimeout(Io);const r=ai[0];if(!r)return;const e=Date.now(),t=Math.min(r.runAt-e,_m);Io=va.setTimeout(Tm,t)}function Tm(){const r=Date.now(),e=[];for(;;){const t=ai[0];if(!t||t.runAt>r)break;const i=ai.shift();Rm("runCallbacks: popping",i.key),e.push(i)}Wa();for(const t of e)try{t.func.apply(va,t.params)}catch(i){d.error("Uncaught exception in callback function",i)}}function Cm(r,e){let t=0,i=r.length;for(;t<i;){const n=t+i>>1;e(r[n])>0?i=n:t=n+1}return t}var Ro={};class km extends wm{constructor(){super(...arguments),this.uploads=[]}uploadContent(e,t={}){const i=t.includeFilename??!0,n=t.abortController??new AbortController,s=(t.type??e.type)||"application/octet-stream",o=t.name??e.name,a={loaded:0,total:0,abortController:n},c=Nn();if(Ro.XMLHttpRequest){const l=new Ro.XMLHttpRequest,u=function(){l.abort(),c.reject(new Error("Timeout"))};let h=sl(u,3e4);l.onreadystatechange=function(){switch(l.readyState){case Ro.XMLHttpRequest.DONE:ol(h);try{if(l.status===0)throw new DOMException(l.statusText,"AbortError");if(!l.responseText)throw new Error("No response body.");l.status>=400?c.reject(su(l,l.responseText)):c.resolve(JSON.parse(l.responseText))}catch(g){if(g.name==="AbortError"){c.reject(g);return}c.reject(new to("request failed",g))}break}},l.upload.onprogress=g=>{var m;ol(h),a.loaded=g.loaded,a.total=g.total,h=sl(u,3e4),(m=t.progressHandler)==null||m.call(t,{loaded:g.loaded,total:g.total})};const f=this.getUrl("/upload",void 0,Cn.V3);i&&o&&f.searchParams.set("filename",encodeURIComponent(o)),!this.opts.useAuthorizationHeader&&this.opts.accessToken&&f.searchParams.set("access_token",encodeURIComponent(this.opts.accessToken)),l.open(D.Post,f.href),this.opts.useAuthorizationHeader&&this.opts.accessToken&&l.setRequestHeader("Authorization","Bearer "+this.opts.accessToken),l.setRequestHeader("Content-Type",s),l.send(e),n.signal.addEventListener("abort",()=>{l.abort()})}else{const l={};i&&o&&(l.filename=o);const u={"Content-Type":s};this.authedRequest(D.Post,"/upload",l,e,{prefix:Cn.V3,headers:u,abortSignal:n.signal}).then(h=>this.opts.onlyData?h:h.json()).then(c.resolve,c.reject)}return a.promise=c.promise.finally(()=>{Rs(this.uploads,l=>l===a)}),n.signal.addEventListener("abort",()=>{Rs(this.uploads,l=>l===a),c.reject(new DOMException("Aborted","AbortError"))}),this.uploads.push(a),a.promise}cancelUpload(e){const t=this.uploads.find(i=>i.promise===e);return t?(t.abortController.abort(),!0):!1}getCurrentUploads(){return this.uploads}getContentUri(){return{base:this.opts.baseUrl,path:Cn.V3+"/upload",params:{access_token:this.opts.accessToken}}}}var He=(r=>(r[r.Stable=0]="Stable",r[r.Unstable=1]="Unstable",r[r.Unsupported=2]="Unsupported",r))(He||{}),yt=(r=>(r.Thread="Thread",r.ThreadUnreadNotifications="ThreadUnreadNotifications",r.LoginTokenRequest="LoginTokenRequest",r.RelationBasedRedactions="RelationBasedRedactions",r.AccountDataDeletion="AccountDataDeletion",r.RelationsRecursion="RelationsRecursion",r.IntentionalMentions="IntentionalMentions",r))(yt||{});const Om={Thread:{unstablePrefixes:["org.matrix.msc3440"],matrixVersion:"v1.3"},ThreadUnreadNotifications:{unstablePrefixes:["org.matrix.msc3771","org.matrix.msc3773"],matrixVersion:"v1.4"},LoginTokenRequest:{unstablePrefixes:["org.matrix.msc3882"]},RelationBasedRedactions:{unstablePrefixes:["org.matrix.msc3912"]},AccountDataDeletion:{unstablePrefixes:["org.matrix.msc3391"]},RelationsRecursion:{unstablePrefixes:["org.matrix.msc3981"]},IntentionalMentions:{unstablePrefixes:["org.matrix.msc3952_intentional_mentions"],matrixVersion:"v1.7"}};async function Mm(r){var t,i;const e=new Map;for(const[n,s]of Object.entries(Om)){const o=((t=r.versions)==null?void 0:t.includes(s.matrixVersion||""))??!1,a=((i=s.unstablePrefixes)==null?void 0:i.every(c=>{var l;return((l=r.unstable_features)==null?void 0:l[c])===!0}))??!1;o?e.set(n,0):a?e.set(n,1):e.set(n,2)}return e}var al={};const cl=80*1e3,Am=3;var st=(r=>(r.Error="ERROR",r.Prepared="PREPARED",r.Stopped="STOPPED",r.Syncing="SYNCING",r.Catchup="CATCHUP",r.Reconnecting="RECONNECTING",r))(st||{});const Pm=["org.matrix.msc2716v3"];function ll(r,e){return`FILTER_SYNC_${r}`+(e?"_"+e:"")}function Re(...r){d.log(...r)}function au(r){return{initialSyncLimit:8,resolveInvitesToProfiles:!1,pollTimeout:30*1e3,pendingEventOrdering:Ln.Chronological,threadSupport:!1,...r}}function cu(r){return{canResetEntireTimeline:e=>!1,...r}}class pr{constructor(e,t,i){this.client=e,this._peekRoom=null,this.syncState=null,this.catchingUp=!1,this.running=!1,this.notifEvents=[],this.failedSyncCount=0,this.storeIsInvalid=!1,this.getPushRules=async()=>{try{Re("Getting push rules...");const n=await this.client.getPushRules();Re("Got push rules"),this.client.pushRules=n}catch(n){return d.error("Getting push rules failed",n),this.shouldAbortSync(n)?void 0:(Re("Waiting for saved sync before retrying push rules..."),await this.recoverFromSyncStartupError(this.savedSyncPromise,n),this.getPushRules())}},this.buildDefaultFilter=()=>{const n=new It(this.client.credentials.userId);return this.client.canSupport.get(yt.ThreadUnreadNotifications)!==He.Unsupported&&n.setUnreadThreadNotifications(!0),n},this.prepareLazyLoadingForSync=async()=>{var n;Re("Prepare lazy loading for sync..."),this.client.isGuest()&&(this.opts.lazyLoadMembers=!1),this.opts.lazyLoadMembers&&(Re("Enabling lazy load on sync filter..."),this.opts.filter||(this.opts.filter=this.buildDefaultFilter()),this.opts.filter.setLazyLoadMembers(!0)),this.opts.lazyLoadMembers&&((n=this.syncOpts.crypto)==null||n.enableLazyLoading())},this.storeClientOptions=async()=>{try{Re("Storing client options..."),await this.client.storeClientOptions(),Re("Stored client options")}catch(n){throw d.error("Storing client options failed",n),n}},this.getFilter=async()=>{Re("Getting filter...");let n;this.opts.filter?n=this.opts.filter:n=this.buildDefaultFilter();let s;try{s=await this.client.getOrCreateFilter(ll(this.client.credentials.userId),n)}catch(o){return d.error("Getting filter failed",o),this.shouldAbortSync(o)?{}:(Re("Waiting for saved sync before retrying filter..."),await this.recoverFromSyncStartupError(this.savedSyncPromise,o),this.getFilter())}return{filter:n,filterId:s}},this.onOnline=()=>{Re("Browser thinks we are back online"),this.startKeepAlives(0)},this.opts=au(t),this.syncOpts=cu(i),e.getNotifTimelineSet()&&e.reEmitter.reEmit(e.getNotifTimelineSet(),[de.Timeline,de.TimelineReset])}createRoom(e){const t=lu(this.client,e,this.opts);return t.on(fe.Marker,(i,n)=>{this.onMarkerStateEvent(t,i,n)}),t}onMarkerStateEvent(e,t,{timelineWasEmpty:i}={}){if(i){d.debug(`MarkerState: Ignoring markerEventId=${t.getId()} in roomId=${e.roomId} because the timeline was empty before the marker arrived which means there is nothing to refresh.`);return}Pm.includes(e.getVersion())||t.getSender()===e.getCreator()?(d.debug(`MarkerState: Timeline needs to be refreshed because a new markerEventId=${t.getId()} was sent in roomId=${e.roomId}`),e.setTimelineNeedsRefresh(!0),e.emit(de.HistoryImportedWithinTimeline,t,e)):d.debug(`MarkerState: Ignoring markerEventId=${t.getId()} in roomId=${e.roomId} because MSC2716 is not supported in the room version or for any room version, the marker wasn't sent by the room creator.`)}async syncLeftRooms(){var l;const e=this.client,t=new It(this.client.credentials.userId);t.setTimelineLimit(1),t.setIncludeLeaveRooms(!0);const i=this.opts.pollTimeout+cl,s={timeout:0,filter:await e.getOrCreateFilter(ll(e.credentials.userId,"LEFT_ROOMS"),t)},o=await e.http.authedRequest(D.Get,"/sync",s,void 0,{localTimeoutMs:i});let a=[];return(l=o.rooms)!=null&&l.leave&&(a=this.mapSyncResponseToRoomArray(o.rooms.leave)),(await Promise.all(a.map(async u=>{const h=u.room;if(!u.isBrandNewRoom)return;u.timeline=u.timeline||{prev_batch:null,events:[]};const f=this.mapSyncEventsFormat(u.timeline,h),g=this.mapSyncEventsFormat(u.state,h);return h.getLiveTimeline().setPaginationToken(u.timeline.prev_batch,ee.BACKWARDS),await this.injectRoomEvents(h,g,f),h.recalculate(),e.store.storeRoom(h),e.emit(ie.Room,h),this.processEventsForNotifs(h,f),h}))).filter(Boolean)}peek(e){var i;if(((i=this._peekRoom)==null?void 0:i.roomId)===e)return Promise.resolve(this._peekRoom);const t=this.client;return this._peekRoom=this.createRoom(e),this.client.roomInitialSync(e,20).then(n=>{var c;if(((c=this._peekRoom)==null?void 0:c.roomId)!==e)throw new Error("Peeking aborted");n.messages=n.messages||{chunk:[]},n.messages.chunk=n.messages.chunk||[],n.state=n.state||[];const s=wd(n.state).map(t.getEventMapper()),o=n.state.map(t.getEventMapper()),a=n.messages.chunk.map(t.getEventMapper());return Array.isArray(n.presence)&&n.presence.map(t.getEventMapper()).forEach(function(l){let u=t.store.getUser(l.getContent().user_id);u?u.setPresenceEvent(l):(u=ki.createUser(l.getContent().user_id,t),u.setPresenceEvent(l),t.store.storeUser(u)),t.emit(ie.Event,l)}),n.messages.start&&(this._peekRoom.oldState.paginationToken=n.messages.start),this._peekRoom.oldState.setStateEvents(s),this._peekRoom.currentState.setStateEvents(o),this.resolveInvites(this._peekRoom),this._peekRoom.recalculate(),this._peekRoom.addEventsToTimeline(a.reverse(),!0,this._peekRoom.getLiveTimeline(),n.messages.start),t.store.storeRoom(this._peekRoom),t.emit(ie.Room,this._peekRoom),this.peekPoll(this._peekRoom),this._peekRoom})}stopPeeking(){this._peekRoom=null}peekPoll(e,t){var i;if(this._peekRoom!==e){Re("Stopped peeking in room %s",e.roomId);return}this.client.http.authedRequest(D.Get,"/events",{room_id:e.roomId,timeout:String(30*1e3),from:t},void 0,{localTimeoutMs:50*1e3,abortSignal:(i=this.abortController)==null?void 0:i.signal}).then(async n=>{if(this._peekRoom!==e){Re("Stopped peeking in room %s",e.roomId);return}n.chunk.filter(function(o){return o.type==="m.presence"}).map(this.client.getEventMapper()).forEach(o=>{let a=this.client.store.getUser(o.getContent().user_id);a?a.setPresenceEvent(o):(a=ki.createUser(o.getContent().user_id,this.client),a.setPresenceEvent(o),this.client.store.storeUser(a)),this.client.emit(ie.Event,o)});const s=n.chunk.filter(function(o){return o.room_id===e.roomId&&o.event_id}).map(this.client.getEventMapper());await e.addLiveEvents(s),this.peekPoll(e,n.end)},n=>{d.error("[%s] Peek poll failed: %s",e.roomId,n),setTimeout(()=>{this.peekPoll(e,t)},30*1e3)})}getSyncState(){return this.syncState}getSyncStateData(){return this.syncStateData??null}async recoverFromSyncStartupError(e,t){await e;const i=this.startKeepAlives();this.updateSyncState("ERROR",{error:t}),await i}shouldAbortSync(e){return e.errcode==="M_UNKNOWN_TOKEN"?(d.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState("ERROR",{error:e}),!0):!1}async sync(){var n,s;if(this.running=!0,this.abortController=new AbortController,(s=(n=al.window)==null?void 0:n.addEventListener)==null||s.call(n,"online",this.onOnline,!1),this.client.isGuest())return this.doSync({});Re("Getting saved sync token...");const e=this.client.store.getSavedSyncToken().then(o=>(Re("Got saved sync token"),o));this.savedSyncPromise=this.client.store.getSavedSync().then(o=>{if(Re(`Got reply from saved sync, exists? ${!!o}`),o)return this.syncFromCache(o)}).catch(o=>{d.error("Getting saved sync failed",o)}),await this.getPushRules(),await this.prepareLazyLoadingForSync(),await this.storeClientOptions();const{filterId:t,filter:i}=await this.getFilter();if(i){if(this.client.resetNotifTimelineSet(),!this.currentSyncRequest){let o=t;const a=await e;if(a)Re("Sending first sync request...");else{Re("Sending initial sync request...");const c=this.buildDefaultFilter();c.setDefinition(i.getDefinition()),c.setTimelineLimit(this.opts.initialSyncLimit),o=JSON.stringify(c.getDefinition())}this.currentSyncRequest=this.doSyncRequest({filter:o},a)}return Re("Waiting for saved sync before starting sync processing..."),await this.savedSyncPromise,this.doSync({filter:t})}}stop(){var e,t,i;Re("SyncApi.stop"),(t=(e=al.window)==null?void 0:e.removeEventListener)==null||t.call(e,"online",this.onOnline,!1),this.running=!1,(i=this.abortController)==null||i.abort(),this.keepAliveTimer&&(clearTimeout(this.keepAliveTimer),this.keepAliveTimer=void 0)}retryImmediately(){return this.connectionReturnedDefer?(this.startKeepAlives(0),!0):!1}async syncFromCache(e){Re("sync(): not doing HTTP hit, instead returning stored /sync data");const t=e.nextBatch;this.client.store.setSyncToken(t);const i={nextSyncToken:t,catchingUp:!1,fromCache:!0},n={next_batch:t,rooms:e.roomsData,account_data:{events:e.accountData}};try{await this.processSyncResponse(i,n)}catch(s){d.error("Error processing cached sync",s)}this.storeIsInvalid||this.updateSyncState("PREPARED",i)}async doSync(e){for(;this.running;){const t=this.client.store.getSyncToken();let i;try{this.currentSyncRequest||(this.currentSyncRequest=this.doSyncRequest(e,t)),i=await this.currentSyncRequest}catch(s){if(await this.onSyncError(s))return;continue}finally{this.currentSyncRequest=void 0}this.client.store.setSyncToken(i.next_batch),this.failedSyncCount=0;const n={oldSyncToken:t??void 0,nextSyncToken:i.next_batch,catchingUp:this.catchingUp};this.syncOpts.crypto&&await this.syncOpts.crypto.onSyncWillProcess(n);try{await this.processSyncResponse(n,i)}catch(s){d.error("Caught /sync error",s),this.client.emit(ie.SyncUnexpectedError,s)}await this.client.store.setSyncData(i),n.catchingUp=this.catchingUp,e.hasSyncedBefore||(this.updateSyncState("PREPARED",n),e.hasSyncedBefore=!0),this.syncOpts.cryptoCallbacks&&await this.syncOpts.cryptoCallbacks.onSyncCompleted(n),this.updateSyncState("SYNCING",n),this.client.store.wantsSave()&&(this.syncOpts.crypto&&await this.syncOpts.crypto.saveDeviceList(0),await this.client.store.save())}this.running||(Re("Sync no longer running: exiting."),this.connectionReturnedDefer&&(this.connectionReturnedDefer.reject(),this.connectionReturnedDefer=void 0),this.updateSyncState("STOPPED"))}doSyncRequest(e,t){var n;const i=this.getSyncParams(e,t);return this.client.http.authedRequest(D.Get,"/sync",i,void 0,{localTimeoutMs:i.timeout+cl,abortSignal:(n=this.abortController)==null?void 0:n.signal})}getSyncParams(e,t){let i=this.opts.pollTimeout;(this.getSyncState()!=="SYNCING"||this.catchingUp)&&(this.catchingUp=!0,i=0);let n=e.filter;this.client.isGuest()&&!n&&(n=this.getGuestFilter());const s={filter:n,timeout:i};return this.opts.disablePresence?s.set_presence="offline":this.presence!==void 0&&(s.set_presence=this.presence),t?s.since=t:s._cacheBuster=Date.now(),["RECONNECTING","ERROR"].includes(this.getSyncState())&&(s.timeout=0),s}setPresence(e){this.presence=e}async onSyncError(e){if(!this.running)return Re("Sync no longer running: exiting"),this.connectionReturnedDefer&&(this.connectionReturnedDefer.reject(),this.connectionReturnedDefer=void 0),this.updateSyncState("STOPPED"),!0;if(d.error("/sync error %s",e),this.shouldAbortSync(e))return!0;this.failedSyncCount++,d.log("Number of consecutive failed sync requests:",this.failedSyncCount),Re("Starting keep-alive");const t=this.startKeepAlives();return this.currentSyncRequest=void 0,this.updateSyncState(this.failedSyncCount>=Am?"ERROR":"RECONNECTING",{error:e}),await t&&this.getSyncState()==="ERROR"&&this.updateSyncState("CATCHUP",{catchingUp:!0}),!1}async processSyncResponse(e,t){var c,l,u;const i=this.client;if(Array.isArray((c=t.presence)==null?void 0:c.events)&&t.presence.events.filter(Dt).map(i.getEventMapper()).forEach(function(h){let f=i.store.getUser(h.getSender());f?f.setPresenceEvent(h):(f=ki.createUser(h.getSender(),i),f.setPresenceEvent(h),i.store.storeUser(f)),i.emit(ie.Event,h)}),Array.isArray((l=t.account_data)==null?void 0:l.events)){const h=t.account_data.events.filter(Dt).map(i.getEventMapper()),f=h.reduce((g,m)=>(g[m.getType()]=i.store.getAccountData(m.getType()),g),{});i.store.storeAccountDataEvents(h),h.forEach(function(g){if(g.getType()===R.PushRules){const v=g.getContent();i.setPushRules(v)}const m=f[g.getType()];return i.emit(ie.AccountData,g,m),g})}if(t.to_device&&Array.isArray(t.to_device.events)&&t.to_device.events.length>0){let h=t.to_device.events.filter(Dt);this.syncOpts.cryptoCallbacks&&(h=await this.syncOpts.cryptoCallbacks.preprocessToDeviceMessages(h));const f=[];h.map(i.getEventMapper({toDevice:!0})).map(g=>{if(g.getType()==="m.key.verification.cancel"){const m=g.getContent().transaction_id;m&&f.push(m)}return g}).forEach(function(g){const m=g.getContent();if(g.getType()=="m.room.message"&&m.msgtype=="m.bad.encrypted"){d.log("Ignoring undecryptable to-device event from "+g.getSender());return}if(g.getType()==="m.key.verification.start"||g.getType()==="m.key.verification.request"){const v=m.transaction_id;f.includes(v)&&g.flagCancelled()}i.emit(ie.ToDeviceEvent,g)})}else this.catchingUp=!1;let n=[],s=[],o=[],a=[];t.rooms&&(t.rooms.invite&&(n=this.mapSyncResponseToRoomArray(t.rooms.invite)),t.rooms.join&&(s=this.mapSyncResponseToRoomArray(t.rooms.join)),t.rooms.leave&&(o=this.mapSyncResponseToRoomArray(t.rooms.leave)),t.rooms.knock&&(a=this.mapSyncResponseToRoomArray(t.rooms.knock))),this.notifEvents=[],await bn(n,async h=>{var S;const f=h.room,g=this.mapSyncEventsFormat(h.invite_state,f);await this.injectRoomEvents(f,g);const m=(S=f.currentState.getStateEvents(R.RoomMember,i.getUserId()))==null?void 0:S.getSender(),v=i.crypto;if(v){const w=await v.cryptoStore.takeParkedSharedHistory(f.roomId);for(const M of w)M.senderId===m&&await v.olmDevice.addInboundGroupSession(f.roomId,M.senderKey,M.forwardingCurve25519KeyChain,M.sessionId,M.sessionKey,M.keysClaimed,!0,{sharedHistory:!0,untrusted:!0})}h.isBrandNewRoom?(f.recalculate(),i.store.storeRoom(f),i.emit(ie.Room,f)):f.recalculate(),g.forEach(function(w){i.emit(ie.Event,w)})}),await bn(s,async h=>{const f=h.room,g=this.mapSyncEventsFormat(h.state,f),m=this.mapSyncEventsFormat(h.timeline,f,!1),v=this.mapSyncEventsFormat(h.ephemeral),S=this.mapSyncEventsFormat(h.account_data),w=this.isRoomEncrypted(f,g,m);h.unread_notifications&&((!w||h.unread_notifications.notification_count===0)&&f.setUnreadNotificationCount(Be.Total,h.unread_notifications.notification_count??0),(!w||f.getUnreadNotificationCount(Be.Highlight)<=0)&&f.setUnreadNotificationCount(Be.Highlight,h.unread_notifications.highlight_count??0));const M=h[ua.name]??h[ua.altName];if(M){f.resetThreadUnreadNotificationCountFromSync(Object.keys(M));for(const[C,A]of Object.entries(M)){(!w||A.notification_count===0)&&f.setThreadUnreadNotificationCount(C,Be.Total,A.notification_count??0);const y=f.getThreadUnreadNotificationCount(C,Be.Highlight)<=0;(!w||w&&y)&&f.setThreadUnreadNotificationCount(C,Be.Highlight,A.highlight_count??0)}}else f.resetThreadUnreadNotificationCountFromSync();if(h.timeline=h.timeline||{},h.isBrandNewRoom)h.timeline.prev_batch!==null&&f.getLiveTimeline().setPaginationToken(h.timeline.prev_batch,ee.BACKWARDS);else if(h.timeline.limited){let C=!0;for(let A=m.length-1;A>=0;A--){const y=m[A].getId();if(f.getTimelineForEvent(y)){Re(`Already have event ${y} in limited sync - not resetting`),C=!1,m.splice(0,A);break}}C&&(f.resetLiveTimeline(h.timeline.prev_batch,this.syncOpts.canResetEntireTimeline(f.roomId)?null:e.oldSyncToken??null),i.resetNotifTimelineSet())}if(this.syncOpts.cryptoCallbacks)for(const C of g.concat(m))C.isState()&&C.getType()===R.RoomEncryption&&C.getStateKey()===""&&await this.syncOpts.cryptoCallbacks.onCryptoEvent(f,C);try{await this.injectRoomEvents(f,g,m,e.fromCache)}catch(C){d.error(`Failed to process events on room ${f.roomId}:`,C)}h.summary&&f.setSummary(h.summary),f.addEphemeralEvents(v),f.addAccountData(S),f.recalculate(),h.isBrandNewRoom&&(i.store.storeRoom(f),i.emit(ie.Room,f)),this.processEventsForNotifs(f,m);const _=C=>i.emit(ie.Event,C);g.forEach(_),m.forEach(_),v.forEach(_),S.forEach(_),f.decryptCriticalEvents()}),await bn(o,async h=>{const f=h.room,g=this.mapSyncEventsFormat(h.state,f),m=this.mapSyncEventsFormat(h.timeline,f),v=this.mapSyncEventsFormat(h.account_data);await this.injectRoomEvents(f,g,m),f.addAccountData(v),f.recalculate(),h.isBrandNewRoom&&(i.store.storeRoom(f),i.emit(ie.Room,f)),this.processEventsForNotifs(f,m),g.forEach(function(S){i.emit(ie.Event,S)}),m.forEach(function(S){i.emit(ie.Event,S)}),v.forEach(function(S){i.emit(ie.Event,S)})}),await bn(a,async h=>{const f=h.room,g=this.mapSyncEventsFormat(h.knock_state,f);await this.injectRoomEvents(f,g),h.isBrandNewRoom?(f.recalculate(),i.store.storeRoom(f),i.emit(ie.Room,f)):f.recalculate(),g.forEach(function(m){i.emit(ie.Event,m)})}),e.oldSyncToken&&this.notifEvents.length&&(this.notifEvents.sort(function(h,f){return h.getTs()-f.getTs()}),this.notifEvents.forEach(function(h){var f;(f=i.getNotifTimelineSet())==null||f.addLiveEvent(h)})),t.device_lists&&this.syncOpts.cryptoCallbacks&&await this.syncOpts.cryptoCallbacks.processDeviceLists(t.device_lists),await((u=this.syncOpts.cryptoCallbacks)==null?void 0:u.processKeyCounts(t.device_one_time_keys_count,t.device_unused_fallback_key_types??t["org.matrix.msc2732.device_unused_fallback_key_types"]))}startKeepAlives(e){return e===void 0&&(e=2e3+Math.floor(Math.random()*5e3)),this.keepAliveTimer!==null&&clearTimeout(this.keepAliveTimer),e>0?this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this),e):this.pokeKeepAlive(),this.connectionReturnedDefer||(this.connectionReturnedDefer=Nn()),this.connectionReturnedDefer.promise}pokeKeepAlive(e=!1){var i;if(!this.running){clearTimeout(this.keepAliveTimer),this.connectionReturnedDefer&&(this.connectionReturnedDefer.reject("SyncApi.stop() was called"),this.connectionReturnedDefer=void 0);return}const t=()=>{clearTimeout(this.keepAliveTimer),this.connectionReturnedDefer&&(this.connectionReturnedDefer.resolve(e),this.connectionReturnedDefer=void 0)};this.client.http.request(D.Get,"/_matrix/client/versions",void 0,void 0,{prefix:"",localTimeoutMs:15*1e3,abortSignal:(i=this.abortController)==null?void 0:i.signal}).then(()=>{t()},n=>{n.httpStatus==400||n.httpStatus==404?this.keepAliveTimer=setTimeout(t,2e3):(e=!0,this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this,e),5e3+Math.floor(Math.random()*5e3)),this.updateSyncState("ERROR",{error:n}))})}mapSyncResponseToRoomArray(e){const t=this.client;return Object.keys(e).filter(i=>!wn(i)).map(i=>{let n=t.store.getRoom(i),s=!1;return n||(n=this.createRoom(i),s=!0),{...e[i],room:n,isBrandNewRoom:s}})}mapSyncEventsFormat(e,t,i=!0){if(!e||!Array.isArray(e.events))return[];const n=this.client.getEventMapper({decrypt:i});return e.events.filter(Dt).map(function(s){return t&&(s.room_id=t.roomId),n(s)})}resolveInvites(e){if(!e||!this.opts.resolveInvitesToProfiles)return;const t=this.client;e.getMembersWithMembership(ae.Invite).forEach(function(i){if(i.requestedProfileInfo)return;i.requestedProfileInfo=!0;const n=t.getUser(i.userId);let s;n?s=Promise.resolve({avatar_url:n.avatarUrl,displayname:n.displayName}):s=t.getProfileInfo(i.userId),s.then(function(o){const a=i.events.member;(a==null?void 0:a.getContent().membership)===ae.Invite&&(a.getContent().avatar_url=o.avatar_url,a.getContent().displayname=o.displayname,i.setMembershipEvent(a,e.currentState))},function(o){})})}findEncryptionEvent(e){return e==null?void 0:e.find(t=>t.getType()===R.RoomEncryption&&t.getStateKey()==="")}isRoomEncrypted(e,t,i){return e.hasEncryptionStateEvent()||!!this.findEncryptionEvent(t)||!!this.findEncryptionEvent(i)}async injectRoomEvents(e,t,i,n=!1){const s=e.getLiveTimeline(),o=s.getEvents().length==0;if(o){for(const a of t)this.client.getPushActionsForEvent(a);s.initialiseState(t,{timelineWasEmpty:o})}this.resolveInvites(e),e.recalculate(),o||(e.oldState.setStateEvents(t||[]),e.currentState.setStateEvents(t||[])),await e.addLiveEvents(i||[],{fromCache:n,timelineWasEmpty:o}),this.client.processBeaconEvents(e,i)}processEventsForNotifs(e,t){var i;if(this.client.getNotifTimelineSet())for(const n of t){const s=this.client.getPushActionsForEvent(n);s!=null&&s.notify&&((i=s.tweaks)!=null&&i.highlight)&&this.notifEvents.push(n)}}getGuestFilter(){return"{}"}updateSyncState(e,t){const i=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit(ie.Sync,this.syncState,i,t)}}function lu(r,e,t){const{timelineSupport:i}=r,n=new Ga(e,r,r.getUserId(),{lazyLoadMembers:t.lazyLoadMembers,pendingEventOrdering:t.pendingEventOrdering,timelineSupport:i});return r.reEmitter.reEmit(n,[de.Name,de.Redaction,de.RedactionCancelled,de.Receipt,de.Tags,de.LocalEchoUpdated,de.AccountData,de.MyMembership,de.Timeline,de.TimelineReset,fe.Events,fe.Members,fe.NewMember,fe.Update,Ke.New,Ke.Update,Ke.Destroy,Ke.LivenessChange]),n.on(fe.NewMember,(s,o,a)=>{a.user=r.getUser(a.userId)??void 0,r.reEmitter.reEmit(a,[Nt.Name,Nt.Typing,Nt.PowerLevel,Nt.Membership])}),n}class Dm{constructor(){this.accountData=new Map,this.fromToken=null}isNewlyCreated(){return Promise.resolve(!0)}getSyncToken(){return this.fromToken}setSyncToken(e){this.fromToken=e}storeRoom(e){}getRoom(e){return null}getRooms(){return[]}removeRoom(e){}getRoomSummaries(){return[]}storeUser(e){}getUser(e){return null}getUsers(){return[]}scrollback(e,t){return[]}setUserCreator(e){}storeEvents(e,t,i,n){}storeFilter(e){}getFilter(e,t){return null}getFilterIdByName(e){return null}setFilterIdByName(e,t){}storeAccountDataEvents(e){}getAccountData(e){}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(){return Promise.resolve()}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return Promise.resolve()}getOutOfBandMembers(){return Promise.resolve(null)}setOutOfBandMembers(e,t){return Promise.resolve()}clearOutOfBandMembers(){return Promise.resolve()}getClientOptions(){return Promise.resolve(void 0)}storeClientOptions(e){return Promise.resolve()}async getPendingEvents(e){return[]}setPendingEvents(e,t){return Promise.resolve()}async saveToDeviceBatches(e){return Promise.resolve()}getOldestToDeviceBatch(){return Promise.resolve(null)}async removeToDeviceBatch(e){return Promise.resolve()}async destroy(){}}let Qr;const Um=new Uint8Array(16);function Lm(){if(!Qr&&(Qr=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Qr))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Qr(Um)}const We=[];for(let r=0;r<256;++r)We.push((r+256).toString(16).slice(1));function Nm(r,e=0){return We[r[e+0]]+We[r[e+1]]+We[r[e+2]]+We[r[e+3]]+"-"+We[r[e+4]]+We[r[e+5]]+"-"+We[r[e+6]]+We[r[e+7]]+"-"+We[r[e+8]]+We[r[e+9]]+"-"+We[r[e+10]]+We[r[e+11]]+We[r[e+12]]+We[r[e+13]]+We[r[e+14]]+We[r[e+15]]}const Km=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),dl={randomUUID:Km};function Kt(r,e,t){if(dl.randomUUID&&!e&&!r)return dl.randomUUID();r=r||{};const i=r.random||(r.rng||Lm)();if(i[6]=i[6]&15|64,i[8]=i[8]&63|128,e){t=t||0;for(let n=0;n<16;++n)e[t+n]=i[n];return e}return Nm(i)}var du={},uu={exports:{}},ul=uu.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(r){return r.encoding?"rtpmap:%d %s/%s/%s":r.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(r){return r.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(r){return r.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(r){return"extmap:%d"+(r.direction?"/%s":"%v")+(r["encrypt-uri"]?" %s":"%v")+" %s"+(r.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(r){return r.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(r){var e="candidate:%s %d %s %d %s %d typ %s";return e+=r.raddr!=null?" raddr %s rport %d":"%v%v",e+=r.tcptype!=null?" tcptype %s":"%v",r.generation!=null&&(e+=" generation %d"),e+=r["network-id"]!=null?" network-id %d":"%v",e+=r["network-cost"]!=null?" network-cost %d":"%v",e}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(r){var e="ssrc:%d";return r.attribute!=null&&(e+=" %s",r.value!=null&&(e+=":%s")),e}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(r){return r.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(r){return r.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(r){return"imageattr:%s %s %s"+(r.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(r){return"simulcast:%s %s"+(r.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(r){return"ts-refclk:%s"+(r.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(r){var e="mediaclk:";return e+=r.id!=null?"id=%s %s":"%v%s",e+=r.mediaClockValue!=null?"=%s":"",e+=r.rateNumerator!=null?" rate=%s":"",e+=r.rateDenominator!=null?"/%s":"",e}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(ul).forEach(function(r){var e=ul[r];e.forEach(function(t){t.reg||(t.reg=/(.*)/),t.format||(t.format="%s")})});var hu=uu.exports;(function(r){var e=function(a){return String(Number(a))===a?Number(a):a},t=function(a,c,l,u){if(u&&!l)c[u]=e(a[1]);else for(var h=0;h<l.length;h+=1)a[h+1]!=null&&(c[l[h]]=e(a[h+1]))},i=function(a,c,l){var u=a.name&&a.names;a.push&&!c[a.push]?c[a.push]=[]:u&&!c[a.name]&&(c[a.name]={});var h=a.push?{}:u?c[a.name]:c;t(l.match(a.reg),h,a.names,a.name),a.push&&c[a.push].push(h)},n=hu,s=RegExp.prototype.test.bind(/^([a-z])=(.*)/);r.parse=function(a){var c={},l=[],u=c;return a.split(/(\r\n|\r|\n)/).filter(s).forEach(function(h){var f=h[0],g=h.slice(2);f==="m"&&(l.push({rtp:[],fmtp:[]}),u=l[l.length-1]);for(var m=0;m<(n[f]||[]).length;m+=1){var v=n[f][m];if(v.reg.test(g))return i(v,u,g)}}),c.media=l,c};var o=function(a,c){var l=c.split(/=(.+)/,2);return l.length===2?a[l[0]]=e(l[1]):l.length===1&&c.length>1&&(a[l[0]]=void 0),a};r.parseParams=function(a){return a.split(/;\s?/).reduce(o,{})},r.parseFmtpConfig=r.parseParams,r.parsePayloads=function(a){return a.toString().split(" ").map(Number)},r.parseRemoteCandidates=function(a){for(var c=[],l=a.split(" ").map(e),u=0;u<l.length;u+=3)c.push({component:l[u],ip:l[u+1],port:l[u+2]});return c},r.parseImageAttributes=function(a){return a.split(" ").map(function(c){return c.substring(1,c.length-1).split(",").reduce(o,{})})},r.parseSimulcastStreamList=function(a){return a.split(";").map(function(c){return c.split(",").map(function(l){var u,h=!1;return l[0]!=="~"?u=e(l):(u=e(l.substring(1,l.length)),h=!0),{scid:u,paused:h}})})}})(du);var To=hu,Fm=/%[sdv%]/g,$m=function(r){var e=1,t=arguments,i=t.length;return r.replace(Fm,function(n){if(e>=i)return n;var s=t[e];switch(e+=1,n){case"%%":return"%";case"%s":return String(s);case"%d":return Number(s);case"%v":return""}})},tr=function(r,e,t){var i=e.format instanceof Function?e.format(e.push?t:t[e.name]):e.format,n=[r+"="+i];if(e.names)for(var s=0;s<e.names.length;s+=1){var o=e.names[s];e.name?n.push(t[e.name][o]):n.push(t[e.names[s]])}else n.push(t[e.name]);return $m.apply(null,n)},Bm=["v","o","s","i","u","e","p","c","b","t","r","z","a"],xm=["i","c","b","a"],qm=function(r,e){e=e||{},r.version==null&&(r.version=0),r.name==null&&(r.name=" "),r.media.forEach(function(s){s.payloads==null&&(s.payloads="")});var t=e.outerOrder||Bm,i=e.innerOrder||xm,n=[];return t.forEach(function(s){To[s].forEach(function(o){o.name in r&&r[o.name]!=null?n.push(tr(s,o,r)):o.push in r&&r[o.push]!=null&&r[o.push].forEach(function(a){n.push(tr(s,o,a))})})}),r.media.forEach(function(s){n.push(tr("m",To.m[0],s)),i.forEach(function(o){To[o].forEach(function(a){a.name in s&&s[a.name]!=null?n.push(tr(o,a,s)):a.push in s&&s[a.push]!=null&&s[a.push].forEach(function(c){n.push(tr(o,a,c))})})})}),n.join(`\r
`)+`\r
`},sn=du,Vm=qm,jm=Vm,fu=sn.parse;sn.parseParams;sn.parseFmtpConfig;sn.parsePayloads;sn.parseRemoteCandidates;sn.parseImageAttributes;sn.parseSimulcastStreamList;function lt(r){if(typeof Buffer=="function")return Buffer.from(r).toString("base64");if(typeof btoa=="function"&&r instanceof Uint8Array)return btoa(r.reduce((e,t)=>e+String.fromCharCode(t),""));throw new Error("No base64 impl found!")}function Ha(r){return lt(r).replace(/={1,2}$/,"")}function Gm(r){return Ha(r).replace("+","-").replace("/","_")}function tt(r){if(typeof Buffer=="function")return Buffer.from(r,"base64");if(typeof atob=="function"){const e=function*(){const t=atob(r.replace("-","+").replace("_","/"));for(let i=0;i<t.length;++i)yield t.charCodeAt(i)};return Uint8Array.from(e())}else throw new Error("No base64 impl found!")}let rt=globalThis.crypto,bt=(rt==null?void 0:rt.subtle)??(rt==null?void 0:rt.webkitSubtle),Yi=globalThis.TextEncoder;if(!rt)try{rt=require("crypto").webcrypto}catch(r){d.error("Failed to load webcrypto",r)}bt||(bt=rt==null?void 0:rt.subtle);if(!Yi)try{Yi=require("util").TextEncoder}catch(r){d.error("Failed to load TextEncoder util",r)}const Wm="abcdefghijklmnopqrstuvwxyz",Hm="ABCDEFGHIJKLMNOPQRSTUVWXYZ",Jm="0123456789";function zm(r){const e=new Uint8Array(r);return rt.getRandomValues(e),Gm(e)}function rn(r){return Ym(r,Hm+Wm+Jm)}function Ym(r,e){let t="";for(let i=0;i<r;++i)t+=e.charAt(Math.floor(Math.random()*e.length));return t}const yi="org.matrix.msc3077.sdp_stream_metadata";var Ee=(r=>(r.Usermedia="m.usermedia",r.Screenshare="m.screenshare",r))(Ee||{});let Ji=null,ya=0;const Qm=()=>(Ji===null&&(Ji=new AudioContext),ya++,Ji),Xm=()=>{ya--,ya===0&&(Ji==null||Ji.close(),Ji=null)},Zm=200,Sa=-60,ev=8;class oi extends ke{constructor(e){super(),this.localVolume=1,this.measuringVolumeActivity=!1,this.speakingThreshold=Sa,this.speaking=!1,this._disposed=!1,this._connected=!1,this.onAddTrack=()=>{this.emit("new_stream",this.stream)},this.onCallState=t=>{t===St.Connected?this.connected=!0:t===St.Connecting&&(this.connected=!1)},this.volumeLooper=()=>{if(!this.analyser||!this.measuringVolumeActivity)return;this.analyser.getFloatFrequencyData(this.frequencyBinCount);let t=-1/0;for(const n of this.frequencyBinCount)n>t&&(t=n);this.speakingVolumeSamples.shift(),this.speakingVolumeSamples.push(t),this.emit("volume_changed",t);let i=!1;for(const n of this.speakingVolumeSamples)if(n>this.speakingThreshold){i=!0;break}this.speaking!==i&&(this.speaking=i,this.emit("speaking",this.speaking)),this.volumeLooperTimeout=setTimeout(this.volumeLooper,Zm)},this.client=e.client,this.call=e.call,this.roomId=e.roomId,this.userId=e.userId,this.deviceId=e.deviceId,this.purpose=e.purpose,this.audioMuted=e.audioMuted,this.videoMuted=e.videoMuted,this.speakingVolumeSamples=new Array(ev).fill(-1/0),this.sdpMetadataStreamId=e.stream.id,this.updateStream(null,e.stream),this.stream=e.stream,this.hasAudioTrack&&this.initVolumeMeasuring(),e.call&&(e.call.addListener(vt.State,this.onCallState),this.onCallState(e.call.state))}get connected(){return this.isLocal()||this._connected}set connected(e){this._connected=e,this.emit("connected_changed",this.connected)}get hasAudioTrack(){return this.stream.getAudioTracks().length>0}updateStream(e,t){if(t===e)return;const i=this.measuringVolumeActivity;e&&(e.removeEventListener("addtrack",this.onAddTrack),this.measureVolumeActivity(!1)),this.stream=t,t.addEventListener("addtrack",this.onAddTrack),this.hasAudioTrack?(this.initVolumeMeasuring(),i&&this.measureVolumeActivity(!0)):this.measureVolumeActivity(!1),this.emit("new_stream",this.stream)}initVolumeMeasuring(){if(!this.hasAudioTrack)return;this.audioContext||(this.audioContext=Qm()),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=512,this.analyser.smoothingTimeConstant=.1,this.audioContext.createMediaStreamSource(this.stream).connect(this.analyser),this.frequencyBinCount=new Float32Array(this.analyser.frequencyBinCount)}getMember(){const e=this.client.getRoom(this.roomId);return(e==null?void 0:e.getMember(this.userId))??null}isLocal(){return this.userId===this.client.getUserId()&&(this.deviceId===void 0||this.deviceId===this.client.getDeviceId())}isAudioMuted(){return this.stream.getAudioTracks().length===0||this.audioMuted}isVideoMuted(){return this.stream.getVideoTracks().length===0||this.videoMuted}isSpeaking(){return this.speaking}setNewStream(e){this.updateStream(this.stream,e)}setAudioVideoMuted(e,t){e!==null&&(this.audioMuted!==e&&this.speakingVolumeSamples.fill(-1/0),this.audioMuted=e),t!==null&&(this.videoMuted=t),this.emit("mute_state_changed",this.audioMuted,this.videoMuted)}measureVolumeActivity(e){if(e){if(!this.analyser||!this.frequencyBinCount||!this.hasAudioTrack)return;this.measuringVolumeActivity=!0,this.volumeLooper()}else this.measuringVolumeActivity=!1,this.speakingVolumeSamples.fill(-1/0),this.emit("volume_changed",-1/0)}setSpeakingThreshold(e){this.speakingThreshold=e}clone(){const e=this.client.getMediaHandler(),t=this.stream.clone();return d.log(`CallFeed clone() cloning stream (originalStreamId=${this.stream.id}, newStreamId${t.id})`),this.purpose===Ee.Usermedia?e.userMediaStreams.push(t):e.screensharingStreams.push(t),new oi({client:this.client,roomId:this.roomId,userId:this.userId,deviceId:this.deviceId,stream:t,purpose:this.purpose,audioMuted:this.audioMuted,videoMuted:this.videoMuted})}dispose(){var e,t;clearTimeout(this.volumeLooperTimeout),(e=this.stream)==null||e.removeEventListener("addtrack",this.onAddTrack),(t=this.call)==null||t.removeListener(vt.State,this.onCallState),this.audioContext&&(this.audioContext=void 0,this.analyser=void 0,Xm()),this._disposed=!0,this.emit("disposed")}get disposed(){return this._disposed}set disposed(e){this._disposed=e}getLocalVolume(){return this.localVolume}setLocalVolume(e){this.localVolume=e,this.emit("local_volume_changed",e)}}var Ei=(r=>(r[r.Blocked=-1]="Blocked",r[r.Unverified=0]="Unverified",r[r.Verified=1]="Verified",r))(Ei||{});class tv{constructor(e){this.dehydrated=!1,this.deviceId=e.deviceId,this.userId=e.userId,this.algorithms=e.algorithms,this.keys=e.keys,this.verified=e.verified||0,this.signatures=e.signatures||new Map,this.displayName=e.displayName,this.dehydrated=!!e.dehydrated}getFingerprint(){return this.keys.get(`ed25519:${this.deviceId}`)}getIdentityKey(){return this.keys.get(`curve25519:${this.deviceId}`)}}const Gs=class Gs{constructor(e){this.deviceId=e,this.algorithms=[],this.keys={},this.verified=Ei.Unverified,this.known=!1,this.unsigned={},this.signatures={}}static fromStorage(e,t){const i=new Gs(t);for(const n in e)e.hasOwnProperty(n)&&(i[n]=e[n]);return i}toStorage(){return{algorithms:this.algorithms,keys:this.keys,verified:this.verified,known:this.known,unsigned:this.unsigned,signatures:this.signatures}}getFingerprint(){return this.keys["ed25519:"+this.deviceId]}getIdentityKey(){return this.keys["curve25519:"+this.deviceId]}getDisplayName(){return this.unsigned.device_display_name||null}isBlocked(){return this.verified==Ei.Blocked}isVerified(){return this.verified==Ei.Verified}isUnverified(){return this.verified==Ei.Unverified}isKnown(){return this.known===!0}};Gs.DeviceVerification={VERIFIED:Ei.Verified,UNVERIFIED:Ei.Unverified,BLOCKED:Ei.Blocked};let ht=Gs;const iv=3e3;var Ea=(r=>(r.Incoming="Call.incoming",r))(Ea||{});class nv{constructor(e){this.nextSeqByCall=new Map,this.toDeviceEventBuffers=new Map,this.onSync=()=>{const t=this.callEventBuffer;this.callEventBuffer=[],this.eventBufferPromiseChain?this.eventBufferPromiseChain=this.eventBufferPromiseChain.then(()=>this.evaluateEventBuffer(t)):this.eventBufferPromiseChain=this.evaluateEventBuffer(t)},this.onRoomTimeline=t=>{this.callEventBuffer.push(t)},this.onToDeviceEvent=t=>{const i=t.getContent();if(!i.call_id){this.callEventBuffer.push(t);return}if(this.nextSeqByCall.has(i.call_id)||this.nextSeqByCall.set(i.call_id,0),i.seq===void 0){this.callEventBuffer.push(t);return}const n=this.nextSeqByCall.get(i.call_id)||0;if(i.seq!==n){this.toDeviceEventBuffers.has(i.call_id)||this.toDeviceEventBuffers.set(i.call_id,[]);const s=this.toDeviceEventBuffers.get(i.call_id),o=s.findIndex(a=>a.getContent().seq>i.seq);o===-1?s.push(t):s.splice(o,0,t)}else{const s=i.call_id;this.callEventBuffer.push(t),this.nextSeqByCall.set(s,i.seq+1);const o=this.toDeviceEventBuffers.get(s);let a=o&&o.shift();for(;a&&a.getContent().seq===this.nextSeqByCall.get(s);)this.callEventBuffer.push(a),this.nextSeqByCall.set(s,a.getContent().seq+1),a=o.shift()}},this.client=e,this.calls=new Map,this.callEventBuffer=[],this.candidateEventsByCall=new Map}start(){this.client.on(ie.Sync,this.onSync),this.client.on(de.Timeline,this.onRoomTimeline),this.client.on(ie.ToDeviceEvent,this.onToDeviceEvent)}stop(){this.client.removeListener(ie.Sync,this.onSync),this.client.removeListener(de.Timeline,this.onRoomTimeline),this.client.removeListener(ie.ToDeviceEvent,this.onToDeviceEvent)}async evaluateEventBuffer(e){await Promise.all(e.map(n=>this.client.decryptEventIfNeeded(n)));const t=e.filter(n=>{const s=n.getType();return s.startsWith("m.call.")||s.startsWith("org.matrix.call.")}),i=new Set;for(const n of t){const s=n.getType();(s===R.CallAnswer||s===R.CallHangup)&&i.add(n.getContent().call_id)}for(const n of t){const s=n.getType(),o=n.getContent().call_id;if(!(s===R.CallInvite&&i.has(o)))try{await this.handleCallEvent(n)}catch(a){d.error("CallEventHandler evaluateEventBuffer() caught exception handling call event",a)}}}async handleCallEvent(e){var h,f,g;this.client.emit(ie.ReceivedVoipEvent,e);const t=e.getContent(),i=e.getRoomId()||((f=(h=this.client.groupCallEventHandler.getGroupCallById(t.conf_id))==null?void 0:h.room)==null?void 0:f.roomId),n=t.conf_id,s=e.getType(),o=e.getSender();let a=t.call_id?this.calls.get(t.call_id):void 0,c,l;if(n){if(l=this.client.groupCallEventHandler.getGroupCallById(n),!l){d.warn(`CallEventHandler handleCallEvent() could not find a group call - ignoring event (groupCallId=${n}, type=${s})`);return}if(c=t.device_id,!c){d.warn(`CallEventHandler handleCallEvent() could not find a device id - ignoring event (senderId=${o})`),l.emit(wa.Error,new vu(o));return}if(t.dest_session_id!==this.client.getSessionId()){d.warn("CallEventHandler handleCallEvent() call event does not match current session id - ignoring");return}}const u=o===this.client.credentials.userId&&(c===void 0||c===this.client.getDeviceId());if(i){if(s===R.CallInvite){if(u||e.getLocalAge()>t.lifetime-iv||a&&a.state===St.Ended||(a&&d.warn(`CallEventHandler handleCallEvent() already has a call but got an invite - clobbering (callId=${t.call_id})`),t.invitee&&t.invitee!==this.client.getUserId()))return;const m=(this.client.getTurnServersExpiry()??0)-Date.now();if(d.info("CallEventHandler handleCallEvent() current turn creds expire in "+m+" ms"),a=Ds(this.client,i,{forceTURN:this.client.forceTURN,opponentDeviceId:c,groupCallId:n,opponentSessionId:t.sender_session_id})??void 0,!a){d.log(`CallEventHandler handleCallEvent() this client does not support WebRTC (callId=${t.call_id})`);return}a.callId=t.call_id;const v=l==null?void 0:l.getGroupCallStats();v&&a.initStats(v);try{await a.initWithInvite(e)}catch(w){w instanceof ni&&(w.code===mu.UnknownDevice?l==null||l.emit(wa.Error,w):d.error(w))}if(this.calls.set(a.callId,a),this.candidateEventsByCall.get(a.callId))for(const w of this.candidateEventsByCall.get(a.callId))a.onRemoteIceCandidatesReceived(w);let S;for(const w of this.calls.values()){const M=[St.WaitLocalMedia,St.CreateOffer,St.InviteSent].includes(w.state);if(a.roomId===w.roomId&&w.direction===Eu.Outbound&&((g=a.getOpponentMember())==null?void 0:g.userId)===w.invitee&&M){S=w;break}}S?S.callId>a.callId?(d.log(`CallEventHandler handleCallEvent() detected glare - answering incoming call and canceling outgoing call (incomingId=${a.callId}, outgoingId=${S.callId})`),S.replacedBy(a)):(d.log(`CallEventHandler handleCallEvent() detected glare - hanging up incoming call (incomingId=${a.callId}, outgoingId=${S.callId})`),a.hangup(ii.Replaced,!0)):this.client.emit("Call.incoming",a);return}else if(s===R.CallCandidates){if(u)return;a?a.onRemoteIceCandidatesReceived(e):(this.candidateEventsByCall.has(t.call_id)||this.candidateEventsByCall.set(t.call_id,[]),this.candidateEventsByCall.get(t.call_id).push(e));return}else if([R.CallHangup,R.CallReject].includes(s)){a?a.state!==St.Ended&&(s===R.CallHangup?a.onHangupReceived(t):a.onRejectReceived(t),a.state===St.Ended&&this.calls.delete(t.call_id)):(a=Ds(this.client,i,{opponentDeviceId:c,opponentSessionId:t.sender_session_id})??void 0,a&&(a.callId=t.call_id,a.initWithHangup(e),this.calls.set(t.call_id,a)));return}if(!a||!a.hasPeerConnection){d.info(`CallEventHandler handleCallEvent() discarding possible call event as we don't have a call (type=${s})`);return}if(e.getContent().party_id!==a.ourPartyId)switch(s){case R.CallAnswer:u?a.state===St.Ringing&&a.onAnsweredElsewhere(t):a.onAnswerReceived(e);break;case R.CallSelectAnswer:a.onSelectAnswerReceived(e);break;case R.CallNegotiate:a.onNegotiateReceived(e);break;case R.CallAssertedIdentity:case R.CallAssertedIdentityPrefix:a.onAssertedIdentityReceived(e);break;case R.CallSDPStreamMetadataChanged:case R.CallSDPStreamMetadataChangedPrefix:a.onSDPStreamMetadataChangedReceived(e);break}}}}var ba=(r=>(r.Incoming="GroupCall.incoming",r.Outgoing="GroupCall.outgoing",r.Ended="GroupCall.ended",r.Participants="GroupCall.participants",r))(ba||{});class rv{constructor(e){this.client=e,this.groupCalls=new Map,this.roomDeferreds=new Map,this.onRoomsChanged=t=>{this.createGroupCallForRoom(t)},this.onRoomStateChanged=(t,i)=>{if(t.getType()===R.GroupCallPrefix){const s=t.getStateKey(),o=t.getContent(),a=this.groupCalls.get(i.roomId);!a&&!o["m.terminated"]&&!t.isRedacted()?this.createGroupCallFromRoomStateEvent(t):a&&a.groupCallId===s?o["m.terminated"]||t.isRedacted()?a.terminate(!1):o["m.type"]!==a.type&&d.warn(`GroupCallEventHandler onRoomStateChanged() currently does not support changing type (roomId=${i.roomId})`):a&&a.groupCallId!==s&&d.warn(`GroupCallEventHandler onRoomStateChanged() currently does not support multiple calls (roomId=${i.roomId})`)}}}async start(){this.client.getSyncState()!==st.Syncing&&(d.debug("GroupCallEventHandler start() waiting for client to start syncing"),await new Promise(t=>{const i=()=>{if(this.client.getSyncState()===st.Syncing)return this.client.off(ie.Sync,i),t()};this.client.on(ie.Sync,i)}));const e=this.client.getRooms();for(const t of e)this.createGroupCallForRoom(t);this.client.on(ie.Room,this.onRoomsChanged),this.client.on(fe.Events,this.onRoomStateChanged)}stop(){this.client.removeListener(ie.Room,this.onRoomsChanged),this.client.removeListener(fe.Events,this.onRoomStateChanged)}getRoomDeferred(e){let t=this.roomDeferreds.get(e);if(t===void 0){let i;t={prom:new Promise(n=>{i=n})},t.resolve=i,this.roomDeferreds.set(e,t)}return t}waitUntilRoomReadyForGroupCalls(e){return this.getRoomDeferred(e).prom}getGroupCallById(e){return[...this.groupCalls.values()].find(t=>t.groupCallId===e)}createGroupCallForRoom(e){const t=e.currentState.getStateEvents(R.GroupCallPrefix),i=t.sort((n,s)=>s.getTs()-n.getTs());for(const n of i)if(!(n.getContent()["m.terminated"]||n.isRedacted())){d.debug(`GroupCallEventHandler createGroupCallForRoom() choosing group call from possible calls (stateKey=${n.getStateKey()}, ts=${n.getTs()}, roomId=${e.roomId}, numOfPossibleCalls=${t.length})`),this.createGroupCallFromRoomStateEvent(n);break}this.getRoomDeferred(e.roomId).resolve()}createGroupCallFromRoomStateEvent(e){const t=e.getRoomId(),i=e.getContent(),n=this.client.getRoom(t);if(!n){d.warn(`GroupCallEventHandler createGroupCallFromRoomStateEvent() couldn't find room for call (roomId=${t})`);return}const s=e.getStateKey(),o=i["m.type"];if(!Object.values(Ja).includes(o)){d.warn(`GroupCallEventHandler createGroupCallFromRoomStateEvent() received invalid call type (type=${o}, roomId=${t})`);return}const a=i["m.intent"];if(!Object.values(pu).includes(a)){d.warn(`Received invalid group call intent (type=${o}, roomId=${t})`);return}const c=!!i["io.element.ptt"];let l;if(i!=null&&i.dataChannelsEnabled&&(i!=null&&i.dataChannelOptions)){const{ordered:h,maxPacketLifeTime:f,maxRetransmits:g,protocol:m}=i.dataChannelOptions;l={ordered:h,maxPacketLifeTime:f,maxRetransmits:g,protocol:m}}const u=new Su(this.client,n,o,c,a,s,(i==null?void 0:i.dataChannelsEnabled)||this.client.isVoipWithNoMediaAllowed,l,this.client.isVoipWithNoMediaAllowed,this.client.useLivekitForGroupCalls,i["io.element.livekit_service_url"]);return this.groupCalls.set(n.roomId,u),this.client.emit("GroupCall.incoming",u),u}}class sv{constructor(){this.bandwidth={},this.bitrate={},this.packetLoss={},this.transport=[]}}class ov{static buildBandwidthReport(e){const t=e.availableIncomingBitrate,i=e.availableOutgoingBitrate;return{download:t?Math.round(t/1e3):0,upload:i?Math.round(i/1e3):0}}}class av{static buildReport(e,t,i,n){const s=e==null?void 0:e.get(t.localCandidateId),o=e==null?void 0:e.get(t.remoteCandidateId);if(o&&s){const a=o.ip!==void 0?o.ip:o.address,c=o.port,l=`${a}:${c}`,u=s.ip!==void 0?s.ip:s.address,h=s.port,f=`${u}:${h}`,g=o.protocol;i.some(m=>m.ip===l&&m.type===g&&m.localIp===f)||i.push({ip:l,type:g,localIp:f,isFocus:n,localCandidateType:s.candidateType,remoteCandidateType:o.candidateType,networkType:s.networkType,rtt:t.currentRoundTripTime?t.currentRoundTripTime*1e3:NaN})}return i}}class cv{constructor(){this.ssrcToMid={local:new Map,remote:new Map}}findMidBySsrc(e,t){let i;return this.ssrcToMid[t].forEach((n,s)=>{if(n.find(o=>o==e)){i=s;return}}),i}parse(e,t){const i=fu(e),n=new Map;i.media.forEach(s=>{var o;if(s.mid&&s.type==="video"||s.type==="audio"){const a=[];(o=s.ssrcs)==null||o.forEach(c=>{c.attribute==="cname"&&a.push(`${c.id}`)}),n.set(`${s.mid}`,a)}}),this.ssrcToMid[t]=n}getSsrcToMidMap(e){return this.ssrcToMid[e]}}class lv{constructor(e){this.pc=e}getLocalTracks(e){const t=i=>i!==null&&i.kind===e;return this.pc.getTransceivers().filter(i=>i.currentDirection==="sendonly"||i.currentDirection==="sendrecv").filter(i=>i.sender!==null).map(i=>i.sender).map(i=>i.track).filter(t)}getTackById(e){return this.pc.getTransceivers().map(t=>{if((t==null?void 0:t.sender.track)!==null&&t.sender.track.id===e)return t.sender.track;if((t==null?void 0:t.receiver.track)!==null&&t.receiver.track.id===e)return t.receiver.track}).find(t=>t!==void 0)}getLocalTrackIdByMid(e){const t=this.pc.getTransceivers().find(i=>i.mid===e);if(t!==void 0&&t.sender&&t.sender.track)return t.sender.track.id}getRemoteTrackIdByMid(e){const t=this.pc.getTransceivers().find(i=>i.mid===e);if(t!==void 0&&t.receiver&&t.receiver.track)return t.receiver.track.id}getActiveSimulcastStreams(){return 3}getTransceiverByTrackId(e){return this.pc.getTransceivers().find(t=>t.receiver.track.id===e||t.sender.track!==null&&t.sender.track.id===e)}}class dv{constructor(e,t,i){this.trackId=e,this.type=t,this.kind=i,this.loss={packetsTotal:0,packetsLost:0,isDownloadStream:!1},this.bitrate={download:0,upload:0},this.resolution={width:-1,height:-1},this.audioConcealment={concealedAudio:0,totalAudioDuration:0},this.framerate=0,this.jitter=0,this.codec="",this.isAlive=!0,this.isMuted=!1,this.isEnabled=!0}getType(){return this.type}setLoss(e){this.loss=e}getLoss(){return this.loss}setResolution(e){this.resolution=e}getResolution(){return this.resolution}setFramerate(e){this.framerate=e}getFramerate(){return this.framerate}setBitrate(e){this.bitrate=e}getBitrate(){return this.bitrate}setCodec(e){return this.codec=e,!0}getCodec(){return this.codec}resetBitrate(){this.bitrate={download:0,upload:0}}set alive(e){this.isAlive=e}get alive(){return this.isAlive}set muted(e){this.isMuted=e}get muted(){return this.isMuted}set enabled(e){this.isEnabled=e}get enabled(){return this.isEnabled}setJitter(e){this.jitter=e}getJitter(){return this.jitter}setAudioConcealment(e,t){this.audioConcealment.concealedAudio=e,this.audioConcealment.totalAudioDuration=t}getAudioConcealment(){return this.audioConcealment}}class uv{constructor(e,t){this.mediaSsrcHandler=e,this.mediaTrackHandler=t,this.track2stats=new Map}findTrack2Stats(e,t){let i;if(e.trackIdentifier)i=e.trackIdentifier;else if(e.mid)i=t==="remote"?this.mediaTrackHandler.getRemoteTrackIdByMid(e.mid):this.mediaTrackHandler.getLocalTrackIdByMid(e.mid);else if(e.ssrc){if(!this.mediaSsrcHandler.findMidBySsrc(e.ssrc,t))return;i=t==="remote"?this.mediaTrackHandler.getRemoteTrackIdByMid(e.mid):this.mediaTrackHandler.getLocalTrackIdByMid(e.mid)}if(!i)return;let n=this.track2stats.get(i);if(!n){const s=this.mediaTrackHandler.getTackById(i);if(s!==void 0){const o=s.kind==="audio"?s.kind:"video";n=new dv(i,t,o),this.track2stats.set(i,n)}else return}return n}findLocalVideoTrackStats(e){if(this.mediaTrackHandler.getLocalTracks("video").length!==0)return this.findTrack2Stats(e,"local")}getTrack2stats(){return this.track2stats}findTransceiverByTrackId(e){return this.mediaTrackHandler.getTransceiverByTrackId(e)}}class xi{static getNonNegativeValue(e){let t=e;return typeof t!="number"&&(t=Number(t)),isNaN(t)?0:Math.max(0,t)}}class mt{static buildFramerateResolution(e,t){const i={height:t.frameHeight,width:t.frameWidth},n=t.framesPerSecond;i.height&&i.width&&e.setResolution(i),e.setFramerate(Math.round(n||0))}static calculateSimulcastFramerate(e,t,i,n){let s=e.getFramerate();if(!s){if(i){const o=t.timestamp-i.timestamp;o>0&&t.framesSent&&(s=(t.framesSent-i.framesSent)/o*1e3)}if(!s)return}s=n?Math.round(s/n):0,e.setFramerate(s)}static buildCodec(e,t,i){const n=e==null?void 0:e.get(i.codecId);if(n){const s=n.mimeType.split("/")[1];s&&t.setCodec(s)}}static buildBitrateReceived(e,t,i){e.setBitrate({download:mt.calculateBitrate(t.bytesReceived,i.bytesReceived,t.timestamp,i.timestamp),upload:0})}static buildBitrateSend(e,t,i){e.setBitrate({download:0,upload:this.calculateBitrate(t.bytesSent,i.bytesSent,t.timestamp,i.timestamp)})}static buildPacketsLost(e,t,i){const n=t.type==="outbound-rtp"?"packetsSent":"packetsReceived";let s=t[n];(!s||s<0)&&(s=0);const o=xi.getNonNegativeValue(i[n]),a=Math.max(0,s-o),c=xi.getNonNegativeValue(t.packetsLost),l=xi.getNonNegativeValue(i.packetsLost),u=Math.max(0,c-l);e.setLoss({packetsTotal:a+u,packetsLost:u,isDownloadStream:t.type!=="outbound-rtp"})}static calculateBitrate(e,t,i,n){const s=xi.getNonNegativeValue(e),o=xi.getNonNegativeValue(t),a=Math.max(0,s-o),c=i-n;let l=0;return c>0&&(l=Math.round(a*8/c)),l}static setTrackStatsState(e,t){var n;if(t===void 0){e.alive=!1;return}const i=e.getType()==="remote"?t.receiver.track:(n=t==null?void 0:t.sender)==null?void 0:n.track;if(i==null){e.alive=!1;return}if(i.readyState==="ended"){e.alive=!1;return}e.muted=i.muted,e.enabled=i.enabled,e.alive=!0}static buildTrackSummary(e){const t={count:0,muted:0,maxJitter:0,maxPacketLoss:0,concealedAudio:0,totalAudio:0},i={count:0,muted:0,maxJitter:0,maxPacketLoss:0,concealedAudio:0,totalAudio:0},n=e.filter(o=>o.getType()==="remote"),s=n.filter(o=>o.kind==="audio");return n.forEach(o=>{var c,l;const a=o.kind==="video"?t:i;a.count++,o.alive&&o.muted&&a.muted++,a.maxJitter<o.getJitter()&&(a.maxJitter=o.getJitter()),a.maxPacketLoss<o.getLoss().packetsLost&&(a.maxPacketLoss=o.getLoss().packetsLost),s.length>0&&(a.concealedAudio+=(c=o.getAudioConcealment())==null?void 0:c.concealedAudio,a.totalAudio+=(l=o.getAudioConcealment())==null?void 0:l.totalAudioDuration)}),{audioTrackSummary:i,videoTrackSummary:t}}static buildJitter(e,t){if(t.type!=="inbound-rtp")return;const i=t==null?void 0:t.jitter;if(i!==void 0){const n=xi.getNonNegativeValue(i);e.setJitter(Math.round(n*1e3))}else e.setJitter(-1)}static buildAudioConcealment(e,t){if(t.type!=="inbound-rtp")return;const n=1e3*(t==null?void 0:t.totalSamplesDuration)/(t==null?void 0:t.totalSamplesReceived)*(t==null?void 0:t.concealedSamples),s=1e3*(t==null?void 0:t.totalSamplesDuration);e.setAudioConcealment(n,s)}}class Sr{static build(e){const t={},i={download:0,upload:0},n={download:0,upload:0};let s=0,o=0;const a={local:new Map,remote:new Map},c={local:new Map,remote:new Map},l={local:new Map,remote:new Map},u=new Map,h=new Map;let f=0,g=0,m=0,v=0,S=0,w=0;for(const[M,_]of e){const C=_.getLoss(),A=C.isDownloadStream?"download":"upload";if(i[A]+=C.packetsTotal,n[A]+=C.packetsLost,s+=_.getBitrate().download,o+=_.getBitrate().upload,_.kind==="audio"){const y=_.getAudioConcealment();S+=y.concealedAudio,w+=y.totalAudioDuration,f+=_.getBitrate().download,g+=_.getBitrate().upload}else m+=_.getBitrate().download,v+=_.getBitrate().upload;a[_.getType()].set(M,_.getResolution()),c[_.getType()].set(M,_.getFramerate()),l[_.getType()].set(M,_.getCodec()),_.getType()==="remote"&&(u.set(M,_.getJitter()),_.kind==="audio"&&h.set(M,_.getAudioConcealment())),_.resetBitrate()}return t.bitrate={upload:o,download:s},t.bitrate.audio={upload:g,download:f},t.bitrate.video={upload:v,download:m},t.packetLoss={total:Sr.calculatePacketLoss(n.download+n.upload,i.download+i.upload),download:Sr.calculatePacketLoss(n.download,i.download),upload:Sr.calculatePacketLoss(n.upload,i.upload)},t.audioConcealment=h,t.totalAudioConcealment={concealedAudio:S,totalAudioDuration:w},t.framerate=c,t.resolution=a,t.codec=l,t.jitter=u,t}static calculatePacketLoss(e,t){return!t||t<=0||!e||e<=0?0:Math.round(e/t*100)}}class Ci{static buildCallFeedReport(e,t,i){const n=i.getTransceivers(),s=[],o=[];return n.forEach(a=>{var u;const c=(u=a.sender)!=null&&u.track?Ci.buildTrackStats(a.sender.track,"sender"):null,l=Ci.buildTrackStats(a.receiver.track,"receiver");s.push({mid:a.mid==null?"null":a.mid,direction:a.direction,currentDirection:a.currentDirection==null?"null":a.currentDirection,sender:c,receiver:l})}),{callId:e,opponentMemberId:t,transceiver:s,callFeeds:o}}static buildTrackStats(e,t="--"){var s,o;const i=(s=e.getSettings())==null?void 0:s.deviceId,n=(o=e.getConstraints())==null?void 0:o.deviceId;return{id:e.id,kind:e.kind,settingDeviceId:i||"unknown",constrainDeviceId:n||"unknown",muted:e.muted,enabled:e.enabled,readyState:e.readyState,label:t}}static expandCallFeedReport(e,t,i="unknown"){return e.callFeeds||(e.callFeeds=[]),t.forEach(n=>{const s=n.stream.getAudioTracks(),o=n.stream.getVideoTracks(),a=s.length>0?Ci.buildTrackStats(n.stream.getAudioTracks()[0],n.purpose):null,c=o.length>0?Ci.buildTrackStats(n.stream.getVideoTracks()[0],n.purpose):null,l={stream:n.stream.id,type:n.isLocal()?"local":"remote",audio:a,video:c,purpose:n.purpose,prefix:i,isVideoMuted:n.isVideoMuted(),isAudioMuted:n.isAudioMuted()};e.callFeeds.push(l)}),e}}class hv{constructor(e,t,i,n,s=!0){this.callId=e,this.opponentMemberId=t,this.pc=i,this.emitter=n,this.isFocus=s,this.isActive=!0,this.connectionStats=new sv,i.addEventListener("signalingstatechange",this.onSignalStateChange.bind(this)),this.trackStats=new uv(new cv,new lv(i))}async processStats(e,t){const i={isFirstCollection:this.previousStatsReport===void 0,receivedMedia:0,receivedAudioMedia:0,receivedVideoMedia:0,audioTrackSummary:{count:0,muted:0,maxPacketLoss:0,maxJitter:0,concealedAudio:0,totalAudio:0},videoTrackSummary:{count:0,muted:0,maxPacketLoss:0,maxJitter:0,concealedAudio:0,totalAudio:0}};if(this.isActive){const n=this.pc.getStats();if(typeof(n==null?void 0:n.then)=="function")return n.then(s=>{var a,c;this.currentStatsReport=typeof(s==null?void 0:s.result)=="function"?s.result():s;try{this.processStatsReport(e,t)}catch(l){return this.handleError(l),i}this.previousStatsReport=this.currentStatsReport,i.receivedMedia=this.connectionStats.bitrate.download,i.receivedAudioMedia=((a=this.connectionStats.bitrate.audio)==null?void 0:a.download)||0,i.receivedVideoMedia=((c=this.connectionStats.bitrate.video)==null?void 0:c.download)||0;const o=mt.buildTrackSummary(Array.from(this.trackStats.getTrack2stats().values()));return{...i,audioTrackSummary:o.audioTrackSummary,videoTrackSummary:o.videoTrackSummary}}).catch(s=>(this.handleError(s),i));this.isActive=!1}return Promise.resolve(i)}processStatsReport(e,t){var n;const i=new Map;i.callId=this.callId,i.opponentMemberId=this.opponentMemberId,(n=this.currentStatsReport)==null||n.forEach(s=>{const o=this.previousStatsReport?this.previousStatsReport.get(s.id):null;if(s.type==="candidate-pair"&&s.nominated&&s.state==="succeeded")this.connectionStats.bandwidth=ov.buildBandwidthReport(s),this.connectionStats.transport=av.buildReport(this.currentStatsReport,s,this.connectionStats.transport,this.isFocus);else if(s.type==="inbound-rtp"||s.type==="outbound-rtp"){const a=this.trackStats.findTrack2Stats(s,s.type==="inbound-rtp"?"remote":"local");if(!a)return;if(o&&mt.buildPacketsLost(a,s,o),s.type==="inbound-rtp"){mt.buildFramerateResolution(a,s),o&&mt.buildBitrateReceived(a,s,o);const c=this.trackStats.findTransceiverByTrackId(a.trackId);mt.setTrackStatsState(a,c),mt.buildJitter(a,s),mt.buildAudioConcealment(a,s)}else o&&(i.set(a.trackId,xi.getNonNegativeValue(s.bytesSent)),mt.buildBitrateSend(a,s,o));mt.buildCodec(this.currentStatsReport,a,s)}else if(s.type==="track"&&s.kind==="video"&&!s.remoteSource){const a=this.trackStats.findLocalVideoTrackStats(s);if(!a)return;mt.buildFramerateResolution(a,s),mt.calculateSimulcastFramerate(a,s,o,this.trackStats.mediaTrackHandler.getActiveSimulcastStreams())}}),this.emitter.emitByteSendReport(i),this.emitter.emitCallFeedReport(Ci.buildCallFeedReport(this.callId,this.opponentMemberId,this.pc)),this.processAndEmitConnectionStatsReport()}setActive(e){this.isActive=e}getActive(){return this.isActive}handleError(e){this.isActive=!1,d.warn(`CallStatsReportGatherer ${this.callId} processStatsReport fails and set to inactive ${e}`)}processAndEmitConnectionStatsReport(){const e=Sr.build(this.trackStats.getTrack2stats());e.callId=this.callId,e.opponentMemberId=this.opponentMemberId,this.connectionStats.bandwidth=e.bandwidth,this.connectionStats.bitrate=e.bitrate,this.connectionStats.packetLoss=e.packetLoss,this.emitter.emitConnectionStatsReport({...e,transport:this.connectionStats.transport}),this.connectionStats.transport=[]}stopProcessingStats(){}onSignalStateChange(){this.pc.signalingState==="stable"&&(this.pc.currentRemoteDescription&&this.trackStats.mediaSsrcHandler.parse(this.pc.currentRemoteDescription.sdp,"remote"),this.pc.currentLocalDescription&&this.trackStats.mediaSsrcHandler.parse(this.pc.currentLocalDescription.sdp,"local"))}setOpponentMemberId(e){this.opponentMemberId=e}}var ci=(r=>(r.CONNECTION_STATS="StatsReport.connection_stats",r.CALL_FEED_REPORT="StatsReport.call_feed_report",r.BYTE_SENT_STATS="StatsReport.byte_sent_stats",r.SUMMARY_STATS="StatsReport.summary_stats",r))(ci||{});class fv extends ke{emitByteSendReport(e){this.emit(ci.BYTE_SENT_STATS,e)}emitConnectionStatsReport(e){this.emit(ci.CONNECTION_STATS,e)}emitCallFeedReport(e){this.emit(ci.CALL_FEED_REPORT,e)}emitSummaryStatsReport(e){this.emit(ci.SUMMARY_STATS,e)}}class gu{constructor(e){this.emitter=e}build(e){const t=e.filter(u=>!u.isFirstCollection),i=t.length,n=e.length;if(i===0)return;const s={receivedAudio:0,receivedVideo:0,receivedMedia:0,concealedAudio:0,totalAudio:0};let o=0,a=0;t.forEach(u=>{this.countTrackListReceivedMedia(s,u),this.countConcealedAudio(s,u),o=this.buildMaxJitter(o,u),a=this.buildMaxPacketLoss(a,u)});const c=5,l={percentageReceivedMedia:Number((s.receivedMedia/i).toFixed(c)),percentageReceivedVideoMedia:Number((s.receivedVideo/i).toFixed(c)),percentageReceivedAudioMedia:Number((s.receivedAudio/i).toFixed(c)),maxJitter:o,maxPacketLoss:a,percentageConcealedAudio:Number(s.totalAudio>0?(s.concealedAudio/s.totalAudio).toFixed(c):0),peerConnections:n};this.emitter.emitSummaryStatsReport(l)}static extendSummaryReport(e,t){const i=[],n=[];for(const s of t){n.push(s);for(const o of s[1])i.push(o)}e.opponentDevicesInCall=Math.max(0,i.length-1),e.opponentUsersInCall=Math.max(0,n.length-1),e.diffDevicesToPeerConnections=Math.max(0,i.length-1)-e.peerConnections,e.ratioPeerConnectionToDevices=Math.max(0,i.length-1)==0?0:e.peerConnections/(i.length-1)}countTrackListReceivedMedia(e,t){let i=!1,n=!1;(t.receivedAudioMedia>0||t.audioTrackSummary.count===0)&&(e.receivedAudio++,i=!0),(t.receivedVideoMedia>0||t.videoTrackSummary.count===0||t.videoTrackSummary.muted>0&&t.videoTrackSummary.muted===t.videoTrackSummary.count)&&(e.receivedVideo++,n=!0),n&&i&&e.receivedMedia++}buildMaxJitter(e,t){return e<t.videoTrackSummary.maxJitter&&(e=t.videoTrackSummary.maxJitter),e<t.audioTrackSummary.maxJitter&&(e=t.audioTrackSummary.maxJitter),e}buildMaxPacketLoss(e,t){return e<t.videoTrackSummary.maxPacketLoss&&(e=t.videoTrackSummary.maxPacketLoss),e<t.audioTrackSummary.maxPacketLoss&&(e=t.audioTrackSummary.maxPacketLoss),e}countConcealedAudio(e,t){e.concealedAudio+=t.audioTrackSummary.concealedAudio,e.totalAudio+=t.audioTrackSummary.totalAudio}}class gv{constructor(e,t,i=1e4){this.groupCallId=e,this.userId=t,this.interval=i,this.gatherers=new Map,this.reports=new fv,this.summaryStatsReportGatherer=new gu(this.reports)}start(){this.timer===void 0&&this.interval>0&&(this.timer=setInterval(()=>{this.processStats()},this.interval))}stop(){this.timer!==void 0&&(clearInterval(this.timer),this.gatherers.forEach(e=>e.stopProcessingStats()))}hasStatsReportGatherer(e){return this.gatherers.has(e)}addStatsReportGatherer(e,t,i){return this.hasStatsReportGatherer(e)?!1:(this.gatherers.set(e,new hv(e,t,i,this.reports)),!0)}removeStatsReportGatherer(e){return this.gatherers.delete(e)}getStatsReportGatherer(e){return this.hasStatsReportGatherer(e)?this.gatherers.get(e):void 0}updateOpponentMember(e,t){var i;(i=this.getStatsReportGatherer(e))==null||i.setOpponentMemberId(t)}processStats(){const e=[];this.gatherers.forEach(t=>{e.push(t.processStats(this.groupCallId,this.userId))}),Promise.all(e).then(t=>this.summaryStatsReportGatherer.build(t)).catch(t=>{d.error("Could not build summary stats report",t)})}setInterval(e){this.interval=e}}var pu=(r=>(r.Ring="m.ring",r.Prompt="m.prompt",r.Room="m.room",r))(pu||{}),Ja=(r=>(r.Video="m.video",r.Voice="m.voice",r))(Ja||{}),wa=(r=>(r.GroupCallStateChanged="group_call_state_changed",r.ActiveSpeakerChanged="active_speaker_changed",r.CallsChanged="calls_changed",r.UserMediaFeedsChanged="user_media_feeds_changed",r.ScreenshareFeedsChanged="screenshare_feeds_changed",r.LocalScreenshareStateChanged="local_screenshare_state_changed",r.LocalMuteStateChanged="local_mute_state_changed",r.ParticipantsChanged="participants_changed",r.Error="group_call_error",r))(wa||{}),mu=(r=>(r.NoUserMedia="no_user_media",r.UnknownDevice="unknown_device",r.PlaceCallFailed="place_call_failed",r))(mu||{});class _a extends Error{constructor(e,t,i){i?super(t+": "+i):super(t),this.code=e}}class vu extends _a{constructor(e){super("unknown_device","No device found for "+e),this.userId=e}}var yu=(r=>(r.LocalCallFeedUninitialized="local_call_feed_uninitialized",r.InitializingLocalCallFeed="initializing_local_call_feed",r.LocalCallFeedInitialized="local_call_feed_initialized",r.Entered="entered",r.Ended="ended",r))(yu||{});const hl=1e3*60*60;function Xr(r){var e;return((e=r.getOpponentMember())==null?void 0:e.userId)||r.invitee||null}class Su extends ke{constructor(e,t,i,n,s,o,a,c,l,u=!1,h){var f;super(),this.client=e,this.room=t,this.type=i,this.isPtt=n,this.intent=s,this.dataChannelsEnabled=a,this.dataChannelOptions=c,this.useLivekit=u,this.activeSpeakerInterval=1e3,this.retryCallInterval=5e3,this.participantTimeout=1e3*15,this.pttMaxTransmitTime=1e3*20,this.userMediaFeeds=[],this.screenshareFeeds=[],this.calls=new Map,this.callHandlers=new Map,this.retryCallCounts=new Map,this.transmitTimer=null,this.participantsExpirationTimer=null,this.resendMemberStateTimer=null,this.initWithAudioMuted=!1,this.initWithVideoMuted=!1,this.statsCollectIntervalTime=0,this.onConnectionStats=g=>{this.emit("GroupCall.connection_stats",{report:g})},this.onByteSentStats=g=>{this.emit("GroupCall.byte_sent_stats",{report:g})},this.onSummaryStats=g=>{gu.extendSummaryReport(g,this.participants),this.emit("GroupCall.summary_stats",{report:g})},this.onCallFeedReport=g=>{this.localCallFeed&&(g=Ci.expandCallFeedReport(g,[this.localCallFeed],"from-local-feed"));const m=[];this.forEachCall(v=>{v.callId===g.callId&&v.getFeeds().forEach(S=>m.push(S))}),g=Ci.expandCallFeedReport(g,m,"from-call-feed"),this.emit("GroupCall.call_feed_stats",{report:g})},this._state="local_call_feed_uninitialized",this._participants=new Map,this._creationTs=null,this._enteredViaAnotherSession=!1,this.onIncomingCall=g=>{var M;if(g.roomId!==this.room.roomId)return;if(g.state!==St.Ringing){d.warn(`GroupCall ${this.groupCallId} onIncomingCall() incoming call no longer in ringing state - ignoring`);return}if(!g.groupCallId||g.groupCallId!==this.groupCallId){d.log(`GroupCall ${this.groupCallId} onIncomingCall() ignored because it doesn't match the current group call`),g.reject();return}const m=(M=g.getOpponentMember())==null?void 0:M.userId;if(m===void 0){d.warn(`GroupCall ${this.groupCallId} onIncomingCall() incoming call with no member - ignoring`);return}if(this.useLivekit){d.info("Received incoming call whilst in signaling-only mode! Ignoring.");return}const v=this.calls.get(m)??new Map,S=v.get(g.getOpponentDeviceId());if((S==null?void 0:S.callId)===g.callId)return;d.log(`GroupCall ${this.groupCallId} onIncomingCall() incoming call (userId=${m}, callId=${g.callId})`),S&&S.hangup(ii.Replaced,!1),v.set(g.getOpponentDeviceId(),g),this.calls.set(m,v),this.initCall(g);const w=this.getLocalFeeds().map(_=>_.clone());if(!this.callExpected(g))for(const _ of w)Ue(_.stream.getAudioTracks(),!1),Ue(_.stream.getVideoTracks(),!1);g.answerWithCallFeeds(w),this.emit("calls_changed",this.calls)},this.onRetryCallLoop=()=>{let g=!1;for(const[{userId:m},v]of this.participants){const S=this.calls.get(m);let w=this.retryCallCounts.get(m);for(const[M,_]of v){const C=S==null?void 0:S.get(M),A=(w==null?void 0:w.get(M))??0;(C==null?void 0:C.getOpponentSessionId())!==_.sessionId&&this.wantsOutgoingCall(m,M)&&A<3&&(w===void 0&&(w=new Map,this.retryCallCounts.set(m,w)),w.set(M,A+1),g=!0)}}g&&this.placeOutgoingCalls()},this.onCallFeedsChanged=g=>{const m=Xr(g),v=g.getOpponentDeviceId();if(!m)throw new Error("Cannot change call feeds without user id");const S=this.getUserMediaFeed(m,v),w=g.remoteUsermediaFeed,M=w!==S,_=this.calls.get(m),C=_==null?void 0:_.get(v);if((C==null?void 0:C.callId)!==g.callId)return;M&&(!S&&w?this.addUserMediaFeed(w):S&&w?this.replaceUserMediaFeed(S,w):S&&!w&&this.removeUserMediaFeed(S));const A=this.getScreenshareFeed(m,v),y=g.remoteScreensharingFeed;y!==A&&(!A&&y?this.addScreenshareFeed(y):A&&y?this.replaceScreenshareFeed(A,y):A&&!y&&this.removeScreenshareFeed(A))},this.onCallStateChanged=(g,m,v)=>{var _;if(m===St.Ended)return;const S=this.localCallFeed.isAudioMuted();g.localUsermediaStream&&g.isMicrophoneMuted()!==S&&g.setMicrophoneMuted(S);const w=this.localCallFeed.isVideoMuted();g.localUsermediaStream&&g.isLocalVideoMuted()!==w&&g.setLocalVideoMuted(w);const M=(_=g.getOpponentMember())==null?void 0:_.userId;if(m===St.Connected&&M){const C=this.retryCallCounts.get(M);C==null||C.delete(g.getOpponentDeviceId()),(C==null?void 0:C.size)===0&&this.retryCallCounts.delete(M)}},this.onCallHangup=g=>{var S;if(g.hangupReason===ii.Replaced)return;const m=((S=g.getOpponentMember())==null?void 0:S.userId)??this.room.getMember(g.invitee).userId,v=this.calls.get(m);(v==null?void 0:v.get(g.getOpponentDeviceId()))===g&&(this.disposeCall(g,g.hangupReason),v.delete(g.getOpponentDeviceId()),v.size===0&&this.calls.delete(m),this.emit("calls_changed",this.calls))},this.onCallReplaced=(g,m)=>{const v=g.getOpponentMember().userId;let S=this.calls.get(v);S===void 0&&(S=new Map,this.calls.set(v,S)),g.hangup(ii.Replaced,!1),this.initCall(m),S.set(g.getOpponentDeviceId(),m),this.emit("calls_changed",this.calls)},this.onActiveSpeakerLoop=()=>{let g,m;for(const v of this.userMediaFeeds){if(v.isLocal()&&this.userMediaFeeds.length>1)continue;const w=v.speakingVolumeSamples.reduce((M,_)=>M+Math.max(_,Sa))/v.speakingVolumeSamples.length;(!g||w>g)&&(g=w,m=v)}m&&this.activeSpeaker!==m&&g&&g>Sa&&(this.activeSpeaker=m,this.emit("active_speaker_changed",this.activeSpeaker))},this.onRoomState=()=>this.updateParticipants(),this.onParticipantsChanged=()=>{this.forEachCall(g=>{const m=this.callExpected(g);for(const v of g.getLocalFeeds())Ue(v.stream.getAudioTracks(),!v.isAudioMuted()&&m),Ue(v.stream.getVideoTracks(),!v.isVideoMuted()&&m)}),this.state==="entered"&&!this.useLivekit&&this.placeOutgoingCalls()},this.onStateChanged=(g,m)=>{(g==="entered"||m==="entered"||g==="ended")&&(this.updateParticipants(),this.updateMemberState().catch(v=>d.error(`GroupCall ${this.groupCallId} onStateChanged() failed to update member state devices"`,v)))},this.onLocalFeedsChanged=()=>{this.state==="entered"&&this.updateMemberState().catch(g=>d.error(`GroupCall ${this.groupCallId} onLocalFeedsChanged() failed to update member state feeds`,g))},this.reEmitter=new Xd(this),this.groupCallId=o??qi(),this._livekitServiceURL=h,this.creationTs=((f=t.currentState.getStateEvents(R.GroupCallPrefix,this.groupCallId))==null?void 0:f.getTs())??null,this.updateParticipants(),t.on(fe.Update,this.onRoomState),this.on("participants_changed",this.onParticipantsChanged),this.on("group_call_state_changed",this.onStateChanged),this.on("local_screenshare_state_changed",this.onLocalFeedsChanged),this.allowCallWithoutVideoAndAudio=!!l}async create(){return this.creationTs=Date.now(),this.client.groupCallEventHandler.groupCalls.set(this.room.roomId,this),this.client.emit(ba.Outgoing,this),await this.sendCallStateEvent(),this}async sendCallStateEvent(){const e={"m.intent":this.intent,"m.type":this.type,"io.element.ptt":this.isPtt,dataChannelsEnabled:this.dataChannelsEnabled,dataChannelOptions:this.dataChannelsEnabled?this.dataChannelOptions:void 0};this.livekitServiceURL&&(e["io.element.livekit_service_url"]=this.livekitServiceURL),await this.client.sendStateEvent(this.room.roomId,R.GroupCallPrefix,e,this.groupCallId)}get livekitServiceURL(){return this._livekitServiceURL}updateLivekitServiceURL(e){return this._livekitServiceURL=e,this.sendCallStateEvent()}get state(){return this._state}set state(e){const t=this._state;e!==t&&(this._state=e,this.emit("group_call_state_changed",e,t))}get participants(){return this._participants}set participants(e){const t=this._participants,i=(s,o)=>s.sessionId===o.sessionId&&s.screensharing===o.screensharing;_c(e,t,(s,o)=>_c(s,o,i))||(this._participants=e,this.emit("participants_changed",e))}get creationTs(){return this._creationTs}set creationTs(e){this._creationTs=e}get enteredViaAnotherSession(){return this._enteredViaAnotherSession}set enteredViaAnotherSession(e){this._enteredViaAnotherSession=e,this.updateParticipants()}forEachCall(e){for(const t of this.calls.values())for(const i of t.values())e(i)}getLocalFeeds(){const e=[];return this.localCallFeed&&e.push(this.localCallFeed),this.localScreenshareFeed&&e.push(this.localScreenshareFeed),e}hasLocalParticipant(){var e;return((e=this.participants.get(this.room.getMember(this.client.getUserId())))==null?void 0:e.has(this.client.getDeviceId()))??!1}callExpected(e){var s;const t=Xr(e),i=t===null?null:this.room.getMember(t),n=e.getOpponentDeviceId();return i!==null&&n!==void 0&&((s=this.participants.get(i))==null?void 0:s.get(n))!==void 0}async initLocalCallFeed(){if(this.useLivekit){d.info("Livekit group call: not starting local call feed.");return}if(this.state!=="local_call_feed_uninitialized")throw new Error(`Cannot initialize local call feed in the "${this.state}" state.`);if(this.state="initializing_local_call_feed",this.initCallFeedPromise)return this.initCallFeedPromise;try{this.initCallFeedPromise=this.initLocalCallFeedInternal(),await this.initCallFeedPromise}finally{this.initCallFeedPromise=void 0}}async initLocalCallFeedInternal(){d.log(`GroupCall ${this.groupCallId} initLocalCallFeedInternal() running`);let e;try{e=await this.client.getMediaHandler().getUserMediaStream(!0,this.type==="m.video")}catch(i){if(this.allowCallWithoutVideoAndAudio)e=new MediaStream;else throw this.state="local_call_feed_uninitialized",i}if(this._state!=="initializing_local_call_feed")throw this.client.getMediaHandler().stopUserMediaStream(e),new Error("Group call disposed while gathering media stream");const t=new oi({client:this.client,roomId:this.room.roomId,userId:this.client.getUserId(),deviceId:this.client.getDeviceId(),stream:e,purpose:Ee.Usermedia,audioMuted:this.initWithAudioMuted||e.getAudioTracks().length===0||this.isPtt,videoMuted:this.initWithVideoMuted||e.getVideoTracks().length===0});Ue(e.getAudioTracks(),!t.isAudioMuted()),Ue(e.getVideoTracks(),!t.isVideoMuted()),this.localCallFeed=t,this.addUserMediaFeed(t),this.state="local_call_feed_initialized"}async updateLocalUsermediaStream(e){if(this.localCallFeed){const t=this.localCallFeed.stream;this.localCallFeed.setNewStream(e);const i=this.localCallFeed.isAudioMuted(),n=this.localCallFeed.isVideoMuted();d.log(`GroupCall ${this.groupCallId} updateLocalUsermediaStream() (oldStreamId=${t.id}, newStreamId=${e.id}, micShouldBeMuted=${i}, vidShouldBeMuted=${n})`),Ue(e.getAudioTracks(),!i),Ue(e.getVideoTracks(),!n),this.client.getMediaHandler().stopUserMediaStream(t)}}async enter(){if(this.state==="local_call_feed_uninitialized")await this.initLocalCallFeed();else if(this.state!=="local_call_feed_initialized")throw new Error(`Cannot enter call in the "${this.state}" state`);d.log(`GroupCall ${this.groupCallId} enter() running`),this.state="entered",this.client.on(Ea.Incoming,this.onIncomingCall);for(const e of this.client.callEventHandler.calls.values())this.onIncomingCall(e);this.useLivekit||(this.retryCallLoopInterval=setInterval(this.onRetryCallLoop,this.retryCallInterval),this.activeSpeaker=void 0,this.onActiveSpeakerLoop(),this.activeSpeakerLoopInterval=setInterval(this.onActiveSpeakerLoop,this.activeSpeakerInterval))}dispose(){var e;this.localCallFeed&&(this.removeUserMediaFeed(this.localCallFeed),this.localCallFeed=void 0),this.localScreenshareFeed&&(this.client.getMediaHandler().stopScreensharingStream(this.localScreenshareFeed.stream),this.removeScreenshareFeed(this.localScreenshareFeed),this.localScreenshareFeed=void 0,this.localDesktopCapturerSourceId=void 0),this.client.getMediaHandler().stopAllStreams(),this.transmitTimer!==null&&(clearTimeout(this.transmitTimer),this.transmitTimer=null),this.retryCallLoopInterval!==void 0&&(clearInterval(this.retryCallLoopInterval),this.retryCallLoopInterval=void 0),this.participantsExpirationTimer!==null&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null),this.state==="entered"&&(this.forEachCall(t=>t.hangup(ii.UserHangup,!1)),this.activeSpeaker=void 0,clearInterval(this.activeSpeakerLoopInterval),this.retryCallCounts.clear(),clearInterval(this.retryCallLoopInterval),this.client.removeListener(Ea.Incoming,this.onIncomingCall),(e=this.stats)==null||e.stop())}leave(){this.dispose(),this.state="local_call_feed_uninitialized"}async terminate(e=!0){if(this.dispose(),this.room.off(fe.Update,this.onRoomState),this.client.groupCallEventHandler.groupCalls.delete(this.room.roomId),this.client.emit(ba.Ended,this),this.state="ended",e){const t=this.room.currentState.getStateEvents(R.GroupCallPrefix,this.groupCallId);await this.client.sendStateEvent(this.room.roomId,R.GroupCallPrefix,{...t.getContent(),"m.terminated":"call_ended"},this.groupCallId)}}isLocalVideoMuted(){return this.localCallFeed?this.localCallFeed.isVideoMuted():!0}isMicrophoneMuted(){return this.localCallFeed?this.localCallFeed.isAudioMuted():!0}async setMicrophoneMuted(e){if(!e&&!await this.client.getMediaHandler().hasAudioDevice())return!1;const t=!e&&this.isPtt;this.isPtt&&(!e&&this.isMicrophoneMuted()?this.transmitTimer=setTimeout(()=>{this.setMicrophoneMuted(!0)},this.pttMaxTransmitTime):e&&!this.isMicrophoneMuted()&&(this.transmitTimer!==null&&clearTimeout(this.transmitTimer),this.transmitTimer=null)),this.forEachCall(n=>{var s;return(s=n.localUsermediaFeed)==null?void 0:s.setAudioVideoMuted(e,null)});const i=async()=>{const n=[];this.forEachCall(s=>n.push(s.sendMetadataUpdate())),await Promise.all(n).catch(s=>d.info(`GroupCall ${this.groupCallId} setMicrophoneMuted() failed to send some metadata updates`,s))};if(t&&await i(),this.localCallFeed){if(d.log(`GroupCall ${this.groupCallId} setMicrophoneMuted() (streamId=${this.localCallFeed.stream.id}, muted=${e})`),!await this.checkAudioPermissionIfNecessary(e))return!1;this.localCallFeed.setAudioVideoMuted(e,null),Ue(this.localCallFeed.stream.getAudioTracks(),!e)}else d.log(`GroupCall ${this.groupCallId} setMicrophoneMuted() no stream muted (muted=${e})`),this.initWithAudioMuted=e;return this.forEachCall(n=>Ue(n.localUsermediaFeed.stream.getAudioTracks(),!e&&this.callExpected(n))),this.emit("local_mute_state_changed",e,this.isLocalVideoMuted()),t||await i(),!0}async checkAudioPermissionIfNecessary(e){try{if(!e&&this.localCallFeed&&!this.localCallFeed.hasAudioTrack){const t=await this.client.getMediaHandler().getUserMediaStream(!0,!this.localCallFeed.isVideoMuted());if((t==null?void 0:t.getTracks().length)===0)return d.log(`GroupCall ${this.groupCallId} setMicrophoneMuted() no device to receive local stream, muted=${e}`),!1}}catch{return d.log(`GroupCall ${this.groupCallId} setMicrophoneMuted() no device or permission to receive local stream, muted=${e}`),!1}return!0}async setLocalVideoMuted(e){if(!e&&!await this.client.getMediaHandler().hasVideoDevice())return!1;if(this.localCallFeed){d.log(`GroupCall ${this.groupCallId} setLocalVideoMuted() (stream=${this.localCallFeed.stream.id}, muted=${e})`);try{const i=await this.client.getMediaHandler().getUserMediaStream(!0,!e);await this.updateLocalUsermediaStream(i),this.localCallFeed.setAudioVideoMuted(null,e),Ue(this.localCallFeed.stream.getVideoTracks(),!e)}catch{return d.log(`GroupCall ${this.groupCallId} setLocalVideoMuted() no device or permission to receive local stream, muted=${e}`),!1}}else d.log(`GroupCall ${this.groupCallId} setLocalVideoMuted() no stream muted (muted=${e})`),this.initWithVideoMuted=e;const t=[];return this.forEachCall(i=>t.push(i.setLocalVideoMuted(e))),await Promise.all(t),this.forEachCall(i=>Ue(i.localUsermediaFeed.stream.getVideoTracks(),!e&&this.callExpected(i))),this.emit("local_mute_state_changed",this.isMicrophoneMuted(),e),!0}async setScreensharingEnabled(e,t={}){if(e===this.isScreensharing())return e;if(e)try{d.log(`GroupCall ${this.groupCallId} setScreensharingEnabled() is asking for screensharing permissions`);const i=await this.client.getMediaHandler().getScreensharingStream(t);for(const n of i.getTracks()){const s=()=>{this.setScreensharingEnabled(!1),n.removeEventListener("ended",s)};n.addEventListener("ended",s)}return d.log(`GroupCall ${this.groupCallId} setScreensharingEnabled() granted screensharing permissions. Setting screensharing enabled on all calls`),this.localDesktopCapturerSourceId=t.desktopCapturerSourceId,this.localScreenshareFeed=new oi({client:this.client,roomId:this.room.roomId,userId:this.client.getUserId(),deviceId:this.client.getDeviceId(),stream:i,purpose:Ee.Screenshare,audioMuted:!1,videoMuted:!1}),this.addScreenshareFeed(this.localScreenshareFeed),this.emit("local_screenshare_state_changed",!0,this.localScreenshareFeed,this.localDesktopCapturerSourceId),this.forEachCall(n=>n.pushLocalFeed(this.localScreenshareFeed.clone())),!0}catch(i){if(t.throwOnFail)throw i;return d.error(`GroupCall ${this.groupCallId} setScreensharingEnabled() enabling screensharing error`,i),this.emit("group_call_error",new _a("no_user_media","Failed to get screen-sharing stream: ",i)),!1}else return this.forEachCall(i=>{i.localScreensharingFeed&&i.removeLocalFeed(i.localScreensharingFeed)}),this.client.getMediaHandler().stopScreensharingStream(this.localScreenshareFeed.stream),this.removeScreenshareFeed(this.localScreenshareFeed),this.localScreenshareFeed=void 0,this.localDesktopCapturerSourceId=void 0,this.emit("local_screenshare_state_changed",!1,void 0,void 0),!1}isScreensharing(){return!!this.localScreenshareFeed}wantsOutgoingCall(e,t){const i=this.client.getUserId(),n=this.client.getDeviceId();return e>=i&&(e!==i||t>n)}placeOutgoingCalls(){let e=!1;for(const[{userId:t},i]of this.participants){const n=this.calls.get(t)??new Map;for(const[s,o]of i){const a=n.get(s);if((a==null?void 0:a.getOpponentSessionId())!==o.sessionId&&this.wantsOutgoingCall(t,s)){e=!0,a!==void 0&&(d.debug(`GroupCall ${this.groupCallId} placeOutgoingCalls() replacing call (userId=${t}, deviceId=${s}, callId=${a.callId})`),a.hangup(ii.NewSession,!1));const c=Ds(this.client,this.room.roomId,{invitee:t,opponentDeviceId:s,opponentSessionId:o.sessionId,groupCallId:this.groupCallId});c===null?(d.error(`GroupCall ${this.groupCallId} placeOutgoingCalls() failed to create call (userId=${t}, device=${s})`),n.delete(s)):(this.initCall(c),n.set(s,c),d.debug(`GroupCall ${this.groupCallId} placeOutgoingCalls() placing call (userId=${t}, deviceId=${s}, sessionId=${o.sessionId})`),c.placeCallWithCallFeeds(this.getLocalFeeds().map(l=>l.clone()),o.screensharing).then(()=>{this.dataChannelsEnabled&&c.createDataChannel("datachannel",this.dataChannelOptions)}).catch(l=>{d.warn(`GroupCall ${this.groupCallId} placeOutgoingCalls() failed to place call (userId=${t})`,l),l instanceof ni&&l.code==="unknown_device"?this.emit("group_call_error",l):this.emit("group_call_error",new _a("place_call_failed",`Failed to place call to ${t}`)),c.hangup(ii.SignallingFailed,!1),n.get(s)===c&&n.delete(s)}))}}n.size>0?this.calls.set(t,n):this.calls.delete(t)}e&&this.emit("calls_changed",this.calls)}getMemberStateEvents(e){return e===void 0?this.room.currentState.getStateEvents(R.GroupCallMemberPrefix):this.room.currentState.getStateEvents(R.GroupCallMemberPrefix,e)}initCall(e){const t=Xr(e);if(!t)throw new Error("Cannot init call without user id");const i=()=>this.onCallFeedsChanged(e),n=(c,l)=>this.onCallStateChanged(e,c,l),s=this.onCallHangup,o=c=>this.onCallReplaced(e,c);let a=this.callHandlers.get(t);a===void 0&&(a=new Map,this.callHandlers.set(t,a)),a.set(e.getOpponentDeviceId(),{onCallFeedsChanged:i,onCallStateChanged:n,onCallHangup:s,onCallReplaced:o}),e.on(vt.FeedsChanged,i),e.on(vt.State,n),e.on(vt.Hangup,s),e.on(vt.Replaced,o),e.isPtt=this.isPtt,this.reEmitter.reEmit(e,Object.values(vt)),e.initStats(this.getGroupCallStats()),i()}disposeCall(e,t){const i=Xr(e),n=e.getOpponentDeviceId();if(!i)throw new Error("Cannot dispose call without user id");const s=this.callHandlers.get(i),{onCallFeedsChanged:o,onCallStateChanged:a,onCallHangup:c,onCallReplaced:l}=s.get(n);if(e.removeListener(vt.FeedsChanged,o),e.removeListener(vt.State,a),e.removeListener(vt.Hangup,c),e.removeListener(vt.Replaced,l),s.delete(i),s.size===0&&this.callHandlers.delete(i),e.hangupReason===ii.Replaced)return;const u=this.getUserMediaFeed(i,n);u&&this.removeUserMediaFeed(u);const h=this.getScreenshareFeed(i,n);h&&this.removeScreenshareFeed(h)}getUserMediaFeed(e,t){return this.userMediaFeeds.find(i=>i.userId===e&&i.deviceId===t)}addUserMediaFeed(e){this.userMediaFeeds.push(e),e.measureVolumeActivity(!0),this.emit("user_media_feeds_changed",this.userMediaFeeds)}replaceUserMediaFeed(e,t){const i=this.userMediaFeeds.findIndex(n=>n.userId===e.userId&&n.deviceId===e.deviceId);if(i===-1)throw new Error("Couldn't find user media feed to replace");this.userMediaFeeds.splice(i,1,t),e.dispose(),t.measureVolumeActivity(!0),this.emit("user_media_feeds_changed",this.userMediaFeeds)}removeUserMediaFeed(e){const t=this.userMediaFeeds.findIndex(i=>i.userId===e.userId&&i.deviceId===e.deviceId);if(t===-1)throw new Error("Couldn't find user media feed to remove");this.userMediaFeeds.splice(t,1),e.dispose(),this.emit("user_media_feeds_changed",this.userMediaFeeds),this.activeSpeaker===e&&(this.activeSpeaker=this.userMediaFeeds[0],this.emit("active_speaker_changed",this.activeSpeaker))}getScreenshareFeed(e,t){return this.screenshareFeeds.find(i=>i.userId===e&&i.deviceId===t)}addScreenshareFeed(e){this.screenshareFeeds.push(e),this.emit("screenshare_feeds_changed",this.screenshareFeeds)}replaceScreenshareFeed(e,t){const i=this.screenshareFeeds.findIndex(n=>n.userId===e.userId&&n.deviceId===e.deviceId);if(i===-1)throw new Error("Couldn't find screenshare feed to replace");this.screenshareFeeds.splice(i,1,t),e.dispose(),this.emit("screenshare_feeds_changed",this.screenshareFeeds)}removeScreenshareFeed(e){const t=this.screenshareFeeds.findIndex(i=>i.userId===e.userId&&i.deviceId===e.deviceId);if(t===-1)throw new Error("Couldn't find screenshare feed to remove");this.screenshareFeeds.splice(t,1),e.dispose(),this.emit("screenshare_feeds_changed",this.screenshareFeeds)}updateParticipants(){const e=this.room.getMember(this.client.getUserId());if(!e){d.warn(`GroupCall ${this.groupCallId} updateParticipants() tried to update participants before local room member is available`);return}if(this.participantsExpirationTimer!==null&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null),this.state==="ended"){this.participants=new Map;return}const t=new Map,i=Date.now(),n=this.state==="entered"||this.enteredViaAnotherSession;let s=1/0;for(const o of this.getMemberStateEvents()){const a=this.room.getMember(o.getStateKey()),c=o.getContent(),u=(Array.isArray(c["m.calls"])?c["m.calls"]:[]).find(g=>g["m.call_id"]===this.groupCallId);let f=(Array.isArray(u==null?void 0:u["m.devices"])?u["m.devices"]:[]).filter(g=>typeof g.device_id=="string"&&typeof g.session_id=="string"&&typeof g.expires_ts=="number"&&g.expires_ts>i&&Array.isArray(g.feeds));if(!n&&(a==null?void 0:a.userId)===this.client.getUserId()&&(f=f.filter(g=>g.device_id!==this.client.getDeviceId())),f.length>0&&(a==null?void 0:a.membership)===ae.Join){const g=new Map;t.set(a,g);for(const m of f)g.set(m.device_id,{sessionId:m.session_id,screensharing:m.feeds.some(v=>v.purpose===Ee.Screenshare)}),m.expires_ts<s&&(s=m.expires_ts)}}if(n){let o=t.get(e);o===void 0&&(o=new Map,t.set(e,o)),o.has(this.client.getDeviceId())||o.set(this.client.getDeviceId(),{sessionId:this.client.getSessionId(),screensharing:this.getLocalFeeds().some(a=>a.purpose===Ee.Screenshare)})}this.participants=t,s<1/0&&(this.participantsExpirationTimer=setTimeout(()=>this.updateParticipants(),s-i))}async updateDevices(e,t=!1){const i=Date.now(),n=this.client.getUserId(),s=this.getMemberStateEvents(n),o=(s==null?void 0:s.getContent())??{},a=Array.isArray(o["m.calls"])?o["m.calls"]:[];let c=null;const l=[];for(const v of a)v["m.call_id"]===this.groupCallId?c=v:l.push(v);c===null&&(c={});const h=(Array.isArray(c["m.devices"])?c["m.devices"]:[]).filter(v=>typeof v.device_id=="string"&&typeof v.session_id=="string"&&typeof v.expires_ts=="number"&&v.expires_ts>i&&Array.isArray(v.feeds)),f=e(h);if(f===null)return;const g=[...l];f.length>0&&g.push({...c,"m.call_id":this.groupCallId,"m.devices":f});const m={"m.calls":g};await this.client.sendStateEvent(this.room.roomId,R.GroupCallMemberPrefix,m,n,{keepAlive:t})}async addDeviceToMemberState(){await this.updateDevices(e=>[...e.filter(t=>t.device_id!==this.client.getDeviceId()),{device_id:this.client.getDeviceId(),session_id:this.client.getSessionId(),expires_ts:Date.now()+hl,feeds:this.getLocalFeeds().map(t=>({purpose:t.purpose}))}])}async updateMemberState(){this.resendMemberStateTimer!==null&&(clearInterval(this.resendMemberStateTimer),this.resendMemberStateTimer=null),this.state==="entered"?(await this.addDeviceToMemberState(),this.resendMemberStateTimer=setInterval(async()=>{d.log(`GroupCall ${this.groupCallId} updateMemberState() resending call member state"`);try{await this.addDeviceToMemberState()}catch(e){d.error(`GroupCall ${this.groupCallId} updateMemberState() failed to resend call member state`,e)}},hl*3/4)):await this.updateDevices(e=>e.filter(t=>t.device_id!==this.client.getDeviceId()),!0)}async cleanMemberState(){const{devices:e}=await this.client.getDevices(),t=new Map(e.map(i=>[i.device_id,i]));await this.updateDevices(i=>{const n=i.filter(s=>{const o=t.get(s.device_id);return(o==null?void 0:o.last_seen_ts)!==void 0&&!(s.device_id===this.client.getDeviceId()&&this.state!=="entered"&&!this.enteredViaAnotherSession)});return n.length===i.length?null:n})}getGroupCallStats(){if(this.stats===void 0){const e=this.client.getUserId()||"unknown";this.stats=new gv(this.groupCallId,e,this.statsCollectIntervalTime),this.stats.reports.on(ci.CONNECTION_STATS,this.onConnectionStats),this.stats.reports.on(ci.BYTE_SENT_STATS,this.onByteSentStats),this.stats.reports.on(ci.SUMMARY_STATS,this.onSummaryStats),this.stats.reports.on(ci.CALL_FEED_REPORT,this.onCallFeedReport)}return this.stats}setGroupCallStatsInterval(e){this.statsCollectIntervalTime=e,this.stats!==void 0&&(this.stats.stop(),this.stats.setInterval(e),e>0&&this.stats.start())}}var St=(r=>(r.Fledgling="fledgling",r.InviteSent="invite_sent",r.WaitLocalMedia="wait_local_media",r.CreateOffer="create_offer",r.CreateAnswer="create_answer",r.Connecting="connecting",r.Connected="connected",r.Ringing="ringing",r.Ended="ended",r))(St||{}),Eu=(r=>(r.Inbound="inbound",r.Outbound="outbound",r))(Eu||{}),vt=(r=>(r.Hangup="hangup",r.State="state",r.Error="error",r.Replaced="replaced",r.LocalHoldUnhold="local_hold_unhold",r.RemoteHoldUnhold="remote_hold_unhold",r.HoldUnhold="hold_unhold",r.FeedsChanged="feeds_changed",r.AssertedIdentityChanged="asserted_identity_changed",r.LengthChanged="length_changed",r.DataChannel="datachannel",r.SendVoipEvent="send_voip_event",r.PeerConnectionCreated="peer_connection_created",r))(vt||{}),ii=(r=>(r.UserHangup="user_hangup",r.LocalOfferFailed="local_offer_failed",r.NoUserMedia="no_user_media",r.UnknownDevices="unknown_devices",r.SendInvite="send_invite",r.CreateAnswer="create_answer",r.CreateOffer="create_offer",r.SendAnswer="send_answer",r.SetRemoteDescription="set_remote_description",r.SetLocalDescription="set_local_description",r.AnsweredElsewhere="answered_elsewhere",r.IceFailed="ice_failed",r.InviteTimeout="invite_timeout",r.Replaced="replaced",r.SignallingFailed="signalling_timeout",r.UserBusy="user_busy",r.Transferred="transferred",r.NewSession="new_session",r))(ii||{});const pv="1",mv="stun:turn.matrix.org",Co=60*1e3,vv=1e3,yv=30*1e3,Sv=2*1e3;class ni extends Error{constructor(e,t,i){super(t+": "+i),this.code=e}}function qi(){return Date.now().toString()+rn(16)}function fl(r){return[{mediaType:"audio",codec:"opus",enableDtx:!0,maxAverageBitrate:r?12e3:void 0}]}function kt(r,e){return r+":"+e}class Ev extends ke{constructor(e){if(super(),this.toDeviceSeq=0,this.isPtt=!1,this._state="fledgling",this.candidateSendQueue=[],this.candidateSendTries=0,this.candidatesEnded=!1,this.feeds=[],this.transceivers=new Map,this.inviteOrAnswerSent=!1,this.waitForLocalAVStream=!1,this.removeTrackListeners=new Map,this.remoteOnHold=!1,this.makingOffer=!1,this.ignoreOffer=!1,this.isSettingRemoteAnswerPending=!1,this.remoteCandidateBuffer=new Map,this.gotLocalIceCandidate=t=>{if(t.candidate){if(this.candidatesEnded&&d.warn(`Call ${this.callId} gotLocalIceCandidate() got candidate after candidates have ended!`),d.debug(`Call ${this.callId} got local ICE ${t.candidate.sdpMid} ${t.candidate.candidate}`),this.callHasEnded())return;t.candidate.candidate===""?this.queueCandidate(null):this.queueCandidate(t.candidate)}},this.onIceGatheringStateChange=t=>{var i;d.debug(`Call ${this.callId} onIceGatheringStateChange() ice gathering state changed to ${this.peerConn.iceGatheringState}`),((i=this.peerConn)==null?void 0:i.iceGatheringState)==="complete"&&(this.queueCandidate(null),d.debug(`Call ${this.callId} onIceGatheringStateChange() ice gathering state complete, set candidates have ended`))},this.getLocalOfferFailed=t=>{d.error(`Call ${this.callId} getLocalOfferFailed() running`,t),this.emit("error",new ni("local_offer_failed","Failed to get local offer!",t),this),this.terminate("local","local_offer_failed",!1)},this.getUserMediaFailed=t=>{if(this.successor){this.successor.getUserMediaFailed(t);return}d.warn(`Call ${this.callId} getUserMediaFailed() failed to get user media - ending call`,t),this.emit("error",new ni("no_user_media","Couldn't start capturing media! Is your microphone set up and does this app have permission?",t),this),this.terminate("local","no_user_media",!1)},this.placeCallFailed=t=>{if(this.successor){this.successor.placeCallFailed(t);return}d.warn(`Call ${this.callId} placeCallWithCallFeeds() failed - ending call`,t),this.emit("error",new ni("ice_failed","Couldn't start call! Invalid ICE server configuration.",t),this),this.terminate("local","ice_failed",!1)},this.onIceConnectionStateChanged=()=>{var t,i,n,s,o,a,c;if(!this.callHasEnded()&&(d.debug(`Call ${this.callId} onIceConnectionStateChanged() running (state=${(t=this.peerConn)==null?void 0:t.iceConnectionState}, conn=${(i=this.peerConn)==null?void 0:i.connectionState})`),["connected","completed"].includes(((n=this.peerConn)==null?void 0:n.iceConnectionState)??"")?(clearTimeout(this.iceDisconnectedTimeout),this.iceDisconnectedTimeout=void 0,this.iceReconnectionTimeOut&&clearTimeout(this.iceReconnectionTimeOut),this.state="connected",!this.callLengthInterval&&!this.callStartTime&&(this.callStartTime=Date.now(),this.callLengthInterval=setInterval(()=>{this.emit("length_changed",Math.round((Date.now()-this.callStartTime)/1e3),this)},vv))):((s=this.peerConn)==null?void 0:s.iceConnectionState)=="failed"?(this.candidatesEnded=!1,(o=this.peerConn)!=null&&o.restartIce?(this.candidatesEnded=!1,d.debug(`Call ${this.callId} onIceConnectionStateChanged() ice restart (state=${(a=this.peerConn)==null?void 0:a.iceConnectionState})`),this.peerConn.restartIce()):(d.info(`Call ${this.callId} onIceConnectionStateChanged() hanging up call (ICE failed and no ICE restart method)`),this.hangup("ice_failed",!1))):((c=this.peerConn)==null?void 0:c.iceConnectionState)=="disconnected"&&(this.candidatesEnded=!1,this.iceReconnectionTimeOut=setTimeout(()=>{var l,u,h;d.info(`Call ${this.callId} onIceConnectionStateChanged() ICE restarting because of ICE disconnected, (state=${(l=this.peerConn)==null?void 0:l.iceConnectionState}, conn=${(u=this.peerConn)==null?void 0:u.connectionState})`),(h=this.peerConn)!=null&&h.restartIce&&(this.candidatesEnded=!1,this.peerConn.restartIce()),this.iceReconnectionTimeOut=void 0},Sv),this.iceDisconnectedTimeout=setTimeout(()=>{d.info(`Call ${this.callId} onIceConnectionStateChanged() hanging up call (ICE disconnected for too long)`),this.hangup("ice_failed",!1)},yv),this.state="connecting"),this.isPtt&&["failed","disconnected"].includes(this.peerConn.iceConnectionState)))for(const l of this.getRemoteFeeds())l.setAudioVideoMuted(!0,!0)},this.onSignallingStateChanged=()=>{var t;d.debug(`Call ${this.callId} onSignallingStateChanged() running (state=${(t=this.peerConn)==null?void 0:t.signalingState})`)},this.onTrack=t=>{if(t.streams.length===0){d.warn(`Call ${this.callId} onTrack() called with streamless track streamless (kind=${t.track.kind})`);return}const i=t.streams[0];if(this.pushRemoteFeed(i),!this.removeTrackListeners.has(i)){const n=()=>{i.getTracks().length===0&&(d.info(`Call ${this.callId} onTrack() removing track (streamId=${i.id})`),this.deleteFeedByStream(i),i.removeEventListener("removetrack",n),this.removeTrackListeners.delete(i))};i.addEventListener("removetrack",n),this.removeTrackListeners.set(i,n)}},this.onDataChannel=t=>{this.emit("datachannel",t.channel,this)},this.onNegotiationNeeded=async()=>{if(d.info(`Call ${this.callId} onNegotiationNeeded() negotiation is needed!`),this.state!=="create_offer"&&this.opponentVersion===0){d.info(`Call ${this.callId} onNegotiationNeeded() opponent does not support renegotiation: ignoring negotiationneeded event`);return}this.queueGotLocalOffer()},this.onHangupReceived=t=>{d.debug(`Call ${this.callId} onHangupReceived() running`),this.partyIdMatches(t)||this.state==="ringing"?this.terminate("remote",t.reason||"user_hangup",!0):d.info(`Call ${this.callId} onHangupReceived() ignoring message from party ID ${t.party_id}: our partner is ${this.opponentPartyId}`)},this.onRejectReceived=t=>{d.debug(`Call ${this.callId} onRejectReceived() running`),["invite_sent","ringing"].includes(this.state)||this.state==="fledgling"&&this.direction==="inbound"?this.terminate("remote",t.reason||"user_hangup",!0):d.debug(`Call ${this.callId} onRejectReceived() called in wrong state (state=${this.state})`)},this.onAnsweredElsewhere=t=>{d.debug(`Call ${this.callId} onAnsweredElsewhere() running`),this.terminate("remote","answered_elsewhere",!0)},this.roomId=e.roomId,this.invitee=e.invitee,this.client=e.client,!this.client.deviceId)throw new Error("Client must have a device ID to start calls");this.forceTURN=e.forceTURN??!1,this.ourPartyId=this.client.deviceId,this.opponentDeviceId=e.opponentDeviceId,this.opponentSessionId=e.opponentSessionId,this.groupCallId=e.groupCallId,this.turnServers=e.turnServers||[],this.turnServers.length===0&&this.client.isFallbackICEServerAllowed()&&this.turnServers.push({urls:[mv]});for(const t of this.turnServers)bd(t,["urls"]);this.callId=qi(),this.isOnlyDataChannelAllowed=this.client.isVoipWithNoMediaAllowed}async placeVoiceCall(){await this.placeCall(!0,!1)}async placeVideoCall(){await this.placeCall(!0,!0)}createDataChannel(e,t){const i=this.peerConn.createDataChannel(e,t);return this.emit("datachannel",i,this),i}getOpponentMember(){return this.opponentMember}getOpponentDeviceId(){return this.opponentDeviceId}getOpponentSessionId(){return this.opponentSessionId}opponentCanBeTransferred(){return!!(this.opponentCaps&&this.opponentCaps["m.call.transferee"])}opponentSupportsDTMF(){return!!(this.opponentCaps&&this.opponentCaps["m.call.dtmf"])}getRemoteAssertedIdentity(){return this.remoteAssertedIdentity}get state(){return this._state}set state(e){const t=this._state;this._state=e,this.emit("state",e,t,this)}get type(){return this.hasUserMediaVideoSender||this.hasRemoteUserMediaVideoTrack?"video":"voice"}get hasLocalUserMediaVideoTrack(){var e;return!!((e=this.localUsermediaStream)!=null&&e.getVideoTracks().length)}get hasRemoteUserMediaVideoTrack(){return this.getRemoteFeeds().some(e=>{var t;return e.purpose===Ee.Usermedia&&((t=e.stream)==null?void 0:t.getVideoTracks().length)})}get hasLocalUserMediaAudioTrack(){var e;return!!((e=this.localUsermediaStream)!=null&&e.getAudioTracks().length)}get hasRemoteUserMediaAudioTrack(){return this.getRemoteFeeds().some(e=>{var t;return e.purpose===Ee.Usermedia&&!!((t=e.stream)!=null&&t.getAudioTracks().length)})}get hasUserMediaAudioSender(){var e;return!!((e=this.transceivers.get(kt(Ee.Usermedia,"audio")))!=null&&e.sender)}get hasUserMediaVideoSender(){var e;return!!((e=this.transceivers.get(kt(Ee.Usermedia,"video")))!=null&&e.sender)}get localUsermediaFeed(){return this.getLocalFeeds().find(e=>e.purpose===Ee.Usermedia)}get localScreensharingFeed(){return this.getLocalFeeds().find(e=>e.purpose===Ee.Screenshare)}get localUsermediaStream(){var e;return(e=this.localUsermediaFeed)==null?void 0:e.stream}get localScreensharingStream(){var e;return(e=this.localScreensharingFeed)==null?void 0:e.stream}get remoteUsermediaFeed(){return this.getRemoteFeeds().find(e=>e.purpose===Ee.Usermedia)}get remoteScreensharingFeed(){return this.getRemoteFeeds().find(e=>e.purpose===Ee.Screenshare)}get remoteUsermediaStream(){var e;return(e=this.remoteUsermediaFeed)==null?void 0:e.stream}get remoteScreensharingStream(){var e;return(e=this.remoteScreensharingFeed)==null?void 0:e.stream}getFeedByStreamId(e){return this.getFeeds().find(t=>t.stream.id===e)}getFeeds(){return this.feeds}getLocalFeeds(){return this.feeds.filter(e=>e.isLocal())}getRemoteFeeds(){return this.feeds.filter(e=>!e.isLocal())}async initOpponentCrypto(){var i,n;if(!this.opponentDeviceId||!this.client.getUseE2eForGroupCall())return;if(!this.client.isCryptoEnabled()){this.opponentDeviceInfo=new ht(this.opponentDeviceId);return}if(!this.client.crypto)throw new Error("Crypto is not initialised.");const e=this.invitee||((i=this.getOpponentMember())==null?void 0:i.userId);if(!e)throw new Error("Couldn't find opponent user ID to init crypto");const t=await this.client.crypto.deviceList.downloadKeys([e],!1);if(this.opponentDeviceInfo=(n=t.get(e))==null?void 0:n.get(this.opponentDeviceId),this.opponentDeviceInfo===void 0)throw new vu(e)}getLocalSDPStreamMetadata(e=!1){const t={};for(const i of this.getLocalFeeds())e&&(i.sdpMetadataStreamId=i.stream.id),t[i.sdpMetadataStreamId]={purpose:i.purpose,audio_muted:i.isAudioMuted(),video_muted:i.isVideoMuted()};return t}noIncomingFeeds(){return!this.feeds.some(e=>!e.isLocal())}pushRemoteFeed(e){if(!this.opponentSupportsSDPStreamMetadata()){this.pushRemoteFeedWithoutMetadata(e);return}const t=this.getOpponentMember().userId,i=this.remoteSDPStreamMetadata[e.id].purpose,n=this.remoteSDPStreamMetadata[e.id].audio_muted,s=this.remoteSDPStreamMetadata[e.id].video_muted;if(!i){d.warn(`Call ${this.callId} pushRemoteFeed() ignoring stream because we didn't get any metadata about it (streamId=${e.id})`);return}if(this.getFeedByStreamId(e.id)){d.warn(`Call ${this.callId} pushRemoteFeed() ignoring stream because we already have a feed for it (streamId=${e.id})`);return}this.feeds.push(new oi({client:this.client,call:this,roomId:this.roomId,userId:t,deviceId:this.getOpponentDeviceId(),stream:e,purpose:i,audioMuted:n,videoMuted:s})),this.emit("feeds_changed",this.feeds,this),d.info(`Call ${this.callId} pushRemoteFeed() pushed stream (streamId=${e.id}, active=${e.active}, purpose=${i})`)}pushRemoteFeedWithoutMetadata(e){var s;const t=this.getOpponentMember().userId,i=Ee.Usermedia,n=(s=this.feeds.find(o=>!o.isLocal()))==null?void 0:s.stream;if(n&&e.id!==n.id){d.warn(`Call ${this.callId} pushRemoteFeedWithoutMetadata() ignoring new stream because we already have stream (streamId=${e.id})`);return}if(this.getFeedByStreamId(e.id)){d.warn(`Call ${this.callId} pushRemoteFeedWithoutMetadata() ignoring stream because we already have a feed for it (streamId=${e.id})`);return}this.feeds.push(new oi({client:this.client,call:this,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:t,deviceId:this.getOpponentDeviceId(),stream:e,purpose:i})),this.emit("feeds_changed",this.feeds,this),d.info(`Call ${this.callId} pushRemoteFeedWithoutMetadata() pushed stream (streamId=${e.id}, active=${e.active})`)}pushNewLocalFeed(e,t,i=!0){const n=this.client.getUserId();if(Ue(e.getAudioTracks(),!0),Ue(e.getVideoTracks(),!0),this.getFeedByStreamId(e.id)){d.warn(`Call ${this.callId} pushNewLocalFeed() ignoring stream because we already have a feed for it (streamId=${e.id})`);return}this.pushLocalFeed(new oi({client:this.client,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:n,deviceId:this.getOpponentDeviceId(),stream:e,purpose:t}),i)}pushLocalFeed(e,t=!0){if(this.feeds.some(i=>e.stream.id===i.stream.id)){d.info(`Call ${this.callId} pushLocalFeed() ignoring duplicate local stream (streamId=${e.stream.id})`);return}if(this.feeds.push(e),t)for(const i of e.stream.getTracks()){d.info(`Call ${this.callId} pushLocalFeed() adding track to peer connection (id=${i.id}, kind=${i.kind}, streamId=${e.stream.id}, streamPurpose=${e.purpose}, enabled=${i.enabled})`);const n=kt(e.purpose,i.kind);if(this.transceivers.has(n)){const s=this.transceivers.get(n);s.sender.replaceTrack(i),s.direction=s.direction==="inactive"?"sendonly":"sendrecv"}else{const s=this.peerConn.addTrack(i,e.stream),o=this.peerConn.getTransceivers().find(a=>a.sender===s);o?this.transceivers.set(n,o):d.warn(`Call ${this.callId} pushLocalFeed() didn't find a matching transceiver after adding track!`)}}d.info(`Call ${this.callId} pushLocalFeed() pushed stream (id=${e.stream.id}, active=${e.stream.active}, purpose=${e.purpose})`),this.emit("feeds_changed",this.feeds,this)}removeLocalFeed(e){const t=kt(e.purpose,"audio"),i=kt(e.purpose,"video");for(const n of[t,i])if(this.transceivers.has(n)){const s=this.transceivers.get(n);s.sender&&this.peerConn.removeTrack(s.sender)}e.purpose===Ee.Screenshare&&this.client.getMediaHandler().stopScreensharingStream(e.stream),this.deleteFeed(e)}deleteAllFeeds(){for(const e of this.feeds)(!e.isLocal()||!this.groupCallId)&&e.dispose();this.feeds=[],this.emit("feeds_changed",this.feeds,this)}deleteFeedByStream(e){const t=this.getFeedByStreamId(e.id);if(!t){d.warn(`Call ${this.callId} deleteFeedByStream() didn't find the feed to delete (streamId=${e.id})`);return}this.deleteFeed(t)}deleteFeed(e){e.dispose(),this.feeds.splice(this.feeds.indexOf(e),1),this.emit("feeds_changed",this.feeds,this)}async getCurrentCallStats(){return this.callHasEnded()?this.callStatsAtEnd:this.collectCallStats()}async collectCallStats(){if(!this.peerConn)return;const e=await this.peerConn.getStats(),t=[];return e.forEach(i=>{t.push(i)}),t}async initWithInvite(e){var o;const t=e.getContent();this.direction="inbound",await this.client.checkTurnServers()||d.warn(`Call ${this.callId} initWithInvite() failed to get TURN credentials! Proceeding with call anyway...`);const n=t[yi];n?this.updateRemoteSDPStreamMetadata(n):d.debug(`Call ${this.callId} initWithInvite() did not get any SDPStreamMetadata! Can not send/receive multiple streams`),this.peerConn=this.createPeerConnection(),this.emit("peer_connection_created",this.peerConn,this),this.chooseOpponent(e),await this.initOpponentCrypto();try{await this.peerConn.setRemoteDescription(t.offer),d.debug(`Call ${this.callId} initWithInvite() set remote description: ${t.offer.type}`),await this.addBufferedIceCandidates()}catch(a){d.debug(`Call ${this.callId} initWithInvite() failed to set remote description`,a),this.terminate("local","set_remote_description",!1);return}const s=(o=this.feeds.find(a=>!a.isLocal()))==null?void 0:o.stream;if(!this.isOnlyDataChannelAllowed&&(!s||s.getTracks().length===0)){d.error(`Call ${this.callId} initWithInvite() no remote stream or no tracks after setting remote description!`),this.terminate("local","set_remote_description",!1);return}if(this.state="ringing",e.getLocalAge()){const a=setTimeout(()=>{var l;this.state=="ringing"&&(d.debug(`Call ${this.callId} initWithInvite() invite has expired. Hanging up.`),this.hangupParty="remote",this.state="ended",this.stopAllMedia(),this.peerConn.signalingState!="closed"&&this.peerConn.close(),(l=this.stats)==null||l.removeStatsReportGatherer(this.callId),this.emit("hangup",this))},t.lifetime-e.getLocalAge()),c=l=>{l!=="ringing"&&(clearTimeout(a),this.off("state",c))};this.on("state",c)}}initWithHangup(e){this.state="ended"}shouldAnswerWithMediaType(e,t,i){return e&&!t?(d.warn(`Call ${this.callId} shouldAnswerWithMediaType() unable to answer with ${i} because the other side isn't sending it either.`),!1):!Rd(e)&&e!==t&&!this.opponentSupportsSDPStreamMetadata()?(d.warn(`Call ${this.callId} shouldAnswerWithMediaType() unable to answer with ${i}=${e} because the other side doesn't support it. Answering with ${i}=${t}.`),t):e??t}async answer(e,t){if(!this.inviteOrAnswerSent){if(e===!1&&t===!1)throw new Error("You CANNOT answer a call without media");if(!this.localUsermediaStream&&!this.waitForLocalAVStream){const i=this.state,n=this.shouldAnswerWithMediaType(e,this.hasRemoteUserMediaAudioTrack,"audio"),s=this.shouldAnswerWithMediaType(t,this.hasRemoteUserMediaVideoTrack,"video");this.state="wait_local_media",this.waitForLocalAVStream=!0;try{const o=await this.client.getMediaHandler().getUserMediaStream(n,s);this.waitForLocalAVStream=!1;const c=[new oi({client:this.client,roomId:this.roomId,userId:this.client.getUserId(),deviceId:this.client.getDeviceId()??void 0,stream:o,purpose:Ee.Usermedia,audioMuted:!1,videoMuted:!1})];this.localScreensharingFeed&&c.push(this.localScreensharingFeed),this.answerWithCallFeeds(c)}catch(o){if(s)d.warn(`Call ${this.callId} answer() failed to getUserMedia(), trying to getUserMedia() without video`),this.state=i,this.waitForLocalAVStream=!1,await this.answer(n,!1);else{this.getUserMediaFailed(o);return}}}else this.waitForLocalAVStream&&(this.state="wait_local_media")}}answerWithCallFeeds(e){this.inviteOrAnswerSent||this.queueGotCallFeedsForAnswer(e)}replacedBy(e){d.debug(`Call ${this.callId} replacedBy() running (newCallId=${e.callId})`),this.state==="wait_local_media"?(d.debug(`Call ${this.callId} replacedBy() telling new call to wait for local media (newCallId=${e.callId})`),e.waitForLocalAVStream=!0):["create_offer","invite_sent"].includes(this.state)&&(e.direction==="outbound"?e.queueGotCallFeedsForAnswer([]):(d.debug(`Call ${this.callId} replacedBy() handing local stream to new call(newCallId=${e.callId})`),e.queueGotCallFeedsForAnswer(this.getLocalFeeds().map(t=>t.clone())))),this.successor=e,this.emit("replaced",e,this),this.hangup("replaced",!0)}hangup(e,t){if(this.callHasEnded()||(d.debug(`Call ${this.callId} hangup() ending call (reason=${e})`),this.terminate("local",e,!t),["fledgling","wait_local_media"].includes(this.state)))return;const i={};(this.opponentVersion&&this.opponentVersion!==0||e!=="user_hangup")&&(i.reason=e),this.sendVoipEvent(R.CallHangup,i)}reject(){if(this.state!=="ringing")throw Error("Call must be in 'ringing' state to reject!");if(this.opponentVersion===0){d.info(`Call ${this.callId} reject() opponent version is less than 1: sending hangup instead of reject (opponentVersion=${this.opponentVersion})`),this.hangup("user_hangup",!0);return}d.debug("Rejecting call: "+this.callId),this.terminate("local","user_hangup",!0),this.sendVoipEvent(R.CallReject,{})}async upgradeCall(e,t){if(!(!e&&!t)&&this.opponentSupportsSDPStreamMetadata())try{d.debug(`Call ${this.callId} upgradeCall() upgrading call (audio=${e}, video=${t})`);const i=e||this.hasLocalUserMediaAudioTrack,n=t||this.hasLocalUserMediaVideoTrack,s=await this.client.getMediaHandler().getUserMediaStream(i,n,!1);await this.updateLocalUsermediaStream(s,e,t)}catch(i){d.error(`Call ${this.callId} upgradeCall() failed to upgrade the call`,i),this.emit("error",new ni("no_user_media","Failed to get camera access: ",i),this)}}opponentSupportsSDPStreamMetadata(){return!!this.remoteSDPStreamMetadata}isScreensharing(){return!!this.localScreensharingStream}async setScreensharingEnabled(e,t){if(e&&this.isScreensharing())return d.warn(`Call ${this.callId} setScreensharingEnabled() there is already a screensharing stream - there is nothing to do!`),!0;if(!e&&!this.isScreensharing())return d.warn(`Call ${this.callId} setScreensharingEnabled() there already isn't a screensharing stream - there is nothing to do!`),!1;if(!this.opponentSupportsSDPStreamMetadata())return this.setScreensharingEnabledWithoutMetadataSupport(e,t);if(d.debug(`Call ${this.callId} setScreensharingEnabled() running (enabled=${e})`),e)try{const i=await this.client.getMediaHandler().getScreensharingStream(t);return i?(this.pushNewLocalFeed(i,Ee.Screenshare),!0):!1}catch(i){return d.error(`Call ${this.callId} setScreensharingEnabled() failed to get screen-sharing stream:`,i),!1}else{const i=this.transceivers.get(kt(Ee.Screenshare,"audio")),n=this.transceivers.get(kt(Ee.Screenshare,"video"));for(const s of[i,n])s&&s.sender&&this.peerConn.removeTrack(s.sender);return this.client.getMediaHandler().stopScreensharingStream(this.localScreensharingStream),this.deleteFeedByStream(this.localScreensharingStream),!1}}async setScreensharingEnabledWithoutMetadataSupport(e,t){var i,n,s;if(d.debug(`Call ${this.callId} setScreensharingEnabledWithoutMetadataSupport() running (enabled=${e})`),e)try{const o=await this.client.getMediaHandler().getScreensharingStream(t);if(!o)return!1;const a=o.getTracks().find(l=>l.kind==="video"),c=(i=this.transceivers.get(kt(Ee.Usermedia,"video")))==null?void 0:i.sender;return c==null||c.replaceTrack(a??null),this.pushNewLocalFeed(o,Ee.Screenshare,!1),!0}catch(o){return d.error(`Call ${this.callId} setScreensharingEnabledWithoutMetadataSupport() failed to get screen-sharing stream:`,o),!1}else{const o=(n=this.localUsermediaStream)==null?void 0:n.getTracks().find(c=>c.kind==="video"),a=(s=this.transceivers.get(kt(Ee.Usermedia,"video")))==null?void 0:s.sender;return a==null||a.replaceTrack(o??null),this.client.getMediaHandler().stopScreensharingStream(this.localScreensharingStream),this.deleteFeedByStream(this.localScreensharingStream),!1}}async updateLocalUsermediaStream(e,t=!1,i=!1){const n=this.localUsermediaFeed,s=t||!n.isAudioMuted()&&!this.remoteOnHold,o=i||!n.isVideoMuted()&&!this.remoteOnHold;d.log(`Call ${this.callId} updateLocalUsermediaStream() running (streamId=${e.id}, audio=${s}, video=${o})`),Ue(e.getAudioTracks(),s),Ue(e.getVideoTracks(),o);for(const a of this.localUsermediaStream.getTracks())this.localUsermediaStream.removeTrack(a),a.stop();for(const a of e.getTracks())this.localUsermediaStream.addTrack(a);for(const a of e.getTracks()){const c=kt(Ee.Usermedia,a.kind),l=this.transceivers.get(c),u=l==null?void 0:l.sender;let h=!1;if(u)try{d.info(`Call ${this.callId} updateLocalUsermediaStream() replacing track (id=${a.id}, kind=${a.kind}, streamId=${e.id}, streamPurpose=${n.purpose})`),await u.replaceTrack(a),l.direction=l.direction==="inactive"?"sendonly":"sendrecv",h=!0}catch(f){d.warn(`Call ${this.callId} updateLocalUsermediaStream() replaceTrack failed: adding new transceiver instead`,f)}if(!h){d.info(`Call ${this.callId} updateLocalUsermediaStream() adding track to peer connection (id=${a.id}, kind=${a.kind}, streamId=${e.id}, streamPurpose=${n.purpose})`);const f=this.peerConn.addTrack(a,this.localUsermediaStream),g=this.peerConn.getTransceivers().find(m=>m.sender===f);g?this.transceivers.set(c,g):d.warn(`Call ${this.callId} updateLocalUsermediaStream() couldn't find matching transceiver for newly added track!`)}}}async setLocalVideoMuted(e){var t,i;if(d.log(`Call ${this.callId} setLocalVideoMuted() running ${e}`),!e&&this.stopVideoTrackTimer!==void 0&&(clearTimeout(this.stopVideoTrackTimer),this.stopVideoTrackTimer=void 0),!await this.client.getMediaHandler().hasVideoDevice())return this.isLocalVideoMuted();if(!this.hasUserMediaVideoSender&&!e)return(t=this.localUsermediaFeed)==null||t.setAudioVideoMuted(null,e),await this.upgradeCall(!1,!0),this.isLocalVideoMuted();if(!e&&this.localUsermediaStream.getVideoTracks().length===0){const n=await this.client.getMediaHandler().getUserMediaStream(!0,!0);await this.updateLocalUsermediaStream(n)}return(i=this.localUsermediaFeed)==null||i.setAudioVideoMuted(null,e),this.updateMuteStatus(),await this.sendMetadataUpdate(),e&&(this.stopVideoTrackTimer=setTimeout(()=>{for(const n of this.localUsermediaStream.getVideoTracks())n.stop(),this.localUsermediaStream.removeTrack(n)},120)),this.isLocalVideoMuted()}isLocalVideoMuted(){var e;return((e=this.localUsermediaFeed)==null?void 0:e.isVideoMuted())??!1}async setMicrophoneMuted(e){var t;return d.log(`Call ${this.callId} setMicrophoneMuted() running ${e}`),await this.client.getMediaHandler().hasAudioDevice()?!e&&(!this.hasUserMediaAudioSender||!this.hasLocalUserMediaAudioTrack)?(await this.upgradeCall(!0,!1),this.isMicrophoneMuted()):((t=this.localUsermediaFeed)==null||t.setAudioVideoMuted(e,null),this.updateMuteStatus(),await this.sendMetadataUpdate(),this.isMicrophoneMuted()):this.isMicrophoneMuted()}isMicrophoneMuted(){var e;return((e=this.localUsermediaFeed)==null?void 0:e.isAudioMuted())??!1}isRemoteOnHold(){return this.remoteOnHold}setRemoteOnHold(e){if(this.isRemoteOnHold()!==e){this.remoteOnHold=e;for(const t of this.peerConn.getTransceivers())t.direction=e?"sendonly":"sendrecv";this.updateMuteStatus(),this.sendMetadataUpdate(),this.emit("remote_hold_unhold",this.remoteOnHold,this)}}isLocalOnHold(){if(this.state!=="connected")return!1;let e=!0;for(const t of this.peerConn.getTransceivers())["inactive","recvonly"].includes(t.currentDirection)||(e=!1);return e}sendDtmfDigit(e){var t;for(const i of this.peerConn.getSenders())if(((t=i.track)==null?void 0:t.kind)==="audio"&&i.dtmf){i.dtmf.insertDTMF(e);return}throw new Error("Unable to find a track to send DTMF on")}updateMuteStatus(){const e=this.isMicrophoneMuted()||this.remoteOnHold,t=this.isLocalVideoMuted()||this.remoteOnHold;d.log(`Call ${this.callId} updateMuteStatus stream ${this.localUsermediaStream.id} micShouldBeMuted ${e} vidShouldBeMuted ${t}`),Ue(this.localUsermediaStream.getAudioTracks(),!e),Ue(this.localUsermediaStream.getVideoTracks(),!t)}async sendMetadataUpdate(){await this.sendVoipEvent(R.CallSDPStreamMetadataChangedPrefix,{[yi]:this.getLocalSDPStreamMetadata()})}gotCallFeedsForInvite(e,t=!1){if(this.successor){this.successor.queueGotCallFeedsForAnswer(e);return}if(this.callHasEnded()){this.stopAllMedia();return}for(const i of e)this.pushLocalFeed(i);t&&this.peerConn.addTransceiver("video",{direction:"recvonly"}),this.state="create_offer",d.debug(`Call ${this.callId} gotUserMediaForInvite() run`)}async sendAnswer(){const e={answer:{sdp:this.peerConn.localDescription.sdp,type:this.peerConn.localDescription.type},[yi]:this.getLocalSDPStreamMetadata(!0)};e.capabilities={"m.call.transferee":this.client.supportsCallTransfer,"m.call.dtmf":!1};const t=this.discardDuplicateCandidates();d.info(`Call ${this.callId} sendAnswer() discarding ${t} candidates that will be sent in answer`);try{await this.sendVoipEvent(R.CallAnswer,e),this.inviteOrAnswerSent=!0}catch(i){this.state="ringing",i instanceof Et&&i.event&&this.client.cancelPendingEvent(i.event);let n="send_answer",s="Failed to send answer";throw i.name=="UnknownDeviceError"&&(n="unknown_devices",s="Unknown devices present in the room"),this.emit("error",new ni(n,s,i),this),i}this.sendCandidateQueue()}queueGotCallFeedsForAnswer(e){this.responsePromiseChain?this.responsePromiseChain=this.responsePromiseChain.then(()=>this.gotCallFeedsForAnswer(e)):this.responsePromiseChain=this.gotCallFeedsForAnswer(e)}mungeSdp(e,t){const i=fu(e.sdp);i.media.forEach(n=>{const s=new Map,o=new Map;for(const a of n.rtp)s.set(a.payload,a.codec),o.set(a.codec,a.payload);for(const a of t){if(a.mediaType!==n.type)continue;if(!o.has(a.codec)){d.info(`Call ${this.callId} mungeSdp() ignoring SDP modifications for ${a.codec} as it's not present.`);continue}const c=[];a.enableDtx!==void 0&&c.push(`usedtx=${a.enableDtx?"1":"0"}`),a.maxAverageBitrate!==void 0&&c.push(`maxaveragebitrate=${a.maxAverageBitrate}`);let l=!1;for(const u of n.fmtp)s.get(u.payload)===a.codec&&(l=!0,u.config+=";"+c.join(";"));l||n.fmtp.push({payload:o.get(a.codec),config:c.join(";")})}}),e.sdp=jm(i)}async createOffer(){const e=await this.peerConn.createOffer();return this.mungeSdp(e,fl(this.isPtt)),e}async createAnswer(){const e=await this.peerConn.createAnswer();return this.mungeSdp(e,fl(this.isPtt)),e}async gotCallFeedsForAnswer(e){if(this.callHasEnded())return;this.waitForLocalAVStream=!1;for(const i of e)this.pushLocalFeed(i);this.state="create_answer";let t;try{this.getRidOfRTXCodecs(),t=await this.createAnswer()}catch(i){d.debug(`Call ${this.callId} gotCallFeedsForAnswer() failed to create answer: `,i),this.terminate("local","create_answer",!0);return}try{if(await this.peerConn.setLocalDescription(t),this.callHasEnded()||(this.state="connecting",await new Promise(i=>{setTimeout(i,200)}),this.callHasEnded()))return;this.sendAnswer()}catch(i){d.debug(`Call ${this.callId} gotCallFeedsForAnswer() error setting local description!`,i),this.terminate("local","set_local_description",!0);return}}async onRemoteIceCandidatesReceived(e){if(this.callHasEnded())return;const t=e.getContent(),i=t.candidates;if(!i){d.info(`Call ${this.callId} onRemoteIceCandidatesReceived() ignoring candidates event with no candidates!`);return}const n=t.version===0?null:t.party_id||null;if(this.opponentPartyId===void 0){if(n){d.info(`Call ${this.callId} onRemoteIceCandidatesReceived() buffering ${i.length} candidates until we pick an opponent`);const s=this.remoteCandidateBuffer.get(n)||[];s.push(...i),this.remoteCandidateBuffer.set(n,s)}return}if(!this.partyIdMatches(t)){d.info(`Call ${this.callId} onRemoteIceCandidatesReceived() ignoring candidates from party ID ${t.party_id}: we have chosen party ID ${this.opponentPartyId}`);return}await this.addIceCandidates(i)}async onAnswerReceived(e){const t=e.getContent();if(d.debug(`Call ${this.callId} onAnswerReceived() running (hangupParty=${t.party_id})`),this.callHasEnded()){d.debug(`Call ${this.callId} onAnswerReceived() ignoring answer because call has ended`);return}if(this.opponentPartyId!==void 0){d.info(`Call ${this.callId} onAnswerReceived() ignoring answer from party ID ${t.party_id}: we already have an answer/reject from ${this.opponentPartyId}`);return}this.chooseOpponent(e),await this.addBufferedIceCandidates(),this.state="connecting";const i=t[yi];i?this.updateRemoteSDPStreamMetadata(i):d.warn(`Call ${this.callId} onAnswerReceived() did not get any SDPStreamMetadata! Can not send/receive multiple streams`);try{this.isSettingRemoteAnswerPending=!0,await this.peerConn.setRemoteDescription(t.answer),this.isSettingRemoteAnswerPending=!1,d.debug(`Call ${this.callId} onAnswerReceived() set remote description: ${t.answer.type}`)}catch(n){this.isSettingRemoteAnswerPending=!1,d.debug(`Call ${this.callId} onAnswerReceived() failed to set remote description`,n),this.terminate("local","set_remote_description",!1);return}if(this.opponentPartyId!==null)try{await this.sendVoipEvent(R.CallSelectAnswer,{selected_party_id:this.opponentPartyId})}catch(n){d.warn(`Call ${this.callId} onAnswerReceived() failed to send select_answer event`,n)}}async onSelectAnswerReceived(e){if(this.direction!=="inbound"){d.warn(`Call ${this.callId} onSelectAnswerReceived() got select_answer for an outbound call: ignoring`);return}const t=e.getContent().selected_party_id;if(t==null){d.warn(`Call ${this.callId} onSelectAnswerReceived() got nonsensical select_answer with null/undefined selected_party_id: ignoring`);return}t!==this.ourPartyId&&(d.info(`Call ${this.callId} onSelectAnswerReceived() got select_answer for party ID ${t}: we are party ID ${this.ourPartyId}.`),await this.terminate("remote","answered_elsewhere",!0))}async onNegotiateReceived(e){var u;const t=e.getContent(),i=t.description;if(!i||!i.sdp||!i.type){d.info(`Call ${this.callId} onNegotiateReceived() ignoring invalid m.call.negotiate event`);return}const n=this.direction==="inbound",s=!this.makingOffer&&(this.peerConn.signalingState==="stable"||this.isSettingRemoteAnswerPending),o=i.type==="offer"&&!s;if(this.ignoreOffer=!n&&o,this.ignoreOffer){d.info(`Call ${this.callId} onNegotiateReceived() ignoring colliding negotiate event because we're impolite`);return}const a=this.isLocalOnHold(),c=t[yi];c?this.updateRemoteSDPStreamMetadata(c):d.warn(`Call ${this.callId} onNegotiateReceived() received negotiation event without SDPStreamMetadata!`);try{if(this.isSettingRemoteAnswerPending=i.type=="answer",await this.peerConn.setRemoteDescription(i),this.isSettingRemoteAnswerPending=!1,d.debug(`Call ${this.callId} onNegotiateReceived() set remote description: ${i.type}`),i.type==="offer"){let h;try{this.getRidOfRTXCodecs(),h=await this.createAnswer()}catch(f){d.debug(`Call ${this.callId} onNegotiateReceived() failed to create answer: `,f),this.terminate("local","create_answer",!0);return}await this.peerConn.setLocalDescription(h),d.debug(`Call ${this.callId} onNegotiateReceived() create an answer`),this.sendVoipEvent(R.CallNegotiate,{lifetime:Co,description:(u=this.peerConn.localDescription)==null?void 0:u.toJSON(),[yi]:this.getLocalSDPStreamMetadata(!0)})}}catch(h){this.isSettingRemoteAnswerPending=!1,d.warn(`Call ${this.callId} onNegotiateReceived() failed to complete negotiation`,h)}const l=this.isLocalOnHold();a!==l&&(this.emit("local_hold_unhold",l,this),this.emit("hold_unhold",l))}updateRemoteSDPStreamMetadata(e){var t;this.remoteSDPStreamMetadata=Td(this.remoteSDPStreamMetadata||{},e,!0);for(const i of this.getRemoteFeeds()){const n=i.stream.id,s=this.remoteSDPStreamMetadata[n];i.setAudioVideoMuted(s==null?void 0:s.audio_muted,s==null?void 0:s.video_muted),i.purpose=(t=this.remoteSDPStreamMetadata[n])==null?void 0:t.purpose}}onSDPStreamMetadataChangedReceived(e){const i=e.getContent()[yi];this.updateRemoteSDPStreamMetadata(i)}async onAssertedIdentityReceived(e){const t=e.getContent();t.asserted_identity&&(this.remoteAssertedIdentity={id:t.asserted_identity.id,displayName:t.asserted_identity.display_name},this.emit("asserted_identity_changed",this))}callHasEnded(){return this.state==="ended"}queueGotLocalOffer(){this.responsePromiseChain?this.responsePromiseChain=this.responsePromiseChain.then(()=>this.wrappedGotLocalOffer()):this.responsePromiseChain=this.wrappedGotLocalOffer()}async wrappedGotLocalOffer(){this.makingOffer=!0;try{await this.gotLocalOffer()}catch(e){this.getLocalOfferFailed(e);return}finally{this.makingOffer=!1}}async gotLocalOffer(){var s,o;if(d.debug(`Call ${this.callId} gotLocalOffer() running`),this.callHasEnded()){d.debug(`Call ${this.callId} gotLocalOffer() ignoring newly created offer because the call has ended"`);return}let e;try{this.getRidOfRTXCodecs(),e=await this.createOffer()}catch(a){d.debug(`Call ${this.callId} gotLocalOffer() failed to create offer: `,a),this.terminate("local","create_offer",!0);return}try{await this.peerConn.setLocalDescription(e)}catch(a){d.debug(`Call ${this.callId} gotLocalOffer() error setting local description!`,a),this.terminate("local","set_local_description",!0);return}if(this.peerConn.iceGatheringState==="gathering"&&await new Promise(a=>{setTimeout(a,200)}),this.callHasEnded())return;const t=this.state==="create_offer"?R.CallInvite:R.CallNegotiate,i={lifetime:Co};t===R.CallInvite&&this.invitee&&(i.invitee=this.invitee),this.state==="create_offer"?i.offer=(s=this.peerConn.localDescription)==null?void 0:s.toJSON():i.description=(o=this.peerConn.localDescription)==null?void 0:o.toJSON(),i.capabilities={"m.call.transferee":this.client.supportsCallTransfer,"m.call.dtmf":!1},i[yi]=this.getLocalSDPStreamMetadata(!0);const n=this.discardDuplicateCandidates();d.info(`Call ${this.callId} gotLocalOffer() discarding ${n} candidates that will be sent in offer`);try{await this.sendVoipEvent(t,i)}catch(a){d.error(`Call ${this.callId} gotLocalOffer() failed to send invite`,a),a instanceof Et&&a.event&&this.client.cancelPendingEvent(a.event);let c="signalling_timeout",l="Signalling failed";this.state==="create_offer"&&(c="send_invite",l="Failed to send invite"),a.name=="UnknownDeviceError"&&(c="unknown_devices",l="Unknown devices present in the room"),this.emit("error",new ni(c,l,a),this),this.terminate("local",c,!1);return}this.sendCandidateQueue(),this.state==="create_offer"&&(this.inviteOrAnswerSent=!0,this.state="invite_sent",this.inviteTimeout=setTimeout(()=>{this.inviteTimeout=void 0,this.state==="invite_sent"&&this.hangup("invite_timeout",!1)},Co))}getRidOfRTXCodecs(){var s;if(!RTCRtpReceiver.getCapabilities||!RTCRtpSender.getCapabilities)return;const e=RTCRtpReceiver.getCapabilities("video").codecs,i=[...RTCRtpSender.getCapabilities("video").codecs,...e];for(const o of i)if(o.mimeType==="video/rtx"){const a=i.indexOf(o);i.splice(a,1)}const n=this.transceivers.get(kt(Ee.Screenshare,"video"));(s=n==null?void 0:n.setCodecPreferences)==null||s.call(n,i)}async sendVoipEvent(e,t){var n,s;const i={...t,version:pv,call_id:this.callId,party_id:this.ourPartyId,conf_id:this.groupCallId};if(this.opponentDeviceId){const o=this.toDeviceSeq++,a={...i,device_id:this.client.deviceId,sender_session_id:this.client.getSessionId(),dest_session_id:this.opponentSessionId,seq:o,[ut]:Kt()};this.emit("send_voip_event",{type:"toDevice",eventType:e,userId:this.invitee||((n=this.getOpponentMember())==null?void 0:n.userId),opponentDeviceId:this.opponentDeviceId,content:a},this);const c=this.invitee||this.getOpponentMember().userId;if(this.client.getUseE2eForGroupCall()){if(!this.opponentDeviceInfo){d.warn(`Call ${this.callId} sendVoipEvent() failed: we do not have opponentDeviceInfo`);return}await this.client.encryptAndSendToDevices([{userId:c,deviceInfo:this.opponentDeviceInfo}],{type:e,content:a})}else await this.client.sendToDevice(e,new Map([[c,new Map([[this.opponentDeviceId,a]])]]))}else this.emit("send_voip_event",{type:"sendEvent",eventType:e,roomId:this.roomId,content:i,userId:this.invitee||((s=this.getOpponentMember())==null?void 0:s.userId)},this),await this.client.sendEvent(this.roomId,e,i)}queueCandidate(e){if(e?this.candidateSendQueue.push(e):this.candidatesEnded=!0,this.state==="ringing"||!this.inviteOrAnswerSent)return;const t=this.direction==="inbound"?500:2e3;this.candidateSendTries===0&&setTimeout(()=>{this.sendCandidateQueue()},t)}discardDuplicateCandidates(){let e=0;const t=[];for(let i=0;i<this.candidateSendQueue.length;i++){const n=this.candidateSendQueue[i];n.candidate===""?t.push(n):e++}return this.candidateSendQueue=t,e}async transfer(e){const t=await this.client.getProfileInfo(e),i=qi(),n={replacement_id:qi(),target_user:{id:e,display_name:t.displayname,avatar_url:t.avatar_url},create_call:i};await this.sendVoipEvent(R.CallReplaces,n),await this.terminate("local","transferred",!0)}async transferToCall(e){var l,u;const t=(l=e.getOpponentMember())==null?void 0:l.userId,i=t?await this.client.getProfileInfo(t):void 0,n=(u=this.getOpponentMember())==null?void 0:u.userId,s=n?await this.client.getProfileInfo(n):void 0,o=qi(),a={replacement_id:qi(),target_user:{id:n,display_name:s==null?void 0:s.displayname,avatar_url:s==null?void 0:s.avatar_url},await_call:o};await e.sendVoipEvent(R.CallReplaces,a);const c={replacement_id:qi(),target_user:{id:t,display_name:i==null?void 0:i.displayname,avatar_url:i==null?void 0:i.avatar_url},create_call:o};await this.sendVoipEvent(R.CallReplaces,c),await this.terminate("local","transferred",!0),await e.terminate("local","transferred",!0)}async terminate(e,t,i){var n;if(!this.callHasEnded()){this.hangupParty=e,this.hangupReason=t,this.state="ended",this.inviteTimeout&&(clearTimeout(this.inviteTimeout),this.inviteTimeout=void 0),this.iceDisconnectedTimeout!==void 0&&(clearTimeout(this.iceDisconnectedTimeout),this.iceDisconnectedTimeout=void 0),this.callLengthInterval&&(clearInterval(this.callLengthInterval),this.callLengthInterval=void 0),this.stopVideoTrackTimer!==void 0&&(clearTimeout(this.stopVideoTrackTimer),this.stopVideoTrackTimer=void 0);for(const[s,o]of this.removeTrackListeners)s.removeEventListener("removetrack",o);this.removeTrackListeners.clear(),this.callStatsAtEnd=await this.collectCallStats(),this.stopAllMedia(),this.deleteAllFeeds(),this.peerConn&&this.peerConn.signalingState!=="closed"&&this.peerConn.close(),(n=this.stats)==null||n.removeStatsReportGatherer(this.callId),i&&this.emit("hangup",this),this.client.callEventHandler.calls.delete(this.callId)}}stopAllMedia(){d.debug(`Call ${this.callId} stopAllMedia() running`);for(const e of this.feeds)if(e.isLocal()&&e.purpose===Ee.Usermedia)this.client.getMediaHandler().stopUserMediaStream(e.stream);else if(e.isLocal()&&e.purpose===Ee.Screenshare)this.client.getMediaHandler().stopScreensharingStream(e.stream);else if(!e.isLocal()){d.debug(`Call ${this.callId} stopAllMedia() stopping stream (streamId=${e.stream.id})`);for(const t of e.stream.getTracks())t.stop()}}checkForErrorListener(){if(this.listeners(Kd.Error).length===0)throw new Error("You MUST attach an error listener using call.on('error', function() {})")}async sendCandidateQueue(){if(this.candidateSendQueue.length===0||this.callHasEnded())return;const e=this.candidateSendQueue;this.candidateSendQueue=[],++this.candidateSendTries;const t={candidates:e.map(i=>i.toJSON())};this.candidatesEnded&&t.candidates.push({candidate:""}),d.debug(`Call ${this.callId} sendCandidateQueue() attempting to send ${e.length} candidates`);try{await this.sendVoipEvent(R.CallCandidates,t),this.candidateSendTries=0,this.sendCandidateQueue()}catch(i){if(i instanceof Et&&i.event&&this.client.cancelPendingEvent(i.event),this.candidateSendQueue.push(...e),this.candidateSendTries>5){d.debug(`Call ${this.callId} sendCandidateQueue() failed to send candidates on attempt ${this.candidateSendTries}. Giving up on this call.`,i);const s="signalling_timeout",o="Signalling failed";this.emit("error",new ni(s,o,i),this),this.hangup(s,!1);return}const n=500*Math.pow(2,this.candidateSendTries);++this.candidateSendTries,d.debug(`Call ${this.callId} sendCandidateQueue() failed to send candidates. Retrying in ${n}ms`,i),setTimeout(()=>{this.sendCandidateQueue()},n)}}async placeCall(e,t){if(!e)throw new Error("You CANNOT start a call without audio");this.state="wait_local_media";let i;try{const n=await this.client.getMediaHandler().getUserMediaStream(e,t);Ue(n.getAudioTracks(),!0),Ue(n.getVideoTracks(),!0),i=new oi({client:this.client,roomId:this.roomId,userId:this.client.getUserId(),deviceId:this.client.getDeviceId()??void 0,stream:n,purpose:Ee.Usermedia,audioMuted:!1,videoMuted:!1})}catch(n){this.getUserMediaFailed(n);return}try{await this.placeCallWithCallFeeds([i])}catch(n){this.placeCallFailed(n);return}}async placeCallWithCallFeeds(e,t=!1){this.checkForErrorListener(),this.direction="outbound",await this.initOpponentCrypto(),this.client.callEventHandler.calls.set(this.callId,this),await this.client.checkTurnServers()||d.warn(`Call ${this.callId} placeCallWithCallFeeds() failed to get TURN credentials! Proceeding with call anyway...`),this.peerConn=this.createPeerConnection(),this.emit("peer_connection_created",this.peerConn,this),this.gotCallFeedsForInvite(e,t)}createPeerConnection(){var n;const e=new window.RTCPeerConnection({iceTransportPolicy:this.forceTURN?"relay":void 0,iceServers:this.turnServers.length?this.turnServers:void 0,iceCandidatePoolSize:this.client.iceCandidatePoolSize,bundlePolicy:"max-bundle"});e.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChanged),e.addEventListener("signalingstatechange",this.onSignallingStateChanged),e.addEventListener("icecandidate",this.gotLocalIceCandidate),e.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),e.addEventListener("track",this.onTrack),e.addEventListener("negotiationneeded",this.onNegotiationNeeded),e.addEventListener("datachannel",this.onDataChannel);const t=this.getOpponentMember(),i=t?t.userId:"unknown";return(n=this.stats)==null||n.addStatsReportGatherer(this.callId,i,e),e}partyIdMatches(e){return(e.version===0?null:e.party_id||null)===this.opponentPartyId}chooseOpponent(e){var i;const t=e.getContent();d.debug(`Call ${this.callId} chooseOpponent() running (partyId=${t.party_id})`),this.opponentVersion=t.version,this.opponentVersion===0?this.opponentPartyId=null:this.opponentPartyId=t.party_id||null,this.opponentCaps=t.capabilities||{},this.opponentMember=this.client.getRoom(this.roomId).getMember(e.getSender())??void 0,this.opponentMember&&((i=this.stats)==null||i.updateOpponentMember(this.callId,this.opponentMember.userId))}async addBufferedIceCandidates(){const e=this.remoteCandidateBuffer.get(this.opponentPartyId);e&&(d.info(`Call ${this.callId} addBufferedIceCandidates() adding ${e.length} buffered candidates for opponent ${this.opponentPartyId}`),await this.addIceCandidates(e)),this.remoteCandidateBuffer.clear()}async addIceCandidates(e){for(const t of e){(t.sdpMid===null||t.sdpMid===void 0)&&(t.sdpMLineIndex===null||t.sdpMLineIndex===void 0)?d.debug(`Call ${this.callId} addIceCandidates() got remote ICE end-of-candidates`):d.debug(`Call ${this.callId} addIceCandidates() got remote ICE candidate (sdpMid=${t.sdpMid}, candidate=${t.candidate})`);try{await this.peerConn.addIceCandidate(t)}catch(i){this.ignoreOffer?d.debug(`Call ${this.callId} addIceCandidates() failed to add remote ICE candidate because ignoring offer`,i):d.info(`Call ${this.callId} addIceCandidates() failed to add remote ICE candidate`,i)}}}get hasPeerConnection(){return!!this.peerConn}initStats(e,t="unknown"){this.stats=e,this.stats.start()}}function Ue(r,e){for(const t of r)t.enabled=e}function Ia(){if(typeof window>"u"||typeof document>"u")return!1;try{if(!!!(window.RTCPeerConnection||window.RTCSessionDescription||window.RTCIceCandidate||navigator.mediaDevices))return d.error("WebRTC is not supported in this browser / environment"),!1}catch(r){return d.error("Exception thrown when trying to access WebRTC",r),!1}return!0}function Ds(r,e,t){if(!Ia())return null;const i=t?t.forceTURN:!1,n={client:r,roomId:e,invitee:t==null?void 0:t.invitee,turnServers:r.getTurnServers(),forceTURN:r.forceTURN||i,opponentDeviceId:t==null?void 0:t.opponentDeviceId,opponentSessionId:t==null?void 0:t.opponentSessionId,groupCallId:t==null?void 0:t.groupCallId},s=new Ev(n);return r.reEmitter.reEmit(s,Object.values(vt)),s}var Oi=(r=>(r.DontNotify="dont_notify",r.Notify="notify",r.Coalesce="coalesce",r))(Oi||{}),za=(r=>(r.Highlight="highlight",r.Sound="sound",r))(za||{}),Le=(r=>(r.EventMatch="event_match",r.EventPropertyIs="event_property_is",r.EventPropertyContains="event_property_contains",r.ContainsDisplayName="contains_display_name",r.RoomMemberCount="room_member_count",r.SenderNotificationPermission="sender_notification_permission",r.CallStarted="call_started",r.CallStartedPrefix="org.matrix.msc3914.call_started",r))(Le||{}),je=(r=>(r.Override="override",r.ContentSpecific="content",r.RoomSpecific="room",r.SenderSpecific="sender",r.Underride="underride",r))(je||{}),Ve=(r=>(r.Master=".m.rule.master",r.IsUserMention=".m.rule.is_user_mention",r.IsRoomMention=".m.rule.is_room_mention",r.ContainsDisplayName=".m.rule.contains_display_name",r.ContainsUserName=".m.rule.contains_user_name",r.AtRoomNotification=".m.rule.roomnotif",r.DM=".m.rule.room_one_to_one",r.EncryptedDM=".m.rule.encrypted_room_one_to_one",r.Message=".m.rule.message",r.EncryptedMessage=".m.rule.encrypted",r.InviteToSelf=".m.rule.invite_for_me",r.MemberEvent=".m.rule.member_event",r.IncomingCall=".m.rule.call",r.SuppressNotices=".m.rule.suppress_notices",r.Tombstone=".m.rule.tombstone",r.PollStart=".m.rule.poll_start",r.PollStartUnstable=".org.matrix.msc3930.rule.poll_start",r.PollEnd=".m.rule.poll_end",r.PollEndUnstable=".org.matrix.msc3930.rule.poll_end",r.PollStartOneToOne=".m.rule.poll_start_one_to_one",r.PollStartOneToOneUnstable=".org.matrix.msc3930.rule.poll_start_one_to_one",r.PollEndOneToOne=".m.rule.poll_end_one_to_one",r.PollEndOneToOneUnstable=".org.matrix.msc3930.rule.poll_end_one_to_one",r))(Ve||{});const gl=[je.Override,je.ContentSpecific,je.RoomSpecific,je.SenderSpecific,je.Underride],bv={".m.rule.is_room_mention":{rule_id:".m.rule.is_room_mention",default:!0,enabled:!0,conditions:[{kind:Le.EventPropertyIs,key:"content.m\\.mentions.room",value:!0},{kind:Le.SenderNotificationPermission,key:"room"}],actions:[Oi.Notify,{set_tweak:za.Highlight}]},".m.rule.reaction":{rule_id:".m.rule.reaction",default:!0,enabled:!0,conditions:[{kind:Le.EventMatch,key:"type",pattern:"m.reaction"}],actions:[Oi.DontNotify]},".org.matrix.msc3786.rule.room.server_acl":{rule_id:".org.matrix.msc3786.rule.room.server_acl",default:!0,enabled:!0,conditions:[{kind:Le.EventMatch,key:"type",pattern:R.RoomServerAcl},{kind:Le.EventMatch,key:"state_key",pattern:""}],actions:[]}},Ya=Symbol("UserDefinedRules"),wv=[Ve.Master,Ya,Ve.SuppressNotices,Ve.InviteToSelf,Ve.MemberEvent,Ve.IsUserMention,Ve.ContainsDisplayName,Ve.IsRoomMention,Ve.AtRoomNotification,Ve.Tombstone,".m.rule.reaction",".m.rule.room.server_acl",".org.matrix.msc3786.rule.room.server_acl",".m.rule.suppress_edits"],_v={".org.matrix.msc3914.rule.room.call":{rule_id:".org.matrix.msc3914.rule.room.call",default:!0,enabled:!0,conditions:[{kind:Le.EventMatch,key:"type",pattern:"org.matrix.msc3401.call"},{kind:Le.CallStarted}],actions:[Oi.Notify,{set_tweak:za.Sound,value:"default"}]}},Iv=[Ya,Ve.IncomingCall,".org.matrix.msc3914.rule.room.call",Ve.EncryptedDM,Ve.DM,Ve.Message,Ve.EncryptedMessage];function pl(r,e,t,i){const n=e.filter(l=>l.default),s=e.filter(l=>!l.default);function o(l){l===Ya?c.push(...s):l in t?(d.warn(`Adding default global ${r} push rule ${l}`),c.push(t[l])):d.warn(`Missing default global ${r} push rule ${l}`)}let a=0;const c=[];for(const l of n){const u=i.indexOf(l.rule_id);if(u===-1){c.push(l);continue}for(;u>a;){const h=i[a];o(h),a+=1}c.push(l),a+=1}for(const l of i.slice(a))o(l);return c}const Vt=class Vt{constructor(e){this.client=e,this.parsedKeys=new Map}static actionListToActionsObject(e){const t={notify:!1,tweaks:{}};for(const i of e)i===Oi.Notify?t.notify=!0:typeof i=="object"&&(i.value===void 0&&(i.value=!0),t.tweaks[i.set_tweak]=i.value);return t}static rewriteDefaultRules(e,t=void 0){let i=JSON.parse(JSON.stringify(e));return i||(i={}),i.global||(i.global={}),i.global.override||(i.global.override=[]),i.global.underride||(i.global.underride=[]),i.global.override=pl(je.Override,i.global.override,bv,wv),i.global.underride=pl(je.Underride,i.global.underride,_v,Iv),i}updateCachedPushRuleKeys(e){e||(e={}),e.global||(e.global={}),e.global.override||(e.global.override=[]),e.global.room||(e.global.room=[]),e.global.sender||(e.global.sender=[]),e.global.underride||(e.global.underride=[]);const t=new Set(this.parsedKeys.keys());for(const i of[e.global.override,e.global.room,e.global.sender,e.global.underride])for(const n of i)if(n.conditions)for(const s of n.conditions)s.kind===Le.EventMatch&&(t.delete(s.key),this.parsedKeys.set(s.key,Vt.partsForDottedKey(s.key)));t.forEach(i=>this.parsedKeys.delete(i))}matchingRuleFromKindSet(e,t){for(const i of gl){const n=t[i];if(n)for(const s of n){if(!s.enabled)continue;const o=this.templateRuleToRaw(i,s);if(o&&this.ruleMatchesEvent(o,e))return{...s,kind:i}}}return null}templateRuleToRaw(e,t){const i={rule_id:t.rule_id,actions:t.actions,conditions:[]};switch(e){case je.Underride:case je.Override:i.conditions=t.conditions;break;case je.RoomSpecific:if(!t.rule_id)return null;i.conditions.push({kind:Le.EventMatch,key:"room_id",value:t.rule_id});break;case je.SenderSpecific:if(!t.rule_id)return null;i.conditions.push({kind:Le.EventMatch,key:"user_id",value:t.rule_id});break;case je.ContentSpecific:if(!t.pattern)return null;i.conditions.push({kind:Le.EventMatch,key:"content.body",pattern:t.pattern});break}return i}eventFulfillsCondition(e,t){switch(e.kind){case Le.EventMatch:return this.eventFulfillsEventMatchCondition(e,t);case Le.EventPropertyIs:return this.eventFulfillsEventPropertyIsCondition(e,t);case Le.EventPropertyContains:return this.eventFulfillsEventPropertyContains(e,t);case Le.ContainsDisplayName:return this.eventFulfillsDisplayNameCondition(e,t);case Le.RoomMemberCount:return this.eventFulfillsRoomMemberCountCondition(e,t);case Le.SenderNotificationPermission:return this.eventFulfillsSenderNotifPermCondition(e,t);case Le.CallStarted:case Le.CallStartedPrefix:return this.eventFulfillsCallStartedCondition(e,t)}return!1}eventFulfillsSenderNotifPermCondition(e,t){const i=e.key;if(!i)return!1;const n=this.client.getRoom(t.getRoomId());return n!=null&&n.currentState?n.currentState.mayTriggerNotifOfType(i,t.getSender()):!1}eventFulfillsRoomMemberCountCondition(e,t){if(!e.is)return!1;const i=this.client.getRoom(t.getRoomId());if(!i||!i.currentState||!i.currentState.members)return!1;const n=i.currentState.getJoinedMemberCount(),s=e.is.match(/^([=<>]*)(\d*)$/);if(!s)return!1;const o=s[1],a=parseInt(s[2]);if(isNaN(a))return!1;switch(o){case"":case"==":return n==a;case"<":return n<a;case">":return n>a;case"<=":return n<=a;case">=":return n>=a;default:return!1}}eventFulfillsDisplayNameCondition(e,t){var c;let i=t.getContent();if(t.isEncrypted()&&t.getClearContent()&&(i=t.getClearContent()),!i||!i.body||typeof i.body!="string")return!1;const n=this.client.getRoom(t.getRoomId()),s=(c=n==null?void 0:n.currentState)==null?void 0:c.getMember(this.client.credentials.userId);if(!s)return!1;const o=s.name,a=new RegExp("(^|\\W)"+_d(o)+"(\\W|$)","i");return i.body.search(a)>-1}eventFulfillsEventMatchCondition(e,t){if(!e.key)return!1;const i=this.valueForDottedKey(e.key,t);if(typeof i!="string")return!1;if(e.value)return e.value===i;if(typeof e.pattern!="string")return!1;const n=e.key==="content.body"?this.createCachedRegex("(^|\\W)",e.pattern,"(\\W|$)"):this.createCachedRegex("^",e.pattern,"$");return!!i.match(n)}eventFulfillsEventPropertyIsCondition(e,t){return!e.key||e.value===void 0?!1:e.value===this.valueForDottedKey(e.key,t)}eventFulfillsEventPropertyContains(e,t){if(!e.key||e.value===void 0)return!1;const i=this.valueForDottedKey(e.key,t);return Array.isArray(i)?i.includes(e.value):!1}eventFulfillsCallStartedCondition(e,t){return["m.ring","m.prompt"].includes(t.getContent()["m.intent"])&&!("m.terminated"in t.getContent())&&(t.getPrevContent()["m.terminated"]!==t.getContent()["m.terminated"]||Xi(t.getPrevContent(),{}))}createCachedRegex(e,t,i){return Vt.cachedGlobToRegex[t]||(Vt.cachedGlobToRegex[t]=new RegExp(e+Id(t)+i,"i")),Vt.cachedGlobToRegex[t]}static partsForDottedKey(e){const t=[];let i="",n=!1;for(const s of e){if(n){s==="\\"||s==="."?i+=s:i+="\\"+s,n=!1;continue}s=="."?(t.push(i),i=""):s=="\\"?n=!0:i+=s}return n&&(i+="\\"),t.push(i),t}valueForDottedKey(e,t){let i=this.parsedKeys.get(e);i===void 0&&(i=Vt.partsForDottedKey(e),this.parsedKeys.set(e,i));let n;const s=i[0];let o=0;for(s==="content"?(n=t.getContent(),++o):s==="type"?(n=t.getType(),++o):n=t.event;o<i.length;++o){if(Rd(n))return;const a=i[o];n=n[a]}return n}matchingRuleForEventWithRulesets(e,t){return!t||e.getSender()===this.client.getSafeUserId()?null:this.matchingRuleFromKindSet(e,t.global)}pushActionsForEventAndRulesets(e,t){const i=this.matchingRuleForEventWithRulesets(e,t);if(!i)return{};const n=Vt.actionListToActionsObject(i.actions);return n.tweaks.highlight===void 0&&(n.tweaks.highlight=i.kind==je.ContentSpecific),{actions:n,rule:i}}ruleMatchesEvent(e,t){var i;return this.client.supportsIntentionalMentions()&&t.getContent()["m.mentions"]!==void 0&&(e.rule_id===Ve.ContainsUserName||e.rule_id===Ve.ContainsDisplayName||e.rule_id===Ve.AtRoomNotification)?!1:!((i=e.conditions)!=null&&i.some(n=>!this.eventFulfillsCondition(n,t)))}actionsForEvent(e){const{actions:t}=this.pushActionsForEventAndRulesets(e,this.client.pushRules);return t||{}}actionsAndRuleForEvent(e){return this.pushActionsForEventAndRulesets(e,this.client.pushRules)}getPushRuleById(e){const t=this.getPushRuleAndKindById(e);return(t==null?void 0:t.rule)??null}getPushRuleAndKindById(e){var t;for(const i of["global"])if(((t=this.client.pushRules)==null?void 0:t[i])!==void 0){for(const n of gl)if(this.client.pushRules[i][n]!==void 0){for(const s of this.client.pushRules[i][n])if(s.rule_id===e)return{rule:s,kind:n}}}return null}};Vt.cachedGlobToRegex={};let Us=Vt;const Ls=["v1.1","v1.2","v1.3","v1.4","v1.5","v1.6","v1.7","v1.8","v1.9"];Ls[0];Ls[Ls.length-1];var Rv={},bu=(r=>(r.Invalid="Invalid homeserver discovery response",r.GenericFailure="Failed to get autodiscovery configuration from server",r.InvalidHsBaseUrl="Invalid base_url for m.homeserver",r.InvalidHomeserver="Homeserver URL does not appear to be a valid Matrix homeserver",r.InvalidIsBaseUrl="Invalid base_url for m.identity_server",r.InvalidIdentityServer="Identity server URL does not appear to be a valid identity server",r.InvalidIs="Invalid identity server discovery response",r.MissingWellknown="No .well-known JSON file found",r.InvalidJson="Invalid JSON",r.UnsupportedHomeserverSpecVersion="The homeserver does not meet the version requirements",r.HomeserverTooOld="The homeserver does not meet the version requirements",r))(bu||{});const ce=class ce{static async fromDiscoveryConfig(e){var c;const t={"m.homeserver":{state:ce.FAIL_ERROR,error:ce.ERROR_INVALID,base_url:null},"m.identity_server":{state:ce.PROMPT,error:null,base_url:null}};if(!(e!=null&&e["m.homeserver"]))return d.error("No m.homeserver key in config"),t["m.homeserver"].state=ce.FAIL_PROMPT,t["m.homeserver"].error=ce.ERROR_INVALID,Promise.resolve(t);if(!e["m.homeserver"].base_url)return d.error("No m.homeserver base_url in config"),t["m.homeserver"].state=ce.FAIL_PROMPT,t["m.homeserver"].error=ce.ERROR_INVALID_HS_BASE_URL,Promise.resolve(t);const i=this.sanitizeWellKnownUrl(e["m.homeserver"].base_url);if(!i)return d.error("Invalid base_url for m.homeserver"),t["m.homeserver"].error=ce.ERROR_INVALID_HS_BASE_URL,Promise.resolve(t);const n=await this.fetchWellKnownObject(`${i}/_matrix/client/versions`);if(!n||!Array.isArray((c=n.raw)==null?void 0:c.versions))return d.error("Invalid /versions response"),t["m.homeserver"].error=ce.ERROR_INVALID_HOMESERVER,t["m.homeserver"].base_url=i,Promise.resolve(t);const s=new Set(n.raw.versions);let o=!1;for(const l of Ls)if(s.has(l)){o=!0;break}if(!o)return d.error("Homeserver does not meet version requirements"),t["m.homeserver"].error=ce.ERROR_UNSUPPORTED_HOMESERVER_SPEC_VERSION,t["m.homeserver"].base_url=i,Promise.resolve(t);t["m.homeserver"]={state:ce.SUCCESS,error:null,base_url:i};let a="";if(e["m.identity_server"]){const l={"m.homeserver":t["m.homeserver"],"m.identity_server":{state:ce.FAIL_PROMPT,error:ce.ERROR_INVALID_IS,base_url:null}};if(a=this.sanitizeWellKnownUrl(e["m.identity_server"].base_url),!a)return d.error("Invalid base_url for m.identity_server"),l["m.identity_server"].error=ce.ERROR_INVALID_IS_BASE_URL,Promise.resolve(l);const u=await this.fetchWellKnownObject(`${a}/_matrix/identity/v2`);if(!(u!=null&&u.raw)||u.action!=="SUCCESS")return d.error("Invalid /v2 response"),l["m.identity_server"].error=ce.ERROR_INVALID_IDENTITY_SERVER,l["m.identity_server"].base_url=a,Promise.resolve(l)}return a&&a.toString().length>0&&(t["m.identity_server"]={state:ce.SUCCESS,error:null,base_url:a}),Object.keys(e).forEach(l=>{if(l==="m.homeserver"||l==="m.identity_server"){const u=["error","state","base_url"];for(const h of Object.keys(e[l]))u.includes(h)||(t[l][h]=e[l][h])}else t[l]=e[l]}),Promise.resolve(t)}static async findClientConfig(e){if(!e||typeof e!="string"||e.length===0)throw new Error("'domain' must be a string of non-zero length");const t={"m.homeserver":{state:ce.FAIL_ERROR,error:ce.ERROR_INVALID,base_url:null},"m.identity_server":{state:ce.PROMPT,error:null,base_url:null}},i=e.includes("://")?e:`https://${e}`,n=await this.fetchWellKnownObject(`${i}/.well-known/matrix/client`);return!n||n.action!=="SUCCESS"?(d.error("No response or error when parsing .well-known"),n.reason&&d.error(n.reason),n.action==="IGNORE"?t["m.homeserver"]={state:ce.PROMPT,error:null,base_url:null}:(t["m.homeserver"].state=ce.FAIL_PROMPT,t["m.homeserver"].error=ce.ERROR_INVALID),Promise.resolve(t)):ce.fromDiscoveryConfig(n.raw)}static async getRawClientConfig(e){if(!e||typeof e!="string"||e.length===0)throw new Error("'domain' must be a string of non-zero length");const t=await this.fetchWellKnownObject(`https://${e}/.well-known/matrix/client`);return t?t.raw??{}:{}}static sanitizeWellKnownUrl(e){if(!e)return!1;try{let t;try{t=new URL(e)}catch(o){d.error("Could not parse url",o)}if(!(t!=null&&t.hostname)||t.protocol!=="http:"&&t.protocol!=="https:")return!1;const i=t.port?`:${t.port}`:"",n=t.pathname?t.pathname:"";let s=`${t.protocol}//${t.hostname}${i}${n}`;return s.endsWith("/")&&(s=s.substring(0,s.length-1)),s}catch(t){return d.error(t),!1}}static fetch(e,t){return this.fetchFn?this.fetchFn(e,t):Rv.fetch(e,t)}static setFetchFn(e){ce.fetchFn=e}static async fetchWellKnownObject(e){let t;try{if(t=await ce.fetch(e,{method:D.Get,signal:ru(5e3)}),t.status===404)return{raw:{},action:"IGNORE",reason:ce.ERROR_MISSING_WELLKNOWN};if(!t.ok)return{raw:{},action:"FAIL_PROMPT",reason:"General failure"}}catch(i){const n=i;let s="";return typeof n=="object"&&(s=n==null?void 0:n.message),{error:n,raw:{},action:"FAIL_PROMPT",reason:s||"General failure"}}try{return{raw:await t.json(),action:"SUCCESS"}}catch(i){const n=i;return{error:n,raw:{},action:"FAIL_PROMPT",reason:(n==null?void 0:n.name)==="SyntaxError"?ce.ERROR_INVALID_JSON:ce.ERROR_INVALID}}}};ce.ERROR_INVALID="Invalid homeserver discovery response",ce.ERROR_GENERIC_FAILURE="Failed to get autodiscovery configuration from server",ce.ERROR_INVALID_HS_BASE_URL="Invalid base_url for m.homeserver",ce.ERROR_INVALID_HOMESERVER="Homeserver URL does not appear to be a valid Matrix homeserver",ce.ERROR_INVALID_IS_BASE_URL="Invalid base_url for m.identity_server",ce.ERROR_INVALID_IDENTITY_SERVER="Identity server URL does not appear to be a valid identity server",ce.ERROR_INVALID_IS="Invalid identity server discovery response",ce.ERROR_MISSING_WELLKNOWN="No .well-known JSON file found",ce.ERROR_INVALID_JSON="Invalid JSON",ce.ERROR_UNSUPPORTED_HOMESERVER_SPEC_VERSION="The homeserver does not meet the version requirements",ce.ERROR_HOMESERVER_TOO_OLD=ce.ERROR_UNSUPPORTED_HOMESERVER_SPEC_VERSION,ce.ALL_ERRORS=Object.keys(bu),ce.FAIL_ERROR="FAIL_ERROR",ce.FAIL_PROMPT="FAIL_PROMPT",ce.PROMPT="PROMPT",ce.SUCCESS="SUCCESS";let Ra=ce;var ml=/[\\\"\x00-\x1F]/g,fi={};for(var Zr=0;Zr<32;++Zr)fi[String.fromCharCode(Zr)]="\\U"+("0000"+Zr.toString(16)).slice(-4).toUpperCase();fi["\b"]="\\b";fi["	"]="\\t";fi[`
`]="\\n";fi["\f"]="\\f";fi["\r"]="\\r";fi['"']='\\"';fi["\\"]="\\\\";function wu(r){return ml.lastIndex=0,r.replace(ml,function(e){return fi[e]})}function Qa(r){switch(typeof r){case"string":return'"'+wu(r)+'"';case"number":return isFinite(r)?r:"null";case"boolean":return r;case"object":return r===null?"null":Array.isArray(r)?Tv(r):Cv(r);default:throw new Error("Cannot stringify: "+typeof r)}}function Tv(r){for(var e="[",t="",i=0;i<r.length;++i)t+=e,e=",",t+=Qa(r[i]);return e!=","?"[]":t+"]"}function Cv(r){var e="{",t="",i=Object.keys(r);i.sort();for(var n=0;n<i.length;++n){var s=i[n];t+=e+'"'+wu(s)+'":',e=",",t+=Qa(r[s])}return e!=","?"{}":t+"}"}var kv={stringify:Qa};const li=Nr(kv);var _u={};const Ge="m.olm.v1.curve25519-aes-sha2",dt="m.megolm.v1.aes-sha2",Ov="m.megolm_backup.v1.curve25519-aes-sha2";async function Ai(r,e,t,i,n,s,o){const a=s.getIdentityKey(),c=await i.getSessionIdForDevice(a);if(c===null){d.log(`[olmlib.encryptMessageForDevice] Unable to find Olm session for device ${n}:${s.deviceId}`);return}d.log(`[olmlib.encryptMessageForDevice] Using Olm session ${c} for device ${n}:${s.deviceId}`);const l={sender:e,sender_device:t,keys:{ed25519:i.deviceEd25519Key},recipient:n,recipient_keys:{ed25519:s.getFingerprint()},...o};r[a]=await i.encryptMessage(a,c,JSON.stringify(l))}async function Iu(r,e,t){const i=new $e(()=>[]),n=new $e(()=>new Map),s=[];for(const[o,a]of Object.entries(t))for(const c of a){const l=c.deviceId,u=c.getIdentityKey();s.push((async()=>{const h=await r.getSessionIdForDevice(u,!0);h===null?i.getOrCreate(o).push(c):n.getOrCreate(o).set(l,{device:c,sessionId:h})})())}return await Promise.all(s),[i,n]}async function di(r,e,t,i=!1,n,s,o=d){var v,S,w;const a=[],c=new Map,l=new Map;for(const M of t.values())for(const _ of M){const C=_.getIdentityKey();C!==r.deviceCurve25519Key&&(r.sessionsInProgress[C]||(r.sessionsInProgress[C]=new Promise(A=>{l.set(C,y=>{delete r.sessionsInProgress[C],A(y)})})))}for(const[M,_]of t){const C=new Map;c.set(M,C);for(const A of _){const y=A.deviceId,$=A.getIdentityKey();if($===r.deviceCurve25519Key){o.info("Attempted to start session with ourself! Ignoring"),C.set(y,{device:A,sessionId:null});continue}const X=`for ${$} (${M}:${y})`,le=await r.getSessionIdForDevice($,!!l.get($),o),ne=l.get($);le!==null&&ne&&ne(),(le===null||i)&&(i?o.info(`Forcing new Olm session ${X}`):o.info(`Making new Olm session ${X}`),a.push([M,y])),C.set(y,{device:A,sessionId:le})}}if(a.length===0)return c;const u="signed_curve25519";let h,f=`one-time keys for ${a.length} devices`;try{o.debug(`Claiming ${f}`),h=await e.claimOneTimeKeys(a,u,n),o.debug(`Claimed ${f}`)}catch(M){for(const _ of l.values())_();throw o.debug(`Failed to claim ${f}`,M,a),M}s&&"failures"in h&&s.push(...Object.keys(h.failures));const g=h.one_time_keys||{},m=[];for(const[M,_]of t){const C=g[M]||{};for(const A of _){const y=A.deviceId,$=A.getIdentityKey();if($===r.deviceCurve25519Key||(S=(v=c.get(M))==null?void 0:v.get(y))!=null&&S.sessionId&&!i)continue;const X=C[y]||{};let le=null;for(const ne in X)ne.indexOf(u+":")===0&&(le=X[ne]);if(!le){o.warn(`No one-time keys (alg=${u}) for device ${M}:${y}`),(w=l.get($))==null||w();continue}m.push(Mv(r,le,M,A).then(ne=>{var ge,Se;(ge=l.get($))==null||ge(ne??void 0);const ue=(Se=c.get(M))==null?void 0:Se.get(y);ue&&(ue.sessionId=ne)},ne=>{var ue;throw(ue=l.get($))==null||ue(),ne}))}}return f=`Olm sessions for ${m.length} devices`,o.debug(`Starting ${f}`),await Promise.all(m),o.debug(`Started ${f}`),c}async function Mv(r,e,t,i){const n=i.deviceId;try{await Dn(r,e,t,n,i.getFingerprint())}catch(o){return d.error("Unable to verify signature on one-time key for device "+t+":"+n+":",o),null}let s;try{s=await r.createOutboundSession(i.getIdentityKey(),e.key)}catch(o){return d.error("Error starting olm session with device "+t+":"+n+": "+o),null}return d.log("Started new olm sessionid "+s+" for device "+t+":"+n),s}async function Dn(r,e,t,i,n){const s="ed25519:"+i,c=((e.signatures||{})[t]||{})[s];if(!c)throw Error("No signature");const l=Object.assign({},e);"unsigned"in l&&delete l.unsigned,delete l.signatures;const u=li.stringify(l);r.verifySignature(n,u,c)}function ys(r,e,t,i){let n=!1;if(e instanceof Uint8Array){const a=new _u.Olm.PkSigning;i=a.init_with_seed(e),e=a,n=!0}const s=r.signatures||{};delete r.signatures;const o=r.unsigned;r.unsigned&&delete r.unsigned;try{const a=s[t]||{};return s[t]=a,a["ed25519:"+i]=e.sign(li.stringify(r))}finally{r.signatures=s,o&&(r.unsigned=o),n&&e.free()}}function yn(r,e,t){const i="ed25519:"+e;if(!(r.signatures&&r.signatures[t]&&r.signatures[t][i]))throw new Error("No signature");const n=r.signatures[t][i],s=new _u.Olm.Utility,o=r.signatures;delete r.signatures;const a=r.unsigned;r.unsigned&&delete r.unsigned;try{s.ed25519_verify(e,li.stringify(r),n)}finally{r.signatures=o,a&&(r.unsigned=a),s.free()}}function Xa(r){return r.getSenderKey()?r.getWireType()!==R.RoomMessageEncrypted||!["m.olm.v1.curve25519-aes-sha2"].includes(r.getWireContent().algorithm)?(d.error("Event was not encrypted using an appropriate algorithm"),!1):!0:(d.error("Event has no sender key (not encrypted?)"),!1)}const Av=Object.freeze(Object.defineProperty({__proto__:null,MEGOLM_ALGORITHM:dt,MEGOLM_BACKUP_ALGORITHM:Ov,OLM_ALGORITHM:Ge,encryptMessageForDevice:Ai,ensureOlmSessionsForDevices:di,getExistingOlmSessions:Iu,isOlmEncrypted:Xa,pkSign:ys,pkVerify:yn,verifySignature:Dn},Symbol.toStringTag,{value:"Module"}));var Ta=(r=>(r.IS="SERVICE_TYPE_IS",r.IM="SERVICE_TYPE_IM",r))(Ta||{});const ft="crypto.",vl=ft+"migration",ko=ft+"account",yl=ft+"cross_signing_keys",Sl=ft+"notified_error_devices",El=ft+"device_data",bi=ft+"inboundgroupsessions/",Pv=ft+"inboundgroupsessions.withheld/",Dv=ft+"rooms/",Ki=ft+"sessionsneedingbackup";function Fi(r){return ft+"sessions/"+r}function bl(r){return ft+"session.problems/"+r}function es(r,e){return bi+r+"/"+e}function wl(r,e){return Pv+r+"/"+e}function _l(r){return Dv+r}class Za extends xa{constructor(e){super(),this.store=e}static exists(e){var i;const t=e.length;for(let n=0;n<t;n++)if((i=e.key(n))!=null&&i.startsWith(ft))return!0;return!1}async containsData(){return Za.exists(this.store)}async getMigrationState(){return Ae(this.store,vl)??Zi.NOT_STARTED}async setMigrationState(e){at(this.store,vl,e)}countEndToEndSessions(e,t){let i=0;for(let n=0;n<this.store.length;++n){const s=this.store.key(n);if(s!=null&&s.startsWith(Fi(""))){const o=Ae(this.store,s);i+=Object.keys(o??{}).length}}t(i)}_getEndToEndSessions(e){const t=Ae(this.store,Fi(e)),i={};for(const[n,s]of Object.entries(t||{}))typeof s=="string"?i[n]={session:s}:i[n]=s;return i}getEndToEndSession(e,t,i,n){const s=this._getEndToEndSessions(e);n(s[t]||{})}getEndToEndSessions(e,t,i){i(this._getEndToEndSessions(e)||{})}getAllEndToEndSessions(e,t){var i;for(let n=0;n<this.store.length;++n)if((i=this.store.key(n))!=null&&i.startsWith(Fi(""))){const s=this.store.key(n).split("/")[1];for(const o of Object.values(this._getEndToEndSessions(s)))t(o)}}storeEndToEndSession(e,t,i,n){const s=this._getEndToEndSessions(e)||{};s[t]=i,at(this.store,Fi(e),s)}async storeEndToEndSessionProblem(e,t,i){const n=bl(e),s=Ae(this.store,n)||[];s.push({type:t,fixed:i,time:Date.now()}),s.sort((o,a)=>o.time-a.time),at(this.store,n,s)}async getEndToEndSessionProblem(e,t){const i=bl(e),n=Ae(this.store,i)||[];if(!n.length)return null;const s=n[n.length-1];for(const o of n)if(o.time>t)return Object.assign({},o,{fixed:s.fixed});return s.fixed?null:s}async filterOutNotifiedErrorDevices(e){const t=Ae(this.store,Sl)||{},i=[];for(const n of e){const{userId:s,deviceInfo:o}=n;s in t?o.deviceId in t[s]||(i.push(n),Gt(t[s],o.deviceId,!0)):(i.push(n),Gt(t,s,{[o.deviceId]:!0}))}return at(this.store,Sl,t),i}async getEndToEndSessionsBatch(){var t;const e=[];for(let i=0;i<this.store.length;++i)if((t=this.store.key(i))!=null&&t.startsWith(Fi(""))){const n=this.store.key(i).split("/")[1];for(const s of Object.values(this._getEndToEndSessions(n)))if(e.push(s),e.length>=Pn)return e}return e.length===0?null:e}async deleteEndToEndSessionsBatch(e){for(const{deviceKey:t,sessionId:i}of e){const n=this._getEndToEndSessions(t)||{};delete n[i],Object.keys(n).length===0?this.store.removeItem(Fi(t)):at(this.store,Fi(t),n)}}getEndToEndInboundGroupSession(e,t,i,n){n(Ae(this.store,es(e,t)),Ae(this.store,wl(e,t)))}getAllEndToEndInboundGroupSessions(e,t){for(let i=0;i<this.store.length;++i){const n=this.store.key(i);n!=null&&n.startsWith(bi)&&t({senderKey:n.slice(bi.length,bi.length+43),sessionId:n.slice(bi.length+44),sessionData:Ae(this.store,n)})}t(null)}addEndToEndInboundGroupSession(e,t,i,n){Ae(this.store,es(e,t))||this.storeEndToEndInboundGroupSession(e,t,i,n)}storeEndToEndInboundGroupSession(e,t,i,n){at(this.store,es(e,t),i)}storeEndToEndInboundGroupSessionWithheld(e,t,i,n){at(this.store,wl(e,t),i)}async countEndToEndInboundGroupSessions(){let e=0;for(let t=0;t<this.store.length;++t){const i=this.store.key(t);i!=null&&i.startsWith(bi)&&(e+=1)}return e}async getEndToEndInboundGroupSessionsBatch(){const e=Ae(this.store,Ki)||{},t=[];for(let i=0;i<this.store.length;++i){const n=this.store.key(i);if(n!=null&&n.startsWith(bi)){const s=n.slice(bi.length);if(t.push({senderKey:s.slice(0,43),sessionId:s.slice(44),sessionData:Ae(this.store,n),needsBackup:s in e}),t.length>=Pn)return t}}return t.length===0?null:t}async deleteEndToEndInboundGroupSessionsBatch(e){for(const{senderKey:t,sessionId:i}of e){const n=es(t,i);this.store.removeItem(n)}}getEndToEndDeviceData(e,t){t(Ae(this.store,El))}storeEndToEndDeviceData(e,t){at(this.store,El,e)}storeEndToEndRoom(e,t,i){at(this.store,_l(e),t)}getEndToEndRooms(e,t){const i={},n=_l("");for(let s=0;s<this.store.length;++s){const o=this.store.key(s);if(o!=null&&o.startsWith(n)){const a=o.slice(n.length);i[a]=Ae(this.store,o)}}t(i)}getSessionsNeedingBackup(e){const t=Ae(this.store,Ki)||{},i=[];for(const n in t)if(Object.prototype.hasOwnProperty.call(t,n)){const s=n.slice(0,43),o=n.slice(44);if(this.getEndToEndInboundGroupSession(s,o,null,a=>{i.push({senderKey:s,sessionId:o,sessionData:a})}),e&&i.length>=e)break}return Promise.resolve(i)}countSessionsNeedingBackup(){const e=Ae(this.store,Ki)||{};return Promise.resolve(Object.keys(e).length)}unmarkSessionsNeedingBackup(e){const t=Ae(this.store,Ki)||{};for(const i of e)delete t[i.senderKey+"/"+i.sessionId];return at(this.store,Ki,t),Promise.resolve()}markSessionsNeedingBackup(e){const t=Ae(this.store,Ki)||{};for(const i of e)t[i.senderKey+"/"+i.sessionId]=!0;return at(this.store,Ki,t),Promise.resolve()}deleteAllData(){return this.store.removeItem(ko),Promise.resolve()}getAccount(e,t){const i=Ae(this.store,ko);t(i)}storeAccount(e,t){at(this.store,ko,t)}getCrossSigningKeys(e,t){const i=Ae(this.store,yl);t(i)}getSecretStorePrivateKey(e,t,i){const n=Ae(this.store,ft+`ssss_cache.${i}`);t(n)}storeCrossSigningKeys(e,t){at(this.store,yl,t)}storeSecretStorePrivateKey(e,t,i){at(this.store,ft+`ssss_cache.${t}`,i)}doTxn(e,t,i){return Promise.resolve(i(null))}}function Ae(r,e){try{return JSON.parse(r.getItem(e))}catch(t){d.log("Error: Failed to get key %s: %s",e,t.message),d.log(t.stack)}return null}function at(r,e,t){r.setItem(e,JSON.stringify(t))}class Uv{constructor(e){this.db=e,this.nextTxnId=0,e.onversionchange=()=>{d.log(`versionchange for indexeddb ${this.db.name}: closing`),e.close()}}async containsData(){throw Error("Not implemented for Backend")}async startup(){return this}async deleteAllData(){throw Error("This is not implemented, call IDBFactory::deleteDatabase(dbName) instead.")}async getMigrationState(){let e=Zi.NOT_STARTED;return await this.doTxn("readonly",[z.STORE_ACCOUNT],t=>{const n=t.objectStore(z.STORE_ACCOUNT).get(qo);n.onsuccess=()=>{e=n.result??Zi.NOT_STARTED}}),e}async setMigrationState(e){await this.doTxn("readwrite",[z.STORE_ACCOUNT],t=>{t.objectStore(z.STORE_ACCOUNT).put(e,qo)})}getOrAddOutgoingRoomKeyRequest(e){const t=e.requestBody;return new Promise((i,n)=>{const s=this.db.transaction("outgoingRoomKeyRequests","readwrite");s.onerror=n,this._getOutgoingRoomKeyRequest(s,t,o=>{if(o){d.log(`already have key request outstanding for ${t.room_id} / ${t.session_id}: not sending another`),i(o);return}d.log(`enqueueing key request for ${t.room_id} / `+t.session_id),s.oncomplete=()=>{i(e)},s.objectStore("outgoingRoomKeyRequests").add(e)})})}getOutgoingRoomKeyRequest(e){return new Promise((t,i)=>{const n=this.db.transaction("outgoingRoomKeyRequests","readonly");n.onerror=i,this._getOutgoingRoomKeyRequest(n,e,s=>{t(s)})})}_getOutgoingRoomKeyRequest(e,t,i){const o=e.objectStore("outgoingRoomKeyRequests").index("session").openCursor([t.room_id,t.session_id]);o.onsuccess=()=>{const a=o.result;if(!a){i(null);return}const c=a.value;if(Xi(c.requestBody,t)){i(c);return}a.continue()}}getOutgoingRoomKeyRequestByState(e){if(e.length===0)return Promise.resolve(null);let t=0,i;function n(){const l=this.result;if(l){i=l.value;return}if(t++,t>=e.length)return;const u=e[t],h=this.source.openCursor(u);h.onsuccess=n}const s=this.db.transaction("outgoingRoomKeyRequests","readonly"),o=s.objectStore("outgoingRoomKeyRequests"),a=e[t],c=o.index("state").openCursor(a);return c.onsuccess=n,$i(s).then(()=>i)}getAllOutgoingRoomKeyRequestsByState(e){return new Promise((t,i)=>{const a=this.db.transaction("outgoingRoomKeyRequests","readonly").objectStore("outgoingRoomKeyRequests").index("state").getAll(e);a.onsuccess=()=>t(a.result),a.onerror=()=>i(a.error)})}getOutgoingRoomKeyRequestsByTarget(e,t,i){let n=0;const s=[];function o(){const h=this.result;if(h){const f=h.value;f.recipients.some(g=>g.userId===e&&g.deviceId===t)&&s.push(f),h.continue()}else{if(n++,n>=i.length)return;const f=i[n],g=this.source.openCursor(f);g.onsuccess=o}}const a=this.db.transaction("outgoingRoomKeyRequests","readonly"),c=a.objectStore("outgoingRoomKeyRequests"),l=i[n],u=c.index("state").openCursor(l);return u.onsuccess=o,$i(a).then(()=>s)}updateOutgoingRoomKeyRequest(e,t,i){let n=null;function s(){const c=this.result;if(!c)return;const l=c.value;if(l.state!=t){d.warn(`Cannot update room key request from ${t} as it was already updated to ${l.state}`);return}Object.assign(l,i),c.update(l),n=l}const o=this.db.transaction("outgoingRoomKeyRequests","readwrite"),a=o.objectStore("outgoingRoomKeyRequests").openCursor(e);return a.onsuccess=s,$i(o).then(()=>n)}deleteOutgoingRoomKeyRequest(e,t){const i=this.db.transaction("outgoingRoomKeyRequests","readwrite"),n=i.objectStore("outgoingRoomKeyRequests").openCursor(e);return n.onsuccess=()=>{const s=n.result;if(!s)return;const o=s.value;if(o.state!=t){d.warn(`Cannot delete room key request in state ${o.state} (expected ${t})`);return}s.delete()},$i(i)}getAccount(e,t){const n=e.objectStore("account").get("-");n.onsuccess=function(){try{t(n.result||null)}catch(s){xe(e,s)}}}storeAccount(e,t){e.objectStore("account").put(t,"-")}getCrossSigningKeys(e,t){const n=e.objectStore("account").get("crossSigningKeys");n.onsuccess=function(){try{t(n.result||null)}catch(s){xe(e,s)}}}getSecretStorePrivateKey(e,t,i){const s=e.objectStore("account").get(`ssss_cache:${i}`);s.onsuccess=function(){try{t(s.result||null)}catch(o){xe(e,o)}}}storeCrossSigningKeys(e,t){e.objectStore("account").put(t,"crossSigningKeys")}storeSecretStorePrivateKey(e,t,i){e.objectStore("account").put(i,`ssss_cache:${t}`)}countEndToEndSessions(e,t){const n=e.objectStore("sessions").count();n.onsuccess=function(){try{t(n.result)}catch(s){xe(e,s)}}}getEndToEndSessions(e,t,i){const o=t.objectStore("sessions").index("deviceKey").openCursor(e),a={};o.onsuccess=function(){const c=o.result;if(c)a[c.value.sessionId]={session:c.value.session,lastReceivedMessageTs:c.value.lastReceivedMessageTs},c.continue();else try{i(a)}catch(l){xe(t,l)}}}getEndToEndSession(e,t,i,n){const o=i.objectStore("sessions").get([e,t]);o.onsuccess=function(){try{o.result?n({session:o.result.session,lastReceivedMessageTs:o.result.lastReceivedMessageTs}):n(null)}catch(a){xe(i,a)}}}getAllEndToEndSessions(e,t){const n=e.objectStore("sessions").openCursor();n.onsuccess=function(){try{const s=n.result;s?(t(s.value),s.continue()):t(null)}catch(s){xe(e,s)}}}storeEndToEndSession(e,t,i,n){n.objectStore("sessions").put({deviceKey:e,sessionId:t,session:i.session,lastReceivedMessageTs:i.lastReceivedMessageTs})}async storeEndToEndSessionProblem(e,t,i){const n=this.db.transaction("session_problems","readwrite");n.objectStore("session_problems").put({deviceKey:e,type:t,fixed:i,time:Date.now()}),await $i(n)}async getEndToEndSessionProblem(e,t){let i=null;const n=this.db.transaction("session_problems","readwrite"),a=n.objectStore("session_problems").index("deviceKey").getAll(e);return a.onsuccess=()=>{const c=a.result;if(!c.length){i=null;return}c.sort((u,h)=>u.time-h.time);const l=c[c.length-1];for(const u of c)if(u.time>t){i=Object.assign({},u,{fixed:l.fixed});return}l.fixed?i=null:i=l},await $i(n),i}async filterOutNotifiedErrorDevices(e){const i=this.db.transaction("notified_error_devices","readwrite").objectStore("notified_error_devices"),n=[];return await Promise.all(e.map(s=>new Promise(o=>{const{userId:a,deviceInfo:c}=s,l=i.get([a,c.deviceId]);l.onsuccess=function(){l.result||(i.put({userId:a,deviceId:c.deviceId}),n.push(s)),o()}}))),n}async getEndToEndSessionsBatch(){const e=[];return await this.doTxn("readonly",[z.STORE_SESSIONS],t=>{const n=t.objectStore(z.STORE_SESSIONS).openCursor();n.onsuccess=function(){try{const s=n.result;s&&(e.push(s.value),e.length<Pn&&s.continue())}catch(s){xe(t,s)}}}),e.length===0?null:e}async deleteEndToEndSessionsBatch(e){await this.doTxn("readwrite",[z.STORE_SESSIONS],async t=>{try{const i=t.objectStore(z.STORE_SESSIONS);for(const{deviceKey:n,sessionId:s}of e){const o=i.delete([n,s]);await new Promise(a=>{o.onsuccess=a})}}catch(i){xe(t,i)}})}getEndToEndInboundGroupSession(e,t,i,n){let s=!1,o=!1;const c=i.objectStore("inbound_group_sessions").get([e,t]);c.onsuccess=function(){try{c.result?s=c.result.session:s=null,o!==!1&&n(s,o)}catch(h){xe(i,h)}};const u=i.objectStore("inbound_group_sessions_withheld").get([e,t]);u.onsuccess=function(){try{u.result?o=u.result.session:o=null,s!==!1&&n(s,o)}catch(h){xe(i,h)}}}getAllEndToEndInboundGroupSessions(e,t){const n=e.objectStore("inbound_group_sessions").openCursor();n.onsuccess=function(){const s=n.result;if(s){try{t({senderKey:s.value.senderCurve25519Key,sessionId:s.value.sessionId,sessionData:s.value.session})}catch(o){xe(e,o)}s.continue()}else try{t(null)}catch(o){xe(e,o)}}}addEndToEndInboundGroupSession(e,t,i,n){const o=n.objectStore("inbound_group_sessions").add({senderCurve25519Key:e,sessionId:t,session:i});o.onerror=a=>{var c;((c=o.error)==null?void 0:c.name)==="ConstraintError"?(a.stopPropagation(),a.preventDefault(),d.log("Ignoring duplicate inbound group session: "+e+" / "+t)):xe(n,new Error("Failed to add inbound group session: "+o.error))}}storeEndToEndInboundGroupSession(e,t,i,n){n.objectStore("inbound_group_sessions").put({senderCurve25519Key:e,sessionId:t,session:i})}storeEndToEndInboundGroupSessionWithheld(e,t,i,n){n.objectStore("inbound_group_sessions_withheld").put({senderCurve25519Key:e,sessionId:t,session:i})}async countEndToEndInboundGroupSessions(){let e=0;return await this.doTxn("readonly",[z.STORE_INBOUND_GROUP_SESSIONS],t=>{const n=t.objectStore(z.STORE_INBOUND_GROUP_SESSIONS).count();n.onsuccess=()=>{e=n.result}}),e}async getEndToEndInboundGroupSessionsBatch(){const e=[];return await this.doTxn("readonly",[z.STORE_INBOUND_GROUP_SESSIONS,z.STORE_BACKUP],t=>{const i=t.objectStore(z.STORE_INBOUND_GROUP_SESSIONS),n=t.objectStore(z.STORE_BACKUP),s=i.openCursor();s.onsuccess=function(){try{const o=s.result;if(o){const a=n.get(o.key);a.onsuccess=()=>{e.push({senderKey:o.value.senderCurve25519Key,sessionId:o.value.sessionId,sessionData:o.value.session,needsBackup:a.result!==void 0}),e.length<Pn&&o.continue()}}}catch(o){xe(t,o)}}}),e.length===0?null:e}async deleteEndToEndInboundGroupSessionsBatch(e){await this.doTxn("readwrite",[z.STORE_INBOUND_GROUP_SESSIONS],async t=>{try{const i=t.objectStore(z.STORE_INBOUND_GROUP_SESSIONS);for(const{senderKey:n,sessionId:s}of e){const o=i.delete([n,s]);await new Promise(a=>{o.onsuccess=a})}}catch(i){xe(t,i)}})}getEndToEndDeviceData(e,t){const n=e.objectStore("device_data").get("-");n.onsuccess=function(){try{t(n.result||null)}catch(s){xe(e,s)}}}storeEndToEndDeviceData(e,t){t.objectStore("device_data").put(e,"-")}storeEndToEndRoom(e,t,i){i.objectStore("rooms").put(t,e)}getEndToEndRooms(e,t){const i={},s=e.objectStore("rooms").openCursor();s.onsuccess=function(){const o=s.result;if(o)i[o.key]=o.value,o.continue();else try{t(i)}catch(a){xe(e,a)}}}getSessionsNeedingBackup(e){return new Promise((t,i)=>{const n=[],s=this.db.transaction(["sessions_needing_backup","inbound_group_sessions"],"readonly");s.onerror=i,s.oncomplete=function(){t(n)};const o=s.objectStore("sessions_needing_backup"),a=s.objectStore("inbound_group_sessions"),c=o.openCursor();c.onsuccess=function(){const l=c.result;if(l){const u=a.get(l.key);u.onsuccess=function(){n.push({senderKey:u.result.senderCurve25519Key,sessionId:u.result.sessionId,sessionData:u.result.session})},(!e||n.length<e)&&l.continue()}}})}countSessionsNeedingBackup(e){e||(e=this.db.transaction("sessions_needing_backup","readonly"));const t=e.objectStore("sessions_needing_backup");return new Promise((i,n)=>{const s=t.count();s.onerror=n,s.onsuccess=()=>i(s.result)})}async unmarkSessionsNeedingBackup(e,t){t||(t=this.db.transaction("sessions_needing_backup","readwrite"));const i=t.objectStore("sessions_needing_backup");await Promise.all(e.map(n=>new Promise((s,o)=>{const a=i.delete([n.senderKey,n.sessionId]);a.onsuccess=s,a.onerror=o})))}async markSessionsNeedingBackup(e,t){t||(t=this.db.transaction("sessions_needing_backup","readwrite"));const i=t.objectStore("sessions_needing_backup");await Promise.all(e.map(n=>new Promise((s,o)=>{const a=i.put({senderCurve25519Key:n.senderKey,sessionId:n.sessionId});a.onsuccess=s,a.onerror=o})))}addSharedHistoryInboundGroupSession(e,t,i,n){n||(n=this.db.transaction("shared_history_inbound_group_sessions","readwrite"));const s=n.objectStore("shared_history_inbound_group_sessions"),o=s.get([e]);o.onsuccess=()=>{const{sessions:a}=o.result||{sessions:[]};a.push([t,i]),s.put({roomId:e,sessions:a})}}getSharedHistoryInboundGroupSessions(e,t){t||(t=this.db.transaction("shared_history_inbound_group_sessions","readonly"));const n=t.objectStore("shared_history_inbound_group_sessions").get([e]);return new Promise((s,o)=>{n.onsuccess=()=>{const{sessions:a}=n.result||{sessions:[]};s(a)},n.onerror=o})}addParkedSharedHistory(e,t,i){i||(i=this.db.transaction("parked_shared_history","readwrite"));const n=i.objectStore("parked_shared_history"),s=n.get([e]);s.onsuccess=()=>{const{parked:o}=s.result||{parked:[]};o.push(t),n.put({roomId:e,parked:o})}}takeParkedSharedHistory(e,t){t||(t=this.db.transaction("parked_shared_history","readwrite"));const i=t.objectStore("parked_shared_history").openCursor(e);return new Promise((n,s)=>{i.onsuccess=()=>{const o=i.result;if(!o){n([]);return}const a=o.value;o.delete(),n(a)},i.onerror=s})}doTxn(e,t,i,n=d){const s=this.db.transaction(t,e),o=$i(s),a=i(s);return o.then(()=>a)}}const Ru=[r=>{Nv(r)},r=>{r.createObjectStore("account")},r=>{r.createObjectStore("sessions",{keyPath:["deviceKey","sessionId"]}).createIndex("deviceKey","deviceKey")},r=>{r.createObjectStore("inbound_group_sessions",{keyPath:["senderCurve25519Key","sessionId"]})},r=>{r.createObjectStore("device_data")},r=>{r.createObjectStore("rooms")},r=>{r.createObjectStore("sessions_needing_backup",{keyPath:["senderCurve25519Key","sessionId"]})},r=>{r.createObjectStore("inbound_group_sessions_withheld",{keyPath:["senderCurve25519Key","sessionId"]})},r=>{r.createObjectStore("session_problems",{keyPath:["deviceKey","time"]}).createIndex("deviceKey","deviceKey"),r.createObjectStore("notified_error_devices",{keyPath:["userId","deviceId"]})},r=>{r.createObjectStore("shared_history_inbound_group_sessions",{keyPath:["roomId"]})},r=>{r.createObjectStore("parked_shared_history",{keyPath:["roomId"]})}],Tu=Ru.length;function Lv(r,e){d.log(`Upgrading IndexedDBCryptoStore from version ${e} to ${Tu}`),Ru.forEach((t,i)=>{e<=i&&t(r)})}function Nv(r){const e=r.createObjectStore("outgoingRoomKeyRequests",{keyPath:"requestId"});e.createIndex("session",["requestBody.room_id","requestBody.session_id"]),e.createIndex("state","state")}function xe(r,e){r._mx_abortexception=e;try{r.abort()}catch{}}function $i(r){return new Promise((e,t)=>{r.oncomplete=()=>{r._mx_abortexception!==void 0&&t(r._mx_abortexception),e(null)},r.onerror=i=>{r._mx_abortexception!==void 0?t(r._mx_abortexception):(d.log("Error performing indexeddb txn",i),t(r.error))},r.onabort=i=>{r._mx_abortexception!==void 0?t(r._mx_abortexception):(d.log("Error performing indexeddb txn",i),t(r.error))}})}var Cu=(r=>(r.TooNew="TOO_NEW",r))(Cu||{});const dc=class dc extends Error{constructor(e){const t=`Crypto store is invalid because ${e}, please stop the client, delete all data and start the client again`;super(t),this.reason=e,this.name="InvalidCryptoStoreError"}};dc.TOO_NEW="TOO_NEW";let Ca=dc;class ts extends Error{constructor(e,t){super(e),this.value=t}}class NE extends Error{constructor(){super("MatrixClient has been stopped")}}function Kv(r,e){return new Promise((t,i)=>{let n=!0;const s=r.open(e);s.onupgradeneeded=()=>{n=!1},s.onblocked=()=>i(s.error),s.onsuccess=()=>{s.result.close(),n||r.deleteDatabase(e),t(n)},s.onerror=()=>i(s.error)})}var Fv={};const Qe=class Qe{constructor(e,t){this.indexedDB=e,this.dbName=t}static exists(e,t){return Kv(e,t)}static existsAndIsNotMigrated(e,t){return new Promise((i,n)=>{let s=!0;const o=e.open(t);o.onupgradeneeded=()=>{s=!1},o.onblocked=()=>n(o.error),o.onsuccess=()=>{const a=o.result;if(!s)a.close(),e.deleteDatabase(t),i(!1);else{const u=a.transaction([Qe.STORE_ACCOUNT],"readonly").objectStore(Qe.STORE_ACCOUNT).get(qo);u.onsuccess=()=>{const h=u.result??Zi.NOT_STARTED;i(h===Zi.NOT_STARTED)},u.onerror=()=>{n(u.error)},a.close()}},o.onerror=()=>n(o.error)})}async containsData(){return Qe.exists(this.indexedDB,this.dbName)}startup(){return this.backendPromise?this.backendPromise:(this.backendPromise=new Promise((e,t)=>{if(!this.indexedDB){t(new Error("no indexeddb support available"));return}d.log(`connecting to indexeddb ${this.dbName}`);const i=this.indexedDB.open(this.dbName,Tu);i.onupgradeneeded=n=>{const s=i.result,o=n.oldVersion;Lv(s,o)},i.onblocked=()=>{d.log("can't yet open IndexedDBCryptoStore because it is open elsewhere")},i.onerror=n=>{d.log("Error connecting to indexeddb",n),t(i.error)},i.onsuccess=()=>{const n=i.result;d.log(`connected to indexeddb ${this.dbName}`),e(new Uv(n))}}).then(e=>e.doTxn("readonly",[Qe.STORE_INBOUND_GROUP_SESSIONS,Qe.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],t=>{e.getEndToEndInboundGroupSession("","",t,()=>{})}).then(()=>e)).catch(e=>{if(e.name==="VersionError")throw d.warn("Crypto DB is too new for us to use!",e),new Ca(Cu.TooNew);d.warn(`unable to connect to indexeddb ${this.dbName}: falling back to localStorage store: ${e}`);try{return new Za(Fv.localStorage)}catch(t){return d.warn(`unable to open localStorage: falling back to in-memory store: ${t}`),new xa}}).then(e=>(this.backend=e,e)),this.backendPromise)}deleteAllData(){return new Promise((e,t)=>{if(!this.indexedDB){t(new Error("no indexeddb support available"));return}d.log(`Removing indexeddb instance: ${this.dbName}`);const i=this.indexedDB.deleteDatabase(this.dbName);i.onblocked=()=>{d.log("can't yet delete IndexedDBCryptoStore because it is open elsewhere")},i.onerror=n=>{d.log("Error deleting data from indexeddb",n),t(i.error)},i.onsuccess=()=>{d.log(`Removed indexeddb instance: ${this.dbName}`),e()}}).catch(e=>{d.warn(`unable to delete IndexedDBCryptoStore: ${e}`)})}getMigrationState(){return this.backend.getMigrationState()}setMigrationState(e){return this.backend.setMigrationState(e)}getOrAddOutgoingRoomKeyRequest(e){return this.backend.getOrAddOutgoingRoomKeyRequest(e)}getOutgoingRoomKeyRequest(e){return this.backend.getOutgoingRoomKeyRequest(e)}getOutgoingRoomKeyRequestByState(e){return this.backend.getOutgoingRoomKeyRequestByState(e)}getAllOutgoingRoomKeyRequestsByState(e){return this.backend.getAllOutgoingRoomKeyRequestsByState(e)}getOutgoingRoomKeyRequestsByTarget(e,t,i){return this.backend.getOutgoingRoomKeyRequestsByTarget(e,t,i)}updateOutgoingRoomKeyRequest(e,t,i){return this.backend.updateOutgoingRoomKeyRequest(e,t,i)}deleteOutgoingRoomKeyRequest(e,t){return this.backend.deleteOutgoingRoomKeyRequest(e,t)}getAccount(e,t){this.backend.getAccount(e,t)}storeAccount(e,t){this.backend.storeAccount(e,t)}getCrossSigningKeys(e,t){this.backend.getCrossSigningKeys(e,t)}getSecretStorePrivateKey(e,t,i){this.backend.getSecretStorePrivateKey(e,t,i)}storeCrossSigningKeys(e,t){this.backend.storeCrossSigningKeys(e,t)}storeSecretStorePrivateKey(e,t,i){this.backend.storeSecretStorePrivateKey(e,t,i)}countEndToEndSessions(e,t){this.backend.countEndToEndSessions(e,t)}getEndToEndSession(e,t,i,n){this.backend.getEndToEndSession(e,t,i,n)}getEndToEndSessions(e,t,i){this.backend.getEndToEndSessions(e,t,i)}getAllEndToEndSessions(e,t){this.backend.getAllEndToEndSessions(e,t)}storeEndToEndSession(e,t,i,n){this.backend.storeEndToEndSession(e,t,i,n)}storeEndToEndSessionProblem(e,t,i){return this.backend.storeEndToEndSessionProblem(e,t,i)}getEndToEndSessionProblem(e,t){return this.backend.getEndToEndSessionProblem(e,t)}filterOutNotifiedErrorDevices(e){return this.backend.filterOutNotifiedErrorDevices(e)}countEndToEndInboundGroupSessions(){return this.backend.countEndToEndInboundGroupSessions()}getEndToEndSessionsBatch(){return this.backend.getEndToEndSessionsBatch()}deleteEndToEndSessionsBatch(e){return this.backend.deleteEndToEndSessionsBatch(e)}getEndToEndInboundGroupSession(e,t,i,n){this.backend.getEndToEndInboundGroupSession(e,t,i,n)}getAllEndToEndInboundGroupSessions(e,t){this.backend.getAllEndToEndInboundGroupSessions(e,t)}addEndToEndInboundGroupSession(e,t,i,n){this.backend.addEndToEndInboundGroupSession(e,t,i,n)}storeEndToEndInboundGroupSession(e,t,i,n){this.backend.storeEndToEndInboundGroupSession(e,t,i,n)}storeEndToEndInboundGroupSessionWithheld(e,t,i,n){this.backend.storeEndToEndInboundGroupSessionWithheld(e,t,i,n)}getEndToEndInboundGroupSessionsBatch(){return this.backend.getEndToEndInboundGroupSessionsBatch()}deleteEndToEndInboundGroupSessionsBatch(e){return this.backend.deleteEndToEndInboundGroupSessionsBatch(e)}storeEndToEndDeviceData(e,t){this.backend.storeEndToEndDeviceData(e,t)}getEndToEndDeviceData(e,t){this.backend.getEndToEndDeviceData(e,t)}storeEndToEndRoom(e,t,i){this.backend.storeEndToEndRoom(e,t,i)}getEndToEndRooms(e,t){this.backend.getEndToEndRooms(e,t)}getSessionsNeedingBackup(e){return this.backend.getSessionsNeedingBackup(e)}countSessionsNeedingBackup(e){return this.backend.countSessionsNeedingBackup(e)}unmarkSessionsNeedingBackup(e,t){return this.backend.unmarkSessionsNeedingBackup(e,t)}markSessionsNeedingBackup(e,t){return this.backend.markSessionsNeedingBackup(e,t)}addSharedHistoryInboundGroupSession(e,t,i,n){this.backend.addSharedHistoryInboundGroupSession(e,t,i,n)}getSharedHistoryInboundGroupSessions(e,t){return this.backend.getSharedHistoryInboundGroupSessions(e,t)}addParkedSharedHistory(e,t,i){this.backend.addParkedSharedHistory(e,t,i)}takeParkedSharedHistory(e,t){return this.backend.takeParkedSharedHistory(e,t)}doTxn(e,t,i,n){return this.backend.doTxn(e,t,i,n)}};Qe.STORE_ACCOUNT="account",Qe.STORE_SESSIONS="sessions",Qe.STORE_INBOUND_GROUP_SESSIONS="inbound_group_sessions",Qe.STORE_INBOUND_GROUP_SESSIONS_WITHHELD="inbound_group_sessions_withheld",Qe.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS="shared_history_inbound_group_sessions",Qe.STORE_PARKED_SHARED_HISTORY="parked_shared_history",Qe.STORE_DEVICE_DATA="device_data",Qe.STORE_ROOMS="rooms",Qe.STORE_BACKUP="sessions_needing_backup";let z=Qe;var Vi=(r=>(r.Change="change",r))(Vi||{}),on=(r=>(r[r.Unsent=1]="Unsent",r[r.Requested=2]="Requested",r[r.Ready=3]="Ready",r[r.Started=4]="Started",r[r.Cancelled=5]="Cancelled",r[r.Done=6]="Done",r))(on||{}),io=(r=>(r.Cancel="cancel",r.ShowSas="show_sas",r.ShowReciprocateQr="show_reciprocate_qr",r))(io||{});function $v(r){return r.phase<3&&!r.accepting&&!r.declining}var Ne=(r=>(r.MEGOLM_UNKNOWN_INBOUND_SESSION_ID="MEGOLM_UNKNOWN_INBOUND_SESSION_ID",r.OLM_UNKNOWN_MESSAGE_INDEX="OLM_UNKNOWN_MESSAGE_INDEX",r.HISTORICAL_MESSAGE_NO_KEY_BACKUP="HISTORICAL_MESSAGE_NO_KEY_BACKUP",r.HISTORICAL_MESSAGE_BACKUP_UNCONFIGURED="HISTORICAL_MESSAGE_BACKUP_UNCONFIGURED",r.HISTORICAL_MESSAGE_WORKING_BACKUP="HISTORICAL_MESSAGE_WORKING_BACKUP",r.UNKNOWN_ERROR="UNKNOWN_ERROR",r.MEGOLM_BAD_ROOM="MEGOLM_BAD_ROOM",r.MEGOLM_MISSING_FIELDS="MEGOLM_MISSING_FIELDS",r.OLM_DECRYPT_GROUP_MESSAGE_ERROR="OLM_DECRYPT_GROUP_MESSAGE_ERROR",r.OLM_BAD_ENCRYPTED_MESSAGE="OLM_BAD_ENCRYPTED_MESSAGE",r.OLM_BAD_RECIPIENT="OLM_BAD_RECIPIENT",r.OLM_BAD_RECIPIENT_KEY="OLM_BAD_RECIPIENT_KEY",r.OLM_BAD_ROOM="OLM_BAD_ROOM",r.OLM_BAD_SENDER_CHECK_FAILED="OLM_BAD_SENDER_CHECK_FAILED",r.OLM_BAD_SENDER="OLM_BAD_SENDER",r.OLM_FORWARDED_MESSAGE="OLM_FORWARDED_MESSAGE",r.OLM_MISSING_CIPHERTEXT="OLM_MISSING_CIPHERTEXT",r.OLM_NOT_INCLUDED_IN_RECIPIENTS="OLM_NOT_INCLUDED_IN_RECIPIENTS",r.UNKNOWN_ENCRYPTION_ALGORITHM="UNKNOWN_ENCRYPTION_ALGORITHM",r))(Ne||{});class Ss{constructor(e,t,i){this.crossSigningVerified=e,this.crossSigningVerifiedBefore=t,this.tofu=i}isVerified(){return this.isCrossSigningVerified()}isCrossSigningVerified(){return this.crossSigningVerified}wasCrossSigningVerified(){return this.crossSigningVerifiedBefore}isTofu(){return this.tofu}}class Bv{constructor(e){this.signedByOwner=e.signedByOwner??!1,this.crossSigningVerified=e.crossSigningVerified??!1,this.tofu=e.tofu??!1,this.localVerified=e.localVerified??!1,this.trustCrossSignedDevices=e.trustCrossSignedDevices??!1}isVerified(){return this.localVerified||this.trustCrossSignedDevices&&this.crossSigningVerified}}var ec=(r=>(r.Master="master",r.SelfSigning="self_signing",r.UserSigning="user_signing",r))(ec||{}),wi=(r=>(r[r.NONE=0]="NONE",r[r.GREY=1]="GREY",r[r.RED=2]="RED",r))(wi||{}),Sn=(r=>(r[r.UNKNOWN=0]="UNKNOWN",r[r.UNVERIFIED_IDENTITY=1]="UNVERIFIED_IDENTITY",r[r.UNSIGNED_DEVICE=2]="UNSIGNED_DEVICE",r[r.UNKNOWN_DEVICE=3]="UNKNOWN_DEVICE",r[r.AUTHENTICITY_NOT_GUARANTEED=4]="AUTHENTICITY_NOT_GUARANTEED",r[r.MISMATCHED_SENDER_KEY=5]="MISMATCHED_SENDER_KEY",r))(Sn||{});class Fe extends Error{constructor(e,t,i){super(t),this.code=e,this.name="DecryptionError",this.detailedString=xv(this,i)}}function xv(r,e){let t=r.name+"[msg: "+r.message;return e&&(t+=", "+Object.keys(e).map(i=>i+": "+e[i]).join(", ")),t+="]",t}var Ot={};const Il=65536*3/4;class qv extends Error{constructor(){super(...arguments),this.data={errcode:"M_TOO_LARGE",error:"Payload too large for encrypted message"}}}function Rl(r){if(r===void 0)throw new Error("payloadString undefined");if(r.length>Il)throw new qv(`Message too long (${r.length} bytes). The maximum for an encrypted message is ${Il} bytes.`)}class Tl{constructor(e){this.cryptoStore=e,this.pickleKey="DEFAULT_KEY",this.deviceCurve25519Key=null,this.deviceEd25519Key=null,this.maxOneTimeKeys=null,this.outboundGroupSessionStore={},this.inboundGroupSessionMessageIndexes={},this.sessionsInProgress={},this.olmPrekeyPromise=Promise.resolve()}static getOlmVersion(){return Ot.Olm.get_library_version()}async init({pickleKey:e,fromExportedDevice:t}={}){let i;const n=new Ot.Olm.Account;try{t?(e&&d.warn("ignoring opts.pickleKey because opts.fromExportedDevice is present."),this.pickleKey=t.pickleKey,await this.initialiseFromExportedDevice(t,n)):(e&&(this.pickleKey=e),await this.initialiseAccount(n)),i=JSON.parse(n.identity_keys()),this.maxOneTimeKeys=n.max_number_of_one_time_keys()}finally{n.free()}this.deviceCurve25519Key=i.curve25519,this.deviceEd25519Key=i.ed25519}async initialiseFromExportedDevice(e,t){await this.cryptoStore.doTxn("readwrite",[z.STORE_ACCOUNT,z.STORE_SESSIONS],i=>{this.cryptoStore.storeAccount(i,e.pickledAccount),e.sessions.forEach(n=>{const{deviceKey:s,sessionId:o}=n,a={session:n.session,lastReceivedMessageTs:n.lastReceivedMessageTs};this.cryptoStore.storeEndToEndSession(s,o,a,i)})}),t.unpickle(this.pickleKey,e.pickledAccount)}async initialiseAccount(e){await this.cryptoStore.doTxn("readwrite",[z.STORE_ACCOUNT],t=>{this.cryptoStore.getAccount(t,i=>{i!==null?e.unpickle(this.pickleKey,i):(e.create(),i=e.pickle(this.pickleKey),this.cryptoStore.storeAccount(t,i))})})}getAccount(e,t){this.cryptoStore.getAccount(e,i=>{const n=new Ot.Olm.Account;try{n.unpickle(this.pickleKey,i),t(n)}finally{n.free()}})}storeAccount(e,t){this.cryptoStore.storeAccount(e,t.pickle(this.pickleKey))}async export(){const e={pickleKey:this.pickleKey};return await this.cryptoStore.doTxn("readonly",[z.STORE_ACCOUNT,z.STORE_SESSIONS],t=>{this.cryptoStore.getAccount(t,i=>{e.pickledAccount=i}),e.sessions=[],this.cryptoStore.getAllEndToEndSessions(t,i=>{e.sessions.push(i)})}),e}getSession(e,t,i,n){this.cryptoStore.getEndToEndSession(e,t,i,s=>{this.unpickleSession(s,n)})}unpickleSession(e,t){const i=new Ot.Olm.Session;try{i.unpickle(this.pickleKey,e.session);const n=Object.assign({},e,{session:i});t(n)}finally{i.free()}}saveSession(e,t,i){const n=t.session.session_id();d.debug(`Saving Olm session ${n} with device ${e}: ${t.session.describe()}`);const s=Object.assign(t,{session:t.session.pickle(this.pickleKey)});this.cryptoStore.storeEndToEndSession(e,n,s,i)}getUtility(e){const t=new Ot.Olm.Utility;try{return e(t)}finally{t.free()}}async sign(e){let t;return await this.cryptoStore.doTxn("readonly",[z.STORE_ACCOUNT],i=>{this.getAccount(i,n=>{t=n.sign(e)})}),t}async getOneTimeKeys(){let e;return await this.cryptoStore.doTxn("readonly",[z.STORE_ACCOUNT],t=>{this.getAccount(t,i=>{e=JSON.parse(i.one_time_keys())})}),e}maxNumberOfOneTimeKeys(){return this.maxOneTimeKeys??-1}async markKeysAsPublished(){await this.cryptoStore.doTxn("readwrite",[z.STORE_ACCOUNT],e=>{this.getAccount(e,t=>{t.mark_keys_as_published(),this.storeAccount(e,t)})})}generateOneTimeKeys(e){return this.cryptoStore.doTxn("readwrite",[z.STORE_ACCOUNT],t=>{this.getAccount(t,i=>{i.generate_one_time_keys(e),this.storeAccount(t,i)})})}async generateFallbackKey(){await this.cryptoStore.doTxn("readwrite",[z.STORE_ACCOUNT],e=>{this.getAccount(e,t=>{t.generate_fallback_key(),this.storeAccount(e,t)})})}async getFallbackKey(){let e;return await this.cryptoStore.doTxn("readonly",[z.STORE_ACCOUNT],t=>{this.getAccount(t,i=>{e=JSON.parse(i.unpublished_fallback_key())})}),e}async forgetOldFallbackKey(){await this.cryptoStore.doTxn("readwrite",[z.STORE_ACCOUNT],e=>{this.getAccount(e,t=>{t.forget_old_fallback_key(),this.storeAccount(e,t)})})}async createOutboundSession(e,t){let i;return await this.cryptoStore.doTxn("readwrite",[z.STORE_ACCOUNT,z.STORE_SESSIONS],n=>{this.getAccount(n,s=>{const o=new Ot.Olm.Session;try{o.create_outbound(s,e,t),i=o.session_id(),this.storeAccount(n,s);const a={session:o,lastReceivedMessageTs:Date.now()};this.saveSession(e,a,n)}finally{o.free()}})},d.getChild("[createOutboundSession]")),i}async createInboundSession(e,t,i){if(t!==0)throw new Error("Need messageType == 0 to create inbound session");let n;return await this.cryptoStore.doTxn("readwrite",[z.STORE_ACCOUNT,z.STORE_SESSIONS],s=>{this.getAccount(s,o=>{const a=new Ot.Olm.Session;try{a.create_inbound_from(o,e,i),o.remove_one_time_keys(a),this.storeAccount(s,o);const c=a.decrypt(t,i),l={session:a,lastReceivedMessageTs:Date.now()};this.saveSession(e,l,s),n={payload:c,session_id:a.session_id()}}finally{a.free()}})},d.getChild("[createInboundSession]")),n}async getSessionIdsForDevice(e){const t=d.getChild("[getSessionIdsForDevice]");if(e in this.sessionsInProgress){t.debug(`Waiting for Olm session for ${e} to be created`);try{await this.sessionsInProgress[e]}catch{}}let i;return await this.cryptoStore.doTxn("readonly",[z.STORE_SESSIONS],n=>{this.cryptoStore.getEndToEndSessions(e,n,s=>{i=Object.keys(s)})},t),i}async getSessionIdForDevice(e,t=!1,i){const n=await this.getSessionInfoForDevice(e,t,i);if(n.length===0)return null;let s=0;for(let o=1;o<n.length;o++){const a=n[o],c=a.lastReceivedMessageTs===void 0?0:a.lastReceivedMessageTs,l=n[s],u=l.lastReceivedMessageTs===void 0?0:l.lastReceivedMessageTs;(c>u||c===u&&a.sessionId<l.sessionId)&&(s=o)}return n[s].sessionId}async getSessionInfoForDevice(e,t=!1,i=d){if(i=i.getChild("[getSessionInfoForDevice]"),e in this.sessionsInProgress&&!t){i.debug(`Waiting for Olm session for ${e} to be created`);try{await this.sessionsInProgress[e]}catch{}}const n=[];return await this.cryptoStore.doTxn("readonly",[z.STORE_SESSIONS],s=>{this.cryptoStore.getEndToEndSessions(e,s,o=>{const a=Object.keys(o).sort();for(const c of a)this.unpickleSession(o[c],l=>{n.push({lastReceivedMessageTs:l.lastReceivedMessageTs,hasReceivedMessage:l.session.has_received_message(),sessionId:c})})})},i),n}async encryptMessage(e,t,i){Rl(i);let n;return await this.cryptoStore.doTxn("readwrite",[z.STORE_SESSIONS],s=>{this.getSession(e,t,s,o=>{const a=o.session.describe();d.log("encryptMessage: Olm Session ID "+t+" to "+e+": "+a),n=o.session.encrypt(i),this.saveSession(e,o,s)})},d.getChild("[encryptMessage]")),n}async decryptMessage(e,t,i,n){let s;return await this.cryptoStore.doTxn("readwrite",[z.STORE_SESSIONS],o=>{this.getSession(e,t,o,a=>{const c=a.session.describe();d.log("decryptMessage: Olm Session ID "+t+" from "+e+": "+c),s=a.session.decrypt(i,n),a.lastReceivedMessageTs=Date.now(),this.saveSession(e,a,o)})},d.getChild("[decryptMessage]")),s}async matchesSession(e,t,i,n){if(i!==0)return!1;let s;return await this.cryptoStore.doTxn("readonly",[z.STORE_SESSIONS],o=>{this.getSession(e,t,o,a=>{s=a.session.matches_inbound(n)})},d.getChild("[matchesSession]")),s}async recordSessionProblem(e,t,i){d.info(`Recording problem on olm session with ${e} of type ${t}. Recreating: ${i}`),await this.cryptoStore.storeEndToEndSessionProblem(e,t,i)}sessionMayHaveProblems(e,t){return this.cryptoStore.getEndToEndSessionProblem(e,t)}filterOutNotifiedErrorDevices(e){return this.cryptoStore.filterOutNotifiedErrorDevices(e)}saveOutboundGroupSession(e){this.outboundGroupSessionStore[e.session_id()]=e.pickle(this.pickleKey)}getOutboundGroupSession(e,t){const i=this.outboundGroupSessionStore[e];if(i===void 0)throw new Error("Unknown outbound group session "+e);const n=new Ot.Olm.OutboundGroupSession;try{return n.unpickle(this.pickleKey,i),t(n)}finally{n.free()}}createOutboundGroupSession(){const e=new Ot.Olm.OutboundGroupSession;try{return e.create(),this.saveOutboundGroupSession(e),e.session_id()}finally{e.free()}}encryptGroupMessage(e,t){return d.log(`encrypting msg with megolm session ${e}`),Rl(t),this.getOutboundGroupSession(e,i=>{const n=i.encrypt(t);return this.saveOutboundGroupSession(i),n})}getOutboundGroupSessionKey(e){return this.getOutboundGroupSession(e,function(t){return{chain_index:t.message_index(),key:t.session_key()}})}unpickleInboundGroupSession(e,t){const i=new Ot.Olm.InboundGroupSession;try{return i.unpickle(this.pickleKey,e.session),t(i)}finally{i.free()}}getInboundGroupSession(e,t,i,n,s){this.cryptoStore.getEndToEndInboundGroupSession(t,i,n,(o,a)=>{if(o===null){s(null,null,a);return}if(e!==null&&e!==o.room_id)throw new Error("Mismatched room_id for inbound group session (expected "+o.room_id+", was "+e+")");this.unpickleInboundGroupSession(o,c=>{s(c,o,a)})})}async addInboundGroupSession(e,t,i,n,s,o,a,c={}){await this.cryptoStore.doTxn("readwrite",[z.STORE_INBOUND_GROUP_SESSIONS,z.STORE_INBOUND_GROUP_SESSIONS_WITHHELD,z.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS],l=>{this.getInboundGroupSession(e,t,n,l,(u,h)=>{const f=new Ot.Olm.InboundGroupSession;try{if(a?f.import_session(s):f.create(s),n!=f.session_id())throw new Error("Mismatched group session ID from senderKey: "+t);if(u&&(d.log(`Update for megolm session ${t}|${n}`),u.first_known_index()<=f.first_known_index())){if(!h.untrusted||c.untrusted){d.log(`Keeping existing megolm session ${t}|${n}`);return}if(u.first_known_index()<f.first_known_index()){u.export_session(f.first_known_index())===f.export_session(f.first_known_index())?(d.info(`Upgrading trust of existing megolm session ${t}|${n} based on newly-received trusted session`),h.untrusted=!1,this.cryptoStore.storeEndToEndInboundGroupSession(t,n,h,l)):d.warn(`Newly-received megolm session ${t}|$sessionId} does not match existing session! Keeping existing session`);return}}d.debug(`Storing megolm session ${t}|${n} with first index `+f.first_known_index());const g=Object.assign({},c,{room_id:e,session:f.pickle(this.pickleKey),keysClaimed:o,forwardingCurve25519KeyChain:i});this.cryptoStore.storeEndToEndInboundGroupSession(t,n,g,l),!u&&c.sharedHistory&&this.cryptoStore.addSharedHistoryInboundGroupSession(e,t,n,l)}finally{f.free()}})},d.getChild("[addInboundGroupSession]"))}async addInboundGroupSessionWithheld(e,t,i,n,s){await this.cryptoStore.doTxn("readwrite",[z.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],o=>{this.cryptoStore.storeEndToEndInboundGroupSessionWithheld(t,i,{room_id:e,code:n,reason:s},o)})}async decryptGroupMessage(e,t,i,n,s,o){let a=null,c;if(await this.cryptoStore.doTxn("readwrite",[z.STORE_INBOUND_GROUP_SESSIONS,z.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],l=>{this.getInboundGroupSession(e,t,i,l,(u,h,f)=>{if(u===null||h===null){f&&(c=new Fe(Ne.MEGOLM_UNKNOWN_INBOUND_SESSION_ID,Cl(f),{session:t+"|"+i})),a=null;return}let g;try{g=u.decrypt(n)}catch(v){(v==null?void 0:v.message)==="OLM.UNKNOWN_MESSAGE_INDEX"&&f?c=new Fe(Ne.MEGOLM_UNKNOWN_INBOUND_SESSION_ID,Cl(f),{session:t+"|"+i}):c=v;return}let m=g.plaintext;if(m===void 0)m=g;else{const v=t+"|"+i+"|"+g.message_index;if(v in this.inboundGroupSessionMessageIndexes){const S=this.inboundGroupSessionMessageIndexes[v];if(S.id!==s||S.timestamp!==o){c=new Error("Duplicate message index, possible replay attack: "+v);return}}this.inboundGroupSessionMessageIndexes[v]={id:s,timestamp:o}}h.session=u.pickle(this.pickleKey),this.cryptoStore.storeEndToEndInboundGroupSession(t,i,h,l),a={result:m,keysClaimed:h.keysClaimed||{},senderKey:t,forwardingCurve25519KeyChain:h.forwardingCurve25519KeyChain||[],untrusted:!!h.untrusted}})},d.getChild("[decryptGroupMessage]")),c)throw c;return a}async hasInboundSessionKeys(e,t,i){let n;return await this.cryptoStore.doTxn("readonly",[z.STORE_INBOUND_GROUP_SESSIONS,z.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],s=>{this.cryptoStore.getEndToEndInboundGroupSession(t,i,s,o=>{if(o===null){n=!1;return}e!==o.room_id?(d.warn(`requested keys for inbound group session ${t}|${i}, with incorrect room_id (expected ${o.room_id}, was ${e})`),n=!1):n=!0})},d.getChild("[hasInboundSessionKeys]")),n}async getInboundGroupSessionKey(e,t,i,n){let s=null;return await this.cryptoStore.doTxn("readonly",[z.STORE_INBOUND_GROUP_SESSIONS,z.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],o=>{this.getInboundGroupSession(e,t,i,o,(a,c)=>{if(a===null||c===null){s=null;return}n===void 0&&(n=a.first_known_index());const l=a.export_session(n),h=(c.keysClaimed||{}).ed25519||null,f=c.forwardingCurve25519KeyChain||[],g="untrusted"in c?c.untrusted:f.length>0;s={chain_index:n,key:l,forwarding_curve25519_key_chain:f,sender_claimed_ed25519_key:h,shared_history:c.sharedHistory||!1,untrusted:g}})},d.getChild("[getInboundGroupSessionKey]")),s}exportInboundGroupSession(e,t,i){return this.unpickleInboundGroupSession(i,n=>{const s=n.first_known_index();return{sender_key:e,sender_claimed_keys:i.keysClaimed,room_id:i.room_id,session_id:t,session_key:n.export_session(s),forwarding_curve25519_key_chain:i.forwardingCurve25519KeyChain||[],first_known_index:n.first_known_index(),"org.matrix.msc3061.shared_history":i.sharedHistory||!1}})}async getSharedHistoryInboundGroupSessions(e){let t;return await this.cryptoStore.doTxn("readonly",[z.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS],i=>{t=this.cryptoStore.getSharedHistoryInboundGroupSessions(e,i)},d.getChild("[getSharedHistoryInboundGroupSessionsForRoom]")),t}verifySignature(e,t,i){this.getUtility(function(n){n.ed25519_verify(e,t,i)})}}const kr={"m.unverified":"The sender has disabled encrypting to unverified devices.","m.blacklisted":"The sender has blocked you.","m.unauthorised":"You are not authorised to read the message.","m.no_olm":"Unable to establish a secure channel."};function Cl(r){return r.code&&r.code in kr?kr[r.code]:r.reason?r.reason:"decryption key withheld"}const Vv=new Uint8Array(8);async function Vn(r,e,t,i){let n;i?n=tt(i):(n=new Uint8Array(16),rt.getRandomValues(n),n[8]&=127);const[s,o]=await ku(e,t),a=new Yi().encode(r),c=await bt.encrypt({name:"AES-CTR",counter:n,length:64},s,a),l=await bt.sign({name:"HMAC"},o,c);return{iv:lt(n),ciphertext:lt(c),mac:lt(l)}}async function jr(r,e,t){const[i,n]=await ku(e,t),s=tt(r.ciphertext);if(!await bt.verify({name:"HMAC"},n,tt(r.mac),s))throw new Error(`Error decrypting secret ${t}: bad MAC`);const o=await bt.decrypt({name:"AES-CTR",counter:tt(r.iv),length:64},i,s);return new TextDecoder().decode(new Uint8Array(o))}async function ku(r,e){const t=await bt.importKey("raw",r,{name:"HKDF"},!1,["deriveBits"]),i=await bt.deriveBits({name:"HKDF",salt:Vv,info:new Yi().encode(e),hash:"SHA-256"},t,512),n=i.slice(0,32),s=i.slice(32),o=bt.importKey("raw",n,{name:"AES-CTR"},!1,["encrypt","decrypt"]),a=bt.importKey("raw",s,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign","verify"]);return Promise.all([o,a])}const jv="\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0";function kn(r,e){return Vn(jv,r,"",e)}var is={};const Gv=1e3*60;function ns(r){return Object.values(r.keys)[0]}class Ut{constructor(e,t={},i={}){this.userId=e,this.callbacks=t,this.cacheCallbacks=i,this.keys={},this.firstUse=!0,this.crossSigningVerifiedBefore=!1}static fromStorage(e,t){const i=new Ut(t);for(const n in e)e.hasOwnProperty(n)&&(i[n]=e[n]);return i}toStorage(){return{keys:this.keys,firstUse:this.firstUse,crossSigningVerifiedBefore:this.crossSigningVerifiedBefore}}async getCrossSigningKey(e,t){const i=["master","self_signing","user_signing"].indexOf(e)>=0;if(!this.callbacks.getCrossSigningKey)throw new Error("No getCrossSigningKey callback supplied");t===void 0&&(t=this.getId(e));function n(c){if(!c)return;const l=new is.Olm.PkSigning,u=l.init_with_seed(c);if(u===t)return[u,l];l.free()}let s=null;this.cacheCallbacks.getCrossSigningKeyCache&&i&&(s=await this.cacheCallbacks.getCrossSigningKeyCache(e,t));const o=n(s);if(o)return o;s=await this.callbacks.getCrossSigningKey(e,t);const a=n(s);if(a)return this.cacheCallbacks.storeCrossSigningKeyCache&&i&&await this.cacheCallbacks.storeCrossSigningKeyCache(e,s),a;throw s?new Error("Key type "+e+" from getCrossSigningKey callback did not match"):new Error("getCrossSigningKey callback for "+e+" returned falsey")}async isStoredInSecretStorage(e){const t=await e.isStored("m.cross_signing.master")||{};function i(n){for(const s of Object.keys(t))n[s]||delete t[s]}for(const n of["self_signing","user_signing"])i(await e.isStored(`m.cross_signing.${n}`)||{});return Object.keys(t).length?t:null}static async storeInSecretStorage(e,t){for(const[i,n]of e){const s=lt(n);await t.store(`m.cross_signing.${i}`,s)}}static async getFromSecretStorage(e,t){const i=await t.get(`m.cross_signing.${e}`);return i?tt(i):null}async isStoredInKeyCache(e){var n;const t=this.cacheCallbacks;if(!t)return!1;const i=e?[e]:["master","self_signing","user_signing"];for(const s of i)if(!await((n=t.getCrossSigningKeyCache)==null?void 0:n.call(t,s)))return!1;return!0}async getCrossSigningKeysFromCache(){var i;const e=new Map,t=this.cacheCallbacks;if(!t)return e;for(const n of["master","self_signing","user_signing"]){const s=await((i=t.getCrossSigningKeyCache)==null?void 0:i.call(t,n));s&&e.set(n,s)}return e}getId(e="master"){if(!this.keys[e])return null;const t=this.keys[e];return ns(t)}async resetKeys(e){if(!this.callbacks.saveCrossSigningKeys)throw new Error("No saveCrossSigningKeys callback supplied");if(e===void 0||e&4||!this.keys.master)e=7;else if(e===0)return;const t={},i={};let n,s;try{if(e&4?(n=new is.Olm.PkSigning,t.master=n.generate_seed(),s=n.init_with_seed(t.master),i.master={user_id:this.userId,usage:["master"],keys:{["ed25519:"+s]:s}}):[s,n]=await this.getCrossSigningKey("master"),e&1){const o=new is.Olm.PkSigning;try{t.self_signing=o.generate_seed();const a=o.init_with_seed(t.self_signing);i.self_signing={user_id:this.userId,usage:["self_signing"],keys:{["ed25519:"+a]:a}},ys(i.self_signing,n,this.userId,s)}finally{o.free()}}if(e&2){const o=new is.Olm.PkSigning;try{t.user_signing=o.generate_seed();const a=o.init_with_seed(t.user_signing);i.user_signing={user_id:this.userId,usage:["user_signing"],keys:{["ed25519:"+a]:a}},ys(i.user_signing,n,this.userId,s)}finally{o.free()}}Object.assign(this.keys,i),this.callbacks.saveCrossSigningKeys(t)}finally{n&&n.free()}}clearKeys(){this.keys={}}setKeys(e){const t={};if(e.master){if(e.master.user_id!==this.userId){const n="Mismatched user ID "+e.master.user_id+" in master key from "+this.userId;throw d.error(n),new Error(n)}this.keys.master?ns(e.master)!==this.getId()&&(this.firstUse=!1):this.firstUse=!0,t.master=e.master}else if(this.keys.master)t.master=this.keys.master;else throw new Error("Tried to set cross-signing keys without a master key");const i=ns(t.master);if(e.user_signing){if(e.user_signing.user_id!==this.userId){const n="Mismatched user ID "+e.master.user_id+" in user_signing key from "+this.userId;throw d.error(n),new Error(n)}try{yn(e.user_signing,i,this.userId)}catch(n){throw d.error("invalid signature on user-signing key"),n}}if(e.self_signing){if(e.self_signing.user_id!==this.userId){const n="Mismatched user ID "+e.master.user_id+" in self_signing key from "+this.userId;throw d.error(n),new Error(n)}try{yn(e.self_signing,i,this.userId)}catch(n){throw d.error("invalid signature on self-signing key"),n}}e.master&&(this.keys.master=e.master,delete this.keys.self_signing,delete this.keys.user_signing),e.self_signing&&(this.keys.self_signing=e.self_signing),e.user_signing&&(this.keys.user_signing=e.user_signing)}updateCrossSigningVerifiedBefore(e){!this.crossSigningVerifiedBefore&&e&&(this.crossSigningVerifiedBefore=!0)}async signObject(e,t){if(!this.keys[t])throw new Error("Attempted to sign with "+t+" key but no such key present");const[i,n]=await this.getCrossSigningKey(t);try{return ys(e,n,this.userId,i),e}finally{n.free()}}async signUser(e){if(!this.keys.user_signing){d.info("No user signing key: not signing user");return}return this.signObject(e.keys.master,"user_signing")}async signDevice(e,t){if(e!==this.userId)throw new Error(`Trying to sign ${e}'s device; can only sign our own device`);if(!this.keys.self_signing){d.info("No self signing key: not signing device");return}return this.signObject({algorithms:t.algorithms,keys:t.keys,device_id:t.deviceId,user_id:e},"self_signing")}checkUserTrust(e){if(this.userId===e.userId&&this.getId()&&this.getId()===e.getId()&&this.getId("self_signing")&&this.getId("self_signing")===e.getId("self_signing"))return new Ss(!0,!0,this.firstUse);if(!this.keys.user_signing)return new Ss(!1,!1,e.firstUse);let t;const i=e.keys.master,n=this.getId("user_signing");try{yn(i,n,this.userId),t=!0}catch{t=!1}return new Ss(t,e.crossSigningVerifiedBefore,e.firstUse)}checkDeviceTrust(e,t,i,n){const s=this.checkUserTrust(e),o=e.keys.self_signing;if(!o)return new On(!1,!1,i,n);const a=Wv(t,e.userId);try{return yn(o,e.getId(),e.userId),yn(a,ns(o),e.userId),On.fromUserTrustLevel(s,i,n)}catch{return new On(!1,!1,i,n)}}getCacheCallbacks(){return this.cacheCallbacks}}function Wv(r,e){return{algorithms:r.algorithms,keys:r.keys,device_id:r.deviceId,user_id:e,signatures:r.signatures}}class On extends Bv{constructor(e,t,i,n,s=!1){super({crossSigningVerified:e,tofu:t,localVerified:i,trustCrossSignedDevices:n,signedByOwner:s})}static fromUserTrustLevel(e,t,i){return new On(e.isCrossSigningVerified(),e.isTofu(),t,i,!0)}isCrossSigningVerified(){return this.crossSigningVerified}isLocallyVerified(){return this.localVerified}isTofu(){return this.tofu}}function Ou(r,e){return{getCrossSigningKeyCache:async function(t,i){const n=await new Promise(s=>{r.doTxn("readonly",[z.STORE_ACCOUNT],o=>{r.getSecretStorePrivateKey(o,s,t)})});if(n&&n.ciphertext){const s=Buffer.from(e.pickleKey),o=await jr(n,s,t);return tt(o)}else return n},storeCrossSigningKeyCache:async function(t,i){if(!(i instanceof Uint8Array))throw new Error(`storeCrossSigningKeyCache expects Uint8Array, got ${i}`);const n=Buffer.from(e.pickleKey),s=await Vn(lt(i),n,t);return r.doTxn("readwrite",[z.STORE_ACCOUNT],o=>{r.storeSecretStorePrivateKey(o,t,s)})}}}async function Hv(r,e,t){if(r.getUserId()===e)return d.log("Cross-signing: Self-verification done; requesting keys"),new Promise((i,n)=>{const s=r,o=s.crypto.crossSigningInfo,a=new Ut(o.userId,{getCrossSigningKey:async u=>{d.debug("Cross-signing: requesting secret",u,t);const{promise:h}=s.requestSecret(`m.cross_signing.${u}`,[t]),f=await h,g=tt(f);return Uint8Array.from(g)}},o.getCacheCallbacks());a.keys=o.keys;const c=new Promise(u=>{setTimeout(u,Gv,new Error("Timeout"))}),l=(async()=>{if(!await s.crypto.getSessionBackupPrivateKey()){d.info("No cached backup key found. Requesting...");const f=await s.requestSecret("m.megolm_backup.v1",[t]).promise;d.info("Got key backup key, decoding...");const g=tt(f);d.info("Decoded backup key, storing..."),await s.crypto.storeSessionBackupPrivateKey(Uint8Array.from(g)),d.info("Backup key stored. Starting backup restore...");const m=await s.getKeyBackupVersion();s.restoreKeyBackupWithCache(void 0,void 0,m).then(()=>{d.info("Backup restored.")})}})();Promise.race([Promise.all([a.getCrossSigningKey("master"),a.getCrossSigningKey("self_signing"),a.getCrossSigningKey("user_signing"),l]),c]).then(i,n)}).catch(i=>{d.warn("Cross-signing: failure while requesting keys:",i)})}class Jv extends ke{constructor(e,t,i,n=250){super(),this.cryptoStore=t,this.keyDownloadChunkSize=n,this.devices={},this.crossSigningInfo={},this.userByIdentityKey={},this.deviceTrackingStatus={},this.syncToken=null,this.keyDownloadsInProgressByUser=new Map,this.dirty=!1,this.savePromise=null,this.resolveSavePromise=null,this.savePromiseTime=null,this.saveTimer=null,this.hasFetched=null,this.serialiser=new zv(e,i,this)}async load(){await this.cryptoStore.doTxn("readonly",[z.STORE_DEVICE_DATA],e=>{this.cryptoStore.getEndToEndDeviceData(e,t=>{this.hasFetched=!!(t!=null&&t.devices),this.devices=t?t.devices:{},this.crossSigningInfo=t?t.crossSigningInfo||{}:{},this.deviceTrackingStatus=t?t.trackingStatus:{},this.syncToken=(t==null?void 0:t.syncToken)??null,this.userByIdentityKey={};for(const i of Object.keys(this.devices)){const n=this.devices[i];for(const s of Object.keys(n)){const o=n[s].keys["curve25519:"+s];o!==void 0&&(this.userByIdentityKey[o]=i)}}})});for(const e of Object.keys(this.deviceTrackingStatus))this.deviceTrackingStatus[e]==2&&(this.deviceTrackingStatus[e]=1)}stop(){this.saveTimer!==null&&clearTimeout(this.saveTimer)}async saveIfDirty(e=500){if(!this.dirty)return Promise.resolve(!1);const t=Date.now()+e;this.savePromiseTime&&t<this.savePromiseTime&&(clearTimeout(this.saveTimer),this.saveTimer=null,this.savePromiseTime=null);let i=this.savePromise;if(i===null&&(i=new Promise(n=>{this.resolveSavePromise=n}),this.savePromise=i),this.saveTimer===null){const n=this.resolveSavePromise;this.savePromiseTime=t,this.saveTimer=setTimeout(()=>{d.log("Saving device tracking data",this.syncToken),this.savePromiseTime=null,this.saveTimer=null,this.savePromise=null,this.resolveSavePromise=null,this.cryptoStore.doTxn("readwrite",[z.STORE_DEVICE_DATA],s=>{this.cryptoStore.storeEndToEndDeviceData({devices:this.devices,crossSigningInfo:this.crossSigningInfo,trackingStatus:this.deviceTrackingStatus,syncToken:this.syncToken??void 0},s)}).then(()=>{this.dirty=!1,n==null||n(!0)},s=>{d.error("Failed to save device tracking data",this.syncToken),d.error(s)})},e)}return i}getSyncToken(){return this.syncToken}setSyncToken(e){this.syncToken=e}downloadKeys(e,t){const i=[],n=[];if(e.forEach(s=>{const o=this.deviceTrackingStatus[s];this.keyDownloadsInProgressByUser.has(s)?(d.log(`downloadKeys: already have a download in progress for ${s}: awaiting its result`),n.push(this.keyDownloadsInProgressByUser.get(s))):(t||o!=3)&&i.push(s)}),i.length!=0){d.log("downloadKeys: downloading for",i);const s=this.doKeyDownload(i);n.push(s)}return n.length===0&&d.log("downloadKeys: already have all necessary keys"),Promise.all(n).then(()=>this.getDevicesFromStore(e))}getDevicesFromStore(e){const t=new Map;return e.forEach(i=>{var s;const n=new Map;(s=this.getStoredDevicesForUser(i))==null||s.forEach(function(o){n.set(o.deviceId,o)}),t.set(i,n)}),t}getKnownUserIds(){return Object.keys(this.devices)}getStoredDevicesForUser(e){const t=this.devices[e];if(!t)return null;const i=[];for(const n in t)t.hasOwnProperty(n)&&i.push(ht.fromStorage(t[n],n));return i}getRawStoredDevicesForUser(e){return this.devices[e]}getStoredCrossSigningForUser(e){return this.crossSigningInfo[e]?Ut.fromStorage(this.crossSigningInfo[e],e):null}storeCrossSigningForUser(e,t){this.crossSigningInfo[e]=t,this.dirty=!0}getStoredDevice(e,t){const i=this.devices[e];if(i!=null&&i[t])return ht.fromStorage(i[t],t)}getUserByIdentityKey(e,t){return e!==Ge&&e!==dt?null:this.userByIdentityKey[t]}getDeviceByIdentityKey(e,t){const i=this.getUserByIdentityKey(e,t);if(!i)return null;const n=this.devices[i];if(!n)return null;for(const s in n){if(!n.hasOwnProperty(s))continue;const o=n[s];for(const a in o.keys){if(!o.keys.hasOwnProperty(a)||a.indexOf("curve25519:")!==0)continue;if(o.keys[a]==t)return ht.fromStorage(o,s)}}return null}storeDevicesForUser(e,t){this.setRawStoredDevicesForUser(e,t),this.dirty=!0}startTrackingDeviceList(e){if(typeof e!="string")throw new Error("userId must be a string; was "+e);this.deviceTrackingStatus[e]||(d.log("Now tracking device list for "+e),this.deviceTrackingStatus[e]=1,this.dirty=!0)}stopTrackingDeviceList(e){this.deviceTrackingStatus[e]&&(d.log("No longer tracking device list for "+e),this.deviceTrackingStatus[e]=0,this.dirty=!0)}stopTrackingAllDeviceLists(){for(const e of Object.keys(this.deviceTrackingStatus))this.deviceTrackingStatus[e]=0;this.dirty=!0}invalidateUserDeviceList(e){this.deviceTrackingStatus[e]&&(d.log("Marking device list outdated for",e),this.deviceTrackingStatus[e]=1,this.dirty=!0)}refreshOutdatedDeviceLists(){this.saveIfDirty();const e=[];for(const t of Object.keys(this.deviceTrackingStatus))this.deviceTrackingStatus[t]==1&&e.push(t);return this.doKeyDownload(e)}setRawStoredDevicesForUser(e,t){if(this.devices[e]!==void 0)for(const[i,n]of Object.entries(this.devices[e])){const s=n.keys["curve25519:"+i];delete this.userByIdentityKey[s]}this.devices[e]=t;for(const[i,n]of Object.entries(t)){const s=n.keys["curve25519:"+i];this.userByIdentityKey[s]=e}}setRawStoredCrossSigningForUser(e,t){this.crossSigningInfo[e]=t}doKeyDownload(e){if(e.length===0)return Promise.resolve();const t=this.serialiser.updateDevicesForUsers(e,this.syncToken).then(()=>{i(!0)},n=>{throw d.error("Error downloading keys for "+e+":",n),i(!1),n});e.forEach(n=>{this.keyDownloadsInProgressByUser.set(n,t),this.deviceTrackingStatus[n]==1&&(this.deviceTrackingStatus[n]=2)});const i=n=>{this.emit(me.WillUpdateDevices,e,!this.hasFetched),e.forEach(s=>{if(this.dirty=!0,this.keyDownloadsInProgressByUser.get(s)!==t){d.log("Another update in the queue for",s,"- not marking up-to-date");return}this.keyDownloadsInProgressByUser.delete(s),this.deviceTrackingStatus[s]==2&&(n?(this.deviceTrackingStatus[s]=3,d.log("Device list for",s,"now up to date")):this.deviceTrackingStatus[s]=1)}),this.saveIfDirty(),this.emit(me.DevicesUpdated,e,!this.hasFetched),this.hasFetched=!0};return t}}class zv{constructor(e,t,i){this.baseApis=e,this.olmDevice=t,this.deviceList=i,this.downloadInProgress=!1,this.keyDownloadsQueuedByUser={}}updateDevicesForUsers(e,t){return e.forEach(i=>{this.keyDownloadsQueuedByUser[i]=!0}),this.queuedQueryDeferred||(this.queuedQueryDeferred=Nn()),this.syncToken=t,this.downloadInProgress?(d.log("Queued key download for",e),this.queuedQueryDeferred.promise):this.doQueuedQueries()}doQueuedQueries(){if(this.downloadInProgress)throw new Error("DeviceListUpdateSerialiser.doQueuedQueries called with request active");const e=Object.keys(this.keyDownloadsQueuedByUser);this.keyDownloadsQueuedByUser={};const t=this.queuedQueryDeferred;this.queuedQueryDeferred=void 0,d.log("Starting key download for",e),this.downloadInProgress=!0;const i={};this.syncToken&&(i.token=this.syncToken);const n=[];for(let s=0;s<e.length;s+=this.deviceList.keyDownloadChunkSize){const o=e.slice(s,s+this.deviceList.keyDownloadChunkSize);n.push(()=>this.baseApis.downloadKeysForUsers(o,i))}return ef(n,3).then(async s=>{const o=Object.assign({},...s.map(u=>u.device_keys||{})),a=Object.assign({},...s.map(u=>u.master_keys||{})),c=Object.assign({},...s.map(u=>u.self_signing_keys||{})),l=Object.assign({},...s.map(u=>u.user_signing_keys||{}));for(const u of e){await Ir(5);try{await this.processQueryResponseForUser(u,o[u],{master:a==null?void 0:a[u],self_signing:c==null?void 0:c[u],user_signing:l==null?void 0:l[u]})}catch(h){d.error(`Error processing keys for ${u}:`,h)}}}).then(()=>{d.log("Completed key download for "+e),this.downloadInProgress=!1,t==null||t.resolve(),this.queuedQueryDeferred&&this.doQueuedQueries()},s=>{d.warn("Error downloading keys for "+e+":",s),this.downloadInProgress=!1,t==null||t.reject(s)}),t.promise}async processQueryResponseForUser(e,t,i){d.log("got device keys for "+e+":",t),d.log("got cross-signing keys for "+e+":",i);{const n={},s=this.deviceList.getRawStoredDevicesForUser(e);s&&Object.keys(s).forEach(a=>{const c=ht.fromStorage(s[a],a);n[a]=c}),await Yv(this.olmDevice,e,n,t||{},this.baseApis.getUserId(),this.baseApis.deviceId);const o={};Object.keys(n).forEach(a=>{o[a]=n[a].toStorage()}),this.deviceList.setRawStoredDevicesForUser(e,o)}if(i&&(i.master||i.self_signing||i.user_signing)){const n=this.deviceList.getStoredCrossSigningForUser(e)||new Ut(e);n.setKeys(i),this.deviceList.setRawStoredCrossSigningForUser(e,n.toStorage()),this.deviceList.emit(me.UserCrossSigningUpdated,e)}}}async function Yv(r,e,t,i,n,s){let o=!1;for(const a in t)if(t.hasOwnProperty(a)&&!(a in i)){if(e===n&&a===s){d.warn(`Local device ${a} missing from sync, skipping removal`);continue}d.log("Device "+e+":"+a+" has been removed"),delete t[a],o=!0}for(const a in i){if(!i.hasOwnProperty(a))continue;const c=i[a];if(c.user_id!==e){d.warn("Mismatched user_id "+c.user_id+" in keys from "+e+":"+a);continue}if(c.device_id!==a){d.warn("Mismatched device_id "+c.device_id+" in keys from "+e+":"+a);continue}await Qv(r,t,c)&&(o=!0)}return o}async function Qv(r,e,t){if(!t.keys)return!1;const i=t.device_id,n=t.user_id,s="ed25519:"+i,o=t.keys[s];if(!o)return d.warn("Device "+n+":"+i+" has no ed25519 key"),!1;const a=t.unsigned||{},c=t.signatures||{};try{await Dn(r,t,n,i,o)}catch(u){return d.warn("Unable to verify signature on device "+n+":"+i+":"+u),!1}let l;if(i in e){if(l=e[i],l.getFingerprint()!=o)return d.warn("Ed25519 key for device "+n+":"+i+" has changed"),!1}else e[i]=l=new ht(i);return l.keys=t.keys||{},l.algorithms=t.algorithms||[],l.unsigned=a,l.signatures=c,!0}const Mu=new Map,ka=new Map;class Au{constructor(e){this.userId=e.userId,this.deviceId=e.deviceId,this.crypto=e.crypto,this.olmDevice=e.olmDevice,this.baseApis=e.baseApis,this.roomId=e.roomId}prepareToEncrypt(e){}onRoomMembership(e,t,i){}}class Pu{constructor(e){this.userId=e.userId,this.crypto=e.crypto,this.olmDevice=e.olmDevice,this.baseApis=e.baseApis,this.roomId=e.roomId}async onRoomKeyEvent(e){}async importRoomKey(e,t){}hasKeysForKeyRequest(e){return Promise.resolve(!1)}shareKeysWithDevice(e){throw new Error("shareKeysWithDevice not supported for this DecryptionAlgorithm")}async retryDecryptionFromSender(e){return!1}}class Xv extends Error{constructor(e,t,i){super(e),this.devices=t,this.event=i,this.name="UnknownDeviceError",this.devices=t}}function Du(r,e,t){Mu.set(r,e),ka.set(r,t)}const Zv=ht.DeviceVerification;class ey extends Au{constructor(){super(...arguments),this.sessionPrepared=!1,this.prepPromise=null}ensureSession(e){return this.prepPromise?this.prepPromise:this.sessionPrepared?Promise.resolve():(this.prepPromise=this.crypto.downloadKeys(e).then(()=>this.crypto.ensureOlmSessionsForUsers(e)).then(()=>{this.sessionPrepared=!0}).finally(()=>{this.prepPromise=null}),this.prepPromise)}async encryptMessage(e,t,i){const s=(await e.getEncryptionTargetMembers()).map(function(l){return l.userId});await this.ensureSession(s);const o={room_id:e.roomId,type:t,content:i},a={algorithm:Ge,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{}},c=[];for(const l of s){const u=this.crypto.getStoredDevicesForUser(l)||[];for(const h of u)h.getIdentityKey()!=this.olmDevice.deviceCurve25519Key&&h.verified!=Zv.BLOCKED&&c.push(Ai(a.ciphertext,this.userId,this.deviceId,this.olmDevice,l,h,o))}return Promise.all(c).then(()=>a)}}class ty extends Pu{async decryptEvent(e){const t=e.getWireContent(),i=t.sender_key,n=t.ciphertext;if(!n)throw new Fe(Ne.OLM_MISSING_CIPHERTEXT,"Missing ciphertext");if(!(this.olmDevice.deviceCurve25519Key in n))throw new Fe(Ne.OLM_NOT_INCLUDED_IN_RECIPIENTS,"Not included in recipients");const s=n[this.olmDevice.deviceCurve25519Key];let o;try{o=await this.decryptMessage(i,s)}catch(u){throw new Fe(Ne.OLM_BAD_ENCRYPTED_MESSAGE,"Bad Encrypted Message",{sender:i,err:u})}const a=JSON.parse(o);if(a.recipient!=this.userId)throw new Fe(Ne.OLM_BAD_RECIPIENT,"Message was intended for "+a.recipient);if(a.recipient_keys.ed25519!=this.olmDevice.deviceEd25519Key)throw new Fe(Ne.OLM_BAD_RECIPIENT_KEY,"Message not intended for this device",{intended:a.recipient_keys.ed25519,our_key:this.olmDevice.deviceEd25519Key});let c=this.crypto.deviceList.getUserByIdentityKey(Ge,i);if(c==null){try{await this.crypto.deviceList.downloadKeys([e.getSender()],!1)}catch(u){throw new Fe(Ne.OLM_BAD_SENDER_CHECK_FAILED,"Could not verify sender identity",{sender:i,err:u})}c=this.crypto.deviceList.getUserByIdentityKey(Ge,i)}if(c!==e.getSender()&&c!==void 0&&c!==null)throw new Fe(Ne.OLM_BAD_SENDER,"Message claimed to be from "+e.getSender(),{real_sender:c});if(a.sender!=e.getSender())throw new Fe(Ne.OLM_FORWARDED_MESSAGE,"Message forwarded from "+a.sender,{reported_sender:e.getSender()});if(a.room_id!==e.getRoomId())throw new Fe(Ne.OLM_BAD_ROOM,"Message intended for room "+a.room_id,{reported_room:e.getRoomId()||"ROOM_ID_UNDEFINED"});const l=a.keys||{};return{clearEvent:a,senderCurve25519Key:i,claimedEd25519Key:l.ed25519||null}}decryptMessage(e,t){if(t.type!==0)return this.reallyDecryptMessage(e,t);{const i=this.olmDevice.olmPrekeyPromise.then(()=>this.reallyDecryptMessage(e,t));return this.olmDevice.olmPrekeyPromise=i.catch(()=>{}),i}}async reallyDecryptMessage(e,t){const i=await this.olmDevice.getSessionIdsForDevice(e),n={};for(const o of i)try{const a=await this.olmDevice.decryptMessage(e,o,t.type,t.body);return d.log("Decrypted Olm message from "+e+" with session "+o),a}catch(a){if(await this.olmDevice.matchesSession(e,o,t.type,t.body))throw new Error("Error decrypting prekey message with existing session id "+o+": "+a.message);n[o]=a.message}if(t.type!==0)throw i.length===0?new Error("No existing sessions"):new Error("Error decrypting non-prekey message with existing sessions: "+JSON.stringify(n));let s;try{s=await this.olmDevice.createInboundSession(e,t.type,t.body)}catch(o){throw n["(new)"]=o.message,new Error("Error decrypting prekey message: "+JSON.stringify(n))}return d.log("created new inbound Olm session ID "+s.session_id+" with "+e),s.payload}}Du(Ge,ey,ty);const iy=500;var Uu=(r=>(r[r.Unsent=0]="Unsent",r[r.Sent=1]="Sent",r[r.CancellationPending=2]="CancellationPending",r[r.CancellationPendingAndWillResend=3]="CancellationPendingAndWillResend",r))(Uu||{});class ny{constructor(e,t,i){this.baseApis=e,this.deviceId=t,this.cryptoStore=i,this.sendOutgoingRoomKeyRequestsRunning=!1,this.clientRunning=!0}stop(){d.log("stopping OutgoingRoomKeyRequestManager"),this.clientRunning=!1}sendQueuedRequests(){this.startTimer()}async queueRoomKeyRequest(e,t,i=!1){const n=await this.cryptoStore.getOutgoingRoomKeyRequest(e);if(!n)await this.cryptoStore.getOrAddOutgoingRoomKeyRequest({requestBody:e,recipients:t,requestId:this.baseApis.makeTxnId(),state:0});else switch(n.state){case 3:case 0:return;case 2:{const s=i?3:1;await this.cryptoStore.updateOutgoingRoomKeyRequest(n.requestId,2,{state:s,cancellationTxnId:this.baseApis.makeTxnId()});break}case 1:{if(i){const o=await this.cryptoStore.updateOutgoingRoomKeyRequest(n.requestId,1,{state:3,cancellationTxnId:this.baseApis.makeTxnId(),requestTxnId:this.baseApis.makeTxnId()});if(!o)return this.queueRoomKeyRequest(e,t,i);try{await this.sendOutgoingRoomKeyRequestCancellation(o,!0)}catch(a){d.error("Error sending room key request cancellation; will retry later.",a)}}break}default:throw new Error("unhandled state: "+n.state)}}cancelRoomKeyRequest(e){return this.cryptoStore.getOutgoingRoomKeyRequest(e).then(t=>{if(t)switch(t.state){case 2:case 3:return;case 0:return d.log("deleting unnecessary room key request for "+rs(e)),this.cryptoStore.deleteOutgoingRoomKeyRequest(t.requestId,0);case 1:return this.cryptoStore.updateOutgoingRoomKeyRequest(t.requestId,1,{state:2,cancellationTxnId:this.baseApis.makeTxnId()}).then(i=>{if(!i){d.log("Tried to cancel room key request for "+rs(e)+" but it was already cancelled in another tab");return}this.sendOutgoingRoomKeyRequestCancellation(i).catch(n=>{d.error("Error sending room key request cancellation; will retry later.",n),this.startTimer()})});default:throw new Error("unhandled state: "+t.state)}})}getOutgoingSentRoomKeyRequest(e,t){return this.cryptoStore.getOutgoingRoomKeyRequestsByTarget(e,t,[1])}async cancelAndResendAllOutgoingRequests(){const e=await this.cryptoStore.getAllOutgoingRoomKeyRequestsByState(1);return Promise.all(e.map(({requestBody:t,recipients:i})=>this.queueRoomKeyRequest(t,i,!0)))}startTimer(){if(this.sendOutgoingRoomKeyRequestsTimer)return;const e=()=>{if(this.sendOutgoingRoomKeyRequestsRunning)throw new Error("RoomKeyRequestSend already in progress!");this.sendOutgoingRoomKeyRequestsRunning=!0,this.sendOutgoingRoomKeyRequests().finally(()=>{this.sendOutgoingRoomKeyRequestsRunning=!1}).catch(t=>{d.warn(`error in OutgoingRoomKeyRequestManager: ${t}`)})};this.sendOutgoingRoomKeyRequestsTimer=setTimeout(e,iy)}async sendOutgoingRoomKeyRequests(){if(!this.clientRunning){this.sendOutgoingRoomKeyRequestsTimer=void 0;return}const e=await this.cryptoStore.getOutgoingRoomKeyRequestByState([2,3,0]);if(!e){this.sendOutgoingRoomKeyRequestsTimer=void 0;return}try{switch(e.state){case 0:await this.sendOutgoingRoomKeyRequest(e);break;case 2:await this.sendOutgoingRoomKeyRequestCancellation(e);break;case 3:await this.sendOutgoingRoomKeyRequestCancellation(e,!0);break}return this.sendOutgoingRoomKeyRequests()}catch(t){d.error("Error sending room key request; will retry later.",t),this.sendOutgoingRoomKeyRequestsTimer=void 0}}sendOutgoingRoomKeyRequest(e){d.log(`Requesting keys for ${rs(e.requestBody)} from ${kl(e.recipients)}(id ${e.requestId})`);const t={action:"request",requesting_device_id:this.deviceId,request_id:e.requestId,body:e.requestBody};return this.sendMessageToDevices(t,e.recipients,e.requestTxnId||e.requestId).then(()=>this.cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,0,{state:1}))}sendOutgoingRoomKeyRequestCancellation(e,t=!1){d.log(`Sending cancellation for key request for ${rs(e.requestBody)} to ${kl(e.recipients)} (cancellation id ${e.cancellationTxnId})`);const i={action:"request_cancellation",requesting_device_id:this.deviceId,request_id:e.requestId};return this.sendMessageToDevices(i,e.recipients,e.cancellationTxnId).then(()=>t?this.cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,3,{state:0}):this.cryptoStore.deleteOutgoingRoomKeyRequest(e.requestId,2))}sendMessageToDevices(e,t,i){const n=new $e(()=>new Map);for(const s of t)n.getOrCreate(s.userId).set(s.deviceId,{...e,[ut]:Kt()});return this.baseApis.sendToDevice(R.RoomKeyRequest,n,i)}}function rs(r){return r.room_id+" / "+r.session_id}function kl(r){return`[${r.map(e=>`${e.userId}:${e.deviceId}`).join(",")}]`}function Lu(r){var i,n;const e=(i=r==null?void 0:r.currentState)==null?void 0:i.getStateEvents("m.room.history_visibility",""),t=(n=e==null?void 0:e.getContent())==null?void 0:n.history_visibility;return["world_readable","shared"].includes(t)}const ry=r=>typeof r.ciphertext=="string"?!!r.ciphertext.length:!!Object.keys(r.ciphertext).length;class sy{constructor(e,t=!1){this.sessionId=e,this.sharedHistory=t,this.useCount=0,this.sharedWithDevices=new $e(()=>new Map),this.blockedDevicesNotified=new $e(()=>new Map),this.creationTime=new Date().getTime()}needsRotation(e,t){const i=new Date().getTime()-this.creationTime;return this.useCount>=e||i>=t?(d.log("Rotating megolm session after "+this.useCount+" messages, "+i+"ms"),!0):!1}markSharedWithDevice(e,t,i,n){this.sharedWithDevices.getOrCreate(e).set(t,{deviceKey:i,messageIndex:n})}markNotifiedBlockedDevice(e,t){this.blockedDevicesNotified.getOrCreate(e).set(t,!0)}sharedWithTooManyDevices(e){var t;for(const[i,n]of this.sharedWithDevices){if(!e.has(i))return d.log("Starting new megolm session because we shared with "+i),!0;for(const[s]of n)if(!((t=e.get(i))!=null&&t.get(s)))return d.log("Starting new megolm session because we shared with "+i+":"+s),!0}return!1}}class oy extends Au{constructor(e){var t,i;super(e),this.setupPromise=Promise.resolve(null),this.outboundSessions={},this.roomId=e.roomId,this.prefixedLogger=d.getChild(`[${this.roomId} encryption]`),this.sessionRotationPeriodMsgs=((t=e.config)==null?void 0:t.rotation_period_msgs)??100,this.sessionRotationPeriodMs=((i=e.config)==null?void 0:i.rotation_period_ms)??7*24*3600*1e3}async ensureOutboundSession(e,t,i,n=!1){const s=async a=>{const c=Lu(e),l=await this.prepareSession(t,c,a);return await this.shareSession(t,c,n,i,l),l},o=this.setupPromise.then(s);return this.setupPromise=o.catch(a=>(this.prefixedLogger.error("Failed to setup outbound session",a),null)),o}async prepareSession(e,t,i){return i&&t!==i.sharedHistory&&(i=null),i!=null&&i.needsRotation(this.sessionRotationPeriodMsgs,this.sessionRotationPeriodMs)&&(this.prefixedLogger.debug("Starting new megolm session because we need to rotate."),i=null),i!=null&&i.sharedWithTooManyDevices(e)&&(i=null),i||(this.prefixedLogger.debug("Starting new megolm session"),i=await this.prepareNewSession(t),this.prefixedLogger.debug(`Started new megolm session ${i.sessionId}`),this.outboundSessions[i.sessionId]=i),i}async shareSession(e,t,i,n,s){var h;const o={};for(const[f,g]of e)for(const[m,v]of g)v.getIdentityKey()!=this.olmDevice.deviceCurve25519Key&&((h=s.sharedWithDevices.get(f))!=null&&h.get(m)||(o[f]=o[f]||[],o[f].push(v)));const a=this.olmDevice.getOutboundGroupSessionKey(s.sessionId),c={type:"m.room_key",content:{algorithm:dt,room_id:this.roomId,session_id:s.sessionId,session_key:a.key,chain_index:a.chain_index,"org.matrix.msc3061.shared_history":t}},[l,u]=await Iu(this.olmDevice,this.baseApis,o);await Promise.all([(async()=>{const f=Array.from(u.entries()).map(([g,m])=>Array.from(m.entries()).map(([v,S])=>`${g}/${v}: ${S.sessionId}`)).flat(1);this.prefixedLogger.debug("Sharing keys with devices with existing Olm sessions:",f),await this.shareKeyWithOlmSessions(s,a,c,u),this.prefixedLogger.debug("Shared keys with existing Olm sessions")})(),(async()=>{const f=Array.from(l.entries()).map(([S,w])=>w.map(M=>`${S}/${M.deviceId}`)).flat(1);this.prefixedLogger.debug("Sharing keys (start phase 1) with devices without existing Olm sessions:",f);const g=[],m=Date.now(),v=[];await this.shareKeyWithDevices(s,a,c,l,g,i?1e4:2e3,v),this.prefixedLogger.debug("Shared keys (end phase 1) with devices without existing Olm sessions"),!i&&Date.now()-m<1e4?(async()=>{const S=new $e(()=>[]),w=new Set;for(const C of v)w.add(C);const M=[];for(const{userId:C,deviceInfo:A}of g){const y=C.slice(C.indexOf(":")+1);w.has(y)?S.getOrCreate(C).push(A):M.push({userId:C,deviceInfo:A})}const _=Array.from(S.entries()).map(([C,A])=>A.map(y=>`${C}/${y.deviceId}`)).flat(1);_.length>0&&(this.prefixedLogger.debug("Sharing keys (start phase 2) with devices without existing Olm sessions:",_),await this.shareKeyWithDevices(s,a,c,S,M,3e4),this.prefixedLogger.debug("Shared keys (end phase 2) with devices without existing Olm sessions")),await this.notifyFailedOlmDevices(s,a,M)})():await this.notifyFailedOlmDevices(s,a,g)})(),(async()=>{var m;this.prefixedLogger.debug(`There are ${n.size} blocked devices:`,Array.from(n.entries()).map(([v,S])=>Array.from(S.entries()).map(([w,M])=>`${v}/${w}`)).flat(1));const f=new $e(()=>new Map);let g=0;for(const[v,S]of n)for(const[w,M]of S)((m=s.blockedDevicesNotified.get(v))==null?void 0:m.get(w))===void 0&&(f.getOrCreate(v).set(w,{device:M}),g++);g&&(this.prefixedLogger.debug(`Notifying ${g} newly blocked devices:`,Array.from(f.entries()).map(([v,S])=>Object.entries(S).map(([w,M])=>`${v}/${w}`)).flat(1)),await this.notifyBlockedDevices(s,f),this.prefixedLogger.debug(`Notified ${g} newly blocked devices`))})()])}async prepareNewSession(e){const t=this.olmDevice.createOutboundGroupSession(),i=this.olmDevice.getOutboundGroupSessionKey(t);return await this.olmDevice.addInboundGroupSession(this.roomId,this.olmDevice.deviceCurve25519Key,[],t,i.key,{ed25519:this.olmDevice.deviceEd25519Key},!1,{sharedHistory:e}),this.crypto.backupManager.backupGroupSession(this.olmDevice.deviceCurve25519Key,t),new sy(t,e)}getDevicesWithoutSessions(e,t,i=[]){for(const[n,s]of t){const o=e.get(n);for(const a of s){const c=a.deviceId,l=o==null?void 0:o.get(c);if(!(l!=null&&l.sessionId)){i.push({userId:n,deviceInfo:a}),o==null||o.delete(c);continue}}}return i}splitDevices(e){let i=[];const n=[i];for(const[s,o]of e){for(const a of o.values())i.push({userId:s,deviceInfo:a.device});i.length>20&&(i=[],n.push(i))}return i.length===0&&n.pop(),n}encryptAndSendKeysToDevices(e,t,i,n){return this.crypto.encryptAndSendToDevices(i,n).then(()=>{for(const s of i)e.markSharedWithDevice(s.userId,s.deviceInfo.deviceId,s.deviceInfo.getIdentityKey(),t)}).catch(s=>{throw this.prefixedLogger.error("failed to encryptAndSendToDevices",s),s})}async sendBlockedNotificationsToDevices(e,t,i){const n=new $e(()=>new Map);for(const s of t){const o=s.userId,a=s.deviceInfo,l=a.deviceInfo.deviceId,u={...i,code:a.code,reason:a.reason,[ut]:Kt()};u.code==="m.no_olm"&&(delete u.room_id,delete u.session_id),n.getOrCreate(o).set(l,u)}await this.baseApis.sendToDevice("m.room_key.withheld",n);for(const[s,o]of n)for(const a of o.keys())e.markNotifiedBlockedDevice(s,a)}async reshareKeyWithDevice(e,t,i,n){var u;const s=this.outboundSessions[t];if(!s){this.prefixedLogger.debug(`megolm session ${e}|${t} not found: not re-sharing keys`);return}if(!s.sharedWithDevices.has(i)){this.prefixedLogger.debug(`megolm session ${e}|${t} never shared with user ${i}`);return}const o=(u=s.sharedWithDevices.get(i))==null?void 0:u.get(n.deviceId);if(o===void 0){this.prefixedLogger.debug(`megolm session ${e}|${t} never shared with device ${i}:${n.deviceId}`);return}if(o.deviceKey!==n.getIdentityKey()){this.prefixedLogger.warn(`Megolm session ${e}|${t} has been shared with device ${n.deviceId} but with identity key ${o.deviceKey}. Key is now ${n.getIdentityKey()}!`);return}const a=await this.olmDevice.getInboundGroupSessionKey(this.roomId,e,t,o.messageIndex);if(!a){this.prefixedLogger.warn(`No inbound session key found for megolm session ${e}|${t}: not re-sharing keys`);return}await di(this.olmDevice,this.baseApis,new Map([[i,[n]]]));const c={type:"m.forwarded_room_key",content:{algorithm:dt,room_id:this.roomId,session_id:t,session_key:a.key,chain_index:a.chain_index,sender_key:e,sender_claimed_ed25519_key:a.sender_claimed_ed25519_key,forwarding_curve25519_key_chain:a.forwarding_curve25519_key_chain,"org.matrix.msc3061.shared_history":a.shared_history||!1}},l={algorithm:Ge,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[ut]:Kt()};await Ai(l.ciphertext,this.userId,this.deviceId,this.olmDevice,i,n,c),await this.baseApis.sendToDevice("m.room.encrypted",new Map([[i,new Map([[n.deviceId,l]])]])),this.prefixedLogger.debug(`Re-shared key for megolm session ${e}|${t} with ${i}:${n.deviceId}`)}async shareKeyWithDevices(e,t,i,n,s,o,a){const c=await di(this.olmDevice,this.baseApis,n,!1,o,a,this.prefixedLogger);this.getDevicesWithoutSessions(c,n,s),await this.shareKeyWithOlmSessions(e,t,i,c)}async shareKeyWithOlmSessions(e,t,i,n){const s=this.splitDevices(n);for(let o=0;o<s.length;o++){const a=`megolm keys for ${e.sessionId} (slice ${o+1}/${s.length})`;try{this.prefixedLogger.debug(`Sharing ${a}`,s[o].map(c=>`${c.userId}/${c.deviceInfo.deviceId}`)),await this.encryptAndSendKeysToDevices(e,t.chain_index,s[o],i),this.prefixedLogger.debug(`Shared ${a}`)}catch(c){throw this.prefixedLogger.error(`Failed to share ${a}`),c}}}async notifyFailedOlmDevices(e,t,i){this.prefixedLogger.debug(`Notifying ${i.length} devices we failed to create Olm sessions`);for(const{userId:o,deviceInfo:a}of i){const c=a.deviceId;e.markSharedWithDevice(o,c,a.getIdentityKey(),t.chain_index)}const n=await this.olmDevice.filterOutNotifiedErrorDevices(i);this.prefixedLogger.debug(`Need to notify ${n.length} failed devices which haven't been notified before`);const s=new $e(()=>new Map);for(const{userId:o,deviceInfo:a}of n)s.getOrCreate(o).set(a.deviceId,{device:{code:"m.no_olm",reason:kr["m.no_olm"],deviceInfo:a}});await this.notifyBlockedDevices(e,s),this.prefixedLogger.debug(`Notified ${n.length} devices we failed to create Olm sessions`)}async notifyBlockedDevices(e,t){const i={room_id:this.roomId,session_id:e.sessionId,algorithm:dt,sender_key:this.olmDevice.deviceCurve25519Key},n=this.splitDevices(t);for(let s=0;s<n.length;s++)try{await this.sendBlockedNotificationsToDevices(e,n[s],i),this.prefixedLogger.debug(`Completed blacklist notification for ${e.sessionId} (slice ${s+1}/${n.length})`)}catch(o){throw this.prefixedLogger.debug(`blacklist notification for ${e.sessionId} (slice ${s+1}/${n.length}) failed`),o}}prepareToEncrypt(e){if(e.roomId!==this.roomId)throw new Error("MegolmEncryption.prepareToEncrypt called on unexpected room");if(this.encryptionPreparation!=null){const n=Date.now()-this.encryptionPreparation.startTime;return this.prefixedLogger.debug(`Already started preparing to encrypt for this room ${n}ms ago, skipping`),this.encryptionPreparation.cancel}this.prefixedLogger.debug("Preparing to encrypt events");let t=!1;const i=()=>t;return this.encryptionPreparation={startTime:Date.now(),promise:(async()=>{try{const n=await this.getDevicesInRoom(e,!1,i);if(n===null)return;const[s,o]=n;this.crypto.globalErrorOnUnknownDevices&&this.removeUnknownDevices(s),this.prefixedLogger.debug("Ensuring outbound megolm session"),await this.ensureOutboundSession(e,s,o,!0),this.prefixedLogger.debug("Ready to encrypt events")}catch(n){this.prefixedLogger.error("Failed to prepare to encrypt events",n)}finally{delete this.encryptionPreparation}})(),cancel:()=>{t=!0,delete this.encryptionPreparation}},this.encryptionPreparation.cancel}async encryptMessage(e,t,i){if(this.prefixedLogger.debug("Starting to encrypt event"),this.encryptionPreparation!=null)try{await this.encryptionPreparation.promise}catch{}const n=this.isVerificationEvent(t,i),[s,o]=await this.getDevicesInRoom(e,n);this.crypto.globalErrorOnUnknownDevices&&this.checkForUnknownDevices(s);const a=await this.ensureOutboundSession(e,s,o),c={room_id:this.roomId,type:t,content:i},l=this.olmDevice.encryptGroupMessage(a.sessionId,JSON.stringify(c)),u={algorithm:dt,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:l,session_id:a.sessionId,device_id:this.deviceId};return a.useCount++,u}isVerificationEvent(e,t){switch(e){case R.KeyVerificationCancel:case R.KeyVerificationDone:case R.KeyVerificationMac:case R.KeyVerificationStart:case R.KeyVerificationKey:case R.KeyVerificationReady:case R.KeyVerificationAccept:return!0;case R.RoomMessage:return t.msgtype===Jt.KeyVerificationRequest;default:return!1}}forceDiscardSession(){this.setupPromise=this.setupPromise.then(()=>null)}checkForUnknownDevices(e){const t=new $e(()=>new Map);for(const[i,n]of e)for(const[s,o]of n)o.isUnverified()&&!o.isKnown()&&t.getOrCreate(i).set(s,o);if(t.size)throw new Xv("This room contains unknown devices which have not been verified. We strongly recommend you verify them before continuing.",t)}removeUnknownDevices(e){for(const[t,i]of e){for(const[n,s]of i)s.isUnverified()&&!s.isKnown()&&i.delete(n);i.size===0&&e.delete(t)}}async getDevicesInRoom(e,t=!1,i){const n=await e.getEncryptionTargetMembers();this.prefixedLogger.debug(`Encrypting for users (shouldEncryptForInvitedMembers: ${e.shouldEncryptForInvitedMembers()}):`,n.map(u=>`${u.userId} (${u.membership})`));const s=n.map(function(u){return u.userId});let o=this.crypto.globalBlacklistUnverifiedDevices;const a=e.getBlacklistUnverifiedDevices();typeof a=="boolean"&&(o=a);const c=await this.crypto.downloadKeys(s,!1);if((i==null?void 0:i())===!0)return null;const l=new $e(()=>new Map);for(const[u,h]of c)for(const[f,g]of h){if(i!==void 0&&await Xh(),(i==null?void 0:i())===!0)return null;const m=this.crypto.checkDeviceTrust(u,f);if(g.isBlocked()||!m.isVerified()&&o&&!t){const v=l.getOrCreate(u),S=g.isBlocked();v.set(f,{code:S?"m.blacklisted":"m.unverified",reason:kr[S?"m.blacklisted":"m.unverified"],deviceInfo:g}),h.delete(f)}}return[c,l]}}class ay extends Pu{constructor(e){super(e),this.pendingEvents=new Map,this.olmlib=Av,this.roomId=e.roomId,this.prefixedLogger=d.getChild(`[${this.roomId} decryption]`)}async decryptEvent(e){const t=e.getWireContent();if(!t.sender_key||!t.session_id||!t.ciphertext)throw new Fe(Ne.MEGOLM_MISSING_FIELDS,"Missing fields in input");this.addEventToPendingList(e);let i;try{i=await this.olmDevice.decryptGroupMessage(e.getRoomId(),t.sender_key,t.session_id,t.ciphertext,e.getId(),e.getTs())}catch(s){if(s.name==="DecryptionError")throw s;let o=Ne.OLM_DECRYPT_GROUP_MESSAGE_ERROR;throw(s==null?void 0:s.message)==="OLM.UNKNOWN_MESSAGE_INDEX"&&(this.requestKeysForEvent(e),o=Ne.OLM_UNKNOWN_MESSAGE_INDEX),new Fe(o,s instanceof Error?s.message:"Unknown Error: Error is undefined",{session:t.sender_key+"|"+t.session_id})}if(i===null){this.crypto.backupManager.queryKeyBackupRateLimited(e.getRoomId(),t.session_id).catch(()=>{}),this.requestKeysForEvent(e);const s=await this.olmDevice.sessionMayHaveProblems(t.sender_key,e.getTs()-12e4);if(s){this.prefixedLogger.info(`When handling UISI from ${e.getSender()} (sender key ${t.sender_key}): recent session problem with that sender:`,s);let o=Ol[s.type]||Ol.unknown;throw s.fixed&&(o+=" Trying to create a new secure channel and re-requesting the keys."),new Fe(Ne.MEGOLM_UNKNOWN_INBOUND_SESSION_ID,o,{session:t.sender_key+"|"+t.session_id})}throw new Fe(Ne.MEGOLM_UNKNOWN_INBOUND_SESSION_ID,"The sender's device has not sent us the keys for this message.",{session:t.sender_key+"|"+t.session_id})}i.untrusted||this.removeEventFromPendingList(e);const n=JSON.parse(i.result);if(n.room_id!==e.getRoomId())throw new Fe(Ne.MEGOLM_BAD_ROOM,"Message intended for room "+n.room_id);return{clearEvent:n,senderCurve25519Key:i.senderKey,claimedEd25519Key:i.keysClaimed.ed25519,forwardingCurve25519KeyChain:i.forwardingCurve25519KeyChain,untrusted:i.untrusted}}requestKeysForEvent(e){const t=e.getWireContent(),i=e.getKeyRequestRecipients(this.userId);this.crypto.requestRoomKey({room_id:e.getRoomId(),algorithm:t.algorithm,sender_key:t.sender_key,session_id:t.session_id},i)}addEventToPendingList(e){var o;const t=e.getWireContent(),i=t.sender_key,n=t.session_id;this.pendingEvents.has(i)||this.pendingEvents.set(i,new Map);const s=this.pendingEvents.get(i);s.has(n)||s.set(n,new Set),(o=s.get(n))==null||o.add(e)}removeEventFromPendingList(e){const t=e.getWireContent(),i=t.sender_key,n=t.session_id,s=this.pendingEvents.get(i),o=s==null?void 0:s.get(n);o&&(o.delete(e),o.size===0&&s.delete(n),s.size===0&&this.pendingEvents.delete(i))}roomKeyFromEvent(e){const t=e.getSenderKey(),i=e.getContent(),n={};if(!i.room_id||!i.session_key||!i.session_id||!i.algorithm){this.prefixedLogger.error("key event is missing fields");return}if(!Xa(e)){this.prefixedLogger.error("key event not properly encrypted");return}return i["org.matrix.msc3061.shared_history"]&&(n.sharedHistory=!0),{senderKey:t,sessionId:i.session_id,sessionKey:i.session_key,extraSessionData:n,exportFormat:!1,roomId:i.room_id,algorithm:i.algorithm,forwardingKeyChain:[],keysClaimed:e.getKeysClaimed()}}forwardedRoomKeyFromEvent(e){const t=this.roomKeyFromEvent(e);if(!t)return;const i=e.getSenderKey(),n=e.getContent(),s=this.baseApis.crypto.deviceList.getUserByIdentityKey(Ge,i),o=n.sender_key,a=n.sender_claimed_ed25519_key;let c=Array.isArray(n.forwarding_curve25519_key_chain)?n.forwarding_curve25519_key_chain:[];if(c=c.slice(),c.push(i),s!==e.getSender()){this.prefixedLogger.error("sending device does not belong to the user it claims to be from");return}if(!o){this.prefixedLogger.error("forwarded_room_key event is missing sender_key field");return}if(!a){this.prefixedLogger.error("forwarded_room_key_event is missing sender_claimed_ed25519_key field");return}const l={ed25519:a};return t.senderKey=o,t.keysClaimed=l,t.exportFormat=!0,t.forwardingKeyChain=c,t.extraSessionData.untrusted=!0,t}async shouldAcceptForwardedKey(e,t){const i=e.getSenderKey(),n=this.crypto.deviceList.getDeviceByIdentityKey(Ge,i)??void 0,s=this.crypto.checkDeviceInfoTrust(e.getSender(),n),o=e.getSender()===this.baseApis.getUserId(),a=s.isVerified()&&o,c=await this.wasRoomKeyRequested(e,t),l=this.wasRoomKeyForwardedByInviter(e,t),u=this.wasRoomKeyForwardedAsHistory(t);return c&&a||l&&u}async wasRoomKeyRequested(e,t){return(await this.crypto.cryptoStore.getOutgoingRoomKeyRequestsByTarget(e.getSender(),"*",[Uu.Sent])).some(n=>n.requestBody.room_id===t.roomId&&n.requestBody.session_id===t.sessionId)}wasRoomKeyForwardedByInviter(e,t){var c,l,u;const i=this.baseApis.getRoom(t.roomId),n=e.getSenderKey();if(!n)return!1;const s=this.crypto.deviceList.getUserByIdentityKey(Ge,n);if(!s)return!1;const o=(c=i==null?void 0:i.getMember(this.userId))==null?void 0:c.events.member,a=(o==null?void 0:o.getSender())===s||((l=o==null?void 0:o.getUnsigned())==null?void 0:l.prev_sender)===s&&((u=o==null?void 0:o.getPrevContent())==null?void 0:u.membership)===ae.Invite;return!!(i&&a)}wasRoomKeyForwardedAsHistory(e){return!!(this.baseApis.getRoom(e.roomId)&&e.extraSessionData.sharedHistory)}shouldParkForwardedKey(e){return!!(!this.baseApis.getRoom(e.roomId)&&e.extraSessionData.sharedHistory)}async parkForwardedKey(e,t){const i={senderId:e.getSender(),senderKey:t.senderKey,sessionId:t.sessionId,sessionKey:t.sessionKey,keysClaimed:t.keysClaimed,forwardingCurve25519KeyChain:t.forwardingKeyChain};await this.crypto.cryptoStore.doTxn("readwrite",["parked_shared_history"],n=>this.crypto.cryptoStore.addParkedSharedHistory(t.roomId,i,n),d.getChild("[addParkedSharedHistory]"))}async addRoomKey(e){try{await this.olmDevice.addInboundGroupSession(e.roomId,e.senderKey,e.forwardingKeyChain,e.sessionId,e.sessionKey,e.keysClaimed,e.exportFormat,e.extraSessionData),await this.retryDecryption(e.senderKey,e.sessionId,!e.extraSessionData.untrusted)&&this.crypto.cancelRoomKeyRequest({algorithm:e.algorithm,room_id:e.roomId,session_id:e.sessionId,sender_key:e.senderKey}),await this.crypto.backupManager.backupGroupSession(e.senderKey,e.sessionId)}catch(t){this.prefixedLogger.error(`Error handling m.room_key_event: ${t}`)}}async onForwardedRoomKey(e){const t=this.forwardedRoomKeyFromEvent(e);t&&(await this.shouldAcceptForwardedKey(e,t)?await this.addRoomKey(t):this.shouldParkForwardedKey(t)&&await this.parkForwardedKey(e,t))}async onRoomKeyEvent(e){if(e.getType()=="m.forwarded_room_key")await this.onForwardedRoomKey(e);else{const t=this.roomKeyFromEvent(e);if(!t)return;await this.addRoomKey(t)}}async onRoomKeyWithheldEvent(e){const t=e.getContent(),i=t.sender_key;t.code==="m.no_olm"?await this.onNoOlmWithheldEvent(e):t.code==="m.unavailable"||await this.olmDevice.addInboundGroupSessionWithheld(t.room_id,i,t.session_id,t.code,t.reason),t.session_id?await this.retryDecryption(i,t.session_id):await this.retryDecryptionFromSender(i)}async onNoOlmWithheldEvent(e){const t=e.getContent(),i=t.sender_key,n=e.getSender();if(this.prefixedLogger.warn(`${n}:${i} was unable to establish an olm session with us`),await this.olmDevice.getSessionIdForDevice(i)){this.prefixedLogger.debug("New session already created.  Not creating a new one."),await this.olmDevice.recordSessionProblem(i,"no_olm",!0);return}let s=this.crypto.deviceList.getDeviceByIdentityKey(t.algorithm,i);if(!s&&(await this.crypto.downloadKeys([n],!1),s=this.crypto.deviceList.getDeviceByIdentityKey(t.algorithm,i),!s)){this.prefixedLogger.info("Couldn't find device for identity key "+i+": not establishing session"),await this.olmDevice.recordSessionProblem(i,"no_olm",!1);return}await di(this.olmDevice,this.baseApis,new Map([[n,[s]]]),!1);const o={algorithm:Ge,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[ut]:Kt()};await Ai(o.ciphertext,this.userId,void 0,this.olmDevice,n,s,{type:"m.dummy"}),await this.olmDevice.recordSessionProblem(i,"no_olm",!0),await this.baseApis.sendToDevice("m.room.encrypted",new Map([[n,new Map([[s.deviceId,o]])]]))}hasKeysForKeyRequest(e){const t=e.requestBody;return this.olmDevice.hasInboundSessionKeys(t.room_id,t.sender_key,t.session_id)}shareKeysWithDevice(e){const t=e.userId,i=e.deviceId,n=this.crypto.getStoredDevice(t,i),s=e.requestBody;this.olmlib.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,new Map([[t,[n]]])).then(o=>{var c;const a=(c=o.get(t))==null?void 0:c.get(i);return a!=null&&a.sessionId?(this.prefixedLogger.debug("sharing keys for session "+s.sender_key+"|"+s.session_id+" with device "+t+":"+i),this.buildKeyForwardingMessage(s.room_id,s.sender_key,s.session_id)):null}).then(o=>{const a={algorithm:Ge,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[ut]:Kt()};return this.olmlib.encryptMessageForDevice(a.ciphertext,this.userId,void 0,this.olmDevice,t,n,o).then(()=>this.baseApis.sendToDevice("m.room.encrypted",new Map([[t,new Map([[i,a]])]])))})}async buildKeyForwardingMessage(e,t,i){const n=await this.olmDevice.getInboundGroupSessionKey(e,t,i);return{type:"m.forwarded_room_key",content:{algorithm:dt,room_id:e,sender_key:t,sender_claimed_ed25519_key:n.sender_claimed_ed25519_key,session_id:i,session_key:n.key,chain_index:n.chain_index,forwarding_curve25519_key_chain:n.forwarding_curve25519_key_chain,"org.matrix.msc3061.shared_history":n.shared_history||!1}}}importRoomKey(e,{untrusted:t,source:i}={}){const n={};return(t||e.untrusted)&&(n.untrusted=!0),e["org.matrix.msc3061.shared_history"]&&(n.sharedHistory=!0),this.olmDevice.addInboundGroupSession(e.room_id,e.sender_key,e.forwarding_curve25519_key_chain,e.session_id,e.session_key,e.sender_claimed_keys,!0,n).then(()=>{i!=="backup"&&this.crypto.backupManager.backupGroupSession(e.sender_key,e.session_id).catch(s=>{this.prefixedLogger.debug("Failed to back up megolm session",s)}),this.retryDecryption(e.sender_key,e.session_id,!n.untrusted)})}async retryDecryption(e,t,i){var a;const n=this.pendingEvents.get(e);if(!n)return!0;const s=n.get(t);if(!s)return!0;const o=[...s];return this.prefixedLogger.debug("Retrying decryption on events:",o.map(c=>`${c.getId()}`)),await Promise.all(o.map(async c=>{try{await c.attemptDecryption(this.crypto,{isRetry:!0,forceRedecryptIfUntrusted:i})}catch{}})),!((a=this.pendingEvents.get(e))!=null&&a.has(t))}async retryDecryptionFromSender(e){const t=this.pendingEvents.get(e);return t?(this.pendingEvents.delete(e),await Promise.all([...t].map(async([i,n])=>{await Promise.all([...n].map(async s=>{try{await s.attemptDecryption(this.crypto)}catch{}}))})),!this.pendingEvents.has(e)):!0}async sendSharedHistoryInboundSessions(e){await di(this.olmDevice,this.baseApis,e);const t=await this.olmDevice.getSharedHistoryInboundGroupSessions(this.roomId);this.prefixedLogger.debug(`Sharing history in with users ${Array.from(e.keys())}`,t.map(([i,n])=>`${i}|${n}`));for(const[i,n]of t){const s=await this.buildKeyForwardingMessage(this.roomId,i,n),o=[],a=new Map;for(const[c,l]of e){const u=new Map;a.set(c,u);for(const h of l){const f={algorithm:Ge,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[ut]:Kt()};u.set(h.deviceId,f),o.push(Ai(f.ciphertext,this.userId,void 0,this.olmDevice,c,h,s))}}await Promise.all(o);for(const[c,l]of a){for(const[u,h]of l)ry(h)||(this.prefixedLogger.debug("No ciphertext for device "+c+":"+u+": pruning"),l.delete(u));l.size===0&&(this.prefixedLogger.debug("Pruned all devices for user "+c),a.delete(c))}if(a.size===0){this.prefixedLogger.debug("No users left to send to: aborting");return}await this.baseApis.sendToDevice("m.room.encrypted",a)}}}const Ol={no_olm:"The sender was unable to establish a secure channel.",unknown:"The secure channel with the sender was corrupted."};Du(dt,oy,ay);class Ml{constructor(e,t){this.accountDataClientAdapter=new ly(e),this.crossSigningCallbacks=new dy,this.ssssCryptoCallbacks=new uy(t)}addCrossSigningKeys(e,t){this.crossSigningKeys={authUpload:e,keys:t}}addSessionBackup(e){this.keyBackupInfo=e}addSessionBackupPrivateKeyToCache(e){this.sessionBackupPrivateKey=e}addKeySignature(e,t,i){this.keySignatures||(this.keySignatures={});const n=this.keySignatures[e]||{};this.keySignatures[e]=n,n[t]=i}async setAccountData(e,t){await this.accountDataClientAdapter.setAccountData(e,t)}buildOperation(){const e=this.accountDataClientAdapter.values;return new cy(e,this.crossSigningKeys,this.keyBackupInfo,this.keySignatures)}async persist(e){var t;if(this.crossSigningKeys){const i=Ou(e.cryptoStore,e.olmDevice);for(const n of["master","self_signing","user_signing"]){d.log(`Cache ${n} cross-signing private key locally`);const s=this.crossSigningCallbacks.privateKeys.get(n);await((t=i.storeCrossSigningKeyCache)==null?void 0:t.call(i,n,s))}await e.cryptoStore.doTxn("readwrite",[z.STORE_ACCOUNT],n=>{e.cryptoStore.storeCrossSigningKeys(n,this.crossSigningKeys.keys)})}this.sessionBackupPrivateKey&&await e.storeSessionBackupPrivateKey(this.sessionBackupPrivateKey)}}class cy{constructor(e,t,i,n){this.accountData=e,this.crossSigningKeys=t,this.keyBackupInfo=i,this.keySignatures=n}async apply(e){var i,n;const t=e.baseApis;if(this.crossSigningKeys){const s={};for(const[o,a]of Object.entries(this.crossSigningKeys.keys))s[o+"_key"]=a;await((n=(i=this.crossSigningKeys).authUpload)==null?void 0:n.call(i,o=>t.uploadDeviceSigningKeys(o??void 0,s))),e.crossSigningInfo.setKeys(this.crossSigningKeys.keys)}if(this.accountData)for(const[s,o]of this.accountData)await t.setAccountData(s,o);this.keySignatures&&await t.uploadKeySignatures(this.keySignatures),this.keyBackupInfo&&(this.keyBackupInfo.version?await t.http.authedRequest(D.Put,"/room_keys/version/"+this.keyBackupInfo.version,void 0,{algorithm:this.keyBackupInfo.algorithm,auth_data:this.keyBackupInfo.auth_data},{prefix:Pe.V3}):await t.http.authedRequest(D.Post,"/room_keys/version",void 0,this.keyBackupInfo,{prefix:Pe.V3}),await e.backupManager.checkKeyBackup())}}class ly extends ke{constructor(e){super(),this.existingValues=e,this.values=new Map}getAccountDataFromServer(e){return Promise.resolve(this.getAccountData(e))}getAccountData(e){const t=this.values.get(e);if(t)return t;const i=this.existingValues.get(e);return i?i.getContent():null}setAccountData(e,t){const i=this.values.get(e);return this.values.set(e,t),Promise.resolve().then(()=>{const n=new it({type:e,content:t});return this.emit(ie.AccountData,n,i),{}})}}class dy{constructor(){this.privateKeys=new Map}getCrossSigningKeyCache(e,t){return this.getCrossSigningKey(e,t)}storeCrossSigningKeyCache(e,t){return this.privateKeys.set(e,t),Promise.resolve()}getCrossSigningKey(e,t){return Promise.resolve(this.privateKeys.get(e)??null)}saveCrossSigningKeys(e){for(const[t,i]of Object.entries(e))this.privateKeys.set(t,i)}}class uy{constructor(e){this.delegateCryptoCallbacks=e,this.privateKeys=new Map}async getSecretStorageKey({keys:e},t){var i;for(const n of Object.keys(e)){const s=this.privateKeys.get(n);if(s)return[n,s]}if((i=this==null?void 0:this.delegateCryptoCallbacks)!=null&&i.getSecretStorageKey){const n=await this.delegateCryptoCallbacks.getSecretStorageKey({keys:e},t);if(n){const[s,o]=n;this.privateKeys.set(s,o)}return n}return null}addPrivateKey(e,t,i){var n,s;this.privateKeys.set(e,i),(s=(n=this.delegateCryptoCallbacks)==null?void 0:n.cacheSecretStorageKey)==null||s.call(n,e,t,i)}}const si="m.secret_storage.v1.aes-hmac-sha2";class Ns{constructor(e,t){this.accountDataAdapter=e,this.callbacks=t}async getDefaultKeyId(){const e=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.default_key");return e?e.key:null}setDefaultKeyId(e){return new Promise((t,i)=>{const n=s=>{s.getType()==="m.secret_storage.default_key"&&s.getContent().key===e&&(this.accountDataAdapter.removeListener(ie.AccountData,n),t())};this.accountDataAdapter.on(ie.AccountData,n),this.accountDataAdapter.setAccountData("m.secret_storage.default_key",{key:e}).catch(s=>{this.accountDataAdapter.removeListener(ie.AccountData,n),i(s)})})}async addKey(e,t,i){if(e!==si)throw new Error(`Unknown key algorithm ${e}`);const n={algorithm:e};t.name&&(n.name=t.name),t.passphrase&&(n.passphrase=t.passphrase);const{iv:s,mac:o}=await kn(t.key);if(n.iv=s,n.mac=o,!i)do i=rn(32);while(await this.accountDataAdapter.getAccountDataFromServer(`m.secret_storage.key.${i}`));return await this.accountDataAdapter.setAccountData(`m.secret_storage.key.${i}`,n),{keyId:i,keyInfo:n}}async getKey(e){if(e||(e=await this.getDefaultKeyId()),!e)return null;const t=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+e);return t?[e,t]:null}async hasKey(e){return!!await this.getKey(e)}async checkKey(e,t){if(t.algorithm===si)if(t.mac){const{mac:i}=await kn(e,t.iv);return Al(t.mac)===Al(i)}else return!0;else throw new Error("Unknown algorithm")}async store(e,t,i){const n={};if(!i){const s=await this.getDefaultKeyId();if(!s)throw new Error("No keys specified and no default key present");i=[s]}if(i.length===0)throw new Error("Zero keys given to encrypt with!");for(const s of i){const o=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+s);if(!o)throw new Error("Unknown key: "+s);if(o.algorithm===si){const a={[s]:o},[,c]=await this.getSecretStorageKey(a,e);n[s]=await c.encrypt(t)}else d.warn("unknown algorithm for secret storage key "+s+": "+o.algorithm)}await this.accountDataAdapter.setAccountData(e,{encrypted:n})}async get(e){const t=await this.accountDataAdapter.getAccountDataFromServer(e);if(!t)return;if(!t.encrypted)throw new Error("Content is not encrypted!");const i={};for(const a of Object.keys(t.encrypted)){const c=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+a),l=t.encrypted[a];(c==null?void 0:c.algorithm)===si&&l.iv&&l.ciphertext&&l.mac&&(i[a]=c)}if(Object.keys(i).length===0)throw new Error(`Could not decrypt ${e} because none of the keys it is encrypted with are for a supported algorithm`);const[n,s]=await this.getSecretStorageKey(i,e),o=t.encrypted[n];return s.decrypt(o)}async isStored(e){const t=await this.accountDataAdapter.getAccountDataFromServer(e);if(!(t!=null&&t.encrypted))return null;const i={};for(const n of Object.keys(t.encrypted)){const s=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+n);if(!s)continue;const o=t.encrypted[n];s.algorithm===si&&o.iv&&o.ciphertext&&o.mac&&(i[n]=s)}return Object.keys(i).length?i:null}async getSecretStorageKey(e,t){if(!this.callbacks.getSecretStorageKey)throw new Error("No getSecretStorageKey callback supplied");const i=await this.callbacks.getSecretStorageKey({keys:e},t);if(!i)throw new Error("getSecretStorageKey callback returned falsey");if(i.length<2)throw new Error("getSecretStorageKey callback returned invalid data");const[n,s]=i;if(!e[n])throw new Error("App returned unknown key from getSecretStorageKey!");if(e[n].algorithm===si)return[n,{encrypt:function(a){return Vn(a,s,t)},decrypt:function(a){return jr(a,s,t)}}];throw new Error("Unknown key type: "+e[n].algorithm)}}function Al(r){let e=r.length;for(;e>=1&&r.charCodeAt(e-1)==61;)e--;return e<r.length?r.substring(0,e):r}class hy{constructor(e,t){this.baseApis=e,this.cryptoCallbacks=t,this.requests=new Map}request(e,t){const i=this.baseApis.makeTxnId(),n=Nn();this.requests.set(i,{name:e,devices:t,deferred:n});const s=c=>{const l={action:"request_cancellation",requesting_device_id:this.baseApis.deviceId,request_id:i},u=new Map;for(const h of t)u.set(h,l);this.baseApis.sendToDevice("m.secret.request",new Map([[this.baseApis.getUserId(),u]])),n.reject(new Error(c||"Cancelled"))},o={name:e,action:"request",requesting_device_id:this.baseApis.deviceId,request_id:i,[ut]:Kt()},a=new Map;for(const c of t)a.set(c,o);return d.info(`Request secret ${e} from ${t}, id ${i}`),this.baseApis.sendToDevice("m.secret.request",new Map([[this.baseApis.getUserId(),a]])),{requestId:i,promise:n.promise,cancel:s}}async onRequestReceived(e){const t=e.getSender(),i=e.getContent();if(t!==this.baseApis.getUserId()||!(i.name&&i.action&&i.requesting_device_id&&i.request_id))return;const n=i.requesting_device_id;if(i.action!=="request_cancellation"){if(i.action==="request"){if(n===this.baseApis.deviceId||(d.info("received request for secret ("+t+", "+n+", "+i.request_id+")"),!this.cryptoCallbacks.onSecretRequested))return;const s=await this.cryptoCallbacks.onSecretRequested(t,n,i.request_id,i.name,this.baseApis.checkDeviceTrust(t,n));if(s){d.info(`Preparing ${i.name} secret for ${n}`);const o={type:"m.secret.send",content:{request_id:i.request_id,secret:s}},a={algorithm:Ge,sender_key:this.baseApis.crypto.olmDevice.deviceCurve25519Key,ciphertext:{},[ut]:Kt()};await di(this.baseApis.crypto.olmDevice,this.baseApis,new Map([[t,[this.baseApis.getStoredDevice(t,n)]]])),await Ai(a.ciphertext,this.baseApis.getUserId(),this.baseApis.deviceId,this.baseApis.crypto.olmDevice,t,this.baseApis.getStoredDevice(t,n),o);const c=new Map([[t,new Map([[n,a]])]]);d.info(`Sending ${i.name} secret for ${n}`),this.baseApis.sendToDevice("m.room.encrypted",c)}else d.info(`Request denied for ${i.name} secret for ${n}`)}}}onSecretReceived(e){if(e.getSender()!==this.baseApis.getUserId())return;if(!Xa(e)){d.error("secret event not properly encrypted");return}const t=e.getContent();if(this.baseApis.crypto.deviceList.getUserByIdentityKey(Ge,e.getSenderKey()||"")!==e.getSender()){d.error("sending device does not belong to the user it claims to be from");return}d.log("got secret share for request",t.request_id);const n=this.requests.get(t.request_id);if(n){const s=this.baseApis.crypto.deviceList.getDeviceByIdentityKey(Ge,e.getSenderKey());if(!s){d.log("secret share from unknown device with key",e.getSenderKey());return}if(!n.devices.includes(s.deviceId)){d.log("unsolicited secret share from device",s.deviceId);return}if(!this.baseApis.crypto.checkDeviceInfoTrust(e.getSender(),s).isVerified()){d.log("secret share from unverified device");return}d.log(`Successfully received secret ${n.name} from ${s.deviceId}`),n.deferred.resolve(t.secret)}}}class fy{constructor(e,t,i){this.storageImpl=new Ns(e,t),this.sharingImpl=new hy(i,t)}getDefaultKeyId(){return this.storageImpl.getDefaultKeyId()}setDefaultKeyId(e){return this.storageImpl.setDefaultKeyId(e)}addKey(e,t,i){return this.storageImpl.addKey(e,t,i)}getKey(e){return this.storageImpl.getKey(e)}hasKey(e){return this.storageImpl.hasKey(e)}checkKey(e,t){return this.storageImpl.checkKey(e,t)}store(e,t,i){return this.storageImpl.store(e,t,i)}get(e){return this.storageImpl.get(e)}async isStored(e){return this.storageImpl.isStored(e)}request(e,t){return this.sharingImpl.request(e,t)}onRequestReceived(e){return this.sharingImpl.onRequestReceived(e)}onSecretReceived(e){this.sharingImpl.onSecretReceived(e)}}function gy(r,e,t){const i=Object.assign({},{code:r,reason:e},t);return new it({type:R.KeyVerificationCancel,content:i})}function gi(r,e){return function(t){return gy(r,e,t)}}const Nu=gi("m.user","Cancelled by user"),py=gi("m.timeout","Timed out"),Er=gi("m.unknown_method","Unknown method"),Ku=gi("m.unexpected_message","Unexpected message"),Gi=gi("m.key_mismatch","Key mismatch"),my=gi("m.invalid_message","Invalid message");function Oa(r){const e=r.getContent();if(e){const{code:t,reason:i}=e;return{code:t,reason:i}}else return{code:"Unknown error",reason:"m.unknown"}}const Pl=new Error("Verification timed out");class Ma extends Error{constructor(e){super(),this.startEvent=e}}const vy=io;class tc extends ke{constructor(e,t,i,n,s,o){super(),this.channel=e,this.baseApis=t,this.userId=i,this.deviceId=n,this.startEvent=s,this.request=o,this.cancelled=!1,this._done=!1,this.promise=null,this.transactionTimeoutTimer=null}get initiatedByMe(){if(!this.startEvent)return!0;const e=this.startEvent.getSender(),t=this.startEvent.getContent();return e===this.baseApis.getUserId()&&t.from_device===this.baseApis.getDeviceId()}get hasBeenCancelled(){return this.cancelled}resetTimer(){d.info("Refreshing/starting the verification transaction timeout timer"),this.transactionTimeoutTimer!==null&&clearTimeout(this.transactionTimeoutTimer),this.transactionTimeoutTimer=setTimeout(()=>{!this._done&&!this.cancelled&&(d.info("Triggering verification timeout"),this.cancel(Pl))},10*60*1e3)}endTimer(){this.transactionTimeoutTimer!==null&&(clearTimeout(this.transactionTimeoutTimer),this.transactionTimeoutTimer=null)}send(e,t){return this.channel.send(e,t)}waitForEvent(e){if(this._done)return Promise.reject(new Error("Verification is already done"));const t=this.request.getEventFromOtherParty(e);return t?Promise.resolve(t):(this.expectedEvent=e,new Promise((i,n)=>{this.resolveEvent=i,this.rejectEvent=n}))}canSwitchStartEvent(e){return!1}switchStartEvent(e){if(this.canSwitchStartEvent(e))if(d.log("Verification Base: switching verification start event",{restartingFlow:!!this.rejectEvent}),this.rejectEvent){const t=this.rejectEvent;this.rejectEvent=void 0,t(new Ma(e))}else this.startEvent=e}handleEvent(e){var t;if(!this._done){if(e.getType()===this.expectedEvent)this.expectedEvent!==R.KeyVerificationDone&&(this.expectedEvent=void 0,this.rejectEvent=void 0,this.resetTimer(),(t=this.resolveEvent)==null||t.call(this,e));else if(e.getType()===R.KeyVerificationCancel){const i=this.reject;if(this.reject=void 0,i){const n=e.getContent(),{reason:s,code:o}=n;i(new Error(`Other side cancelled verification because ${s} (${o})`))}}else if(this.expectedEvent){const i=new Error("Unexpected message: expecting "+this.expectedEvent+" but got "+e.getType());if(this.expectedEvent=void 0,this.rejectEvent){const n=this.rejectEvent;this.rejectEvent=void 0,n(i)}this.cancel(i)}}}async done(){var e;if(this.endTimer(),!this._done)return this.request.onVerifierFinished(),(e=this.resolve)==null||e.call(this),Hv(this.baseApis,this.userId,this.deviceId)}cancel(e){if(this.endTimer(),!this._done){if(this.cancelled=!0,this.request.onVerifierCancelled(),this.userId&&this.deviceId)if(e===Pl){const t=py();this.send(t.getType(),t.getContent())}else if(e instanceof it){if(e.getSender()!==this.userId){const i=e.getContent();e.getType()===R.KeyVerificationCancel?(i.code=i.code||"m.unknown",i.reason=i.reason||i.body||"Unknown reason",this.send(R.KeyVerificationCancel,i)):this.send(R.KeyVerificationCancel,{code:"m.unknown",reason:i.body||"Unknown reason"})}}else this.send(R.KeyVerificationCancel,{code:"m.unknown",reason:e.toString()});this.promise!==null?this.reject&&this.reject(e):this.promise=Promise.reject(e),this.emit(vy.Cancel,e)}}verify(){return this.promise?this.promise:(this.promise=new Promise((e,t)=>{this.resolve=(...i)=>{this._done=!0,this.endTimer(),e(...i)},this.reject=i=>{this._done=!0,this.endTimer(),t(i)}}),this.doVerification&&!this.started&&(this.started=!0,this.resetTimer(),new Promise((e,t)=>{var n;((n=this.baseApis.crypto.deviceList.getStoredCrossSigningForUser(this.userId))==null?void 0:n.getId())===this.deviceId&&t(new Error("Device ID is the same as the cross-signing ID")),e()}).then(()=>this.doVerification()).then(this.done.bind(this),this.cancel.bind(this))),this.promise)}async verifyKeys(e,t,i){const n=[];for(const[s,o]of Object.entries(t)){const a=s.split(":",2)[1],c=this.baseApis.getStoredDevice(e,a);if(c)i(s,c,o),n.push([a,s,c.keys[s]]);else{const l=this.baseApis.crypto.deviceList.getStoredCrossSigningForUser(e);l&&l.getId()===a?(i(s,ht.fromStorage({keys:{[s]:a}},a),o),n.push([a,s,a])):d.warn(`verification: Could not find device ${a} to verify`)}}if(!n.length)throw new Error("No devices could be verified");d.info("Verification completed! Marking devices verified: ",n);for(const[s,o,a]of n)await this.baseApis.crypto.setDeviceVerification(e,s,!0,null,null,{[o]:a});e==this.baseApis.credentials.userId&&await this.baseApis.checkKeyBackup()}get events(){}getShowSasCallbacks(){return null}getReciprocateQrCodeCallbacks(){return null}}var no=(r=>(r.Sas="m.sas.v1",r.ShowQrCode="m.qr_code.show.v1",r.ScanQrCode="m.qr_code.scan.v1",r.Reciprocate="m.reciprocate.v1",r))(no||{});const yy=no.ShowQrCode,Fu=no.ScanQrCode,Sy=io;class Or extends tc{constructor(){super(...arguments),this.doVerification=async()=>{if(!this.startEvent)throw new Error("It is not currently possible to start verificationwith this method yet.");const{qrCodeData:e}=this.request;if(this.startEvent.getContent().secret!==(e==null?void 0:e.encodedSharedSecret))throw Gi();await new Promise((i,n)=>{this.reciprocateQREvent={confirm:i,cancel:()=>n(Nu())},this.emit(Sy.ShowReciprocateQr,this.reciprocateQREvent)});const t={};switch(e==null?void 0:e.mode){case 0:{const i=e.otherUserMasterKey;t[`ed25519:${i}`]=i;break}case 1:{const i=this.request.targetDevice.deviceId;t[`ed25519:${i}`]=e.otherDeviceKey;break}case 2:{const i=e.myMasterKey;t[`ed25519:${i}`]=i;break}}await this.verifyKeys(this.userId,t,(i,n,s)=>{const o=t[i];if(!o)throw Gi();if(s!==o)throw d.error("key ID from key info does not match"),Gi();for(const a in n.keys){if(!a.startsWith("ed25519"))continue;const c=t[a];if(!c)throw Gi();if(n.keys[a]!==c)throw d.error("master key does not match"),Gi()}})}}static factory(e,t,i,n,s,o){return new Or(e,t,i,n,s,o)}static get NAME(){return"m.reciprocate.v1"}getReciprocateQrCodeCallbacks(){return this.reciprocateQREvent??null}}const Ey=2,by="MATRIX";class Ii{constructor(e,t,i,n,s,o){this.mode=e,this.sharedSecret=t,this.otherUserMasterKey=i,this.otherDeviceKey=n,this.myMasterKey=s,this.buffer=o}static async create(e,t){const i=Ii.generateSharedSecret(),n=Ii.determineMode(e,t);let s=null,o=null,a=null;if(n===0)s=t.getStoredCrossSigningForUser(e.otherUserId).getId("master");else if(n===1)o=await Ii.getOtherDeviceKey(e,t);else if(n===2){const u=t.getUserId();a=t.getStoredCrossSigningForUser(u).getId("master")}const c=Ii.generateQrData(e,t,n,i,s,o,a),l=Ii.generateBuffer(c);return new Ii(n,i,s,o,a,l)}get encodedSharedSecret(){return this.sharedSecret}getBuffer(){return this.buffer}static generateSharedSecret(){const e=new Uint8Array(11);return rt.getRandomValues(e),Ha(e)}static async getOtherDeviceKey(e,t){const i=t.getUserId(),n=e.targetDevice,s=n.deviceId?t.getStoredDevice(i,n.deviceId):void 0;if(!s)throw new Error("could not find device "+(n==null?void 0:n.deviceId));return s.getFingerprint()}static determineMode(e,t){const i=t.getUserId(),n=e.otherUserId;let s=0;return i===n&&(t.checkUserTrust(i).isCrossSigningVerified()?s=1:s=2),s}static generateQrData(e,t,i,n,s,o,a){const c=t.getUserId(),l=e.channel.transactionId,u={prefix:by,version:Ey,mode:i,transactionId:l,firstKeyB64:"",secondKeyB64:"",secretB64:n},h=t.getStoredCrossSigningForUser(c);return i===0?(u.firstKeyB64=h.getId("master"),u.secondKeyB64=s):i===1?(u.firstKeyB64=h.getId("master"),u.secondKeyB64=o):i===2&&(u.firstKeyB64=t.getDeviceEd25519Key(),u.secondKeyB64=a),u}static generateBuffer(e){let t=Buffer.alloc(0);const i=a=>{const c=Buffer.from([a]);t=Buffer.concat([t,c])},n=a=>{const c=Buffer.alloc(2);c.writeInt16BE(a,0),t=Buffer.concat([t,c])},s=(a,c,l=!0)=>{const u=Buffer.from(a,c);l&&n(u.byteLength),t=Buffer.concat([t,u])},o=a=>{const c=tt(a),l=Buffer.from(c);t=Buffer.concat([t,l])};return s(e.prefix,"ascii",!1),i(e.version),i(e.mode),s(e.transactionId,"utf-8"),o(e.firstKeyB64),o(e.secondKeyB64),o(e.secretB64),t}}function wy(r){return[(r[0]<<5|r[1]>>3)+1e3,((r[1]&7)<<10|r[2]<<2|r[3]>>6)+1e3,((r[3]&63)<<7|r[4]>>1)+1e3]}var ss={};const Oo=R.KeyVerificationStart,_y=[R.KeyVerificationAccept,R.KeyVerificationKey,R.KeyVerificationMac];let os;const Iy=gi("m.mismatched_sas","Mismatched short authentication string"),Ry=gi("m.mismatched_commitment","Mismatched commitment"),Ty=[["🐶","dog"],["🐱","cat"],["🦁","lion"],["🐎","horse"],["🦄","unicorn"],["🐷","pig"],["🐘","elephant"],["🐰","rabbit"],["🐼","panda"],["🐓","rooster"],["🐧","penguin"],["🐢","turtle"],["🐟","fish"],["🐙","octopus"],["🦋","butterfly"],["🌷","flower"],["🌳","tree"],["🌵","cactus"],["🍄","mushroom"],["🌏","globe"],["🌙","moon"],["☁️","cloud"],["🔥","fire"],["🍌","banana"],["🍎","apple"],["🍓","strawberry"],["🌽","corn"],["🍕","pizza"],["🎂","cake"],["❤️","heart"],["😀","smiley"],["🤖","robot"],["🎩","hat"],["👓","glasses"],["🔧","spanner"],["🎅","santa"],["👍","thumbs up"],["☂️","umbrella"],["⌛","hourglass"],["⏰","clock"],["🎁","gift"],["💡","light bulb"],["📕","book"],["✏️","pencil"],["📎","paperclip"],["✂️","scissors"],["🔒","lock"],["🔑","key"],["🔨","hammer"],["☎️","telephone"],["🏁","flag"],["🚂","train"],["🚲","bicycle"],["✈️","aeroplane"],["🚀","rocket"],["🏆","trophy"],["⚽","ball"],["🎸","guitar"],["🎺","trumpet"],["🔔","bell"],["⚓","anchor"],["🎧","headphones"],["📁","folder"],["📌","pin"]];function Cy(r){return[r[0]>>2,(r[0]&3)<<4|r[1]>>4,(r[1]&15)<<2|r[2]>>6,r[2]&63,r[3]>>2,(r[3]&3)<<4|r[4]>>4,(r[4]&15)<<2|r[5]>>6].map(t=>Ty[t])}const Aa={decimal:wy,emoji:Cy};function ky(r,e){const t={};for(const i of e)i in Aa&&(t[i]=Aa[i](Array.from(r)));return t}const Oy={"hkdf-hmac-sha256":"calculate_mac","org.matrix.msc3783.hkdf-hmac-sha256":"calculate_mac_fixed_base64","hkdf-hmac-sha256.v2":"calculate_mac_fixed_base64","hmac-sha256":"calculate_mac_long_kdf"};function ir(r,e){return function(t,i){const n=r[Oy[e]](t,i);return d.log("SAS calculateMAC:",e,[t,i],n),n}}const My={"curve25519-hkdf-sha256":function(r,e,t){const i=`${r.baseApis.getUserId()}|${r.baseApis.deviceId}|${r.ourSASPubKey}|`,n=`${r.userId}|${r.deviceId}|${r.theirSASPubKey}|`,s="MATRIX_KEY_VERIFICATION_SAS|"+(r.initiatedByMe?i+n:n+i)+r.channel.transactionId;return e.generate_bytes(s,t)},curve25519:function(r,e,t){const i=`${r.baseApis.getUserId()}${r.baseApis.deviceId}`,n=`${r.userId}${r.deviceId}`,s="MATRIX_KEY_VERIFICATION_SAS"+(r.initiatedByMe?i+n:n+i)+r.channel.transactionId;return e.generate_bytes(s,t)}},Pa=["curve25519-hkdf-sha256","curve25519"],Da=["sha256"],Ua=["hkdf-hmac-sha256.v2","org.matrix.msc3783.hkdf-hmac-sha256","hkdf-hmac-sha256","hmac-sha256"],$u=Object.keys(Aa),Ay=new Set(Pa),Py=new Set(Da),Dy=new Set(Ua),Dl=new Set($u);function nr(r,e){return Array.isArray(r)?r.filter(t=>e.has(t)):[]}const Uy=io;class Un extends tc{constructor(){super(...arguments),this.doVerification=async()=>{await ss.Olm.init(),os=os||new ss.Olm.Utility,await this.baseApis.downloadKeys([this.userId]);let e=!1;do try{return this.initiatedByMe?await this.doSendVerification():await this.doRespondVerification()}catch(t){if(t instanceof Ma)this.startEvent=t.startEvent,e=!0;else throw t}while(e)}}static get NAME(){return no.Sas}get events(){return _y}canSwitchStartEvent(e){if(e.getType()!==Oo)return!1;const t=e.getContent();return(t==null?void 0:t.method)===Un.NAME&&!!this.waitingForAccept}async sendStart(){const e=this.channel.completeContent(Oo,{method:Un.NAME,from_device:this.baseApis.deviceId,key_agreement_protocols:Pa,hashes:Da,message_authentication_codes:Ua,short_authentication_string:$u});return await this.channel.sendCompleted(Oo,e),e}async verifyAndCheckMAC(e,t,i,n){const s=My[e](this,i,6),o=new Promise((l,u)=>{this.sasEvent={sas:ky(s,t),confirm:async()=>{try{await this.sendMAC(i,n),l()}catch(h){u(h)}},cancel:()=>u(Nu()),mismatch:()=>u(Iy())},this.emit(Uy.ShowSas,this.sasEvent)}),[a]=await Promise.all([this.waitForEvent(R.KeyVerificationMac).then(l=>(this.expectedEvent=R.KeyVerificationDone,l)),o]),c=a.getContent();await this.checkMAC(i,c,n)}async doSendVerification(){this.waitingForAccept=!0;let e;if(this.startEvent?e=this.channel.completedContentFromEvent(this.startEvent):e=await this.sendStart(),!this.initiatedByMe)throw new Ma(this.startEvent);let t;try{t=await this.waitForEvent(R.KeyVerificationAccept)}finally{this.waitingForAccept=!1}let i=t.getContent();const n=nr(i.short_authentication_string,Dl);if(!(Ay.has(i.key_agreement_protocol)&&Py.has(i.hash)&&Dy.has(i.message_authentication_code)&&n.length))throw Er();if(typeof i.commitment!="string")throw my();const s=i.key_agreement_protocol,o=i.message_authentication_code,a=i.commitment,c=new ss.Olm.SAS;try{this.ourSASPubKey=c.get_pubkey(),await this.send(R.KeyVerificationKey,{key:this.ourSASPubKey}),t=await this.waitForEvent(R.KeyVerificationKey),i=t.getContent();const l=i.key+li.stringify(e);if(os.sha256(l)!==a)throw Ry();this.theirSASPubKey=i.key,c.set_their_key(i.key),await this.verifyAndCheckMAC(s,n,c,o)}finally{c.free()}}async doRespondVerification(){let e=this.channel.completedContentFromEvent(this.startEvent);const t=nr(Pa,new Set(e.key_agreement_protocols))[0],i=nr(Da,new Set(e.hashes))[0],n=nr(Ua,new Set(e.message_authentication_codes))[0],s=nr(e.short_authentication_string,Dl);if(!(t!==void 0&&i!==void 0&&n!==void 0&&s.length))throw Er();const o=new ss.Olm.SAS;try{const a=o.get_pubkey()+li.stringify(e);await this.send(R.KeyVerificationAccept,{key_agreement_protocol:t,hash:i,message_authentication_code:n,short_authentication_string:s,commitment:os.sha256(a)}),e=(await this.waitForEvent(R.KeyVerificationKey)).getContent(),this.theirSASPubKey=e.key,o.set_their_key(e.key),this.ourSASPubKey=o.get_pubkey(),await this.send(R.KeyVerificationKey,{key:this.ourSASPubKey}),await this.verifyAndCheckMAC(t,s,o,n)}finally{o.free()}}sendMAC(e,t){const i={},n=[],s="MATRIX_KEY_VERIFICATION_MAC"+this.baseApis.getUserId()+this.baseApis.deviceId+this.userId+this.deviceId+this.channel.transactionId,o=`ed25519:${this.baseApis.deviceId}`;i[o]=ir(e,t)(this.baseApis.getDeviceEd25519Key(),s+o),n.push(o);const a=this.baseApis.getCrossSigningId();if(a){const l=`ed25519:${a}`;i[l]=ir(e,t)(a,s+l),n.push(l)}const c=ir(e,t)(n.sort().join(","),s+"KEY_IDS");return this.send(R.KeyVerificationMac,{mac:i,keys:c})}async checkMAC(e,t,i){const n="MATRIX_KEY_VERIFICATION_MAC"+this.userId+this.deviceId+this.baseApis.getUserId()+this.baseApis.deviceId+this.channel.transactionId;if(t.keys!==ir(e,i)(Object.keys(t.mac).sort().join(","),n+"KEY_IDS"))throw Gi();await this.verifyKeys(this.userId,t.mac,(s,o,a)=>{if(a!==ir(e,i)(o.keys[s],n+s))throw Gi()})}getShowSasCallbacks(){return this.sasEvent??null}}var Bu={};const Ul=5e5,ic=256;function Ll(r,e){if(!Bu.Olm)throw new Error("Olm is not available");if(!r.private_key_salt||!r.private_key_iterations)throw new Error("Salt and/or iterations not found: this backup cannot be restored with a passphrase");return xu(e,r.private_key_salt,r.private_key_iterations,r.private_key_bits||ic)}async function nc(r){if(!Bu.Olm)throw new Error("Olm is not available");const e=rn(32);return{key:await xu(r,e,Ul,ic),salt:e,iterations:Ul}}async function xu(r,e,t,i=ic){if(!bt||!Yi)throw new Error("Password-based backup is not available on this platform");const n=await bt.importKey("raw",new Yi().encode(r),{name:"PBKDF2"},!1,["deriveBits"]),s=await bt.deriveBits({name:"PBKDF2",salt:new Yi().encode(e),iterations:t,hash:"SHA-512"},n,i);return new Uint8Array(s)}function Ly(r){if(r.length>=255)throw new TypeError("Alphabet too long");for(var e=new Uint8Array(256),t=0;t<e.length;t++)e[t]=255;for(var i=0;i<r.length;i++){var n=r.charAt(i),s=n.charCodeAt(0);if(e[s]!==255)throw new TypeError(n+" is ambiguous");e[s]=i}var o=r.length,a=r.charAt(0),c=Math.log(o)/Math.log(256),l=Math.log(256)/Math.log(o);function u(g){if(g instanceof Uint8Array||(ArrayBuffer.isView(g)?g=new Uint8Array(g.buffer,g.byteOffset,g.byteLength):Array.isArray(g)&&(g=Uint8Array.from(g))),!(g instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(g.length===0)return"";for(var m=0,v=0,S=0,w=g.length;S!==w&&g[S]===0;)S++,m++;for(var M=(w-S)*l+1>>>0,_=new Uint8Array(M);S!==w;){for(var C=g[S],A=0,y=M-1;(C!==0||A<v)&&y!==-1;y--,A++)C+=256*_[y]>>>0,_[y]=C%o>>>0,C=C/o>>>0;if(C!==0)throw new Error("Non-zero carry");v=A,S++}for(var $=M-v;$!==M&&_[$]===0;)$++;for(var X=a.repeat(m);$<M;++$)X+=r.charAt(_[$]);return X}function h(g){if(typeof g!="string")throw new TypeError("Expected String");if(g.length===0)return new Uint8Array;for(var m=0,v=0,S=0;g[m]===a;)v++,m++;for(var w=(g.length-m)*c+1>>>0,M=new Uint8Array(w);g[m];){var _=e[g.charCodeAt(m)];if(_===255)return;for(var C=0,A=w-1;(_!==0||C<S)&&A!==-1;A--,C++)_+=o*M[A]>>>0,M[A]=_%256>>>0,_=_/256>>>0;if(_!==0)throw new Error("Non-zero carry");S=C,m++}for(var y=w-S;y!==w&&M[y]===0;)y++;for(var $=new Uint8Array(v+(w-y)),X=v;y!==w;)$[X++]=M[y++];return $}function f(g){var m=h(g);if(m)return m;throw new Error("Non-base"+o+" character")}return{encode:u,decodeUnsafe:h,decode:f}}var Ny=Ly;const Ky=Ny,Fy="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";var qu=Ky(Fy);const Ti=[139,1],Nl=32;function La(r){var n;const e=Buffer.alloc(Ti.length+r.length+1);e.set(Ti,0),e.set(r,Ti.length);let t=0;for(let s=0;s<e.length-1;++s)t^=e[s];return e[e.length-1]=t,(n=qu.encode(e).match(/.{1,4}/g))==null?void 0:n.join(" ")}function Es(r){const e=qu.decode(r.replace(/ /g,""));let t=0;for(const i of e)t^=i;if(t!==0)throw new Error("Incorrect parity");for(let i=0;i<Ti.length;++i)if(e[i]!==Ti[i])throw new Error("Incorrect prefix");if(e.length!==Ti.length+Nl+1)throw new Error("Incorrect length");return Uint8Array.from(e.slice(Ti.length,Ti.length+Nl))}const $y=10*60*1e3,By=2*60*1e3,xy=3*1e3,jn="m.key.verification.",pe=jn+"request",qe=jn+"start",Lt=jn+"cancel",qy=jn+"done",Pt=jn+"ready",Xt=on.Unsent,Mt=on.Requested,xt=on.Ready,ri=on.Started,rr=on.Cancelled,sr=on.Done;class Wi extends ke{constructor(e,t,i){super(),this.channel=e,this.verificationMethods=t,this.client=i,this.eventsByUs=new Map,this.eventsByThem=new Map,this._observeOnly=!1,this.timeoutTimer=null,this._accepting=!1,this._declining=!1,this.verifierHasFinished=!1,this._cancelled=!1,this._chosenMethod=null,this._qrCodeData=null,this.requestReceivedAt=null,this.commonMethods=[],this.cancelOnTimeout=async()=>{try{this.initiatedByMe?await this.cancel({reason:"Other party didn't accept in time",code:"m.timeout"}):await this.cancel({reason:"User didn't accept in time",code:"m.timeout"})}catch(n){d.error("Error while cancelling verification request",n)}},this.channel.request=this,this.setPhase(Xt,!1)}static validateEvent(e,t,i){const n=t.getContent();return!e||!e.startsWith(jn)?!1:n?(e===pe||e===Pt)&&!Array.isArray(n.methods)?(d.log("VerificationRequest: validateEvent: fail because methods"),!1):(e===pe||e===Pt||e===qe)&&(typeof n.from_device!="string"||n.from_device.length===0)?(d.log("VerificationRequest: validateEvent: fail because from_device"),!1):!0:(d.log("VerificationRequest: validateEvent: no content"),!1)}get transactionId(){return this.channel.transactionId}get roomId(){return this.channel.roomId}get invalid(){return this.phase===Xt}get requested(){return this.phase===Mt}get cancelled(){return this.phase===rr}get ready(){return this.phase===xt}get started(){return this.phase===ri}get done(){return this.phase===sr}get methods(){return this.commonMethods}get chosenMethod(){return this._chosenMethod}calculateEventTimeout(e){let t=this.channel.getTimestamp(e)+$y;if(this.requestReceivedAt&&!this.initiatedByMe&&this.phase<=Mt){const i=this.requestReceivedAt+By;t=Math.min(t,i)}return Math.max(0,t-Date.now())}get timeout(){const e=this.getEventByEither(pe);return e?this.calculateEventTimeout(e):0}get requestEvent(){return this.getEventByEither(pe)}get phase(){return this._phase}get verifier(){return this._verifier}get canAccept(){return $v(this)}get accepting(){return this._accepting}get declining(){return this._declining}get pending(){return!this.observeOnly&&this._phase!==sr&&this._phase!==rr}get qrCodeData(){return this._qrCodeData}getQRCodeBytes(){var e;return(e=this._qrCodeData)==null?void 0:e.getBuffer()}async generateQRCode(){return this.getQRCodeBytes()}otherPartySupportsMethod(e,t=!1){if(!t&&!this.ready&&!this.started)return!1;const i=this.eventsByThem.get(pe)||this.eventsByThem.get(Pt);if(!i){if(this.started&&this.initiatedByMe){const o=this.eventsByUs.get(qe),a=o&&o.getContent(),c=a&&a.method;return e==c}return!1}const n=i.getContent();if(!n)return!1;const{methods:s}=n;return Array.isArray(s)?s.includes(e):!1}get initiatedByMe(){const e=this.eventsByUs.size+this.eventsByThem.size===0;if(this._phase===Xt&&e)return!0;const t=this.eventsByUs.has(pe),i=this.eventsByThem.has(pe);if(t&&!i)return!0;if(!t&&i)return!1;const n=this.eventsByUs.has(qe),s=this.eventsByThem.has(qe);return!!(n&&!s)}get requestingUserId(){return this.initiatedByMe?this.client.getUserId():this.otherUserId}get receivingUserId(){return this.initiatedByMe?this.otherUserId:this.client.getUserId()}get otherUserId(){return this.channel.userId}get otherDeviceId(){return this.channel.deviceId}get isSelfVerification(){return this.client.getUserId()===this.otherUserId}get cancellingUserId(){const e=this.eventsByUs.get(Lt),t=this.eventsByThem.get(Lt);if(e&&(!t||e.getId()<t.getId()))return e.getSender();if(t)return t.getSender()}get cancellationCode(){const e=this.getEventByEither(Lt);return e?e.getContent().code:null}get observeOnly(){return this._observeOnly}get targetDevice(){const e=this.eventsByThem.get(pe)||this.eventsByThem.get(Pt)||this.eventsByThem.get(qe),t=e==null?void 0:e.getContent(),i=t==null?void 0:t.from_device;return{userId:this.otherUserId,deviceId:i}}beginKeyVerification(e,t=null){if(!this.observeOnly&&!this._verifier&&(this.phase===Mt||this.phase===xt||this.phase===Xt&&this.channel.canCreateRequest(qe))){if(this.commonMethods.length&&!this.commonMethods.includes(e)||(this._verifier=this.createVerifier(e,null,t),!this._verifier))throw Er();this._chosenMethod=e}return this._verifier}async startVerification(e){const t=this.beginKeyVerification(e);return t.verify(),t}scanQRCode(e){throw new Error("QR code scanning not supported by legacy crypto")}async sendRequest(){if(!this.observeOnly&&this._phase===Xt){const e=[...this.verificationMethods.keys()];await this.channel.send(pe,{methods:e})}}async cancel({reason:e="User declined",code:t="m.user"}={}){if(!this.observeOnly&&this._phase!==rr){if(this._declining=!0,this.emit(Vi.Change),this._verifier)return this._verifier.cancel(gi(t,e)());this._cancellingUserId=this.client.getUserId(),await this.channel.send(Lt,{code:t,reason:e})}}async accept(){if(!this.observeOnly&&this.phase===Mt&&!this.initiatedByMe){const e=[...this.verificationMethods.keys()];this._accepting=!0,this.emit(Vi.Change),await this.channel.send(Pt,{methods:e})}}waitFor(e){return new Promise((t,i)=>{const n=()=>{let s=!1;return e(this)?(t(this),s=!0):this.cancelled&&(i(new Error("cancelled")),s=!0),s&&this.off(Vi.Change,n),s};n()||this.on(Vi.Change,n)})}setPhase(e,t=!0){this._phase=e,t&&this.emit(Vi.Change)}getEventByEither(e){return this.eventsByThem.get(e)||this.eventsByUs.get(e)}getEventBy(e,t=!1){return t?this.eventsByThem.get(e):this.eventsByUs.get(e)}calculatePhaseTransitions(){const e=[{phase:Xt}],t=()=>e[e.length-1].phase,i=this.eventsByThem.has(pe),n=this.getEventBy(pe,i);n&&e.push({phase:Mt,event:n});const s=n&&this.getEventBy(Pt,!i);s&&t()===Mt&&e.push({phase:xt,event:s});let o;if(s||!n){const l=this.eventsByThem.get(qe),u=this.eventsByUs.get(qe);l&&u?o=l.getSender()<u.getSender()?l:u:o=l||u}else o=this.getEventBy(qe,!i);if(o){const l=t()===Mt&&(n==null?void 0:n.getSender())!==o.getSender(),u=t()===Xt&&this.channel.canCreateRequest(qe);(l||t()===xt||u)&&e.push({phase:ri,event:o})}const a=this.eventsByUs.get(qy);(this.verifierHasFinished||a&&t()===ri)&&e.push({phase:sr});const c=this.getEventByEither(Lt);return(this._cancelled||c)&&t()!==sr&&e.push({phase:rr,event:c}),e}transitionToPhase(e){const{phase:t,event:i}=e;if((t===Mt||t===xt)&&!this.wasSentByOwnDevice(i)){const n=i.getContent();this.commonMethods=n.methods.filter(s=>this.verificationMethods.has(s))}if(this.observeOnly||(t===Mt||t===ri||t===xt)&&this.channel.receiveStartFromOtherDevices&&this.wasSentByOwnUser(i)&&!this.wasSentByOwnDevice(i)&&(this._observeOnly=!0),t===ri){const{method:n}=i.getContent();!this._verifier&&!this.observeOnly&&(this._verifier=this.createVerifier(n,i),this._verifier?this._chosenMethod=n:this.cancel({code:"m.unknown_method",reason:`Unknown method: ${n}`}))}}applyPhaseTransitions(){const e=this.calculatePhaseTransitions(),t=e.findIndex(n=>n.phase===this.phase),i=e.slice(t+1);for(const n of i)this.transitionToPhase(n);return i}isWinningStartRace(e){if(e.getType()!==qe)return!1;const t=this._verifier.startEvent;let i;if(this.isSelfVerification)if(t){const s=t.getContent();i=s&&s.from_device}else i=this.client.getDeviceId();else t?i=t.getSender():i=this.client.getUserId();let n;if(this.isSelfVerification){const s=e.getContent();n=s&&s.from_device}else n=e.getSender();return n<i}hasEventId(e){for(const t of this.eventsByUs.values())if(t.getId()===e)return!0;for(const t of this.eventsByThem.values())if(t.getId()===e)return!0;return!1}async handleEvent(e,t,i,n,s){var u;if(this.done||this.cancelled)return;const o=this._observeOnly;if(this.adjustObserveOnly(t,i),!this.observeOnly&&!n&&await this.cancelOnError(e,t)||(s?this.eventsByUs.has(e):this.eventsByThem.has(e)))return;const c=this.phase;this.addEvent(e,t,s);const l=this.applyPhaseTransitions();try{if(this._verifier&&!this.observeOnly){const h=this.isWinningStartRace(t);this._verifier.canSwitchStartEvent(t)&&h?this._verifier.switchStartEvent(t):n||(e===Lt||(u=this._verifier.events)!=null&&u.includes(e))&&this._verifier.handleEvent(t)}if(l.length){i&&l.some(g=>g.phase===xt)&&this.otherPartySupportsMethod(Fu,!0)&&(this._qrCodeData=await Ii.create(this,this.client));const h=l[l.length-1],{phase:f}=h;this.setupTimeout(f),this.setPhase(f)}else this._observeOnly!==o&&this.emit(Vi.Change)}finally{d.log(`Verification request ${this.channel.transactionId}: ${e} event with id:${t.getId()}, content:${JSON.stringify(t.getContent())} deviceId:${this.channel.deviceId}, sender:${t.getSender()}, isSentByUs:${s}, isLiveEvent:${i}, isRemoteEcho:${n}, phase:${c}=>${this.phase}, observeOnly:${o}=>${this._observeOnly}`)}}setupTimeout(e){!this.timeoutTimer&&!this.observeOnly&&e===Mt&&(this.timeoutTimer=setTimeout(this.cancelOnTimeout,this.timeout)),this.timeoutTimer&&(e===ri||e===xt||e===sr||e===rr)&&(clearTimeout(this.timeoutTimer),this.timeoutTimer=null)}async cancelOnError(e,t){if(e===qe){const s=t.getContent().method;if(!this.verificationMethods.has(s))return await this.cancel(Oa(Er())),!0}const i=e===pe&&this.phase!==Xt,n=e===Pt&&this.phase!==Mt&&this.phase!==ri;if(this.phase!==Xt&&(i||n)){d.warn(`Cancelling, unexpected ${e} verification event from ${t.getSender()}`);const s=`Unexpected ${e} event in phase ${this.phase}`;return await this.cancel(Oa(Ku({reason:s}))),!0}return!1}adjustObserveOnly(e,t=!1){t||(this._observeOnly=!0),this.calculateEventTimeout(e)<xy&&(this._observeOnly=!0)}addEvent(e,t,i=!1){if(i?this.eventsByUs.set(e,t):this.eventsByThem.set(e,t),e===pe){for(const[n,s]of this.eventsByThem.entries())s.getSender()!==this.otherUserId&&this.eventsByThem.delete(n);this.requestReceivedAt=Date.now()}}createVerifier(e,t=null,i=null){i||(i=this.targetDevice);const{userId:n,deviceId:s}=i,o=this.verificationMethods.get(e);if(!o){d.warn("could not find verifier constructor for method",e);return}return new o(this.channel,this.client,n,s,t,this)}wasSentByOwnUser(e){return(e==null?void 0:e.getSender())===this.client.getUserId()}wasSentByOwnDevice(e){if(!this.wasSentByOwnUser(e))return!1;const t=e.getContent();return!(!t||t.from_device!==this.client.getDeviceId())}onVerifierCancelled(){this._cancelled=!0;const e=this.applyPhaseTransitions();e.length&&this.setPhase(e[e.length-1].phase)}onVerifierFinished(){this.channel.send(R.KeyVerificationDone,{}),this.verifierHasFinished=!0;const e=this.applyPhaseTransitions();e.length&&this.setPhase(e[e.length-1].phase)}getEventFromOtherParty(e){return this.eventsByThem.get(e)}}const Kl=R.RoomMessage,Fl="m.reference",$l="m.relates_to";class Ze{constructor(e,t,i){this.client=e,this.roomId=t,this.userId=i}get receiveStartFromOtherDevices(){return!0}get transactionId(){return this.requestEventId}static getOtherPartyUserId(e,t){if(Ze.getEventType(e)!==pe)return;const n=t.getUserId(),s=e.getSender(),a=e.getContent().to;if(s===n)return a;if(a===n)return s}getTimestamp(e){return e.getTs()}static canCreateRequest(e){return e===pe}canCreateRequest(e){return Ze.canCreateRequest(e)}static getTransactionId(e){if(Ze.getEventType(e)===pe)return e.getId();{const t=e.getRelation();if((t==null?void 0:t.rel_type)===Fl)return t.event_id}}static validateEvent(e,t){const i=Ze.getTransactionId(e);if(typeof i!="string"||i.length===0)return!1;const n=Ze.getEventType(e),s=e.getContent();if(n===pe){if(!s||typeof s.to!="string"||!s.to.length)return d.log("InRoomChannel: validateEvent: no valid to "+s.to),!1;if(!Ze.getOtherPartyUserId(e,t))return d.log(`InRoomChannel: validateEvent: not directed to or sent by me: ${e.getSender()}, ${s.to}`),!1}return Wi.validateEvent(n,e,t)}static getEventType(e){const t=e.getType();if(t===Kl){const i=e.getContent();if(i){const{msgtype:n}=i;if(n===pe)return pe}}return t&&t!==pe?t:""}async handleEvent(e,t,i=!1){if(t.hasEventId(e.getId()))return;const n=Ze.getEventType(e);if(e.getRoomId()!==this.roomId)return;if(!this.userId){const u=Ze.getOtherPartyUserId(e,this.client);u&&(this.userId=u)}const s=this.client.getUserId(),o=e.getSender();if(this.userId&&o!==s&&o!==this.userId){d.log(`InRoomChannel: ignoring verification event from non-participating sender ${o}`);return}this.requestEventId||(this.requestEventId=Ze.getTransactionId(e));const a=!!e.getTxnId(),c=!!e.getUnsigned().transaction_id,l=e.getSender()===this.client.getUserId();return t.handleEvent(n,e,i,a||c,l)}completedContentFromEvent(e){const t=Object.assign({},e.getContent());return t[$l]=e.getRelation(),t}completeContent(e,t){return t=Object.assign({},t),(e===pe||e===Pt||e===qe)&&(t.from_device=this.client.getDeviceId()),e===pe?t={body:this.client.getUserId()+" is requesting to verify your key, but your client does not support in-chat key verification.  You will need to use legacy key verification to verify keys.",msgtype:pe,to:this.userId,from_device:t.from_device,methods:t.methods}:t[$l]={rel_type:Fl,event_id:this.transactionId},t}send(e,t){const i=this.completeContent(e,t);return this.sendCompleted(e,i)}async sendCompleted(e,t){let i=e;e===pe&&(i=Kl);const n=await this.client.sendEvent(this.roomId,i,t);e===pe&&(this.requestEventId=n.event_id)}}class Vy{constructor(){this.requestsByRoomId=new Map}getRequest(e){const t=e.getRoomId(),i=Ze.getTransactionId(e);return this.getRequestByTxnId(t,i)}getRequestByChannel(e){return this.getRequestByTxnId(e.roomId,e.transactionId)}getRequestByTxnId(e,t){const i=this.requestsByRoomId.get(e);if(i)return i.get(t)}setRequest(e,t){this.doSetRequest(e.getRoomId(),Ze.getTransactionId(e),t)}setRequestByChannel(e,t){this.doSetRequest(e.roomId,e.transactionId,t)}doSetRequest(e,t,i){let n=this.requestsByRoomId.get(e);n||(n=new Map,this.requestsByRoomId.set(e,n)),n.set(t,i)}removeRequest(e){const t=e.getRoomId(),i=this.requestsByRoomId.get(t);i&&(i.delete(Ze.getTransactionId(e)),i.size===0&&this.requestsByRoomId.delete(t))}findRequestInProgress(e,t){const i=this.requestsByRoomId.get(e);if(i){for(const n of i.values())if(n.pending&&(t===void 0||n.requestingUserId===t))return n}}}class Xe{constructor(e,t,i,n,s){this.client=e,this.userId=t,this.devices=i,this.transactionId=n,this.deviceId=s}isToDevices(e){if(e.length===this.devices.length){for(const t of e)if(!this.devices.includes(t))return!1;return!0}else return!1}static getEventType(e){return e.getType()}static getTransactionId(e){const t=e.getContent();return t&&t.transaction_id}static canCreateRequest(e){return e===pe||e===qe}canCreateRequest(e){return Xe.canCreateRequest(e)}static validateEvent(e,t){if(e.isCancelled())return d.warn("Ignoring flagged verification request from "+e.getSender()),!1;const i=e.getContent();if(!i)return d.warn("ToDeviceChannel.validateEvent: invalid: no content"),!1;if(!i.transaction_id)return d.warn("ToDeviceChannel.validateEvent: invalid: no transaction_id"),!1;const n=e.getType();if(n===pe){if(!Number.isFinite(i.timestamp))return d.warn("ToDeviceChannel.validateEvent: invalid: no timestamp"),!1;if(e.getSender()===t.getUserId()&&i.from_device==t.getDeviceId())return d.warn("ToDeviceChannel.validateEvent: invalid: from own device"),!1}return Wi.validateEvent(n,e,t)}getTimestamp(e){const t=e.getContent();return t&&t.timestamp}async handleEvent(e,t,i=!1){const n=e.getType(),s=e.getContent();if(n===pe||n===Pt||n===qe){this.transactionId||(this.transactionId=s.transaction_id);const l=s.from_device;if(!this.deviceId&&this.devices.includes(l)&&(this.deviceId=l),!this.deviceId||this.deviceId!==l){const u=this.completeContent(Lt,Oa(Ku()));return this.sendToDevices(Lt,u,[l])}}const o=t.phase===ri||t.phase===xt;await t.handleEvent(e.getType(),e,i,!1,!1);const a=t.phase===ri||t.phase===xt;if((n===qe||n===Pt)&&!o&&a&&this.deviceId){const l=this.devices.filter(u=>u!==this.deviceId&&u!==this.client.getDeviceId());if(l.length){const u=this.completeContent(Lt,{code:"m.accepted",reason:"Verification request accepted by another device"});await this.sendToDevices(Lt,u,l)}}}completedContentFromEvent(e){return e.getContent()}completeContent(e,t){return t=Object.assign({},t),this.transactionId&&(t.transaction_id=this.transactionId),(e===pe||e===Pt||e===qe)&&(t.from_device=this.client.getDeviceId()),e===pe&&(t.timestamp=Date.now()),t}send(e,t={}){(e===pe||e===qe)&&!this.transactionId&&(this.transactionId=Xe.makeTransactionId());const i=this.completeContent(e,t);return this.sendCompleted(e,i)}async sendCompleted(e,t){let i;e===pe||e===Lt&&!this.deviceId?i=await this.sendToDevices(e,t,this.devices):i=await this.sendToDevices(e,t,[this.deviceId]);const n=new it({sender:this.client.getUserId(),content:t,type:e});return await this.request.handleEvent(e,n,!0,!0,!0),i}async sendToDevices(e,t,i){if(i.length){const n=new Map;for(const s of i)n.set(s,t);await this.client.sendToDevice(e,new Map([[this.userId,n]]))}}static makeTransactionId(){return rn(32)}}class jy{constructor(){this.requestsByUserId=new Map}getRequest(e){return this.getRequestBySenderAndTxnId(e.getSender(),Xe.getTransactionId(e))}getRequestByChannel(e){return this.getRequestBySenderAndTxnId(e.userId,e.transactionId)}getRequestBySenderAndTxnId(e,t){const i=this.requestsByUserId.get(e);if(i)return i.get(t)}setRequest(e,t){this.setRequestBySenderAndTxnId(e.getSender(),Xe.getTransactionId(e),t)}setRequestByChannel(e,t){this.setRequestBySenderAndTxnId(e.userId,e.transactionId,t)}setRequestBySenderAndTxnId(e,t,i){let n=this.requestsByUserId.get(e);n||(n=new Map,this.requestsByUserId.set(e,n)),n.set(t,i)}removeRequest(e){const t=e.getSender(),i=this.requestsByUserId.get(t);i&&(i.delete(Xe.getTransactionId(e)),i.size===0&&this.requestsByUserId.delete(t))}findRequestInProgress(e,t){const i=this.requestsByUserId.get(e);if(i){for(const n of i.values())if(n.pending&&n.channel.isToDevices(t))return n}}getRequestsInProgress(e){const t=this.requestsByUserId.get(e);return t?Array.from(t.values()).filter(i=>i.pending):[]}}class Ks extends tc{constructor(){super(...arguments),this.doVerification=async()=>{throw new Error("Verification is not possible with this method")}}static factory(e,t,i,n,s,o){return new Ks(e,t,i,n,s,o)}static get NAME(){return"org.matrix.illegal_method"}}var gn={};const bs="org.matrix.msc2697.v1.olm.libolm_pickle",Bl=7*24*60*60*1e3;class Gy{constructor(e){this.crypto=e,this.inProgress=!1,this.getDehydrationKeyFromCache()}getDehydrationKeyFromCache(){return this.crypto.cryptoStore.doTxn("readonly",[z.STORE_ACCOUNT],e=>{this.crypto.cryptoStore.getSecretStorePrivateKey(e,async t=>{if(t){const{key:i,keyInfo:n,deviceDisplayName:s,time:o}=t,a=Buffer.from(this.crypto.olmDevice.pickleKey),c=await jr(i,a,bs);this.key=tt(c),this.keyInfo=n,this.deviceDisplayName=s;const l=Date.now(),u=Math.max(1,o+Bl-l);this.timeoutId=gn.setTimeout(this.dehydrateDevice.bind(this),u)}},"dehydration")})}async setKeyAndQueueDehydration(e,t={},i){await this.setKey(e,t,i)||this.dehydrateDevice()}async setKey(e,t={},i){if(!e){this.timeoutId&&(gn.clearTimeout(this.timeoutId),this.timeoutId=void 0),await this.crypto.cryptoStore.doTxn("readwrite",[z.STORE_ACCOUNT],s=>{this.crypto.cryptoStore.storeSecretStorePrivateKey(s,"dehydration",null)}),this.key=void 0,this.keyInfo=void 0;return}let n=!!this.key&&e.length==this.key.length;for(let s=0;n&&s<e.length;s++)e[s]!=this.key[s]&&(n=!1);return n||(this.key=e,this.keyInfo=t,this.deviceDisplayName=i),n}async dehydrateDevice(){if(this.inProgress){d.log("Dehydration already in progress -- not starting new dehydration");return}this.inProgress=!0,this.timeoutId&&(gn.clearTimeout(this.timeoutId),this.timeoutId=void 0);try{const e=Buffer.from(this.crypto.olmDevice.pickleKey),t=await Vn(lt(this.key),e,bs);await this.crypto.cryptoStore.doTxn("readwrite",[z.STORE_ACCOUNT],S=>{this.crypto.cryptoStore.storeSecretStorePrivateKey(S,"dehydration",{keyInfo:this.keyInfo,key:t,deviceDisplayName:this.deviceDisplayName,time:Date.now()})}),d.log("Attempting to dehydrate device"),d.log("Creating account");const i=new gn.Olm.Account;i.create();const n=JSON.parse(i.identity_keys()),s=i.max_number_of_one_time_keys();i.generate_one_time_keys(s/2),i.generate_fallback_key();const o=JSON.parse(i.one_time_keys()),a=JSON.parse(i.fallback_key());i.mark_keys_as_published();const c=i.pickle(new Uint8Array(this.key)),l={algorithm:bs,account:c};this.keyInfo.passphrase&&(l.passphrase=this.keyInfo.passphrase),d.log("Uploading account to server");const h=(await this.crypto.baseApis.http.authedRequest(D.Put,"/dehydrated_device",void 0,{device_data:l,initial_device_display_name:this.deviceDisplayName},{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})).device_id;d.log("Preparing device keys",h);const f={algorithms:this.crypto.supportedAlgorithms,device_id:h,user_id:this.crypto.userId,keys:{[`ed25519:${h}`]:n.ed25519,[`curve25519:${h}`]:n.curve25519}},g=i.sign(li.stringify(f));f.signatures={[this.crypto.userId]:{[`ed25519:${h}`]:g}},this.crypto.crossSigningInfo.getId("self_signing")&&await this.crypto.crossSigningInfo.signObject(f,"self_signing"),d.log("Preparing one-time keys");const m={};for(const[S,w]of Object.entries(o.curve25519)){const M={key:w},_=i.sign(li.stringify(M));M.signatures={[this.crypto.userId]:{[`ed25519:${h}`]:_}},m[`signed_curve25519:${S}`]=M}d.log("Preparing fallback keys");const v={};for(const[S,w]of Object.entries(a.curve25519)){const M={key:w,fallback:!0},_=i.sign(li.stringify(M));M.signatures={[this.crypto.userId]:{[`ed25519:${h}`]:_}},v[`signed_curve25519:${S}`]=M}return d.log("Uploading keys to server"),await this.crypto.baseApis.http.authedRequest(D.Post,"/keys/upload/"+encodeURI(h),void 0,{device_keys:f,one_time_keys:m,"org.matrix.msc2732.fallback_keys":v}),d.log("Done dehydrating"),this.timeoutId=gn.setTimeout(this.dehydrateDevice.bind(this),Bl),h}finally{this.inProgress=!1}}stop(){this.timeoutId&&(gn.clearTimeout(this.timeoutId),this.timeoutId=void 0)}}var or={};const Wy=200,Hy=5e3;class Qi{constructor(e,t){this.baseApis=e,this.getKey=t,this.sessionLastCheckAttemptedTime={},this.clientRunning=!0,this.checkedForBackup=!1,this.sendingBackups=!1}stop(){this.clientRunning=!1}get version(){return this.backupInfo&&this.backupInfo.version}static checkBackupVersion(e){const t=Mo[e.algorithm];if(!t)throw new Error("Unknown backup algorithm: "+e.algorithm);if(typeof e.auth_data!="object")throw new Error("Invalid backup data returned");return t.checkBackupVersion(e)}static makeAlgorithm(e,t){const i=Mo[e.algorithm];if(!i)throw new Error("Unknown backup algorithm");return i.init(e.auth_data,t)}async enableKeyBackup(e){this.backupInfo=e,this.algorithm&&this.algorithm.free(),this.algorithm=await Qi.makeAlgorithm(e,this.getKey),this.baseApis.emit(me.KeyBackupStatus,!0),this.scheduleKeyBackupSend()}disableKeyBackup(){this.algorithm&&this.algorithm.free(),this.algorithm=void 0,this.backupInfo=void 0,this.baseApis.emit(me.KeyBackupStatus,!1)}getKeyBackupEnabled(){return this.checkedForBackup?!!this.algorithm:null}async prepareKeyBackupVersion(e,t){const i=t?Mo[t]:Yy;if(!i)throw new Error("Unknown backup algorithm");const[n,s]=await i.prepare(e),o=La(n);return{algorithm:i.algorithmName,auth_data:s,recovery_key:o,privateKey:n}}async createKeyBackupVersion(e){this.algorithm=await Qi.makeAlgorithm(e,this.getKey)}async deleteAllKeyBackupVersions(){var t,i;let e=((t=await this.baseApis.getKeyBackupVersion())==null?void 0:t.version)??null;for(;e!=null;)await this.deleteKeyBackupVersion(e),this.disableKeyBackup(),e=((i=await this.baseApis.getKeyBackupVersion())==null?void 0:i.version)??null}async deleteKeyBackupVersion(e){const t=W("/room_keys/version/$version",{$version:e});await this.baseApis.http.authedRequest(D.Delete,t,void 0,void 0,{prefix:Pe.V3})}async checkAndStart(){if(d.log("Checking key backup status..."),this.baseApis.isGuest())return d.log("Skipping key backup check since user is guest"),this.checkedForBackup=!0,null;let e;try{e=await this.baseApis.getKeyBackupVersion()??void 0}catch(i){return d.log("Error checking for active key backup",i),i.httpStatus===404&&(this.checkedForBackup=!0),null}this.checkedForBackup=!0;const t=await this.isKeyBackupTrusted(e);return t.usable&&!this.backupInfo?(d.log(`Found usable key backup v${e.version}: enabling key backups`),await this.enableKeyBackup(e)):!t.usable&&this.backupInfo?(d.log("No usable key backup: disabling key backup"),this.disableKeyBackup()):!t.usable&&!this.backupInfo?d.log("No usable key backup: not enabling key backup"):t.usable&&this.backupInfo&&(e.version!==this.backupInfo.version?(d.log(`On backup version ${this.backupInfo.version} but found version ${e.version}: switching.`),this.disableKeyBackup(),await this.enableKeyBackup(e),await this.scheduleAllGroupSessionsForBackup()):d.log(`Backup version ${e.version} still current`)),{backupInfo:e,trustInfo:t}}async checkKeyBackup(){return this.checkedForBackup=!1,this.checkAndStart()}async queryKeyBackupRateLimited(e,t){if(!this.backupInfo)return;const i=new Date().getTime();(!this.sessionLastCheckAttemptedTime[t]||i-this.sessionLastCheckAttemptedTime[t]>Hy)&&(this.sessionLastCheckAttemptedTime[t]=i,await this.baseApis.restoreKeyBackupWithCache(e,t,this.backupInfo,{}))}async isKeyBackupTrusted(e){const t={usable:!1,trusted_locally:!1,sigs:[]};if(!e||!e.algorithm||!e.auth_data||!e.auth_data.signatures)return d.info(`Key backup is absent or missing required data: ${JSON.stringify(e)}`),t;const i=this.baseApis.getUserId(),n=await this.baseApis.crypto.getSessionBackupPrivateKey();if(n){let o=null;try{o=await Qi.makeAlgorithm(e,async()=>n),await o.keyMatches(n)&&(d.info("Backup is trusted locally"),t.trusted_locally=!0)}catch{}finally{o==null||o.free()}}const s=e.auth_data.signatures[i]||{};for(const o of Object.keys(s)){const a=o.split(":");if(a[0]!=="ed25519"){d.log("Ignoring unknown signature type: "+a[0]);continue}const c={deviceId:a[1]},l=this.baseApis.crypto.crossSigningInfo.getId();if(l===c.deviceId){c.crossSigningId=!0;try{await Dn(this.baseApis.crypto.olmDevice,e.auth_data,i,c.deviceId,l),c.valid=!0}catch(h){d.warn("Bad signature from cross signing key "+l,h),c.valid=!1}t.sigs.push(c);continue}const u=this.baseApis.crypto.deviceList.getStoredDevice(i,c.deviceId);if(u){c.device=u,c.deviceTrust=this.baseApis.checkDeviceTrust(i,c.deviceId);try{await Dn(this.baseApis.crypto.olmDevice,e.auth_data,i,u.deviceId,u.getFingerprint()),c.valid=!0}catch(h){d.info("Bad signature from key ID "+o+" userID "+this.baseApis.getUserId()+" device ID "+u.deviceId+" fingerprint: "+u.getFingerprint(),e.auth_data,h),c.valid=!1}}else c.valid=null,d.info("Ignoring signature from unknown key "+o);t.sigs.push(c)}return t.usable=t.sigs.some(o=>{var a;return o.valid&&(o.device&&((a=o.deviceTrust)==null?void 0:a.isVerified())||o.crossSigningId)}),t}async scheduleKeyBackupSend(e=1e4){if(d.debug(`Key backup: scheduleKeyBackupSend currentSending:${this.sendingBackups} delay:${e}`),!this.sendingBackups){this.sendingBackups=!0;try{const t=Math.random()*e;if(await Ir(t),!this.clientRunning){this.sendingBackups=!1;return}let i=0;for(;;){if(!this.algorithm)return;try{if(await this.backupPendingKeys(Wy)===0){this.sendingBackups=!1;return}i=0}catch(n){if(i++,d.log("Key backup request failed",n),n instanceof Et){const s=n.data.errcode;if(s=="M_NOT_FOUND"||s=="M_WRONG_ROOM_KEYS_VERSION"){this.sendingBackups=!1,this.baseApis.crypto.emit(me.KeyBackupFailed,s),await this.checkKeyBackup();return}}}if(i&&await Ir(1e3*Math.pow(2,Math.min(i-1,4))),!this.clientRunning){d.debug("Key backup send loop aborted, client stopped"),this.sendingBackups=!1;return}}}catch(t){d.log(`Backup loop failed ${t}`),this.sendingBackups=!1}}}async backupPendingKeys(e){const t=await this.baseApis.crypto.cryptoStore.getSessionsNeedingBackup(e);if(!t.length)return 0;let i=await this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup();this.baseApis.crypto.emit(me.KeyBackupSessionsRemaining,i);const n={};for(const s of t){const o=s.sessionData.room_id;Gt(n,o,n[o]||{sessions:{}});const a=this.baseApis.crypto.olmDevice.exportInboundGroupSession(s.senderKey,s.sessionId,s.sessionData);a.algorithm=dt;const c=(a.forwarding_curve25519_key_chain||[]).length,l=this.baseApis.crypto.deviceList.getUserByIdentityKey(dt,s.senderKey),u=this.baseApis.crypto.deviceList.getDeviceByIdentityKey(dt,s.senderKey)??void 0,h=this.baseApis.crypto.checkDeviceInfoTrust(l,u).isVerified();Gt(n[o].sessions,s.sessionId,{first_message_index:a.first_known_index,forwarded_count:c,is_verified:h,session_data:await this.algorithm.encryptSession(a)})}return await this.baseApis.sendKeyBackup(void 0,void 0,this.backupInfo.version,{rooms:n}),await this.baseApis.crypto.cryptoStore.unmarkSessionsNeedingBackup(t),i=await this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup(),this.baseApis.crypto.emit(me.KeyBackupSessionsRemaining,i),t.length}async backupGroupSession(e,t){await this.baseApis.crypto.cryptoStore.markSessionsNeedingBackup([{senderKey:e,sessionId:t}]),this.backupInfo&&this.scheduleKeyBackupSend()}async scheduleAllGroupSessionsForBackup(){await this.flagAllGroupSessionsForBackup(),this.scheduleKeyBackupSend(0)}async flagAllGroupSessionsForBackup(){await this.baseApis.crypto.cryptoStore.doTxn("readwrite",[z.STORE_INBOUND_GROUP_SESSIONS,z.STORE_BACKUP],t=>{this.baseApis.crypto.cryptoStore.getAllEndToEndInboundGroupSessions(t,i=>{i!==null&&this.baseApis.crypto.cryptoStore.markSessionsNeedingBackup([i],t)})});const e=await this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup();return this.baseApis.emit(me.KeyBackupSessionsRemaining,e),e}countSessionsNeedingBackup(){return this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup()}}const Ws=class Ws{constructor(e,t,i){this.authData=e,this.publicKey=t,this.getKey=i}static async init(e,t){if(!e||!("public_key"in e))throw new Error("auth_data missing required information");const i=new or.Olm.PkEncryption;return i.set_recipient_key(e.public_key),new Ws(e,i,t)}static async prepare(e){const t=new or.Olm.PkDecryption;try{const i={};if(!e)i.public_key=t.generate_key();else if(e instanceof Uint8Array)i.public_key=t.init_with_private_key(e);else{const s=await nc(e);i.private_key_salt=s.salt,i.private_key_iterations=s.iterations,i.public_key=t.init_with_private_key(s.key)}return new or.Olm.PkEncryption().set_recipient_key(i.public_key),[t.get_private_key(),i]}finally{t.free()}}static checkBackupVersion(e){if(!("public_key"in e.auth_data))throw new Error("Invalid backup data returned")}get untrusted(){return!0}async encryptSession(e){const t=Object.assign({},e);return delete t.session_id,delete t.room_id,delete t.first_known_index,this.publicKey.encrypt(JSON.stringify(t))}async decryptSessions(e){const t=await this.getKey(),i=new or.Olm.PkDecryption;try{if(i.init_with_private_key(t)!==this.authData.public_key)throw new Et({errcode:Pr.RESTORE_BACKUP_ERROR_BAD_KEY});const s=[];for(const[o,a]of Object.entries(e))try{const c=JSON.parse(i.decrypt(a.session_data.ephemeral,a.session_data.mac,a.session_data.ciphertext));c.session_id=o,s.push(c)}catch(c){d.log("Failed to decrypt megolm session from backup",c,a)}return s}finally{i.free()}}async keyMatches(e){const t=new or.Olm.PkDecryption;let i;try{i=t.init_with_private_key(e)}finally{t.free()}return i===this.authData.public_key}free(){this.publicKey.free()}};Ws.algorithmName="m.megolm_backup.v1.curve25519-aes-sha2";let Mr=Ws;function Jy(r){const e=new Uint8Array(r);return rt.getRandomValues(e),e}const zy=new Ce("m.megolm_backup.v1.aes-hmac-sha2","org.matrix.msc3270.v1.aes-hmac-sha2"),Hs=class Hs{constructor(e,t){this.authData=e,this.key=t}static async init(e,t){if(!e)throw new Error("auth_data missing");const i=await t();if(e.mac){const{mac:n}=await kn(i,e.iv);if(e.mac.replace(/=+$/g,"")!==n.replace(/=+/g,""))throw new Error("Key does not match")}return new Hs(e,i)}static async prepare(e){let t;const i={};if(!e)t=Jy(32);else if(e instanceof Uint8Array)t=new Uint8Array(e);else{const o=await nc(e);i.private_key_salt=o.salt,i.private_key_iterations=o.iterations,t=o.key}const{iv:n,mac:s}=await kn(t);return i.iv=n,i.mac=s,[t,i]}static checkBackupVersion(e){if(!("iv"in e.auth_data&&"mac"in e.auth_data))throw new Error("Invalid backup data returned")}get untrusted(){return!1}encryptSession(e){const t=Object.assign({},e);return delete t.session_id,delete t.room_id,delete t.first_known_index,Vn(JSON.stringify(t),this.key,e.session_id)}async decryptSessions(e){const t=[];for(const[i,n]of Object.entries(e))try{const s=JSON.parse(await jr(n.session_data,this.key,i));s.session_id=i,t.push(s)}catch(s){d.log("Failed to decrypt megolm session from backup",s,n)}return t}async keyMatches(e){if(this.authData.mac){const{mac:t}=await kn(e,this.authData.iv);return this.authData.mac.replace(/=+$/g,"")===t.replace(/=+/g,"")}else return!0}free(){this.key.fill(0)}};Hs.algorithmName=zy.name;let Fs=Hs;const Mo={[Mr.algorithmName]:Mr,[Fs.algorithmName]:Fs},Yy=Mr;function xl(r){return{trusted:r.usable,matchesDecryptionKey:r.trusted_locally??!1}}class Qy{constructor(e){this.algorithm=e,this.sourceTrusted=!e.untrusted}free(){this.algorithm.free()}async decryptSessions(e){return await this.algorithm.decryptSessions(e)}}class Xy{constructor(e){this.cryptoStore=e,this.roomEncryption={}}async init(){await this.cryptoStore.doTxn("readwrite",[z.STORE_ROOMS],e=>{this.cryptoStore.getEndToEndRooms(e,t=>{this.roomEncryption=t})})}getRoomEncryption(e){return this.roomEncryption[e]||null}isRoomEncrypted(e){return!!this.getRoomEncryption(e)}async setRoomEncryption(e,t){this.roomEncryption[e]=t,await this.cryptoStore.doTxn("readwrite",[z.STORE_ROOMS],i=>{this.cryptoStore.storeEndToEndRoom(e,t,i)})}}function ql(r,e){const t=new Map(Object.entries(r.keys)),i=r.getDisplayName()||void 0,n=new Map;if(r.signatures)for(const s in r.signatures)n.set(s,new Map(Object.entries(r.signatures[s])));return new tv({deviceId:r.deviceId,userId:e,keys:t,algorithms:r.algorithms,verified:r.verified,signatures:n,displayName:i})}var as={};const Zt=ht.DeviceVerification,Ao={[Or.NAME]:Or,[Un.NAME]:Un,[yy]:Ks,[Fu]:Ks};Or.NAME,Un.NAME;function Zy(){return!!globalThis.Olm}const eS=60*60*1e3,tS=5*60*1e3;var me=(r=>(r.DeviceVerificationChanged="deviceVerificationChanged",r.UserTrustStatusChanged="userTrustStatusChanged",r.UserCrossSigningUpdated="userCrossSigningUpdated",r.RoomKeyRequest="crypto.roomKeyRequest",r.RoomKeyRequestCancellation="crypto.roomKeyRequestCancellation",r.KeyBackupStatus="crypto.keyBackupStatus",r.KeyBackupFailed="crypto.keyBackupFailed",r.KeyBackupSessionsRemaining="crypto.keyBackupSessionsRemaining",r.KeyBackupDecryptionKeyCached="crypto.keyBackupDecryptionKeyCached",r.KeySignatureUploadFailure="crypto.keySignatureUploadFailure",r.VerificationRequest="crypto.verification.request",r.VerificationRequestReceived="crypto.verificationRequestReceived",r.Warning="crypto.warning",r.WillUpdateDevices="crypto.willUpdateDevices",r.DevicesUpdated="crypto.devicesUpdated",r.KeysChanged="crossSigning.keysChanged",r.LegacyCryptoStoreMigrationProgress="crypto.legacyCryptoStoreMigrationProgress",r))(me||{});class $s extends ke{constructor(e,t,i,n,s,o){if(super(),this.baseApis=e,this.userId=t,this.deviceId=i,this.clientStore=n,this.cryptoStore=s,this.trustCrossSignedDevices=!0,this.lastOneTimeKeyCheck=null,this.oneTimeKeyCheckInProgress=!1,this.roomEncryptors=new Map,this.roomDecryptors=new Map,this.deviceKeys={},this.globalBlacklistUnverifiedDevices=!1,this.globalErrorOnUnknownDevices=!0,this.receivedRoomKeyRequests=[],this.receivedRoomKeyRequestCancellations=[],this.processingRoomKeyRequests=!1,this.lazyLoadMembers=!1,this.roomDeviceTrackingState={},this.forceNewSessionRetryTime=new $e(()=>new $e(()=>0)),this.sendKeyRequestsImmediately=!1,this.onDeviceListUserCrossSigningUpdated=async l=>{if(l===this.userId){const u=this.deviceList.getStoredCrossSigningForUser(l),h=u?u.getId():null,f=this.crossSigningInfo.getId();f&&h&&!(f!==h)?await this.checkOwnCrossSigningTrust():(this.storeTrustedSelfKeys(null),this.emit("crossSigning.keysChanged",{}),this.emit("userTrustStatusChanged",this.userId,this.checkUserTrust(l)))}else{await this.checkDeviceVerifications(l);const u=this.deviceList.getStoredCrossSigningForUser(l);u&&(u.updateCrossSigningVerifiedBefore(this.checkUserTrust(l).isCrossSigningVerified()),this.deviceList.setRawStoredCrossSigningForUser(l,u.toStorage())),this.emit("userTrustStatusChanged",l,this.checkUserTrust(l))}},this.onMembership=(l,u,h)=>{try{this.onRoomMembership(l,u,h)}catch(f){d.error("Error handling membership change:",f)}},this.onToDeviceEvent=l=>{try{d.log(`received to-device ${l.getType()} from: ${l.getSender()} id: ${l.getContent()[ut]}`),l.getType()=="m.room_key"||l.getType()=="m.forwarded_room_key"?this.onRoomKeyEvent(l):l.getType()=="m.room_key_request"?this.onRoomKeyRequestEvent(l):l.getType()==="m.secret.request"?this.secretStorage.onRequestReceived(l):l.getType()==="m.secret.send"?this.secretStorage.onSecretReceived(l):l.getType()==="m.room_key.withheld"?this.onRoomKeyWithheldEvent(l):l.getContent().transaction_id?this.onKeyVerificationMessage(l):l.getContent().msgtype==="m.bad.encrypted"?this.onToDeviceBadEncrypted(l):(l.isBeingDecrypted()||l.shouldAttemptDecryption())&&(l.isBeingDecrypted()||l.attemptDecryption(this),l.once(be.Decrypted,u=>{this.onToDeviceEvent(u)}))}catch(u){d.error("Error handling toDeviceEvent:",u)}},this.onTimelineEvent=(l,u,h,f,{liveEvent:g=!0}={})=>{if(!Ze.validateEvent(l,this.baseApis))return;const m=v=>{const S=new Ze(this.baseApis,v.getRoomId());return new Wi(S,this.verificationMethods,this.baseApis)};this.handleVerificationEvent(l,this.inRoomVerificationRequests,m,g)},d.debug("Crypto: initialising roomlist..."),this.roomList=new Xy(s),this.reEmitter=new qn(this),o){this.verificationMethods=new Map;for(const l of o)typeof l=="string"?Ao[l]&&this.verificationMethods.set(l,Ao[l]):l.NAME?this.verificationMethods.set(l.NAME,l):d.warn(`Excluding unknown verification method ${l}`)}else this.verificationMethods=new Map(Object.entries(Ao));this.backupManager=new Qi(e,async()=>{const l=await this.getSessionBackupPrivateKey();if(l)return l;const u=await this.secretStorage.get("m.megolm_backup.v1");if(u){const h=ws(u);if(h){const f=await this.secretStorage.getKey();await this.secretStorage.store("m.megolm_backup.v1",h,[f[0]])}return tt(h||u)}if(this.baseApis.cryptoCallbacks&&this.baseApis.cryptoCallbacks.getBackupKey)return this.baseApis.cryptoCallbacks.getBackupKey();throw new Error("Unable to get private key")}),this.olmDevice=new Tl(s),this.deviceList=new Jv(e,s,this.olmDevice),this.deviceList.on("userCrossSigningUpdated",this.onDeviceListUserCrossSigningUpdated),this.reEmitter.reEmit(this.deviceList,["crypto.devicesUpdated","crypto.willUpdateDevices"]),this.supportedAlgorithms=Array.from(ka.keys()),this.outgoingRoomKeyRequestManager=new ny(e,this.deviceId,this.cryptoStore),this.toDeviceVerificationRequests=new jy,this.inRoomVerificationRequests=new Vy;const a=this.baseApis.cryptoCallbacks||{},c=Ou(s,this.olmDevice);this.crossSigningInfo=new Ut(t,a,c),this.secretStorage=new fy(e,a,e),this.dehydrationManager=new Gy(this),!a.getCrossSigningKey&&a.getSecretStorageKey&&(a.getCrossSigningKey=async l=>Ut.getFromSecretStorage(l,this.secretStorage))}static getOlmVersion(){return Tl.getOlmVersion()}async init({exportedOlmDevice:e,pickleKey:t}={}){d.log("Crypto: initialising Olm..."),await as.Olm.init(),d.log(e?"Crypto: initialising Olm device from exported device...":"Crypto: initialising Olm device..."),await this.olmDevice.init({fromExportedDevice:e,pickleKey:t}),d.log("Crypto: loading device list..."),await this.deviceList.load(),this.deviceKeys["ed25519:"+this.deviceId]=this.olmDevice.deviceEd25519Key,this.deviceKeys["curve25519:"+this.deviceId]=this.olmDevice.deviceCurve25519Key,d.log("Crypto: fetching own devices...");let i=this.deviceList.getRawStoredDevicesForUser(this.userId);if(i||(i={}),!i[this.deviceId]){d.log("Crypto: adding this device to the store...");const n={keys:this.deviceKeys,algorithms:this.supportedAlgorithms,verified:Zt.VERIFIED,known:!0};i[this.deviceId]=n,this.deviceList.storeDevicesForUser(this.userId,i),this.deviceList.saveIfDirty()}await this.cryptoStore.doTxn("readonly",[z.STORE_ACCOUNT],n=>{this.cryptoStore.getCrossSigningKeys(n,s=>{s&&Object.keys(s).length!==0&&(d.log("Loaded cross-signing public keys from crypto store"),this.crossSigningInfo.setKeys(s))})}),this.deviceList.startTrackingDeviceList(this.userId),d.debug("Crypto: initialising roomlist..."),await this.roomList.init(),d.log("Crypto: checking for key backup..."),this.backupManager.checkAndStart()}getVersion(){const e=$s.getOlmVersion();return`Olm ${e[0]}.${e[1]}.${e[2]}`}getTrustCrossSignedDevices(){return this.trustCrossSignedDevices}getCryptoTrustCrossSignedDevices(){return this.trustCrossSignedDevices}setTrustCrossSignedDevices(e){this.trustCrossSignedDevices=e;for(const t of this.deviceList.getKnownUserIds()){const i=this.deviceList.getRawStoredDevicesForUser(t);for(const n of Object.keys(i)){const s=this.checkDeviceTrust(t,n);if(!s.isLocallyVerified()&&s.isCrossSigningVerified()){const o=this.deviceList.getStoredDevice(t,n);this.emit("deviceVerificationChanged",t,n,o)}}}}setCryptoTrustCrossSignedDevices(e){this.setTrustCrossSignedDevices(e)}async createRecoveryKeyFromPassphrase(e){const t=new as.Olm.PkDecryption;try{if(e){const i=await nc(e);t.init_with_private_key(i.key);const n=t.get_private_key();return{keyInfo:{passphrase:{algorithm:"m.pbkdf2",iterations:i.iterations,salt:i.salt}},privateKey:n,encodedPrivateKey:La(n)}}else{t.generate_key();const i=t.get_private_key();return{privateKey:i,encodedPrivateKey:La(i)}}}finally{t==null||t.free()}}async userHasCrossSigningKeys(e=this.userId){return await this.downloadKeys([e]),this.deviceList.getStoredCrossSigningForUser(e)!==null}async isCrossSigningReady(){const e=this.crossSigningInfo.getId(),t=await this.crossSigningInfo.isStoredInKeyCache()||await this.crossSigningInfo.isStoredInSecretStorage(this.secretStorage);return!!(e&&t)}async isSecretStorageReady(){const e=await this.secretStorage.hasKey(),t=await this.crossSigningInfo.isStoredInSecretStorage(this.secretStorage),i=!this.backupManager.getKeyBackupEnabled()||await this.baseApis.isKeyBackupKeyStored();return!!(e&&t&&i)}async getCrossSigningStatus(){var a,c,l;const e=!!this.crossSigningInfo.getId(),t=!!await this.crossSigningInfo.isStoredInSecretStorage(this.secretStorage),i=this.crossSigningInfo.getCacheCallbacks(),n=!!await((a=i.getCrossSigningKeyCache)==null?void 0:a.call(i,"master")),s=!!await((c=i.getCrossSigningKeyCache)==null?void 0:c.call(i,"self_signing")),o=!!await((l=i.getCrossSigningKeyCache)==null?void 0:l.call(i,"user_signing"));return{publicKeysOnDevice:e,privateKeysInSecretStorage:t,privateKeysCachedLocally:{masterKey:n,selfSigningKey:s,userSigningKey:o}}}async bootstrapCrossSigning({authUploadDeviceSigningKeys:e,setupNewCrossSigning:t}={}){d.log("Bootstrapping cross-signing");const i=this.baseApis.cryptoCallbacks,n=new Ml(this.baseApis.store.accountData,i),s=new Ut(this.userId,n.crossSigningCallbacks,n.crossSigningCallbacks),o=async()=>{s.resetKeys(),await this.signObject(s.keys.master),n.addCrossSigningKeys(e,s.keys);const g=this.deviceList.getStoredDevice(this.userId,this.deviceId),m=await s.signDevice(this.userId,g);n.addKeySignature(this.userId,this.deviceId,m),this.backupManager.backupInfo&&(await s.signObject(this.backupManager.backupInfo.auth_data,"master"),n.addSessionBackup(this.backupManager.backupInfo))},a=this.crossSigningInfo.getId(),c=await this.crossSigningInfo.isStoredInKeyCache(),l=await this.crossSigningInfo.isStoredInSecretStorage(this.secretStorage),u=c||l;d.log({setupNewCrossSigning:t,publicKeysOnDevice:a,privateKeysInCache:c,privateKeysInStorage:l,privateKeysExistSomewhere:u}),!u||t?(d.log("Cross-signing private keys not found locally or in secret storage, creating new keys"),await o()):a&&c?d.log("Cross-signing public keys trusted and private keys found locally"):l&&(d.log("Cross-signing private keys not found locally, but they are available in secret storage, reading storage and caching locally"),await this.checkOwnCrossSigningTrust({allowPrivateKeyRequests:!0}));const h=n.crossSigningCallbacks.privateKeys;if(h.size&&!this.baseApis.cryptoCallbacks.saveCrossSigningKeys){const g=new Ns(n.accountDataClientAdapter,n.ssssCryptoCallbacks);await g.hasKey()&&(d.log("Storing new cross-signing private keys in secret storage"),await Ut.storeInSecretStorage(h,g))}await n.buildOperation().apply(this),await n.persist(this),d.log("Cross-signing ready")}async bootstrapSecretStorage({createSecretStorageKey:e=async()=>({}),keyBackupInfo:t,setupNewKeyBackup:i,setupNewSecretStorage:n,getKeyBackupPassphrase:s}={}){d.log("Bootstrapping Secure Secret Storage");const o=this.baseApis.cryptoCallbacks,a=new Ml(this.baseApis.store.accountData,o),c=new Ns(a.accountDataClientAdapter,a.ssssCryptoCallbacks);let l=null;const u=async _=>{const{keyId:C,keyInfo:A}=await c.addKey(si,_);return a.ssssCryptoCallbacks.addPrivateKey(C,A,_.key),await c.setDefaultKeyId(C),C},h=async(_,C)=>{var A,y;if(!C.mac){const $=await((y=(A=this.baseApis.cryptoCallbacks).getSecretStorageKey)==null?void 0:y.call(A,{keys:{[_]:C}},""));if($){const X=$[1];a.ssssCryptoCallbacks.addPrivateKey(_,C,X);const{iv:le,mac:ne}=await kn(X);C.iv=le,C.mac=ne,await a.setAccountData(`m.secret_storage.key.${_}`,C)}}},f=async _=>{if(this.crossSigningInfo.getId()&&await this.crossSigningInfo.isStoredInKeyCache("master"))try{d.log("Adding cross-signing signature to key backup"),await this.crossSigningInfo.signObject(_,"master")}catch(C){d.error("Signing key backup with cross-signing keys failed",C)}else d.warn("Cross-signing keys not available, skipping signature on key backup")},g=await this.secretStorage.getKey(),[m,v]=g||[null,null],S=!n&&v&&v.algorithm===si;if(d.log({keyBackupInfo:t,setupNewKeyBackup:i,setupNewSecretStorage:n,storageExists:S,oldKeyInfo:v}),!S&&!t){d.log("Secret storage does not exist, creating new storage key");const{keyInfo:_,privateKey:C}=await e();l=await u({passphrase:_==null?void 0:_.passphrase,key:C,name:_==null?void 0:_.name})}else if(!S&&t){d.log("Secret storage does not exist, using key backup key");const _=await this.getSessionBackupPrivateKey()||await(s==null?void 0:s()),C={key:_};t.auth_data.private_key_salt&&t.auth_data.private_key_iterations&&(C.passphrase={algorithm:"m.pbkdf2",iterations:t.auth_data.private_key_iterations,salt:t.auth_data.private_key_salt,bits:256}),l=await u(C),await c.store("m.megolm_backup.v1",lt(_),[l]),await f(t.auth_data),a.addSessionBackup(t)}else d.log("Secret storage exists"),v&&v.algorithm===si&&await h(m,v);if(!this.baseApis.cryptoCallbacks.saveCrossSigningKeys&&await this.isCrossSigningReady()&&(l||!await this.crossSigningInfo.isStoredInSecretStorage(c))){d.log("Copying cross-signing private keys from cache to secret storage");const _=await this.crossSigningInfo.getCrossSigningKeysFromCache();await Ut.storeInSecretStorage(_,c)}if(i&&!t){d.log("Creating new message key backup version");const _=await this.baseApis.prepareKeyBackupVersion(null,{secureSecretStorage:!1}),C=Es(_.recovery_key);await c.store("m.megolm_backup.v1",lt(C));const A={algorithm:_.algorithm,auth_data:_.auth_data};await f(A.auth_data),await this.signObject(A.auth_data),a.addSessionBackup(A)}const w=await c.get("m.megolm_backup.v1");if(w){d.info("Got session backup key from secret storage: caching");const _=ws(w);if(_){const A=l||m;await c.store("m.megolm_backup.v1",_,A?[A]:null)}const C=new Uint8Array(tt(_||w));a.addSessionBackupPrivateKeyToCache(C)}else if(this.backupManager.getKeyBackupEnabled()){const _=await this.getSessionBackupPrivateKey()||await(s==null?void 0:s());if(!_){d.error("Key backup is enabled but couldn't get key backup key!");return}d.info("Got session backup key from cache/user that wasn't in SSSS: saving to SSSS"),await c.store("m.megolm_backup.v1",lt(_))}await a.buildOperation().apply(this),await a.persist(this),d.log("Secure Secret Storage ready")}async resetKeyBackup(){await this.backupManager.deleteAllKeyBackupVersions();const e=await this.backupManager.prepareKeyBackupVersion();await this.signObject(e.auth_data);const{version:t}=await this.baseApis.http.authedRequest(D.Post,"/room_keys/version",void 0,e,{prefix:Pe.V3});d.log(`Created backup version ${t}`);const i=e.privateKey;await this.secretStorage.store("m.megolm_backup.v1",lt(i)),await this.storeSessionBackupPrivateKey(i),await this.backupManager.checkAndStart(),await this.backupManager.scheduleAllGroupSessionsForBackup()}async deleteKeyBackupVersion(e){await this.backupManager.deleteKeyBackupVersion(e)}addSecretStorageKey(e,t,i){return this.secretStorage.addKey(e,t,i)}hasSecretStorageKey(e){return this.secretStorage.hasKey(e)}getSecretStorageKey(e){return this.secretStorage.getKey(e)}storeSecret(e,t,i){return this.secretStorage.store(e,t,i)}getSecret(e){return this.secretStorage.get(e)}isSecretStored(e){return this.secretStorage.isStored(e)}requestSecret(e,t){return t||(t=Object.keys(this.deviceList.getRawStoredDevicesForUser(this.userId))),this.secretStorage.request(e,t)}getDefaultSecretStorageKeyId(){return this.secretStorage.getDefaultKeyId()}setDefaultSecretStorageKeyId(e){return this.secretStorage.setDefaultKeyId(e)}checkSecretStorageKey(e,t){return this.secretStorage.checkKey(e,t)}checkSecretStoragePrivateKey(e,t){let i=null;try{return i=new as.Olm.PkDecryption,i.init_with_private_key(e)===t}finally{i==null||i.free()}}async getSessionBackupPrivateKey(){const e=await new Promise(i=>{this.cryptoStore.doTxn("readonly",[z.STORE_ACCOUNT],n=>{this.cryptoStore.getSecretStorePrivateKey(n,i,"m.megolm_backup.v1")})});let t=null;if(typeof e=="string"&&(t=new Uint8Array(tt(ws(e)||e)),await this.storeSessionBackupPrivateKey(t)),e&&typeof e=="object"&&"ciphertext"in e){const i=Buffer.from(this.olmDevice.pickleKey),n=await jr(e,i,"m.megolm_backup.v1");t=tt(n)}return t}async storeSessionBackupPrivateKey(e,t){if(!(e instanceof Uint8Array))throw new Error(`storeSessionBackupPrivateKey expects Uint8Array, got ${e}`);const i=Buffer.from(this.olmDevice.pickleKey),n=await Vn(lt(e),i,"m.megolm_backup.v1");return this.cryptoStore.doTxn("readwrite",[z.STORE_ACCOUNT],s=>{this.cryptoStore.storeSecretStorePrivateKey(s,"m.megolm_backup.v1",n)})}async getActiveSessionBackupVersion(){return this.backupManager.getKeyBackupEnabled()?this.backupManager.version??null:null}async isKeyBackupTrusted(e){const t=await this.backupManager.isKeyBackupTrusted(e);return xl(t)}async checkKeyBackupAndEnable(){const e=await this.backupManager.checkKeyBackup();return!e||!e.backupInfo?null:{backupInfo:e.backupInfo,trustInfo:xl(e.trustInfo)}}checkCrossSigningPrivateKey(e,t){let i=null;try{return i=new as.Olm.PkSigning,i.init_with_seed(e)===t}finally{i==null||i.free()}}async afterCrossSigningLocalKeyChange(){d.info("Starting cross-signing key change post-processing");const e=this.deviceList.getStoredDevice(this.userId,this.deviceId),t=await this.crossSigningInfo.signDevice(this.userId,e);d.info(`Starting background key sig upload for ${this.deviceId}`);const i=({shouldEmit:s=!1})=>this.baseApis.uploadKeySignatures({[this.userId]:{[this.deviceId]:t}}).then(o=>{const{failures:a}=o||{};if(Object.keys(a||[]).length>0)throw s&&this.baseApis.emit("crypto.keySignatureUploadFailure",a,"afterCrossSigningLocalKeyChange",i),new ts("Key upload failed",{failures:a});d.info(`Finished background key sig upload for ${this.deviceId}`)}).catch(o=>{d.error(`Error during background key sig upload for ${this.deviceId}`,o)});i({shouldEmit:!0});const n=this.baseApis.cryptoCallbacks.shouldUpgradeDeviceVerifications;if(n){d.info("Starting device verification upgrade");const s={};for(const[o,a]of Object.entries(this.deviceList.crossSigningInfo)){const c=await this.checkForDeviceVerificationUpgrade(o,Ut.fromStorage(a,o));c&&(s[o]=c)}if(Object.keys(s).length>0){d.info(`Found ${Object.keys(s).length} verif users to upgrade`);try{const o=await n({users:s});if(o)for(const a of o)a in s&&await this.baseApis.setDeviceVerified(a,s[a].crossSigningInfo.getId())}catch(o){d.log("shouldUpgradeDeviceVerifications threw an error: not upgrading",o)}}d.info("Finished device verification upgrade")}d.info("Finished cross-signing key change post-processing")}async checkForDeviceVerificationUpgrade(e,t){const i=this.crossSigningInfo.checkUserTrust(t);if(t.firstUse&&!i.isVerified()){const n=this.deviceList.getRawStoredDevicesForUser(e),s=await this.checkForValidDeviceSignature(e,t.keys.master,n);if(s.length)return{devices:s.map(o=>ht.fromStorage(n[o],o)),crossSigningInfo:t}}}async checkForValidDeviceSignature(e,t,i){const n=[];if(i&&t.signatures&&t.signatures[e])for(const s of Object.keys(t.signatures[e])){const[,o]=s.split(":",2);if(o in i&&i[o].verified===Zt.VERIFIED)try{await Dn(this.olmDevice,t,e,o,i[o].keys[s]),n.push(o)}catch{}}return n}getCrossSigningKeyId(e=ec.Master){return Promise.resolve(this.getCrossSigningId(e))}getCrossSigningId(e){return this.crossSigningInfo.getId(e)}getStoredCrossSigningForUser(e){return this.deviceList.getStoredCrossSigningForUser(e)}checkUserTrust(e){const t=this.deviceList.getStoredCrossSigningForUser(e);return t?this.crossSigningInfo.checkUserTrust(t):new Ss(!1,!1,!1)}async getUserVerificationStatus(e){return this.checkUserTrust(e)}async getDeviceVerificationStatus(e,t){const i=this.deviceList.getStoredDevice(e,t);return i?this.checkDeviceInfoTrust(e,i):null}checkDeviceTrust(e,t){const i=this.deviceList.getStoredDevice(e,t);return this.checkDeviceInfoTrust(e,i)}checkDeviceInfoTrust(e,t){const i=!!(t!=null&&t.isVerified()),n=this.deviceList.getStoredCrossSigningForUser(e);if(t&&n){const s=this.trustCrossSignedDevices||e===this.userId;return this.crossSigningInfo.checkDeviceTrust(n,t,i,s)}else return new On(!1,!1,i,!1)}checkIfOwnDeviceCrossSigned(e){const t=this.deviceList.getStoredDevice(this.userId,e);if(!t)return!1;const i=this.deviceList.getStoredCrossSigningForUser(this.userId);return(i==null?void 0:i.checkDeviceTrust(i,t,!1,!0).isCrossSigningVerified())??!1}async checkOwnCrossSigningTrust({allowPrivateKeyRequests:e=!1}={}){const t=this.userId;await this.downloadKeys([this.userId]);const i=await this.crossSigningInfo.getCrossSigningKeysFromCache(),n=this.deviceList.getStoredCrossSigningForUser(t);if(!n){d.error("Got cross-signing update event for user "+t+" but no new cross-signing information found!");return}const s=n.getId(),o=this.crossSigningInfo.getId()!==s,a=n.getId()&&!i.has("master");if(o&&d.info("Got new master public key",s),e&&(o||a)){d.info("Attempting to retrieve cross-signing master private key");let S=null;try{S=(await this.crossSigningInfo.getCrossSigningKey("master",s))[1],d.info("Got cross-signing master private key")}finally{S==null||S.free()}}const c=this.crossSigningInfo.getId("self_signing"),l=this.crossSigningInfo.getId("user_signing");this.storeTrustedSelfKeys(n.keys);const u=c!==n.getId("self_signing"),h=l!==n.getId("user_signing"),f=n.getId("self_signing")&&!i.has("self_signing"),g=n.getId("user_signing")&&!i.has("user_signing"),m={};if(u&&d.info("Got new self-signing key",n.getId("self_signing")),e&&(u||f)){d.info("Attempting to retrieve cross-signing self-signing private key");let S=null;try{S=(await this.crossSigningInfo.getCrossSigningKey("self_signing",n.getId("self_signing")))[1],d.info("Got cross-signing self-signing private key")}finally{S==null||S.free()}const w=this.deviceList.getStoredDevice(this.userId,this.deviceId),M=await this.crossSigningInfo.signDevice(this.userId,w);m[this.deviceId]=M}if(h&&d.info("Got new user-signing key",n.getId("user_signing")),e&&(h||g)){d.info("Attempting to retrieve cross-signing user-signing private key");let S=null;try{S=(await this.crossSigningInfo.getCrossSigningKey("user_signing",n.getId("user_signing")))[1],d.info("Got cross-signing user-signing private key")}finally{S==null||S.free()}}if(o){const S=this.crossSigningInfo.keys.master;await this.signObject(S);const w=S.signatures[this.userId]["ed25519:"+this.deviceId];m[this.crossSigningInfo.getId()]=Object.assign({},S,{signatures:{[this.userId]:{["ed25519:"+this.deviceId]:w}}})}const v=Object.keys(m);if(v.length){const S=({shouldEmit:w=!1})=>(d.info(`Starting background key sig upload for ${v}`),this.baseApis.uploadKeySignatures({[this.userId]:m}).then(M=>{const{failures:_}=M||{};if(d.info(`Finished background key sig upload for ${v}`),Object.keys(_||[]).length>0)throw w&&this.baseApis.emit("crypto.keySignatureUploadFailure",_,"checkOwnCrossSigningTrust",S),new ts("Key upload failed",{failures:_})}).catch(M=>{d.error(`Error during background key sig upload for ${v}`,M)}));S({shouldEmit:!0})}this.emit("userTrustStatusChanged",t,this.checkUserTrust(t)),o&&(this.emit("crossSigning.keysChanged",{}),await this.afterCrossSigningLocalKeyChange()),await this.backupManager.checkKeyBackup()}async getBackupDecryptor(e,t){if(!(t instanceof Uint8Array))throw new Error("getBackupDecryptor expects Uint8Array");const i=await Qi.makeAlgorithm(e,async()=>t);return await i.keyMatches(t)?new Qy(i):Promise.reject(new Et({errcode:Pr.RESTORE_BACKUP_ERROR_BAD_KEY}))}importBackedUpRoomKeys(e,t={}){return t.source="backup",this.importRoomKeys(e,t)}async storeTrustedSelfKeys(e){e?this.crossSigningInfo.setKeys(e):this.crossSigningInfo.clearKeys(),await this.cryptoStore.doTxn("readwrite",[z.STORE_ACCOUNT],t=>{this.cryptoStore.storeCrossSigningKeys(t,this.crossSigningInfo.keys)})}async checkDeviceVerifications(e){const t=this.baseApis.cryptoCallbacks.shouldUpgradeDeviceVerifications;if(t){if(d.info(`Starting device verification upgrade for ${e}`),this.crossSigningInfo.keys.user_signing){const i=this.deviceList.getStoredCrossSigningForUser(e);if(i){const n=await this.checkForDeviceVerificationUpgrade(e,i);n&&(await t({users:{[e]:n}})).includes(e)&&await this.baseApis.setDeviceVerified(e,i.getId())}}d.info(`Finished device verification upgrade for ${e}`)}}enableLazyLoading(){this.lazyLoadMembers=!0}registerEventHandlers(e){e.on(Nt.Membership,this.onMembership),e.on(ie.ToDeviceEvent,this.onToDeviceEvent),e.on(de.Timeline,this.onTimelineEvent),e.on(be.Decrypted,this.onTimelineEvent)}start(){d.warn("MatrixClient.crypto.start() is deprecated")}stop(){this.outgoingRoomKeyRequestManager.stop(),this.deviceList.stop(),this.dehydrationManager.stop(),this.backupManager.stop()}getDeviceEd25519Key(){return this.olmDevice.deviceEd25519Key}getDeviceCurve25519Key(){return this.olmDevice.deviceCurve25519Key}async getOwnDeviceKeys(){if(!this.olmDevice.deviceCurve25519Key)throw new Error("Curve25519 key not yet created");if(!this.olmDevice.deviceEd25519Key)throw new Error("Ed25519 key not yet created");return{ed25519:this.olmDevice.deviceEd25519Key,curve25519:this.olmDevice.deviceCurve25519Key}}setGlobalBlacklistUnverifiedDevices(e){this.globalBlacklistUnverifiedDevices=e}getGlobalBlacklistUnverifiedDevices(){return this.globalBlacklistUnverifiedDevices}uploadDeviceKeys(){const e={algorithms:this.supportedAlgorithms,device_id:this.deviceId,keys:this.deviceKeys,user_id:this.userId};return this.signObject(e).then(()=>this.baseApis.uploadKeysRequest({device_keys:e}))}getNeedsNewFallback(){return!!this.needsNewFallback}maybeUploadOneTimeKeys(){if(this.oneTimeKeyCheckInProgress)return;const i=Date.now();if(this.lastOneTimeKeyCheck!==null&&i-this.lastOneTimeKeyCheck<6e4)return;this.lastOneTimeKeyCheck=i;const n=this.olmDevice.maxNumberOfOneTimeKeys(),s=Math.floor(n/2),o=async a=>{for(;s>a||this.getNeedsNewFallback();){if(s>a){d.info("generating oneTimeKeys");const l=Math.min(s-a,5);await this.olmDevice.generateOneTimeKeys(l)}if(this.getNeedsNewFallback()){const l=await this.olmDevice.getFallbackKey();(!l.curve25519||Object.keys(l.curve25519).length==0)&&(d.info("generating fallback key"),this.fallbackCleanup&&(clearTimeout(this.fallbackCleanup),delete this.fallbackCleanup),await this.olmDevice.generateFallbackKey())}d.info("calling uploadOneTimeKeys");const c=await this.uploadOneTimeKeys();if(c.one_time_key_counts&&c.one_time_key_counts.signed_curve25519)a=c.one_time_key_counts.signed_curve25519;else throw new Error("response for uploading keys does not contain one_time_key_counts.signed_curve25519")}};this.oneTimeKeyCheckInProgress=!0,Promise.resolve().then(()=>this.oneTimeKeyCount!==void 0?Promise.resolve(this.oneTimeKeyCount):this.baseApis.uploadKeysRequest({}).then(a=>a.one_time_key_counts.signed_curve25519||0)).then(a=>o(a)).catch(a=>{d.error("Error uploading one-time keys",a.stack||a)}).finally(()=>{this.oneTimeKeyCount=void 0,this.oneTimeKeyCheckInProgress=!1})}async uploadOneTimeKeys(){const e=[];let t;if(this.getNeedsNewFallback()){t={};const a=await this.olmDevice.getFallbackKey();for(const[c,l]of Object.entries(a.curve25519)){const u={key:l,fallback:!0};t["signed_curve25519:"+c]=u,e.push(this.signObject(u))}this.needsNewFallback=!1}const i=await this.olmDevice.getOneTimeKeys(),n={};for(const a in i.curve25519)if(i.curve25519.hasOwnProperty(a)){const c={key:i.curve25519[a]};n["signed_curve25519:"+a]=c,e.push(this.signObject(c))}await Promise.all(e);const s={one_time_keys:n};t&&(s["org.matrix.msc2732.fallback_keys"]=t,s.fallback_keys=t);const o=await this.baseApis.uploadKeysRequest(s);return t&&(this.fallbackCleanup=setTimeout(()=>{delete this.fallbackCleanup,this.olmDevice.forgetOldFallbackKey()},60*60*1e3)),await this.olmDevice.markKeysAsPublished(),o}downloadKeys(e,t){return this.deviceList.downloadKeys(e,!!t)}getStoredDevicesForUser(e){return this.deviceList.getStoredDevicesForUser(e)}async getUserDeviceInfo(e,t=!1){const i=new Map,n=[];for(const s of e){const o=await this.getStoredDevicesForUser(s);if(o){const a=new Map(o.map(c=>[c.deviceId,ql(c,s)]));i.set(s,a)}else n.push(s)}return t&&n.length>0&&(await this.downloadKeys(n)).forEach((o,a)=>{const c=new Map;o.forEach((l,u)=>c.set(u,ql(l,a))),i.set(a,c)}),i}getStoredDevice(e,t){return this.deviceList.getStoredDevice(e,t)}saveDeviceList(e){return this.deviceList.saveIfDirty(e)}async setDeviceVerified(e,t,i=!0){await this.setDeviceVerification(e,t,i)}async crossSignDevice(e){await this.setDeviceVerified(this.userId,e,!0)}async setDeviceVerification(e,t,i=null,n=null,s=null,o){const a=this.deviceList.getStoredCrossSigningForUser(e);if((a==null?void 0:a.getId())===t){if(n!==null||s!==null)throw new Error("Cannot set blocked or known for a cross-signing key");if(!i)throw new Error("Cannot set a cross-signing key as unverified");const g=o?Object.values(o)[0]:null;if(o&&(Object.values(o).length!==1||g!==a.getId()))throw new Error(`Key did not match expected value: expected ${a.getId()}, got ${g}`);if(!this.crossSigningInfo.getId()&&e===this.crossSigningInfo.userId&&(this.storeTrustedSelfKeys(a.keys),this.emit("userTrustStatusChanged",this.userId,this.checkUserTrust(e))),e!==this.userId){d.info("Master key "+a.getId()+" for "+e+" marked verified. Signing...");const m=await this.crossSigningInfo.signUser(a);if(m){const v=async({shouldEmit:S=!1})=>{d.info("Uploading signature for "+e+"...");const w=await this.baseApis.uploadKeySignatures({[e]:{[t]:m}}),{failures:M}=w||{};if(Object.keys(M||[]).length>0)throw S&&this.baseApis.emit("crypto.keySignatureUploadFailure",M,"setDeviceVerification",v),new ts("Key upload failed",{failures:M})};await v({shouldEmit:!0})}return m}else return a}const c=this.deviceList.getRawStoredDevicesForUser(e);if(!c||!c[t])throw new Error("Unknown device "+e+":"+t);const l=c[t];let u=l.verified;if(i){if(o){for(const[g,m]of Object.entries(o))if(l.keys[g]!==m)throw new Error(`Key did not match expected value: expected ${m}, got ${l.keys[g]}`)}u=Zt.VERIFIED}else i!==null&&u==Zt.VERIFIED&&(u=Zt.UNVERIFIED);n?u=Zt.BLOCKED:n!==null&&u==Zt.BLOCKED&&(u=Zt.UNVERIFIED);let h=l.known;if(s!==null&&(h=s),(l.verified!==u||l.known!==h)&&(l.verified=u,l.known=h,this.deviceList.storeDevicesForUser(e,c),this.deviceList.saveIfDirty()),i&&e===this.userId){d.info("Own device "+t+" marked verified: signing");let g;if(this.checkDeviceTrust(e,t).isCrossSigningVerified()?d.log(`Own device ${t} already cross-signing verified`):g=await this.crossSigningInfo.signDevice(e,ht.fromStorage(l,t)),g){const v=async({shouldEmit:S=!1})=>{d.info("Uploading signature for "+t);const w=await this.baseApis.uploadKeySignatures({[e]:{[t]:g}}),{failures:M}=w||{};if(Object.keys(M||[]).length>0)throw S&&this.baseApis.emit("crypto.keySignatureUploadFailure",M,"setDeviceVerification",v),new ts("Key upload failed",{failures:M})};await v({shouldEmit:!0})}}const f=ht.fromStorage(l,t);return this.emit("deviceVerificationChanged",e,t,f),f}findVerificationRequestDMInProgress(e,t){return this.inRoomVerificationRequests.findRequestInProgress(e,t)}getVerificationRequestsToDeviceInProgress(e){return this.toDeviceVerificationRequests.getRequestsInProgress(e)}requestVerificationDM(e,t){const i=this.inRoomVerificationRequests.findRequestInProgress(t);if(i)return Promise.resolve(i);const n=new Ze(this.baseApis,t,e);return this.requestVerificationWithChannel(e,n,this.inRoomVerificationRequests)}requestVerification(e,t){t||(t=Object.keys(this.deviceList.getRawStoredDevicesForUser(e)));const i=this.toDeviceVerificationRequests.findRequestInProgress(e,t);if(i)return Promise.resolve(i);const n=new Xe(this.baseApis,e,t,Xe.makeTransactionId());return this.requestVerificationWithChannel(e,n,this.toDeviceVerificationRequests)}requestOwnUserVerification(){return this.requestVerification(this.userId)}requestDeviceVerification(e,t){return this.requestVerification(e,[t])}async requestVerificationWithChannel(e,t,i){let n=new Wi(t,this.verificationMethods,this.baseApis);t.transactionId&&i.setRequestByChannel(t,n),await n.sendRequest();const s=i.getRequestByChannel(t);return s?n=s:(d.log(`Crypto: adding new request to requestsByTxnId with id ${t.transactionId} ${t.roomId}`),i.setRequestByChannel(t,n)),n}beginKeyVerification(e,t,i,n=null){let s;if(n){if(s=this.toDeviceVerificationRequests.getRequestBySenderAndTxnId(t,n),!s)throw new Error(`No request found for user ${t} with transactionId ${n}`)}else{n=Xe.makeTransactionId();const o=new Xe(this.baseApis,t,[i],n,i);s=new Wi(o,this.verificationMethods,this.baseApis),this.toDeviceVerificationRequests.setRequestBySenderAndTxnId(t,n,s)}return s.beginKeyVerification(e,{userId:t,deviceId:i})}async legacyDeviceVerification(e,t,i){const n=Xe.makeTransactionId(),s=new Xe(this.baseApis,e,[t],n,t),o=new Wi(s,this.verificationMethods,this.baseApis);this.toDeviceVerificationRequests.setRequestBySenderAndTxnId(e,n,o);const a=o.beginKeyVerification(i,{userId:e,deviceId:t});return await Promise.race([a.verify(),o.waitFor(c=>c.started)]),o}async getOlmSessionsForUser(e){const t=this.getStoredDevicesForUser(e)||[],i={};for(const n of t){const s=n.getIdentityKey(),o=await this.olmDevice.getSessionInfoForDevice(s);i[n.deviceId]={deviceIdKey:s,sessions:o}}return i}getEventSenderDeviceInfo(e){const t=e.getSenderKey(),i=e.getWireContent().algorithm;if(!t||!i||e.isKeySourceUntrusted())return null;const n=this.deviceList.getDeviceByIdentityKey(i,t);if(n===null)return null;const s=e.getClaimedEd25519Key();return s?s!==n.getFingerprint()?(d.warn("Event "+e.getId()+" claims ed25519 key "+s+" but sender device has key "+n.getFingerprint()),null):n:(d.warn("Event "+e.getId()+" claims no ed25519 key: cannot verify sending device"),null)}getEventEncryptionInfo(e){const t={};if(t.senderKey=e.getSenderKey()??void 0,t.algorithm=e.getWireContent().algorithm,!t.senderKey||!t.algorithm)return t.encrypted=!1,t;t.encrypted=!0,e.isKeySourceUntrusted()?t.authenticated=!1:t.authenticated=!0,t.sender=this.deviceList.getDeviceByIdentityKey(t.algorithm,t.senderKey)??void 0;const i=e.getClaimedEd25519Key();return i||(d.warn("Event "+e.getId()+" claims no ed25519 key: cannot verify sending device"),t.mismatchedSender=!0),t.sender&&i!==t.sender.getFingerprint()&&(d.warn("Event "+e.getId()+" claims ed25519 key "+i+"but sender device has key "+t.sender.getFingerprint()),t.mismatchedSender=!0),t}async getEncryptionInfoForEvent(e){const t=this.getEventEncryptionInfo(e);if(!t.encrypted)return null;const i=e.getSender();if(!i||t.mismatchedSender)return{shieldColour:wi.RED,shieldReason:Sn.MISMATCHED_SENDER_KEY};if(!this.checkUserTrust(i).isCrossSigningVerified())return t.authenticated?{shieldColour:wi.NONE,shieldReason:null}:{shieldColour:wi.GREY,shieldReason:Sn.AUTHENTICITY_NOT_GUARANTEED};const s=i&&t.sender&&await this.getDeviceVerificationStatus(i,t.sender.deviceId);return s?s.isVerified()?t.authenticated?{shieldColour:wi.NONE,shieldReason:null}:{shieldColour:wi.GREY,shieldReason:Sn.AUTHENTICITY_NOT_GUARANTEED}:{shieldColour:wi.RED,shieldReason:Sn.UNSIGNED_DEVICE}:{shieldColour:wi.GREY,shieldReason:Sn.UNKNOWN_DEVICE}}forceDiscardSession(e){const t=this.roomEncryptors.get(e);if(t===void 0)throw new Error("Room not encrypted");if(t.forceDiscardSession===void 0)throw new Error("Room encryption algorithm doesn't support session discarding");return t.forceDiscardSession(),Promise.resolve()}async setRoomEncryption(e,t,i){const n=this.clientStore.getRoom(e);if(!n)throw new Error(`Unable to enable encryption tracking devices in unknown room ${e}`);await this.setRoomEncryptionImpl(n,t),!this.lazyLoadMembers&&!i&&this.deviceList.refreshOutdatedDeviceLists()}async setRoomEncryptionImpl(e,t){const i=e.roomId;if(!t.algorithm){d.log("Ignoring setRoomEncryption with no algorithm");return}const n=this.roomList.getRoomEncryption(i);if(n&&JSON.stringify(n)!=JSON.stringify(t)){d.error("Ignoring m.room.encryption event which requests a change of config in "+i);return}if(this.roomEncryptors.get(i))return;let o=null;n||(o=this.roomList.setRoomEncryption(i,t));const a=Mu.get(t.algorithm);if(!a)throw new Error("Unable to encrypt with "+t.algorithm);const c=new a({userId:this.userId,deviceId:this.deviceId,crypto:this,olmDevice:this.olmDevice,baseApis:this.baseApis,roomId:i,config:t});if(this.roomEncryptors.set(i,c),o&&await o,d.log(`Enabling encryption in ${i}`),e.membersLoaded())await this.trackRoomDevicesImpl(e);else{const l=u=>{e.off(fe.Update,l),e.membersLoaded()&&this.trackRoomDevicesImpl(e).catch(h=>{d.error(`Error enabling device tracking in ${i}`,h)})};e.on(fe.Update,l)}}trackRoomDevices(e){const t=this.clientStore.getRoom(e);if(!t)throw new Error(`Unable to start tracking devices in unknown room ${e}`);return this.trackRoomDevicesImpl(t)}trackRoomDevicesImpl(e){const t=e.roomId,i=async()=>{if(!this.roomEncryptors.has(t))return;d.log(`Starting to track devices for room ${t} ...`),(await e.getEncryptionTargetMembers()).forEach(o=>{this.deviceList.startTrackingDeviceList(o.userId)})};let n=this.roomDeviceTrackingState[t];return n||(n=i(),this.roomDeviceTrackingState[t]=n.catch(s=>{throw delete this.roomDeviceTrackingState[t],s})),n}ensureOlmSessionsForUsers(e,t){const i=new Map;for(const n of e){const s=[];i.set(n,s);const o=this.getStoredDevicesForUser(n)||[];for(const a of o)a.getIdentityKey()!=this.olmDevice.deviceCurve25519Key&&a.verified!=Zt.BLOCKED&&s.push(a)}return di(this.olmDevice,this.baseApis,i,t)}async exportRoomKeys(){const e=[];return await this.cryptoStore.doTxn("readonly",[z.STORE_INBOUND_GROUP_SESSIONS],t=>{this.cryptoStore.getAllEndToEndInboundGroupSessions(t,i=>{if(i===null)return;const n=this.olmDevice.exportInboundGroupSession(i.senderKey,i.sessionId,i.sessionData);delete n.first_known_index,n.algorithm=dt,e.push(n)})}),e}async exportRoomKeysAsJson(){return JSON.stringify(await this.exportRoomKeys())}importRoomKeys(e,t={}){let i=0,n=0;const s=e.length;function o(){var a;(a=t.progressCallback)==null||a.call(t,{stage:"load_keys",successes:i,failures:n,total:s})}return Promise.all(e.map(a=>!a.room_id||!a.algorithm?(d.warn("ignoring room key entry with missing fields",a),n++,t.progressCallback&&o(),null):this.getRoomDecryptor(a.room_id,a.algorithm).importRoomKey(a,t).finally(()=>{i++,t.progressCallback&&o()}))).then()}async importRoomKeysAsJson(e,t){return await this.importRoomKeys(JSON.parse(e))}countSessionsNeedingBackup(){return this.backupManager.countSessionsNeedingBackup()}prepareToEncrypt(e){const t=this.roomEncryptors.get(e.roomId);t&&t.prepareToEncrypt(e)}async encryptEvent(e,t){const i=e.getRoomId(),n=this.roomEncryptors.get(i);if(!n)throw new Error("Room "+i+" was previously configured to use encryption, but is no longer. Perhaps the homeserver is hiding the configuration event.");await this.trackRoomDevicesImpl(t);let s=e.getContent();const o=s["m.relates_to"];o&&(s=Object.assign({},s),delete s["m.relates_to"]);const a=s["io.element.performance_metrics"];a&&(s=Object.assign({},s),delete s["io.element.performance_metrics"]);const c=await n.encryptMessage(t,e.getType(),s);o&&(c["m.relates_to"]=o),a&&(c["io.element.performance_metrics"]=a),e.makeEncrypted("m.room.encrypted",c,this.olmDevice.deviceCurve25519Key,this.olmDevice.deviceEd25519Key)}async decryptEvent(e){if(e.isRedacted()){const t=new it({room_id:e.getRoomId(),...e.getUnsigned().redacted_because});let i=e.getUnsigned().redacted_because;if(t.isEncrypted())try{i=(await this.decryptEvent(t)).clearEvent}catch(n){d.warn("Decryption of redaction failed. Falling back to unencrypted event.",n)}return{clearEvent:{room_id:e.getRoomId(),type:"m.room.message",content:{},unsigned:{redacted_because:i}}}}else{const t=e.getWireContent();return this.getRoomDecryptor(e.getRoomId(),t.algorithm).decryptEvent(e)}}async processDeviceLists(e){await this.evalDeviceListChanges(e)}requestRoomKey(e,t,i=!1){return this.outgoingRoomKeyRequestManager.queueRoomKeyRequest(e,t,i).then(()=>{this.sendKeyRequestsImmediately&&this.outgoingRoomKeyRequestManager.sendQueuedRequests()}).catch(n=>{d.error("Error requesting key for event",n)})}cancelRoomKeyRequest(e){this.outgoingRoomKeyRequestManager.cancelRoomKeyRequest(e).catch(t=>{d.warn("Error clearing pending room key requests",t)})}async cancelAndResendAllOutgoingKeyRequests(){await this.outgoingRoomKeyRequestManager.cancelAndResendAllOutgoingRequests()}async onCryptoEvent(e,t){const i=t.getContent();await this.setRoomEncryptionImpl(e,i)}async onSyncWillProcess(e){e.oldSyncToken||(d.log("Initial sync performed - resetting device tracking state"),this.deviceList.stopTrackingAllDeviceLists(),this.deviceList.startTrackingDeviceList(this.userId),this.roomDeviceTrackingState={}),this.sendKeyRequestsImmediately=!1}async onSyncCompleted(e){this.deviceList.setSyncToken(e.nextSyncToken??null),this.deviceList.saveIfDirty(),this.deviceList.startTrackingDeviceList(this.userId),this.deviceList.refreshOutdatedDeviceLists(),e.catchingUp||(this.maybeUploadOneTimeKeys(),this.processReceivedRoomKeyRequests(),this.outgoingRoomKeyRequestManager.sendQueuedRequests(),this.sendKeyRequestsImmediately=!0)}async evalDeviceListChanges(e){if(Array.isArray(e==null?void 0:e.changed)&&e.changed.forEach(t=>{this.deviceList.invalidateUserDeviceList(t)}),Array.isArray(e==null?void 0:e.left)&&e.left.length){const t=new Set(await this.getTrackedE2eUsers());e.left.forEach(i=>{t.has(i)||this.deviceList.stopTrackingDeviceList(i)})}}async getTrackedE2eUsers(){const e=[];for(const t of this.getTrackedE2eRooms()){const i=await t.getEncryptionTargetMembers();for(const n of i)e.push(n.userId)}return e}getTrackedE2eRooms(){return this.clientStore.getRooms().filter(e=>{if(!this.roomEncryptors.get(e.roomId)||!this.roomDeviceTrackingState[e.roomId])return!1;const i=e.getMyMembership();return i===ae.Join||i===ae.Invite})}async encryptAndSendToDevices(e,t){const i={eventType:R.RoomMessageEncrypted,batch:[]};try{await Promise.all(e.map(async({userId:n,deviceInfo:s})=>{const o=s.deviceId,a={algorithm:Ge,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[ut]:Kt()};i.batch.push({userId:n,deviceId:o,payload:a}),await di(this.olmDevice,this.baseApis,new Map([[n,[s]]])),await Ai(a.ciphertext,this.userId,this.deviceId,this.olmDevice,n,s,t)})),i.batch=i.batch.filter(n=>Object.keys(n.payload.ciphertext).length>0?!0:(d.log(`No ciphertext for device ${n.userId}:${n.deviceId}: pruning`),!1));try{await this.baseApis.queueToDevice(i)}catch(n){throw d.error("sendToDevice failed",n),n}}catch(n){throw d.error("encryptAndSendToDevices promises failed",n),n}}async preprocessToDeviceMessages(e){return e.filter(t=>{var i;return t.type===R.RoomMessageEncrypted&&!["m.olm.v1.curve25519-aes-sha2"].includes((i=t.content)==null?void 0:i.algorithm)?(d.log("Ignoring invalid encrypted to-device event from "+t.sender),!1):!0})}updateOneTimeKeyCount(e){if(isFinite(e))this.oneTimeKeyCount=e;else throw new TypeError("Parameter for updateOneTimeKeyCount has to be a number")}processKeyCounts(e,t){return e!==void 0&&this.updateOneTimeKeyCount(e.signed_curve25519||0),t!==void 0&&(this.needsNewFallback=!t.includes("signed_curve25519")),Promise.resolve()}onRoomKeyEvent(e){const t=e.getContent();if(!t.room_id||!t.algorithm){d.error("key event is missing fields");return}this.backupManager.checkedForBackup||this.backupManager.checkAndStart(),this.getRoomDecryptor(t.room_id,t.algorithm).onRoomKeyEvent(e)}onRoomKeyWithheldEvent(e){const t=e.getContent();if(t.code!=="m.no_olm"&&(!t.room_id||!t.session_id)||!t.algorithm||!t.sender_key){d.error("key withheld event is missing fields");return}d.info(`Got room key withheld event from ${e.getSender()} for ${t.algorithm} session ${t.sender_key}|${t.session_id} in room ${t.room_id} with code ${t.code} (${t.reason})`);const i=this.getRoomDecryptor(t.room_id,t.algorithm);if(i.onRoomKeyWithheldEvent&&i.onRoomKeyWithheldEvent(e),!t.room_id){const n=this.getRoomDecryptors(t.algorithm);for(const s of n)s.retryDecryptionFromSender(t.sender_key)}}onKeyVerificationMessage(e){if(!Xe.validateEvent(e,this.baseApis))return;const t=i=>{if(!Xe.canCreateRequest(Xe.getEventType(i)))return;const n=i.getContent(),s=n&&n.from_device;if(!s)return;const o=i.getSender(),a=new Xe(this.baseApis,o,[s]);return new Wi(a,this.verificationMethods,this.baseApis)};this.handleVerificationEvent(e,this.toDeviceVerificationRequests,t)}async handleVerificationEvent(e,t,i,n=!0){if(e.isSending()&&e.status!=se.SENT){let c,l;try{await new Promise((u,h)=>{c=u,l=()=>{e.status==se.CANCELLED&&h(new Error("Event status set to CANCELLED."))},e.once(be.LocalEventIdReplaced,c),e.on(be.Status,l)})}catch(u){d.error("error while waiting for the verification event to be sent: ",u);return}finally{e.removeListener(be.LocalEventIdReplaced,c),e.removeListener(be.Status,l)}}let s=t.getRequest(e),o=!1;if(!s){if(s=i(e),!s){d.log(`Crypto: could not find VerificationRequest for ${e.getType()}, and could not create one, so ignoring.`);return}o=!0,t.setRequest(e,s)}e.setVerificationRequest(s);try{await s.channel.handleEvent(e,s,n)}catch(c){d.error("error while handling verification event",c)}o&&!s.initiatedByMe&&!s.invalid&&!s.observeOnly&&(this.baseApis.emit("crypto.verification.request",s),this.baseApis.emit("crypto.verificationRequestReceived",s))}async onToDeviceBadEncrypted(e){const t=e.getWireContent(),i=e.getSender(),n=t.algorithm,s=t.sender_key;this.baseApis.emit(ie.UndecryptableToDeviceEvent,e);const o=()=>{const g=this.getRoomDecryptors(dt);for(const m of g)m.retryDecryptionFromSender(s)};if(i===void 0||s===void 0||s===void 0)return;const a=this.forceNewSessionRetryTime.getOrCreate(i),c=a.getOrCreate(s);if(c>Date.now()){d.debug(`New session already forced with device ${i}:${s}: not forcing another until at least ${new Date(c).toUTCString()}`),await this.olmDevice.recordSessionProblem(s,"wedged",!0),o();return}a.set(s,Date.now()+tS);let l=this.deviceList.getDeviceByIdentityKey(n,s);if(!l&&(await this.downloadKeys([i],!1),l=this.deviceList.getDeviceByIdentityKey(n,s),!l)){d.info("Couldn't find device for identity key "+s+": not re-establishing session"),await this.olmDevice.recordSessionProblem(s,"wedged",!1),o();return}const u=new Map([[i,[l]]]);await di(this.olmDevice,this.baseApis,u,!0),a.set(s,Date.now()+eS);const h={algorithm:Ge,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[ut]:Kt()};await Ai(h.ciphertext,this.userId,this.deviceId,this.olmDevice,i,l,{type:"m.dummy"}),await this.olmDevice.recordSessionProblem(s,"wedged",!0),o(),await this.baseApis.sendToDevice("m.room.encrypted",new Map([[i,new Map([[l.deviceId,h]])]]));const f=await this.outgoingRoomKeyRequestManager.getOutgoingSentRoomKeyRequest(i,l.deviceId);for(const g of f)this.requestRoomKey(g.requestBody,g.recipients,!0)}onRoomMembership(e,t,i){var o;const n=t.roomId,s=this.roomEncryptors.get(n);s&&(n in this.roomDeviceTrackingState&&(t.membership==ae.Join?(d.log("Join event for "+t.userId+" in "+n),this.deviceList.startTrackingDeviceList(t.userId)):t.membership==ae.Invite&&((o=this.clientStore.getRoom(n))!=null&&o.shouldEncryptForInvitedMembers())&&(d.log("Invite event for "+t.userId+" in "+n),this.deviceList.startTrackingDeviceList(t.userId))),s.onRoomMembership(e,t,i))}onRoomKeyRequestEvent(e){const t=e.getContent();if(t.action==="request"){const i=new iS(e);this.receivedRoomKeyRequests.push(i)}else if(t.action==="request_cancellation"){const i=new nS(e);this.receivedRoomKeyRequestCancellations.push(i)}}async processReceivedRoomKeyRequests(){if(!this.processingRoomKeyRequests){this.processingRoomKeyRequests=!0;try{const e=this.receivedRoomKeyRequests;this.receivedRoomKeyRequests=[];const t=this.receivedRoomKeyRequestCancellations;this.receivedRoomKeyRequestCancellations=[],await Promise.all(e.map(i=>this.processReceivedRoomKeyRequest(i))),await Promise.all(t.map(i=>this.processReceivedRoomKeyRequestCancellation(i)))}catch(e){d.error(`Error processing room key requsts: ${e}`)}finally{this.processingRoomKeyRequests=!1}}}async processReceivedRoomKeyRequest(e){const t=e.userId,i=e.deviceId,n=e.requestBody,s=n.room_id,o=n.algorithm;if(d.log(`m.room_key_request from ${t}:${i} for ${s} / ${n.session_id} (id ${e.requestId})`),t!==this.userId){if(!this.roomEncryptors.get(s)){d.debug(`room key request for unencrypted room ${s}`);return}const c=this.roomEncryptors.get(s),l=this.deviceList.getStoredDevice(t,i);if(!l){d.debug(`Ignoring keyshare for unknown device ${t}:${i}`);return}try{await c.reshareKeyWithDevice(n.sender_key,n.session_id,t,l)}catch(u){d.warn("Failed to re-share keys for session "+n.session_id+" with device "+t+":"+l.deviceId,u)}return}if(i===this.deviceId){d.log("Ignoring room key request from ourselves");return}if(!this.roomDecryptors.has(s)){d.log(`room key request for unencrypted room ${s}`);return}const a=this.roomDecryptors.get(s).get(o);if(!a){d.log(`room key request for unknown alg ${o} in room ${s}`);return}if(!await a.hasKeysForKeyRequest(e)){d.log(`room key request for unknown session ${s} / `+n.session_id);return}if(e.share=()=>{a.shareKeysWithDevice(e)},this.checkDeviceTrust(t,i).isVerified()){d.log("device is already verified: sharing keys"),e.share();return}this.emit("crypto.roomKeyRequest",e)}async processReceivedRoomKeyRequestCancellation(e){d.log(`m.room_key_request cancellation for ${e.userId}:${e.deviceId} (id ${e.requestId})`),this.emit("crypto.roomKeyRequestCancellation",e)}getRoomDecryptor(e,t){let i,n;if(e&&(i=this.roomDecryptors.get(e),i||(i=new Map,this.roomDecryptors.set(e,i)),n=i.get(t),n))return n;const s=ka.get(t);if(!s)throw new Fe(Ne.UNKNOWN_ENCRYPTION_ALGORITHM,'Unknown encryption algorithm "'+t+'".');return n=new s({userId:this.userId,crypto:this,olmDevice:this.olmDevice,baseApis:this.baseApis,roomId:e??void 0}),i&&i.set(t,n),n}getRoomDecryptors(e){const t=[];for(const i of this.roomDecryptors.values())i.has(e)&&t.push(i.get(e));return t}async signObject(e){const t=new Map(Object.entries(e.signatures||{})),i=e.unsigned;delete e.signatures,delete e.unsigned;const n=t.get(this.userId)||{};t.set(this.userId,n),n["ed25519:"+this.deviceId]=await this.olmDevice.sign(li.stringify(e)),e.signatures=In(t),i!==void 0&&(e.unsigned=i)}isRoomEncrypted(e){return this.roomList.isRoomEncrypted(e)}async isEncryptionEnabledInRoom(e){return this.isRoomEncrypted(e)}getRoomEncryption(e){return this.roomList.getRoomEncryption(e)}async isDehydrationSupported(){return!1}async startDehydration(e){throw new Error("Not implemented")}}function ws(r){if(typeof r!="string"||r.indexOf(",")<0)return null;const e=Uint8Array.from(r.split(","),t=>parseInt(t));return lt(e)}class iS{constructor(e){const t=e.getContent();this.userId=e.getSender(),this.deviceId=t.requesting_device_id,this.requestId=t.request_id,this.requestBody=t.body||{},this.share=()=>{throw new Error("don't know how to share keys for this request yet")}}}class nS{constructor(e){const t=e.getContent();this.userId=e.getSender(),this.deviceId=t.requesting_device_id,this.requestId=t.request_id}}class rS{constructor(e){this.ourEvent=e,this.ourEventIndex=0,this.paginateTokens={[he.Backward]:null,[he.Forward]:null},this.timeline=[e]}getEvent(){return this.timeline[this.ourEventIndex]}getTimeline(){return this.timeline}getOurEventIndex(){return this.ourEventIndex}getPaginateToken(e=!1){return this.paginateTokens[e?he.Backward:he.Forward]}setPaginateToken(e,t=!1){this.paginateTokens[t?he.Backward:he.Forward]=e??null}addEvents(e,t=!1){t?(this.timeline=e.concat(this.timeline),this.ourEventIndex+=e.length):this.timeline=this.timeline.concat(e)}}class rc{constructor(e,t){this.rank=e,this.context=t}static fromJson(e,t){const i=e.context||{};let n=(i.events_before||[]).map(t),s=(i.events_after||[]).map(t);const o=new rS(t(e.result)),a=o.ourEvent.threadRootId;return n=n.filter(c=>c.threadRootId===a),s=s.filter(c=>c.threadRootId===a),o.setPaginateToken(i.start,!0),o.addEvents(n,!0),o.addEvents(s,!1),o.setPaginateToken(i.end,!1),new rc(e.rank,o)}}var sc=(r=>(r.PrivateChat="private_chat",r.TrustedPrivateChat="trusted_private_chat",r.PublicChat="public_chat",r))(sc||{}),Vu=(r=>(r.Public="public",r.Invite="invite",r.Private="private",r.Knock="knock",r.Restricted="restricted",r))(Vu||{}),Bs=(r=>(r.CanJoin="can_join",r.Forbidden="forbidden",r))(Bs||{}),oc=(r=>(r.Invited="invited",r.Joined="joined",r.Shared="shared",r.WorldReadable="world_readable",r))(oc||{});function sS(r,e){let t=!!e.preventReEmit;const i=e.decrypt!==!1;function n(s){e.toDevice&&delete s.room_id;const o=r.getRoom(s.room_id);let a;o&&s.state_key===void 0&&(a=o.findEventById(s.event_id)),!a||a.status?a=new it(s):(a.setUnsigned({...a.getUnsigned(),...s.unsigned}),t=!0);const c=a.getServerAggregatedRelation(Te.Replace);if(c!=null&&c.content){const u=n(c);a.makeReplaced(u)}const l=o==null?void 0:o.findThreadForEvent(a);return l&&a.setThread(l),a.isEncrypted()&&(t||r.reEmitter.reEmit(a,[be.Decrypted]),i&&r.decryptEventIfNeeded(a)),t||(r.reEmitter.reEmit(a,[be.Replaced,be.VisibilityChange]),o==null||o.reEmitter.reEmit(a,[be.BeforeRedaction])),a}return n}class Vl{constructor(e,t,i){this.client=e,this.indexEvent=t,this.directory=i}get id(){const e=this.indexEvent.getStateKey();if(!e)throw new Error("State key not found for branch");return e}get isActive(){return this.indexEvent.getContent().active===!0}get version(){return this.indexEvent.getContent().version??1}get roomId(){return this.indexEvent.getRoomId()}async delete(){await this.client.sendStateEvent(this.roomId,Ri.name,{},this.id),await this.client.redactEvent(this.roomId,this.id);const e=(await this.getVersionHistory())[1];e&&await e.delete()}getName(){return this.indexEvent.getContent().name||"Unnamed File"}async setName(e){await this.client.sendStateEvent(this.roomId,Ri.name,{...this.indexEvent.getContent(),name:e},this.id)}isLocked(){return this.indexEvent.getContent().locked||!1}async setLocked(e){await this.client.sendStateEvent(this.roomId,Ri.name,{...this.indexEvent.getContent(),locked:e},this.id)}async getFileInfo(){const t=(await this.getFileEvent()).getOriginalContent().file,i=this.client.mxcUrlToHttp(t.url);if(!i)throw new Error(`No HTTP URL available for ${t.url}`);return{info:t,httpUrl:i}}async getFileEvent(){const e=this.client.getRoom(this.roomId);if(!e)throw new Error("Unknown room");let t=e.getUnfilteredTimelineSet().findEventById(this.id);for(;!t&&e.getLiveTimeline().getState(ee.BACKWARDS).paginationToken;)await this.client.scrollback(e,100),t=e.getUnfilteredTimelineSet().findEventById(this.id);if(!t)throw new Error("Failed to find event");return await this.client.decryptEventIfNeeded(t),t}async createNewVersion(e,t,i,n){const s=await this.directory.createFile(e,t,i,{...n??{},"m.new_content":!0,"m.relates_to":{rel_type:Te.Replace,event_id:this.id}});return await this.client.sendStateEvent(this.roomId,Ri.name,{active:!0,name:e,version:this.version+1},s.event_id),await this.client.sendStateEvent(this.roomId,Ri.name,{...this.indexEvent.getContent(),active:!1},this.id),s}async getVersionHistory(){const e=[];e.push(this);const t=this.client.getRoom(this.roomId);if(!t)throw new Error("Invalid or unknown room");const i=[...t.getLiveTimeline().getEvents()].reverse();let n,s=await this.getFileEvent();do if(n=i.find(o=>o.replacingEventId()===s.getId()),n){const o=this.directory.getFile(n.getId());if(o)e.push(o),s=n;else break}while(n);return e}}const oS={invite:100,kick:100,ban:100,redact:50,state_default:50,events_default:50,users_default:0,events:{[R.RoomPowerLevels]:100,[R.RoomHistoryVisibility]:100,[R.RoomTombstone]:100,[R.RoomEncryption]:100,[R.RoomName]:50,[R.RoomMessage]:50,[R.RoomMessageEncrypted]:50,[R.Sticker]:50},users:{}};class jl{constructor(e,t){if(this.client=e,this.roomId=t,this.room=this.client.getRoom(this.roomId),!this.room)throw new Error("Unknown room")}get id(){return this.roomId}get isTopLevel(){const e=this.room.currentState.getStateEvents(R.SpaceParent);return e!=null&&e.length?e.every(t=>{var i;return!((i=t.getContent())!=null&&i.via)}):!0}async setName(e){await this.client.sendStateEvent(this.roomId,R.RoomName,{name:e},"")}async invite(e,t=!0,i=!0){const n=[this.retryInvite(e)];return t&&n.push(...this.getDirectories().map(s=>s.invite(e,t,i))),Promise.all(n).then(()=>{i&&Lu(this.room)&&this.client.sendSharedHistoryKeys(this.roomId,[e])})}retryInvite(e){return tf(async()=>{await this.client.invite(this.roomId,e).catch(t=>{throw(t==null?void 0:t.errcode)==="M_FORBIDDEN"?new Ed.AbortError(t):t})})}async setPermissions(e,t){var l;const i=this.room.currentState.getStateEvents(R.RoomPowerLevels,"");if(Array.isArray(i))throw new Error("Unexpected return type for power levels");const n=(i==null?void 0:i.getContent())||{},s=n.users_default||0,o=n.events_default||50,a=((l=n.events)==null?void 0:l[R.RoomPowerLevels])||100,c=n.users||{};switch(t){case"viewer":c[e]=s;break;case"editor":c[e]=o;break;case"owner":c[e]=a;break;default:throw new Error("Invalid role: "+t)}n.users=c,await this.client.sendStateEvent(this.roomId,R.RoomPowerLevels,n,"")}getPermissions(e){var c,l;const t=this.room.currentState.getStateEvents(R.RoomPowerLevels,"");if(Array.isArray(t))throw new Error("Unexpected return type for power levels");const i=(t==null?void 0:t.getContent())||{},n=i.users_default||0,s=i.events_default||50,o=((c=i.events)==null?void 0:c[R.RoomPowerLevels])||100,a=((l=i.users)==null?void 0:l[e])||n;return a>=o?"owner":a>=s?"editor":"viewer"}async createDirectory(e){const t=await this.client.unstableCreateFileTree(e);return await this.client.sendStateEvent(this.roomId,R.SpaceChild,{via:[this.client.getDomain()]},t.roomId),await this.client.sendStateEvent(t.roomId,R.SpaceParent,{via:[this.client.getDomain()]},this.roomId),t}getDirectories(){const e=[],t=this.room.currentState.getStateEvents(R.SpaceChild);for(const i of t)try{const n=i.getStateKey();if(n){const s=this.client.unstableGetFileTreeSpace(n);s&&e.push(s)}}catch(n){d.warn("Unable to create tree space instance for listing. Are we joined?",n)}return e}getDirectory(e){return this.getDirectories().find(t=>t.roomId===e)}async delete(){const e=this.getDirectories();for(const n of e)await n.delete();const t=[ae.Invite,ae.Knock,ae.Join],i=this.room.currentState.getStateEvents(R.RoomMember);for(const n of i)if(n.getStateKey()!==this.client.getUserId()&&t.includes(n.getContent().membership)){const o=n.getStateKey();if(!o)throw new Error("State key not found for branch");await this.client.kick(this.roomId,o,"Room deleted")}await this.client.leave(this.roomId)}getOrderedChildren(e){const t=e.map(i=>({roomId:i.getStateKey(),order:i.getContent().order})).filter(i=>i.roomId);return t.sort((i,n)=>{var s,o;if(i.order&&!n.order)return-1;if(!i.order&&n.order)return 1;if(!i.order&&!n.order){const a=this.client.getRoom(i.roomId),c=this.client.getRoom(n.roomId);if(!a||!c)return us(i.roomId,n.roomId);const l=((s=a.currentState.getStateEvents(R.RoomCreate,""))==null?void 0:s.getTs())??0,u=((o=c.currentState.getStateEvents(R.RoomCreate,""))==null?void 0:o.getTs())??0;return l===u?us(i.roomId,n.roomId):l-u}else return us(i.order,n.order)}),t}getParentRoom(){const t=this.room.currentState.getStateEvents(R.SpaceParent)[0];if(!t)throw new Error("Expected to have a parent in a non-top level space");const i=t.getStateKey();if(!i)throw new Error("No state key found for parent");const n=this.client.getRoom(i);if(!n)throw new Error("Unable to locate room for parent");return n}getOrder(){if(this.isTopLevel)return-1;const t=this.getParentRoom().currentState.getStateEvents(R.SpaceChild);return this.getOrderedChildren(t).findIndex(n=>n.roomId===this.roomId)}async setOrder(e){if(this.isTopLevel)throw new Error("Cannot set order of top level spaces currently");const t=this.getParentRoom(),i=t.currentState.getStateEvents(R.SpaceChild),n=this.getOrderedChildren(i);e=Math.max(Math.min(e,n.length-1),0);const o=this.getOrder()<e;o&&e===n.length-1?e--:!o&&e===0&&e++;const a=n[o?e:e-1],c=n[o?e+1:e];let l=Mi[0],u=!1;if(!a)c!=null&&c.order&&(l=bc(c.order));else if(e===n.length-1)c!=null&&c.order&&(l=Qn(c.order));else{const g=a==null?void 0:a.order,m=c==null?void 0:c.order;g&&m?g===m?l=Qn(g):l=nf(g,m):g?l=Qn(g):m?l=bc(m):u=!0}if(u){let g;for(let m=0;m<=e;m++){const v=n[m];if(m===0&&(g=v.order),v.order)g=v.order;else{g=g?Qn(g):Mi[0];const S=t.currentState.getStateEvents(R.SpaceChild,v.roomId),w=(S==null?void 0:S.getContent())??{via:[this.client.getDomain()]};await this.client.sendStateEvent(t.roomId,R.SpaceChild,{...w,order:g},v.roomId)}}g&&(l=Qn(g))}const h=t.currentState.getStateEvents(R.SpaceChild,this.roomId),f=(h==null?void 0:h.getContent())??{via:[this.client.getDomain()]};await this.client.sendStateEvent(t.roomId,R.SpaceChild,{...f,order:l},this.roomId)}async createFile(e,t,i,n){const{content_uri:s}=await this.client.uploadContent(t,{includeFilename:!1});i.url=s;const o={msgtype:Jt.File,body:e,url:s,file:i};n=n??{},n["m.new_content"]&&(n["m.new_content"]=o);const a=await this.client.sendMessage(this.roomId,{...n,...o,[kh.name]:{}});return await this.client.sendStateEvent(this.roomId,Ri.name,{active:!0,name:e},a.event_id),a}getFile(e){const t=this.room.currentState.getStateEvents(Ri.name,e);return t?new Vl(this.client,t,this):null}listFiles(){return this.listAllFiles().filter(e=>e.isActive)}listAllFiles(){return(this.room.currentState.getStateEvents(Ri.name)??[]).map(t=>new Vl(this.client,t,this))}}var ju=(r=>(r.Recent="recent",r.Rank="rank",r))(ju||{});class aS extends ke{constructor(e){super(),this.client=e,this.userMediaStreams=[],this.screensharingStreams=[]}restoreMediaSettings(e,t){this.audioInput=e,this.videoInput=t}async setAudioInput(e){d.info(`MediaHandler setAudioInput() running (deviceId=${e})`),this.audioInput!==e&&(this.audioInput=e,await this.updateLocalUsermediaStreams())}async setAudioSettings(e){d.info(`MediaHandler setAudioSettings() running (opts=${JSON.stringify(e)})`),this.audioSettings=Object.assign({},e),await this.updateLocalUsermediaStreams()}async setVideoInput(e){d.info(`MediaHandler setVideoInput() running (deviceId=${e})`),this.videoInput!==e&&(this.videoInput=e,await this.updateLocalUsermediaStreams())}async setMediaInputs(e,t){d.log(`MediaHandler setMediaInputs() running (audioInput: ${e} videoInput: ${t})`),this.audioInput=e,this.videoInput=t,await this.updateLocalUsermediaStreams()}async updateLocalUsermediaStreams(){if(this.userMediaStreams.length===0)return;const e=new Map;for(const t of this.client.callEventHandler.calls.values())e.set(t.callId,{audio:t.hasLocalUserMediaAudioTrack,video:t.hasLocalUserMediaVideoTrack});for(const t of this.userMediaStreams){d.log(`MediaHandler updateLocalUsermediaStreams() stopping all tracks (streamId=${t.id})`);for(const i of t.getTracks())i.stop()}this.userMediaStreams=[],this.localUserMediaStream=void 0;for(const t of this.client.callEventHandler.calls.values()){if(t.callHasEnded()||!e.has(t.callId))continue;const{audio:i,video:n}=e.get(t.callId);d.log(`MediaHandler updateLocalUsermediaStreams() calling getUserMediaStream() (callId=${t.callId})`);const s=await this.getUserMediaStream(i,n);t.callHasEnded()||await t.updateLocalUsermediaStream(s)}for(const t of this.client.groupCallEventHandler.groupCalls.values()){if(!t.localCallFeed)continue;d.log(`MediaHandler updateLocalUsermediaStreams() calling getUserMediaStream() (groupCallId=${t.groupCallId})`);const i=await this.getUserMediaStream(!0,t.type===Ja.Video);t.state!==yu.Ended&&await t.updateLocalUsermediaStream(i)}this.emit("local_streams_changed")}async hasAudioDevice(){try{return(await navigator.mediaDevices.enumerateDevices()).filter(t=>t.kind==="audioinput").length>0}catch(e){return d.log("MediaHandler hasAudioDevice() calling navigator.mediaDevices.enumerateDevices with error",e),!1}}async hasVideoDevice(){try{return(await navigator.mediaDevices.enumerateDevices()).filter(t=>t.kind==="videoinput").length>0}catch(e){return d.log("MediaHandler hasVideoDevice() calling navigator.mediaDevices.enumerateDevices with error",e),!1}}async getUserMediaStream(e,t,i=!0){return this.getMediaStreamPromise?this.getMediaStreamPromise=this.getMediaStreamPromise.then(()=>this.getUserMediaStreamInternal(e,t,i)):this.getMediaStreamPromise=this.getUserMediaStreamInternal(e,t,i),this.getMediaStreamPromise}async getUserMediaStreamInternal(e,t,i){var c,l,u,h,f;const n=e&&await this.hasAudioDevice(),s=t&&await this.hasVideoDevice();let o,a=!0;if(this.localUserMediaStream?(n!==this.localUserMediaStream.getAudioTracks().length>0&&(a=!1),s!==this.localUserMediaStream.getVideoTracks().length>0&&(a=!1),n&&((l=(c=this.localUserMediaStream.getAudioTracks()[0])==null?void 0:c.getSettings())==null?void 0:l.deviceId)!==this.audioInput&&(a=!1),s&&((h=(u=this.localUserMediaStream.getVideoTracks()[0])==null?void 0:u.getSettings())==null?void 0:h.deviceId)!==this.videoInput&&(a=!1)):a=!1,a){if(o=this.localUserMediaStream.clone(),d.log(`MediaHandler getUserMediaStreamInternal() cloning (oldStreamId=${(f=this.localUserMediaStream)==null?void 0:f.id} newStreamId=${o.id} shouldRequestAudio=${n} shouldRequestVideo=${s})`),!n)for(const g of o.getAudioTracks())o.removeTrack(g);if(!s)for(const g of o.getVideoTracks())o.removeTrack(g)}else{const g=this.getUserMediaContraints(n,s);o=await navigator.mediaDevices.getUserMedia(g),d.log(`MediaHandler getUserMediaStreamInternal() calling getUserMediaStream (streamId=${o.id}, shouldRequestAudio=${n}, shouldRequestVideo=${s}, constraints=${JSON.stringify(g)})`);for(const m of o.getTracks()){const v=m.getSettings();m.kind==="audio"?this.audioInput=v.deviceId:m.kind==="video"&&(this.videoInput=v.deviceId)}i&&(this.localUserMediaStream=o)}return i&&this.userMediaStreams.push(o),this.emit("local_streams_changed"),o}stopUserMediaStream(e){var i;d.log(`MediaHandler stopUserMediaStream() stopping (streamId=${e.id})`);for(const n of e.getTracks())n.stop();const t=this.userMediaStreams.indexOf(e);if(t!==-1&&(d.debug(`MediaHandler stopUserMediaStream() splicing usermedia stream out stream array (streamId=${e.id})`,e.id),this.userMediaStreams.splice(t,1)),this.emit("local_streams_changed"),this.localUserMediaStream===e)this.localUserMediaStream=void 0;else for(const n of e.getTracks())if((i=this.localUserMediaStream)!=null&&i.getTrackById(n.id)){this.stopUserMediaStream(this.localUserMediaStream);break}}async getScreensharingStream(e={},t=!0){let i;if(this.screensharingStreams.length===0){const n=this.getScreenshareContraints(e);e.desktopCapturerSourceId?(d.debug(`MediaHandler getScreensharingStream() calling getUserMedia() (opts=${JSON.stringify(e)})`),i=await navigator.mediaDevices.getUserMedia(n)):(d.debug(`MediaHandler getScreensharingStream() calling getDisplayMedia() (opts=${JSON.stringify(e)})`),i=await navigator.mediaDevices.getDisplayMedia(n))}else{const n=this.screensharingStreams[this.screensharingStreams.length-1];d.log(`MediaHandler getScreensharingStream() cloning (streamId=${n.id})`),i=n.clone()}return t&&this.screensharingStreams.push(i),this.emit("local_streams_changed"),i}stopScreensharingStream(e){d.debug(`MediaHandler stopScreensharingStream() stopping stream (streamId=${e.id})`);for(const i of e.getTracks())i.stop();const t=this.screensharingStreams.indexOf(e);t!==-1&&(d.debug(`MediaHandler stopScreensharingStream() splicing stream out (streamId=${e.id})`),this.screensharingStreams.splice(t,1)),this.emit("local_streams_changed")}stopAllStreams(){for(const e of this.userMediaStreams){d.log(`MediaHandler stopAllStreams() stopping (streamId=${e.id})`);for(const t of e.getTracks())t.stop()}for(const e of this.screensharingStreams)for(const t of e.getTracks())t.stop();this.userMediaStreams=[],this.screensharingStreams=[],this.localUserMediaStream=void 0,this.emit("local_streams_changed")}getUserMediaContraints(e,t){const i=!!navigator.webkitGetUserMedia;return{audio:e?{deviceId:this.audioInput?{ideal:this.audioInput}:void 0,autoGainControl:this.audioSettings?{ideal:this.audioSettings.autoGainControl}:void 0,echoCancellation:this.audioSettings?{ideal:this.audioSettings.echoCancellation}:void 0,noiseSuppression:this.audioSettings?{ideal:this.audioSettings.noiseSuppression}:void 0}:!1,video:t?{deviceId:this.videoInput?{ideal:this.videoInput}:void 0,width:i?{exact:640}:{ideal:640},height:i?{exact:360}:{ideal:360}}:!1}}getScreenshareContraints(e){const{desktopCapturerSourceId:t,audio:i}=e;return t?{audio:i??!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t}}}:{audio:i??!1,video:!0}}}var Na=(r=>(r.RequestFinished="FINISHED",r.Complete="COMPLETE",r))(Na||{}),Gn=(r=>(r.PreProcess="ExtState.PreProcess",r.PostProcess="ExtState.PostProcess",r))(Gn||{}),Ka=(r=>(r.RoomData="SlidingSync.RoomData",r.Lifecycle="SlidingSync.Lifecycle",r.List="SlidingSync.List",r))(Ka||{});const cS=3;class lS{constructor(e){this.crypto=e}name(){return"e2ee"}when(){return Gn.PreProcess}onRequest(e){if(e)return{enabled:!0}}async onResponse(e){e.device_lists&&await this.crypto.processDeviceLists(e.device_lists),await this.crypto.processKeyCounts(e.device_one_time_keys_count,e.device_unused_fallback_key_types||e["org.matrix.msc2732.device_unused_fallback_key_types"]),this.crypto.onSyncCompleted({})}}class dS{constructor(e,t){this.client=e,this.cryptoCallbacks=t,this.nextBatch=null}name(){return"to_device"}when(){return Gn.PreProcess}onRequest(e){const t={since:this.nextBatch!==null?this.nextBatch:void 0};return e&&(t.limit=100,t.enabled=!0),t}async onResponse(e){const t=[];let i=e.events||[];i.length>0&&this.cryptoCallbacks&&(i=await this.cryptoCallbacks.preprocessToDeviceMessages(i)),i.map(this.client.getEventMapper()).map(n=>{if(n.getType()==="m.key.verification.cancel"){const s=n.getContent().transaction_id;s&&t.push(s)}return n}).forEach(n=>{const s=n.getContent();if(n.getType()=="m.room.message"&&s.msgtype=="m.bad.encrypted"){d.log("Ignoring undecryptable to-device event from "+n.getSender());return}if(n.getType()==="m.key.verification.start"||n.getType()==="m.key.verification.request"){const o=s.transaction_id;t.includes(o)&&n.flagCancelled()}this.client.emit(ie.ToDeviceEvent,n)}),this.nextBatch=e.next_batch}}class uS{constructor(e){this.client=e}name(){return"account_data"}when(){return Gn.PostProcess}onRequest(e){if(e)return{enabled:!0}}async onResponse(e){e.global&&e.global.length>0&&this.processGlobalAccountData(e.global);for(const t in e.rooms){const i=Mn(this.client,t,e.rooms[t]),n=this.client.getRoom(t);if(!n){d.warn("got account data for room but room doesn't exist on client:",t);continue}n.addAccountData(i),i.forEach(s=>{this.client.emit(ie.Event,s)})}}processGlobalAccountData(e){const t=Mn(this.client,void 0,e),i=t.reduce((n,s)=>(n[s.getType()]=this.client.store.getAccountData(s.getType()),n),{});this.client.store.storeAccountDataEvents(t),t.forEach(n=>{if(n.getType()===R.PushRules){const o=n.getContent();this.client.setPushRules(o)}const s=i[n.getType()];return this.client.emit(ie.AccountData,n,s),n})}}class hS{constructor(e){this.client=e}name(){return"typing"}when(){return Gn.PostProcess}onRequest(e){if(e)return{enabled:!0}}async onResponse(e){if(e!=null&&e.rooms)for(const t in e.rooms)Wu(this.client,t,[e.rooms[t]])}}class fS{constructor(e){this.client=e}name(){return"receipts"}when(){return Gn.PostProcess}onRequest(e){if(e)return{enabled:!0}}async onResponse(e){if(e!=null&&e.rooms)for(const t in e.rooms)Wu(this.client,t,[e.rooms[t]])}}class Gu{constructor(e,t,i,n){this.slidingSync=e,this.client=t,this.syncState=null,this.lastPos=null,this.failCount=0,this.notifEvents=[],this.opts=au(i),this.syncOpts=cu(n),t.getNotifTimelineSet()&&t.reEmitter.reEmit(t.getNotifTimelineSet(),[de.Timeline,de.TimelineReset]),this.slidingSync.on(Ka.Lifecycle,this.onLifecycle.bind(this)),this.slidingSync.on(Ka.RoomData,this.onRoomData.bind(this));const s=[new dS(this.client,this.syncOpts.cryptoCallbacks),new uS(this.client),new hS(this.client),new fS(this.client)];this.syncOpts.crypto&&s.push(new lS(this.syncOpts.crypto)),s.forEach(o=>{this.slidingSync.registerExtension(o)})}async onRoomData(e,t){let i=this.client.store.getRoom(e);if(!i){if(!t.initial){d.debug("initial flag not set but no stored room exists for room ",e,t);return}i=lu(this.client,e,this.opts)}await this.processRoomData(this.client,i,t)}onLifecycle(e,t,i){switch(i&&d.debug("onLifecycle",e,i),e){case Na.Complete:if(this.purgeNotifications(),!t)break;this.lastPos||this.updateSyncState(st.Prepared,{oldSyncToken:void 0,nextSyncToken:t.pos,catchingUp:!1,fromCache:!1}),this.updateSyncState(st.Syncing,{oldSyncToken:this.lastPos,nextSyncToken:t.pos,catchingUp:!1,fromCache:!1}),this.lastPos=t.pos;break;case Na.RequestFinished:if(i){if(this.failCount+=1,this.updateSyncState(this.failCount>cS?st.Error:st.Reconnecting,{error:new Et(i)}),this.shouldAbortSync(new Et(i)))return}else this.failCount=0;break}}async syncLeftRooms(){return[]}async peek(e){return null}stopPeeking(){}setPresence(e){}getSyncState(){return this.syncState}getSyncStateData(){return this.syncStateData??null}createRoom(e){const{timelineSupport:t}=this.client,i=new Ga(e,this.client,this.client.getUserId(),{lazyLoadMembers:this.opts.lazyLoadMembers,pendingEventOrdering:this.opts.pendingEventOrdering,timelineSupport:t});return this.client.reEmitter.reEmit(i,[de.Name,de.Redaction,de.RedactionCancelled,de.Receipt,de.Tags,de.LocalEchoUpdated,de.AccountData,de.MyMembership,de.Timeline,de.TimelineReset]),this.registerStateListeners(i),i}registerStateListeners(e){this.client.reEmitter.reEmit(e.currentState,[fe.Events,fe.Members,fe.NewMember,fe.Update]),e.currentState.on(fe.NewMember,(t,i,n)=>{n.user=this.client.getUser(n.userId)??void 0,this.client.reEmitter.reEmit(n,[Nt.Name,Nt.Typing,Nt.PowerLevel,Nt.Membership])})}shouldAbortSync(e){return e.errcode==="M_UNKNOWN_TOKEN"?(d.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(st.Error,{error:e}),!0):!1}async processRoomData(e,t,i){i=gS(e,t.roomId,i);const n=Mn(this.client,t.roomId,i.required_state);let s=Mn(this.client,t.roomId,i.timeline,!1);const o=[];if(i.initial){const l=new Set;t.getLiveTimeline().getEvents().forEach(g=>{l.add(g.getId())});const u=[],h=[];let f=!1;for(let g=s.length-1;g>=0;g--){const m=s[g];if(l.has(m.getId())){f=!0;continue}f?u.push(m):h.unshift(m)}s=h,u.length>0&&t.addEventsToTimeline(u,!0,t.getLiveTimeline(),i.prev_batch)}const a=t.hasEncryptionStateEvent();if(i.notification_count!=null&&t.setUnreadNotificationCount(Be.Total,i.notification_count),i.highlight_count!=null&&(!a||a&&t.getUnreadNotificationCount(Be.Highlight)<=0)&&t.setUnreadNotificationCount(Be.Highlight,i.highlight_count),Number.isInteger(i.invited_count)&&t.currentState.setInvitedMemberCount(i.invited_count),Number.isInteger(i.joined_count)&&t.currentState.setJoinedMemberCount(i.joined_count),i.invite_state){const l=Mn(this.client,t.roomId,i.invite_state);await this.injectRoomEvents(t,l),i.initial&&(t.recalculate(),this.client.store.storeRoom(t),this.client.emit(ie.Room,t)),l.forEach(u=>{this.client.emit(ie.Event,u)}),t.updateMyMembership(ae.Invite);return}i.initial&&t.getLiveTimeline().setPaginationToken(i.prev_batch??null,ee.BACKWARDS),await this.injectRoomEvents(t,n,s,i.num_live),t.addEphemeralEvents(o),t.updateMyMembership(ae.Join),t.recalculate(),i.initial&&(e.store.storeRoom(t),e.emit(ie.Room,t)),this.addNotifications(s);const c=async l=>{e.emit(ie.Event,l),l.isState()&&l.getType()==R.RoomEncryption&&this.syncOpts.cryptoCallbacks&&await this.syncOpts.cryptoCallbacks.onCryptoEvent(t,l)};await bn(n,c),await bn(s,c),o.forEach(function(l){e.emit(ie.Event,l)}),t.decryptCriticalEvents()}async injectRoomEvents(e,t,i,n){i=i||[],t=t||[],n=n||0;const s=e.getLiveTimeline(),o=s.getEvents().length==0;if(o){for(const c of t)this.client.getPushActionsForEvent(c);s.initialiseState(t)}o||(e.oldState.setStateEvents(t),e.currentState.setStateEvents(t));let a=[];n>0&&(a=i.slice(-1*n),i=i.slice(0,-1*a.length)),await e.addLiveEvents(i,{fromCache:!0}),a.length>0&&await e.addLiveEvents(a,{fromCache:!1}),e.recalculate(),this.resolveInvites(e)}resolveInvites(e){if(!e||!this.opts.resolveInvitesToProfiles)return;const t=this.client;e.getMembersWithMembership(ae.Invite).forEach(function(i){if(i.requestedProfileInfo)return;i.requestedProfileInfo=!0;const n=t.getUser(i.userId);let s;n?s=Promise.resolve({avatar_url:n.avatarUrl,displayname:n.displayName}):s=t.getProfileInfo(i.userId),s.then(function(o){const a=i.events.member;a.getContent().membership===ae.Invite&&(a.getContent().avatar_url=o.avatar_url,a.getContent().displayname=o.displayname,i.setMembershipEvent(a,e.currentState))},function(o){})})}retryImmediately(){return!0}async sync(){for(d.debug("Sliding sync init loop");!this.client.isGuest();)try{d.debug("Getting push rules...");const e=await this.client.getPushRules();d.debug("Got push rules"),this.client.pushRules=e;break}catch(e){if(d.error("Getting push rules failed",e),this.shouldAbortSync(e))return}await this.slidingSync.start()}stop(){d.debug("SyncApi.stop"),this.slidingSync.stop()}updateSyncState(e,t){const i=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit(ie.Sync,this.syncState,i,t)}addNotifications(e){if(this.client.getNotifTimelineSet())for(const t of e){const i=this.client.getPushActionsForEvent(t);i&&i.notify&&i.tweaks&&i.tweaks.highlight&&this.notifEvents.push(t)}}purgeNotifications(){this.notifEvents.sort(function(e,t){return e.getTs()-t.getTs()}),this.notifEvents.forEach(e=>{var t;(t=this.client.getNotifTimelineSet())==null||t.addLiveEvent(e)}),this.notifEvents=[]}}function gS(r,e,t){if(!t.name)return t;for(const i of t.required_state)if(i.type===R.RoomName&&i.state_key==="")return i.content={name:t.name},t;return t.required_state.push({event_id:"$fake-sliding-sync-name-event-"+e,state_key:"",type:R.RoomName,content:{name:t.name},sender:r.getUserId(),origin_server_ts:new Date().getTime()}),t}function Mn(r,e,t,i=!0){const n=r.getEventMapper({decrypt:i});return t.map(function(s){return s.room_id=e,n(s)})}function Wu(r,e,t){const i=Mn(r,e,t),n=r.getRoom(e);if(!n){d.warn("got ephemeral events for room but room doesn't exist on client:",e);return}n.addEphemeralEvents(i),i.forEach(s=>{r.emit(ie.Event,s)})}const Hu=new Ce("m.beacon_info","org.matrix.msc3672.beacon_info"),Gl=new Ce("m.beacon","org.matrix.msc3672.beacon");class Ar{constructor(e=Ar.RETRY_BACKOFF_RATELIMIT,t=Ar.QUEUE_MESSAGES){this.retryAlgorithm=e,this.queueAlgorithm=t,this.queues={},this.activeQueues=[],this.procFn=null,this.processQueue=i=>{const n=this.peekNextEvent(i);if(!n){this.disableQueue(i);return}cs("Queue '%s' has %s pending events",i,this.queues[i].length),Promise.resolve().then(()=>this.procFn(n.event)).then(s=>{this.removeNextEvent(i),cs("Queue '%s' sent event %s",i,n.event.getId()),n.defer.resolve(s),this.processQueue(i)},s=>{n.attempts+=1;const o=this.retryAlgorithm(n.event,n.attempts,s);cs("retry(%s) err=%s event_id=%s waitTime=%s",n.attempts,s,n.event.getId(),o),o===-1?(d.info("Queue '%s' giving up on event %s",i,n.event.getId()),this.clearQueue(i,s)):setTimeout(this.processQueue,o,i)})}}static RETRY_BACKOFF_RATELIMIT(e,t,i){return Em(i,t,!1)}static QUEUE_MESSAGES(e){return e.getType()===R.RoomMessage||e.hasAssociation()?"message":null}getQueueForEvent(e){const t=this.queueAlgorithm(e);return!t||!this.queues[t]?null:this.queues[t].map(function(i){return i.event})}removeEventFromQueue(e){const t=this.queueAlgorithm(e);if(!t||!this.queues[t])return!1;let i=!1;return Rs(this.queues[t],n=>n.event.getId()===e.getId()?(i=!0,!0):!1),i}setProcessFunction(e){this.procFn=e,this.startProcessingQueues()}queueEvent(e){const t=this.queueAlgorithm(e);if(!t)return null;this.queues[t]||(this.queues[t]=[]);const i=Nn();return this.queues[t].push({event:e,defer:i,attempts:0}),cs("Queue algorithm dumped event %s into queue '%s'",e.getId(),t),this.startProcessingQueues(),i.promise}startProcessingQueues(){this.procFn&&Object.keys(this.queues).filter(e=>this.activeQueues.indexOf(e)===-1&&this.queues[e].length>0).forEach(e=>{this.activeQueues.push(e),this.processQueue(e)})}disableQueue(e){const t=this.activeQueues.indexOf(e);t>=0&&this.activeQueues.splice(t,1),d.info("Stopping queue '%s' as it is now empty",e)}clearQueue(e,t){d.info("clearing queue '%s'",e);let i;for(;i=this.removeNextEvent(e);)i.defer.reject(t);this.disableQueue(e)}peekNextEvent(e){const t=this.queues[e];if(Array.isArray(t))return t[0]}removeNextEvent(e){const t=this.queues[e];if(Array.isArray(t))return t.shift()}}function cs(...r){}const Wl=20;class pS{constructor(e){this.client=e,this.sending=!1,this.running=!0,this.retryTimeout=null,this.retryAttempts=0,this.sendQueue=async()=>{if(this.retryTimeout!==null&&clearTimeout(this.retryTimeout),this.retryTimeout=null,this.sending||!this.running)return;d.debug("Attempting to send queued to-device messages"),this.sending=!0;let t;try{for(;this.running&&(t=await this.client.store.getOldestToDeviceBatch(),t!==null);)await this.sendBatch(t),await this.client.store.removeToDeviceBatch(t.id),this.retryAttempts=0;if(!this.running)return;d.debug("All queued to-device messages sent")}catch(i){++this.retryAttempts;const n=Ar.RETRY_BACKOFF_RATELIMIT(null,this.retryAttempts,i);if(n===-1){Math.floor(i.httpStatus/100)===4?(d.error("Fatal error when sending to-device message - dropping to-device batch!",i),await this.client.store.removeToDeviceBatch(t.id)):d.info("Automatic retry limit reached for to-device messages.");return}d.info(`Failed to send batch of to-device messages. Will retry in ${n}ms`,i),this.retryTimeout=setTimeout(this.sendQueue,n)}finally{this.sending=!1}},this.onResumedSync=(t,i)=>{t===st.Syncing&&i!==st.Syncing&&(d.info("Resuming queue after resumed sync"),this.sendQueue())}}start(){this.running=!0,this.sendQueue(),this.client.on(ie.Sync,this.onResumedSync)}stop(){this.running=!1,this.retryTimeout!==null&&clearTimeout(this.retryTimeout),this.retryTimeout=null,this.client.removeListener(ie.Sync,this.onResumedSync)}async queueBatch(e){const t=[];for(let i=0;i<e.batch.length;i+=Wl){const n={eventType:e.eventType,batch:e.batch.slice(i,i+Wl),txnId:this.client.makeTxnId()};t.push(n);const s=n.batch.map(o=>`${o.userId}/${o.deviceId} (msgid ${o.payload[ut]})`);d.info(`Enqueuing batch of to-device messages. type=${e.eventType} txnid=${n.txnId}`,s)}await this.client.store.saveToDeviceBatches(t),this.sendQueue()}async sendBatch(e){const t=new $e(()=>new Map);for(const i of e.batch)t.getOrCreate(i.userId).set(i.deviceId,i.payload);d.info(`Sending batch of ${e.batch.length} to-device messages with ID ${e.id} and txnId ${e.txnId}`),await this.client.sendToDevice(e.eventType,t,e.txnId)}}const Po=new ot.UnstableValue("m.policies","org.matrix.msc3847.policies"),ls=new ot.UnstableValue("m.ignore.invites","org.matrix.msc3847.ignore.invites"),Hl={"m.policy.user":R.PolicyRuleUser,"m.policy.room":R.PolicyRuleRoom,"m.policy.server":R.PolicyRuleServer};class mS{constructor(e){this.client=e}async addRule(e,t,i){const n=await this.getOrCreateTargetRoom();return(await this.client.sendStateEvent(n.roomId,Hl[e],{entity:t,reason:i,recommendation:"m.ban"})).event_id}async removeRule(e){await this.client.redactEvent(e.getRoomId(),e.getId())}async addSource(e){await this.client.joinRoom(e);const t=(await this.getOrCreateSourceRooms()).map(i=>i.roomId);return t.includes(e)?!1:(t.push(e),await this.withIgnoreInvitesPolicies(i=>{i.sources=t}),!0)}async getRuleForInvite({sender:e,roomId:t}){const i=await this.getOrCreateSourceRooms(),n=e.split(":")[1],s=t.split(":")[1];for(const o of i){const a=o.getUnfilteredTimelineSet().getLiveTimeline().getState(ee.FORWARDS);for(const{scope:c,entities:l}of[{scope:"m.policy.room",entities:[t]},{scope:"m.policy.user",entities:[e]},{scope:"m.policy.server",entities:[n,s]}]){const u=a.getStateEvents(Hl[c]);for(const h of u){const f=h.getContent();if((f==null?void 0:f.recommendation)!="m.ban")continue;const g=f==null?void 0:f.entity;if(!g)continue;let m;try{m=new RegExp(Id(g))}catch{continue}for(const v of l)if(v&&m.test(v))return h}}}return null}async getOrCreateTargetRoom(){let t=this.getIgnoreInvitesPolicies().target;if(typeof t!="string"&&(t=null),t){const i=this.client.getRoom(t);if(i)return i;t=null}return t=(await this.client.createRoom({name:"Individual Policy Room",preset:sc.PrivateChat})).room_id,await this.withIgnoreInvitesPolicies(i=>{i.target=t}),this.client.getRoom(t)}async getOrCreateSourceRooms(){let t=this.getIgnoreInvitesPolicies().sources,i=!1;Array.isArray(t)||(i=!0,t=[]);let n=t.filter(s=>typeof s=="string").map(s=>this.client.getRoom(s)).filter(s=>!!s);if(n.length!=t.length&&(i=!0),n.length==0){const s=await this.getOrCreateTargetRoom();i=!0,n=[s]}return i&&await this.withIgnoreInvitesPolicies(s=>{s.sources=t}),n}getIgnoreInvitesPolicies(){return this.getPoliciesAndIgnoreInvitesPolicies().ignoreInvitesPolicies}async withIgnoreInvitesPolicies(e){const{policies:t,ignoreInvitesPolicies:i}=this.getPoliciesAndIgnoreInvitesPolicies();e(i),t[ls.name]=i,await this.client.setAccountData(Po.name,t)}getPoliciesAndIgnoreInvitesPolicies(){var n;let e={};for(const s of[Po.name,Po.altName]){if(!s)continue;const o=(n=this.client.getAccountData(s))==null?void 0:n.getContent();if(o){e=o;break}}let t={},i=!1;for(const s of[ls.name,ls.altName]){if(!s)continue;const o=e[s];if(o&&typeof o=="object"){t=o,i=!0;break}}return i||(e[ls.name]=t),{policies:e,ignoreInvitesPolicies:t}}}const Do="matrix-js-sdk";class ds{constructor(e,t){if(this.parentEvent=e,this.data=t,!(t.expires||t.expires_ts))throw new Error("Malformed membership: expires_ts or expires must be present");if(t.expires&&typeof t.expires!="number")throw new Error("Malformed membership: expires must be numeric");if(t.expires_ts&&typeof t.expires_ts!="number")throw new Error("Malformed membership: expires_ts must be numeric");if(typeof t.device_id!="string")throw new Error("Malformed membership event: device_id must be string");if(typeof t.call_id!="string")throw new Error("Malformed membership event: call_id must be string");if(typeof t.scope!="string")throw new Error("Malformed membership event: scope must be string");if(!e.getSender())throw new Error("Invalid parent event: sender is null")}static equal(e,t){return Xi(e.data,t.data)}get sender(){return this.parentEvent.getSender()}get callId(){return this.data.call_id}get deviceId(){return this.data.device_id}get application(){return this.data.application}get scope(){return this.data.scope}get membershipID(){return this.data.membershipID}createdTs(){return this.data.created_ts??this.parentEvent.getTs()}getAbsoluteExpiry(){return this.data.expires?this.createdTs()+this.data.expires:this.data.expires_ts}getLocalExpiry(){if(this.data.expires){const e=this.parentEvent.getTs()-this.createdTs();return this.parentEvent.localTimestamp-e+this.data.expires}else return this.data.expires_ts}getMsUntilExpiry(){return this.getLocalExpiry()-Date.now()}isExpired(){return this.getMsUntilExpiry()<=0}getActiveFoci(){return this.data.foci_active??[]}}const Uo=60*60*1e3,Jl=2*60*1e3,vS=3e3,zl=3e3,yS=3e3,SS=5e3,_s=(r,e)=>`${r}:${e}`,Yl=r=>_s(r.sender,r.deviceId);function ES(r,e){return r===e?!0:r&&e&&r.length===e.length&&r.every((t,i)=>t===e[i])}class An extends ke{constructor(e,t,i){var s;super(),this.client=e,this.room=t,this.memberships=i,this.setNewKeyTimeouts=new Set,this.updateCallMembershipRunning=!1,this.needCallMembershipUpdate=!1,this.manageMediaKeys=!1,this.encryptionKeys=new Map,this.sendEncryptionKeysEvent=async()=>{var l;if(this.keysEventUpdateTimeout!==void 0&&(clearTimeout(this.keysEventUpdateTimeout),this.keysEventUpdateTimeout=void 0),this.lastEncryptionKeyUpdateRequest=Date.now(),d.info("Sending encryption keys event"),!this.isJoined())return;const o=this.client.getUserId(),a=this.client.getDeviceId();if(!o)throw new Error("No userId");if(!a)throw new Error("No deviceId");const c=this.getKeysForParticipant(o,a);if(!c){d.warn("Tried to send encryption keys event but no keys found!");return}try{await this.client.sendEvent(this.room.roomId,R.CallEncryptionKeysPrefix,{keys:c.map((u,h)=>({index:h,key:Ha(u)})),device_id:a,call_id:""}),d.debug(`Embedded-E2EE-LOG updateEncryptionKeyEvent participantId=${o}:${a} numSent=${c.length}`,this.encryptionKeys)}catch(u){const h=u;if(h.event&&this.client.cancelPendingEvent(h.event),this.keysEventUpdateTimeout===void 0){const f=((l=h.data)==null?void 0:l.retry_after_ms)??5e3;d.warn(`Failed to send m.call.encryption_key, retrying in ${f}`,u),this.keysEventUpdateTimeout=setTimeout(this.sendEncryptionKeysEvent,f)}else d.info("Not scheduling key resend as another re-send is already pending")}},this.onCallEncryption=o=>{const a=o.getSender(),c=o.getContent(),l=c.device_id,u=c.call_id;if(!a){d.warn(`Received m.call.encryption_keys with no userId: callId=${u}`);return}if(u!==""){d.warn(`Received m.call.encryption_keys with unsupported callId: userId=${a}, deviceId=${l}, callId=${u}`);return}if(!Array.isArray(c.keys)){d.warn(`Received m.call.encryption_keys where keys wasn't an array: callId=${u}`);return}if(a===this.client.getUserId()&&l===this.client.getDeviceId()){d.info("Ignoring our own keys event");return}for(const h of c.keys){if(!h){d.info("Ignoring false-y key in keys event");continue}const f=h.key,g=h.index;!f||g===void 0||g===null||u===void 0||u===null||typeof l!="string"||typeof u!="string"||typeof f!="string"||typeof g!="number"?d.warn(`Malformed call encryption_key: userId=${a}, deviceId=${l}, encryptionKeyIndex=${g} callId=${u}`):(d.debug(`Embedded-E2EE-LOG onCallEncryption userId=${a}:${l} encryptionKeyIndex=${g}`,this.encryptionKeys),this.setEncryptionKey(a,l,g,f))}},this.onMembershipUpdate=()=>{var l;const o=this.memberships;this.memberships=An.callMembershipsForRoom(this.room),this._callId=this._callId??((l=this.memberships[0])==null?void 0:l.callId),(o.length!=this.memberships.length||o.some((u,h)=>!ds.equal(u,this.memberships[h])))&&(d.info(`Memberships for call in room ${this.room.roomId} have changed: emitting`),this.emit("memberships_changed",o,this.memberships));const c=u=>u.sender===this.client.getUserId()&&u.deviceId===this.client.getDeviceId();if(this.manageMediaKeys&&this.isJoined()&&this.makeNewKeyTimeout===void 0){const u=new Set(o.filter(m=>!c(m)).map(Yl)),h=new Set(this.memberships.filter(m=>!c(m)).map(Yl)),f=Array.from(u).some(m=>!h.has(m)),g=Array.from(h).some(m=>!u.has(m));f?(d.debug("Member(s) have left: queueing sender key rotation"),this.makeNewKeyTimeout=setTimeout(this.onRotateKeyTimeout,yS)):g&&(d.debug("New member(s) have joined: re-sending keys"),this.requestKeyEventSend())}this.setExpiryTimer()},this.triggerCallMembershipEventUpdate=async()=>{if(this.updateCallMembershipRunning){this.needCallMembershipUpdate=!0;return}this.updateCallMembershipRunning=!0;try{do this.needCallMembershipUpdate=!1,await this.updateCallMembershipEvent();while(this.needCallMembershipUpdate)}finally{this.updateCallMembershipRunning=!1}},this.onRotateKeyTimeout=()=>{this.manageMediaKeys&&(this.makeNewKeyTimeout=void 0,d.info("Making new sender key for key rotation"),this.makeNewSenderKey(!0),this.sendEncryptionKeysEvent())},this._callId=(s=i[0])==null?void 0:s.callId;const n=this.room.getLiveTimeline().getState(ee.FORWARDS);n==null||n.on(fe.Members,this.onMembershipUpdate),this.setExpiryTimer()}get callId(){return this._callId}static callMembershipsForRoom(e){const t=e.getLiveTimeline().getState(ee.FORWARDS);if(!t)throw d.warn("Couldn't get state for room "+e.roomId),new Error("Could't get state for room "+e.roomId);const i=t.getStateEvents(R.GroupCallMemberPrefix),n=[];for(const s of i){const o=s.getContent().memberships;if(o===void 0){d.debug(`Ignoring malformed member event from ${s.getSender()}: no memberships section`);continue}if(!Array.isArray(o)){d.warn(`Malformed member event from ${s.getSender()}: memberships is not an array`);continue}for(const a of o)try{const c=new ds(s,a);if(c.callId!==""||c.scope!=="m.room"){d.info("Ignoring user-scoped call");continue}if(c.isExpired()){d.info(`Ignoring expired device membership ${c.sender}/${c.deviceId}`);continue}if(!e.hasMembershipState(c.sender??"",ae.Join)){d.info(`Ignoring membership of user ${c.sender} who is not in the room.`);continue}n.push(c)}catch(c){d.warn("Couldn't construct call membership: ",c)}}return n.sort((s,o)=>s.createdTs()-o.createdTs()),n.length>1&&d.debug(`Call memberships in room ${e.roomId}, in order: `,n.map(s=>[s.createdTs(),s.sender])),n}static roomSessionForRoom(e,t){const i=An.callMembershipsForRoom(t);return new An(e,t,i)}isJoined(){return this.relativeExpiry!==void 0}async stop(){await this.leaveRoomSession(1e3),this.expiryTimeout&&(clearTimeout(this.expiryTimeout),this.expiryTimeout=void 0),this.memberEventTimeout&&(clearTimeout(this.memberEventTimeout),this.memberEventTimeout=void 0);const e=this.room.getLiveTimeline().getState(ee.FORWARDS);e==null||e.off(fe.Members,this.onMembershipUpdate)}joinRoomSession(e,t){if(this.isJoined()){d.info(`Already joined to session in room ${this.room.roomId}: ignoring join call`);return}d.info(`Joining call session in room ${this.room.roomId} with manageMediaKeys=${t}`),this.activeFoci=e,this.relativeExpiry=Uo,this.manageMediaKeys=t??!1,this.membershipId=rn(5),this.emit("join_state_changed",!0),t&&(this.makeNewSenderKey(),this.requestKeyEventSend()),this.triggerCallMembershipEventUpdate()}async leaveRoomSession(e=void 0){if(!this.isJoined())return d.info(`Not joined to session in room ${this.room.roomId}: ignoring leave call`),new Promise(s=>s(!1));const t=this.client.getUserId(),i=this.client.getDeviceId();if(!t)throw new Error("No userId");if(!i)throw new Error("No deviceId");this.encryptionKeys.set(_s(t,i),[]),this.makeNewKeyTimeout!==void 0&&(clearTimeout(this.makeNewKeyTimeout),this.makeNewKeyTimeout=void 0);for(const s of this.setNewKeyTimeouts)clearTimeout(s);this.setNewKeyTimeouts.clear(),d.info(`Leaving call session in room ${this.room.roomId}`),this.relativeExpiry=void 0,this.activeFoci=void 0,this.manageMediaKeys=!1,this.membershipId=void 0,this.emit("join_state_changed",!1);const n=new Promise(s=>{e&&setTimeout(s,e,"timeout")});return new Promise(s=>{Promise.race([this.triggerCallMembershipEventUpdate(),n]).then(o=>{s(o!="timeout")})})}getKeysForParticipant(e,t){return this.encryptionKeys.get(_s(e,t))}getEncryptionKeys(){return this.encryptionKeys.entries()}getNewEncryptionKeyIndex(){var i;const e=this.client.getUserId(),t=this.client.getDeviceId();if(!e)throw new Error("No userId!");if(!t)throw new Error("No deviceId!");return(((i=this.getKeysForParticipant(e,t))==null?void 0:i.length)??0)%16}setEncryptionKey(e,t,i,n,s=!1){const o=tt(n),a=_s(e,t),c=this.encryptionKeys.get(a)??[];if(!ES(c[i],o))if(c[i]=o,this.encryptionKeys.set(a,c),s){const l=setTimeout(()=>{this.setNewKeyTimeouts.delete(l),d.info(`Delayed-emitting key changed event for ${a} idx ${i}`),this.emit("encryption_key_changed",o,i,a)},SS);this.setNewKeyTimeouts.add(l)}else this.emit("encryption_key_changed",o,i,a)}makeNewSenderKey(e=!1){const t=this.client.getUserId(),i=this.client.getDeviceId();if(!t)throw new Error("No userId");if(!i)throw new Error("No deviceId");const n=zm(16),s=this.getNewEncryptionKeyIndex();d.info("Generated new key at index "+s),this.setEncryptionKey(t,i,s,n,e)}requestKeyEventSend(){if(this.manageMediaKeys){if(this.lastEncryptionKeyUpdateRequest&&this.lastEncryptionKeyUpdateRequest+zl>Date.now()){d.info("Last encryption key event sent too recently: postponing"),this.keysEventUpdateTimeout===void 0&&(this.keysEventUpdateTimeout=setTimeout(this.sendEncryptionKeysEvent,zl));return}this.sendEncryptionKeysEvent()}}setExpiryTimer(){this.expiryTimeout&&(clearTimeout(this.expiryTimeout),this.expiryTimeout=void 0);let e;for(const t of this.memberships){const i=t.getMsUntilExpiry();(e===void 0||i<e)&&(e=i)}e!=null&&(this.expiryTimeout=setTimeout(this.onMembershipUpdate,e))}getOldestMembership(){return this.memberships[0]}makeMyMembership(e){if(this.relativeExpiry===void 0)throw new Error("Tried to create our own membership event when we're not joined!");if(this.membershipId===void 0)throw new Error("Tried to create our own membership event when we have no membership ID!");const t={call_id:"",scope:"m.room",application:"m.call",device_id:this.client.getDeviceId(),expires:this.relativeExpiry,foci_active:this.activeFoci,membershipID:this.membershipId};return e&&(t.created_ts=e.createdTs()),t.created_ts?t.expires_ts=t.created_ts+(t.expires??0):t.expires_ts=Date.now()+(t.expires??0),t}membershipEventNeedsUpdate(e,t){let i=!1;return!this.isJoined()&&e&&(i=!0),this.isJoined()&&(t?t.getMsUntilExpiry()<Uo/2&&(i=!0,this.relativeExpiry+=Uo):i=!0),i}makeNewMemberships(e,t,i){const n=this.client.getDeviceId();if(!n)throw new Error("Local device ID is null!");const s=c=>{let l;try{l=new ds(t,c)}catch{return!1}return!l.isExpired()},o=c=>(c.created_ts===void 0&&(c.created_ts=t.getTs()),c);let a=e.filter(s).filter(c=>c.device_id!==n);return a=a.map(o),this.isJoined()&&a.push(this.makeMyMembership(i)),a}async updateCallMembershipEvent(){this.memberEventTimeout&&(clearTimeout(this.memberEventTimeout),this.memberEventTimeout=void 0);const e=this.room.getLiveTimeline().getState(ee.FORWARDS);if(!e)throw new Error("Couldn't get room state for room "+this.room.roomId);const t=this.client.getUserId(),i=this.client.getDeviceId();if(!t||!i)throw new Error("User ID or device ID was null!");const n=e.getStateEvents(R.GroupCallMemberPrefix,t)??void 0,s=(n==null?void 0:n.getContent())??{},o=Array.isArray(s.memberships)?s.memberships:[],a=o.find(u=>u.device_id===i);let c;try{n&&a&&a.membershipID===this.membershipId&&(c=new ds(n,a))}catch(u){d.warn("Our previous call membership was invalid - this shouldn't happen.",u)}if(c&&d.debug(`${c.getMsUntilExpiry()} until our membership expires`),!this.membershipEventNeedsUpdate(a,c)){this.memberEventTimeout=setTimeout(this.triggerCallMembershipEventUpdate,Jl);return}const l={memberships:this.makeNewMemberships(o,n,c)};try{await this.client.sendStateEvent(this.room.roomId,R.GroupCallMemberPrefix,l,t),d.info("Sent updated call member event."),this.isJoined()&&(this.memberEventTimeout=setTimeout(this.triggerCallMembershipEventUpdate,Jl))}catch{const h=vS+Math.random()*2e3;d.warn(`Failed to send call member event: retrying in ${h}`),await new Promise(f=>setTimeout(f,h)),await this.triggerCallMembershipEventUpdate()}}}class bS extends ke{constructor(e){super(),this.client=e,this.roomSessions=new Map,this.onTimeline=t=>{this.consumeCallEncryptionEvent(t)},this.onRoom=t=>{this.refreshRoom(t)},this.onRoomState=(t,i)=>{const n=this.client.getRoom(t.getRoomId());if(!n){d.error(`Got room state event for unknown room ${t.getRoomId()}!`);return}t.getType()==R.GroupCallMemberPrefix&&this.refreshRoom(n)}}start(){for(const e of this.client.getRooms()??[]){const t=An.roomSessionForRoom(this.client,e);t.memberships.length>0&&this.roomSessions.set(e.roomId,t)}this.client.on(ie.Room,this.onRoom),this.client.on(de.Timeline,this.onTimeline),this.client.on(fe.Events,this.onRoomState)}stop(){for(const e of this.roomSessions.values())e.stop();this.roomSessions.clear(),this.client.removeListener(ie.Room,this.onRoom),this.client.removeListener(de.Timeline,this.onTimeline),this.client.removeListener(fe.Events,this.onRoomState)}getActiveRoomSession(e){return this.roomSessions.get(e.roomId)}getRoomSession(e){return this.roomSessions.has(e.roomId)||this.roomSessions.set(e.roomId,An.roomSessionForRoom(this.client,e)),this.roomSessions.get(e.roomId)}async consumeCallEncryptionEvent(e){if(await this.client.decryptEventIfNeeded(e),e.getType()!==R.CallEncryptionKeysPrefix)return Promise.resolve();const t=this.client.getRoom(e.getRoomId());if(!t)return d.error(`Got room state event for unknown room ${e.getRoomId()}!`),Promise.resolve();this.getRoomSession(t).onCallEncryption(e)}refreshRoom(e){const t=!this.roomSessions.has(e.roomId),i=this.getRoomSession(e),n=i.memberships.length>0&&!t;i.onMembershipUpdate();const s=i.memberships.length>0;n&&!s?this.emit("session_ended",e.roomId,this.roomSessions.get(e.roomId)):!n&&s&&this.emit("session_started",e.roomId,this.roomSessions.get(e.roomId))}}function Lo(r){return e=>{var t,i,n,s;return((i=(t=e.content)==null?void 0:t["m.relates_to"])==null?void 0:i.event_id)!==r||((s=(n=e.content)==null?void 0:n["m.relates_to"])==null?void 0:s.rel_type)===_e.name}}var pn={};const wS=3e3,_S=216e5,Ql=10*60*1e3;new Ce("last_seen_user_agent","org.matrix.msc3852.last_seen_user_agent");var Ln=(r=>(r.Chronological="chronological",r.Detached="detached",r))(Ln||{}),Ju=(r=>(r.Stable="stable",r.Unstable="unstable",r))(Ju||{});new $a("m.get_login_token","org.matrix.msc3882.get_login_token");const IS="uk.half-shot.msc2666",RS="uk.half-shot.msc2666.mutual_rooms",TS="uk.half-shot.msc2666.query_mutual_rooms",$t="$";var ie=(r=>(r.Sync="sync",r.Event="event",r.ToDeviceEvent="toDeviceEvent",r.AccountData="accountData",r.Room="Room",r.DeleteRoom="deleteRoom",r.SyncUnexpectedError="sync.unexpectedError",r.ClientWellKnown="WellKnown.client",r.ReceivedVoipEvent="received_voip_event",r.UndecryptableToDeviceEvent="toDeviceEvent.undecryptable",r.TurnServers="turnServers",r.TurnServersError="turnServers.error",r))(ie||{});const CS=new Ce("action","org.matrix.msc3824.action"),uc=class uc extends ke{constructor(e){super(),this.reEmitter=new qn(this),this.olmVersion=null,this.usingExternalCrypto=!1,this.clientRunning=!1,this.timelineSupport=!1,this.urlPreviewCache={},this.supportsCallTransfer=!1,this.forceTURN=!1,this.iceCandidatePoolSize=0,this.canSupportVoip=!1,this.peekSync=null,this.isGuestAccount=!1,this.ongoingScrollbacks={},this.notifTimelineSet=null,this.fallbackICEServerAllowed=!1,this.syncedLeftRooms=!1,this.canSupport=new Map,this.pushProcessor=new Us(this),this.turnServers=[],this.turnServersExpiry=0,this.txnCtr=0,this.mediaHandler=new aS(this),this.eventsBeingEncrypted=new Set,this.useE2eForGroupCall=!0,this.startCallEventHandler=()=>{this.isInitialSyncComplete()&&(Ia()&&(this.callEventHandler.start(),this.groupCallEventHandler.start()),this.off("sync",this.startCallEventHandler))},this.startMatrixRTC=()=>{this.isInitialSyncComplete()&&(this.matrixRTC.start(),this.off("sync",this.startMatrixRTC))},this.fixupRoomNotifications=()=>{if(this.isInitialSyncComplete()){const i=(this.getRooms()??[]).filter(n=>n.getUnreadNotificationCount(Be.Total)>0);for(const n of i){const s=this.getSafeUserId();n.fixupNotifications(s)}this.off("sync",this.fixupRoomNotifications)}},this.logger=e.logger??d,e.baseUrl=fo(e.baseUrl),e.idBaseUrl=fo(e.idBaseUrl),this.baseUrl=e.baseUrl,this.idBaseUrl=e.idBaseUrl,this.identityServer=e.identityServer,this.usingExternalCrypto=e.usingExternalCrypto??!1,this.store=e.store||new Dm,this.deviceId=e.deviceId||null,this.sessionId=rn(10);const t=e.userId||null;this.credentials={userId:t},this.http=new km(this,{fetchFn:e.fetchFn,baseUrl:e.baseUrl,idBaseUrl:e.idBaseUrl,accessToken:e.accessToken,refreshToken:e.refreshToken,tokenRefreshFunction:e.tokenRefreshFunction,prefix:Pe.V3,onlyData:!0,extraParams:e.queryParams,localTimeoutMs:e.localTimeoutMs,useAuthorizationHeader:e.useAuthorizationHeader,logger:this.logger}),e.deviceToImport?this.deviceId?this.logger.warn("not importing device because device ID is provided to constructor independently of exported data"):this.credentials.userId?this.logger.warn("not importing device because user ID is provided to constructor independently of exported data"):e.deviceToImport.deviceId?(this.deviceId=e.deviceToImport.deviceId,this.credentials.userId=e.deviceToImport.userId,this.exportedOlmDeviceToImport=e.deviceToImport.olmDevice):this.logger.warn("not importing device because no device ID in exported data"):e.pickleKey&&(this.pickleKey=e.pickleKey),this.useLivekitForGroupCalls=!!e.useLivekitForGroupCalls,this.scheduler=e.scheduler,this.scheduler&&this.scheduler.setProcessFunction(async i=>{const n=this.getRoom(i.getRoomId());i.status!==se.SENDING&&this.updatePendingEventStatus(n,i,se.SENDING);const s=await this.sendEventHttpRequest(i);return n&&n.updatePendingEvent(i,se.SENT,s.event_id),s}),Ia()&&(this.callEventHandler=new nv(this),this.groupCallEventHandler=new rv(this),this.canSupportVoip=!0,this.on("sync",this.startCallEventHandler)),this.matrixRTC=new bS(this),this.on("sync",this.fixupRoomNotifications),this.timelineSupport=!!e.timelineSupport,this.cryptoStore=e.cryptoStore,this.verificationMethods=e.verificationMethods,this.cryptoCallbacks=e.cryptoCallbacks||{},this.forceTURN=e.forceTURN||!1,this.iceCandidatePoolSize=e.iceCandidatePoolSize===void 0?0:e.iceCandidatePoolSize,this.supportsCallTransfer=e.supportsCallTransfer||!1,this.fallbackICEServerAllowed=e.fallbackICEServerAllowed||!1,this.isVoipWithNoMediaAllowed=e.isVoipWithNoMediaAllowed||!1,e.useE2eForGroupCall!==void 0&&(this.useE2eForGroupCall=e.useE2eForGroupCall),this.livekitServiceURL=e.livekitServiceURL,this.roomNameGenerator=e.roomNameGenerator,this.toDeviceMessageQueue=new pS(this),this.on(be.Decrypted,i=>{kS(this,i)}),this.ignoredInvites=new mS(this),this._secretStorage=new Ns(this,e.cryptoCallbacks??{}),this.setMaxListeners(0)}set store(e){this._store=e,this._store.setUserCreator(t=>ki.createUser(t,this))}get store(){return this._store}async startClient(e){if(this.clientRunning)return;this.clientRunning=!0,this.on("sync",this.startMatrixRTC),typeof e=="number"&&(e={initialSyncLimit:e});const t=this.getUserId();t&&this.store.storeUser(new ki(t)),this.canSupportVoip&&(this.checkTurnServersIntervalID=setInterval(()=>{this.checkTurnServers()},Ql),this.checkTurnServers()),this.syncApi&&(this.logger.error("Still have sync object whilst not running: stopping old one"),this.syncApi.stop());try{await this.getVersions();const{threads:i,list:n,fwdPagination:s}=await this.doesServerSupportThread();et.setServerSideSupport(i),et.setServerSideListSupport(n),et.setServerSideFwdPaginationSupport(s)}catch(i){this.logger.error("Can't fetch server versions, continuing to initialise sync, this will be retried later",i)}this.clientOpts=e??{},this.clientOpts.slidingSync?this.syncApi=new Gu(this.clientOpts.slidingSync,this,this.clientOpts,this.buildSyncApiOptions()):this.syncApi=new pr(this,this.clientOpts,this.buildSyncApiOptions()),this.syncApi.sync().catch(i=>this.logger.info("Sync startup aborted with an error:",i)),this.clientOpts.clientWellKnownPollPeriod!==void 0&&(this.clientWellKnownIntervalID=setInterval(()=>{this.fetchClientWellKnown()},1e3*this.clientOpts.clientWellKnownPollPeriod),this.fetchClientWellKnown()),this.toDeviceMessageQueue.start()}buildSyncApiOptions(){return{crypto:this.crypto,cryptoCallbacks:this.cryptoBackend,canResetEntireTimeline:e=>this.canResetTimelineCallback?this.canResetTimelineCallback(e):!1}}stopClient(){var e,t,i,n,s;(e=this.cryptoBackend)==null||e.stop(),this.off("sync",this.startMatrixRTC),this.clientRunning&&(this.logger.debug("stopping MatrixClient"),this.clientRunning=!1,(t=this.syncApi)==null||t.stop(),this.syncApi=void 0,(i=this.peekSync)==null||i.stopPeeking(),(n=this.callEventHandler)==null||n.stop(),(s=this.groupCallEventHandler)==null||s.stop(),this.callEventHandler=void 0,this.groupCallEventHandler=void 0,pn.clearInterval(this.checkTurnServersIntervalID),this.checkTurnServersIntervalID=void 0,this.clientWellKnownIntervalID!==void 0&&pn.clearInterval(this.clientWellKnownIntervalID),this.toDeviceMessageQueue.stop(),this.matrixRTC.stop())}async rehydrateDevice(){if(this.crypto)throw new Error("Cannot rehydrate device after crypto is initialized");if(!this.cryptoCallbacks.getDehydrationKey)return;const e=await this.getDehydratedDevice();if(!e)return;if(!e.device_data||!e.device_id){this.logger.info("no dehydrated device found");return}const t=new pn.Olm.Account;try{const i=e.device_data;if(i.algorithm!==bs){this.logger.warn("Wrong algorithm for dehydrated device");return}this.logger.debug("unpickling dehydrated device");const n=await this.cryptoCallbacks.getDehydrationKey(i,o=>{t.unpickle(new Uint8Array(o),i.account)});if(t.unpickle(n,i.account),this.logger.debug("unpickled device"),(await this.http.authedRequest(D.Post,"/dehydrated_device/claim",void 0,{device_id:e.device_id},{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})).success){this.deviceId=e.device_id,this.logger.info("using dehydrated device");const o=this.pickleKey||"DEFAULT_KEY";return this.exportedOlmDeviceToImport={pickledAccount:t.pickle(o),sessions:[],pickleKey:o},t.free(),this.deviceId}else{t.free(),this.logger.info("not using dehydrated device");return}}catch(i){t.free(),this.logger.warn("could not unpickle",i)}}async getDehydratedDevice(){try{return await this.http.authedRequest(D.Get,"/dehydrated_device",void 0,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})}catch(e){this.logger.info("could not get dehydrated device",e);return}}async setDehydrationKey(e,t,i){if(!this.crypto){this.logger.warn("not dehydrating device if crypto is not enabled");return}return this.crypto.dehydrationManager.setKeyAndQueueDehydration(e,t,i)}async createDehydratedDevice(e,t,i){if(!this.crypto){this.logger.warn("not dehydrating device if crypto is not enabled");return}return await this.crypto.dehydrationManager.setKey(e,t,i),this.crypto.dehydrationManager.dehydrateDevice()}async exportDevice(){if(!this.crypto){this.logger.warn("not exporting device if crypto is not enabled");return}return{userId:this.credentials.userId,deviceId:this.deviceId,olmDevice:await this.crypto.olmDevice.export()}}clearStores(){if(this.clientRunning)throw new Error("Cannot clear stores while client is running");const e=[];e.push(this.store.deleteAllData()),this.cryptoStore&&e.push(this.cryptoStore.deleteAllData());const t=async()=>{let i;try{if(i=pn.indexedDB,!i)return}catch{return}for(const n of[`${Do}::matrix-sdk-crypto`,`${Do}::matrix-sdk-crypto-meta`])await new Promise((o,a)=>{this.logger.info(`Removing IndexedDB instance ${n}`);const c=i.deleteDatabase(n);c.onsuccess=l=>{this.logger.info(`Removed IndexedDB instance ${n}`),o(0)},c.onerror=l=>{this.logger.warn(`Failed to remove IndexedDB instance ${n}:`,l),o(0)},c.onblocked=l=>{this.logger.info(`cannot yet remove IndexedDB instance ${n}`)}})};return e.push(t()),Promise.all(e).then()}getUserId(){return this.credentials&&this.credentials.userId?this.credentials.userId:null}getSafeUserId(){const e=this.getUserId();if(!e)throw new Error("Expected logged in user but found none.");return e}getDomain(){return this.credentials&&this.credentials.userId?this.credentials.userId.replace(/^.*?:/,""):null}getUserIdLocalpart(){return this.credentials&&this.credentials.userId?this.credentials.userId.split(":")[0].substring(1):null}getDeviceId(){return this.deviceId}getSessionId(){return this.sessionId}supportsVoip(){return this.canSupportVoip}getMediaHandler(){return this.mediaHandler}setForceTURN(e){this.forceTURN=e}setSupportsCallTransfer(e){this.supportsCallTransfer=e}getUseE2eForGroupCall(){return this.useE2eForGroupCall}createCall(e){return Ds(this,e)}async createGroupCall(e,t,i,n,s,o){if(this.getGroupCallForRoom(e))throw new Error(`${e} already has an existing group call`);const a=this.getRoom(e);if(!a)throw new Error(`Cannot find room ${e}`);return new Su(this,a,t,i,n,void 0,s||this.isVoipWithNoMediaAllowed,o,this.isVoipWithNoMediaAllowed,this.useLivekitForGroupCalls,this.livekitServiceURL).create()}getLivekitServiceURL(){return this.livekitServiceURL}setLivekitServiceURL(e){this.livekitServiceURL=e}waitUntilRoomReadyForGroupCalls(e){return this.groupCallEventHandler.waitUntilRoomReadyForGroupCalls(e)}getGroupCallForRoom(e){return this.groupCallEventHandler.groupCalls.get(e)||null}getSyncState(){var e;return((e=this.syncApi)==null?void 0:e.getSyncState())??null}getSyncStateData(){return this.syncApi?this.syncApi.getSyncStateData():null}isInitialSyncComplete(){const e=this.getSyncState();return e?e===st.Prepared||e===st.Syncing:!1}isGuest(){return this.isGuestAccount}setGuest(e){this.isGuestAccount=e}getScheduler(){return this.scheduler}retryImmediately(){var e;return this.toDeviceMessageQueue.sendQueue(),((e=this.syncApi)==null?void 0:e.retryImmediately())??!1}getNotifTimelineSet(){return this.notifTimelineSet}setNotifTimelineSet(e){this.notifTimelineSet=e}getCapabilities(e=!1){const t=new Date().getTime();return this.cachedCapabilities&&!e&&t<this.cachedCapabilities.expiration?(this.logger.debug("Returning cached capabilities"),Promise.resolve(this.cachedCapabilities.capabilities)):this.http.authedRequest(D.Get,"/capabilities").catch(i=>(this.logger.error(i),{})).then((i={})=>{const n=i.capabilities||{},s=Object.keys(n).length?_S:6e4+Math.random()*5e3;return this.cachedCapabilities={capabilities:n,expiration:t+s},this.logger.debug("Caching capabilities: ",n),n})}async initCrypto(){if(!Zy())throw new Error("End-to-end encryption not supported in this js-sdk build: did you remember to load the olm library?");if(this.cryptoBackend){this.logger.warn("Attempt to re-initialise e2e encryption on MatrixClient");return}if(!this.cryptoStore)throw new Error("Cannot enable encryption: no cryptoStore provided");this.logger.debug("Crypto: Starting up crypto store..."),await this.cryptoStore.startup();const e=this.getUserId();if(e===null)throw new Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");if(this.deviceId===null)throw new Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");const t=new $s(this,e,this.deviceId,this.store,this.cryptoStore,this.verificationMethods);this.reEmitter.reEmit(t,[me.KeyBackupFailed,me.KeyBackupSessionsRemaining,me.RoomKeyRequest,me.RoomKeyRequestCancellation,me.Warning,me.DevicesUpdated,me.WillUpdateDevices,me.DeviceVerificationChanged,me.UserTrustStatusChanged,me.KeysChanged]),this.logger.debug("Crypto: initialising crypto object..."),await t.init({exportedOlmDevice:this.exportedOlmDeviceToImport,pickleKey:this.pickleKey}),delete this.exportedOlmDeviceToImport,this.olmVersion=$s.getOlmVersion(),t.registerEventHandlers(this),this.cryptoBackend=this.crypto=t,this.crypto.uploadDeviceKeys().catch(i=>{this.logger.error("Error uploading device keys",i)})}async initRustCrypto({useIndexedDB:e=!0}={}){if(this.cryptoBackend){this.logger.warn("Attempt to re-initialise e2e encryption on MatrixClient");return}const t=this.getUserId();if(t===null)throw new Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");const i=this.getDeviceId();if(i===null)throw new Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");this.logger.debug("Downloading Rust crypto library");const s=await(await Np(()=>import("./index-gPIPSbpu.js"),[],import.meta.url)).initRustCrypto({logger:this.logger,http:this.http,userId:t,deviceId:i,secretStorage:this.secretStorage,cryptoCallbacks:this.cryptoCallbacks,storePrefix:e?Do:null,storePassphrase:this.pickleKey,legacyCryptoStore:this.cryptoStore,legacyPickleKey:this.pickleKey??"DEFAULT_KEY",legacyMigrationProgressListener:(o,a)=>{this.emit(me.LegacyCryptoStoreMigrationProgress,o,a)}});s.setSupportedVerificationMethods(this.verificationMethods),this.cryptoBackend=s,this.on(Nt.Membership,s.onRoomMembership.bind(s)),this.on("event",o=>{s.onLiveEventFromSync(o)}),this.reEmitter.reEmit(s,[me.VerificationRequestReceived,me.UserTrustStatusChanged,me.KeyBackupStatus,me.KeyBackupSessionsRemaining,me.KeyBackupFailed,me.KeyBackupDecryptionKeyCached,me.KeysChanged,me.DevicesUpdated,me.WillUpdateDevices])}get secretStorage(){return this._secretStorage}getCrypto(){return this.cryptoBackend}isCryptoEnabled(){return!!this.cryptoBackend}getDeviceEd25519Key(){var e;return((e=this.crypto)==null?void 0:e.getDeviceEd25519Key())??null}getDeviceCurve25519Key(){var e;return((e=this.crypto)==null?void 0:e.getDeviceCurve25519Key())??null}async uploadKeys(){this.logger.warn("MatrixClient.uploadKeys is deprecated")}downloadKeys(e,t){return this.crypto?this.crypto.downloadKeys(e,t):Promise.reject(new Error("End-to-end encryption disabled"))}getStoredDevicesForUser(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getStoredDevicesForUser(e)||[]}getStoredDevice(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getStoredDevice(e,t)||null}setDeviceVerified(e,t,i=!0){const n=this.setDeviceVerification(e,t,i,null,null);return e==this.credentials.userId&&this.checkKeyBackup(),n}setDeviceBlocked(e,t,i=!0){return this.setDeviceVerification(e,t,null,i,null)}setDeviceKnown(e,t,i=!0){return this.setDeviceVerification(e,t,null,null,i)}async setDeviceVerification(e,t,i,n,s){if(!this.crypto)throw new Error("End-to-end encryption disabled");await this.crypto.setDeviceVerification(e,t,i,n,s)}requestVerificationDM(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestVerificationDM(e,t)}findVerificationRequestDMInProgress(e){if(this.cryptoBackend){if(!this.crypto)return}else throw new Error("End-to-end encryption disabled");return this.crypto.findVerificationRequestDMInProgress(e)}getVerificationRequestsToDeviceInProgress(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getVerificationRequestsToDeviceInProgress(e)}requestVerification(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestVerification(e,t)}beginKeyVerification(e,t,i){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.beginKeyVerification(e,t,i)}checkSecretStorageKey(e,t){return this.secretStorage.checkKey(e,t)}setGlobalBlacklistUnverifiedDevices(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.globalBlacklistUnverifiedDevices=e,e}getGlobalBlacklistUnverifiedDevices(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.globalBlacklistUnverifiedDevices}setGlobalErrorOnUnknownDevices(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");this.cryptoBackend.globalErrorOnUnknownDevices=e}getGlobalErrorOnUnknownDevices(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.globalErrorOnUnknownDevices}getCrossSigningId(e=ec.Master){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getCrossSigningId(e)}getStoredCrossSigningForUser(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.getStoredCrossSigningForUser(e)}checkUserTrust(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.checkUserTrust(e)}checkDeviceTrust(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkDeviceTrust(e,t)}checkIfOwnDeviceCrossSigned(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkIfOwnDeviceCrossSigned(e)}checkOwnCrossSigningTrust(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.checkOwnCrossSigningTrust(e)}checkCrossSigningPrivateKey(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkCrossSigningPrivateKey(e,t)}legacyDeviceVerification(e,t,i){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.legacyDeviceVerification(e,t,i)}prepareToEncrypt(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");this.cryptoBackend.prepareToEncrypt(e)}userHasCrossSigningKeys(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.userHasCrossSigningKeys()}isCrossSigningReady(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.isCrossSigningReady()}bootstrapCrossSigning(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.bootstrapCrossSigning(e)}getCryptoTrustCrossSignedDevices(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.getTrustCrossSignedDevices()}setCryptoTrustCrossSignedDevices(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");this.cryptoBackend.setTrustCrossSignedDevices(e)}countSessionsNeedingBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.countSessionsNeedingBackup()}getEventEncryptionInfo(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.getEventEncryptionInfo(e)}createRecoveryKeyFromPassphrase(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.createRecoveryKeyFromPassphrase(e)}isSecretStorageReady(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.isSecretStorageReady()}bootstrapSecretStorage(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.bootstrapSecretStorage(e)}addSecretStorageKey(e,t,i){return this.secretStorage.addKey(e,t,i)}hasSecretStorageKey(e){return this.secretStorage.hasKey(e)}storeSecret(e,t,i){return this.secretStorage.store(e,t,i)}getSecret(e){return this.secretStorage.get(e)}isSecretStored(e){return this.secretStorage.isStored(e)}requestSecret(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestSecret(e,t)}getDefaultSecretStorageKeyId(){return this.secretStorage.getDefaultKeyId()}setDefaultSecretStorageKeyId(e){return this.secretStorage.setDefaultKeyId(e)}checkSecretStoragePrivateKey(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkSecretStoragePrivateKey(e,t)}async getEventSenderDeviceInfo(e){return this.crypto?this.crypto.getEventSenderDeviceInfo(e):null}async isEventSenderVerified(e){const t=await this.getEventSenderDeviceInfo(e);return t?t.isVerified():!1}getOutgoingRoomKeyRequest(e){if(!this.crypto)throw new Error("End-to-End encryption disabled");const t=e.getWireContent(),i={session_id:t.session_id,sender_key:t.sender_key,algorithm:t.algorithm,room_id:e.getRoomId()};return!i.session_id||!i.sender_key||!i.algorithm||!i.room_id?Promise.resolve(null):this.crypto.cryptoStore.getOutgoingRoomKeyRequest(i)}cancelAndResendEventRoomKeyRequest(e){if(!this.crypto)throw new Error("End-to-End encryption disabled");return e.cancelAndResendKeyRequest(this.crypto,this.getUserId())}setRoomEncryption(e,t){if(!this.crypto)throw new Error("End-to-End encryption disabled");return this.crypto.setRoomEncryption(e,t)}isRoomEncrypted(e){var i;const t=this.getRoom(e);return t?t.hasEncryptionStateEvent()?!0:((i=this.crypto)==null?void 0:i.isRoomEncrypted(e))??!1:!1}encryptAndSendToDevices(e,t){if(!this.crypto)throw new Error("End-to-End encryption disabled");return this.crypto.encryptAndSendToDevices(e,t)}forceDiscardSession(e){if(!this.cryptoBackend)throw new Error("End-to-End encryption disabled");this.cryptoBackend.forceDiscardSession(e)}exportRoomKeys(){return this.cryptoBackend?this.cryptoBackend.exportRoomKeys():Promise.reject(new Error("End-to-end encryption disabled"))}importRoomKeys(e,t){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.importRoomKeys(e,t)}checkKeyBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.checkKeyBackup()}async getKeyBackupVersion(){let e;try{e=await this.http.authedRequest(D.Get,"/room_keys/version",void 0,void 0,{prefix:Pe.V3})}catch(t){if(t.errcode==="M_NOT_FOUND")return null;throw t}return Qi.checkBackupVersion(e),e}isKeyBackupTrusted(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.isKeyBackupTrusted(e)}getKeyBackupEnabled(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.getKeyBackupEnabled()}enableKeyBackup(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.enableKeyBackup(e)}disableKeyBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");this.crypto.backupManager.disableKeyBackup()}async prepareKeyBackupVersion(e,t={secureSecretStorage:!1}){if(!this.crypto)throw new Error("End-to-end encryption disabled");const{algorithm:i,auth_data:n,recovery_key:s,privateKey:o}=await this.crypto.backupManager.prepareKeyBackupVersion(e);return t.secureSecretStorage&&(await this.secretStorage.store("m.megolm_backup.v1",lt(o)),this.logger.info("Key backup private key stored in secret storage")),{algorithm:i,auth_data:n,recovery_key:s}}isKeyBackupKeyStored(){return Promise.resolve(this.secretStorage.isStored("m.megolm_backup.v1"))}async createKeyBackupVersion(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");await this.crypto.backupManager.createKeyBackupVersion(e);const t={algorithm:e.algorithm,auth_data:e.auth_data};await this.crypto.signObject(t.auth_data),this.cryptoCallbacks.getCrossSigningKey&&this.crypto.crossSigningInfo.getId()&&await this.crypto.crossSigningInfo.signObject(t.auth_data,"master");const i=await this.http.authedRequest(D.Post,"/room_keys/version",void 0,t);return await this.checkKeyBackup(),this.getKeyBackupEnabled()||this.logger.error("Key backup not usable even though we just created it"),i}async deleteKeyBackupVersion(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");await this.cryptoBackend.deleteKeyBackupVersion(e)}makeKeyBackupPath(e,t,i){let n;return t!==void 0?n=W("/room_keys/keys/$roomId/$sessionId",{$roomId:e,$sessionId:t}):e!==void 0?n=W("/room_keys/keys/$roomId",{$roomId:e}):n="/room_keys/keys",{path:n,queryData:i===void 0?void 0:{version:i}}}async sendKeyBackup(e,t,i,n){if(!this.crypto)throw new Error("End-to-end encryption disabled");const s=this.makeKeyBackupPath(e,t,i);await this.http.authedRequest(D.Put,s.path,s.queryData,n,{prefix:Pe.V3})}async scheduleAllGroupSessionsForBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");await this.crypto.backupManager.scheduleAllGroupSessionsForBackup()}flagAllGroupSessionsForBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.flagAllGroupSessionsForBackup()}isValidRecoveryKey(e){try{return Es(e),!0}catch{return!1}}keyBackupKeyFromPassword(e,t){return Ll(t.auth_data,e)}keyBackupKeyFromRecoveryKey(e){return Es(e)}async restoreKeyBackupWithPassword(e,t,i,n,s){const o=await Ll(n.auth_data,e);return this.restoreKeyBackup(o,t,i,n,s)}async restoreKeyBackupWithSecretStorage(e,t,i,n){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");const s=await this.secretStorage.get("m.megolm_backup.v1"),o=ws(s);if(o){const c=await this.secretStorage.getKey();await this.secretStorage.store("m.megolm_backup.v1",o,[c[0]])}const a=tt(o||s);return this.restoreKeyBackup(a,t,i,e,n)}restoreKeyBackupWithRecoveryKey(e,t,i,n,s){const o=Es(e);return this.restoreKeyBackup(o,t,i,n,s)}async restoreKeyBackupWithCache(e,t,i,n){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");const s=await this.cryptoBackend.getSessionBackupPrivateKey();if(!s)throw new Error("Couldn't get key");return this.restoreKeyBackup(s,e,t,i,n)}async restoreKeyBackup(e,t,i,n,s){const o=s==null?void 0:s.cacheCompleteCallback,a=s==null?void 0:s.progressCallback;if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");if(!n.version)throw new Error("Backup version must be defined");let c=0,l=0,u=0;const h=this.makeKeyBackupPath(t,i,n.version),f=await this.cryptoBackend.getBackupDecryptor(n,e),g=!f.sourceTrusted;try{if(!(e instanceof Uint8Array))throw new Error(`restoreKeyBackup expects Uint8Array, got ${e}`);this.cryptoBackend.storeSessionBackupPrivateKey(e,n.version).catch(v=>{this.logger.warn("Error caching session backup key:",v)}).then(o),a&&a({stage:"fetch"});const m=await this.http.authedRequest(D.Get,h.path,h.queryData,void 0,{prefix:Pe.V3});if(a&&a({stage:"load_keys"}),m.rooms)c=this.getTotalKeyCount(m),await this.handleDecryptionOfAFullBackup(m,f,200,async v=>{try{await this.cryptoBackend.importBackedUpRoomKeys(v,{untrusted:g}),u+=v.length}catch(S){l+=v.length,d.error("Error importing keys from backup",S)}a&&a({total:c,successes:u,stage:"load_keys",failures:l})});else if(m.sessions){const v=m.sessions;c=Object.keys(v).length;const S=await f.decryptSessions(v);for(const w of S)w.room_id=t;await this.cryptoBackend.importBackedUpRoomKeys(S,{progressCallback:a,untrusted:g}),u=S.length}else{c=1;try{const[v]=await f.decryptSessions({[i]:m});v.room_id=t,v.session_id=i,await this.cryptoBackend.importBackedUpRoomKeys([v],{progressCallback:a,untrusted:g}),u=1}catch(v){this.logger.debug("Failed to decrypt megolm session from backup",v)}}}finally{f.free()}return await this.cryptoBackend.checkKeyBackupAndEnable(),{total:c,imported:u}}getTotalKeyCount(e){const t=e.rooms;let i=0;for(const n of Object.values(t))n.sessions&&(i+=Object.keys(n.sessions).length);return i}async handleDecryptionOfAFullBackup(e,t,i,n){const s=e.rooms;let o=0,a=new Map;const c=async l=>{const u=[];for(const h of l.keys()){const f=await t.decryptSessions(l.get(h));for(const g in f){const m=f[g];m.room_id=h,u.push(m)}}await n(u)};for(const[l,u]of Object.entries(s))if(u.sessions){a.set(l,{});for(const[h,f]of Object.entries(u.sessions)){const g=a.get(l);g[h]=f,o+=1,o>=i&&(await c(a),a=new Map,a.set(l,{}),o=0)}}o>0&&await c(a)}async deleteKeysFromBackup(e,t,i){if(!this.crypto)throw new Error("End-to-end encryption disabled");const n=this.makeKeyBackupPath(e,t,i);await this.http.authedRequest(D.Delete,n.path,n.queryData,void 0,{prefix:Pe.V3})}async sendSharedHistoryKeys(e,t){var a;if(!this.crypto)throw new Error("End-to-end encryption disabled");const i=(a=this.crypto)==null?void 0:a.getRoomEncryption(e);if(!i){this.logger.error("Unknown room.  Not sharing decryption keys");return}const n=await this.crypto.downloadKeys(t),s=new Map;for(const[c,l]of n)s.set(c,Array.from(l.values()));const o=this.crypto.getRoomDecryptor(e,i.algorithm);o.sendSharedHistoryInboundSessions?await o.sendSharedHistoryInboundSessions(s):this.logger.warn("Algorithm does not support sharing previous keys",i.algorithm)}getMediaConfig(){return this.http.authedRequest(D.Get,"/config",void 0,void 0,{prefix:Cn.V3})}getRoom(e){return e?this.store.getRoom(e):null}getRooms(){return this.store.getRooms()}getVisibleRooms(e=!1){var n;const t=this.store.getRooms(),i=new Set;for(const s of t){const o=(n=s.findPredecessor(e))==null?void 0:n.roomId;o&&i.add(o)}return t.filter(s=>!(s.currentState.getStateEvents(R.RoomTombstone,"")&&i.has(s.roomId)))}getUser(e){return this.store.getUser(e)}getUsers(){return this.store.getUsers()}setAccountData(e,t){const i=W("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});return Sm(5,()=>this.http.authedRequest(D.Put,i,void 0,t))}getAccountData(e){return this.store.getAccountData(e)}async getAccountDataFromServer(e){var i;if(this.isInitialSyncComplete()){const n=this.store.getAccountData(e);return n?n.getContent():null}const t=W("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});try{return await this.http.authedRequest(D.Get,t)}catch(n){if(((i=n.data)==null?void 0:i.errcode)==="M_NOT_FOUND")return null;throw n}}async deleteAccountData(e){const t=this.canSupport.get(yt.AccountDataDeletion);if(t===He.Unsupported){await this.setAccountData(e,{});return}const i=W("/user/$userId/account_data/$type",{$userId:this.getSafeUserId(),$type:e}),n=t===He.Unstable?{prefix:"/_matrix/client/unstable/org.matrix.msc3391"}:void 0;return await this.http.authedRequest(D.Delete,i,void 0,void 0,n)}getIgnoredUsers(){const e=this.getAccountData("m.ignored_user_list");return!e||!e.getContent()||!e.getContent().ignored_users?[]:Object.keys(e.getContent().ignored_users)}setIgnoredUsers(e){const t={ignored_users:{}};return e.forEach(i=>{t.ignored_users[i]={}}),this.setAccountData("m.ignored_user_list",t)}isUserIgnored(e){return this.getIgnoredUsers().includes(e)}async joinRoom(e,t={}){t.syncRoom===void 0&&(t.syncRoom=!0);const i=this.getRoom(e);if(i!=null&&i.hasMembershipState(this.credentials.userId,ae.Join))return i;let n=Promise.resolve();if(t.inviteSignUrl){const m=new URL(t.inviteSignUrl);m.searchParams.set("mxid",this.credentials.userId),n=this.http.requestOtherUrl(D.Post,m)}const s={};t.viaServers&&(s.server_name=t.viaServers);const o={},a=await n;a&&(o.third_party_signed=a);const c=W("/join/$roomid",{$roomid:e}),u=(await this.http.authedRequest(D.Post,c,s,o)).room_id,h=this.getRoom(u);if(h!=null&&h.hasMembershipState(this.credentials.userId,ae.Join))return h;const g=new pr(this,this.clientOpts,this.buildSyncApiOptions()).createRoom(u);return t.syncRoom,g}knockRoom(e,t={}){const i=this.getRoom(e);if(i!=null&&i.hasMembershipState(this.credentials.userId,ae.Knock))return Promise.resolve({room_id:i.roomId});const n=W("/knock/$roomIdOrAlias",{$roomIdOrAlias:e}),s={};t.viaServers&&(s.server_name=t.viaServers);const o={};return t.reason&&(o.reason=t.reason),this.http.authedRequest(D.Post,n,s,o)}resendEvent(e,t){return this.toDeviceMessageQueue.sendQueue(),this.updatePendingEventStatus(t,e,se.SENDING),this.encryptAndSendEvent(t,e)}cancelPendingEvent(e){if(![se.QUEUED,se.NOT_SENT,se.ENCRYPTING].includes(e.status))throw new Error("cannot cancel an event with status "+e.status);e.status===se.ENCRYPTING?this.eventsBeingEncrypted.delete(e.getId()):this.scheduler&&e.status===se.QUEUED&&this.scheduler.removeEventFromQueue(e);const t=this.getRoom(e.getRoomId());this.updatePendingEventStatus(t,e,se.CANCELLED)}setRoomName(e,t){return this.sendStateEvent(e,R.RoomName,{name:t})}setRoomTopic(e,t,i){const n=Jp(t,i);return this.sendStateEvent(e,R.RoomTopic,n)}getRoomTags(e){const t=W("/user/$userId/rooms/$roomId/tags",{$userId:this.credentials.userId,$roomId:e});return this.http.authedRequest(D.Get,t)}setRoomTag(e,t,i={}){const n=W("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(D.Put,n,void 0,i)}deleteRoomTag(e,t){const i=W("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(D.Delete,i)}setRoomAccountData(e,t,i){const n=W("/user/$userId/rooms/$roomId/account_data/$type",{$userId:this.credentials.userId,$roomId:e,$type:t});return this.http.authedRequest(D.Put,n,void 0,i)}async setPowerLevel(e,t,i){var o,a,c;let n;if(this.clientRunning&&this.isInitialSyncComplete()&&(n=(c=(a=(o=this.getRoom(e))==null?void 0:o.currentState)==null?void 0:a.getStateEvents(R.RoomPowerLevels,""))==null?void 0:c.getContent()),!n)try{n=await this.getStateEvent(e,R.RoomPowerLevels,"")}catch(l){if(l instanceof Et&&l.errcode==="M_NOT_FOUND")n={};else throw l}n=wd(n),n!=null&&n.users||(n.users={});const s=Array.isArray(t)?t:[t];for(const l of s)i==null?delete n.users[l]:n.users[l]=i;return this.sendStateEvent(e,R.RoomPowerLevels,n,"")}async unstable_createLiveBeacon(e,t){return this.unstable_setLiveBeacon(e,t)}async unstable_setLiveBeacon(e,t){return this.sendStateEvent(e,Hu.name,t,this.getUserId())}sendEvent(e,t,i,n,s){var u,h,f,g;let o,a,c,l;if(!(t!=null&&t.startsWith($t))&&t!==null?(l=n,c=i,a=t,o=null):(l=s,c=n,a=i,o=t),o&&!((u=c["m.relates_to"])!=null&&u.rel_type)){const m=!!((h=c["m.relates_to"])!=null&&h["m.in_reply_to"]);c["m.relates_to"]={...c["m.relates_to"],rel_type:_e.name,event_id:o,is_falling_back:!m};const v=(f=this.getRoom(e))==null?void 0:f.getThread(o);v&&!m&&(c["m.relates_to"]["m.in_reply_to"]={event_id:((g=v.lastReply(S=>S.isRelation(_e.name)&&!S.status))==null?void 0:g.getId())??o})}return this.sendCompleteEvent(e,o,{type:a,content:c},l)}sendCompleteEvent(e,t,i,n){n||(n=this.makeTxnId());const s=new it(Object.assign(i,{event_id:"~"+e+":"+n,user_id:this.credentials.userId,sender:this.credentials.userId,room_id:e,origin_server_ts:new Date().getTime()})),o=this.getRoom(e),a=t?o==null?void 0:o.getThread(t):void 0;a&&s.setThread(a),this.reEmitter.reEmit(s,[be.Replaced,be.VisibilityChange]),o==null||o.reEmitter.reEmit(s,[be.BeforeRedaction]);const c=s.getAssociatedId();if(c!=null&&c.startsWith("~")){const u=o==null?void 0:o.getPendingEvents().find(h=>h.getId()===c);u==null||u.once(be.LocalEventIdReplaced,()=>{s.updateAssociatedId(u.getId())})}const l=s.getType();return this.logger.debug(`sendEvent of type ${l} in ${e} with txnId ${n}`),s.setTxnId(n),s.setStatus(se.SENDING),o==null||o.addPendingEvent(s,n),s.status===se.NOT_SENT?Promise.reject(new Error("Event blocked by other events not yet sent")):this.encryptAndSendEvent(o,s)}async encryptAndSendEvent(e,t){try{let i;this.eventsBeingEncrypted.add(t.getId());try{await this.encryptEventIfNeeded(t,e??void 0)}finally{i=!this.eventsBeingEncrypted.delete(t.getId())}if(i)return{};t.status===se.ENCRYPTING&&this.updatePendingEventStatus(e,t,se.SENDING);let n=null;return this.scheduler&&(n=this.scheduler.queueEvent(t),n&&this.scheduler.getQueueForEvent(t).length>1&&this.updatePendingEventStatus(e,t,se.QUEUED)),n||(n=this.sendEventHttpRequest(t),e&&(n=n.then(s=>(e.updatePendingEvent(t,se.SENT,s.event_id),s)))),await n}catch(i){this.logger.error("Error sending event",i);try{t.error=i,this.updatePendingEventStatus(e,t,se.NOT_SENT)}catch(n){this.logger.error("Exception in error handler!",n)}throw i instanceof Et&&(i.event=t),i}}async encryptEventIfNeeded(e,t){if(t&&await this.shouldEncryptEventForRoom(e,t)&&!(!this.cryptoBackend&&this.usingExternalCrypto)){if(!this.cryptoBackend)throw new Error("This room is configured to use encryption, but your client does not support encryption.");this.updatePendingEventStatus(t,e,se.ENCRYPTING),await this.cryptoBackend.encryptEvent(e,t)}}async shouldEncryptEventForRoom(e,t){var i;return e.isEncrypted()||e.getType()===R.Reaction||e.isRedaction()?!1:!!(t.hasEncryptionStateEvent()||await((i=this.cryptoBackend)==null?void 0:i.isEncryptionEnabledInRoom(t.roomId)))}getEncryptedIfNeededEventType(e,t){var i;return t===R.Reaction?t:(i=this.getRoom(e))!=null&&i.hasEncryptionStateEvent()?R.RoomMessageEncrypted:t}updatePendingEventStatus(e,t,i){e?e.updatePendingEvent(t,i):t.setStatus(i)}sendEventHttpRequest(e){let t=e.getTxnId();t||(t=this.makeTxnId(),e.setTxnId(t));const i={$roomId:e.getRoomId(),$eventType:e.getWireType(),$stateKey:e.getStateKey(),$txnId:t};let n;if(e.isState()){let s="/rooms/$roomId/state/$eventType";e.getStateKey()&&e.getStateKey().length>0&&(s="/rooms/$roomId/state/$eventType/$stateKey"),n=W(s,i)}else e.isRedaction()?n=W("/rooms/$roomId/redact/$redactsEventId/$txnId",{$redactsEventId:e.event.redacts,...i}):n=W("/rooms/$roomId/send/$eventType/$txnId",i);return this.http.authedRequest(D.Put,n,void 0,e.getWireContent()).then(s=>(this.logger.debug(`Event sent to ${e.getRoomId()} with event id ${s.event_id}`),s))}redactEvent(e,t,i,n,s){i!=null&&i.startsWith($t)||(s=n,n=i,i=t,t=null);const a={reason:s==null?void 0:s.reason};if((s==null?void 0:s.with_rel_types)!==void 0){if(this.canSupport.get(yt.RelationBasedRedactions)===He.Unsupported)throw new Error(`Server does not support relation based redactions roomId ${e} eventId ${i} txnId: ${n} threadId ${t}`);const c=this.canSupport.get(yt.RelationBasedRedactions)===He.Stable?mc.stable:mc.unstable;a[c]=s.with_rel_types}return this.sendCompleteEvent(e,t,{type:R.RoomRedaction,content:a,redacts:i},n)}sendMessage(e,t,i,n){typeof t!="string"&&t!==null&&(n=i,i=t,t=null);const s=R.RoomMessage,o=i;return this.sendEvent(e,t,s,o,n)}sendTextMessage(e,t,i,n){!(t!=null&&t.startsWith($t))&&t!==null&&(n=i,i=t,t=null);const s=Gp(i);return this.sendMessage(e,t,s,n)}sendNotice(e,t,i,n){!(t!=null&&t.startsWith($t))&&t!==null&&(n=i,i=t,t=null);const s=Wp(i);return this.sendMessage(e,t,s,n)}sendEmoteMessage(e,t,i,n){!(t!=null&&t.startsWith($t))&&t!==null&&(n=i,i=t,t=null);const s=Hp(i);return this.sendMessage(e,t,s,n)}sendImageMessage(e,t,i,n,s="Image"){!(t!=null&&t.startsWith($t))&&t!==null&&(s=n||"Image",n=i,i=t,t=null);const o={msgtype:Jt.Image,url:i,info:n,body:s};return this.sendMessage(e,t,o)}sendStickerMessage(e,t,i,n,s="Sticker"){!(t!=null&&t.startsWith($t))&&t!==null&&(s=n||"Sticker",n=i,i=t,t=null);const o={url:i,info:n,body:s};return this.sendEvent(e,t,R.Sticker,o)}sendHtmlMessage(e,t,i,n){!(t!=null&&t.startsWith($t))&&t!==null&&(n=i,i=t,t=null);const s=qp(i,n);return this.sendMessage(e,t,s)}sendHtmlNotice(e,t,i,n){!(t!=null&&t.startsWith($t))&&t!==null&&(n=i,i=t,t=null);const s=Vp(i,n);return this.sendMessage(e,t,s)}sendHtmlEmote(e,t,i,n){!(t!=null&&t.startsWith($t))&&t!==null&&(n=i,i=t,t=null);const s=jp(i,n);return this.sendMessage(e,t,s)}async sendReceipt(e,t,i,n=!1){if(this.isGuest())return Promise.resolve({});const s=W("/rooms/$roomId/receipt/$receiptType/$eventId",{$roomId:e.getRoomId(),$receiptType:t,$eventId:e.getId()}),a=!n&&this.supportsThreads()?{...i,thread_id:Dr(e)}:i,c=this.http.authedRequest(D.Post,s,void 0,a||{}),l=this.getRoom(e.getRoomId());return l&&this.credentials.userId&&l.addLocalEchoReceipt(this.credentials.userId,e,t,n),c}async sendReadReceipt(e,t=nt.Read,i=!1){if(!e)return;const n=e.getId(),s=this.getRoom(e.getRoomId());if(s!=null&&s.hasPendingEvent(n))throw new Error(`Cannot set read receipt to a pending event (${n})`);return this.sendReceipt(e,t,{},i)}async setRoomReadMarkers(e,t,i,n){const s=this.getRoom(e);if(s!=null&&s.hasPendingEvent(t))throw new Error(`Cannot set read marker to a pending event (${t})`);let o;if(i){if(o=i.getId(),s!=null&&s.hasPendingEvent(o))throw new Error(`Cannot set read receipt to a pending event (${o})`);s==null||s.addLocalEchoReceipt(this.credentials.userId,i,nt.Read)}let a;if(n){if(a=n.getId(),s!=null&&s.hasPendingEvent(a))throw new Error(`Cannot set read receipt to a pending event (${a})`);s==null||s.addLocalEchoReceipt(this.credentials.userId,n,nt.ReadPrivate)}return await this.setRoomReadMarkersHttpRequest(e,t,o,a)}getUrlPreview(e,t){t=Math.floor(t/6e4)*6e4;const i=new URL(e);i.hash="",e=i.toString();const n=t+"_"+e;if(n in this.urlPreviewCache)return this.urlPreviewCache[n];const s=this.http.authedRequest(D.Get,"/preview_url",{url:e,ts:t.toString()},void 0,{prefix:Cn.V3,priority:"low"});return this.urlPreviewCache[n]=s,s}sendTyping(e,t,i){if(this.isGuest())return Promise.resolve({});const n=W("/rooms/$roomId/typing/$userId",{$roomId:e,$userId:this.getUserId()}),s={typing:t};return t&&(s.timeout=i||2e4),this.http.authedRequest(D.Put,n,void 0,s)}getRoomUpgradeHistory(e,t=!1,i=!1){const n=this.getRoom(e);if(!n)return[];const s=this.findPredecessorRooms(n,t,i),o=this.findSuccessorRooms(n,t,i);return[...s,n,...o]}findPredecessorRooms(e,t,i){var o,a;const n=[];let s=(o=e.findPredecessor(i))==null?void 0:o.roomId;for(;s!==null;){const c=this.getRoom(s);if(c===null)break;if(t){const l=c.currentState.getStateEvents(R.RoomTombstone,"");if(!l||l.getContent().replacement_room!==e.roomId)break}n.splice(0,0,c),e=c,s=(a=e.findPredecessor(i))==null?void 0:a.roomId}return n}findSuccessorRooms(e,t,i){var o;const n=[];let s=e.currentState.getStateEvents(R.RoomTombstone,"");for(;s;){const a=this.getRoom(s.getContent().replacement_room);if(!a||a.roomId===e.roomId)break;if(t){const l=(o=a.findPredecessor(i))==null?void 0:o.roomId;if(!l||l!==e.roomId)break}if(n.push(a),new Set(n.map(l=>l.roomId)).size<n.length)return n.slice(0,n.length-1);e=a,s=e.currentState.getStateEvents(R.RoomTombstone,"")}return n}invite(e,t,i){return this.membershipChange(e,t,ae.Invite,i)}inviteByEmail(e,t){return this.inviteByThreePid(e,"email",t)}async inviteByThreePid(e,t,i){var a;const n=W("/rooms/$roomId/invite",{$roomId:e}),s=this.getIdentityServerUrl(!0);if(!s)return Promise.reject(new Et({error:"No supplied identity server URL",errcode:"ORG.MATRIX.JSSDK_MISSING_PARAM"}));const o={id_server:s,medium:t,address:i};if((a=this.identityServer)!=null&&a.getAccessToken){const c=await this.identityServer.getAccessToken();c&&(o.id_access_token=c)}return this.http.authedRequest(D.Post,n,void 0,o)}leave(e){return this.membershipChange(e,void 0,ae.Leave)}leaveRoomChain(e,t=!0){const i=this.getRoomUpgradeHistory(e);let n=i;if(!t){n=[];for(const c of i)if(n.push(c),c.roomId===e)break}const s={},o=[],a=c=>this.leave(c).then(()=>{delete s[c]}).catch(l=>{s[c]=l});for(const c of n)o.push(a(c.roomId));return Promise.all(o).then(()=>s)}ban(e,t,i){return this.membershipChange(e,t,ae.Ban,i)}forget(e,t=!0){const i=this.membershipChange(e,void 0,"forget");return t?i.then(n=>(this.store.removeRoom(e),this.emit("deleteRoom",e),n)):i}unban(e,t){const i=W("/rooms/$roomId/unban",{$roomId:e}),n={user_id:t};return this.http.authedRequest(D.Post,i,void 0,n)}kick(e,t,i){const n=W("/rooms/$roomId/kick",{$roomId:e}),s={user_id:t,reason:i};return this.http.authedRequest(D.Post,n,void 0,s)}membershipChange(e,t,i,n){const s=W("/rooms/$room_id/$membership",{$room_id:e,$membership:i});return this.http.authedRequest(D.Post,s,void 0,{user_id:t,reason:n})}getPushActionsForEvent(e,t=!1){if(!e.getPushActions()||t){const{actions:i,rule:n}=this.pushProcessor.actionsAndRuleForEvent(e);e.setPushDetails(i,n)}return e.getPushActions()}getPushDetailsForEvent(e,t=!1){if(!e.getPushDetails()||t){const{actions:i,rule:n}=this.pushProcessor.actionsAndRuleForEvent(e);e.setPushDetails(i,n)}return e.getPushDetails()}setProfileInfo(e,t){const i=W("/profile/$userId/$info",{$userId:this.credentials.userId,$info:e});return this.http.authedRequest(D.Put,i,void 0,t)}async setDisplayName(e){const t=await this.setProfileInfo("displayname",{displayname:e}),i=this.getUser(this.getUserId());return i&&(i.displayName=e,i.emit(da.DisplayName,i.events.presence,i)),t}async setAvatarUrl(e){const t=await this.setProfileInfo("avatar_url",{avatar_url:e}),i=this.getUser(this.getUserId());return i&&(i.avatarUrl=e,i.emit(da.AvatarUrl,i.events.presence,i)),t}mxcUrlToHttp(e,t,i,n,s,o){return qa(this.baseUrl,e,t,i,n,s,o)}async setSyncPresence(e){var t;(t=this.syncApi)==null||t.setPresence(e)}async setPresence(e){const t=W("/presence/$userId/status",{$userId:this.credentials.userId});if(["offline","online","unavailable"].indexOf(e.presence)===-1)throw new Error("Bad presence value: "+e.presence);await this.http.authedRequest(D.Put,t,void 0,e)}getPresence(e){const t=W("/presence/$userId/status",{$userId:e});return this.http.authedRequest(D.Get,t)}scrollback(e,t=30){let i=0,n=this.ongoingScrollbacks[e.roomId]||{};if(n.promise)return n.promise;if(n.errorTs){const a=Date.now()-n.errorTs;i=Math.max(wS-a,0)}if(e.oldState.paginationToken===null)return Promise.resolve(e);const s=this.store.scrollback(e,t).length;if(s===t)return Promise.resolve(e);t=t-s;const o=new Promise((a,c)=>{Ir(i).then(()=>this.createMessagesRequest(e.roomId,e.oldState.paginationToken,t,he.Backward)).then(l=>{const u=l.chunk.map(this.getEventMapper());if(l.state){const m=l.state.map(this.getEventMapper());e.currentState.setUnknownStateEvents(m)}const[h,f,g]=e.partitionThreadedEvents(u);this.processAggregatedTimelineEvents(e,h),e.addEventsToTimeline(h,!0,e.getLiveTimeline()),this.processThreadEvents(e,f,!0),g.forEach(m=>e.relations.aggregateChildEvent(m)),e.oldState.paginationToken=l.end??null,l.chunk.length===0&&(e.oldState.paginationToken=null),this.store.storeEvents(e,u,l.end??null,!0),delete this.ongoingScrollbacks[e.roomId],a(e)}).catch(l=>{this.ongoingScrollbacks[e.roomId]={errorTs:Date.now()},c(l)})});return n={promise:o},this.ongoingScrollbacks[e.roomId]=n,o}getEventMapper(e){return sS(this,e||{})}async getEventTimeline(e,t){var g,m;if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(!(e!=null&&e.room))throw new Error("getEventTimeline only supports room timelines");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);if(e.thread&&this.supportsThreads())return this.getThreadTimeline(e,t);const i=W("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t});let n;(g=this.clientOpts)!=null&&g.lazyLoadMembers&&(n={filter:JSON.stringify(It.LAZY_LOADING_MESSAGES_FILTER)});const s=await this.http.authedRequest(D.Get,i,n);if(!s.event)throw new Error("'event' not in '/context' result - homeserver too old?");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);const o=this.getEventMapper(),a=o(s.event);if(a.isRelation(_e.name)){this.logger.warn("Tried loading a regular timeline at the position of a thread event");return}const c=[...s.events_after.reverse().map(o),a,...s.events_before.map(o)];let l=e.getTimelineForEvent(c[0].getId());l?l.getState(ee.BACKWARDS).setUnknownStateEvents(s.state.map(o)):(l=e.addTimeline(),l.initialiseState(s.state.map(o)),l.getState(ee.FORWARDS).paginationToken=s.end);const[u,h,f]=e.room.partitionThreadedEvents(c);return e.addEventsToTimeline(u,!0,l,s.start),this.processThreadEvents(e.room,h,!0),this.processAggregatedTimelineEvents(e.room,u),f.forEach(v=>e.relations.aggregateChildEvent(v)),e.getTimelineForEvent(t)??((m=e.room.findThreadForEvent(a))==null?void 0:m.liveTimeline)??l}async getThreadTimeline(e,t){var l,u,h;if(!this.supportsThreads())throw new Error("could not get thread timeline: no client support");if(!e.room)throw new Error("could not get thread timeline: not a room timeline");if(!e.thread)throw new Error("could not get thread timeline: not a thread timeline");const i=W("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t}),n={limit:"0"};(l=this.clientOpts)!=null&&l.lazyLoadMembers&&(n.filter=JSON.stringify(It.LAZY_LOADING_MESSAGES_FILTER));const s=await this.http.authedRequest(D.Get,i,n),o=this.getEventMapper(),a=o(s.event);if(!e.canContain(a))return;const c=this.canSupport.get(yt.RelationsRecursion)!==He.Unsupported;if(et.hasServerSideSupport)if(et.hasServerSideFwdPaginationSupport){if(!e.thread)throw new Error("could not get thread timeline: not a thread timeline");const f=e.thread,g=await this.fetchRelations(e.room.roomId,f.id,null,null,{dir:he.Backward,from:s.start,recurse:c||void 0}),m=await this.fetchRelations(e.room.roomId,f.id,null,null,{dir:he.Forward,from:s.end,recurse:c||void 0}),v=[...m.chunk.reverse().filter(Lo(f.id)).map(o),a,...g.chunk.filter(Lo(f.id)).map(o)];for(const w of v)await((u=e.thread)==null?void 0:u.processEvent(w));let S=e.getTimelineForEvent(a.getId());if(S?S.getState(ee.BACKWARDS).setUnknownStateEvents(s.state.map(o)):(S=e.addTimeline(),S.initialiseState(s.state.map(o))),e.addEventsToTimeline(v,!0,S,m.next_batch),!g.next_batch){const w=await this.fetchRoomEvent(e.room.roomId,f.id);e.addEventsToTimeline([o(w)],!0,S,null)}return S.setPaginationToken(g.next_batch??null,he.Backward),S.setPaginationToken(m.next_batch??null,he.Forward),this.processAggregatedTimelineEvents(e.room,v),e.getTimelineForEvent(t)??S}else{const f=e.thread,g=await this.fetchRelations(e.room.roomId,f.id,_e.name,null,{dir:he.Backward,from:s.start,recurse:c||void 0}),m=[];let v=s.end;for(;v;){const M=await this.fetchRelations(e.room.roomId,f.id,_e.name,null,{dir:he.Forward,from:v,recurse:c||void 0});v=M.next_batch??null,m.push(...M.chunk)}const S=[...m.reverse().map(o),a,...g.chunk.map(o)];for(const M of S)await((h=e.thread)==null?void 0:h.processEvent(M));const w=e.getLiveTimeline();if(w.getState(ee.BACKWARDS).setUnknownStateEvents(s.state.map(o)),e.addEventsToTimeline(S,!0,w,null),!g.next_batch){const M=await this.fetchRoomEvent(e.room.roomId,f.id);e.addEventsToTimeline([o(M)],!0,w,null)}return w.setPaginationToken(g.next_batch??null,he.Backward),w.setPaginationToken(null,he.Forward),this.processAggregatedTimelineEvents(e.room,S),w}}async getLatestTimeline(e){var i,n,s,o;if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(!e.room)throw new Error("getLatestTimeline only supports room timelines");let t;if(e.threadListType!==null)t=(i=(await this.createThreadListMessagesRequest(e.room.roomId,null,1,he.Backward,e.threadListType,e.getFilter())).chunk)==null?void 0:i[0];else if(e.thread&&et.hasServerSideSupport){const a=this.canSupport.get(yt.RelationsRecursion)!==He.Unsupported;t=(n=(await this.fetchRelations(e.room.roomId,e.thread.id,_e.name,null,{dir:he.Backward,limit:1,recurse:a||void 0})).chunk)==null?void 0:n[0]}else{const a=W("/rooms/$roomId/messages",{$roomId:e.room.roomId}),c={dir:"b"};(s=this.clientOpts)!=null&&s.lazyLoadMembers&&(c.filter=JSON.stringify(It.LAZY_LOADING_MESSAGES_FILTER)),t=(o=(await this.http.authedRequest(D.Get,a,c)).chunk)==null?void 0:o[0]}if(!t)throw new Error("No message returned when trying to construct getLatestTimeline");return this.getEventTimeline(e,t.event_id)}createMessagesRequest(e,t,i=30,n,s){var l,u;const o=W("/rooms/$roomId/messages",{$roomId:e}),a={limit:i.toString(),dir:n};t&&(a.from=t);let c=null;return(l=this.clientOpts)!=null&&l.lazyLoadMembers&&(c=Object.assign({},It.LAZY_LOADING_MESSAGES_FILTER)),s&&(c=c||{},Object.assign(c,(u=s.getRoomTimelineFilterComponent())==null?void 0:u.toJSON())),c&&(a.filter=JSON.stringify(c)),this.http.authedRequest(D.Get,o,a)}createThreadListMessagesRequest(e,t,i=30,n=he.Backward,s=qt.All,o){var h,f;const a=W("/rooms/$roomId/threads",{$roomId:e}),c={limit:i.toString(),dir:n,include:MS(s)};t&&(c.from=t);let l={};(h=this.clientOpts)!=null&&h.lazyLoadMembers&&(l={...It.LAZY_LOADING_MESSAGES_FILTER}),o&&(l={...l,...(f=o.getRoomTimelineFilterComponent())==null?void 0:f.toJSON()}),Object.keys(l).length&&(c.filter=JSON.stringify(l));const u={prefix:et.hasServerSideListSupport===ti.Stable?Pe.V1:"/_matrix/client/unstable/org.matrix.msc3856"};return this.http.authedRequest(D.Get,a,c,void 0,u).then(g=>{var m;return{...g,chunk:(m=g.chunk)==null?void 0:m.reverse(),start:g.prev_batch,end:g.next_batch}})}paginateEventTimeline(e,t){const i=e.getTimelineSet()===this.notifTimelineSet,n=this.getRoom(e.getRoomId()),s=e.getTimelineSet().threadListType,o=e.getTimelineSet().thread;t=t||{};const a=t.backwards||!1;if(i&&!a)throw new Error("paginateNotifTimeline can only paginate backwards");const c=a?ee.BACKWARDS:ee.FORWARDS,l=e.getPaginationToken(c),u=e.paginationRequests[c];if(u)return u;let h,f,g;if(i)h="/notifications",f={limit:(t.limit??30).toString(),only:"highlight"},l&&l!=="end"&&(f.from=l),g=this.http.authedRequest(D.Get,h,f).then(async m=>{const v=m.next_token,S=[];m.notifications=m.notifications.filter(Dt);for(let M=0;M<m.notifications.length;M++){const _=m.notifications[M],C=this.getEventMapper()(_.event);this.getPushDetailsForEvent(C,!0),C.event.room_id=_.room_id,S[M]=C}const w=e.getTimelineSet();return w.addEventsToTimeline(S,a,e,v),this.processAggregatedTimelineEvents(w.room,S),a&&!m.next_token&&e.setPaginationToken(null,c),!!m.next_token}).finally(()=>{e.paginationRequests[c]=null}),e.paginationRequests[c]=g;else if(s!==null){if(!n)throw new Error("Unknown room "+e.getRoomId());if(!et.hasServerSideFwdPaginationSupport&&c===he.Forward)throw new Error("Cannot paginate threads forwards without server-side support for MSC 3715");g=this.createThreadListMessagesRequest(e.getRoomId(),l,t.limit,c,s,e.getFilter()).then(m=>{if(m.state){const M=e.getState(c),_=m.state.filter(Dt).map(this.getEventMapper());M.setUnknownStateEvents(_)}const v=m.end,S=m.chunk.filter(Dt).map(this.getEventMapper());return e.getTimelineSet().addEventsToTimeline(S,a,e,v),this.processAggregatedTimelineEvents(n,S),this.processThreadRoots(n,S,a),a&&m.end==m.start&&e.setPaginationToken(null,c),m.end!==m.start}).finally(()=>{e.paginationRequests[c]=null}),e.paginationRequests[c]=g}else if(o){const m=this.getRoom(e.getRoomId()??void 0);if(!m)throw new Error("Unknown room "+e.getRoomId());const v=this.canSupport.get(yt.RelationsRecursion)!==He.Unsupported;g=this.fetchRelations(e.getRoomId()??"",o.id,null,null,{dir:c,limit:t.limit,from:l??void 0,recurse:v||void 0}).then(async S=>{const w=this.getEventMapper(),M=S.chunk.filter(Dt).filter(Lo(o.id)).map(w);for(const A of M.slice().reverse()){await(o==null?void 0:o.processEvent(A));const y=A.getSender();(!a||(o==null?void 0:o.getEventReadUpTo(y))===null)&&m.addLocalEchoReceipt(y,A,nt.Read)}const _=S.next_batch,C=e.getTimelineSet();if(C.addEventsToTimeline(M,a,e,_??null),!_&&a){const A=o.rootEvent??w(await this.fetchRoomEvent(e.getRoomId()??"",o.id));C.addEventsToTimeline([A],!0,e,null)}return this.processAggregatedTimelineEvents(C.room,M),a&&!_&&e.setPaginationToken(null,c),!!_}).finally(()=>{e.paginationRequests[c]=null}),e.paginationRequests[c]=g}else{if(!n)throw new Error("Unknown room "+e.getRoomId());g=this.createMessagesRequest(e.getRoomId(),l,t.limit,c,e.getFilter()).then(m=>{if(m.state){const A=e.getState(c),y=m.state.filter(Dt).map(this.getEventMapper());A.setUnknownStateEvents(y)}const v=m.end,S=m.chunk.filter(Dt).map(this.getEventMapper()),w=e.getTimelineSet(),[M,,_]=n.partitionThreadedEvents(S);w.addEventsToTimeline(M,a,e,v),this.processAggregatedTimelineEvents(n,M),this.processThreadRoots(n,M.filter(A=>A.getServerAggregatedRelation(_e.name)),!1),_.forEach(A=>n.relations.aggregateChildEvent(A));const C=m.end===void 0||m.end===m.start;return a&&C&&e.setPaginationToken(null,c),!C}).finally(()=>{e.paginationRequests[c]=null}),e.paginationRequests[c]=g}return g}resetNotifTimelineSet(){this.notifTimelineSet&&this.notifTimelineSet.resetLiveTimeline("end")}peekInRoom(e){var t;return(t=this.peekSync)==null||t.stopPeeking(),this.peekSync=new pr(this,this.clientOpts,this.buildSyncApiOptions()),this.peekSync.peek(e)}stopPeeking(){this.peekSync&&(this.peekSync.stopPeeking(),this.peekSync=null)}setGuestAccess(e,t){const i=this.sendStateEvent(e,R.RoomGuestAccess,{guest_access:t.allowJoin?Bs.CanJoin:Bs.Forbidden},"");let n=Promise.resolve();return t.allowRead&&(n=this.sendStateEvent(e,R.RoomHistoryVisibility,{history_visibility:oc.WorldReadable},"")),Promise.all([n,i]).then()}requestRegisterEmailToken(e,t,i,n){return this.requestTokenFromEndpoint("/register/email/requestToken",{email:e,client_secret:t,send_attempt:i,next_link:n})}requestRegisterMsisdnToken(e,t,i,n,s){return this.requestTokenFromEndpoint("/register/msisdn/requestToken",{country:e,phone_number:t,client_secret:i,send_attempt:n,next_link:s})}requestAdd3pidEmailToken(e,t,i,n){return this.requestTokenFromEndpoint("/account/3pid/email/requestToken",{email:e,client_secret:t,send_attempt:i,next_link:n})}requestAdd3pidMsisdnToken(e,t,i,n,s){return this.requestTokenFromEndpoint("/account/3pid/msisdn/requestToken",{country:e,phone_number:t,client_secret:i,send_attempt:n,next_link:s})}requestPasswordEmailToken(e,t,i,n){return this.requestTokenFromEndpoint("/account/password/email/requestToken",{email:e,client_secret:t,send_attempt:i,next_link:n})}requestPasswordMsisdnToken(e,t,i,n,s){return this.requestTokenFromEndpoint("/account/password/msisdn/requestToken",{country:e,phone_number:t,client_secret:i,send_attempt:n,next_link:s})}async requestTokenFromEndpoint(e,t){const i=Object.assign({},t);return this.http.request(D.Post,e,void 0,i)}getRoomPushRule(e,t){var i,n;if(this.pushRules)return(n=(i=this.pushRules[e])==null?void 0:i.room)==null?void 0:n.find(s=>s.rule_id===t);throw new Error("SyncApi.sync() must be done before accessing to push rules.")}setRoomMutePushRule(e,t,i){let n,s=!1;const o=this.getRoomPushRule(e,t);if(o!=null&&o.actions.includes(Oi.DontNotify)&&(s=!0),!i)s&&(n=this.deletePushRule(e,je.RoomSpecific,o.rule_id));else if(!o)n=this.addPushRule(e,je.RoomSpecific,t,{actions:[Oi.DontNotify]});else if(!s){const a=Nn();this.deletePushRule(e,je.RoomSpecific,o.rule_id).then(()=>{this.addPushRule(e,je.RoomSpecific,t,{actions:[Oi.DontNotify]}).then(()=>{a.resolve()}).catch(c=>{a.reject(c)})}).catch(c=>{a.reject(c)}),n=a.promise}if(n)return new Promise((a,c)=>{n.then(()=>{this.getPushRules().then(l=>{this.pushRules=l,a()}).catch(l=>{c(l)})}).catch(l=>{this.getPushRules().then(u=>{this.pushRules=u,c(l)}).catch(u=>{c(l)})})})}searchMessageText(e){const t={search_term:e.query};return"keys"in e&&(t.keys=e.keys),this.search({body:{search_categories:{room_events:t}}})}searchRoomEvents(e){const t={search_categories:{room_events:{search_term:e.term,filter:e.filter,order_by:ju.Recent,event_context:{before_limit:1,after_limit:1,include_profile:!0}}}},i={_query:t,results:[],highlights:[]};return this.search({body:t}).then(n=>this.processRoomEventsSearch(i,n))}backPaginateRoomEventsSearch(e){if(!e.next_batch)return Promise.reject(new Error("Cannot backpaginate event search any further"));if(e.pendingRequest)return e.pendingRequest;const t={body:e._query,next_batch:e.next_batch},i=this.search(t,e.abortSignal).then(n=>this.processRoomEventsSearch(e,n)).finally(()=>{e.pendingRequest=void 0});return e.pendingRequest=i,i}processRoomEventsSearch(e,t){var a;const i=t.search_categories.room_events;e.count=i.count,e.next_batch=i.next_batch;const n=new Set(i.highlights);e.highlights.forEach(c=>{n.add(c)}),e.highlights=Array.from(n);const s=this.getEventMapper(),o=((a=i.results)==null?void 0:a.length)??0;for(let c=0;c<o;c++){const l=rc.fromJson(i.results[c],s),u=this.getRoom(l.context.getEvent().getRoomId());if(u)for(const h of l.context.getTimeline()){const f=u.getMember(h.getSender());!h.sender&&f&&(h.sender=f)}e.results.push(l)}return e}syncLeftRooms(){if(this.syncedLeftRooms)return Promise.resolve([]);if(this.syncLeftRoomsPromise)return this.syncLeftRoomsPromise;const e=new pr(this,this.clientOpts,this.buildSyncApiOptions());return this.syncLeftRoomsPromise=e.syncLeftRooms(),this.syncLeftRoomsPromise.then(()=>{this.logger.debug("Marking success of sync left room request"),this.syncedLeftRooms=!0}).finally(()=>{this.syncLeftRoomsPromise=void 0}),this.syncLeftRoomsPromise}createFilter(e){const t=W("/user/$userId/filter",{$userId:this.credentials.userId});return this.http.authedRequest(D.Post,t,void 0,e).then(i=>{const n=It.fromJson(this.credentials.userId,i.filter_id,e);return this.store.storeFilter(n),n})}getFilter(e,t,i){if(i){const s=this.store.getFilter(e,t);if(s)return Promise.resolve(s)}const n=W("/user/$userId/filter/$filterId",{$userId:e,$filterId:t});return this.http.authedRequest(D.Get,n).then(s=>{const o=It.fromJson(e,t,s);return this.store.storeFilter(o),o})}async getOrCreateFilter(e,t){const i=this.store.getFilterIdByName(e);let n;if(i){try{const o=await this.getFilter(this.credentials.userId,i,!0);if(o){const a=o.getDefinition(),c=t.getDefinition();Xi(a,c)&&(n=i)}}catch(o){if(o.errcode!=="M_UNKNOWN"&&o.errcode!=="M_NOT_FOUND")throw o}n||this.store.setFilterIdByName(e,void 0)}if(n)return n;const s=await this.createFilter(t.getDefinition());return this.store.setFilterIdByName(e,s.filterId),s.filterId}getOpenIdToken(){const e=W("/user/$userId/openid/request_token",{$userId:this.credentials.userId});return this.http.authedRequest(D.Post,e,void 0,{})}turnServer(){return this.http.authedRequest(D.Get,"/voip/turnServer")}getTurnServers(){return this.turnServers||[]}getTurnServersExpiry(){return this.turnServersExpiry}get pollingTurnServers(){return this.checkTurnServersIntervalID!==void 0}async checkTurnServers(){if(!this.canSupportVoip)return;let e=!1;const t=this.turnServersExpiry-Date.now();if(t>Ql)this.logger.debug("TURN creds are valid for another "+t+" ms: not fetching new ones."),e=!0;else{this.logger.debug("Fetching new TURN credentials");try{const i=await this.turnServer();if(i.uris){this.logger.debug("Got TURN URIs: "+i.uris+" refresh in "+i.ttl+" secs");const n={urls:i.uris,username:i.username,credential:i.password};this.turnServers=[n],this.turnServersExpiry=Date.now()+i.ttl*1e3,e=!0,this.emit("turnServers",this.turnServers)}}catch(i){this.logger.error("Failed to get TURN URIs",i),i.httpStatus===403?(this.logger.info("TURN access unavailable for this account: stopping credentials checks"),this.checkTurnServersIntervalID!==null&&pn.clearInterval(this.checkTurnServersIntervalID),this.checkTurnServersIntervalID=void 0,this.emit("turnServers.error",i,!0)):this.emit("turnServers.error",i,!1)}}return e}setFallbackICEServerAllowed(e){this.fallbackICEServerAllowed=e}isFallbackICEServerAllowed(){return this.fallbackICEServerAllowed}isSynapseAdministrator(){const e=W("/_synapse/admin/v1/users/$userId/admin",{$userId:this.getUserId()});return this.http.authedRequest(D.Get,e,void 0,void 0,{prefix:""}).then(t=>t.admin)}whoisSynapseUser(e){const t=W("/_synapse/admin/v1/whois/$userId",{$userId:e});return this.http.authedRequest(D.Get,t,void 0,void 0,{prefix:""})}deactivateSynapseUser(e){const t=W("/_synapse/admin/v1/deactivate/$userId",{$userId:e});return this.http.authedRequest(D.Post,t,void 0,void 0,{prefix:""})}async fetchClientWellKnown(){this.clientWellKnownPromise=Ra.getRawClientConfig(this.getDomain()??void 0),this.clientWellKnown=await this.clientWellKnownPromise,this.emit("WellKnown.client",this.clientWellKnown)}getClientWellKnown(){return this.clientWellKnown}waitForClientWellKnown(){if(!this.clientRunning)throw new Error("Client is not running");return this.clientWellKnownPromise}storeClientOptions(){const e=["boolean","string","number"],t=Object.entries(this.clientOpts).filter(([i,n])=>e.includes(typeof n)).reduce((i,[n,s])=>(i[n]=s,i),{});return this.store.storeClientOptions(t)}async _unstable_getSharedRooms(e){const t=await this.doesServerSupportUnstableFeature(IS),i=await this.doesServerSupportUnstableFeature(RS),n=await this.doesServerSupportUnstableFeature(TS);if(!t&&!i&&!n)throw Error("Server does not support the Mutual Rooms API");let s,o;n?(s="/uk.half-shot.msc2666/user/mutual_rooms",o={user_id:e}):(s=W(`/uk.half-shot.msc2666/user/${i?"mutual_rooms":"shared_rooms"}/$userId`,{$userId:e}),o={});const a=[];let c=null;do{const l={};c!=null&&n&&(l.batch_token=c);const u=await this.http.authedRequest(D.Get,s,{...o,...l},void 0,{prefix:Pe.Unstable});a.push(...u.joined),u.next_batch_token!==void 0?c=u.next_batch_token:c=null}while(c!=null);return a}async getVersions(){if(this.serverVersionsPromise)return this.serverVersionsPromise;this.serverVersionsPromise=this.http.authedRequest(D.Get,"/_matrix/client/versions",void 0,void 0,{prefix:""}).catch(t=>{throw this.serverVersionsPromise=void 0,t});const e=await this.serverVersionsPromise;return this.canSupport=await Mm(e),this.serverVersionsPromise}async isVersionSupported(e){const{versions:t}=await this.getVersions();return t&&t.includes(e)}async doesServerSupportUnstableFeature(e){const t=await this.getVersions();if(!t)return!1;const i=t.unstable_features;return i&&!!i[e]}async doesServerForceEncryptionForPreset(e){const t=await this.getVersions();if(!t)return!1;const i=t.unstable_features,n=e.includes("_chat")?e.substring(0,e.indexOf("_chat")):e;return i&&!!i[`io.element.e2ee_forced.${n}`]}async doesServerSupportThread(){if(await this.isVersionSupported("v1.4"))return{threads:ti.Stable,list:ti.Stable,fwdPagination:ti.Stable};try{const[e,t,i,n,s,o]=await Promise.all([this.doesServerSupportUnstableFeature("org.matrix.msc3440"),this.doesServerSupportUnstableFeature("org.matrix.msc3440.stable"),this.doesServerSupportUnstableFeature("org.matrix.msc3856"),this.doesServerSupportUnstableFeature("org.matrix.msc3856.stable"),this.doesServerSupportUnstableFeature("org.matrix.msc3715"),this.doesServerSupportUnstableFeature("org.matrix.msc3715.stable")]);return{threads:No(t,e),list:No(n,i),fwdPagination:No(o,s)}}catch{return{threads:ti.None,list:ti.None,fwdPagination:ti.None}}}hasLazyLoadMembersEnabled(){var e;return!!((e=this.clientOpts)!=null&&e.lazyLoadMembers)}setCanResetTimelineCallback(e){this.canResetTimelineCallback=e}getCanResetTimelineCallback(){return this.canResetTimelineCallback}async relations(e,t,i,n,s={dir:he.Backward}){const o=n?this.getEncryptedIfNeededEventType(e,n):null,[a,c]=await Promise.all([this.fetchRoomEvent(e,t),this.fetchRelations(e,t,i,o,s)]),l=this.getEventMapper(),u=a?l(a):void 0;let h=c.chunk.map(l);if(o===R.RoomMessageEncrypted){const f=u?h.concat(u):h;await Promise.all(f.map(g=>this.decryptEventIfNeeded(g))),n!==null&&(h=h.filter(g=>g.getType()===n))}return u&&i===Te.Replace&&(h=h.filter(f=>f.getSender()===u.getSender())),{originalEvent:u??null,events:h,nextBatch:c.next_batch??null,prevBatch:c.prev_batch??null}}getCrossSigningCacheCallbacks(){var e;return(e=this.crypto)==null?void 0:e.crossSigningInfo.getCacheCallbacks()}generateClientSecret(){return rn(32)}decryptEventIfNeeded(e,t){return e.shouldAttemptDecryption()&&this.isCryptoEnabled()&&e.attemptDecryption(this.cryptoBackend,t),e.isBeingDecrypted()?e.getDecryptionPromise():Promise.resolve()}termsUrlForService(e,t){switch(e){case Ta.IS:return this.http.getUrl("/terms",void 0,ei.V2,t);case Ta.IM:return this.http.getUrl("/terms",void 0,"/_matrix/integrations/v1",t);default:throw new Error("Unsupported service type")}}getHomeserverUrl(){return this.baseUrl}getIdentityServerUrl(e=!1){var t,i;return e&&((t=this.idBaseUrl)!=null&&t.startsWith("http://")||(i=this.idBaseUrl)!=null&&i.startsWith("https://"))?this.idBaseUrl.split("://")[1]:this.idBaseUrl}setIdentityServerUrl(e){this.idBaseUrl=fo(e),this.http.setIdBaseUrl(this.idBaseUrl)}getAccessToken(){return this.http.opts.accessToken||null}getRefreshToken(){return this.http.opts.refreshToken??null}setAccessToken(e){this.http.opts.accessToken=e,this.serverVersionsPromise=void 0}isLoggedIn(){return this.http.opts.accessToken!==void 0}makeTxnId(){return"m"+new Date().getTime()+"."+this.txnCtr++}isUsernameAvailable(e){return this.http.authedRequest(D.Get,"/register/available",{username:e}).then(t=>t.available).catch(t=>t.errcode==="M_USER_IN_USE"?!1:Promise.reject(t))}register(e,t,i,n,s,o,a){s===!0?s={email:!0}:(s==null||s===!1)&&(s={}),i&&(n.session=i);const c={auth:n,refresh_token:!0};return e!=null&&(c.username=e),t!=null&&(c.password=t),s.email&&(c.bind_email=!0),s.msisdn&&(c.bind_msisdn=!0),o!=null&&(c.guest_access_token=o),a!=null&&(c.inhibit_login=a),t!=null&&(c.x_show_msisdn=!0),this.registerRequest(c)}registerGuest({body:e}={}){return this.registerRequest(e||{},"guest")}registerRequest(e,t){const i={};return t&&(i.kind=t),this.http.request(D.Post,"/register",i,e)}refreshToken(e){const t=i=>this.http.authedRequest(D.Post,"/refresh",void 0,{refresh_token:e},{prefix:i,inhibitLogoutEmit:!0});return t(Pe.V3).catch(i=>{if(i.errcode==="M_UNRECOGNIZED")return t(Pe.V1);throw i})}loginFlows(){return this.http.request(D.Get,"/login")}login(e,t){return this.http.authedRequest(D.Post,"/login",void 0,{...t,type:e}).then(i=>(i.access_token&&i.user_id&&(this.http.opts.accessToken=i.access_token,this.credentials={userId:i.user_id}),i))}loginWithPassword(e,t){return this.login("m.login.password",{user:e,password:t})}getCasLoginUrl(e){return this.getSsoLoginUrl(e,"cas")}getSsoLoginUrl(e,t="sso",i,n){let s="/login/"+t+"/redirect";i&&(s+="/"+i);const o={redirectUrl:e,[CS.unstable]:n};return this.http.getUrl(s,o).href}loginWithToken(e){return this.login("m.login.token",{token:e})}async logout(e=!1){var t,i;if((i=(t=this.crypto)==null?void 0:t.backupManager)!=null&&i.getKeyBackupEnabled())try{for(;await this.crypto.backupManager.backupPendingKeys(200)>0;);}catch(n){this.logger.error("Key backup request failed when logging out. Some keys may be missing from backup",n)}return e&&(this.stopClient(),this.http.abort()),this.http.authedRequest(D.Post,"/logout")}deactivateAccount(e,t){const i={};return e&&(i.auth=e),t!==void 0&&(i.erase=t),this.http.authedRequest(D.Post,"/account/deactivate",void 0,i)}async requestLoginToken(e){const t={auth:e};return this.http.authedRequest(D.Post,"/login/get_token",void 0,t,{prefix:Pe.V1})}getFallbackAuthUrl(e,t){const i=W("/auth/$loginType/fallback/web",{$loginType:e});return this.http.getUrl(i,{session:t}).href}async createRoom(e){var i;const t=(e.invite_3pid||[]).filter(n=>!n.id_access_token);if(t.length>0&&((i=this.identityServer)!=null&&i.getAccessToken)){const n=await this.identityServer.getAccessToken();if(n)for(const s of t)s.id_access_token=n}return this.http.authedRequest(D.Post,"/createRoom",void 0,e)}fetchRelations(e,t,i,n,s={dir:he.Backward}){let o=s;et.hasServerSideFwdPaginationSupport===ti.Experimental&&(o=yc("dir","org.matrix.msc3715.dir",o)),this.canSupport.get(yt.RelationsRecursion)===He.Unstable&&(o=yc("recurse","org.matrix.msc3981.recurse",o));const a=Is(o);let c="/rooms/$roomId/relations/$eventId";i!==null?(c+="/$relationType",n!==null&&(c+="/$eventType")):n!==null&&(this.logger.warn(`eventType: ${n} ignored when fetching
            relations as relationType is null`),n=null);const l=W(c+"?"+a,{$roomId:e,$eventId:t,$relationType:i,$eventType:n});return this.http.authedRequest(D.Get,l,void 0,void 0,{prefix:Pe.V1})}roomState(e){const t=W("/rooms/$roomId/state",{$roomId:e});return this.http.authedRequest(D.Get,t)}fetchRoomEvent(e,t){const i=W("/rooms/$roomId/event/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(D.Get,i)}members(e,t,i,n){const s={};t&&(s.membership=t),i&&(s.not_membership=i),n&&(s.at=n);const o=Is(s),a=W("/rooms/$roomId/members?"+o,{$roomId:e});return this.http.authedRequest(D.Get,a)}upgradeRoom(e,t){const i=W("/rooms/$roomId/upgrade",{$roomId:e});return this.http.authedRequest(D.Post,i,void 0,{new_version:t})}getStateEvent(e,t,i){const n={$roomId:e,$eventType:t,$stateKey:i};let s=W("/rooms/$roomId/state/$eventType",n);return i!==void 0&&(s=W(s+"/$stateKey",n)),this.http.authedRequest(D.Get,s)}sendStateEvent(e,t,i,n="",s={}){const o={$roomId:e,$eventType:t,$stateKey:n};let a=W("/rooms/$roomId/state/$eventType",o);return n!==void 0&&(a=W(a+"/$stateKey",o)),this.http.authedRequest(D.Put,a,void 0,i,s)}roomInitialSync(e,t){const i=W("/rooms/$roomId/initialSync",{$roomId:e});return this.http.authedRequest(D.Get,i,{limit:(t==null?void 0:t.toString())??"30"})}async setRoomReadMarkersHttpRequest(e,t,i,n){const s=W("/rooms/$roomId/read_markers",{$roomId:e}),o={[nt.FullyRead]:t,[nt.Read]:i};return(await this.doesServerSupportUnstableFeature("org.matrix.msc2285.stable")||await this.isVersionSupported("v1.4"))&&(o[nt.ReadPrivate]=n),this.http.authedRequest(D.Post,s,void 0,o)}getJoinedRooms(){const e=W("/joined_rooms",{});return this.http.authedRequest(D.Get,e)}getJoinedRoomMembers(e){const t=W("/rooms/$roomId/joined_members",{$roomId:e});return this.http.authedRequest(D.Get,t)}publicRooms({server:e,limit:t,since:i,...n}={}){if(Object.keys(n).length===0){const s={server:e,limit:t,since:i};return this.http.authedRequest(D.Get,"/publicRooms",s)}else{const s={server:e},o={limit:t,since:i,...n};return this.http.authedRequest(D.Post,"/publicRooms",s,o)}}createAlias(e,t){const i=W("/directory/room/$alias",{$alias:e}),n={room_id:t};return this.http.authedRequest(D.Put,i,void 0,n)}deleteAlias(e){const t=W("/directory/room/$alias",{$alias:e});return this.http.authedRequest(D.Delete,t)}getLocalAliases(e){const t=W("/rooms/$roomId/aliases",{$roomId:e}),i=Pe.V3;return this.http.authedRequest(D.Get,t,void 0,void 0,{prefix:i})}getRoomIdForAlias(e){const t=W("/directory/room/$alias",{$alias:e});return this.http.authedRequest(D.Get,t)}getRoomDirectoryVisibility(e){const t=W("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(D.Get,t)}setRoomDirectoryVisibility(e,t){const i=W("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(D.Put,i,void 0,{visibility:t})}searchUserDirectory({term:e,limit:t}){const i={search_term:e};return t!==void 0&&(i.limit=t),this.http.authedRequest(D.Post,"/user_directory/search",void 0,i)}uploadContent(e,t){return this.http.uploadContent(e,t)}cancelUpload(e){return this.http.cancelUpload(e)}getCurrentUploads(){return this.http.getCurrentUploads()}getProfileInfo(e,t){const i=t?W("/profile/$userId/$info",{$userId:e,$info:t}):W("/profile/$userId",{$userId:e});return this.http.authedRequest(D.Get,i)}getThreePids(){return this.http.authedRequest(D.Get,"/account/3pid")}async addThreePidOnly(e){return this.http.authedRequest(D.Post,"/account/3pid/add",void 0,e)}async bindThreePid(e){return this.http.authedRequest(D.Post,"/account/3pid/bind",void 0,e)}async unbindThreePid(e,t){const i="/account/3pid/unbind",n={medium:e,address:t,id_server:this.getIdentityServerUrl(!0)};return this.http.authedRequest(D.Post,i,void 0,n)}deleteThreePid(e,t){return this.http.authedRequest(D.Post,"/account/3pid/delete",void 0,{medium:e,address:t})}setPassword(e,t,i){const n="/account/password",s={auth:e,new_password:t,logout_devices:i};return this.http.authedRequest(D.Post,n,void 0,s)}getDevices(){return this.http.authedRequest(D.Get,"/devices")}getDevice(e){const t=W("/devices/$device_id",{$device_id:e});return this.http.authedRequest(D.Get,t)}setDeviceDetails(e,t){const i=W("/devices/$device_id",{$device_id:e});return this.http.authedRequest(D.Put,i,void 0,t)}deleteDevice(e,t){const i=W("/devices/$device_id",{$device_id:e}),n={};return t&&(n.auth=t),this.http.authedRequest(D.Delete,i,void 0,n)}deleteMultipleDevices(e,t){const i={devices:e};return t&&(i.auth=t),this.http.authedRequest(D.Post,"/delete_devices",void 0,i)}async getPushers(){const e=await this.http.authedRequest(D.Get,"/pushers");return await this.doesServerSupportUnstableFeature("org.matrix.msc3881")||(e.pushers=e.pushers.map(t=>(t.hasOwnProperty(vc.name)||(t[vc.name]=!0),t))),e}setPusher(e){return this.http.authedRequest(D.Post,"/pushers/set",void 0,e)}removePusher(e,t){const i="/pushers/set",n={pushkey:e,app_id:t,kind:null};return this.http.authedRequest(D.Post,i,void 0,n)}setLocalNotificationSettings(e,t){const i=`${Ah.name}.${e}`;return this.setAccountData(i,t)}getPushRules(){return this.http.authedRequest(D.Get,"/pushrules/").then(e=>(this.setPushRules(e),this.pushRules))}setPushRules(e){this.pushRules=Us.rewriteDefaultRules(e,this.getUserId()),this.pushProcessor.updateCachedPushRuleKeys(this.pushRules)}addPushRule(e,t,i,n){const s=W("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:i});return this.http.authedRequest(D.Put,s,void 0,n)}deletePushRule(e,t,i){const n=W("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:i});return this.http.authedRequest(D.Delete,n)}setPushRuleEnabled(e,t,i,n){const s=W("/pushrules/"+e+"/$kind/$ruleId/enabled",{$kind:t,$ruleId:i});return this.http.authedRequest(D.Put,s,void 0,{enabled:n})}setPushRuleActions(e,t,i,n){const s=W("/pushrules/"+e+"/$kind/$ruleId/actions",{$kind:t,$ruleId:i});return this.http.authedRequest(D.Put,s,void 0,{actions:n})}search({body:e,next_batch:t},i){const n={};return t&&(n.next_batch=t),this.http.authedRequest(D.Post,"/search",n,e,{abortSignal:i})}uploadKeysRequest(e,t){return this.http.authedRequest(D.Post,"/keys/upload",void 0,e)}uploadKeySignatures(e){return this.http.authedRequest(D.Post,"/keys/signatures/upload",void 0,e)}downloadKeysForUsers(e,{token:t}={}){const i={device_keys:{}};return t!==void 0&&(i.token=t),e.forEach(n=>{i.device_keys[n]=[]}),this.http.authedRequest(D.Post,"/keys/query",void 0,i)}claimOneTimeKeys(e,t="signed_curve25519",i){const n={};t===void 0&&(t="signed_curve25519");for(const[a,c]of e){const l=n[a]||{};Gt(n,a,l),Gt(l,c,t)}const s={one_time_keys:n};return i&&(s.timeout=i),this.http.authedRequest(D.Post,"/keys/claim",void 0,s)}getKeyChanges(e,t){const i={from:e,to:t};return this.http.authedRequest(D.Get,"/keys/changes",i)}uploadDeviceSigningKeys(e,t){const i=Object.assign({},t);return e&&Object.assign(i,{auth:e}),this.http.authedRequest(D.Post,"/keys/device_signing/upload",void 0,i,{prefix:Pe.Unstable})}registerWithIdentityServer(e){if(!this.idBaseUrl)throw new Error("No identity server base URL set");const t=this.http.getUrl("/account/register",void 0,ei.V2,this.idBaseUrl);return this.http.requestOtherUrl(D.Post,t,e)}requestEmailToken(e,t,i,n,s){const o={client_secret:t,email:e,send_attempt:i==null?void 0:i.toString()};return n&&(o.next_link=n),this.http.idServerRequest(D.Post,"/validate/email/requestToken",o,ei.V2,s)}requestMsisdnToken(e,t,i,n,s,o){const a={client_secret:i,country:e,phone_number:t,send_attempt:n==null?void 0:n.toString()};return s&&(a.next_link=s),this.http.idServerRequest(D.Post,"/validate/msisdn/requestToken",a,ei.V2,o)}submitMsisdnToken(e,t,i,n){const s={sid:e,client_secret:t,token:i};return this.http.idServerRequest(D.Post,"/validate/msisdn/submitToken",s,ei.V2,n??void 0)}submitMsisdnTokenOtherUrl(e,t,i,n){const s={sid:t,client_secret:i,token:n};return this.http.requestOtherUrl(D.Post,e,s)}getIdentityHashDetails(e){return this.http.idServerRequest(D.Get,"/hash_details",void 0,ei.V2,e)}async identityHashedLookup(e,t){const i={},n=await this.getIdentityHashDetails(t);if(!n||!n.lookup_pepper||!n.algorithms)throw new Error("Unsupported identity server: bad response");i.pepper=n.lookup_pepper;const s={};if(n.algorithms.includes("sha256")){const c=new pn.Olm.Utility;i.addresses=e.map(l=>{const u=l[0].toLowerCase(),h=l[1].toLowerCase(),f=c.sha256(`${u} ${h} ${i.pepper}`).replace(/\+/g,"-").replace(/\//g,"_");return s[f]=l[0],f}),i.algorithm="sha256"}else if(n.algorithms.includes("none"))i.addresses=e.map(c=>{const l=c[0].toLowerCase(),u=c[1].toLowerCase(),h=`${l} ${u}`;return s[h]=c[0],h}),i.algorithm="none";else throw new Error("Unsupported identity server: unknown hash algorithm");const o=await this.http.idServerRequest(D.Post,"/lookup",i,ei.V2,t);if(!(o!=null&&o.mappings))return[];const a=[];for(const c of Object.keys(o.mappings)){const l=o.mappings[c],u=s[c];if(!u)throw new Error("Identity server returned more results than expected");a.push({address:u,mxid:l})}return a}async lookupThreePid(e,t,i){const s=(await this.identityHashedLookup([[t,e]],i)).find(a=>a.address===t);return s?{address:t,medium:e,mxid:s.mxid}:{}}async bulkLookupThreePids(e,t){const i=await this.identityHashedLookup(e.map(s=>[s[1],s[0]]),t),n=[];for(const s of i){const o=e.find(a=>a[1]===s.address);if(!o)throw new Error("Identity sever returned unexpected results");n.push([o[0],s.address,s.mxid])}return{threepids:n}}getIdentityAccount(e){return this.http.idServerRequest(D.Get,"/account",void 0,ei.V2,e)}sendToDevice(e,t,i){const n=W("/sendToDevice/$eventType/$txnId",{$eventType:e,$txnId:i||this.makeTxnId()}),s={messages:In(t)},o=new Map;for(const[a,c]of t)o.set(a,Array.from(c.keys()));return this.logger.debug(`PUT ${n}`,o),this.http.authedRequest(D.Put,n,void 0,s)}queueToDevice(e){return this.toDeviceMessageQueue.queueBatch(e)}getThirdpartyProtocols(){return this.http.authedRequest(D.Get,"/thirdparty/protocols").then(e=>{if(!e||typeof e!="object")throw new Error(`/thirdparty/protocols did not return an object: ${e}`);return e})}getThirdpartyLocation(e,t){const i=W("/thirdparty/location/$protocol",{$protocol:e});return this.http.authedRequest(D.Get,i,t)}getThirdpartyUser(e,t){const i=W("/thirdparty/user/$protocol",{$protocol:e});return this.http.authedRequest(D.Get,i,t)}getTerms(e,t){const i=this.termsUrlForService(e,t);return this.http.requestOtherUrl(D.Get,i)}agreeToTerms(e,t,i,n){const s=this.termsUrlForService(e,t),o={Authorization:"Bearer "+i};return this.http.requestOtherUrl(D.Post,s,{user_accepts:n},{headers:o})}reportEvent(e,t,i,n){const s=W("/rooms/$roomId/report/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(D.Post,s,void 0,{score:i,reason:n})}getRoomHierarchy(e,t,i,n=!1,s){const o=W("/rooms/$roomId/hierarchy",{$roomId:e}),a={suggested_only:String(n),max_depth:i==null?void 0:i.toString(),from:s,limit:t==null?void 0:t.toString()};return this.http.authedRequest(D.Get,o,a,void 0,{prefix:Pe.V1}).catch(c=>{if(c.errcode==="M_UNRECOGNIZED")return this.http.authedRequest(D.Get,o,a,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2946"});throw c})}async unstableCreateFileTree(e){const{room_id:t}=await this.createRoom({name:e,preset:sc.PrivateChat,power_level_content_override:{...oS,users:{[this.getUserId()]:100}},creation_content:{[Fo]:_n.Space},initial_state:[{type:fc.name,state_key:pc.name,content:{[gc.name]:!0}},{type:R.RoomEncryption,state_key:"",content:{algorithm:dt}}]});return new jl(this,t)}unstableGetFileTreeSpace(e){var s,o;const t=this.getRoom(e);if((t==null?void 0:t.getMyMembership())!==ae.Join)return null;const i=t.currentState.getStateEvents(R.RoomCreate,""),n=t.currentState.getStateEvents(fc.name,pc.name);if(!i)throw new Error("Expected single room create event");return!((s=n==null?void 0:n.getContent())!=null&&s[gc.name])||((o=i.getContent())==null?void 0:o[Fo])!==_n.Space?null:new jl(this,e)}slidingSync(e,t,i){const n={};e.pos&&(n.pos=e.pos,delete e.pos),e.timeout&&(n.timeout=e.timeout,delete e.timeout);const s=e.clientTimeout;return delete e.clientTimeout,this.http.authedRequest(D.Post,"/sync",n,e,{prefix:"/_matrix/client/unstable/org.matrix.msc3575",baseUrl:t,localTimeoutMs:s,abortSignal:i})}supportsThreads(){var e;return((e=this.clientOpts)==null?void 0:e.threadSupport)||!1}supportsIntentionalMentions(){return this.canSupport.get(yt.IntentionalMentions)!==He.Unsupported}async getRoomSummary(e,t){const i={prefix:"/_matrix/client/unstable/im.nheko.summary"};try{const n=W("/summary/$roomid",{$roomid:e});return await this.http.authedRequest(D.Get,n,{via:t},void 0,i)}catch(n){if(n instanceof Et&&n.errcode==="M_UNRECOGNIZED"){const s=W("/rooms/$roomid/summary",{$roomid:e});return await this.http.authedRequest(D.Get,s,{via:t},void 0,i)}else throw n}}processThreadEvents(e,t,i){e.processThreadedEvents(t,i)}processThreadRoots(e,t,i){this.supportsThreads()&&e.processThreadRoots(t,i)}processBeaconEvents(e,t){this.processAggregatedTimelineEvents(e,t)}processAggregatedTimelineEvents(e,t){t!=null&&t.length&&e&&(e.currentState.processBeaconEvents(t,this),e.processPollEvents(t))}async whoami(){return this.http.authedRequest(D.Get,"/account/whoami")}async timestampToEvent(e,t,i){const n=W("/rooms/$roomId/timestamp_to_event",{$roomId:e}),s={ts:t.toString(),dir:i};try{return await this.http.authedRequest(D.Get,n,s,void 0,{prefix:Pe.V1})}catch(o){if(o.errcode==="M_UNRECOGNIZED"&&(o.httpStatus===400||o.httpStatus===404||o.httpStatus===405))return await this.http.authedRequest(D.Get,n,s,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc3030"});throw o}}async getAuthIssuer(){return this.http.request(D.Get,"/auth_issuer",void 0,void 0,{prefix:Pe.Unstable+"/org.matrix.msc2965"})}};uc.RESTORE_BACKUP_ERROR_BAD_KEY="RESTORE_BACKUP_ERROR_BAD_KEY";let Pr=uc;function kS(r,e){var u;const t=r.getUserId(),i=e.getId(),n=r.getRoom(e.getRoomId());if(!n||!t||!i)return;if(!n.findEventById(i)){d.info(`Decrypted event ${e.getId()} is not in room ${n.roomId}: ignoring`);return}const s=!!e.threadRootId&&!e.isThreadRoot;let o;if(s){const h=n.getThread(e.threadRootId);o=h?h.hasUserReadEvent(t,i):!0}else o=n.hasUserReadEvent(t,i);if(o)return;const a=r.getPushActionsForEvent(e,!0);if(!!((u=a==null?void 0:a.tweaks)!=null&&u.highlight)){const h=n.getUnreadCountForEventContext(Be.Highlight,e)+1;s?n.setThreadUnreadNotificationCount(e.threadRootId,Be.Highlight,h):n.setUnreadNotificationCount(Be.Highlight,h)}if(!!(a!=null&&a.notify)){const h=n.getUnreadCountForEventContext(Be.Total,e)+1;s?n.setThreadUnreadNotificationCount(e.threadRootId,Be.Total,h):n.setUnreadNotificationCount(Be.Total,h)}}function Dr(r){return xs(r)?Ys:r.threadRootId}function xs(r){return!r.threadRootId||r.isThreadRoot?!0:r.isRelation()?r.isRelation(_e.name)?!1:r.relationEventId===r.threadRootId:(d.warn(`Event is not a relation or a thread root, but still has a threadRootId! id=${r.getId()}`),!0)}var jt=(r=>(r.New="Thread.new",r.Update="Thread.update",r.NewReply="Thread.newReply",r.ViewThread="Thread.viewThread",r.Delete="Thread.delete",r))(jt||{}),ti=(r=>(r[r.None=0]="None",r[r.Experimental=1]="Experimental",r[r.Stable=2]="Stable",r))(ti||{});function No(r,e){return r?2:e?1:0}const _t=class _t extends eu{constructor(e,t,i){if(super(),this.id=e,this.rootEvent=t,this._currentUserParticipated=!1,this.replyCount=0,this.pendingReplyCount=0,this.initialEventsFetched=!_t.hasServerSideSupport,this.replayEvents=[],this.onTimelineReset=async()=>{await this.processRootEventPromise,this.processRootEventPromise=void 0},this.onBeforeRedaction=(n,s)=>{n!=null&&n.isRelation(_e.name)&&this.room.eventShouldLiveIn(n).threadId===this.id&&n.getId()!==this.id&&!s.status&&(this.replyCount--,this.updatePendingReplyCount(),this.emit("Thread.update",this))},this.onRedaction=async(n,s,o)=>{var a;if(o===this.id)if(this.replyCount<=0){for(const c of this.timeline)this.clearEventMetadata(c);this.lastEvent=this.rootEvent,this._currentUserParticipated=!1,this.emit("Thread.delete",this)}else((a=this.lastEvent)==null?void 0:a.getId())===n.getAssociatedId()&&(await this.processRootEventPromise,this.processRootEventPromise=void 0),await this.updateThreadMetadata()},this.onTimelineEvent=(n,s,o)=>{if(!o){const a=n.getSender();a&&s&&this.shouldSendLocalEchoReceipt(a,n)&&s.addLocalEchoReceipt(a,n,nt.Read),n.getId()!==this.id&&n.isRelation(_e.name)&&this.replyCount++}this.onEcho(n,o??!1)},this.onLocalEcho=n=>{this.onEcho(n,!1)},this.onEcho=async(n,s)=>{n.threadRootId===this.id&&this.lastEvent!==n&&(await this.updateThreadMetadata(),n.isRelation(_e.name)&&(s||(this.lastEvent=void 0,this.emit("Thread.newReply",this,n))))},this.setMaxListeners(1e3),!(i!=null&&i.room))throw new Error("element-web#22141: A thread requires a room in order to function");this.room=i.room,this.client=i.client,this.pendingEventOrdering=i.pendingEventOrdering??Ln.Chronological,this.timelineSet=new gr(this.room,{timelineSupport:!0,pendingEvents:!0},this.client,this),this.reEmitter=new qn(this),this.reEmitter.reEmit(this.timelineSet,[de.Timeline,de.TimelineReset]),this.room.on(be.BeforeRedaction,this.onBeforeRedaction),this.room.on(de.Redaction,this.onRedaction),this.room.on(de.LocalEchoUpdated,this.onLocalEcho),this.room.on(de.TimelineReset,this.onTimelineReset),this.timelineSet.on(de.Timeline,this.onTimelineEvent),this.processReceipts(i.receipts),this.updateThreadMetadata(),this.setEventMetadata(this.rootEvent)}async fetchRootEvent(){try{const e=await this.client.fetchRoomEvent(this.roomId,this.id),t=this.client.getEventMapper();this.rootEvent=t(e)}catch(e){d.error("Failed to fetch thread root to construct thread with",e)}await this.processEvent(this.rootEvent)}static setServerSideSupport(e){_t.hasServerSideSupport=e,e!==2&&(br.setPreferUnstable(!0),wr.setPreferUnstable(!0),_e.setPreferUnstable(!0))}static setServerSideListSupport(e){_t.hasServerSideListSupport=e}static setServerSideFwdPaginationSupport(e){_t.hasServerSideFwdPaginationSupport=e}shouldSendLocalEchoReceipt(e,t){var n;if((this.client.canSupport.get(yt.RelationsRecursion)??He.Unsupported)===He.Unsupported){const s=(n=this.getReadReceiptForUserId(e))==null?void 0:n.eventId;if(s){const o=this.findEventById(s);if(o&&o.getTs()>t.getTs())return!1}}return!0}get roomState(){return this.room.getLiveTimeline().getState(ee.FORWARDS)}addEventToTimeline(e,t){this.findEventById(e.getId())||this.timelineSet.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:t,fromCache:!1,roomState:this.roomState})}insertEventIntoTimeline(e){const t=e.getId();t&&(this.findEventById(t)||this.timelineSet.insertEventIntoTimeline(e,this.liveTimeline,this.roomState))}addEvents(e,t){e.forEach(i=>this.addEvent(i,t,!1)),this.updateThreadMetadata()}addEvent(e,t,i=!0){this.setEventMetadata(e);const n=this.lastReply(),s=!n||e.localTimestamp>=n.localTimestamp;if(!_t.hasServerSideSupport)this.addEventToTimeline(e,t),this.client.decryptEventIfNeeded(e);else if(e.isRelation(Te.Annotation)||e.isRelation(Te.Replace)){this.addRelatedThreadEvent(e,t);return}else!t&&s?(this.addEventToTimeline(e,!1),this.fetchEditsWhereNeeded(e)):t?this.addEventToTimeline(e,t):this.insertEventIntoTimeline(e);e.getId()!==this.id&&e.isRelation(_e.name)&&!t&&s&&(this.lastEvent=void 0),i&&(this.emit("Thread.newReply",this,e),this.updateThreadMetadata())}addRelatedThreadEvent(e,t){var i,n,s;this.initialEventsFetched?(this.client.canSupport.get(yt.RelationsRecursion)??He.Unsupported)===He.Unsupported?this.insertEventIntoTimeline(e):this.addEventToTimeline(e,t):(i=this.replayEvents)==null||i.push(e),(n=this.timelineSet.relations)==null||n.aggregateParentEvent(e),(s=this.timelineSet.relations)==null||s.aggregateChildEvent(e,this.timelineSet)}async processEvent(e){e&&(this.setEventMetadata(e),await this.fetchEditsWhereNeeded(e))}processReceipts(e=[]){for(const{eventId:t,receiptType:i,userId:n,receipt:s,synthetic:o}of e)this.addReceiptToStructure(t,i,n,s,o)}getRootEventBundledRelationship(e=this.rootEvent){return e==null?void 0:e.getServerAggregatedRelation(_e.name)}async processRootEvent(){const e=this.getRootEventBundledRelationship();if(_t.hasServerSideSupport&&e){this.replyCount=e.count,this._currentUserParticipated=!!e.current_user_participated;const t=this.client.getEventMapper();this.lastEvent=t({...e.latest_event,room_id:this.roomId}),this.updatePendingReplyCount(),await this.processEvent(this.lastEvent)}}updatePendingReplyCount(){const t=(this.pendingEventOrdering===Ln.Detached?this.room.getPendingEvents():this.events).filter(i=>{var n;return i.threadRootId===this.id&&i.isRelation(_e.name)&&i.status!==null&&i.getId()!==((n=this.lastEvent)==null?void 0:n.getId())});this.lastPendingEvent=t.length?t[t.length-1]:void 0,this.pendingReplyCount=t.length}async resetLiveTimeline(e,t){const i=this.liveTimeline;this.timelineSet.resetLiveTimeline(e??void 0,t??void 0);const n=this.liveTimeline;let s,o;e&&(s=(await this.client.createMessagesRequest(this.roomId,e,1,he.Forward)).end),t&&(o=(await this.client.createMessagesRequest(this.roomId,t,1,he.Backward)).start),t&&i.getPaginationToken(he.Forward)===t&&i.setPaginationToken(o??null,he.Forward),e&&n.getPaginationToken(he.Backward)===e&&n.setPaginationToken(s??null,he.Backward)}async updateThreadFromRootEvent(){_t.hasServerSideSupport&&(!this.initialEventsFetched&&!this.lastEvent&&await this.processRootEvent(),await this.fetchRootEvent()),await this.processRootEvent()}async updateThreadMetadata(){if(this.updatePendingReplyCount(),this.processRootEventPromise||(this.processRootEventPromise=this.updateThreadFromRootEvent()),await this.processRootEventPromise,!this.initialEventsFetched)if(this.initalEventFetchProm)await this.initalEventFetchProm;else try{this.timelineSet.resetLiveTimeline(),this.replyCount===0&&this.rootEvent?(this.timelineSet.addEventsToTimeline([this.rootEvent],!0,this.liveTimeline,null),this.liveTimeline.setPaginationToken(null,he.Backward)):(this.initalEventFetchProm=this.client.paginateEventTimeline(this.liveTimeline,{backwards:!0}),await this.initalEventFetchProm),this.initialEventsFetched=!0;for(const e of this.replayEvents)this.addEvent(e,!1);this.replayEvents=null,this.emit(de.TimelineReset,this.room,this.timelineSet,!0)}catch(e){d.error("Failed to load start of newly created thread: ",e),this.initialEventsFetched=!1}this.emit("Thread.update",this)}async fetchEditsWhereNeeded(...e){if((this.client.canSupport.get(yt.RelationsRecursion)??He.Unsupported)===He.Unsupported)return Promise.all(e.filter(OS).map(async i=>{try{const n=await this.client.relations(this.roomId,i.getId(),Te.Replace,i.getType(),{limit:1});if(n.events.length){const s=n.events[0];i.makeReplaced(s),this.insertEventIntoTimeline(s)}}catch(n){d.error("Failed to load edits for encrypted thread event",n)}}))}setEventMetadata(e){e&&(ee.setEventMetadata(e,this.roomState,!1),e.setThread(this))}clearEventMetadata(e){var t,i,n;e&&(e.setThread(void 0),(n=(i=(t=e.event)==null?void 0:t.unsigned)==null?void 0:i["m.relations"])==null||delete n[_e.name])}findEventById(e){return this.timelineSet.findEventById(e)}lastReply(e=t=>t.isRelation(_e.name)){for(let t=this.timeline.length-1;t>=0;t--){const i=this.timeline[t];if(e(i))return i}return null}get roomId(){return this.room.roomId}get length(){return this.replyCount+this.pendingReplyCount}get replyToEvent(){return this.lastPendingEvent??this.lastEvent??this.lastReply()}get timeline(){return this.events}get events(){return this.liveTimeline.getEvents()}has(e){return this.timelineSet.findEventById(e)instanceof it}get hasCurrentUserParticipated(){return this._currentUserParticipated}get liveTimeline(){return this.timelineSet.getLiveTimeline()}getUnfilteredTimelineSet(){return this.timelineSet}addReceipt(e,t){throw new Error("Unsupported function on the thread model")}getEventReadUpTo(e,t){var o;const i=e===this.client.getUserId(),n=this.timeline[this.timeline.length-1];if(i&&n){const a=n.getTs()<this.room.getOldestThreadedReceiptTs(),c=n.getId();if(a&&c)return c}const s=super.getEventReadUpTo(e,t);if(n){const a=this.room.getLastUnthreadedReceiptFor(e);if(!a)return s;for(let c=((o=this.timeline)==null?void 0:o.length)-1;c>=0;--c){const l=this.timeline[c];if(l.getId()===s)return s;if(l.getTs()<a.ts)return l.getId()??s}}return s}hasUserReadEvent(e,t){var i,n,s;if(e===this.client.getUserId()){const o=(((i=this.lastReply())==null?void 0:i.getTs())??0)<this.room.getOldestThreadedReceiptTs(),a=((n=this.room.getLastUnthreadedReceiptFor(e))==null?void 0:n.ts)??0,c=(((s=this==null?void 0:this.lastReply())==null?void 0:s.getTs())??0)<a;if(o||c)return!0}return this.room.hasUserReadEvent(e,t)}setUnread(e,t){return this.room.setThreadUnreadNotificationCount(this.id,e,t)}getLastUnthreadedReceiptFor(e){return this.room.getLastUnthreadedReceiptFor(e)}};_t.hasServerSideSupport=0,_t.hasServerSideListSupport=0,_t.hasServerSideFwdPaginationSupport=0;let et=_t;function OS(r){return r.isEncrypted()&&(r.isRelation(_e.name)||r.isThreadRoot)}const br=new Js("related_by_senders","io.element.relation_senders"),wr=new Js("related_by_rel_types","io.element.relation_types"),_e=new Js("m.thread","io.element.thread");var qt=(r=>(r[r.My=0]="My",r[r.All=1]="All",r))(qt||{});function MS(r){switch(r){case 0:return"participated";default:return"all"}}const Xl=Object.freeze({visible:!0});var be=(r=>(r.Decrypted="Event.decrypted",r.BeforeRedaction="Event.beforeRedaction",r.VisibilityChange="Event.visibilityChange",r.LocalEventIdReplaced="Event.localEventIdReplaced",r.Status="Event.status",r.Replaced="Event.replaced",r.RelationsCreated="Event.relationsCreated",r))(be||{});class it extends ke{constructor(e={}){super(),this.event=e,this.pushDetails={},this._replacingEvent=null,this._localRedactionEvent=null,this._isCancelled=!1,this.visibility=Xl,this._hasCachedExtEv=!1,this._cachedExtEv=void 0,this._decryptionFailureReason=null,this.senderCurve25519Key=null,this.claimedEd25519Key=null,this.forwardingCurve25519KeyChain=[],this.untrusted=null,this.decryptionPromise=null,this.retryDecryption=!1,this.encryptedDisabledForUnverifiedDevices=!1,this.sender=null,this.target=null,this.status=null,this.error=null,this.forwardLooking=!0,["state_key","type","sender","room_id","membership"].forEach(i=>{typeof e[i]=="string"&&(e[i]=ho(e[i]))}),["membership","avatar_url","displayname"].forEach(i=>{var n;typeof((n=e.content)==null?void 0:n[i])=="string"&&(e.content[i]=ho(e.content[i]))}),["rel_type"].forEach(i=>{var n,s;typeof((s=(n=e.content)==null?void 0:n["m.relates_to"])==null?void 0:s[i])=="string"&&(e.content["m.relates_to"][i]=ho(e.content["m.relates_to"][i]))}),this.txnId=e.txn_id;const t=this.getAge();this.localTimestamp=t!==void 0?Date.now()-t:this.getTs()??Date.now(),this.reEmitter=new qn(this)}get unstableExtensibleEvent(){return this._hasCachedExtEv||(this._cachedExtEv=ot.ExtensibleEvents.parse(this.getEffectiveEvent())),this._cachedExtEv}invalidateExtensibleEvent(){this._hasCachedExtEv=!1}getEffectiveEvent(){const e=Object.assign({},this.getContent());if(this.getWireType()===R.RoomMessageEncrypted)for(const[t,i]of Object.entries(this.getWireContent()))["algorithm","ciphertext","device_id","sender_key","session_id"].includes(t)||e[t]===void 0&&(e[t]=i);return Object.assign({},this.event,this.clearEvent,{content:e})}getId(){return this.event.event_id}getSender(){return this.event.sender||this.event.user_id}getType(){return this.clearEvent?this.clearEvent.type:this.event.type}getWireType(){return this.event.type}getRoomId(){return this.event.room_id}getTs(){return this.event.origin_server_ts}getDate(){return this.event.origin_server_ts?new Date(this.event.origin_server_ts):null}getDetails(){var t;const e=this.getRoomId();return e?`id=${this.getId()} type=${this.getWireType()} sender=${this.getSender()} room=${e} ts=${(t=this.getDate())==null?void 0:t.toISOString()}`:`msgid=${this.getContent()[ut]} type=${this.getWireType()} sender=${this.getSender()}`}getOriginalContent(){return this._localRedactionEvent?{}:this.clearEvent?this.clearEvent.content||{}:this.event.content||{}}getContent(){return this._localRedactionEvent?{}:this._replacingEvent?this._replacingEvent.getContent()["m.new_content"]||{}:this.getOriginalContent()}getWireContent(){return this.event.content||{}}get threadRootId(){var i;if(this.isState())return;const e=(i=this.getWireContent())==null?void 0:i["m.relates_to"];if((e==null?void 0:e.rel_type)===_e.name)return e.event_id;if(this.thread)return this.thread.id;if(this.threadId!==void 0)return this.threadId;const t=this.getUnsigned();if(typeof t[$o.name]=="string")return t[$o.name]}get isThreadRoot(){return this.isState()?!1:!!this.getServerAggregatedRelation(_e.name)||this.threadRootId===this.getId()}get replyEventId(){var e,t;return(t=(e=this.getWireContent()["m.relates_to"])==null?void 0:e["m.in_reply_to"])==null?void 0:t.event_id}get relationEventId(){var e,t;return(t=(e=this.getWireContent())==null?void 0:e["m.relates_to"])==null?void 0:t.event_id}getPrevContent(){return this.getUnsigned().prev_content||this.event.prev_content||{}}getDirectionalContent(){return this.forwardLooking?this.getContent():this.getPrevContent()}getAge(){return this.getUnsigned().age||this.event.age}getLocalAge(){return Date.now()-this.localTimestamp}getStateKey(){return this.event.state_key}isState(){return this.event.state_key!==void 0}makeEncrypted(e,t,i,n){this.clearEvent={type:this.event.type,content:this.event.content},this.event.type=e,this.event.content=t,this.senderCurve25519Key=i,this.claimedEd25519Key=n}isBeingDecrypted(){return this.decryptionPromise!=null}getDecryptionPromise(){return this.decryptionPromise}isDecryptionFailure(){return this._decryptionFailureReason!==null}get decryptionFailureReason(){return this._decryptionFailureReason}get isEncryptedDisabledForUnverifiedDevices(){return this.isDecryptionFailure()&&this.encryptedDisabledForUnverifiedDevices}shouldAttemptDecryption(){return!(this.isRedacted()||this.isBeingDecrypted()||this.clearEvent||!this.isEncrypted())}async attemptDecryption(e,t={}){if(!this.isEncrypted())throw new Error("Attempt to decrypt event which isn't encrypted");const i=this.clearEvent&&!this.isDecryptionFailure(),n=t.forceRedecryptIfUntrusted&&this.isKeySourceUntrusted();if(i&&!n)throw new Error("Attempt to decrypt event which has already been decrypted");return this.decryptionPromise?(d.log(`Event ${this.getId()} already being decrypted; queueing a retry`),this.retryDecryption=!0,this.decryptionPromise):(this.decryptionPromise=this.decryptionLoop(e,t),this.decryptionPromise)}cancelAndResendKeyRequest(e,t){const i=this.getWireContent();return e.requestRoomKey({algorithm:i.algorithm,room_id:this.getRoomId(),session_id:i.session_id,sender_key:i.sender_key},this.getKeyRequestRecipients(t),!0)}getKeyRequestRecipients(e){return[{userId:e,deviceId:"*"}]}async decryptionLoop(e,t={}){for(await Promise.resolve();;){this.retryDecryption=!1;let i;try{const n=await e.decryptEvent(this);t.isRetry===!0&&d.info(`Decrypted event on retry (${this.getDetails()})`),this.setClearData(n),this._decryptionFailureReason=null}catch(n){const s=n instanceof Fe?n.detailedString:String(n);if(i=n,this.retryDecryption){d.log(`Error decrypting event (${this.getDetails()}), but retrying: ${s}`);continue}d.warn(`Error decrypting event (${this.getDetails()}): ${s}`),this.setClearDataForDecryptionFailure(String(n)),this._decryptionFailureReason=n instanceof Fe?n.code:Ne.UNKNOWN_ERROR}this.decryptionPromise=null,this.retryDecryption=!1,this.setPushDetails(),t.emit!==!1&&this.emit("Event.decrypted",this,i);return}}setClearData(e){this.clearEvent=e.clearEvent,this.senderCurve25519Key=e.senderCurve25519Key??null,this.claimedEd25519Key=e.claimedEd25519Key??null,this.forwardingCurve25519KeyChain=e.forwardingCurve25519KeyChain||[],this.untrusted=e.untrusted||!1,this.encryptedDisabledForUnverifiedDevices=!1,this.invalidateExtensibleEvent()}setClearDataForDecryptionFailure(e){this.clearEvent={type:R.RoomMessage,content:{msgtype:"m.bad.encrypted",body:`** Unable to decrypt: ${e} **`}},this.senderCurve25519Key=null,this.claimedEd25519Key=null,this.forwardingCurve25519KeyChain=[],this.untrusted=!1,this.encryptedDisabledForUnverifiedDevices=e===`DecryptionError: ${kr["m.unverified"]}`,this.invalidateExtensibleEvent()}getClearContent(){return this.clearEvent?this.clearEvent.content:null}isEncrypted(){return!this.isState()&&this.event.type===R.RoomMessageEncrypted}getSenderKey(){return this.senderCurve25519Key}getKeysClaimed(){return this.claimedEd25519Key?{ed25519:this.claimedEd25519Key}:{}}getClaimedEd25519Key(){return this.claimedEd25519Key}getForwardingCurve25519KeyChain(){return this.forwardingCurve25519KeyChain}isKeySourceUntrusted(){return!!this.untrusted}getUnsigned(){return this.event.unsigned||{}}setUnsigned(e){this.event.unsigned=e}unmarkLocallyRedacted(){const e=this._localRedactionEvent;return this._localRedactionEvent=null,this.event.unsigned&&(this.event.unsigned.redacted_because=void 0),!!e}markLocallyRedacted(e){this._localRedactionEvent||(this.emit("Event.beforeRedaction",this,e),this._localRedactionEvent=e,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event)}applyVisibilityEvent(e){const t=(e==null?void 0:e.visible)??!0,i=(e==null?void 0:e.reason)??null;let n=!1;(this.visibility.visible!==t||!this.visibility.visible&&this.visibility.reason!==i)&&(n=!0),n&&(t?this.visibility=Xl:this.visibility=Object.freeze({visible:!1,reason:i}),this.emit("Event.visibilityChange",this,t))}messageVisibility(){return this.visibility}makeRedacted(e,t){if(!e.event)throw new Error("invalid redactionEvent in makeRedacted");this._localRedactionEvent=null,this.emit("Event.beforeRedaction",this,e),this._replacingEvent=null,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event;for(const s in this.event)this.event.hasOwnProperty(s)&&!AS.has(s)&&delete this.event[s];this.isEncrypted()&&(this.clearEvent=void 0);const i=this.getType()in Zl?Zl[this.getType()]:{},n=this.getContent();for(const s in n)n.hasOwnProperty(s)&&!i[s]&&delete n[s];!this.isThreadRoot&&this.threadRootId&&this.threadRootId!==this.getId()&&(this.moveAllRelatedToMainTimeline(t),e.moveToMainTimeline(t)),this.invalidateExtensibleEvent()}moveAllRelatedToMainTimeline(e){var i;const t=this.thread;if(this.moveToMainTimeline(e),t)for(const n of t.events)((i=n.getRelation())==null?void 0:i.event_id)===this.getId()&&n.moveAllRelatedToMainTimeline(e)}moveToMainTimeline(e){var i;(i=this.thread)==null||i.timelineSet.removeEvent(this.getId()),this.setThread(void 0);const t=e.getLiveTimeline();t.getTimelineSet().insertEventIntoTimeline(this,t,t.getState(ee.FORWARDS))}isRedacted(){return!!this.getUnsigned().redacted_because}isRedaction(){return this.getType()===R.RoomRedaction}asVisibilityChange(){if(!En.matches(this.getType()))return null;const e=this.getRelation();if(!e||e.rel_type!="m.reference")return null;const t=e.event_id;if(!t)return null;const i=this.getWireContent(),n=!!i.visible,s=i.reason;return s&&typeof s!="string"?null:{visible:n,reason:s,eventId:t}}isVisibilityEvent(){return En.matches(this.getType())}getRedactionEvent(){var e,t,i;return this.isRedacted()?(e=this.clearEvent)!=null&&e.unsigned?((t=this.clearEvent)==null?void 0:t.unsigned.redacted_because)??null:(i=this.event.unsigned)!=null&&i.redacted_because?this.event.unsigned.redacted_because:{}:null}getPushActions(){return this.pushDetails.actions||null}getPushDetails(){return this.pushDetails}setPushDetails(e,t){this.pushDetails={actions:e,rule:t}}handleRemoteEcho(e){const t=this.getUnsigned(),i=this.getId();this.event=e,t.redacted_because&&(this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=t.redacted_because),this.setStatus(null),this.getId()!==i&&this.emit("Event.localEventIdReplaced",this),this.localTimestamp=Date.now()-this.getAge()}isSending(){return!!this.status}setStatus(e){this.status=e,this.emit("Event.status",this,e)}replaceLocalEventId(e){this.event.event_id=e,this.emit("Event.localEventIdReplaced",this)}isRelation(e){var i;const t=(i=this.getWireContent())==null?void 0:i["m.relates_to"];return this.isState()&&(t!=null&&t.rel_type)&&[Te.Replace,Te.Thread].includes(t.rel_type)?!1:!!(t!=null&&t.rel_type&&t.event_id&&(!e||t.rel_type===e))}getRelation(){return this.isRelation()?this.getWireContent()["m.relates_to"]??null:null}makeReplaced(e){this.isRedacted()&&e||this.isState()||this._replacingEvent!==e&&(this._replacingEvent=e??null,this.emit("Event.replaced",this),this.invalidateExtensibleEvent())}getAssociatedStatus(){return this._replacingEvent?this._replacingEvent.status:this._localRedactionEvent?this._localRedactionEvent.status:this.status}getServerAggregatedRelation(e){var t;return(t=this.getUnsigned()["m.relations"])==null?void 0:t[e]}replacingEventId(){const e=this.getServerAggregatedRelation(Te.Replace);if(e)return e.event_id;if(this._replacingEvent)return this._replacingEvent.getId()}replacingEvent(){return this._replacingEvent}replacingEventDate(){const e=this.getServerAggregatedRelation(Te.Replace);if(e){const t=e.origin_server_ts;if(Number.isFinite(t))return new Date(t)}else if(this._replacingEvent)return this._replacingEvent.getDate()??void 0}localRedactionEvent(){return this._localRedactionEvent}getAssociatedId(){const e=this.getRelation();if(this.replyEventId)return this.replyEventId;if(e)return e.event_id;if(this.isRedaction())return this.event.redacts}hasAssociation(){return!!this.getAssociatedId()}updateAssociatedId(e){const t=this.getRelation();t?t.event_id=e:this.isRedaction()&&(this.event.redacts=e)}flagCancelled(e=!0){this._isCancelled=e}isCancelled(){return this._isCancelled}toSnapshot(){const e=new it(JSON.parse(JSON.stringify(this.event)));for(const[t,i]of Object.entries(this))t!=="event"&&(e[t]=i);return e}isEquivalentTo(e){if(!e)return!1;if(e===this)return!0;const t=Bo(this.event),i=Bo(e.event);return JSON.stringify(t)===JSON.stringify(i)}toJSON(){const e=this.getEffectiveEvent();return this.isEncrypted()?{decrypted:e,encrypted:this.event}:e}setVerificationRequest(e){this.verificationRequest=e}setTxnId(e){this.txnId=e}getTxnId(){return this.txnId}setThread(e){this.isState()||(this.thread&&this.reEmitter.stopReEmitting(this.thread,[jt.Update]),this.thread=e,this.setThreadId(e==null?void 0:e.id),e&&this.reEmitter.reEmit(e,[jt.Update]))}getThread(){return this.thread}setThreadId(e){this.threadId=e}}const AS=new Set(["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"]),Zl={[R.RoomMember]:{membership:1},[R.RoomJoinRules]:{join_rule:1},[R.RoomPowerLevels]:{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1}};var fe=(r=>(r.Events="RoomState.events",r.Members="RoomState.members",r.NewMember="RoomState.newMember",r.Update="RoomState.update",r.BeaconLiveness="RoomState.BeaconLiveness",r.Marker="RoomState.Marker",r))(fe||{});class qs extends ke{constructor(e,t={status:0}){super(),this.roomId=e,this.oobMemberFlags=t,this.reEmitter=new qn(this),this.sentinels={},this.displayNameToUserIds=new Map,this.userIdsToDisplayNames={},this.tokenToInvite={},this.joinedMemberCount=null,this.summaryJoinedMemberCount=null,this.invitedMemberCount=null,this.summaryInvitedMemberCount=null,this.modified=-1,this.members={},this.events=new Map,this.paginationToken=null,this.beacons=new Map,this._liveBeaconIds=[],this.updateModifiedTime()}getJoinedMemberCount(){return this.summaryJoinedMemberCount!==null?this.summaryJoinedMemberCount:(this.joinedMemberCount===null&&(this.joinedMemberCount=this.getMembers().reduce((e,t)=>t.membership===ae.Join?e+1:e,0)),this.joinedMemberCount)}setJoinedMemberCount(e){this.summaryJoinedMemberCount=e}getInvitedMemberCount(){return this.summaryInvitedMemberCount!==null?this.summaryInvitedMemberCount:(this.invitedMemberCount===null&&(this.invitedMemberCount=this.getMembers().reduce((e,t)=>t.membership===ae.Invite?e+1:e,0)),this.invitedMemberCount)}setInvitedMemberCount(e){this.summaryInvitedMemberCount=e}getMembers(){return Object.values(this.members)}getMembersExcept(e){return this.getMembers().filter(t=>!e.includes(t.userId))}getMember(e){return this.members[e]||null}getSentinelMember(e){if(!e)return null;let t=this.sentinels[e];if(t===void 0){t=new Vo(this.roomId,e);const i=this.members[e];i!=null&&i.events.member&&t.setMembershipEvent(i.events.member,this),this.sentinels[e]=t}return t}getStateEvents(e,t){if(!this.events.has(e))return t===void 0?[]:null;if(t===void 0)return Array.from(this.events.get(e).values());const i=this.events.get(e).get(t);return i||null}get hasLiveBeacons(){var e;return!!((e=this.liveBeaconIds)!=null&&e.length)}get liveBeaconIds(){return this._liveBeaconIds}clone(){const e=new qs(this.roomId,this.oobMemberFlags),t=this.oobMemberFlags.status;return this.oobMemberFlags.status=0,Array.from(this.events.values()).forEach(i=>{e.setStateEvents(Array.from(i.values()))}),this.oobMemberFlags.status=t,this.summaryInvitedMemberCount!==null&&e.setInvitedMemberCount(this.getInvitedMemberCount()),this.summaryJoinedMemberCount!==null&&e.setJoinedMemberCount(this.getJoinedMemberCount()),this.oobMemberFlags.status==2&&this.getMembers().forEach(i=>{var n;i.isOutOfBand()&&((n=e.getMember(i.userId))==null||n.markOutOfBand())}),e}setUnknownStateEvents(e){const t=e.filter(i=>!this.events.has(i.getType())||!this.events.get(i.getType()).has(i.getStateKey()));this.setStateEvents(t)}setStateEvents(e,t){this.updateModifiedTime(),e.forEach(i=>{if(i.getRoomId()!==this.roomId||!i.isState())return;Hu.matches(i.getType())&&this.setBeacon(i);const n=this.getStateEventMatching(i);this.setStateEvent(i),i.getType()===R.RoomMember&&(this.updateDisplayNameCache(i.getStateKey(),i.getContent().displayname??""),this.updateThirdPartyTokenCache(i)),this.emit("RoomState.events",i,this,n)}),this.onBeaconLivenessChange(),e.forEach(i=>{if(!(i.getRoomId()!==this.roomId||!i.isState()))if(i.getType()===R.RoomMember){const n=i.getStateKey();(i.getContent().membership===ae.Leave||i.getContent().membership===ae.Ban)&&(i.getContent().avatar_url=i.getContent().avatar_url||i.getPrevContent().avatar_url,i.getContent().displayname=i.getContent().displayname||i.getPrevContent().displayname);const s=this.getOrCreateMember(n,i);s.setMembershipEvent(i,this),this.updateMember(s),this.emit("RoomState.members",i,this,s)}else if(i.getType()===R.RoomPowerLevels){if(i.getStateKey()!=="")return;Object.values(this.members).forEach(s=>{const o=s.getLastModifiedTime();s.setPowerLevelEvent(i),o!==s.getLastModifiedTime()&&this.emit("RoomState.members",i,this,s)}),this.sentinels={}}else Oh.matches(i.getType())&&this.emit("RoomState.Marker",i,t)}),this.emit("RoomState.update",this)}async processBeaconEvents(e,t){var s;if(!e.length||!this.beacons.size)return;const i=[...this.beacons.values()].reduce((o,a)=>(o[a.beaconInfoId]=a,o),{}),n=(o,a)=>{if(!Gl.matches(a.getType()))return;const c=i[o];c&&c.addLocations([a])};for(const o of e){const a=(s=o.getRelation())==null?void 0:s.event_id;if(!a||!i[a]||!Gl.matches(o.getType())&&!o.isEncrypted())return;try{await t.decryptEventIfNeeded(o),n(a,o)}catch{o.isDecryptionFailure()&&o.once(be.Decrypted,async()=>{n(a,o)})}}}getOrCreateMember(e,t){let i=this.members[e];return i||(i=new Vo(this.roomId,e),this.members[e]=i,this.emit("RoomState.newMember",t,this,i)),i}setStateEvent(e){this.events.has(e.getType())||this.events.set(e.getType(),new Map),this.events.get(e.getType()).set(e.getStateKey(),e)}setBeacon(e){var n;const t=ha(e);if(this.beacons.has(t)){const s=this.beacons.get(t);if(e.isRedacted()){s.beaconInfoId===((n=e.getRedactionEvent())==null?void 0:n.redacts)&&(s.destroy(),this.beacons.delete(t));return}return s.update(e)}if(e.isRedacted())return;const i=new Yp(e);this.reEmitter.reEmit(i,[Ke.New,Ke.Update,Ke.Destroy,Ke.LivenessChange]),this.emit(Ke.New,e,i),i.on(Ke.LivenessChange,this.onBeaconLivenessChange.bind(this)),i.on(Ke.Destroy,this.onBeaconLivenessChange.bind(this)),this.beacons.set(i.identifier,i)}onBeaconLivenessChange(){this._liveBeaconIds=Array.from(this.beacons.values()).filter(e=>e.isLive).map(e=>e.identifier),this.emit("RoomState.BeaconLiveness",this,this.hasLiveBeacons)}getStateEventMatching(e){var t;return((t=this.events.get(e.getType()))==null?void 0:t.get(e.getStateKey()))??null}updateMember(e){const t=this.getStateEvents(R.RoomPowerLevels,"");t&&e.setPowerLevelEvent(t),delete this.sentinels[e.userId],this.members[e.userId]=e,this.joinedMemberCount=null,this.invitedMemberCount=null}needsOutOfBandMembers(){return this.oobMemberFlags.status===0}outOfBandMembersReady(){return this.oobMemberFlags.status===2}markOutOfBandMembersStarted(){this.oobMemberFlags.status===0&&(this.oobMemberFlags.status=1)}markOutOfBandMembersFailed(){this.oobMemberFlags.status===1&&(this.oobMemberFlags.status=0)}clearOutOfBandMembers(){let e=0;Object.keys(this.members).forEach(t=>{this.members[t].isOutOfBand()&&(++e,delete this.members[t])}),d.log(`LL: RoomState removed ${e} members...`),this.oobMemberFlags.status=0}setOutOfBandMembers(e){d.log(`LL: RoomState about to set ${e.length} OOB members ...`),this.oobMemberFlags.status===1&&(d.log("LL: RoomState put in finished state ..."),this.oobMemberFlags.status=2,e.forEach(t=>this.setOutOfBandMember(t)),this.emit("RoomState.update",this))}setOutOfBandMember(e){if(e.getType()!==R.RoomMember)return;const t=e.getStateKey(),i=this.getMember(t);if(i&&!i.isOutOfBand())return;const n=this.getOrCreateMember(t,e);n.setMembershipEvent(e,this),n.markOutOfBand(),this.updateDisplayNameCache(n.userId,n.name),this.setStateEvent(e),this.updateMember(n),this.emit("RoomState.members",e,this,n)}setTypingEvent(e){Object.values(this.members).forEach(function(t){t.setTypingEvent(e)})}getInviteForThreePidToken(e){return this.tokenToInvite[e]||null}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getUserIdsWithDisplayName(e){return this.displayNameToUserIds.get(zi(e))??[]}maySendRedactionForEvent(e,t){const i=this.getMember(t);return!i||i.membership===ae.Leave||e.status||e.isRedacted()||!this.maySendEvent(R.RoomRedaction,t)?!1:e.getSender()===t?!0:this.hasSufficientPowerLevelFor("redact",i.powerLevel)}hasSufficientPowerLevelFor(e,t){const i=this.getStateEvents(R.RoomPowerLevels,"");let n={};i&&(n=i.getContent());let s=50;return Sc(n[e])&&(s=n[e]),t>=s}maySendMessage(e){return this.maySendEventOfType(R.RoomMessage,e,!1)}maySendEvent(e,t){return this.maySendEventOfType(e,t,!1)}mayClientSendStateEvent(e,t){return t.isGuest()||!t.credentials.userId?!1:this.maySendStateEvent(e,t.credentials.userId)}maySendStateEvent(e,t){return this.maySendEventOfType(e,t,!0)}maySendEventOfType(e,t,i){const n=this.getStateEvents(R.RoomPowerLevels,"");let s,o={},a=0,c=0,l=0;if(n){s=n.getContent(),o=s.events||{},Number.isSafeInteger(s.state_default)?a=s.state_default:a=50;const h=s.users&&s.users[t];Number.isSafeInteger(h)?l=h:Number.isSafeInteger(s.users_default)&&(l=s.users_default),Number.isSafeInteger(s.events_default)&&(c=s.events_default)}let u=i?a:c;return Number.isSafeInteger(o[e])&&(u=o[e]),l>=u}mayTriggerNotifOfType(e,t){const i=this.getMember(t);if(!i)return!1;const n=this.getStateEvents(R.RoomPowerLevels,"");let s=50;return n&&n.getContent()&&n.getContent().notifications&&Sc(n.getContent().notifications[e])&&(s=n.getContent().notifications[e]),i.powerLevel>=s}getJoinRule(){const e=this.getStateEvents(R.RoomJoinRules,"");return((e==null?void 0:e.getContent())??{}).join_rule||Vu.Invite}getHistoryVisibility(){const e=this.getStateEvents(R.RoomHistoryVisibility,"");return((e==null?void 0:e.getContent())??{}).history_visibility||oc.Shared}getGuestAccess(){const e=this.getStateEvents(R.RoomGuestAccess,"");return((e==null?void 0:e.getContent())??{}).guest_access||Bs.Forbidden}findPredecessor(e=!1){if(e){const i=this.getStateEvents(R.RoomPredecessor,"");if(i){const n=i.getContent(),s=n.predecessor_room_id;let o=n.last_known_event_id;typeof o!="string"&&(o=void 0);let a=n.via_servers;if(Array.isArray(a)||(a=void 0),typeof s=="string")return{roomId:s,eventId:o,viaServers:a}}}const t=this.getStateEvents(R.RoomCreate,"");if(t){const i=t.getContent().predecessor;if(i){const n=i.room_id;if(typeof n=="string"){let s=i.event_id;return(typeof s!="string"||s==="")&&(s=void 0),{roomId:n,eventId:s}}}}return null}updateThirdPartyTokenCache(e){if(!e.getContent().third_party_invite)return;const t=(e.getContent().third_party_invite.signed||{}).token;!t||!this.getStateEvents(R.RoomThirdPartyInvite,t)||(this.tokenToInvite[t]=e)}updateDisplayNameCache(e,t){const i=this.userIdsToDisplayNames[e];if(delete this.userIdsToDisplayNames[e],i){const s=zi(i),o=this.displayNameToUserIds.get(s);if(o){const a=o.filter(c=>c!==e);this.displayNameToUserIds.set(s,a)}}this.userIdsToDisplayNames[e]=t;const n=t&&zi(t);if(n){const s=this.displayNameToUserIds.get(n)??[];s.push(e),this.displayNameToUserIds.set(n,s)}}}function ed(r){return typeof r=="string"&&!!r&&r!=="undefined"&&r!=="null"||typeof r=="number"}class PS{constructor(e={}){this.rooms={},this.users={},this.syncToken=null,this.filters=new $e(()=>new Map),this.accountData=new Map,this.oobMembers=new Map,this.pendingEvents={},this.pendingToDeviceBatches=[],this.nextToDeviceBatchId=0,this.onRoomMember=(t,i,n)=>{var o;if(n.membership===ae.Invite)return;const s=this.users[n.userId]||((o=this.createUser)==null?void 0:o.call(this,n.userId));n.name&&(s.setDisplayName(n.name),n.events.member&&s.setRawDisplayName(n.events.member.getDirectionalContent().displayname)),n.events.member&&n.events.member.getContent().avatar_url&&s.setAvatarUrl(n.events.member.getContent().avatar_url),this.users[s.userId]=s},this.localStorage=e.localStorage}getSyncToken(){return this.syncToken}isNewlyCreated(){return Promise.resolve(!0)}setSyncToken(e){this.syncToken=e}storeRoom(e){this.rooms[e.roomId]=e,e.currentState.on(fe.Members,this.onRoomMember),e.currentState.getMembers().forEach(t=>{this.onRoomMember(null,e.currentState,t)})}setUserCreator(e){this.createUser=e}getRoom(e){return this.rooms[e]||null}getRooms(){return Object.values(this.rooms)}removeRoom(e){this.rooms[e]&&this.rooms[e].currentState.removeListener(fe.Members,this.onRoomMember),delete this.rooms[e]}getRoomSummaries(){return Object.values(this.rooms).map(function(e){return e.summary})}storeUser(e){this.users[e.userId]=e}getUser(e){return this.users[e]||null}getUsers(){return Object.values(this.users)}scrollback(e,t){return[]}storeEvents(e,t,i,n){}storeFilter(e){!(e!=null&&e.userId)||!(e!=null&&e.filterId)||this.filters.getOrCreate(e.userId).set(e.filterId,e)}getFilter(e,t){var i;return((i=this.filters.get(e))==null?void 0:i.get(t))||null}getFilterIdByName(e){if(!this.localStorage)return null;const t="mxjssdk_memory_filter_"+e;try{const i=this.localStorage.getItem(t);if(ed(i))return i}catch{}return null}setFilterIdByName(e,t){if(!this.localStorage)return;const i="mxjssdk_memory_filter_"+e;try{ed(t)?this.localStorage.setItem(i,t):this.localStorage.removeItem(i)}catch{}}storeAccountDataEvents(e){e.forEach(t=>{!Object.keys(t.getContent()).length?this.accountData.delete(t.getType()):this.accountData.set(t.getType(),t)})}getAccountData(e){return this.accountData.get(e)}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(e){return Promise.resolve()}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return this.rooms={},this.users={},this.syncToken=null,this.filters=new $e(()=>new Map),this.accountData=new Map,Promise.resolve()}getOutOfBandMembers(e){return Promise.resolve(this.oobMembers.get(e)||null)}setOutOfBandMembers(e,t){return this.oobMembers.set(e,t),Promise.resolve()}clearOutOfBandMembers(e){return this.oobMembers.delete(e),Promise.resolve()}getClientOptions(){return Promise.resolve(this.clientOptions)}storeClientOptions(e){return this.clientOptions=Object.assign({},e),Promise.resolve()}async getPendingEvents(e){return this.pendingEvents[e]??[]}async setPendingEvents(e,t){this.pendingEvents[e]=t}saveToDeviceBatches(e){for(const t of e)this.pendingToDeviceBatches.push({id:this.nextToDeviceBatchId++,eventType:t.eventType,txnId:t.txnId,batch:t.batch});return Promise.resolve()}async getOldestToDeviceBatch(){return this.pendingToDeviceBatches.length===0?null:this.pendingToDeviceBatches[0]}removeToDeviceBatch(e){return this.pendingToDeviceBatches=this.pendingToDeviceBatches.filter(t=>t.id!==e),Promise.resolve()}async destroy(){}}var Ko={},ar={},an={};Object.defineProperty(an,"__esModule",{value:!0});an.WidgetApiDirection=void 0;an.invertedDirection=DS;var mr=function(r){return r.ToWidget="toWidget",r.FromWidget="fromWidget",r}({});an.WidgetApiDirection=mr;function DS(r){if(r===mr.ToWidget)return mr.FromWidget;if(r===mr.FromWidget)return mr.ToWidget;throw new Error("Invalid direction")}var Wt={};Object.defineProperty(Wt,"__esModule",{value:!0});Wt.UnstableApiVersion=Wt.MatrixApiVersion=Wt.CurrentApiVersions=void 0;var Fa=function(r){return r.Prerelease1="0.0.1",r.Prerelease2="0.0.2",r}({});Wt.MatrixApiVersion=Fa;var At=function(r){return r.MSC2762="org.matrix.msc2762",r.MSC2871="org.matrix.msc2871",r.MSC2931="org.matrix.msc2931",r.MSC2974="org.matrix.msc2974",r.MSC2876="org.matrix.msc2876",r.MSC3819="org.matrix.msc3819",r.MSC3846="town.robin.msc3846",r.MSC3869="org.matrix.msc3869",r.MSC3973="org.matrix.msc3973",r.MSC4039="org.matrix.msc4039",r}({});Wt.UnstableApiVersion=At;var US=[Fa.Prerelease1,Fa.Prerelease2,At.MSC2762,At.MSC2871,At.MSC2931,At.MSC2974,At.MSC2876,At.MSC3819,At.MSC3846,At.MSC3869,At.MSC3973,At.MSC4039];Wt.CurrentApiVersions=US;var cr={},td;function ac(){if(td)return cr;td=1,Object.defineProperty(cr,"__esModule",{value:!0}),cr.PostmessageTransport=void 0;var r=Kr,e=lo();function t(_){"@babel/helpers - typeof";return t=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(C){return typeof C}:function(C){return C&&typeof Symbol=="function"&&C.constructor===Symbol&&C!==Symbol.prototype?"symbol":typeof C},t(_)}function i(_,C){var A=Object.keys(_);if(Object.getOwnPropertySymbols){var y=Object.getOwnPropertySymbols(_);C&&(y=y.filter(function($){return Object.getOwnPropertyDescriptor(_,$).enumerable})),A.push.apply(A,y)}return A}function n(_){for(var C=1;C<arguments.length;C++){var A=arguments[C]!=null?arguments[C]:{};C%2?i(Object(A),!0).forEach(function(y){v(_,y,A[y])}):Object.getOwnPropertyDescriptors?Object.defineProperties(_,Object.getOwnPropertyDescriptors(A)):i(Object(A)).forEach(function(y){Object.defineProperty(_,y,Object.getOwnPropertyDescriptor(A,y))})}return _}function s(_,C){if(!(_ instanceof C))throw new TypeError("Cannot call a class as a function")}function o(_,C){for(var A=0;A<C.length;A++){var y=C[A];y.enumerable=y.enumerable||!1,y.configurable=!0,"value"in y&&(y.writable=!0),Object.defineProperty(_,S(y.key),y)}}function a(_,C,A){return C&&o(_.prototype,C),A&&o(_,A),Object.defineProperty(_,"prototype",{writable:!1}),_}function c(_,C){if(typeof C!="function"&&C!==null)throw new TypeError("Super expression must either be null or a function");_.prototype=Object.create(C&&C.prototype,{constructor:{value:_,writable:!0,configurable:!0}}),Object.defineProperty(_,"prototype",{writable:!1}),C&&l(_,C)}function l(_,C){return l=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(y,$){return y.__proto__=$,y},l(_,C)}function u(_){var C=g();return function(){var y=m(_),$;if(C){var X=m(this).constructor;$=Reflect.construct(y,arguments,X)}else $=y.apply(this,arguments);return h(this,$)}}function h(_,C){if(C&&(t(C)==="object"||typeof C=="function"))return C;if(C!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return f(_)}function f(_){if(_===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return _}function g(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function m(_){return m=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(A){return A.__proto__||Object.getPrototypeOf(A)},m(_)}function v(_,C,A){return C=S(C),C in _?Object.defineProperty(_,C,{value:A,enumerable:!0,configurable:!0,writable:!0}):_[C]=A,_}function S(_){var C=w(_,"string");return t(C)==="symbol"?C:String(C)}function w(_,C){if(t(_)!=="object"||_===null)return _;var A=_[Symbol.toPrimitive];if(A!==void 0){var y=A.call(_,C||"default");if(t(y)!=="object")return y;throw new TypeError("@@toPrimitive must return a primitive value.")}return(C==="string"?String:Number)(_)}var M=function(_){c(A,_);var C=u(A);function A(y,$,X,le){var ne;return s(this,A),ne=C.call(this),ne.sendDirection=y,ne.initialWidgetId=$,ne.transportWindow=X,ne.inboundWindow=le,v(f(ne),"strictOriginCheck",!1),v(f(ne),"targetOrigin","*"),v(f(ne),"timeoutSeconds",10),v(f(ne),"_ready",!1),v(f(ne),"_widgetId",null),v(f(ne),"outboundRequests",new Map),v(f(ne),"stopController",new AbortController),ne._widgetId=$,ne}return a(A,[{key:"ready",get:function(){return this._ready}},{key:"widgetId",get:function(){return this._widgetId||null}},{key:"nextRequestId",get:function(){for(var $="widgetapi-".concat(Date.now()),X=0,le=$;this.outboundRequests.has(le);)le="".concat($,"-").concat(X++);return this.outboundRequests.set(le,null),le}},{key:"sendInternal",value:function($){console.log("[PostmessageTransport] Sending object to ".concat(this.targetOrigin,": "),$),this.transportWindow.postMessage($,this.targetOrigin)}},{key:"reply",value:function($,X){return this.sendInternal(n(n({},$),{},{response:X}))}},{key:"send",value:function($,X){return this.sendComplete($,X).then(function(le){return le.response})}},{key:"sendComplete",value:function($,X){var le=this;if(!this.ready||!this.widgetId)return Promise.reject(new Error("Not ready or unknown widget ID"));var ne={api:this.sendDirection,widgetId:this.widgetId,requestId:this.nextRequestId,action:$,data:X};return $===e.WidgetApiToWidgetAction.UpdateVisibility&&(ne.visible=X.visible),new Promise(function(ue,ge){var Se=function(T){j(),ue(T)},ze=function(T){j(),ge(T)},Ct=setTimeout(function(){return ze(new Error("Request timed out"))},(le.timeoutSeconds||1)*1e3),q=function(){return ze(new Error("Transport stopped"))};le.stopController.signal.addEventListener("abort",q);var j=function(){le.outboundRequests.delete(ne.requestId),clearTimeout(Ct),le.stopController.signal.removeEventListener("abort",q)};le.outboundRequests.set(ne.requestId,{request:ne,resolve:Se,reject:ze}),le.sendInternal(ne)})}},{key:"start",value:function(){var $=this;this.inboundWindow.addEventListener("message",function(X){$.handleMessage(X)}),this._ready=!0}},{key:"stop",value:function(){this._ready=!1,this.stopController.abort()}},{key:"handleMessage",value:function($){if(!this.stopController.signal.aborted&&$.data&&!(this.strictOriginCheck&&$.origin!==window.origin)){var X=$.data;if(!(!X.action||!X.requestId||!X.widgetId))if(X.response){if(X.api!==this.sendDirection)return;this.handleResponse(X)}else{var le=X;if(le.api!==(0,e.invertedDirection)(this.sendDirection))return;this.handleRequest(le)}}}},{key:"handleRequest",value:function($){if(this.widgetId){if(this.widgetId!==$.widgetId)return}else this._widgetId=$.widgetId;this.emit("message",new CustomEvent("message",{detail:$}))}},{key:"handleResponse",value:function($){if($.widgetId===this.widgetId){var X=this.outboundRequests.get($.requestId);if(X)if((0,e.isErrorResponse)($.response)){var le=$.response;X.reject(new Error(le.error.message))}else X.resolve($)}}}]),A}(r.EventEmitter);return cr.PostmessageTransport=M,cr}var Pi={};Object.defineProperty(Pi,"__esModule",{value:!0});Pi.WidgetApiToWidgetAction=Pi.WidgetApiFromWidgetAction=void 0;var LS=function(r){return r.SupportedApiVersions="supported_api_versions",r.Capabilities="capabilities",r.NotifyCapabilities="notify_capabilities",r.TakeScreenshot="screenshot",r.UpdateVisibility="visibility",r.OpenIDCredentials="openid_credentials",r.WidgetConfig="widget_config",r.CloseModalWidget="close_modal",r.ButtonClicked="button_clicked",r.SendEvent="send_event",r.SendToDevice="send_to_device",r.UpdateTurnServers="update_turn_servers",r}({});Pi.WidgetApiToWidgetAction=LS;var NS=function(r){return r.SupportedApiVersions="supported_api_versions",r.ContentLoaded="content_loaded",r.SendSticker="m.sticker",r.UpdateAlwaysOnScreen="set_always_on_screen",r.GetOpenIDCredentials="get_openid",r.CloseModalWidget="close_modal",r.OpenModalWidget="open_modal",r.SetModalButtonEnabled="set_button_enabled",r.SendEvent="send_event",r.SendToDevice="send_to_device",r.WatchTurnServers="watch_turn_servers",r.UnwatchTurnServers="unwatch_turn_servers",r.BeeperReadRoomAccountData="com.beeper.read_room_account_data",r.MSC2876ReadEvents="org.matrix.msc2876.read_events",r.MSC2931Navigate="org.matrix.msc2931.navigate",r.MSC2974RenegotiateCapabilities="org.matrix.msc2974.request_capabilities",r.MSC3869ReadRelations="org.matrix.msc3869.read_relations",r.MSC3973UserDirectorySearch="org.matrix.msc3973.user_directory_search",r.MSC4039GetMediaConfigAction="org.matrix.msc4039.get_media_config",r.MSC4039UploadFileAction="org.matrix.msc4039.upload_file",r}({});Pi.WidgetApiFromWidgetAction=NS;var Wn={};Object.defineProperty(Wn,"__esModule",{value:!0});Wn.OpenIDRequestState=void 0;var KS=function(r){return r.Allowed="allowed",r.Blocked="blocked",r.PendingUserConfirmation="request",r}({});Wn.OpenIDRequestState=KS;var Gr={};Object.defineProperty(Gr,"__esModule",{value:!0});Gr.MatrixWidgetType=void 0;var FS=function(r){return r.Custom="m.custom",r.JitsiMeet="m.jitsi",r.Stickerpicker="m.stickerpicker",r}({});Gr.MatrixWidgetType=FS;var Wr={};Object.defineProperty(Wr,"__esModule",{value:!0});Wr.BuiltInModalButtonID=void 0;var $S=function(r){return r.Close="m.close",r}({});Wr.BuiltInModalButtonID=$S;var Ht={};Object.defineProperty(Ht,"__esModule",{value:!0});Ht.WidgetEventCapability=Ht.EventKind=Ht.EventDirection=void 0;function Ur(r){"@babel/helpers - typeof";return Ur=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Ur(r)}function BS(r,e){var t=typeof Symbol<"u"&&r[Symbol.iterator]||r["@@iterator"];if(!t){if(Array.isArray(r)||(t=xS(r))||e&&r&&typeof r.length=="number"){t&&(r=t);var i=0,n=function(){};return{s:n,n:function(){return i>=r.length?{done:!0}:{done:!1,value:r[i++]}},e:function(l){throw l},f:n}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var s=!0,o=!1,a;return{s:function(){t=t.call(r)},n:function(){var l=t.next();return s=l.done,l},e:function(l){o=!0,a=l},f:function(){try{!s&&t.return!=null&&t.return()}finally{if(o)throw a}}}}function xS(r,e){if(r){if(typeof r=="string")return id(r,e);var t=Object.prototype.toString.call(r).slice(8,-1);if(t==="Object"&&r.constructor&&(t=r.constructor.name),t==="Map"||t==="Set")return Array.from(r);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return id(r,e)}}function id(r,e){(e==null||e>r.length)&&(e=r.length);for(var t=0,i=new Array(e);t<e;t++)i[t]=r[t];return i}function qS(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function nd(r,e){for(var t=0;t<e.length;t++){var i=e[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(r,jS(i.key),i)}}function VS(r,e,t){return e&&nd(r.prototype,e),t&&nd(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}function jS(r){var e=GS(r,"string");return Ur(e)==="symbol"?e:String(e)}function GS(r,e){if(Ur(r)!=="object"||r===null)return r;var t=r[Symbol.toPrimitive];if(t!==void 0){var i=t.call(r,e||"default");if(Ur(i)!=="object")return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(r)}var pt=function(r){return r.Event="event",r.State="state_event",r.ToDevice="to_device",r.RoomAccount="room_account",r}({});Ht.EventKind=pt;var _i=function(r){return r.Send="send",r.Receive="receive",r}({});Ht.EventDirection=_i;var WS=function(){function r(e,t,i,n,s){qS(this,r),this.direction=e,this.eventType=t,this.kind=i,this.keyStr=n,this.raw=s}return VS(r,[{key:"matchesAsStateEvent",value:function(t,i,n){return this.kind!==pt.State||this.direction!==t||this.eventType!==i?!1:this.keyStr===null||this.keyStr===n}},{key:"matchesAsToDeviceEvent",value:function(t,i){return!(this.kind!==pt.ToDevice||this.direction!==t||this.eventType!==i)}},{key:"matchesAsRoomEvent",value:function(t,i){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:null;if(this.kind!==pt.Event||this.direction!==t||this.eventType!==i)return!1;if(this.eventType==="m.room.message"){if(this.keyStr===null||this.keyStr===n)return!0}else return!0;return!1}},{key:"matchesAsRoomAccountData",value:function(t,i){return!(this.kind!==pt.RoomAccount||this.direction!==t||this.eventType!==i)}}],[{key:"forStateEvent",value:function(t,i,n){i=i.replace(/#/g,"\\#"),n=n!=null?"#".concat(n):"";var s="org.matrix.msc2762.".concat(t,".state_event:").concat(i).concat(n);return r.findEventCapabilities([s])[0]}},{key:"forToDeviceEvent",value:function(t,i){var n="org.matrix.msc3819.".concat(t,".to_device:").concat(i);return r.findEventCapabilities([n])[0]}},{key:"forRoomEvent",value:function(t,i){var n="org.matrix.msc2762.".concat(t,".event:").concat(i);return r.findEventCapabilities([n])[0]}},{key:"forRoomMessageEvent",value:function(t,i){i=i??"";var n="org.matrix.msc2762.".concat(t,".event:m.room.message#").concat(i);return r.findEventCapabilities([n])[0]}},{key:"forRoomAccountData",value:function(t,i){var n="com.beeper.capabilities.".concat(t,".room_account_data:").concat(i);return r.findEventCapabilities([n])[0]}},{key:"findEventCapabilities",value:function(t){var i=[],n=BS(t),s;try{for(n.s();!(s=n.n()).done;){var o=s.value,a=null,c=void 0,l=null;if(o.startsWith("org.matrix.msc2762.send.event:")?(a=_i.Send,l=pt.Event,c=o.substring(30)):o.startsWith("org.matrix.msc2762.send.state_event:")?(a=_i.Send,l=pt.State,c=o.substring(36)):o.startsWith("org.matrix.msc3819.send.to_device:")?(a=_i.Send,l=pt.ToDevice,c=o.substring(34)):o.startsWith("org.matrix.msc2762.receive.event:")?(a=_i.Receive,l=pt.Event,c=o.substring(33)):o.startsWith("org.matrix.msc2762.receive.state_event:")?(a=_i.Receive,l=pt.State,c=o.substring(39)):o.startsWith("org.matrix.msc3819.receive.to_device:")?(a=_i.Receive,l=pt.ToDevice,c=o.substring(37)):o.startsWith("com.beeper.capabilities.receive.room_account_data:")&&(a=_i.Receive,l=pt.RoomAccount,c=o.substring(50)),!(a===null||l===null||c===void 0)){var u=c.startsWith("m.room.message#")||l===pt.State,h=null;if(c.includes("#")&&u){var f=c.split("#"),g=f.findIndex(function(m){return!m.endsWith("\\")});c=f.slice(0,g+1).map(function(m){return m.endsWith("\\")?m.substring(0,m.length-1):m}).join("#"),h=f.slice(g+1).join("#")}i.push(new r(a,c,l,h,o))}}}catch(m){n.e(m)}finally{n.f()}return i}}]),r}();Ht.WidgetEventCapability=WS;var Hn={};Object.defineProperty(Hn,"__esModule",{value:!0});Hn.Symbols=void 0;var HS=function(r){return r.AnyRoom="*",r}({});Hn.Symbols=HS;var rd;function JS(){if(rd)return ar;rd=1,Object.defineProperty(ar,"__esModule",{value:!0}),ar.WidgetApi=void 0;var r=Kr,e=an,t=Wt,i=ac(),n=Pi,s=Wn,o=Gr,a=Wr,c=Ht,l=Hn;function u(q){"@babel/helpers - typeof";return u=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(j){return typeof j}:function(j){return j&&typeof Symbol=="function"&&j.constructor===Symbol&&j!==Symbol.prototype?"symbol":typeof j},u(q)}function h(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */h=function(){return q};var q={},j=Object.prototype,oe=j.hasOwnProperty,T=Object.defineProperty||function(G,x,V){G[x]=V.value},I=typeof Symbol=="function"?Symbol:{},k=I.iterator||"@@iterator",O=I.asyncIterator||"@@asyncIterator",E=I.toStringTag||"@@toStringTag";function P(G,x,V){return Object.defineProperty(G,x,{value:V,enumerable:!0,configurable:!0,writable:!0}),G[x]}try{P({},"")}catch{P=function(V,F,U){return V[F]=U}}function b(G,x,V,F){var U=x&&x.prototype instanceof K?x:K,N=Object.create(U.prototype),H=new ln(F||[]);return T(N,"_invoke",{value:pi(G,V,H)}),N}function B(G,x,V){try{return{type:"normal",arg:G.call(x,V)}}catch(F){return{type:"throw",arg:F}}}q.wrap=b;var L={};function K(){}function Y(){}function J(){}var re={};P(re,k,function(){return this});var Me=Object.getPrototypeOf,ve=Me&&Me(Me(Yn([])));ve&&ve!==j&&oe.call(ve,k)&&(re=ve);var p=J.prototype=K.prototype=Object.create(re);function te(G){["next","throw","return"].forEach(function(x){P(G,x,function(V){return this._invoke(x,V)})})}function Yt(G,x){function V(U,N,H,Z){var Q=B(G[U],G,N);if(Q.type!=="throw"){var ye=Q.arg,Ie=ye.value;return Ie&&u(Ie)=="object"&&oe.call(Ie,"__await")?x.resolve(Ie.__await).then(function(Oe){V("next",Oe,H,Z)},function(Oe){V("throw",Oe,H,Z)}):x.resolve(Ie).then(function(Oe){ye.value=Oe,H(ye)},function(Oe){return V("throw",Oe,H,Z)})}Z(Q.arg)}var F;T(this,"_invoke",{value:function(N,H){function Z(){return new x(function(Q,ye){V(N,H,Q,ye)})}return F=F?F.then(Z,Z):Z()}})}function pi(G,x,V){var F="suspendedStart";return function(U,N){if(F==="executing")throw new Error("Generator is already running");if(F==="completed"){if(U==="throw")throw N;return dn()}for(V.method=U,V.arg=N;;){var H=V.delegate;if(H){var Z=Jn(H,V);if(Z){if(Z===L)continue;return Z}}if(V.method==="next")V.sent=V._sent=V.arg;else if(V.method==="throw"){if(F==="suspendedStart")throw F="completed",V.arg;V.dispatchException(V.arg)}else V.method==="return"&&V.abrupt("return",V.arg);F="executing";var Q=B(G,x,V);if(Q.type==="normal"){if(F=V.done?"completed":"suspendedYield",Q.arg===L)continue;return{value:Q.arg,done:V.done}}Q.type==="throw"&&(F="completed",V.method="throw",V.arg=Q.arg)}}}function Jn(G,x){var V=x.method,F=G.iterator[V];if(F===void 0)return x.delegate=null,V==="throw"&&G.iterator.return&&(x.method="return",x.arg=void 0,Jn(G,x),x.method==="throw")||V!=="return"&&(x.method="throw",x.arg=new TypeError("The iterator does not provide a '"+V+"' method")),L;var U=B(F,G.iterator,x.arg);if(U.type==="throw")return x.method="throw",x.arg=U.arg,x.delegate=null,L;var N=U.arg;return N?N.done?(x[G.resultName]=N.value,x.next=G.nextLoc,x.method!=="return"&&(x.method="next",x.arg=void 0),x.delegate=null,L):N:(x.method="throw",x.arg=new TypeError("iterator result is not an object"),x.delegate=null,L)}function cn(G){var x={tryLoc:G[0]};1 in G&&(x.catchLoc=G[1]),2 in G&&(x.finallyLoc=G[2],x.afterLoc=G[3]),this.tryEntries.push(x)}function zn(G){var x=G.completion||{};x.type="normal",delete x.arg,G.completion=x}function ln(G){this.tryEntries=[{tryLoc:"root"}],G.forEach(cn,this),this.reset(!0)}function Yn(G){if(G){var x=G[k];if(x)return x.call(G);if(typeof G.next=="function")return G;if(!isNaN(G.length)){var V=-1,F=function U(){for(;++V<G.length;)if(oe.call(G,V))return U.value=G[V],U.done=!1,U;return U.value=void 0,U.done=!0,U};return F.next=F}}return{next:dn}}function dn(){return{value:void 0,done:!0}}return Y.prototype=J,T(p,"constructor",{value:J,configurable:!0}),T(J,"constructor",{value:Y,configurable:!0}),Y.displayName=P(J,E,"GeneratorFunction"),q.isGeneratorFunction=function(G){var x=typeof G=="function"&&G.constructor;return!!x&&(x===Y||(x.displayName||x.name)==="GeneratorFunction")},q.mark=function(G){return Object.setPrototypeOf?Object.setPrototypeOf(G,J):(G.__proto__=J,P(G,E,"GeneratorFunction")),G.prototype=Object.create(p),G},q.awrap=function(G){return{__await:G}},te(Yt.prototype),P(Yt.prototype,O,function(){return this}),q.AsyncIterator=Yt,q.async=function(G,x,V,F,U){U===void 0&&(U=Promise);var N=new Yt(b(G,x,V,F),U);return q.isGeneratorFunction(x)?N:N.next().then(function(H){return H.done?H.value:N.next()})},te(p),P(p,E,"Generator"),P(p,k,function(){return this}),P(p,"toString",function(){return"[object Generator]"}),q.keys=function(G){var x=Object(G),V=[];for(var F in x)V.push(F);return V.reverse(),function U(){for(;V.length;){var N=V.pop();if(N in x)return U.value=N,U.done=!1,U}return U.done=!0,U}},q.values=Yn,ln.prototype={constructor:ln,reset:function(x){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(zn),!x)for(var V in this)V.charAt(0)==="t"&&oe.call(this,V)&&!isNaN(+V.slice(1))&&(this[V]=void 0)},stop:function(){this.done=!0;var x=this.tryEntries[0].completion;if(x.type==="throw")throw x.arg;return this.rval},dispatchException:function(x){if(this.done)throw x;var V=this;function F(ye,Ie){return H.type="throw",H.arg=x,V.next=ye,Ie&&(V.method="next",V.arg=void 0),!!Ie}for(var U=this.tryEntries.length-1;U>=0;--U){var N=this.tryEntries[U],H=N.completion;if(N.tryLoc==="root")return F("end");if(N.tryLoc<=this.prev){var Z=oe.call(N,"catchLoc"),Q=oe.call(N,"finallyLoc");if(Z&&Q){if(this.prev<N.catchLoc)return F(N.catchLoc,!0);if(this.prev<N.finallyLoc)return F(N.finallyLoc)}else if(Z){if(this.prev<N.catchLoc)return F(N.catchLoc,!0)}else{if(!Q)throw new Error("try statement without catch or finally");if(this.prev<N.finallyLoc)return F(N.finallyLoc)}}}},abrupt:function(x,V){for(var F=this.tryEntries.length-1;F>=0;--F){var U=this.tryEntries[F];if(U.tryLoc<=this.prev&&oe.call(U,"finallyLoc")&&this.prev<U.finallyLoc){var N=U;break}}N&&(x==="break"||x==="continue")&&N.tryLoc<=V&&V<=N.finallyLoc&&(N=null);var H=N?N.completion:{};return H.type=x,H.arg=V,N?(this.method="next",this.next=N.finallyLoc,L):this.complete(H)},complete:function(x,V){if(x.type==="throw")throw x.arg;return x.type==="break"||x.type==="continue"?this.next=x.arg:x.type==="return"?(this.rval=this.arg=x.arg,this.method="return",this.next="end"):x.type==="normal"&&V&&(this.next=V),L},finish:function(x){for(var V=this.tryEntries.length-1;V>=0;--V){var F=this.tryEntries[V];if(F.finallyLoc===x)return this.complete(F.completion,F.afterLoc),zn(F),L}},catch:function(x){for(var V=this.tryEntries.length-1;V>=0;--V){var F=this.tryEntries[V];if(F.tryLoc===x){var U=F.completion;if(U.type==="throw"){var N=U.arg;zn(F)}return N}}throw new Error("illegal catch attempt")},delegateYield:function(x,V,F){return this.delegate={iterator:Yn(x),resultName:V,nextLoc:F},this.method==="next"&&(this.arg=void 0),L}},q}function f(q,j,oe,T,I,k,O){try{var E=q[k](O),P=E.value}catch(b){oe(b);return}E.done?j(P):Promise.resolve(P).then(T,I)}function g(q){return function(){var j=this,oe=arguments;return new Promise(function(T,I){var k=q.apply(j,oe);function O(P){f(k,T,I,O,E,"next",P)}function E(P){f(k,T,I,O,E,"throw",P)}O(void 0)})}}function m(q,j){if(!(q instanceof j))throw new TypeError("Cannot call a class as a function")}function v(q,j){for(var oe=0;oe<j.length;oe++){var T=j[oe];T.enumerable=T.enumerable||!1,T.configurable=!0,"value"in T&&(T.writable=!0),Object.defineProperty(q,le(T.key),T)}}function S(q,j,oe){return j&&v(q.prototype,j),oe&&v(q,oe),Object.defineProperty(q,"prototype",{writable:!1}),q}function w(q,j){if(typeof j!="function"&&j!==null)throw new TypeError("Super expression must either be null or a function");q.prototype=Object.create(j&&j.prototype,{constructor:{value:q,writable:!0,configurable:!0}}),Object.defineProperty(q,"prototype",{writable:!1}),j&&M(q,j)}function M(q,j){return M=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(T,I){return T.__proto__=I,T},M(q,j)}function _(q){var j=y();return function(){var T=$(q),I;if(j){var k=$(this).constructor;I=Reflect.construct(T,arguments,k)}else I=T.apply(this,arguments);return C(this,I)}}function C(q,j){if(j&&(u(j)==="object"||typeof j=="function"))return j;if(j!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return A(q)}function A(q){if(q===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return q}function y(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function $(q){return $=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(oe){return oe.__proto__||Object.getPrototypeOf(oe)},$(q)}function X(q,j,oe){return j=le(j),j in q?Object.defineProperty(q,j,{value:oe,enumerable:!0,configurable:!0,writable:!0}):q[j]=oe,q}function le(q){var j=ne(q,"string");return u(j)==="symbol"?j:String(j)}function ne(q,j){if(u(q)!=="object"||q===null)return q;var oe=q[Symbol.toPrimitive];if(oe!==void 0){var T=oe.call(q,j||"default");if(u(T)!=="object")return T;throw new TypeError("@@toPrimitive must return a primitive value.")}return(j==="string"?String:Number)(q)}function ue(q){return new ze(q,0)}function ge(q){return function(){return new Se(q.apply(this,arguments))}}function Se(q){var j,oe;function T(k,O){try{var E=q[k](O),P=E.value,b=P instanceof ze;Promise.resolve(b?P.v:P).then(function(B){if(b){var L=k==="return"?"return":"next";if(!P.k||B.done)return T(L,B);B=q[L](B).value}I(E.done?"return":"normal",B)},function(B){T("throw",B)})}catch(B){I("throw",B)}}function I(k,O){switch(k){case"return":j.resolve({value:O,done:!0});break;case"throw":j.reject(O);break;default:j.resolve({value:O,done:!1})}(j=j.next)?T(j.key,j.arg):oe=null}this._invoke=function(k,O){return new Promise(function(E,P){var b={key:k,arg:O,resolve:E,reject:P,next:null};oe?oe=oe.next=b:(j=oe=b,T(k,O))})},typeof q.return!="function"&&(this.return=void 0)}Se.prototype[typeof Symbol=="function"&&Symbol.asyncIterator||"@@asyncIterator"]=function(){return this},Se.prototype.next=function(q){return this._invoke("next",q)},Se.prototype.throw=function(q){return this._invoke("throw",q)},Se.prototype.return=function(q){return this._invoke("return",q)};function ze(q,j){this.v=q,this.k=j}var Ct=function(q){w(oe,q);var j=_(oe);function oe(){var T,I=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null,k=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;if(m(this,oe),T=j.call(this),T.clientOrigin=k,X(A(T),"transport",void 0),X(A(T),"capabilitiesFinished",!1),X(A(T),"supportsMSC2974Renegotiate",!1),X(A(T),"requestedCapabilities",[]),X(A(T),"approvedCapabilities",void 0),X(A(T),"cachedClientVersions",void 0),X(A(T),"turnServerWatchers",0),!window.parent)throw new Error("No parent window. This widget doesn't appear to be embedded properly.");return T.transport=new i.PostmessageTransport(e.WidgetApiDirection.FromWidget,I,window.parent,window),T.transport.targetOrigin=k,T.transport.on("message",T.handleMessage.bind(A(T))),T}return S(oe,[{key:"hasCapability",value:function(I){return Array.isArray(this.approvedCapabilities)?this.approvedCapabilities.includes(I):this.requestedCapabilities.includes(I)}},{key:"requestCapability",value:function(I){if(this.capabilitiesFinished&&!this.supportsMSC2974Renegotiate)throw new Error("Capabilities have already been negotiated");this.requestedCapabilities.push(I)}},{key:"requestCapabilities",value:function(I){var k=this;I.forEach(function(O){return k.requestCapability(O)})}},{key:"requestCapabilityForRoomTimeline",value:function(I){this.requestCapability("org.matrix.msc2762.timeline:".concat(I))}},{key:"requestCapabilityToSendState",value:function(I,k){this.requestCapability(c.WidgetEventCapability.forStateEvent(c.EventDirection.Send,I,k).raw)}},{key:"requestCapabilityToReceiveState",value:function(I,k){this.requestCapability(c.WidgetEventCapability.forStateEvent(c.EventDirection.Receive,I,k).raw)}},{key:"requestCapabilityToSendToDevice",value:function(I){this.requestCapability(c.WidgetEventCapability.forToDeviceEvent(c.EventDirection.Send,I).raw)}},{key:"requestCapabilityToReceiveToDevice",value:function(I){this.requestCapability(c.WidgetEventCapability.forToDeviceEvent(c.EventDirection.Receive,I).raw)}},{key:"requestCapabilityToSendEvent",value:function(I){this.requestCapability(c.WidgetEventCapability.forRoomEvent(c.EventDirection.Send,I).raw)}},{key:"requestCapabilityToReceiveEvent",value:function(I){this.requestCapability(c.WidgetEventCapability.forRoomEvent(c.EventDirection.Receive,I).raw)}},{key:"requestCapabilityToSendMessage",value:function(I){this.requestCapability(c.WidgetEventCapability.forRoomMessageEvent(c.EventDirection.Send,I).raw)}},{key:"requestCapabilityToReceiveMessage",value:function(I){this.requestCapability(c.WidgetEventCapability.forRoomMessageEvent(c.EventDirection.Receive,I).raw)}},{key:"requestCapabilityToReceiveRoomAccountData",value:function(I){this.requestCapability(c.WidgetEventCapability.forRoomAccountData(c.EventDirection.Receive,I).raw)}},{key:"requestOpenIDConnectToken",value:function(){var I=this;return new Promise(function(k,O){I.transport.sendComplete(n.WidgetApiFromWidgetAction.GetOpenIDCredentials,{}).then(function(E){var P=E.response;if(P.state===s.OpenIDRequestState.Allowed)k(P);else if(P.state===s.OpenIDRequestState.Blocked)O(new Error("User declined to verify their identity"));else if(P.state===s.OpenIDRequestState.PendingUserConfirmation){var b=function B(L){L.preventDefault();var K=L.detail;K.data.original_request_id===E.requestId&&(K.data.state===s.OpenIDRequestState.Allowed?(k(K.data),I.transport.reply(K,{})):K.data.state===s.OpenIDRequestState.Blocked?(O(new Error("User declined to verify their identity")),I.transport.reply(K,{})):(O(new Error("Invalid state on reply: "+P.state)),I.transport.reply(K,{error:{message:"Invalid state"}})),I.off("action:".concat(n.WidgetApiToWidgetAction.OpenIDCredentials),B))};I.on("action:".concat(n.WidgetApiToWidgetAction.OpenIDCredentials),b)}else O(new Error("Invalid state: "+P.state))}).catch(O)})}},{key:"updateRequestedCapabilities",value:function(){return this.transport.send(n.WidgetApiFromWidgetAction.MSC2974RenegotiateCapabilities,{capabilities:this.requestedCapabilities}).then()}},{key:"sendContentLoaded",value:function(){return this.transport.send(n.WidgetApiFromWidgetAction.ContentLoaded,{}).then()}},{key:"sendSticker",value:function(I){return this.transport.send(n.WidgetApiFromWidgetAction.SendSticker,I).then()}},{key:"setAlwaysOnScreen",value:function(I){return this.transport.send(n.WidgetApiFromWidgetAction.UpdateAlwaysOnScreen,{value:I}).then(function(k){return k.success})}},{key:"openModalWidget",value:function(I,k){var O=arguments.length>2&&arguments[2]!==void 0?arguments[2]:[],E=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{},P=arguments.length>4&&arguments[4]!==void 0?arguments[4]:o.MatrixWidgetType.Custom;return this.transport.send(n.WidgetApiFromWidgetAction.OpenModalWidget,{type:P,url:I,name:k,buttons:O,data:E}).then()}},{key:"closeModalWidget",value:function(){var I=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.transport.send(n.WidgetApiFromWidgetAction.CloseModalWidget,I).then()}},{key:"sendRoomEvent",value:function(I,k,O){return this.transport.send(n.WidgetApiFromWidgetAction.SendEvent,{type:I,content:k,room_id:O})}},{key:"sendStateEvent",value:function(I,k,O,E){return this.transport.send(n.WidgetApiFromWidgetAction.SendEvent,{type:I,content:O,state_key:k,room_id:E})}},{key:"sendToDevice",value:function(I,k,O){return this.transport.send(n.WidgetApiFromWidgetAction.SendToDevice,{type:I,encrypted:k,messages:O})}},{key:"readRoomAccountData",value:function(I,k){var O={type:I};return k&&(k.includes(l.Symbols.AnyRoom)?O.room_ids=l.Symbols.AnyRoom:O.room_ids=k),this.transport.send(n.WidgetApiFromWidgetAction.BeeperReadRoomAccountData,O).then(function(E){return E.events})}},{key:"readRoomEvents",value:function(I,k,O,E,P){var b={type:I,msgtype:O};return k!==void 0&&(b.limit=k),E&&(E.includes(l.Symbols.AnyRoom)?b.room_ids=l.Symbols.AnyRoom:b.room_ids=E),P&&(b.since=P),this.transport.send(n.WidgetApiFromWidgetAction.MSC2876ReadEvents,b).then(function(B){return B.events})}},{key:"readEventRelations",value:function(){var T=g(h().mark(function k(O,E,P,b,B,L,K,Y){var J,re;return h().wrap(function(ve){for(;;)switch(ve.prev=ve.next){case 0:return ve.next=2,this.getClientVersions();case 2:if(J=ve.sent,J.includes(t.UnstableApiVersion.MSC3869)){ve.next=5;break}throw new Error("The read_relations action is not supported by the client.");case 5:return re={event_id:O,rel_type:P,event_type:b,room_id:E,to:K,from:L,limit:B,direction:Y},ve.abrupt("return",this.transport.send(n.WidgetApiFromWidgetAction.MSC3869ReadRelations,re));case 7:case"end":return ve.stop()}},k,this)}));function I(k,O,E,P,b,B,L,K){return T.apply(this,arguments)}return I}()},{key:"readStateEvents",value:function(I,k,O,E){var P={type:I,state_key:O===void 0?!0:O};return k!==void 0&&(P.limit=k),E&&(E.includes(l.Symbols.AnyRoom)?P.room_ids=l.Symbols.AnyRoom:P.room_ids=E),this.transport.send(n.WidgetApiFromWidgetAction.MSC2876ReadEvents,P).then(function(b){return b.events})}},{key:"setModalButtonEnabled",value:function(I,k){if(I===a.BuiltInModalButtonID.Close)throw new Error("The close button cannot be disabled");return this.transport.send(n.WidgetApiFromWidgetAction.SetModalButtonEnabled,{button:I,enabled:k}).then()}},{key:"navigateTo",value:function(I){if(!I||!I.startsWith("https://matrix.to/#"))throw new Error("Invalid matrix.to URI");return this.transport.send(n.WidgetApiFromWidgetAction.MSC2931Navigate,{uri:I}).then()}},{key:"getTurnServers",value:function(){var I=this;return ge(h().mark(function k(){var O,E;return h().wrap(function(b){for(;;)switch(b.prev=b.next){case 0:if(E=function(){var B=g(h().mark(function L(K){return h().wrap(function(J){for(;;)switch(J.prev=J.next){case 0:return K.preventDefault(),O(K.detail.data),J.next=4,I.transport.reply(K.detail,{});case 4:case"end":return J.stop()}},L)}));return function(K){return B.apply(this,arguments)}}(),I.on("action:".concat(n.WidgetApiToWidgetAction.UpdateTurnServers),E),I.turnServerWatchers!==0){b.next=12;break}return b.prev=3,b.next=6,ue(I.transport.send(n.WidgetApiFromWidgetAction.WatchTurnServers,{}));case 6:b.next=12;break;case 8:throw b.prev=8,b.t0=b.catch(3),I.off("action:".concat(n.WidgetApiToWidgetAction.UpdateTurnServers),E),b.t0;case 12:I.turnServerWatchers++,b.prev=13;case 14:return b.next=17,ue(new Promise(function(B){return O=B}));case 17:return b.next=19,b.sent;case 19:b.next=14;break;case 21:if(b.prev=21,I.off("action:".concat(n.WidgetApiToWidgetAction.UpdateTurnServers),E),I.turnServerWatchers--,I.turnServerWatchers!==0){b.next=27;break}return b.next=27,ue(I.transport.send(n.WidgetApiFromWidgetAction.UnwatchTurnServers,{}));case 27:return b.finish(21);case 28:case"end":return b.stop()}},k,null,[[3,8],[13,,21,28]])}))()}},{key:"searchUserDirectory",value:function(){var T=g(h().mark(function k(O,E){var P,b;return h().wrap(function(L){for(;;)switch(L.prev=L.next){case 0:return L.next=2,this.getClientVersions();case 2:if(P=L.sent,P.includes(t.UnstableApiVersion.MSC3973)){L.next=5;break}throw new Error("The user_directory_search action is not supported by the client.");case 5:return b={search_term:O,limit:E},L.abrupt("return",this.transport.send(n.WidgetApiFromWidgetAction.MSC3973UserDirectorySearch,b));case 7:case"end":return L.stop()}},k,this)}));function I(k,O){return T.apply(this,arguments)}return I}()},{key:"getMediaConfig",value:function(){var T=g(h().mark(function k(){var O,E;return h().wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return b.next=2,this.getClientVersions();case 2:if(O=b.sent,O.includes(t.UnstableApiVersion.MSC4039)){b.next=5;break}throw new Error("The get_media_config action is not supported by the client.");case 5:return E={},b.abrupt("return",this.transport.send(n.WidgetApiFromWidgetAction.MSC4039GetMediaConfigAction,E));case 7:case"end":return b.stop()}},k,this)}));function I(){return T.apply(this,arguments)}return I}()},{key:"uploadFile",value:function(){var T=g(h().mark(function k(O){var E,P;return h().wrap(function(B){for(;;)switch(B.prev=B.next){case 0:return B.next=2,this.getClientVersions();case 2:if(E=B.sent,E.includes(t.UnstableApiVersion.MSC4039)){B.next=5;break}throw new Error("The upload_file action is not supported by the client.");case 5:return P={file:O},B.abrupt("return",this.transport.send(n.WidgetApiFromWidgetAction.MSC4039UploadFileAction,P));case 7:case"end":return B.stop()}},k,this)}));function I(k){return T.apply(this,arguments)}return I}()},{key:"start",value:function(){var I=this;this.transport.start(),this.getClientVersions().then(function(k){k.includes(t.UnstableApiVersion.MSC2974)&&(I.supportsMSC2974Renegotiate=!0)})}},{key:"handleMessage",value:function(I){var k=new CustomEvent("action:".concat(I.detail.action),{detail:I.detail,cancelable:!0});if(this.emit("action:".concat(I.detail.action),k),!k.defaultPrevented)switch(I.detail.action){case n.WidgetApiToWidgetAction.SupportedApiVersions:return this.replyVersions(I.detail);case n.WidgetApiToWidgetAction.Capabilities:return this.handleCapabilities(I.detail);case n.WidgetApiToWidgetAction.UpdateVisibility:return this.transport.reply(I.detail,{});case n.WidgetApiToWidgetAction.NotifyCapabilities:return this.transport.reply(I.detail,{});default:return this.transport.reply(I.detail,{error:{message:"Unknown or unsupported action: "+I.detail.action}})}}},{key:"replyVersions",value:function(I){this.transport.reply(I,{supported_versions:t.CurrentApiVersions})}},{key:"getClientVersions",value:function(){var I=this;return Array.isArray(this.cachedClientVersions)?Promise.resolve(this.cachedClientVersions):this.transport.send(n.WidgetApiFromWidgetAction.SupportedApiVersions,{}).then(function(k){return I.cachedClientVersions=k.supported_versions,k.supported_versions}).catch(function(k){return console.warn("non-fatal error getting supported client versions: ",k),[]})}},{key:"handleCapabilities",value:function(I){var k=this;return this.capabilitiesFinished?this.transport.reply(I,{error:{message:"Capability negotiation already completed"}}):this.getClientVersions().then(function(O){return O.includes(t.UnstableApiVersion.MSC2871)?k.once("action:".concat(n.WidgetApiToWidgetAction.NotifyCapabilities),function(E){k.approvedCapabilities=E.detail.data.approved,k.emit("ready")}):k.emit("ready"),k.capabilitiesFinished=!0,k.transport.reply(I,{capabilities:k.requestedCapabilities})})}}]),oe}(r.EventEmitter);return ar.WidgetApi=Ct,ar}var lr={},Rt={};Object.defineProperty(Rt,"__esModule",{value:!0});Rt.VideoConferenceCapabilities=Rt.StickerpickerCapabilities=Rt.MatrixCapabilities=void 0;Rt.getTimelineRoomIDFromCapability=ZS;Rt.isTimelineCapability=QS;Rt.isTimelineCapabilityFor=XS;var cc=function(r){return r.Screenshots="m.capability.screenshot",r.StickerSending="m.sticker",r.AlwaysOnScreen="m.always_on_screen",r.RequiresClient="io.element.requires_client",r.MSC2931Navigate="org.matrix.msc2931.navigate",r.MSC3846TurnServers="town.robin.msc3846.turn_servers",r.MSC3973UserDirectorySearch="org.matrix.msc3973.user_directory_search",r.MSC4039UploadFile="org.matrix.msc4039.upload_file",r}({});Rt.MatrixCapabilities=cc;var zS=[cc.StickerSending];Rt.StickerpickerCapabilities=zS;var YS=[cc.AlwaysOnScreen];Rt.VideoConferenceCapabilities=YS;function QS(r){return r==null?void 0:r.startsWith("org.matrix.msc2762.timeline:")}function XS(r,e){return r==="org.matrix.msc2762.timeline:".concat(e)}function ZS(r){return r.substring(r.indexOf(":")+1)}var Hr={};Object.defineProperty(Hr,"__esModule",{value:!0});Hr.SimpleObservable=void 0;function Lr(r){"@babel/helpers - typeof";return Lr=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Lr(r)}function eE(r,e){var t=typeof Symbol<"u"&&r[Symbol.iterator]||r["@@iterator"];if(!t){if(Array.isArray(r)||(t=tE(r))||e&&r&&typeof r.length=="number"){t&&(r=t);var i=0,n=function(){};return{s:n,n:function(){return i>=r.length?{done:!0}:{done:!1,value:r[i++]}},e:function(l){throw l},f:n}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var s=!0,o=!1,a;return{s:function(){t=t.call(r)},n:function(){var l=t.next();return s=l.done,l},e:function(l){o=!0,a=l},f:function(){try{!s&&t.return!=null&&t.return()}finally{if(o)throw a}}}}function tE(r,e){if(r){if(typeof r=="string")return sd(r,e);var t=Object.prototype.toString.call(r).slice(8,-1);if(t==="Object"&&r.constructor&&(t=r.constructor.name),t==="Map"||t==="Set")return Array.from(r);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return sd(r,e)}}function sd(r,e){(e==null||e>r.length)&&(e=r.length);for(var t=0,i=new Array(e);t<e;t++)i[t]=r[t];return i}function iE(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function od(r,e){for(var t=0;t<e.length;t++){var i=e[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(r,zu(i.key),i)}}function nE(r,e,t){return e&&od(r.prototype,e),t&&od(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}function rE(r,e,t){return e=zu(e),e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}function zu(r){var e=sE(r,"string");return Lr(e)==="symbol"?e:String(e)}function sE(r,e){if(Lr(r)!=="object"||r===null)return r;var t=r[Symbol.toPrimitive];if(t!==void 0){var i=t.call(r,e||"default");if(Lr(i)!=="object")return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(r)}var oE=function(){function r(e){iE(this,r),rE(this,"listeners",[]),e&&this.listeners.push(e)}return nE(r,[{key:"onUpdate",value:function(t){this.listeners.push(t)}},{key:"update",value:function(t){var i=eE(this.listeners),n;try{for(i.s();!(n=i.n()).done;){var s=n.value;s(t)}}catch(o){i.e(o)}finally{i.f()}}},{key:"close",value:function(){this.listeners=[]}}]),r}();Hr.SimpleObservable=oE;var ad;function aE(){if(ad)return lr;ad=1,Object.defineProperty(lr,"__esModule",{value:!0}),lr.ClientWidgetApi=void 0;var r=Kr,e=ac(),t=an,i=Pi,n=Rt,s=Wt,o=Ht,a=Wn,c=Hr,l=Hn;function u(T){"@babel/helpers - typeof";return u=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(I){return typeof I}:function(I){return I&&typeof Symbol=="function"&&I.constructor===Symbol&&I!==Symbol.prototype?"symbol":typeof I},u(T)}function h(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */h=function(){return T};var T={},I=Object.prototype,k=I.hasOwnProperty,O=Object.defineProperty||function(F,U,N){F[U]=N.value},E=typeof Symbol=="function"?Symbol:{},P=E.iterator||"@@iterator",b=E.asyncIterator||"@@asyncIterator",B=E.toStringTag||"@@toStringTag";function L(F,U,N){return Object.defineProperty(F,U,{value:N,enumerable:!0,configurable:!0,writable:!0}),F[U]}try{L({},"")}catch{L=function(N,H,Z){return N[H]=Z}}function K(F,U,N,H){var Z=U&&U.prototype instanceof re?U:re,Q=Object.create(Z.prototype),ye=new G(H||[]);return O(Q,"_invoke",{value:zn(F,N,ye)}),Q}function Y(F,U,N){try{return{type:"normal",arg:F.call(U,N)}}catch(H){return{type:"throw",arg:H}}}T.wrap=K;var J={};function re(){}function Me(){}function ve(){}var p={};L(p,P,function(){return this});var te=Object.getPrototypeOf,Yt=te&&te(te(x([])));Yt&&Yt!==I&&k.call(Yt,P)&&(p=Yt);var pi=ve.prototype=re.prototype=Object.create(p);function Jn(F){["next","throw","return"].forEach(function(U){L(F,U,function(N){return this._invoke(U,N)})})}function cn(F,U){function N(Z,Q,ye,Ie){var Oe=Y(F[Z],F,Q);if(Oe.type!=="throw"){var Ui=Oe.arg,mi=Ui.value;return mi&&u(mi)=="object"&&k.call(mi,"__await")?U.resolve(mi.__await).then(function(Li){N("next",Li,ye,Ie)},function(Li){N("throw",Li,ye,Ie)}):U.resolve(mi).then(function(Li){Ui.value=Li,ye(Ui)},function(Li){return N("throw",Li,ye,Ie)})}Ie(Oe.arg)}var H;O(this,"_invoke",{value:function(Q,ye){function Ie(){return new U(function(Oe,Ui){N(Q,ye,Oe,Ui)})}return H=H?H.then(Ie,Ie):Ie()}})}function zn(F,U,N){var H="suspendedStart";return function(Z,Q){if(H==="executing")throw new Error("Generator is already running");if(H==="completed"){if(Z==="throw")throw Q;return V()}for(N.method=Z,N.arg=Q;;){var ye=N.delegate;if(ye){var Ie=ln(ye,N);if(Ie){if(Ie===J)continue;return Ie}}if(N.method==="next")N.sent=N._sent=N.arg;else if(N.method==="throw"){if(H==="suspendedStart")throw H="completed",N.arg;N.dispatchException(N.arg)}else N.method==="return"&&N.abrupt("return",N.arg);H="executing";var Oe=Y(F,U,N);if(Oe.type==="normal"){if(H=N.done?"completed":"suspendedYield",Oe.arg===J)continue;return{value:Oe.arg,done:N.done}}Oe.type==="throw"&&(H="completed",N.method="throw",N.arg=Oe.arg)}}}function ln(F,U){var N=U.method,H=F.iterator[N];if(H===void 0)return U.delegate=null,N==="throw"&&F.iterator.return&&(U.method="return",U.arg=void 0,ln(F,U),U.method==="throw")||N!=="return"&&(U.method="throw",U.arg=new TypeError("The iterator does not provide a '"+N+"' method")),J;var Z=Y(H,F.iterator,U.arg);if(Z.type==="throw")return U.method="throw",U.arg=Z.arg,U.delegate=null,J;var Q=Z.arg;return Q?Q.done?(U[F.resultName]=Q.value,U.next=F.nextLoc,U.method!=="return"&&(U.method="next",U.arg=void 0),U.delegate=null,J):Q:(U.method="throw",U.arg=new TypeError("iterator result is not an object"),U.delegate=null,J)}function Yn(F){var U={tryLoc:F[0]};1 in F&&(U.catchLoc=F[1]),2 in F&&(U.finallyLoc=F[2],U.afterLoc=F[3]),this.tryEntries.push(U)}function dn(F){var U=F.completion||{};U.type="normal",delete U.arg,F.completion=U}function G(F){this.tryEntries=[{tryLoc:"root"}],F.forEach(Yn,this),this.reset(!0)}function x(F){if(F){var U=F[P];if(U)return U.call(F);if(typeof F.next=="function")return F;if(!isNaN(F.length)){var N=-1,H=function Z(){for(;++N<F.length;)if(k.call(F,N))return Z.value=F[N],Z.done=!1,Z;return Z.value=void 0,Z.done=!0,Z};return H.next=H}}return{next:V}}function V(){return{value:void 0,done:!0}}return Me.prototype=ve,O(pi,"constructor",{value:ve,configurable:!0}),O(ve,"constructor",{value:Me,configurable:!0}),Me.displayName=L(ve,B,"GeneratorFunction"),T.isGeneratorFunction=function(F){var U=typeof F=="function"&&F.constructor;return!!U&&(U===Me||(U.displayName||U.name)==="GeneratorFunction")},T.mark=function(F){return Object.setPrototypeOf?Object.setPrototypeOf(F,ve):(F.__proto__=ve,L(F,B,"GeneratorFunction")),F.prototype=Object.create(pi),F},T.awrap=function(F){return{__await:F}},Jn(cn.prototype),L(cn.prototype,b,function(){return this}),T.AsyncIterator=cn,T.async=function(F,U,N,H,Z){Z===void 0&&(Z=Promise);var Q=new cn(K(F,U,N,H),Z);return T.isGeneratorFunction(U)?Q:Q.next().then(function(ye){return ye.done?ye.value:Q.next()})},Jn(pi),L(pi,B,"Generator"),L(pi,P,function(){return this}),L(pi,"toString",function(){return"[object Generator]"}),T.keys=function(F){var U=Object(F),N=[];for(var H in U)N.push(H);return N.reverse(),function Z(){for(;N.length;){var Q=N.pop();if(Q in U)return Z.value=Q,Z.done=!1,Z}return Z.done=!0,Z}},T.values=x,G.prototype={constructor:G,reset:function(U){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(dn),!U)for(var N in this)N.charAt(0)==="t"&&k.call(this,N)&&!isNaN(+N.slice(1))&&(this[N]=void 0)},stop:function(){this.done=!0;var U=this.tryEntries[0].completion;if(U.type==="throw")throw U.arg;return this.rval},dispatchException:function(U){if(this.done)throw U;var N=this;function H(Ui,mi){return ye.type="throw",ye.arg=U,N.next=Ui,mi&&(N.method="next",N.arg=void 0),!!mi}for(var Z=this.tryEntries.length-1;Z>=0;--Z){var Q=this.tryEntries[Z],ye=Q.completion;if(Q.tryLoc==="root")return H("end");if(Q.tryLoc<=this.prev){var Ie=k.call(Q,"catchLoc"),Oe=k.call(Q,"finallyLoc");if(Ie&&Oe){if(this.prev<Q.catchLoc)return H(Q.catchLoc,!0);if(this.prev<Q.finallyLoc)return H(Q.finallyLoc)}else if(Ie){if(this.prev<Q.catchLoc)return H(Q.catchLoc,!0)}else{if(!Oe)throw new Error("try statement without catch or finally");if(this.prev<Q.finallyLoc)return H(Q.finallyLoc)}}}},abrupt:function(U,N){for(var H=this.tryEntries.length-1;H>=0;--H){var Z=this.tryEntries[H];if(Z.tryLoc<=this.prev&&k.call(Z,"finallyLoc")&&this.prev<Z.finallyLoc){var Q=Z;break}}Q&&(U==="break"||U==="continue")&&Q.tryLoc<=N&&N<=Q.finallyLoc&&(Q=null);var ye=Q?Q.completion:{};return ye.type=U,ye.arg=N,Q?(this.method="next",this.next=Q.finallyLoc,J):this.complete(ye)},complete:function(U,N){if(U.type==="throw")throw U.arg;return U.type==="break"||U.type==="continue"?this.next=U.arg:U.type==="return"?(this.rval=this.arg=U.arg,this.method="return",this.next="end"):U.type==="normal"&&N&&(this.next=N),J},finish:function(U){for(var N=this.tryEntries.length-1;N>=0;--N){var H=this.tryEntries[N];if(H.finallyLoc===U)return this.complete(H.completion,H.afterLoc),dn(H),J}},catch:function(U){for(var N=this.tryEntries.length-1;N>=0;--N){var H=this.tryEntries[N];if(H.tryLoc===U){var Z=H.completion;if(Z.type==="throw"){var Q=Z.arg;dn(H)}return Q}}throw new Error("illegal catch attempt")},delegateYield:function(U,N,H){return this.delegate={iterator:x(U),resultName:N,nextLoc:H},this.method==="next"&&(this.arg=void 0),J}},T}function f(T,I,k,O,E,P,b){try{var B=T[P](b),L=B.value}catch(K){k(K);return}B.done?I(L):Promise.resolve(L).then(O,E)}function g(T){return function(){var I=this,k=arguments;return new Promise(function(O,E){var P=T.apply(I,k);function b(L){f(P,O,E,b,B,"next",L)}function B(L){f(P,O,E,b,B,"throw",L)}b(void 0)})}}function m(T,I){var k=typeof Symbol<"u"&&T[Symbol.iterator]||T["@@iterator"];if(!k){if(Array.isArray(T)||(k=v(T))||I&&T&&typeof T.length=="number"){k&&(T=k);var O=0,E=function(){};return{s:E,n:function(){return O>=T.length?{done:!0}:{done:!1,value:T[O++]}},e:function(K){throw K},f:E}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var P=!0,b=!1,B;return{s:function(){k=k.call(T)},n:function(){var K=k.next();return P=K.done,K},e:function(K){b=!0,B=K},f:function(){try{!P&&k.return!=null&&k.return()}finally{if(b)throw B}}}}function v(T,I){if(T){if(typeof T=="string")return S(T,I);var k=Object.prototype.toString.call(T).slice(8,-1);if(k==="Object"&&T.constructor&&(k=T.constructor.name),k==="Map"||k==="Set")return Array.from(T);if(k==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(k))return S(T,I)}}function S(T,I){(I==null||I>T.length)&&(I=T.length);for(var k=0,O=new Array(I);k<I;k++)O[k]=T[k];return O}function w(T,I){var k=Object.keys(T);if(Object.getOwnPropertySymbols){var O=Object.getOwnPropertySymbols(T);I&&(O=O.filter(function(E){return Object.getOwnPropertyDescriptor(T,E).enumerable})),k.push.apply(k,O)}return k}function M(T){for(var I=1;I<arguments.length;I++){var k=arguments[I]!=null?arguments[I]:{};I%2?w(Object(k),!0).forEach(function(O){Se(T,O,k[O])}):Object.getOwnPropertyDescriptors?Object.defineProperties(T,Object.getOwnPropertyDescriptors(k)):w(Object(k)).forEach(function(O){Object.defineProperty(T,O,Object.getOwnPropertyDescriptor(k,O))})}return T}function _(T,I){if(!(T instanceof I))throw new TypeError("Cannot call a class as a function")}function C(T,I){for(var k=0;k<I.length;k++){var O=I[k];O.enumerable=O.enumerable||!1,O.configurable=!0,"value"in O&&(O.writable=!0),Object.defineProperty(T,ze(O.key),O)}}function A(T,I,k){return I&&C(T.prototype,I),k&&C(T,k),Object.defineProperty(T,"prototype",{writable:!1}),T}function y(T,I){if(typeof I!="function"&&I!==null)throw new TypeError("Super expression must either be null or a function");T.prototype=Object.create(I&&I.prototype,{constructor:{value:T,writable:!0,configurable:!0}}),Object.defineProperty(T,"prototype",{writable:!1}),I&&$(T,I)}function $(T,I){return $=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(O,E){return O.__proto__=E,O},$(T,I)}function X(T){var I=ue();return function(){var O=ge(T),E;if(I){var P=ge(this).constructor;E=Reflect.construct(O,arguments,P)}else E=O.apply(this,arguments);return le(this,E)}}function le(T,I){if(I&&(u(I)==="object"||typeof I=="function"))return I;if(I!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return ne(T)}function ne(T){if(T===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return T}function ue(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function ge(T){return ge=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(k){return k.__proto__||Object.getPrototypeOf(k)},ge(T)}function Se(T,I,k){return I=ze(I),I in T?Object.defineProperty(T,I,{value:k,enumerable:!0,configurable:!0,writable:!0}):T[I]=k,T}function ze(T){var I=Ct(T,"string");return u(I)==="symbol"?I:String(I)}function Ct(T,I){if(u(T)!=="object"||T===null)return T;var k=T[Symbol.toPrimitive];if(k!==void 0){var O=k.call(T,I||"default");if(u(O)!=="object")return O;throw new TypeError("@@toPrimitive must return a primitive value.")}return(I==="string"?String:Number)(T)}function q(T){var I,k,O,E=2;for(typeof Symbol<"u"&&(k=Symbol.asyncIterator,O=Symbol.iterator);E--;){if(k&&(I=T[k])!=null)return I.call(T);if(O&&(I=T[O])!=null)return new j(I.call(T));k="@@asyncIterator",O="@@iterator"}throw new TypeError("Object is not async iterable")}function j(T){function I(k){if(Object(k)!==k)return Promise.reject(new TypeError(k+" is not an object."));var O=k.done;return Promise.resolve(k.value).then(function(E){return{value:E,done:O}})}return j=function(O){this.s=O,this.n=O.next},j.prototype={s:null,n:null,next:function(){return I(this.n.apply(this.s,arguments))},return:function(O){var E=this.s.return;return E===void 0?Promise.resolve({value:O,done:!0}):I(E.apply(this.s,arguments))},throw:function(O){var E=this.s.return;return E===void 0?Promise.reject(O):I(E.apply(this.s,arguments))}},new j(T)}var oe=function(T){y(k,T);var I=X(k);function k(O,E,P){var b;if(_(this,k),b=I.call(this),b.widget=O,b.iframe=E,b.driver=P,Se(ne(b),"transport",void 0),Se(ne(b),"contentLoadedActionSent",!1),Se(ne(b),"allowedCapabilities",new Set),Se(ne(b),"allowedEvents",[]),Se(ne(b),"isStopped",!1),Se(ne(b),"turnServers",null),Se(ne(b),"contentLoadedWaitTimer",void 0),!(E!=null&&E.contentWindow))throw new Error("No iframe supplied");if(!O)throw new Error("Invalid widget");if(!P)throw new Error("Invalid driver");return b.transport=new e.PostmessageTransport(t.WidgetApiDirection.ToWidget,O.id,E.contentWindow,window),b.transport.targetOrigin=O.origin,b.transport.on("message",b.handleMessage.bind(ne(b))),E.addEventListener("load",b.onIframeLoad.bind(ne(b))),b.transport.start(),b}return A(k,[{key:"hasCapability",value:function(E){return this.allowedCapabilities.has(E)}},{key:"canUseRoomTimeline",value:function(E){return this.hasCapability("org.matrix.msc2762.timeline:".concat(l.Symbols.AnyRoom))||this.hasCapability("org.matrix.msc2762.timeline:".concat(E))}},{key:"canSendRoomEvent",value:function(E){var P=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;return this.allowedEvents.some(function(b){return b.matchesAsRoomEvent(o.EventDirection.Send,E,P)})}},{key:"canSendStateEvent",value:function(E,P){return this.allowedEvents.some(function(b){return b.matchesAsStateEvent(o.EventDirection.Send,E,P)})}},{key:"canSendToDeviceEvent",value:function(E){return this.allowedEvents.some(function(P){return P.matchesAsToDeviceEvent(o.EventDirection.Send,E)})}},{key:"canReceiveRoomEvent",value:function(E){var P=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;return this.allowedEvents.some(function(b){return b.matchesAsRoomEvent(o.EventDirection.Receive,E,P)})}},{key:"canReceiveStateEvent",value:function(E,P){return this.allowedEvents.some(function(b){return b.matchesAsStateEvent(o.EventDirection.Receive,E,P)})}},{key:"canReceiveToDeviceEvent",value:function(E){return this.allowedEvents.some(function(P){return P.matchesAsToDeviceEvent(o.EventDirection.Receive,E)})}},{key:"canReceiveRoomAccountData",value:function(E){return this.allowedEvents.some(function(P){return P.matchesAsRoomAccountData(o.EventDirection.Receive,E)})}},{key:"stop",value:function(){this.isStopped=!0,this.transport.stop()}},{key:"beginCapabilities",value:function(){var E=this;this.emit("preparing");var P;this.transport.send(i.WidgetApiToWidgetAction.Capabilities,{}).then(function(b){return P=b.capabilities,E.driver.validateCapabilities(new Set(b.capabilities))}).then(function(b){console.log("Widget ".concat(E.widget.id," is allowed capabilities:"),Array.from(b)),E.allowedCapabilities=b,E.allowedEvents=o.WidgetEventCapability.findEventCapabilities(b),E.notifyCapabilities(P),E.emit("ready")}).catch(function(b){E.emit("error:preparing",b)})}},{key:"notifyCapabilities",value:function(E){var P=this;this.transport.send(i.WidgetApiToWidgetAction.NotifyCapabilities,{requested:E,approved:Array.from(this.allowedCapabilities)}).catch(function(b){console.warn("non-fatal error notifying widget of approved capabilities:",b)}).then(function(){P.emit("capabilitiesNotified")})}},{key:"onIframeLoad",value:function(E){this.widget.waitForIframeLoad?this.beginCapabilities():(console.log("waitForIframeLoad is false: waiting for widget to send contentLoaded"),this.contentLoadedWaitTimer=setTimeout(function(){console.error("Widget specified waitForIframeLoad=false but timed out waiting for contentLoaded event!")},1e4),this.contentLoadedActionSent=!1)}},{key:"handleContentLoadedAction",value:function(E){if(this.contentLoadedWaitTimer!==void 0&&(clearTimeout(this.contentLoadedWaitTimer),this.contentLoadedWaitTimer=void 0),this.contentLoadedActionSent)throw new Error("Improper sequence: ContentLoaded Action can only be sent once after the widget loaded and should only be used if waitForIframeLoad is false (default=true)");this.widget.waitForIframeLoad?this.transport.reply(E,{error:{message:"Improper sequence: not expecting ContentLoaded event if waitForIframeLoad is true (default=true)"}}):(this.transport.reply(E,{}),this.beginCapabilities()),this.contentLoadedActionSent=!0}},{key:"replyVersions",value:function(E){this.transport.reply(E,{supported_versions:s.CurrentApiVersions})}},{key:"handleCapabilitiesRenegotiate",value:function(E){var P,b=this;this.transport.reply(E,{});var B=((P=E.data)===null||P===void 0?void 0:P.capabilities)||[],L=new Set(B.filter(function(K){return!b.hasCapability(K)}));if(L.size===0)return this.notifyCapabilities([]);this.driver.validateCapabilities(L).then(function(K){K.forEach(function(J){return b.allowedCapabilities.add(J)});var Y=o.WidgetEventCapability.findEventCapabilities(K);return Y.forEach(function(J){return b.allowedEvents.push(J)}),b.notifyCapabilities(Array.from(L))})}},{key:"handleNavigate",value:function(E){var P,b,B=this;if(!this.hasCapability(n.MatrixCapabilities.MSC2931Navigate))return this.transport.reply(E,{error:{message:"Missing capability"}});if(!((P=E.data)!==null&&P!==void 0&&P.uri)||!((b=E.data)!==null&&b!==void 0&&b.uri.toString().startsWith("https://matrix.to/#")))return this.transport.reply(E,{error:{message:"Invalid matrix.to URI"}});var L=function(Y){return console.error("[ClientWidgetApi] Failed to handle navigation: ",Y),B.transport.reply(E,{error:{message:"Error handling navigation"}})};try{this.driver.navigate(E.data.uri.toString()).catch(function(K){return L(K)}).then(function(){return B.transport.reply(E,{})})}catch(K){return L(K)}}},{key:"handleOIDC",value:function(E){var P=this,b=1,B=function(J,re){return re=re||{},b>1?P.transport.send(i.WidgetApiToWidgetAction.OpenIDCredentials,M({state:J,original_request_id:E.requestId},re)):P.transport.reply(E,M({state:J},re))},L=function(J){return console.error("[ClientWidgetApi] Failed to handle OIDC: ",J),b>1?B(a.OpenIDRequestState.Blocked):P.transport.reply(E,{error:{message:J}})},K=new c.SimpleObservable(function(Y){if(Y.state===a.OpenIDRequestState.PendingUserConfirmation&&b>1)return K.close(),L("client provided out-of-phase response to OIDC flow");if(Y.state===a.OpenIDRequestState.PendingUserConfirmation){B(Y.state),b++;return}return Y.state===a.OpenIDRequestState.Allowed&&!Y.token?L("client provided invalid OIDC token for an allowed request"):(Y.state===a.OpenIDRequestState.Blocked&&(Y.token=void 0),K.close(),B(Y.state,Y.token))});this.driver.askOpenID(K)}},{key:"handleReadRoomAccountData",value:function(E){var P=this,b=Promise.resolve([]);return b=this.driver.readRoomAccountData(E.data.type),this.canReceiveRoomAccountData(E.data.type)?b.then(function(B){P.transport.reply(E,{events:B})}):this.transport.reply(E,{error:{message:"Cannot read room account data of this type"}})}},{key:"handleReadEvents",value:function(E){var P=this;if(!E.data.type)return this.transport.reply(E,{error:{message:"Invalid request - missing event type"}});if(E.data.limit!==void 0&&(!E.data.limit||E.data.limit<0))return this.transport.reply(E,{error:{message:"Invalid request - limit out of range"}});var b=null;if(E.data.room_ids){b=E.data.room_ids,Array.isArray(b)||(b=[b]);var B=m(b),L;try{for(B.s();!(L=B.n()).done;){var K=L.value;if(!this.canUseRoomTimeline(K))return this.transport.reply(E,{error:{message:"Unable to access room timeline: ".concat(K)}})}}catch(ve){B.e(ve)}finally{B.f()}}var Y=E.data.limit||0,J=E.data.since,re=Promise.resolve([]);if(E.data.state_key!==void 0){var Me=E.data.state_key===!0?void 0:E.data.state_key.toString();if(!this.canReceiveStateEvent(E.data.type,Me??null))return this.transport.reply(E,{error:{message:"Cannot read state events of this type"}});re=this.driver.readStateEvents(E.data.type,Me,Y,b)}else{if(!this.canReceiveRoomEvent(E.data.type,E.data.msgtype))return this.transport.reply(E,{error:{message:"Cannot read room events of this type"}});re=this.driver.readRoomEvents(E.data.type,E.data.msgtype,Y,b,J)}return re.then(function(ve){return P.transport.reply(E,{events:ve})})}},{key:"handleSendEvent",value:function(E){var P=this;if(!E.data.type)return this.transport.reply(E,{error:{message:"Invalid request - missing event type"}});if(E.data.room_id&&!this.canUseRoomTimeline(E.data.room_id))return this.transport.reply(E,{error:{message:"Unable to access room timeline: ".concat(E.data.room_id)}});var b=E.data.state_key!==null&&E.data.state_key!==void 0,B;if(b){if(!this.canSendStateEvent(E.data.type,E.data.state_key))return this.transport.reply(E,{error:{message:"Cannot send state events of this type"}});B=this.driver.sendEvent(E.data.type,E.data.content||{},E.data.state_key,E.data.room_id)}else{var L=E.data.content||{},K=L.msgtype;if(!this.canSendRoomEvent(E.data.type,K))return this.transport.reply(E,{error:{message:"Cannot send room events of this type"}});B=this.driver.sendEvent(E.data.type,L,null,E.data.room_id)}B.then(function(Y){return P.transport.reply(E,{room_id:Y.roomId,event_id:Y.eventId})}).catch(function(Y){return console.error("error sending event: ",Y),P.transport.reply(E,{error:{message:"Error sending event"}})})}},{key:"handleSendToDevice",value:function(){var O=g(h().mark(function P(b){return h().wrap(function(L){for(;;)switch(L.prev=L.next){case 0:if(b.data.type){L.next=5;break}return L.next=3,this.transport.reply(b,{error:{message:"Invalid request - missing event type"}});case 3:L.next=32;break;case 5:if(b.data.messages){L.next=10;break}return L.next=8,this.transport.reply(b,{error:{message:"Invalid request - missing event contents"}});case 8:L.next=32;break;case 10:if(typeof b.data.encrypted=="boolean"){L.next=15;break}return L.next=13,this.transport.reply(b,{error:{message:"Invalid request - missing encryption flag"}});case 13:L.next=32;break;case 15:if(this.canSendToDeviceEvent(b.data.type)){L.next=20;break}return L.next=18,this.transport.reply(b,{error:{message:"Cannot send to-device events of this type"}});case 18:L.next=32;break;case 20:return L.prev=20,L.next=23,this.driver.sendToDevice(b.data.type,b.data.encrypted,b.data.messages);case 23:return L.next=25,this.transport.reply(b,{});case 25:L.next=32;break;case 27:return L.prev=27,L.t0=L.catch(20),console.error("error sending to-device event",L.t0),L.next=32,this.transport.reply(b,{error:{message:"Error sending event"}});case 32:case"end":return L.stop()}},P,this,[[20,27]])}));function E(P){return O.apply(this,arguments)}return E}()},{key:"pollTurnServers",value:function(){var O=g(h().mark(function P(b,B){var L,K,Y,J,re,Me;return h().wrap(function(p){for(;;)switch(p.prev=p.next){case 0:return p.prev=0,p.next=3,this.transport.send(i.WidgetApiToWidgetAction.UpdateTurnServers,B);case 3:L=!1,K=!1,p.prev=5,J=q(b);case 7:return p.next=9,J.next();case 9:if(!(L=!(re=p.sent).done)){p.next=16;break}return Me=re.value,p.next=13,this.transport.send(i.WidgetApiToWidgetAction.UpdateTurnServers,Me);case 13:L=!1,p.next=7;break;case 16:p.next=22;break;case 18:p.prev=18,p.t0=p.catch(5),K=!0,Y=p.t0;case 22:if(p.prev=22,p.prev=23,!(L&&J.return!=null)){p.next=27;break}return p.next=27,J.return();case 27:if(p.prev=27,!K){p.next=30;break}throw Y;case 30:return p.finish(27);case 31:return p.finish(22);case 32:p.next=37;break;case 34:p.prev=34,p.t1=p.catch(0),console.error("error polling for TURN servers",p.t1);case 37:case"end":return p.stop()}},P,this,[[0,34],[5,18,22,32],[23,,27,31]])}));function E(P,b){return O.apply(this,arguments)}return E}()},{key:"handleWatchTurnServers",value:function(){var O=g(h().mark(function P(b){var B,L,K,Y;return h().wrap(function(re){for(;;)switch(re.prev=re.next){case 0:if(this.hasCapability(n.MatrixCapabilities.MSC3846TurnServers)){re.next=5;break}return re.next=3,this.transport.reply(b,{error:{message:"Missing capability"}});case 3:re.next=30;break;case 5:if(!this.turnServers){re.next=10;break}return re.next=8,this.transport.reply(b,{});case 8:re.next=30;break;case 10:return re.prev=10,B=this.driver.getTurnServers(),re.next=14,B.next();case 14:if(L=re.sent,K=L.done,Y=L.value,!K){re.next=19;break}throw new Error("Client refuses to provide any TURN servers");case 19:return re.next=21,this.transport.reply(b,{});case 21:this.pollTurnServers(B,Y),this.turnServers=B,re.next=30;break;case 25:return re.prev=25,re.t0=re.catch(10),console.error("error getting first TURN server results",re.t0),re.next=30,this.transport.reply(b,{error:{message:"TURN servers not available"}});case 30:case"end":return re.stop()}},P,this,[[10,25]])}));function E(P){return O.apply(this,arguments)}return E}()},{key:"handleUnwatchTurnServers",value:function(){var O=g(h().mark(function P(b){return h().wrap(function(L){for(;;)switch(L.prev=L.next){case 0:if(this.hasCapability(n.MatrixCapabilities.MSC3846TurnServers)){L.next=5;break}return L.next=3,this.transport.reply(b,{error:{message:"Missing capability"}});case 3:L.next=15;break;case 5:if(this.turnServers){L.next=10;break}return L.next=8,this.transport.reply(b,{});case 8:L.next=15;break;case 10:return L.next=12,this.turnServers.return(void 0);case 12:return this.turnServers=null,L.next=15,this.transport.reply(b,{});case 15:case"end":return L.stop()}},P,this)}));function E(P){return O.apply(this,arguments)}return E}()},{key:"handleReadRelations",value:function(){var O=g(h().mark(function P(b){var B=this,L,K;return h().wrap(function(J){for(;;)switch(J.prev=J.next){case 0:if(b.data.event_id){J.next=2;break}return J.abrupt("return",this.transport.reply(b,{error:{message:"Invalid request - missing event ID"}}));case 2:if(!(b.data.limit!==void 0&&b.data.limit<0)){J.next=4;break}return J.abrupt("return",this.transport.reply(b,{error:{message:"Invalid request - limit out of range"}}));case 4:if(!(b.data.room_id!==void 0&&!this.canUseRoomTimeline(b.data.room_id))){J.next=6;break}return J.abrupt("return",this.transport.reply(b,{error:{message:"Unable to access room timeline: ".concat(b.data.room_id)}}));case 6:return J.prev=6,J.next=9,this.driver.readEventRelations(b.data.event_id,b.data.room_id,b.data.rel_type,b.data.event_type,b.data.from,b.data.to,b.data.limit,b.data.direction);case 9:return L=J.sent,K=L.chunk.filter(function(re){return re.state_key!==void 0?B.canReceiveStateEvent(re.type,re.state_key):B.canReceiveRoomEvent(re.type,re.content.msgtype)}),J.abrupt("return",this.transport.reply(b,{chunk:K,prev_batch:L.prevBatch,next_batch:L.nextBatch}));case 14:return J.prev=14,J.t0=J.catch(6),console.error("error getting the relations",J.t0),J.next=19,this.transport.reply(b,{error:{message:"Unexpected error while reading relations"}});case 19:case"end":return J.stop()}},P,this,[[6,14]])}));function E(P){return O.apply(this,arguments)}return E}()},{key:"handleUserDirectorySearch",value:function(){var O=g(h().mark(function P(b){var B;return h().wrap(function(K){for(;;)switch(K.prev=K.next){case 0:if(this.hasCapability(n.MatrixCapabilities.MSC3973UserDirectorySearch)){K.next=2;break}return K.abrupt("return",this.transport.reply(b,{error:{message:"Missing capability"}}));case 2:if(typeof b.data.search_term=="string"){K.next=4;break}return K.abrupt("return",this.transport.reply(b,{error:{message:"Invalid request - missing search term"}}));case 4:if(!(b.data.limit!==void 0&&b.data.limit<0)){K.next=6;break}return K.abrupt("return",this.transport.reply(b,{error:{message:"Invalid request - limit out of range"}}));case 6:return K.prev=6,K.next=9,this.driver.searchUserDirectory(b.data.search_term,b.data.limit);case 9:return B=K.sent,K.abrupt("return",this.transport.reply(b,{limited:B.limited,results:B.results.map(function(Y){return{user_id:Y.userId,display_name:Y.displayName,avatar_url:Y.avatarUrl}})}));case 13:return K.prev=13,K.t0=K.catch(6),console.error("error searching in the user directory",K.t0),K.next=18,this.transport.reply(b,{error:{message:"Unexpected error while searching in the user directory"}});case 18:case"end":return K.stop()}},P,this,[[6,13]])}));function E(P){return O.apply(this,arguments)}return E}()},{key:"handleGetMediaConfig",value:function(){var O=g(h().mark(function P(b){var B;return h().wrap(function(K){for(;;)switch(K.prev=K.next){case 0:if(this.hasCapability(n.MatrixCapabilities.MSC4039UploadFile)){K.next=2;break}return K.abrupt("return",this.transport.reply(b,{error:{message:"Missing capability"}}));case 2:return K.prev=2,K.next=5,this.driver.getMediaConfig();case 5:return B=K.sent,K.abrupt("return",this.transport.reply(b,B));case 9:return K.prev=9,K.t0=K.catch(2),console.error("error while getting the media configuration",K.t0),K.next=14,this.transport.reply(b,{error:{message:"Unexpected error while getting the media configuration"}});case 14:case"end":return K.stop()}},P,this,[[2,9]])}));function E(P){return O.apply(this,arguments)}return E}()},{key:"handleUploadFile",value:function(){var O=g(h().mark(function P(b){var B;return h().wrap(function(K){for(;;)switch(K.prev=K.next){case 0:if(this.hasCapability(n.MatrixCapabilities.MSC4039UploadFile)){K.next=2;break}return K.abrupt("return",this.transport.reply(b,{error:{message:"Missing capability"}}));case 2:return K.prev=2,K.next=5,this.driver.uploadFile(b.data.file);case 5:return B=K.sent,K.abrupt("return",this.transport.reply(b,{content_uri:B.contentUri}));case 9:return K.prev=9,K.t0=K.catch(2),console.error("error while uploading a file",K.t0),K.next=14,this.transport.reply(b,{error:{message:"Unexpected error while uploading a file"}});case 14:case"end":return K.stop()}},P,this,[[2,9]])}));function E(P){return O.apply(this,arguments)}return E}()},{key:"handleMessage",value:function(E){if(!this.isStopped){var P=new CustomEvent("action:".concat(E.detail.action),{detail:E.detail,cancelable:!0});if(this.emit("action:".concat(E.detail.action),P),!P.defaultPrevented)switch(E.detail.action){case i.WidgetApiFromWidgetAction.ContentLoaded:return this.handleContentLoadedAction(E.detail);case i.WidgetApiFromWidgetAction.SupportedApiVersions:return this.replyVersions(E.detail);case i.WidgetApiFromWidgetAction.SendEvent:return this.handleSendEvent(E.detail);case i.WidgetApiFromWidgetAction.SendToDevice:return this.handleSendToDevice(E.detail);case i.WidgetApiFromWidgetAction.GetOpenIDCredentials:return this.handleOIDC(E.detail);case i.WidgetApiFromWidgetAction.MSC2931Navigate:return this.handleNavigate(E.detail);case i.WidgetApiFromWidgetAction.MSC2974RenegotiateCapabilities:return this.handleCapabilitiesRenegotiate(E.detail);case i.WidgetApiFromWidgetAction.MSC2876ReadEvents:return this.handleReadEvents(E.detail);case i.WidgetApiFromWidgetAction.WatchTurnServers:return this.handleWatchTurnServers(E.detail);case i.WidgetApiFromWidgetAction.UnwatchTurnServers:return this.handleUnwatchTurnServers(E.detail);case i.WidgetApiFromWidgetAction.MSC3869ReadRelations:return this.handleReadRelations(E.detail);case i.WidgetApiFromWidgetAction.MSC3973UserDirectorySearch:return this.handleUserDirectorySearch(E.detail);case i.WidgetApiFromWidgetAction.BeeperReadRoomAccountData:return this.handleReadRoomAccountData(E.detail);case i.WidgetApiFromWidgetAction.MSC4039GetMediaConfigAction:return this.handleGetMediaConfig(E.detail);case i.WidgetApiFromWidgetAction.MSC4039UploadFileAction:return this.handleUploadFile(E.detail);default:return this.transport.reply(E.detail,{error:{message:"Unknown or unsupported action: "+E.detail.action}})}}}},{key:"takeScreenshot",value:function(){return this.transport.send(i.WidgetApiToWidgetAction.TakeScreenshot,{})}},{key:"updateVisibility",value:function(E){return this.transport.send(i.WidgetApiToWidgetAction.UpdateVisibility,{visible:E})}},{key:"sendWidgetConfig",value:function(E){return this.transport.send(i.WidgetApiToWidgetAction.WidgetConfig,E).then()}},{key:"notifyModalWidgetButtonClicked",value:function(E){return this.transport.send(i.WidgetApiToWidgetAction.ButtonClicked,{id:E}).then()}},{key:"notifyModalWidgetClose",value:function(E){return this.transport.send(i.WidgetApiToWidgetAction.CloseModalWidget,E).then()}},{key:"feedEvent",value:function(){var O=g(h().mark(function P(b,B){var L;return h().wrap(function(Y){for(;;)switch(Y.prev=Y.next){case 0:if(!(b.room_id!==B&&!this.canUseRoomTimeline(b.room_id))){Y.next=2;break}return Y.abrupt("return");case 2:if(!(b.state_key!==void 0&&b.state_key!==null)){Y.next=7;break}if(this.canReceiveStateEvent(b.type,b.state_key)){Y.next=5;break}return Y.abrupt("return");case 5:Y.next=9;break;case 7:if(this.canReceiveRoomEvent(b.type,(L=b.content)===null||L===void 0?void 0:L.msgtype)){Y.next=9;break}return Y.abrupt("return");case 9:return Y.next=11,this.transport.send(i.WidgetApiToWidgetAction.SendEvent,b);case 11:case"end":return Y.stop()}},P,this)}));function E(P,b){return O.apply(this,arguments)}return E}()},{key:"feedToDevice",value:function(){var O=g(h().mark(function P(b,B){return h().wrap(function(K){for(;;)switch(K.prev=K.next){case 0:if(!this.canReceiveToDeviceEvent(b.type)){K.next=3;break}return K.next=3,this.transport.send(i.WidgetApiToWidgetAction.SendToDevice,M(M({},b),{},{encrypted:B}));case 3:case"end":return K.stop()}},P,this)}));function E(P,b){return O.apply(this,arguments)}return E}()}]),k}(r.EventEmitter);return lr.ClientWidgetApi=oe,lr}var Yu={};Object.defineProperty(Yu,"__esModule",{value:!0});var Qu={};Object.defineProperty(Qu,"__esModule",{value:!0});var Xu={};Object.defineProperty(Xu,"__esModule",{value:!0});var Zu={};Object.defineProperty(Zu,"__esModule",{value:!0});var eh={};Object.defineProperty(eh,"__esModule",{value:!0});var lc={};Object.defineProperty(lc,"__esModule",{value:!0});lc.isErrorResponse=cE;function cE(r){if("error"in r){var e=r;return!!e.error.message}return!1}var th={};Object.defineProperty(th,"__esModule",{value:!0});var ih={};Object.defineProperty(ih,"__esModule",{value:!0});var nh={};Object.defineProperty(nh,"__esModule",{value:!0});var rh={};Object.defineProperty(rh,"__esModule",{value:!0});var sh={};Object.defineProperty(sh,"__esModule",{value:!0});var oh={};Object.defineProperty(oh,"__esModule",{value:!0});var ah={};Object.defineProperty(ah,"__esModule",{value:!0});var ch={};Object.defineProperty(ch,"__esModule",{value:!0});var lh={};Object.defineProperty(lh,"__esModule",{value:!0});var dh={};Object.defineProperty(dh,"__esModule",{value:!0});var ro={};Object.defineProperty(ro,"__esModule",{value:!0});ro.WidgetKind=void 0;var lE=function(r){return r.Room="room",r.Account="account",r.Modal="modal",r}({});ro.WidgetKind=lE;var so={};Object.defineProperty(so,"__esModule",{value:!0});so.ModalButtonKind=void 0;var dE=function(r){return r.Primary="m.primary",r.Secondary="m.secondary",r.Warning="m.warning",r.Danger="m.danger",r.Link="m.link",r}({});so.ModalButtonKind=dE;var uh={};Object.defineProperty(uh,"__esModule",{value:!0});var hh={};Object.defineProperty(hh,"__esModule",{value:!0});var fh={};Object.defineProperty(fh,"__esModule",{value:!0});var gh={};Object.defineProperty(gh,"__esModule",{value:!0});var ph={};Object.defineProperty(ph,"__esModule",{value:!0});var mh={};Object.defineProperty(mh,"__esModule",{value:!0});var vh={};Object.defineProperty(vh,"__esModule",{value:!0});var yh={};Object.defineProperty(yh,"__esModule",{value:!0});var Sh={};Object.defineProperty(Sh,"__esModule",{value:!0});var Eh={};Object.defineProperty(Eh,"__esModule",{value:!0});var bh={};Object.defineProperty(bh,"__esModule",{value:!0});var wh={};Object.defineProperty(wh,"__esModule",{value:!0});var oo={};Object.defineProperty(oo,"__esModule",{value:!0});oo.isValidUrl=uE;function uE(r){if(!r)return!1;try{var e=new URL(r);return!(e.protocol!=="http"&&e.protocol!=="https")}catch(t){if(t instanceof TypeError)return!1;throw t}}var ao={};Object.defineProperty(ao,"__esModule",{value:!0});ao.assertPresent=hE;function hE(r,e){if(!r[e])throw new Error("".concat(String(e)," is required"))}var dr={},cd;function _h(){if(cd)return dr;cd=1,Object.defineProperty(dr,"__esModule",{value:!0}),dr.Widget=void 0;var r=ao,e=lo();function t(l){"@babel/helpers - typeof";return t=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(u){return typeof u}:function(u){return u&&typeof Symbol=="function"&&u.constructor===Symbol&&u!==Symbol.prototype?"symbol":typeof u},t(l)}function i(l,u){if(!(l instanceof u))throw new TypeError("Cannot call a class as a function")}function n(l,u){for(var h=0;h<u.length;h++){var f=u[h];f.enumerable=f.enumerable||!1,f.configurable=!0,"value"in f&&(f.writable=!0),Object.defineProperty(l,o(f.key),f)}}function s(l,u,h){return u&&n(l.prototype,u),h&&n(l,h),Object.defineProperty(l,"prototype",{writable:!1}),l}function o(l){var u=a(l,"string");return t(u)==="symbol"?u:String(u)}function a(l,u){if(t(l)!=="object"||l===null)return l;var h=l[Symbol.toPrimitive];if(h!==void 0){var f=h.call(l,u||"default");if(t(f)!=="object")return f;throw new TypeError("@@toPrimitive must return a primitive value.")}return(u==="string"?String:Number)(l)}var c=function(){function l(u){if(i(this,l),this.definition=u,!this.definition)throw new Error("Definition is required");(0,r.assertPresent)(u,"id"),(0,r.assertPresent)(u,"creatorUserId"),(0,r.assertPresent)(u,"type"),(0,r.assertPresent)(u,"url")}return s(l,[{key:"creatorUserId",get:function(){return this.definition.creatorUserId}},{key:"type",get:function(){return this.definition.type}},{key:"id",get:function(){return this.definition.id}},{key:"name",get:function(){return this.definition.name||null}},{key:"title",get:function(){return this.rawData.title||null}},{key:"templateUrl",get:function(){return this.definition.url}},{key:"origin",get:function(){return new URL(this.templateUrl).origin}},{key:"waitForIframeLoad",get:function(){return this.definition.waitForIframeLoad===!1?!1:(this.definition.waitForIframeLoad===!0,!0)}},{key:"rawData",get:function(){return this.definition.data||{}}},{key:"getCompleteUrl",value:function(h){return(0,e.runTemplate)(this.templateUrl,this.definition,h)}}]),l}();return dr.Widget=c,dr}var ur={},ld;function fE(){if(ld)return ur;ld=1,Object.defineProperty(ur,"__esModule",{value:!0}),ur.WidgetParser=void 0;var r=_h(),e=oo;function t(f){"@babel/helpers - typeof";return t=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(g){return typeof g}:function(g){return g&&typeof Symbol=="function"&&g.constructor===Symbol&&g!==Symbol.prototype?"symbol":typeof g},t(f)}function i(f,g){var m=typeof Symbol<"u"&&f[Symbol.iterator]||f["@@iterator"];if(!m){if(Array.isArray(f)||(m=n(f))||g&&f&&typeof f.length=="number"){m&&(f=m);var v=0,S=function(){};return{s:S,n:function(){return v>=f.length?{done:!0}:{done:!1,value:f[v++]}},e:function(A){throw A},f:S}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var w=!0,M=!1,_;return{s:function(){m=m.call(f)},n:function(){var A=m.next();return w=A.done,A},e:function(A){M=!0,_=A},f:function(){try{!w&&m.return!=null&&m.return()}finally{if(M)throw _}}}}function n(f,g){if(f){if(typeof f=="string")return s(f,g);var m=Object.prototype.toString.call(f).slice(8,-1);if(m==="Object"&&f.constructor&&(m=f.constructor.name),m==="Map"||m==="Set")return Array.from(f);if(m==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(m))return s(f,g)}}function s(f,g){(g==null||g>f.length)&&(g=f.length);for(var m=0,v=new Array(g);m<g;m++)v[m]=f[m];return v}function o(f,g){if(!(f instanceof g))throw new TypeError("Cannot call a class as a function")}function a(f,g){for(var m=0;m<g.length;m++){var v=g[m];v.enumerable=v.enumerable||!1,v.configurable=!0,"value"in v&&(v.writable=!0),Object.defineProperty(f,l(v.key),v)}}function c(f,g,m){return g&&a(f.prototype,g),m&&a(f,m),Object.defineProperty(f,"prototype",{writable:!1}),f}function l(f){var g=u(f,"string");return t(g)==="symbol"?g:String(g)}function u(f,g){if(t(f)!=="object"||f===null)return f;var m=f[Symbol.toPrimitive];if(m!==void 0){var v=m.call(f,g||"default");if(t(v)!=="object")return v;throw new TypeError("@@toPrimitive must return a primitive value.")}return(g==="string"?String:Number)(f)}var h=function(){function f(){o(this,f)}return c(f,null,[{key:"parseAccountData",value:function(m){if(!m)return[];for(var v=[],S=0,w=Object.keys(m);S<w.length;S++){var M=w[S],_=m[M];if(_&&!(_.type!=="m.widget"&&_.type!=="im.vector.modular.widgets")&&_.sender){var C=_.state_key||_.id;if(C===M){var A={content:_.content,sender:_.sender,type:"m.widget",state_key:M,event_id:"$example",room_id:"!example",origin_server_ts:1},y=f.parseRoomWidget(A);y&&v.push(y)}}}return v}},{key:"parseWidgetsFromRoomState",value:function(m){if(!m)return[];var v=[],S=i(m),w;try{for(S.s();!(w=S.n()).done;){var M=w.value,_=f.parseRoomWidget(M);_&&v.push(_)}}catch(C){S.e(C)}finally{S.f()}return v}},{key:"parseRoomWidget",value:function(m){if(!m||m.type!=="m.widget"&&m.type!=="im.vector.modular.widgets")return null;var v=m.content||{},S={id:m.state_key,creatorUserId:v.creatorUserId||m.sender,name:v.name,type:v.type,url:v.url,waitForIframeLoad:v.waitForIframeLoad,data:v.data};return f.processEstimatedWidget(S)}},{key:"processEstimatedWidget",value:function(m){return!m.id||!m.creatorUserId||!m.type||!(0,e.isValidUrl)(m.url)?null:new r.Widget(m)}}]),f}();return ur.WidgetParser=h,ur}var co={};Object.defineProperty(co,"__esModule",{value:!0});co.runTemplate=gE;co.toString=Ih;function gE(r,e,t){for(var i=Object.assign({},e.data,{matrix_room_id:t.widgetRoomId||"",matrix_user_id:t.currentUserId,matrix_display_name:t.userDisplayName||t.currentUserId,matrix_avatar_url:t.userHttpAvatarUrl||"",matrix_widget_id:e.id,"org.matrix.msc2873.client_id":t.clientId||"","org.matrix.msc2873.client_theme":t.clientTheme||"","org.matrix.msc2873.client_language":t.clientLanguage||"","org.matrix.msc3819.matrix_device_id":t.deviceId||"","org.matrix.msc4039.matrix_base_url":t.baseUrl||""}),n=r,s=0,o=Object.keys(i);s<o.length;s++){var a=o[s],c="$".concat(a).replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),l=new RegExp(c,"g");n=n.replace(l,encodeURIComponent(Ih(i[a])))}return n}function Ih(r){return r==null?"".concat(r):String(r)}var hr={},dd;function pE(){if(dd)return hr;dd=1,Object.defineProperty(hr,"__esModule",{value:!0}),hr.WidgetDriver=void 0;var r=lo();function e(c){"@babel/helpers - typeof";return e=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(l){return typeof l}:function(l){return l&&typeof Symbol=="function"&&l.constructor===Symbol&&l!==Symbol.prototype?"symbol":typeof l},e(c)}function t(c,l){if(!(c instanceof l))throw new TypeError("Cannot call a class as a function")}function i(c,l){for(var u=0;u<l.length;u++){var h=l[u];h.enumerable=h.enumerable||!1,h.configurable=!0,"value"in h&&(h.writable=!0),Object.defineProperty(c,s(h.key),h)}}function n(c,l,u){return l&&i(c.prototype,l),u&&i(c,u),Object.defineProperty(c,"prototype",{writable:!1}),c}function s(c){var l=o(c,"string");return e(l)==="symbol"?l:String(l)}function o(c,l){if(e(c)!=="object"||c===null)return c;var u=c[Symbol.toPrimitive];if(u!==void 0){var h=u.call(c,l||"default");if(e(h)!=="object")return h;throw new TypeError("@@toPrimitive must return a primitive value.")}return(l==="string"?String:Number)(c)}var a=function(){function c(){t(this,c)}return n(c,[{key:"validateCapabilities",value:function(u){return Promise.resolve(new Set)}},{key:"sendEvent",value:function(u,h){return Promise.reject(new Error("Failed to override function"))}},{key:"sendToDevice",value:function(u,h,f){return Promise.reject(new Error("Failed to override function"))}},{key:"readRoomAccountData",value:function(u){return Promise.resolve([])}},{key:"readRoomEvents",value:function(u,h,f){return Promise.resolve([])}},{key:"readStateEvents",value:function(u,h,f){return Promise.resolve([])}},{key:"readEventRelations",value:function(u,h,f,g,m,v,S,w){return Promise.resolve({chunk:[]})}},{key:"askOpenID",value:function(u){u.update({state:r.OpenIDRequestState.Blocked})}},{key:"navigate",value:function(u){throw new Error("Navigation is not implemented")}},{key:"getTurnServers",value:function(){throw new Error("TURN server support is not implemented")}},{key:"searchUserDirectory",value:function(u,h){return Promise.resolve({limited:!1,results:[]})}},{key:"getMediaConfig",value:function(){throw new Error("Get media config is not implemented")}},{key:"uploadFile",value:function(u){throw new Error("Upload file is not implemented")}}]),c}();return hr.WidgetDriver=a,hr}var ud;function lo(){return ud||(ud=1,function(r){Object.defineProperty(r,"__esModule",{value:!0});var e=JS();Object.keys(e).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===e[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return e[p]}})});var t=aE();Object.keys(t).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===t[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return t[p]}})});var i=Hn;Object.keys(i).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===i[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return i[p]}})});var n=Yu;Object.keys(n).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===n[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return n[p]}})});var s=ac();Object.keys(s).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===s[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return s[p]}})});var o=Qu;Object.keys(o).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===o[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return o[p]}})});var a=Xu;Object.keys(a).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===a[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return a[p]}})});var c=Zu;Object.keys(c).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===c[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return c[p]}})});var l=eh;Object.keys(l).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===l[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return l[p]}})});var u=Gr;Object.keys(u).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===u[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return u[p]}})});var h=lc;Object.keys(h).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===h[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return h[p]}})});var f=th;Object.keys(f).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===f[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return f[p]}})});var g=ih;Object.keys(g).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===g[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return g[p]}})});var m=Pi;Object.keys(m).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===m[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return m[p]}})});var v=an;Object.keys(v).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===v[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return v[p]}})});var S=Wt;Object.keys(S).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===S[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return S[p]}})});var w=Rt;Object.keys(w).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===w[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return w[p]}})});var M=nh;Object.keys(M).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===M[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return M[p]}})});var _=rh;Object.keys(_).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===_[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return _[p]}})});var C=sh;Object.keys(C).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===C[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return C[p]}})});var A=oh;Object.keys(A).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===A[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return A[p]}})});var y=ah;Object.keys(y).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===y[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return y[p]}})});var $=ch;Object.keys($).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===$[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return $[p]}})});var X=lh;Object.keys(X).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===X[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return X[p]}})});var le=Wn;Object.keys(le).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===le[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return le[p]}})});var ne=dh;Object.keys(ne).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===ne[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return ne[p]}})});var ue=ro;Object.keys(ue).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===ue[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return ue[p]}})});var ge=so;Object.keys(ge).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===ge[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return ge[p]}})});var Se=Wr;Object.keys(Se).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===Se[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return Se[p]}})});var ze=uh;Object.keys(ze).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===ze[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return ze[p]}})});var Ct=hh;Object.keys(Ct).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===Ct[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return Ct[p]}})});var q=fh;Object.keys(q).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===q[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return q[p]}})});var j=gh;Object.keys(j).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===j[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return j[p]}})});var oe=ph;Object.keys(oe).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===oe[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return oe[p]}})});var T=mh;Object.keys(T).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===T[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return T[p]}})});var I=vh;Object.keys(I).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===I[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return I[p]}})});var k=yh;Object.keys(k).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===k[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return k[p]}})});var O=Sh;Object.keys(O).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===O[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return O[p]}})});var E=Eh;Object.keys(E).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===E[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return E[p]}})});var P=bh;Object.keys(P).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===P[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return P[p]}})});var b=wh;Object.keys(b).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===b[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return b[p]}})});var B=Ht;Object.keys(B).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===B[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return B[p]}})});var L=oo;Object.keys(L).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===L[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return L[p]}})});var K=ao;Object.keys(K).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===K[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return K[p]}})});var Y=_h();Object.keys(Y).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===Y[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return Y[p]}})});var J=fE();Object.keys(J).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===J[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return J[p]}})});var re=co;Object.keys(re).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===re[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return re[p]}})});var Me=Hr;Object.keys(Me).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===Me[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return Me[p]}})});var ve=pE();Object.keys(ve).forEach(function(p){p==="default"||p==="__esModule"||p in r&&r[p]===ve[p]||Object.defineProperty(r,p,{enumerable:!0,get:function(){return ve[p]}})})}(Ko)),Ko}var Hi=lo();class mE extends Pr{constructor(e,t,i,n,s){var o,a,c,l,u,h,f,g,m,v;super(n),this.widgetApi=e,this.capabilities=t,this.roomId=i,this.syncState=null,this.onEvent=async S=>{if(S.preventDefault(),S.detail.data.room_id===this.roomId){const w=new it(S.detail.data);await this.syncApi.injectRoomEvents(this.room,[],[w]),this.emit(ie.Event,w),this.setSyncState(st.Syncing),d.info(`Received event ${w.getId()} ${w.getType()} ${w.getStateKey()}`)}else{const{event_id:w,room_id:M}=S.detail.data;d.info(`Received event ${w} for a different room ${M}; discarding`)}await this.ack(S)},this.onToDevice=async S=>{S.preventDefault();const w=new it({type:S.detail.data.type,sender:S.detail.data.sender,content:S.detail.data.content});S.detail.data.encrypted&&w.makeEncrypted(R.RoomMessageEncrypted,{},"",""),this.emit(ie.ToDeviceEvent,w),this.setSyncState(st.Syncing),await this.ack(S)},this.widgetApiReady=new Promise(S=>this.widgetApi.once("ready",S)),((o=t.sendEvent)!=null&&o.length||(a=t.receiveEvent)!=null&&a.length||t.sendMessage===!0||Array.isArray(t.sendMessage)&&t.sendMessage.length||t.receiveMessage===!0||Array.isArray(t.receiveMessage)&&t.receiveMessage.length||(c=t.sendState)!=null&&c.length||(l=t.receiveState)!=null&&l.length)&&e.requestCapabilityForRoomTimeline(i),(u=t.sendEvent)==null||u.forEach(S=>e.requestCapabilityToSendEvent(S)),(h=t.receiveEvent)==null||h.forEach(S=>e.requestCapabilityToReceiveEvent(S)),t.sendMessage===!0?e.requestCapabilityToSendMessage():Array.isArray(t.sendMessage)&&t.sendMessage.forEach(S=>e.requestCapabilityToSendMessage(S)),t.receiveMessage===!0?e.requestCapabilityToReceiveMessage():Array.isArray(t.receiveMessage)&&t.receiveMessage.forEach(S=>e.requestCapabilityToReceiveMessage(S)),(f=t.sendState)==null||f.forEach(({eventType:S,stateKey:w})=>e.requestCapabilityToSendState(S,w)),(g=t.receiveState)==null||g.forEach(({eventType:S,stateKey:w})=>e.requestCapabilityToReceiveState(S,w)),(m=t.sendToDevice)==null||m.forEach(S=>e.requestCapabilityToSendToDevice(S)),(v=t.receiveToDevice)==null||v.forEach(S=>e.requestCapabilityToReceiveToDevice(S)),t.turnServers&&e.requestCapability(Hi.MatrixCapabilities.MSC3846TurnServers),e.on(`action:${Hi.WidgetApiToWidgetAction.SendEvent}`,this.onEvent),e.on(`action:${Hi.WidgetApiToWidgetAction.SendToDevice}`,this.onToDevice),e.start(),s&&e.sendContentLoaded()}async startClient(e={}){var i;this.lifecycle=new AbortController;const t=this.getUserId();t&&this.store.storeUser(new ki(t)),e.slidingSync?this.syncApi=new Gu(e.slidingSync,this,e,this.buildSyncApiOptions()):this.syncApi=new pr(this,e,this.buildSyncApiOptions()),this.room=this.syncApi.createRoom(this.roomId),this.store.storeRoom(this.room),await this.widgetApiReady,await Promise.all(((i=this.capabilities.receiveState)==null?void 0:i.map(async({eventType:n,stateKey:s})=>{const a=(await this.widgetApi.readStateEvents(n,void 0,s,[this.roomId])).map(c=>new it(c));await this.syncApi.injectRoomEvents(this.room,[],a),a.forEach(c=>{this.emit(ie.Event,c),d.info(`Backfilled event ${c.getId()} ${c.getType()} ${c.getStateKey()}`)})}))??[]),this.setSyncState(st.Syncing),d.info("Finished backfilling events"),this.matrixRTC.start(),this.capabilities.turnServers&&this.watchTurnServers()}stopClient(){this.widgetApi.off(`action:${Hi.WidgetApiToWidgetAction.SendEvent}`,this.onEvent),this.widgetApi.off(`action:${Hi.WidgetApiToWidgetAction.SendToDevice}`,this.onToDevice),super.stopClient(),this.lifecycle.abort()}async joinRoom(e){if(e===this.roomId)return this.room;throw new Error(`Unknown room: ${e}`)}async encryptAndSendEvent(e,t){let i;try{i=await this.widgetApi.sendRoomEvent(t.getType(),t.getContent(),e.roomId)}catch(n){throw this.updatePendingEventStatus(e,t,se.NOT_SENT),n}return e.updatePendingEvent(t,se.SENT,i.event_id),{event_id:i.event_id}}async sendStateEvent(e,t,i,n=""){return await this.widgetApi.sendStateEvent(t,n,i,e)}async sendToDevice(e,t){return await this.widgetApi.sendToDevice(e,!1,In(t)),{}}async getOpenIdToken(){const e=await this.widgetApi.requestOpenIDConnectToken();return{access_token:e.access_token,expires_in:e.expires_in,matrix_server_name:e.matrix_server_name,token_type:e.token_type}}async queueToDevice({eventType:e,batch:t}){const i=new $e(()=>new Map);for(const{userId:n,deviceId:s,payload:o}of t)i.getOrCreate(n).set(s,o);await this.widgetApi.sendToDevice(e,!1,In(i))}async encryptAndSendToDevices(e,t){const i=new $e(()=>new Map);for(const{userId:n,deviceInfo:{deviceId:s}}of e)i.getOrCreate(n).set(s,t);await this.widgetApi.sendToDevice(t.type,!0,In(i))}async checkTurnServers(){return this.turnServers.length>0}getSyncState(){return this.syncState}setSyncState(e){const t=this.syncState;this.syncState=e,this.emit(ie.Sync,e,t)}async ack(e){await this.widgetApi.transport.reply(e.detail,{})}async watchTurnServers(){const e=this.widgetApi.getTurnServers(),t=()=>{e.return(void 0)};this.lifecycle.signal.addEventListener("abort",t);try{for await(const i of e)this.turnServers=[{urls:i.uris,username:i.username,credential:i.password}],this.emit(ie.TurnServers,this.turnServers),d.log(`Received TURN server: ${i.uris}`)}catch(i){d.warn("Error watching TURN servers",i)}finally{this.lifecycle.signal.removeEventListener("abort",t)}}}class vE extends Error{}vE.prototype.name="InvalidTokenError";var Vs=(r=>(r[r.NONE=0]="NONE",r[r.ERROR=1]="ERROR",r[r.WARN=2]="WARN",r[r.INFO=3]="INFO",r[r.DEBUG=4]="DEBUG",r))(Vs||{});(r=>{function e(){}r.reset=e;function t(n){if(!(0<=n&&n<=4))throw new Error("Invalid log level")}r.setLevel=t;function i(n){}r.setLogger=i})(Vs||(Vs={}));Vs.reset();new Ce("delegated_oidc_compatibility","org.matrix.msc3824.delegated_oidc_compatibility");class yE extends ke{}new yE;var SE={};let EE=()=>new xa;function bE(r){return r.store=r.store??new PS({localStorage:SE.localStorage}),r.scheduler=r.scheduler??new Ar,r.cryptoStore=r.cryptoStore??EE(),r}function wE(r,e,t,i,n=!0){return new mE(r,e,t,bE(i),n)}class _E extends ff{constructor(){super(...arguments),this.eventBacklogs=new Map}emit(e,...t){const i=super.emit(e,...t);if(!i){const n=this.eventBacklogs.get(e);n?n.push(t):this.eventBacklogs.set(e,[t])}return i}on(e,t){super.on(e,t);const i=this.eventBacklogs.get(e);if(i){for(const n of i)super.emit(e,...n);this.eventBacklogs.delete(e)}return this}addListener(e,t){return this.on(e,t)}once(e,t){super.once(e,t);const i=this.eventBacklogs.get(e);return i&&(super.emit(e,...i[0]),i.length===1?this.eventBacklogs.delete(e):i.shift()),this}}class IE{constructor(e,t){this.queryParams=new URLSearchParams(e);const i=t.indexOf("?");this.fragmentParams=new URLSearchParams(i===-1?"":t.substring(i))}getParam(e){return this.fragmentParams.get(e)??this.queryParams.get(e)}getAllParams(e){return[...this.fragmentParams.getAll(e),...this.queryParams.getAll(e)]}getFlagParam(e,t=!1){const i=this.getParam(e);return i===null?t:i!=="false"}}const hd=(r=window.location.search,e=window.location.hash)=>{const t=new IE(r,e),i=parseFloat(t.getParam("fontScale")??"");return{widgetId:t.getParam("widgetId"),parentUrl:t.getParam("parentUrl"),roomId:t.getParam("room_id"),password:t.getParam("password"),confineToRoom:t.getFlagParam("confineToRoom")||t.getFlagParam("embed"),appPrompt:t.getFlagParam("appPrompt",!0),preload:t.getFlagParam("preload"),hideHeader:t.getFlagParam("hideHeader"),showControls:t.getFlagParam("showControls",!0),hideScreensharing:t.getFlagParam("hideScreensharing"),e2eEnabled:t.getFlagParam("enableE2EE",!0),userId:t.getParam("userId"),displayName:t.getParam("displayName"),deviceId:t.getParam("device_id"),baseUrl:t.getParam("baseUrl"),lang:t.getParam("lang"),fonts:t.getAllParams("font"),fontScale:Number.isNaN(i)?null:i,analyticsID:t.getParam("analyticsID"),allowIceFallback:t.getFlagParam("allowIceFallback"),perParticipantE2EE:t.getFlagParam("perParticipantE2EE"),skipLobby:t.getFlagParam("skipLobby"),returnToLobby:t.getFlagParam("returnToLobby"),theme:t.getParam("theme"),viaServers:t.getParam("viaServers"),homeserver:t.getParam("homeserver")}},Bt=(()=>{try{const{widgetId:r,parentUrl:e}=hd();if(r&&e){const t=new URL(e).origin;d.info("Widget API is available");const i=new Hi.WidgetApi(r,t);i.requestCapability(Hi.MatrixCapabilities.AlwaysOnScreen),i.requestCapabilityToSendEvent(R.CallEncryptionKeysPrefix),i.requestCapabilityToReceiveEvent(R.CallEncryptionKeysPrefix);const n=new _E;["io.element.join","im.vector.hangup","io.element.tile_layout","io.element.spotlight_layout","io.element.screenshare_start","io.element.screenshare_stop"].forEach(w=>{i.on(`action:${w}`,M=>{M.preventDefault(),n.emit(w,M)})});const{roomId:s,userId:o,deviceId:a,baseUrl:c,e2eEnabled:l,allowIceFallback:u}=hd();if(!s)throw new Error("Room ID must be supplied");if(!o)throw new Error("User ID must be supplied");if(!a)throw new Error("Device ID must be supplied");if(!c)throw new Error("Base URL must be supplied");const h=["org.matrix.rageshake_request"],f=[{eventType:R.GroupCallMemberPrefix,stateKey:o}],g=[{eventType:R.RoomMember},{eventType:R.RoomEncryption},{eventType:R.GroupCallPrefix},{eventType:R.GroupCallMemberPrefix}],m=[R.CallInvite,R.CallCandidates,R.CallAnswer,R.CallHangup,R.CallReject,R.CallSelectAnswer,R.CallNegotiate,R.CallSDPStreamMetadataChanged,R.CallSDPStreamMetadataChangedPrefix,R.CallReplaces],v=wE(i,{sendEvent:h,receiveEvent:h,sendState:f,receiveState:g,sendToDevice:m,receiveToDevice:m,turnServers:!1},s,{baseUrl:c,userId:o,deviceId:a,timelineSupport:!0,useE2eForGroupCall:l,fallbackICEServerAllowed:u},!1),S=new Promise(w=>{(async()=>(await v.startClient(),w(v)))()});return{api:i,lazyActions:n,client:S}}else return d.info("No widget API available"),null}catch(r){return d.warn("Continuing without the widget API",r),null}})();function RE(r,e,t){var n;const i=(n=e.memberships[0])==null?void 0:n.getActiveFoci()[0];if((i==null?void 0:i.type)==="livekit"){const s=i;return{type:"livekit",livekit_service_url:s.livekit_service_url,livekit_alias:s.livekit_alias}}return{type:"livekit",livekit_service_url:t,livekit_alias:r}}async function TE(r,e){const t=await r.getOpenIdToken();d.debug("Got openID token",t);try{d.info(`Trying to get JWT from call's active focus URL of ${e.livekit_service_url}...`);const i=await CE(r,e.livekit_service_url,e.livekit_alias,t);return d.info("Got JWT from call's active focus URL."),i}catch(i){d.warn(`Failed to get JWT from RTC session's active focus URL of ${e.livekit_service_url}.`,i);return}}async function CE(r,e,t,i){try{const n=await fetch(e+"/sfu/get",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({room:t,openid_token:i,device_id:r.getDeviceId()})});if(!n.ok)throw new Error("SFU Config fetch failed with status code "+n.status);return await n.json()}catch(n){throw new Error("SFU Config fetch failed with exception "+n)}}async function kE(r,e,t,i,n,s){try{const o=await fetch(i+"/healthz");console.log("Health check response: ",o);const a=await fetch(i+"/get_join_url",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({room_name:n,room_id:e,openid_token:s,device_id:r,display_name:t})});if(!a.ok)throw new Error("SFU Config fetch failed with status code "+a.status);return await a.json()}catch(o){throw new Error("SFU Config fetch failed with exception "+o)}}window.global||(window.global=window);const OE="https://droplet-7099.meetbbb.com/service",ME="https://livekit-jwt.call.element.dev";async function AE(){if(!Bt)throw console.error("Widget not found"),new Error("Widget not found");Bt.api.requestCapabilityToReceiveEvent("m.room.message"),Bt.api.requestCapabilityToSendEvent("m.room.message");const r=await Bt.client,e=new URLSearchParams(window.location.search),t=e.get("device_id"),i=e.get("room_id"),n=e.get("display_name"),s=r.getRoom(i);if(!s)throw console.error("Room not found"),new Error("Room not found");const o=s.name,a=await r.getOpenIdToken(),c=document.getElementById("app");if(c){const l=a.access_token??"{No access token found!}",u=a.matrix_server_name??"{No matrix server found!}",h=o,f=i;c.innerText=`Token: ${l}

Server: ${u}
roomName: ${h}
roomId: ${f}
JoinURL: unknown`;const{url:g}=await kE(t,i,n,OE,o,a);console.log("Join URL: ",g),c.innerText=`Token: ${l}

Server: ${u}
roomName: ${h}
roomId: ${f}
JoinURL: ${g}`;const m=document.getElementById("widgetFrame"),v="microphone *; camera *; encrypted-media *; autoplay *; display-capture *; clipboard-write *; clipboard-read *;";m.allow=v,m.src=g;const S=r.matrixRTC.getRoomSession(s),w=RE(s.roomId,S,ME),M=TE(r,w);console.log("bbb-widget -- got focus: ",w),r.on(de.Timeline,_=>{var C;if(_.getType()==="m.room.message"){const y=_.getContent();if(y.msgtype==="m.text"){const X={api:"toBBB",action:"send_message",data:{message:y.body}};console.log("bbb-widget -- Matrix message to BBB",X),(C=m.contentWindow)==null||C.postMessage(X,"*")}}}),window.onmessage=async _=>{var C;if(console.log("bbb-widget -- got postmessage event from BBB: ",_),_.data.api==="fromBBB")switch(_.data.action){case"leave":console.log("bbb-widget -- Leaving room session"),S.leaveRoomSession(),Bt==null||Bt.api.setAlwaysOnScreen(!1);break;case"join":console.log("bbb-widget -- Joining room session"),Bt==null||Bt.api.setAlwaysOnScreen(!0),S.joinRoomSession([w]);break;case"request_credentials":const A=await M,y={api:"toBBB",action:"lk-credentials",data:{jwt:A==null?void 0:A.jwt,websocket_url:A==null?void 0:A.url,lk_alias:w.livekit_alias}};console.log("bbb-widget -- Sent credentials",y),(C=m.contentWindow)==null||C.postMessage(y,"*");break;case"send_message":r.sendTextMessage(i,_.data.data.message)}}}}AE();export{be as A,$e as B,me as C,Ei as D,R as E,Fe as F,Ne as G,oc as H,wi as I,Sn as J,ae as K,PE as L,D as M,Zi as N,z as O,jr as P,si as S,ut as T,Ss as U,no as V,LE as a,W as b,rt as c,tt as d,Ha as e,Em as f,tv as g,ke as h,qn as i,Vi as j,on as k,d as l,io as m,Jt as n,Nn as o,Et as p,Pe as q,NE as r,Ir as s,Bv as t,ec as u,nc as v,La as w,rn as x,lt as y,li as z};
